(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))s(o);new MutationObserver(o=>{for(const a of o)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function t(o){const a={};return o.integrity&&(a.integrity=o.integrity),o.referrerPolicy&&(a.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?a.credentials="include":o.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(o){if(o.ep)return;o.ep=!0;const a=t(o);fetch(o.href,a)}})();function bind(i,e){return function(){return i.apply(e,arguments)}}const{toString}=Object.prototype,{getPrototypeOf}=Object,kindOf=(i=>e=>{const t=toString.call(e);return i[t]||(i[t]=t.slice(8,-1).toLowerCase())})(Object.create(null)),kindOfTest=i=>(i=i.toLowerCase(),e=>kindOf(e)===i),typeOfTest=i=>e=>typeof e===i,{isArray}=Array,isUndefined=typeOfTest("undefined");function isBuffer(i){return i!==null&&!isUndefined(i)&&i.constructor!==null&&!isUndefined(i.constructor)&&isFunction(i.constructor.isBuffer)&&i.constructor.isBuffer(i)}const isArrayBuffer=kindOfTest("ArrayBuffer");function isArrayBufferView(i){let e;return typeof ArrayBuffer<"u"&&ArrayBuffer.isView?e=ArrayBuffer.isView(i):e=i&&i.buffer&&isArrayBuffer(i.buffer),e}const isString=typeOfTest("string"),isFunction=typeOfTest("function"),isNumber=typeOfTest("number"),isObject$1=i=>i!==null&&typeof i=="object",isBoolean=i=>i===!0||i===!1,isPlainObject=i=>{if(kindOf(i)!=="object")return!1;const e=getPrototypeOf(i);return(e===null||e===Object.prototype||Object.getPrototypeOf(e)===null)&&!(Symbol.toStringTag in i)&&!(Symbol.iterator in i)},isDate=kindOfTest("Date"),isFile=kindOfTest("File"),isBlob=kindOfTest("Blob"),isFileList=kindOfTest("FileList"),isStream=i=>isObject$1(i)&&isFunction(i.pipe),isFormData=i=>{let e;return i&&(typeof FormData=="function"&&i instanceof FormData||isFunction(i.append)&&((e=kindOf(i))==="formdata"||e==="object"&&isFunction(i.toString)&&i.toString()==="[object FormData]"))},isURLSearchParams=kindOfTest("URLSearchParams"),[isReadableStream,isRequest,isResponse,isHeaders]=["ReadableStream","Request","Response","Headers"].map(kindOfTest),trim=i=>i.trim?i.trim():i.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"");function forEach(i,e,{allOwnKeys:t=!1}={}){if(i===null||typeof i>"u")return;let s,o;if(typeof i!="object"&&(i=[i]),isArray(i))for(s=0,o=i.length;s<o;s++)e.call(null,i[s],s,i);else{const a=t?Object.getOwnPropertyNames(i):Object.keys(i),c=a.length;let u;for(s=0;s<c;s++)u=a[s],e.call(null,i[u],u,i)}}function findKey(i,e){e=e.toLowerCase();const t=Object.keys(i);let s=t.length,o;for(;s-- >0;)if(o=t[s],e===o.toLowerCase())return o;return null}const _global=typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:global,isContextDefined=i=>!isUndefined(i)&&i!==_global;function merge(){const{caseless:i}=isContextDefined(this)&&this||{},e={},t=(s,o)=>{const a=i&&findKey(e,o)||o;isPlainObject(e[a])&&isPlainObject(s)?e[a]=merge(e[a],s):isPlainObject(s)?e[a]=merge({},s):isArray(s)?e[a]=s.slice():e[a]=s};for(let s=0,o=arguments.length;s<o;s++)arguments[s]&&forEach(arguments[s],t);return e}const extend=(i,e,t,{allOwnKeys:s}={})=>(forEach(e,(o,a)=>{t&&isFunction(o)?i[a]=bind(o,t):i[a]=o},{allOwnKeys:s}),i),stripBOM=i=>(i.charCodeAt(0)===65279&&(i=i.slice(1)),i),inherits=(i,e,t,s)=>{i.prototype=Object.create(e.prototype,s),i.prototype.constructor=i,Object.defineProperty(i,"super",{value:e.prototype}),t&&Object.assign(i.prototype,t)},toFlatObject=(i,e,t,s)=>{let o,a,c;const u={};if(e=e||{},i==null)return e;do{for(o=Object.getOwnPropertyNames(i),a=o.length;a-- >0;)c=o[a],(!s||s(c,i,e))&&!u[c]&&(e[c]=i[c],u[c]=!0);i=t!==!1&&getPrototypeOf(i)}while(i&&(!t||t(i,e))&&i!==Object.prototype);return e},endsWith=(i,e,t)=>{i=String(i),(t===void 0||t>i.length)&&(t=i.length),t-=e.length;const s=i.indexOf(e,t);return s!==-1&&s===t},toArray=i=>{if(!i)return null;if(isArray(i))return i;let e=i.length;if(!isNumber(e))return null;const t=new Array(e);for(;e-- >0;)t[e]=i[e];return t},isTypedArray=(i=>e=>i&&e instanceof i)(typeof Uint8Array<"u"&&getPrototypeOf(Uint8Array)),forEachEntry=(i,e)=>{const s=(i&&i[Symbol.iterator]).call(i);let o;for(;(o=s.next())&&!o.done;){const a=o.value;e.call(i,a[0],a[1])}},matchAll=(i,e)=>{let t;const s=[];for(;(t=i.exec(e))!==null;)s.push(t);return s},isHTMLForm=kindOfTest("HTMLFormElement"),toCamelCase=i=>i.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(t,s,o){return s.toUpperCase()+o}),hasOwnProperty=(({hasOwnProperty:i})=>(e,t)=>i.call(e,t))(Object.prototype),isRegExp=kindOfTest("RegExp"),reduceDescriptors=(i,e)=>{const t=Object.getOwnPropertyDescriptors(i),s={};forEach(t,(o,a)=>{let c;(c=e(o,a,i))!==!1&&(s[a]=c||o)}),Object.defineProperties(i,s)},freezeMethods=i=>{reduceDescriptors(i,(e,t)=>{if(isFunction(i)&&["arguments","caller","callee"].indexOf(t)!==-1)return!1;const s=i[t];if(isFunction(s)){if(e.enumerable=!1,"writable"in e){e.writable=!1;return}e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+t+"'")})}})},toObjectSet=(i,e)=>{const t={},s=o=>{o.forEach(a=>{t[a]=!0})};return isArray(i)?s(i):s(String(i).split(e)),t},noop$1=()=>{},toFiniteNumber=(i,e)=>i!=null&&Number.isFinite(i=+i)?i:e,ALPHA="abcdefghijklmnopqrstuvwxyz",DIGIT="0123456789",ALPHABET={DIGIT,ALPHA,ALPHA_DIGIT:ALPHA+ALPHA.toUpperCase()+DIGIT},generateString=(i=16,e=ALPHABET.ALPHA_DIGIT)=>{let t="";const{length:s}=e;for(;i--;)t+=e[Math.random()*s|0];return t};function isSpecCompliantForm(i){return!!(i&&isFunction(i.append)&&i[Symbol.toStringTag]==="FormData"&&i[Symbol.iterator])}const toJSONObject=i=>{const e=new Array(10),t=(s,o)=>{if(isObject$1(s)){if(e.indexOf(s)>=0)return;if(!("toJSON"in s)){e[o]=s;const a=isArray(s)?[]:{};return forEach(s,(c,u)=>{const d=t(c,o+1);!isUndefined(d)&&(a[u]=d)}),e[o]=void 0,a}}return s};return t(i,0)},isAsyncFn=kindOfTest("AsyncFunction"),isThenable=i=>i&&(isObject$1(i)||isFunction(i))&&isFunction(i.then)&&isFunction(i.catch),_setImmediate=((i,e)=>i?setImmediate:e?((t,s)=>(_global.addEventListener("message",({source:o,data:a})=>{o===_global&&a===t&&s.length&&s.shift()()},!1),o=>{s.push(o),_global.postMessage(t,"*")}))(`axios@${Math.random()}`,[]):t=>setTimeout(t))(typeof setImmediate=="function",isFunction(_global.postMessage)),asap=typeof queueMicrotask<"u"?queueMicrotask.bind(_global):typeof process<"u"&&process.nextTick||_setImmediate,utils$1={isArray,isArrayBuffer,isBuffer,isFormData,isArrayBufferView,isString,isNumber,isBoolean,isObject:isObject$1,isPlainObject,isReadableStream,isRequest,isResponse,isHeaders,isUndefined,isDate,isFile,isBlob,isRegExp,isFunction,isStream,isURLSearchParams,isTypedArray,isFileList,forEach,merge,extend,trim,stripBOM,inherits,toFlatObject,kindOf,kindOfTest,endsWith,toArray,forEachEntry,matchAll,isHTMLForm,hasOwnProperty,hasOwnProp:hasOwnProperty,reduceDescriptors,freezeMethods,toObjectSet,toCamelCase,noop:noop$1,toFiniteNumber,findKey,global:_global,isContextDefined,ALPHABET,generateString,isSpecCompliantForm,toJSONObject,isAsyncFn,isThenable,setImmediate:_setImmediate,asap};function AxiosError(i,e,t,s,o){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=i,this.name="AxiosError",e&&(this.code=e),t&&(this.config=t),s&&(this.request=s),o&&(this.response=o,this.status=o.status?o.status:null)}utils$1.inherits(AxiosError,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:utils$1.toJSONObject(this.config),code:this.code,status:this.status}}});const prototype$1=AxiosError.prototype,descriptors={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(i=>{descriptors[i]={value:i}});Object.defineProperties(AxiosError,descriptors);Object.defineProperty(prototype$1,"isAxiosError",{value:!0});AxiosError.from=(i,e,t,s,o,a)=>{const c=Object.create(prototype$1);return utils$1.toFlatObject(i,c,function(d){return d!==Error.prototype},u=>u!=="isAxiosError"),AxiosError.call(c,i.message,e,t,s,o),c.cause=i,c.name=i.name,a&&Object.assign(c,a),c};const httpAdapter=null;function isVisitable(i){return utils$1.isPlainObject(i)||utils$1.isArray(i)}function removeBrackets(i){return utils$1.endsWith(i,"[]")?i.slice(0,-2):i}function renderKey(i,e,t){return i?i.concat(e).map(function(o,a){return o=removeBrackets(o),!t&&a?"["+o+"]":o}).join(t?".":""):e}function isFlatArray(i){return utils$1.isArray(i)&&!i.some(isVisitable)}const predicates=utils$1.toFlatObject(utils$1,{},null,function(e){return/^is[A-Z]/.test(e)});function toFormData(i,e,t){if(!utils$1.isObject(i))throw new TypeError("target must be an object");e=e||new FormData,t=utils$1.toFlatObject(t,{metaTokens:!0,dots:!1,indexes:!1},!1,function(C,R){return!utils$1.isUndefined(R[C])});const s=t.metaTokens,o=t.visitor||v,a=t.dots,c=t.indexes,d=(t.Blob||typeof Blob<"u"&&Blob)&&utils$1.isSpecCompliantForm(e);if(!utils$1.isFunction(o))throw new TypeError("visitor must be a function");function p(y){if(y===null)return"";if(utils$1.isDate(y))return y.toISOString();if(!d&&utils$1.isBlob(y))throw new AxiosError("Blob is not supported. Use a Buffer instead.");return utils$1.isArrayBuffer(y)||utils$1.isTypedArray(y)?d&&typeof Blob=="function"?new Blob([y]):Buffer.from(y):y}function v(y,C,R){let T=y;if(y&&!R&&typeof y=="object"){if(utils$1.endsWith(C,"{}"))C=s?C:C.slice(0,-2),y=JSON.stringify(y);else if(utils$1.isArray(y)&&isFlatArray(y)||(utils$1.isFileList(y)||utils$1.endsWith(C,"[]"))&&(T=utils$1.toArray(y)))return C=removeBrackets(C),T.forEach(function(A,b){!(utils$1.isUndefined(A)||A===null)&&e.append(c===!0?renderKey([C],b,a):c===null?C:C+"[]",p(A))}),!1}return isVisitable(y)?!0:(e.append(renderKey(R,C,a),p(y)),!1)}const g=[],m=Object.assign(predicates,{defaultVisitor:v,convertValue:p,isVisitable});function S(y,C){if(!utils$1.isUndefined(y)){if(g.indexOf(y)!==-1)throw Error("Circular reference detected in "+C.join("."));g.push(y),utils$1.forEach(y,function(T,E){(!(utils$1.isUndefined(T)||T===null)&&o.call(e,T,utils$1.isString(E)?E.trim():E,C,m))===!0&&S(T,C?C.concat(E):[E])}),g.pop()}}if(!utils$1.isObject(i))throw new TypeError("data must be an object");return S(i),e}function encode$1(i){const e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(i).replace(/[!'()~]|%20|%00/g,function(s){return e[s]})}function AxiosURLSearchParams(i,e){this._pairs=[],i&&toFormData(i,this,e)}const prototype=AxiosURLSearchParams.prototype;prototype.append=function(e,t){this._pairs.push([e,t])};prototype.toString=function(e){const t=e?function(s){return e.call(this,s,encode$1)}:encode$1;return this._pairs.map(function(o){return t(o[0])+"="+t(o[1])},"").join("&")};function encode(i){return encodeURIComponent(i).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function buildURL(i,e,t){if(!e)return i;const s=t&&t.encode||encode,o=t&&t.serialize;let a;if(o?a=o(e,t):a=utils$1.isURLSearchParams(e)?e.toString():new AxiosURLSearchParams(e,t).toString(s),a){const c=i.indexOf("#");c!==-1&&(i=i.slice(0,c)),i+=(i.indexOf("?")===-1?"?":"&")+a}return i}class InterceptorManager{constructor(){this.handlers=[]}use(e,t,s){return this.handlers.push({fulfilled:e,rejected:t,synchronous:s?s.synchronous:!1,runWhen:s?s.runWhen:null}),this.handlers.length-1}eject(e){this.handlers[e]&&(this.handlers[e]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(e){utils$1.forEach(this.handlers,function(s){s!==null&&e(s)})}}const transitionalDefaults={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},URLSearchParams$1=typeof URLSearchParams<"u"?URLSearchParams:AxiosURLSearchParams,FormData$1=typeof FormData<"u"?FormData:null,Blob$1=typeof Blob<"u"?Blob:null,platform$1={isBrowser:!0,classes:{URLSearchParams:URLSearchParams$1,FormData:FormData$1,Blob:Blob$1},protocols:["http","https","file","blob","url","data"]},hasBrowserEnv=typeof window<"u"&&typeof document<"u",_navigator=typeof navigator=="object"&&navigator||void 0,hasStandardBrowserEnv=hasBrowserEnv&&(!_navigator||["ReactNative","NativeScript","NS"].indexOf(_navigator.product)<0),hasStandardBrowserWebWorkerEnv=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",origin=hasBrowserEnv&&window.location.href||"http://localhost",utils=Object.freeze(Object.defineProperty({__proto__:null,hasBrowserEnv,hasStandardBrowserEnv,hasStandardBrowserWebWorkerEnv,navigator:_navigator,origin},Symbol.toStringTag,{value:"Module"})),platform={...utils,...platform$1};function toURLEncodedForm(i,e){return toFormData(i,new platform.classes.URLSearchParams,Object.assign({visitor:function(t,s,o,a){return platform.isNode&&utils$1.isBuffer(t)?(this.append(s,t.toString("base64")),!1):a.defaultVisitor.apply(this,arguments)}},e))}function parsePropPath(i){return utils$1.matchAll(/\w+|\[(\w*)]/g,i).map(e=>e[0]==="[]"?"":e[1]||e[0])}function arrayToObject(i){const e={},t=Object.keys(i);let s;const o=t.length;let a;for(s=0;s<o;s++)a=t[s],e[a]=i[a];return e}function formDataToJSON(i){function e(t,s,o,a){let c=t[a++];if(c==="__proto__")return!0;const u=Number.isFinite(+c),d=a>=t.length;return c=!c&&utils$1.isArray(o)?o.length:c,d?(utils$1.hasOwnProp(o,c)?o[c]=[o[c],s]:o[c]=s,!u):((!o[c]||!utils$1.isObject(o[c]))&&(o[c]=[]),e(t,s,o[c],a)&&utils$1.isArray(o[c])&&(o[c]=arrayToObject(o[c])),!u)}if(utils$1.isFormData(i)&&utils$1.isFunction(i.entries)){const t={};return utils$1.forEachEntry(i,(s,o)=>{e(parsePropPath(s),o,t,0)}),t}return null}function stringifySafely(i,e,t){if(utils$1.isString(i))try{return(e||JSON.parse)(i),utils$1.trim(i)}catch(s){if(s.name!=="SyntaxError")throw s}return(0,JSON.stringify)(i)}const defaults={transitional:transitionalDefaults,adapter:["xhr","http","fetch"],transformRequest:[function(e,t){const s=t.getContentType()||"",o=s.indexOf("application/json")>-1,a=utils$1.isObject(e);if(a&&utils$1.isHTMLForm(e)&&(e=new FormData(e)),utils$1.isFormData(e))return o?JSON.stringify(formDataToJSON(e)):e;if(utils$1.isArrayBuffer(e)||utils$1.isBuffer(e)||utils$1.isStream(e)||utils$1.isFile(e)||utils$1.isBlob(e)||utils$1.isReadableStream(e))return e;if(utils$1.isArrayBufferView(e))return e.buffer;if(utils$1.isURLSearchParams(e))return t.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),e.toString();let u;if(a){if(s.indexOf("application/x-www-form-urlencoded")>-1)return toURLEncodedForm(e,this.formSerializer).toString();if((u=utils$1.isFileList(e))||s.indexOf("multipart/form-data")>-1){const d=this.env&&this.env.FormData;return toFormData(u?{"files[]":e}:e,d&&new d,this.formSerializer)}}return a||o?(t.setContentType("application/json",!1),stringifySafely(e)):e}],transformResponse:[function(e){const t=this.transitional||defaults.transitional,s=t&&t.forcedJSONParsing,o=this.responseType==="json";if(utils$1.isResponse(e)||utils$1.isReadableStream(e))return e;if(e&&utils$1.isString(e)&&(s&&!this.responseType||o)){const c=!(t&&t.silentJSONParsing)&&o;try{return JSON.parse(e)}catch(u){if(c)throw u.name==="SyntaxError"?AxiosError.from(u,AxiosError.ERR_BAD_RESPONSE,this,null,this.response):u}}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:platform.classes.FormData,Blob:platform.classes.Blob},validateStatus:function(e){return e>=200&&e<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};utils$1.forEach(["delete","get","head","post","put","patch"],i=>{defaults.headers[i]={}});const ignoreDuplicateOf=utils$1.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),parseHeaders=i=>{const e={};let t,s,o;return i&&i.split(`
`).forEach(function(c){o=c.indexOf(":"),t=c.substring(0,o).trim().toLowerCase(),s=c.substring(o+1).trim(),!(!t||e[t]&&ignoreDuplicateOf[t])&&(t==="set-cookie"?e[t]?e[t].push(s):e[t]=[s]:e[t]=e[t]?e[t]+", "+s:s)}),e},$internals=Symbol("internals");function normalizeHeader(i){return i&&String(i).trim().toLowerCase()}function normalizeValue(i){return i===!1||i==null?i:utils$1.isArray(i)?i.map(normalizeValue):String(i)}function parseTokens(i){const e=Object.create(null),t=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g;let s;for(;s=t.exec(i);)e[s[1]]=s[2];return e}const isValidHeaderName=i=>/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(i.trim());function matchHeaderValue(i,e,t,s,o){if(utils$1.isFunction(s))return s.call(this,e,t);if(o&&(e=t),!!utils$1.isString(e)){if(utils$1.isString(s))return e.indexOf(s)!==-1;if(utils$1.isRegExp(s))return s.test(e)}}function formatHeader(i){return i.trim().toLowerCase().replace(/([a-z\d])(\w*)/g,(e,t,s)=>t.toUpperCase()+s)}function buildAccessors(i,e){const t=utils$1.toCamelCase(" "+e);["get","set","has"].forEach(s=>{Object.defineProperty(i,s+t,{value:function(o,a,c){return this[s].call(this,e,o,a,c)},configurable:!0})})}class AxiosHeaders{constructor(e){e&&this.set(e)}set(e,t,s){const o=this;function a(u,d,p){const v=normalizeHeader(d);if(!v)throw new Error("header name must be a non-empty string");const g=utils$1.findKey(o,v);(!g||o[g]===void 0||p===!0||p===void 0&&o[g]!==!1)&&(o[g||d]=normalizeValue(u))}const c=(u,d)=>utils$1.forEach(u,(p,v)=>a(p,v,d));if(utils$1.isPlainObject(e)||e instanceof this.constructor)c(e,t);else if(utils$1.isString(e)&&(e=e.trim())&&!isValidHeaderName(e))c(parseHeaders(e),t);else if(utils$1.isHeaders(e))for(const[u,d]of e.entries())a(d,u,s);else e!=null&&a(t,e,s);return this}get(e,t){if(e=normalizeHeader(e),e){const s=utils$1.findKey(this,e);if(s){const o=this[s];if(!t)return o;if(t===!0)return parseTokens(o);if(utils$1.isFunction(t))return t.call(this,o,s);if(utils$1.isRegExp(t))return t.exec(o);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,t){if(e=normalizeHeader(e),e){const s=utils$1.findKey(this,e);return!!(s&&this[s]!==void 0&&(!t||matchHeaderValue(this,this[s],s,t)))}return!1}delete(e,t){const s=this;let o=!1;function a(c){if(c=normalizeHeader(c),c){const u=utils$1.findKey(s,c);u&&(!t||matchHeaderValue(s,s[u],u,t))&&(delete s[u],o=!0)}}return utils$1.isArray(e)?e.forEach(a):a(e),o}clear(e){const t=Object.keys(this);let s=t.length,o=!1;for(;s--;){const a=t[s];(!e||matchHeaderValue(this,this[a],a,e,!0))&&(delete this[a],o=!0)}return o}normalize(e){const t=this,s={};return utils$1.forEach(this,(o,a)=>{const c=utils$1.findKey(s,a);if(c){t[c]=normalizeValue(o),delete t[a];return}const u=e?formatHeader(a):String(a).trim();u!==a&&delete t[a],t[u]=normalizeValue(o),s[u]=!0}),this}concat(...e){return this.constructor.concat(this,...e)}toJSON(e){const t=Object.create(null);return utils$1.forEach(this,(s,o)=>{s!=null&&s!==!1&&(t[o]=e&&utils$1.isArray(s)?s.join(", "):s)}),t}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(([e,t])=>e+": "+t).join(`
`)}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e,...t){const s=new this(e);return t.forEach(o=>s.set(o)),s}static accessor(e){const s=(this[$internals]=this[$internals]={accessors:{}}).accessors,o=this.prototype;function a(c){const u=normalizeHeader(c);s[u]||(buildAccessors(o,c),s[u]=!0)}return utils$1.isArray(e)?e.forEach(a):a(e),this}}AxiosHeaders.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]);utils$1.reduceDescriptors(AxiosHeaders.prototype,({value:i},e)=>{let t=e[0].toUpperCase()+e.slice(1);return{get:()=>i,set(s){this[t]=s}}});utils$1.freezeMethods(AxiosHeaders);function transformData(i,e){const t=this||defaults,s=e||t,o=AxiosHeaders.from(s.headers);let a=s.data;return utils$1.forEach(i,function(u){a=u.call(t,a,o.normalize(),e?e.status:void 0)}),o.normalize(),a}function isCancel(i){return!!(i&&i.__CANCEL__)}function CanceledError(i,e,t){AxiosError.call(this,i??"canceled",AxiosError.ERR_CANCELED,e,t),this.name="CanceledError"}utils$1.inherits(CanceledError,AxiosError,{__CANCEL__:!0});function settle(i,e,t){const s=t.config.validateStatus;!t.status||!s||s(t.status)?i(t):e(new AxiosError("Request failed with status code "+t.status,[AxiosError.ERR_BAD_REQUEST,AxiosError.ERR_BAD_RESPONSE][Math.floor(t.status/100)-4],t.config,t.request,t))}function parseProtocol(i){const e=/^([-+\w]{1,25})(:?\/\/|:)/.exec(i);return e&&e[1]||""}function speedometer(i,e){i=i||10;const t=new Array(i),s=new Array(i);let o=0,a=0,c;return e=e!==void 0?e:1e3,function(d){const p=Date.now(),v=s[a];c||(c=p),t[o]=d,s[o]=p;let g=a,m=0;for(;g!==o;)m+=t[g++],g=g%i;if(o=(o+1)%i,o===a&&(a=(a+1)%i),p-c<e)return;const S=v&&p-v;return S?Math.round(m*1e3/S):void 0}}function throttle(i,e){let t=0,s=1e3/e,o,a;const c=(p,v=Date.now())=>{t=v,o=null,a&&(clearTimeout(a),a=null),i.apply(null,p)};return[(...p)=>{const v=Date.now(),g=v-t;g>=s?c(p,v):(o=p,a||(a=setTimeout(()=>{a=null,c(o)},s-g)))},()=>o&&c(o)]}const progressEventReducer=(i,e,t=3)=>{let s=0;const o=speedometer(50,250);return throttle(a=>{const c=a.loaded,u=a.lengthComputable?a.total:void 0,d=c-s,p=o(d),v=c<=u;s=c;const g={loaded:c,total:u,progress:u?c/u:void 0,bytes:d,rate:p||void 0,estimated:p&&u&&v?(u-c)/p:void 0,event:a,lengthComputable:u!=null,[e?"download":"upload"]:!0};i(g)},t)},progressEventDecorator=(i,e)=>{const t=i!=null;return[s=>e[0]({lengthComputable:t,total:i,loaded:s}),e[1]]},asyncDecorator=i=>(...e)=>utils$1.asap(()=>i(...e)),isURLSameOrigin=platform.hasStandardBrowserEnv?function(){const e=platform.navigator&&/(msie|trident)/i.test(platform.navigator.userAgent),t=document.createElement("a");let s;function o(a){let c=a;return e&&(t.setAttribute("href",c),c=t.href),t.setAttribute("href",c),{href:t.href,protocol:t.protocol?t.protocol.replace(/:$/,""):"",host:t.host,search:t.search?t.search.replace(/^\?/,""):"",hash:t.hash?t.hash.replace(/^#/,""):"",hostname:t.hostname,port:t.port,pathname:t.pathname.charAt(0)==="/"?t.pathname:"/"+t.pathname}}return s=o(window.location.href),function(c){const u=utils$1.isString(c)?o(c):c;return u.protocol===s.protocol&&u.host===s.host}}():function(){return function(){return!0}}(),cookies=platform.hasStandardBrowserEnv?{write(i,e,t,s,o,a){const c=[i+"="+encodeURIComponent(e)];utils$1.isNumber(t)&&c.push("expires="+new Date(t).toGMTString()),utils$1.isString(s)&&c.push("path="+s),utils$1.isString(o)&&c.push("domain="+o),a===!0&&c.push("secure"),document.cookie=c.join("; ")},read(i){const e=document.cookie.match(new RegExp("(^|;\\s*)("+i+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(i){this.write(i,"",Date.now()-864e5)}}:{write(){},read(){return null},remove(){}};function isAbsoluteURL(i){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(i)}function combineURLs(i,e){return e?i.replace(/\/?\/$/,"")+"/"+e.replace(/^\/+/,""):i}function buildFullPath(i,e){return i&&!isAbsoluteURL(e)?combineURLs(i,e):e}const headersToObject=i=>i instanceof AxiosHeaders?{...i}:i;function mergeConfig(i,e){e=e||{};const t={};function s(p,v,g){return utils$1.isPlainObject(p)&&utils$1.isPlainObject(v)?utils$1.merge.call({caseless:g},p,v):utils$1.isPlainObject(v)?utils$1.merge({},v):utils$1.isArray(v)?v.slice():v}function o(p,v,g){if(utils$1.isUndefined(v)){if(!utils$1.isUndefined(p))return s(void 0,p,g)}else return s(p,v,g)}function a(p,v){if(!utils$1.isUndefined(v))return s(void 0,v)}function c(p,v){if(utils$1.isUndefined(v)){if(!utils$1.isUndefined(p))return s(void 0,p)}else return s(void 0,v)}function u(p,v,g){if(g in e)return s(p,v);if(g in i)return s(void 0,p)}const d={url:a,method:a,data:a,baseURL:c,transformRequest:c,transformResponse:c,paramsSerializer:c,timeout:c,timeoutMessage:c,withCredentials:c,withXSRFToken:c,adapter:c,responseType:c,xsrfCookieName:c,xsrfHeaderName:c,onUploadProgress:c,onDownloadProgress:c,decompress:c,maxContentLength:c,maxBodyLength:c,beforeRedirect:c,transport:c,httpAgent:c,httpsAgent:c,cancelToken:c,socketPath:c,responseEncoding:c,validateStatus:u,headers:(p,v)=>o(headersToObject(p),headersToObject(v),!0)};return utils$1.forEach(Object.keys(Object.assign({},i,e)),function(v){const g=d[v]||o,m=g(i[v],e[v],v);utils$1.isUndefined(m)&&g!==u||(t[v]=m)}),t}const resolveConfig=i=>{const e=mergeConfig({},i);let{data:t,withXSRFToken:s,xsrfHeaderName:o,xsrfCookieName:a,headers:c,auth:u}=e;e.headers=c=AxiosHeaders.from(c),e.url=buildURL(buildFullPath(e.baseURL,e.url),i.params,i.paramsSerializer),u&&c.set("Authorization","Basic "+btoa((u.username||"")+":"+(u.password?unescape(encodeURIComponent(u.password)):"")));let d;if(utils$1.isFormData(t)){if(platform.hasStandardBrowserEnv||platform.hasStandardBrowserWebWorkerEnv)c.setContentType(void 0);else if((d=c.getContentType())!==!1){const[p,...v]=d?d.split(";").map(g=>g.trim()).filter(Boolean):[];c.setContentType([p||"multipart/form-data",...v].join("; "))}}if(platform.hasStandardBrowserEnv&&(s&&utils$1.isFunction(s)&&(s=s(e)),s||s!==!1&&isURLSameOrigin(e.url))){const p=o&&a&&cookies.read(a);p&&c.set(o,p)}return e},isXHRAdapterSupported=typeof XMLHttpRequest<"u",xhrAdapter=isXHRAdapterSupported&&function(i){return new Promise(function(t,s){const o=resolveConfig(i);let a=o.data;const c=AxiosHeaders.from(o.headers).normalize();let{responseType:u,onUploadProgress:d,onDownloadProgress:p}=o,v,g,m,S,y;function C(){S&&S(),y&&y(),o.cancelToken&&o.cancelToken.unsubscribe(v),o.signal&&o.signal.removeEventListener("abort",v)}let R=new XMLHttpRequest;R.open(o.method.toUpperCase(),o.url,!0),R.timeout=o.timeout;function T(){if(!R)return;const A=AxiosHeaders.from("getAllResponseHeaders"in R&&R.getAllResponseHeaders()),P={data:!u||u==="text"||u==="json"?R.responseText:R.response,status:R.status,statusText:R.statusText,headers:A,config:i,request:R};settle(function(w){t(w),C()},function(w){s(w),C()},P),R=null}"onloadend"in R?R.onloadend=T:R.onreadystatechange=function(){!R||R.readyState!==4||R.status===0&&!(R.responseURL&&R.responseURL.indexOf("file:")===0)||setTimeout(T)},R.onabort=function(){R&&(s(new AxiosError("Request aborted",AxiosError.ECONNABORTED,i,R)),R=null)},R.onerror=function(){s(new AxiosError("Network Error",AxiosError.ERR_NETWORK,i,R)),R=null},R.ontimeout=function(){let b=o.timeout?"timeout of "+o.timeout+"ms exceeded":"timeout exceeded";const P=o.transitional||transitionalDefaults;o.timeoutErrorMessage&&(b=o.timeoutErrorMessage),s(new AxiosError(b,P.clarifyTimeoutError?AxiosError.ETIMEDOUT:AxiosError.ECONNABORTED,i,R)),R=null},a===void 0&&c.setContentType(null),"setRequestHeader"in R&&utils$1.forEach(c.toJSON(),function(b,P){R.setRequestHeader(P,b)}),utils$1.isUndefined(o.withCredentials)||(R.withCredentials=!!o.withCredentials),u&&u!=="json"&&(R.responseType=o.responseType),p&&([m,y]=progressEventReducer(p,!0),R.addEventListener("progress",m)),d&&R.upload&&([g,S]=progressEventReducer(d),R.upload.addEventListener("progress",g),R.upload.addEventListener("loadend",S)),(o.cancelToken||o.signal)&&(v=A=>{R&&(s(!A||A.type?new CanceledError(null,i,R):A),R.abort(),R=null)},o.cancelToken&&o.cancelToken.subscribe(v),o.signal&&(o.signal.aborted?v():o.signal.addEventListener("abort",v)));const E=parseProtocol(o.url);if(E&&platform.protocols.indexOf(E)===-1){s(new AxiosError("Unsupported protocol "+E+":",AxiosError.ERR_BAD_REQUEST,i));return}R.send(a||null)})},composeSignals=(i,e)=>{const{length:t}=i=i?i.filter(Boolean):[];if(e||t){let s=new AbortController,o;const a=function(p){if(!o){o=!0,u();const v=p instanceof Error?p:this.reason;s.abort(v instanceof AxiosError?v:new CanceledError(v instanceof Error?v.message:v))}};let c=e&&setTimeout(()=>{c=null,a(new AxiosError(`timeout ${e} of ms exceeded`,AxiosError.ETIMEDOUT))},e);const u=()=>{i&&(c&&clearTimeout(c),c=null,i.forEach(p=>{p.unsubscribe?p.unsubscribe(a):p.removeEventListener("abort",a)}),i=null)};i.forEach(p=>p.addEventListener("abort",a));const{signal:d}=s;return d.unsubscribe=()=>utils$1.asap(u),d}},streamChunk=function*(i,e){let t=i.byteLength;if(t<e){yield i;return}let s=0,o;for(;s<t;)o=s+e,yield i.slice(s,o),s=o},readBytes=async function*(i,e){for await(const t of readStream(i))yield*streamChunk(t,e)},readStream=async function*(i){if(i[Symbol.asyncIterator]){yield*i;return}const e=i.getReader();try{for(;;){const{done:t,value:s}=await e.read();if(t)break;yield s}}finally{await e.cancel()}},trackStream=(i,e,t,s)=>{const o=readBytes(i,e);let a=0,c,u=d=>{c||(c=!0,s&&s(d))};return new ReadableStream({async pull(d){try{const{done:p,value:v}=await o.next();if(p){u(),d.close();return}let g=v.byteLength;if(t){let m=a+=g;t(m)}d.enqueue(new Uint8Array(v))}catch(p){throw u(p),p}},cancel(d){return u(d),o.return()}},{highWaterMark:2})},isFetchSupported=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",isReadableStreamSupported=isFetchSupported&&typeof ReadableStream=="function",encodeText=isFetchSupported&&(typeof TextEncoder=="function"?(i=>e=>i.encode(e))(new TextEncoder):async i=>new Uint8Array(await new Response(i).arrayBuffer())),test$1=(i,...e)=>{try{return!!i(...e)}catch{return!1}},supportsRequestStream=isReadableStreamSupported&&test$1(()=>{let i=!1;const e=new Request(platform.origin,{body:new ReadableStream,method:"POST",get duplex(){return i=!0,"half"}}).headers.has("Content-Type");return i&&!e}),DEFAULT_CHUNK_SIZE=64*1024,supportsResponseStream=isReadableStreamSupported&&test$1(()=>utils$1.isReadableStream(new Response("").body)),resolvers={stream:supportsResponseStream&&(i=>i.body)};isFetchSupported&&(i=>{["text","arrayBuffer","blob","formData","stream"].forEach(e=>{!resolvers[e]&&(resolvers[e]=utils$1.isFunction(i[e])?t=>t[e]():(t,s)=>{throw new AxiosError(`Response type '${e}' is not supported`,AxiosError.ERR_NOT_SUPPORT,s)})})})(new Response);const getBodyLength=async i=>{if(i==null)return 0;if(utils$1.isBlob(i))return i.size;if(utils$1.isSpecCompliantForm(i))return(await new Request(platform.origin,{method:"POST",body:i}).arrayBuffer()).byteLength;if(utils$1.isArrayBufferView(i)||utils$1.isArrayBuffer(i))return i.byteLength;if(utils$1.isURLSearchParams(i)&&(i=i+""),utils$1.isString(i))return(await encodeText(i)).byteLength},resolveBodyLength=async(i,e)=>{const t=utils$1.toFiniteNumber(i.getContentLength());return t??getBodyLength(e)},fetchAdapter=isFetchSupported&&(async i=>{let{url:e,method:t,data:s,signal:o,cancelToken:a,timeout:c,onDownloadProgress:u,onUploadProgress:d,responseType:p,headers:v,withCredentials:g="same-origin",fetchOptions:m}=resolveConfig(i);p=p?(p+"").toLowerCase():"text";let S=composeSignals([o,a&&a.toAbortSignal()],c),y;const C=S&&S.unsubscribe&&(()=>{S.unsubscribe()});let R;try{if(d&&supportsRequestStream&&t!=="get"&&t!=="head"&&(R=await resolveBodyLength(v,s))!==0){let P=new Request(e,{method:"POST",body:s,duplex:"half"}),_;if(utils$1.isFormData(s)&&(_=P.headers.get("content-type"))&&v.setContentType(_),P.body){const[w,I]=progressEventDecorator(R,progressEventReducer(asyncDecorator(d)));s=trackStream(P.body,DEFAULT_CHUNK_SIZE,w,I)}}utils$1.isString(g)||(g=g?"include":"omit");const T="credentials"in Request.prototype;y=new Request(e,{...m,signal:S,method:t.toUpperCase(),headers:v.normalize().toJSON(),body:s,duplex:"half",credentials:T?g:void 0});let E=await fetch(y);const A=supportsResponseStream&&(p==="stream"||p==="response");if(supportsResponseStream&&(u||A&&C)){const P={};["status","statusText","headers"].forEach(D=>{P[D]=E[D]});const _=utils$1.toFiniteNumber(E.headers.get("content-length")),[w,I]=u&&progressEventDecorator(_,progressEventReducer(asyncDecorator(u),!0))||[];E=new Response(trackStream(E.body,DEFAULT_CHUNK_SIZE,w,()=>{I&&I(),C&&C()}),P)}p=p||"text";let b=await resolvers[utils$1.findKey(resolvers,p)||"text"](E,i);return!A&&C&&C(),await new Promise((P,_)=>{settle(P,_,{data:b,headers:AxiosHeaders.from(E.headers),status:E.status,statusText:E.statusText,config:i,request:y})})}catch(T){throw C&&C(),T&&T.name==="TypeError"&&/fetch/i.test(T.message)?Object.assign(new AxiosError("Network Error",AxiosError.ERR_NETWORK,i,y),{cause:T.cause||T}):AxiosError.from(T,T&&T.code,i,y)}}),knownAdapters={http:httpAdapter,xhr:xhrAdapter,fetch:fetchAdapter};utils$1.forEach(knownAdapters,(i,e)=>{if(i){try{Object.defineProperty(i,"name",{value:e})}catch{}Object.defineProperty(i,"adapterName",{value:e})}});const renderReason=i=>`- ${i}`,isResolvedHandle=i=>utils$1.isFunction(i)||i===null||i===!1,adapters={getAdapter:i=>{i=utils$1.isArray(i)?i:[i];const{length:e}=i;let t,s;const o={};for(let a=0;a<e;a++){t=i[a];let c;if(s=t,!isResolvedHandle(t)&&(s=knownAdapters[(c=String(t)).toLowerCase()],s===void 0))throw new AxiosError(`Unknown adapter '${c}'`);if(s)break;o[c||"#"+a]=s}if(!s){const a=Object.entries(o).map(([u,d])=>`adapter ${u} `+(d===!1?"is not supported by the environment":"is not available in the build"));let c=e?a.length>1?`since :
`+a.map(renderReason).join(`
`):" "+renderReason(a[0]):"as no adapter specified";throw new AxiosError("There is no suitable adapter to dispatch the request "+c,"ERR_NOT_SUPPORT")}return s},adapters:knownAdapters};function throwIfCancellationRequested(i){if(i.cancelToken&&i.cancelToken.throwIfRequested(),i.signal&&i.signal.aborted)throw new CanceledError(null,i)}function dispatchRequest(i){return throwIfCancellationRequested(i),i.headers=AxiosHeaders.from(i.headers),i.data=transformData.call(i,i.transformRequest),["post","put","patch"].indexOf(i.method)!==-1&&i.headers.setContentType("application/x-www-form-urlencoded",!1),adapters.getAdapter(i.adapter||defaults.adapter)(i).then(function(s){return throwIfCancellationRequested(i),s.data=transformData.call(i,i.transformResponse,s),s.headers=AxiosHeaders.from(s.headers),s},function(s){return isCancel(s)||(throwIfCancellationRequested(i),s&&s.response&&(s.response.data=transformData.call(i,i.transformResponse,s.response),s.response.headers=AxiosHeaders.from(s.response.headers))),Promise.reject(s)})}const VERSION="1.7.7",validators$1={};["object","boolean","number","function","string","symbol"].forEach((i,e)=>{validators$1[i]=function(s){return typeof s===i||"a"+(e<1?"n ":" ")+i}});const deprecatedWarnings={};validators$1.transitional=function(e,t,s){function o(a,c){return"[Axios v"+VERSION+"] Transitional option '"+a+"'"+c+(s?". "+s:"")}return(a,c,u)=>{if(e===!1)throw new AxiosError(o(c," has been removed"+(t?" in "+t:"")),AxiosError.ERR_DEPRECATED);return t&&!deprecatedWarnings[c]&&(deprecatedWarnings[c]=!0,console.warn(o(c," has been deprecated since v"+t+" and will be removed in the near future"))),e?e(a,c,u):!0}};function assertOptions(i,e,t){if(typeof i!="object")throw new AxiosError("options must be an object",AxiosError.ERR_BAD_OPTION_VALUE);const s=Object.keys(i);let o=s.length;for(;o-- >0;){const a=s[o],c=e[a];if(c){const u=i[a],d=u===void 0||c(u,a,i);if(d!==!0)throw new AxiosError("option "+a+" must be "+d,AxiosError.ERR_BAD_OPTION_VALUE);continue}if(t!==!0)throw new AxiosError("Unknown option "+a,AxiosError.ERR_BAD_OPTION)}}const validator={assertOptions,validators:validators$1},validators=validator.validators;class Axios{constructor(e){this.defaults=e,this.interceptors={request:new InterceptorManager,response:new InterceptorManager}}async request(e,t){try{return await this._request(e,t)}catch(s){if(s instanceof Error){let o;Error.captureStackTrace?Error.captureStackTrace(o={}):o=new Error;const a=o.stack?o.stack.replace(/^.+\n/,""):"";try{s.stack?a&&!String(s.stack).endsWith(a.replace(/^.+\n.+\n/,""))&&(s.stack+=`
`+a):s.stack=a}catch{}}throw s}}_request(e,t){typeof e=="string"?(t=t||{},t.url=e):t=e||{},t=mergeConfig(this.defaults,t);const{transitional:s,paramsSerializer:o,headers:a}=t;s!==void 0&&validator.assertOptions(s,{silentJSONParsing:validators.transitional(validators.boolean),forcedJSONParsing:validators.transitional(validators.boolean),clarifyTimeoutError:validators.transitional(validators.boolean)},!1),o!=null&&(utils$1.isFunction(o)?t.paramsSerializer={serialize:o}:validator.assertOptions(o,{encode:validators.function,serialize:validators.function},!0)),t.method=(t.method||this.defaults.method||"get").toLowerCase();let c=a&&utils$1.merge(a.common,a[t.method]);a&&utils$1.forEach(["delete","get","head","post","put","patch","common"],y=>{delete a[y]}),t.headers=AxiosHeaders.concat(c,a);const u=[];let d=!0;this.interceptors.request.forEach(function(C){typeof C.runWhen=="function"&&C.runWhen(t)===!1||(d=d&&C.synchronous,u.unshift(C.fulfilled,C.rejected))});const p=[];this.interceptors.response.forEach(function(C){p.push(C.fulfilled,C.rejected)});let v,g=0,m;if(!d){const y=[dispatchRequest.bind(this),void 0];for(y.unshift.apply(y,u),y.push.apply(y,p),m=y.length,v=Promise.resolve(t);g<m;)v=v.then(y[g++],y[g++]);return v}m=u.length;let S=t;for(g=0;g<m;){const y=u[g++],C=u[g++];try{S=y(S)}catch(R){C.call(this,R);break}}try{v=dispatchRequest.call(this,S)}catch(y){return Promise.reject(y)}for(g=0,m=p.length;g<m;)v=v.then(p[g++],p[g++]);return v}getUri(e){e=mergeConfig(this.defaults,e);const t=buildFullPath(e.baseURL,e.url);return buildURL(t,e.params,e.paramsSerializer)}}utils$1.forEach(["delete","get","head","options"],function(e){Axios.prototype[e]=function(t,s){return this.request(mergeConfig(s||{},{method:e,url:t,data:(s||{}).data}))}});utils$1.forEach(["post","put","patch"],function(e){function t(s){return function(a,c,u){return this.request(mergeConfig(u||{},{method:e,headers:s?{"Content-Type":"multipart/form-data"}:{},url:a,data:c}))}}Axios.prototype[e]=t(),Axios.prototype[e+"Form"]=t(!0)});class CancelToken{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let t;this.promise=new Promise(function(a){t=a});const s=this;this.promise.then(o=>{if(!s._listeners)return;let a=s._listeners.length;for(;a-- >0;)s._listeners[a](o);s._listeners=null}),this.promise.then=o=>{let a;const c=new Promise(u=>{s.subscribe(u),a=u}).then(o);return c.cancel=function(){s.unsubscribe(a)},c},e(function(a,c,u){s.reason||(s.reason=new CanceledError(a,c,u),t(s.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){if(this.reason){e(this.reason);return}this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;const t=this._listeners.indexOf(e);t!==-1&&this._listeners.splice(t,1)}toAbortSignal(){const e=new AbortController,t=s=>{e.abort(s)};return this.subscribe(t),e.signal.unsubscribe=()=>this.unsubscribe(t),e.signal}static source(){let e;return{token:new CancelToken(function(o){e=o}),cancel:e}}}function spread(i){return function(t){return i.apply(null,t)}}function isAxiosError(i){return utils$1.isObject(i)&&i.isAxiosError===!0}const HttpStatusCode={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(HttpStatusCode).forEach(([i,e])=>{HttpStatusCode[e]=i});function createInstance(i){const e=new Axios(i),t=bind(Axios.prototype.request,e);return utils$1.extend(t,Axios.prototype,e,{allOwnKeys:!0}),utils$1.extend(t,e,null,{allOwnKeys:!0}),t.create=function(o){return createInstance(mergeConfig(i,o))},t}const axios=createInstance(defaults);axios.Axios=Axios;axios.CanceledError=CanceledError;axios.CancelToken=CancelToken;axios.isCancel=isCancel;axios.VERSION=VERSION;axios.toFormData=toFormData;axios.AxiosError=AxiosError;axios.Cancel=axios.CanceledError;axios.all=function(e){return Promise.all(e)};axios.spread=spread;axios.isAxiosError=isAxiosError;axios.mergeConfig=mergeConfig;axios.AxiosHeaders=AxiosHeaders;axios.formToJSON=i=>formDataToJSON(utils$1.isHTMLForm(i)?new FormData(i):i);axios.getAdapter=adapters.getAdapter;axios.HttpStatusCode=HttpStatusCode;axios.default=axios;var define_process_env_default={};function _mergeNamespaces(i,e){return e.forEach(function(t){t&&typeof t!="string"&&!Array.isArray(t)&&Object.keys(t).forEach(function(s){if(s!=="default"&&!(s in i)){var o=Object.getOwnPropertyDescriptor(t,s);Object.defineProperty(i,s,o.get?o:{enumerable:!0,get:function(){return t[s]}})}})}),Object.freeze(i)}var k=Object.defineProperty,n=(i,e,t)=>e in i?k(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t,l=(i,e,t)=>n(i,typeof e!="symbol"?e+"":e,t);class h{constructor(){l(this,"_locking"),l(this,"_locks"),this._locking=Promise.resolve(),this._locks=0}isLocked(){return this._locks>0}lock(){this._locks+=1;let e;const t=new Promise(o=>e=()=>{this._locks-=1,o()}),s=this._locking.then(()=>e);return this._locking=this._locking.then(()=>t),s}}function assert(i,e){if(!i)throw new Error(e)}const FLOAT32_MAX=34028234663852886e22,FLOAT32_MIN=-34028234663852886e22,UINT32_MAX=4294967295,INT32_MAX=2147483647,INT32_MIN=-2147483648;function assertInt32(i){if(typeof i!="number")throw new Error("invalid int 32: "+typeof i);if(!Number.isInteger(i)||i>INT32_MAX||i<INT32_MIN)throw new Error("invalid int 32: "+i)}function assertUInt32(i){if(typeof i!="number")throw new Error("invalid uint 32: "+typeof i);if(!Number.isInteger(i)||i>UINT32_MAX||i<0)throw new Error("invalid uint 32: "+i)}function assertFloat32(i){if(typeof i!="number")throw new Error("invalid float 32: "+typeof i);if(Number.isFinite(i)&&(i>FLOAT32_MAX||i<FLOAT32_MIN))throw new Error("invalid float 32: "+i)}const enumTypeSymbol=Symbol("@bufbuild/protobuf/enum-type");function getEnumType(i){const e=i[enumTypeSymbol];return assert(e,"missing enum type on enum object"),e}function setEnumType(i,e,t,s){i[enumTypeSymbol]=makeEnumType(e,t.map(o=>({no:o.no,name:o.name,localName:i[o.no]})))}function makeEnumType(i,e,t){const s=Object.create(null),o=Object.create(null),a=[];for(const c of e){const u=normalizeEnumValue(c);a.push(u),s[c.name]=u,o[c.no]=u}return{typeName:i,values:a,findName(c){return s[c]},findNumber(c){return o[c]}}}function makeEnum(i,e,t){const s={};for(const o of e){const a=normalizeEnumValue(o);s[a.localName]=a.no,s[a.no]=a.localName}return setEnumType(s,i,e),s}function normalizeEnumValue(i){return"localName"in i?i:Object.assign(Object.assign({},i),{localName:i.name})}let Message$1=class{equals(e){return this.getType().runtime.util.equals(this.getType(),this,e)}clone(){return this.getType().runtime.util.clone(this)}fromBinary(e,t){const s=this.getType(),o=s.runtime.bin,a=o.makeReadOptions(t);return o.readMessage(this,a.readerFactory(e),e.byteLength,a),this}fromJson(e,t){const s=this.getType(),o=s.runtime.json,a=o.makeReadOptions(t);return o.readMessage(s,e,a,this),this}fromJsonString(e,t){let s;try{s=JSON.parse(e)}catch(o){throw new Error("cannot decode ".concat(this.getType().typeName," from JSON: ").concat(o instanceof Error?o.message:String(o)))}return this.fromJson(s,t)}toBinary(e){const t=this.getType(),s=t.runtime.bin,o=s.makeWriteOptions(e),a=o.writerFactory();return s.writeMessage(this,a,o),a.finish()}toJson(e){const t=this.getType(),s=t.runtime.json,o=s.makeWriteOptions(e);return s.writeMessage(this,o)}toJsonString(e){var t;const s=this.toJson(e);return JSON.stringify(s,null,(t=e==null?void 0:e.prettySpaces)!==null&&t!==void 0?t:0)}toJSON(){return this.toJson({emitDefaultValues:!0})}getType(){return Object.getPrototypeOf(this).constructor}};function makeMessageType(i,e,t,s){var o;const a=(o=s==null?void 0:s.localName)!==null&&o!==void 0?o:e.substring(e.lastIndexOf(".")+1),c={[a]:function(u){i.util.initFields(this),i.util.initPartial(u,this)}}[a];return Object.setPrototypeOf(c.prototype,new Message$1),Object.assign(c,{runtime:i,typeName:e,fields:i.util.newFieldList(t),fromBinary(u,d){return new c().fromBinary(u,d)},fromJson(u,d){return new c().fromJson(u,d)},fromJsonString(u,d){return new c().fromJsonString(u,d)},equals(u,d){return i.util.equals(c,u,d)}}),c}function varint64read(){let i=0,e=0;for(let s=0;s<28;s+=7){let o=this.buf[this.pos++];if(i|=(o&127)<<s,!(o&128))return this.assertBounds(),[i,e]}let t=this.buf[this.pos++];if(i|=(t&15)<<28,e=(t&112)>>4,!(t&128))return this.assertBounds(),[i,e];for(let s=3;s<=31;s+=7){let o=this.buf[this.pos++];if(e|=(o&127)<<s,!(o&128))return this.assertBounds(),[i,e]}throw new Error("invalid varint")}function varint64write(i,e,t){for(let a=0;a<28;a=a+7){const c=i>>>a,u=!(!(c>>>7)&&e==0),d=(u?c|128:c)&255;if(t.push(d),!u)return}const s=i>>>28&15|(e&7)<<4,o=!!(e>>3);if(t.push((o?s|128:s)&255),!!o){for(let a=3;a<31;a=a+7){const c=e>>>a,u=!!(c>>>7),d=(u?c|128:c)&255;if(t.push(d),!u)return}t.push(e>>>31&1)}}const TWO_PWR_32_DBL=4294967296;function int64FromString(i){const e=i[0]==="-";e&&(i=i.slice(1));const t=1e6;let s=0,o=0;function a(c,u){const d=Number(i.slice(c,u));o*=t,s=s*t+d,s>=TWO_PWR_32_DBL&&(o=o+(s/TWO_PWR_32_DBL|0),s=s%TWO_PWR_32_DBL)}return a(-24,-18),a(-18,-12),a(-12,-6),a(-6),e?negate(s,o):newBits(s,o)}function int64ToString(i,e){let t=newBits(i,e);const s=t.hi&2147483648;s&&(t=negate(t.lo,t.hi));const o=uInt64ToString(t.lo,t.hi);return s?"-"+o:o}function uInt64ToString(i,e){if({lo:i,hi:e}=toUnsigned(i,e),e<=2097151)return String(TWO_PWR_32_DBL*e+i);const t=i&16777215,s=(i>>>24|e<<8)&16777215,o=e>>16&65535;let a=t+s*6777216+o*6710656,c=s+o*8147497,u=o*2;const d=1e7;return a>=d&&(c+=Math.floor(a/d),a%=d),c>=d&&(u+=Math.floor(c/d),c%=d),u.toString()+decimalFrom1e7WithLeadingZeros(c)+decimalFrom1e7WithLeadingZeros(a)}function toUnsigned(i,e){return{lo:i>>>0,hi:e>>>0}}function newBits(i,e){return{lo:i|0,hi:e|0}}function negate(i,e){return e=~e,i?i=~i+1:e+=1,newBits(i,e)}const decimalFrom1e7WithLeadingZeros=i=>{const e=String(i);return"0000000".slice(e.length)+e};function varint32write(i,e){if(i>=0){for(;i>127;)e.push(i&127|128),i=i>>>7;e.push(i)}else{for(let t=0;t<9;t++)e.push(i&127|128),i=i>>7;e.push(1)}}function varint32read(){let i=this.buf[this.pos++],e=i&127;if(!(i&128))return this.assertBounds(),e;if(i=this.buf[this.pos++],e|=(i&127)<<7,!(i&128))return this.assertBounds(),e;if(i=this.buf[this.pos++],e|=(i&127)<<14,!(i&128))return this.assertBounds(),e;if(i=this.buf[this.pos++],e|=(i&127)<<21,!(i&128))return this.assertBounds(),e;i=this.buf[this.pos++],e|=(i&15)<<28;for(let t=5;i&128&&t<10;t++)i=this.buf[this.pos++];if(i&128)throw new Error("invalid varint");return this.assertBounds(),e>>>0}function makeInt64Support(){const i=new DataView(new ArrayBuffer(8));if(typeof BigInt=="function"&&typeof i.getBigInt64=="function"&&typeof i.getBigUint64=="function"&&typeof i.setBigInt64=="function"&&typeof i.setBigUint64=="function"&&(typeof process!="object"||typeof define_process_env_default!="object"||define_process_env_default.BUF_BIGINT_DISABLE!=="1")){const o=BigInt("-9223372036854775808"),a=BigInt("9223372036854775807"),c=BigInt("0"),u=BigInt("18446744073709551615");return{zero:BigInt(0),supported:!0,parse(d){const p=typeof d=="bigint"?d:BigInt(d);if(p>a||p<o)throw new Error("int64 invalid: ".concat(d));return p},uParse(d){const p=typeof d=="bigint"?d:BigInt(d);if(p>u||p<c)throw new Error("uint64 invalid: ".concat(d));return p},enc(d){return i.setBigInt64(0,this.parse(d),!0),{lo:i.getInt32(0,!0),hi:i.getInt32(4,!0)}},uEnc(d){return i.setBigInt64(0,this.uParse(d),!0),{lo:i.getInt32(0,!0),hi:i.getInt32(4,!0)}},dec(d,p){return i.setInt32(0,d,!0),i.setInt32(4,p,!0),i.getBigInt64(0,!0)},uDec(d,p){return i.setInt32(0,d,!0),i.setInt32(4,p,!0),i.getBigUint64(0,!0)}}}const t=o=>assert(/^-?[0-9]+$/.test(o),"int64 invalid: ".concat(o)),s=o=>assert(/^[0-9]+$/.test(o),"uint64 invalid: ".concat(o));return{zero:"0",supported:!1,parse(o){return typeof o!="string"&&(o=o.toString()),t(o),o},uParse(o){return typeof o!="string"&&(o=o.toString()),s(o),o},enc(o){return typeof o!="string"&&(o=o.toString()),t(o),int64FromString(o)},uEnc(o){return typeof o!="string"&&(o=o.toString()),s(o),int64FromString(o)},dec(o,a){return int64ToString(o,a)},uDec(o,a){return uInt64ToString(o,a)}}}const protoInt64=makeInt64Support();var ScalarType;(function(i){i[i.DOUBLE=1]="DOUBLE",i[i.FLOAT=2]="FLOAT",i[i.INT64=3]="INT64",i[i.UINT64=4]="UINT64",i[i.INT32=5]="INT32",i[i.FIXED64=6]="FIXED64",i[i.FIXED32=7]="FIXED32",i[i.BOOL=8]="BOOL",i[i.STRING=9]="STRING",i[i.BYTES=12]="BYTES",i[i.UINT32=13]="UINT32",i[i.SFIXED32=15]="SFIXED32",i[i.SFIXED64=16]="SFIXED64",i[i.SINT32=17]="SINT32",i[i.SINT64=18]="SINT64"})(ScalarType||(ScalarType={}));var LongType;(function(i){i[i.BIGINT=0]="BIGINT",i[i.STRING=1]="STRING"})(LongType||(LongType={}));function scalarEquals(i,e,t){if(e===t)return!0;if(i==ScalarType.BYTES){if(!(e instanceof Uint8Array)||!(t instanceof Uint8Array)||e.length!==t.length)return!1;for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!1;return!0}switch(i){case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return e==t}return!1}function scalarZeroValue(i,e){switch(i){case ScalarType.BOOL:return!1;case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return e==0?protoInt64.zero:"0";case ScalarType.DOUBLE:case ScalarType.FLOAT:return 0;case ScalarType.BYTES:return new Uint8Array(0);case ScalarType.STRING:return"";default:return 0}}function isScalarZeroValue(i,e){switch(i){case ScalarType.BOOL:return e===!1;case ScalarType.STRING:return e==="";case ScalarType.BYTES:return e instanceof Uint8Array&&!e.byteLength;default:return e==0}}var WireType;(function(i){i[i.Varint=0]="Varint",i[i.Bit64=1]="Bit64",i[i.LengthDelimited=2]="LengthDelimited",i[i.StartGroup=3]="StartGroup",i[i.EndGroup=4]="EndGroup",i[i.Bit32=5]="Bit32"})(WireType||(WireType={}));class BinaryWriter{constructor(e){this.stack=[],this.textEncoder=e??new TextEncoder,this.chunks=[],this.buf=[]}finish(){this.chunks.push(new Uint8Array(this.buf));let e=0;for(let o=0;o<this.chunks.length;o++)e+=this.chunks[o].length;let t=new Uint8Array(e),s=0;for(let o=0;o<this.chunks.length;o++)t.set(this.chunks[o],s),s+=this.chunks[o].length;return this.chunks=[],t}fork(){return this.stack.push({chunks:this.chunks,buf:this.buf}),this.chunks=[],this.buf=[],this}join(){let e=this.finish(),t=this.stack.pop();if(!t)throw new Error("invalid state, fork stack empty");return this.chunks=t.chunks,this.buf=t.buf,this.uint32(e.byteLength),this.raw(e)}tag(e,t){return this.uint32((e<<3|t)>>>0)}raw(e){return this.buf.length&&(this.chunks.push(new Uint8Array(this.buf)),this.buf=[]),this.chunks.push(e),this}uint32(e){for(assertUInt32(e);e>127;)this.buf.push(e&127|128),e=e>>>7;return this.buf.push(e),this}int32(e){return assertInt32(e),varint32write(e,this.buf),this}bool(e){return this.buf.push(e?1:0),this}bytes(e){return this.uint32(e.byteLength),this.raw(e)}string(e){let t=this.textEncoder.encode(e);return this.uint32(t.byteLength),this.raw(t)}float(e){assertFloat32(e);let t=new Uint8Array(4);return new DataView(t.buffer).setFloat32(0,e,!0),this.raw(t)}double(e){let t=new Uint8Array(8);return new DataView(t.buffer).setFloat64(0,e,!0),this.raw(t)}fixed32(e){assertUInt32(e);let t=new Uint8Array(4);return new DataView(t.buffer).setUint32(0,e,!0),this.raw(t)}sfixed32(e){assertInt32(e);let t=new Uint8Array(4);return new DataView(t.buffer).setInt32(0,e,!0),this.raw(t)}sint32(e){return assertInt32(e),e=(e<<1^e>>31)>>>0,varint32write(e,this.buf),this}sfixed64(e){let t=new Uint8Array(8),s=new DataView(t.buffer),o=protoInt64.enc(e);return s.setInt32(0,o.lo,!0),s.setInt32(4,o.hi,!0),this.raw(t)}fixed64(e){let t=new Uint8Array(8),s=new DataView(t.buffer),o=protoInt64.uEnc(e);return s.setInt32(0,o.lo,!0),s.setInt32(4,o.hi,!0),this.raw(t)}int64(e){let t=protoInt64.enc(e);return varint64write(t.lo,t.hi,this.buf),this}sint64(e){let t=protoInt64.enc(e),s=t.hi>>31,o=t.lo<<1^s,a=(t.hi<<1|t.lo>>>31)^s;return varint64write(o,a,this.buf),this}uint64(e){let t=protoInt64.uEnc(e);return varint64write(t.lo,t.hi,this.buf),this}}class BinaryReader{constructor(e,t){this.varint64=varint64read,this.uint32=varint32read,this.buf=e,this.len=e.length,this.pos=0,this.view=new DataView(e.buffer,e.byteOffset,e.byteLength),this.textDecoder=t??new TextDecoder}tag(){let e=this.uint32(),t=e>>>3,s=e&7;if(t<=0||s<0||s>5)throw new Error("illegal tag: field no "+t+" wire type "+s);return[t,s]}skip(e,t){let s=this.pos;switch(e){case WireType.Varint:for(;this.buf[this.pos++]&128;);break;case WireType.Bit64:this.pos+=4;case WireType.Bit32:this.pos+=4;break;case WireType.LengthDelimited:let o=this.uint32();this.pos+=o;break;case WireType.StartGroup:for(;;){const[a,c]=this.tag();if(c===WireType.EndGroup){if(t!==void 0&&a!==t)throw new Error("invalid end group tag");break}this.skip(c,a)}break;default:throw new Error("cant skip wire type "+e)}return this.assertBounds(),this.buf.subarray(s,this.pos)}assertBounds(){if(this.pos>this.len)throw new RangeError("premature EOF")}int32(){return this.uint32()|0}sint32(){let e=this.uint32();return e>>>1^-(e&1)}int64(){return protoInt64.dec(...this.varint64())}uint64(){return protoInt64.uDec(...this.varint64())}sint64(){let[e,t]=this.varint64(),s=-(e&1);return e=(e>>>1|(t&1)<<31)^s,t=t>>>1^s,protoInt64.dec(e,t)}bool(){let[e,t]=this.varint64();return e!==0||t!==0}fixed32(){return this.view.getUint32((this.pos+=4)-4,!0)}sfixed32(){return this.view.getInt32((this.pos+=4)-4,!0)}fixed64(){return protoInt64.uDec(this.sfixed32(),this.sfixed32())}sfixed64(){return protoInt64.dec(this.sfixed32(),this.sfixed32())}float(){return this.view.getFloat32((this.pos+=4)-4,!0)}double(){return this.view.getFloat64((this.pos+=8)-8,!0)}bytes(){let e=this.uint32(),t=this.pos;return this.pos+=e,this.assertBounds(),this.buf.subarray(t,t+e)}string(){return this.textDecoder.decode(this.bytes())}}function makeExtension(i,e,t,s){let o;return{typeName:e,extendee:t,get field(){if(!o){const a=typeof s=="function"?s():s;a.name=e.split(".").pop(),a.jsonName="[".concat(e,"]"),o=i.util.newFieldList([a]).list()[0]}return o},runtime:i}}function createExtensionContainer(i){const e=i.field.localName,t=Object.create(null);return t[e]=initExtensionField(i),[t,()=>t[e]]}function initExtensionField(i){const e=i.field;if(e.repeated)return[];if(e.default!==void 0)return e.default;switch(e.kind){case"enum":return e.T.values[0].no;case"scalar":return scalarZeroValue(e.T,e.L);case"message":const t=e.T,s=new t;return t.fieldWrapper?t.fieldWrapper.unwrapField(s):s;case"map":throw"map fields are not allowed to be extensions"}}function filterUnknownFields(i,e){if(!e.repeated&&(e.kind=="enum"||e.kind=="scalar")){for(let t=i.length-1;t>=0;--t)if(i[t].no==e.no)return[i[t]];return[]}return i.filter(t=>t.no===e.no)}let encTable="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split(""),decTable=[];for(let i=0;i<encTable.length;i++)decTable[encTable[i].charCodeAt(0)]=i;decTable[45]=encTable.indexOf("+");decTable[95]=encTable.indexOf("/");const protoBase64={dec(i){let e=i.length*3/4;i[i.length-2]=="="?e-=2:i[i.length-1]=="="&&(e-=1);let t=new Uint8Array(e),s=0,o=0,a,c=0;for(let u=0;u<i.length;u++){if(a=decTable[i.charCodeAt(u)],a===void 0)switch(i[u]){case"=":o=0;case`
`:case"\r":case"	":case" ":continue;default:throw Error("invalid base64 string.")}switch(o){case 0:c=a,o=1;break;case 1:t[s++]=c<<2|(a&48)>>4,c=a,o=2;break;case 2:t[s++]=(c&15)<<4|(a&60)>>2,c=a,o=3;break;case 3:t[s++]=(c&3)<<6|a,o=0;break}}if(o==1)throw Error("invalid base64 string.");return t.subarray(0,s)},enc(i){let e="",t=0,s,o=0;for(let a=0;a<i.length;a++)switch(s=i[a],t){case 0:e+=encTable[s>>2],o=(s&3)<<4,t=1;break;case 1:e+=encTable[o|s>>4],o=(s&15)<<2,t=2;break;case 2:e+=encTable[o|s>>6],e+=encTable[s&63],t=0;break}return t&&(e+=encTable[o],e+="=",t==1&&(e+="=")),e}};function getExtension(i,e,t){assertExtendee(e,i);const s=e.runtime.bin.makeReadOptions(t),o=filterUnknownFields(i.getType().runtime.bin.listUnknownFields(i),e.field),[a,c]=createExtensionContainer(e);for(const u of o)e.runtime.bin.readField(a,s.readerFactory(u.data),e.field,u.wireType,s);return c()}function setExtension(i,e,t,s){assertExtendee(e,i);const o=e.runtime.bin.makeReadOptions(s),a=e.runtime.bin.makeWriteOptions(s);if(hasExtension(i,e)){const p=i.getType().runtime.bin.listUnknownFields(i).filter(v=>v.no!=e.field.no);i.getType().runtime.bin.discardUnknownFields(i);for(const v of p)i.getType().runtime.bin.onUnknownField(i,v.no,v.wireType,v.data)}const c=a.writerFactory();let u=e.field;!u.opt&&!u.repeated&&(u.kind=="enum"||u.kind=="scalar")&&(u=Object.assign(Object.assign({},e.field),{opt:!0})),e.runtime.bin.writeField(u,t,c,a);const d=o.readerFactory(c.finish());for(;d.pos<d.len;){const[p,v]=d.tag(),g=d.skip(v,p);i.getType().runtime.bin.onUnknownField(i,p,v,g)}}function hasExtension(i,e){const t=i.getType();return e.extendee.typeName===t.typeName&&!!t.runtime.bin.listUnknownFields(i).find(s=>s.no==e.field.no)}function assertExtendee(i,e){assert(i.extendee.typeName==e.getType().typeName,"extension ".concat(i.typeName," can only be applied to message ").concat(i.extendee.typeName))}function isFieldSet(i,e){const t=i.localName;if(i.repeated)return e[t].length>0;if(i.oneof)return e[i.oneof.localName].case===t;switch(i.kind){case"enum":case"scalar":return i.opt||i.req?e[t]!==void 0:i.kind=="enum"?e[t]!==i.T.values[0].no:!isScalarZeroValue(i.T,e[t]);case"message":return e[t]!==void 0;case"map":return Object.keys(e[t]).length>0}}function clearField(i,e){const t=i.localName,s=!i.opt&&!i.req;if(i.repeated)e[t]=[];else if(i.oneof)e[i.oneof.localName]={case:void 0};else switch(i.kind){case"map":e[t]={};break;case"enum":e[t]=s?i.T.values[0].no:void 0;break;case"scalar":e[t]=s?scalarZeroValue(i.T,i.L):void 0;break;case"message":e[t]=void 0;break}}function isMessage(i,e){if(i===null||typeof i!="object"||!Object.getOwnPropertyNames(Message$1.prototype).every(s=>s in i&&typeof i[s]=="function"))return!1;const t=i.getType();return t===null||typeof t!="function"||!("typeName"in t)||typeof t.typeName!="string"?!1:e===void 0?!0:t.typeName==e.typeName}function wrapField(i,e){return isMessage(e)||!i.fieldWrapper?e:i.fieldWrapper.wrapField(e)}ScalarType.DOUBLE,ScalarType.FLOAT,ScalarType.INT64,ScalarType.UINT64,ScalarType.INT32,ScalarType.UINT32,ScalarType.BOOL,ScalarType.STRING,ScalarType.BYTES;const jsonReadDefaults={ignoreUnknownFields:!1},jsonWriteDefaults={emitDefaultValues:!1,enumAsInteger:!1,useProtoFieldName:!1,prettySpaces:0};function makeReadOptions$1(i){return i?Object.assign(Object.assign({},jsonReadDefaults),i):jsonReadDefaults}function makeWriteOptions$1(i){return i?Object.assign(Object.assign({},jsonWriteDefaults),i):jsonWriteDefaults}const tokenNull=Symbol(),tokenIgnoredUnknownEnum=Symbol();function makeJsonFormat(){return{makeReadOptions:makeReadOptions$1,makeWriteOptions:makeWriteOptions$1,readMessage(i,e,t,s){if(e==null||Array.isArray(e)||typeof e!="object")throw new Error("cannot decode message ".concat(i.typeName," from JSON: ").concat(debugJsonValue(e)));s=s??new i;const o=new Map,a=t.typeRegistry;for(const[c,u]of Object.entries(e)){const d=i.fields.findJsonName(c);if(d){if(d.oneof){if(u===null&&d.kind=="scalar")continue;const p=o.get(d.oneof);if(p!==void 0)throw new Error("cannot decode message ".concat(i.typeName,' from JSON: multiple keys for oneof "').concat(d.oneof.name,'" present: "').concat(p,'", "').concat(c,'"'));o.set(d.oneof,c)}readField$1(s,u,d,t,i)}else{let p=!1;if(a!=null&&a.findExtension&&c.startsWith("[")&&c.endsWith("]")){const v=a.findExtension(c.substring(1,c.length-1));if(v&&v.extendee.typeName==i.typeName){p=!0;const[g,m]=createExtensionContainer(v);readField$1(g,u,v.field,t,v),setExtension(s,v,m(),t)}}if(!p&&!t.ignoreUnknownFields)throw new Error("cannot decode message ".concat(i.typeName,' from JSON: key "').concat(c,'" is unknown'))}}return s},writeMessage(i,e){const t=i.getType(),s={};let o;try{for(o of t.fields.byNumber()){if(!isFieldSet(o,i)){if(o.req)throw"required field not set";if(!e.emitDefaultValues||!canEmitFieldDefaultValue(o))continue}const c=o.oneof?i[o.oneof.localName].value:i[o.localName],u=writeField$1(o,c,e);u!==void 0&&(s[e.useProtoFieldName?o.name:o.jsonName]=u)}const a=e.typeRegistry;if(a!=null&&a.findExtensionFor)for(const c of t.runtime.bin.listUnknownFields(i)){const u=a.findExtensionFor(t.typeName,c.no);if(u&&hasExtension(i,u)){const d=getExtension(i,u,e),p=writeField$1(u.field,d,e);p!==void 0&&(s[u.field.jsonName]=p)}}}catch(a){const c=o?"cannot encode field ".concat(t.typeName,".").concat(o.name," to JSON"):"cannot encode message ".concat(t.typeName," to JSON"),u=a instanceof Error?a.message:String(a);throw new Error(c+(u.length>0?": ".concat(u):""))}return s},readScalar(i,e,t){return readScalar$1(i,e,t??LongType.BIGINT,!0)},writeScalar(i,e,t){if(e!==void 0&&(t||isScalarZeroValue(i,e)))return writeScalar$1(i,e)},debug:debugJsonValue}}function debugJsonValue(i){if(i===null)return"null";switch(typeof i){case"object":return Array.isArray(i)?"array":"object";case"string":return i.length>100?"string":'"'.concat(i.split('"').join('\\"'),'"');default:return String(i)}}function readField$1(i,e,t,s,o){let a=t.localName;if(t.repeated){if(assert(t.kind!="map"),e===null)return;if(!Array.isArray(e))throw new Error("cannot decode field ".concat(o.typeName,".").concat(t.name," from JSON: ").concat(debugJsonValue(e)));const c=i[a];for(const u of e){if(u===null)throw new Error("cannot decode field ".concat(o.typeName,".").concat(t.name," from JSON: ").concat(debugJsonValue(u)));switch(t.kind){case"message":c.push(t.T.fromJson(u,s));break;case"enum":const d=readEnum(t.T,u,s.ignoreUnknownFields,!0);d!==tokenIgnoredUnknownEnum&&c.push(d);break;case"scalar":try{c.push(readScalar$1(t.T,u,t.L,!0))}catch(p){let v="cannot decode field ".concat(o.typeName,".").concat(t.name," from JSON: ").concat(debugJsonValue(u));throw p instanceof Error&&p.message.length>0&&(v+=": ".concat(p.message)),new Error(v)}break}}}else if(t.kind=="map"){if(e===null)return;if(typeof e!="object"||Array.isArray(e))throw new Error("cannot decode field ".concat(o.typeName,".").concat(t.name," from JSON: ").concat(debugJsonValue(e)));const c=i[a];for(const[u,d]of Object.entries(e)){if(d===null)throw new Error("cannot decode field ".concat(o.typeName,".").concat(t.name," from JSON: map value null"));let p;try{p=readMapKey(t.K,u)}catch(v){let g="cannot decode map key for field ".concat(o.typeName,".").concat(t.name," from JSON: ").concat(debugJsonValue(e));throw v instanceof Error&&v.message.length>0&&(g+=": ".concat(v.message)),new Error(g)}switch(t.V.kind){case"message":c[p]=t.V.T.fromJson(d,s);break;case"enum":const v=readEnum(t.V.T,d,s.ignoreUnknownFields,!0);v!==tokenIgnoredUnknownEnum&&(c[p]=v);break;case"scalar":try{c[p]=readScalar$1(t.V.T,d,LongType.BIGINT,!0)}catch(g){let m="cannot decode map value for field ".concat(o.typeName,".").concat(t.name," from JSON: ").concat(debugJsonValue(e));throw g instanceof Error&&g.message.length>0&&(m+=": ".concat(g.message)),new Error(m)}break}}}else switch(t.oneof&&(i=i[t.oneof.localName]={case:a},a="value"),t.kind){case"message":const c=t.T;if(e===null&&c.typeName!="google.protobuf.Value")return;let u=i[a];isMessage(u)?u.fromJson(e,s):(i[a]=u=c.fromJson(e,s),c.fieldWrapper&&!t.oneof&&(i[a]=c.fieldWrapper.unwrapField(u)));break;case"enum":const d=readEnum(t.T,e,s.ignoreUnknownFields,!1);switch(d){case tokenNull:clearField(t,i);break;case tokenIgnoredUnknownEnum:break;default:i[a]=d;break}break;case"scalar":try{const p=readScalar$1(t.T,e,t.L,!1);switch(p){case tokenNull:clearField(t,i);break;default:i[a]=p;break}}catch(p){let v="cannot decode field ".concat(o.typeName,".").concat(t.name," from JSON: ").concat(debugJsonValue(e));throw p instanceof Error&&p.message.length>0&&(v+=": ".concat(p.message)),new Error(v)}break}}function readMapKey(i,e){if(i===ScalarType.BOOL)switch(e){case"true":e=!0;break;case"false":e=!1;break}return readScalar$1(i,e,LongType.BIGINT,!0).toString()}function readScalar$1(i,e,t,s){if(e===null)return s?scalarZeroValue(i,t):tokenNull;switch(i){case ScalarType.DOUBLE:case ScalarType.FLOAT:if(e==="NaN")return Number.NaN;if(e==="Infinity")return Number.POSITIVE_INFINITY;if(e==="-Infinity")return Number.NEGATIVE_INFINITY;if(e===""||typeof e=="string"&&e.trim().length!==e.length||typeof e!="string"&&typeof e!="number")break;const o=Number(e);if(Number.isNaN(o)||!Number.isFinite(o))break;return i==ScalarType.FLOAT&&assertFloat32(o),o;case ScalarType.INT32:case ScalarType.FIXED32:case ScalarType.SFIXED32:case ScalarType.SINT32:case ScalarType.UINT32:let a;if(typeof e=="number"?a=e:typeof e=="string"&&e.length>0&&e.trim().length===e.length&&(a=Number(e)),a===void 0)break;return i==ScalarType.UINT32||i==ScalarType.FIXED32?assertUInt32(a):assertInt32(a),a;case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:if(typeof e!="number"&&typeof e!="string")break;const c=protoInt64.parse(e);return t?c.toString():c;case ScalarType.FIXED64:case ScalarType.UINT64:if(typeof e!="number"&&typeof e!="string")break;const u=protoInt64.uParse(e);return t?u.toString():u;case ScalarType.BOOL:if(typeof e!="boolean")break;return e;case ScalarType.STRING:if(typeof e!="string")break;try{encodeURIComponent(e)}catch{throw new Error("invalid UTF8")}return e;case ScalarType.BYTES:if(e==="")return new Uint8Array(0);if(typeof e!="string")break;return protoBase64.dec(e)}throw new Error}function readEnum(i,e,t,s){if(e===null)return i.typeName=="google.protobuf.NullValue"?0:s?i.values[0].no:tokenNull;switch(typeof e){case"number":if(Number.isInteger(e))return e;break;case"string":const o=i.findName(e);if(o!==void 0)return o.no;if(t)return tokenIgnoredUnknownEnum;break}throw new Error("cannot decode enum ".concat(i.typeName," from JSON: ").concat(debugJsonValue(e)))}function canEmitFieldDefaultValue(i){return i.repeated||i.kind=="map"?!0:!(i.oneof||i.kind=="message"||i.opt||i.req)}function writeField$1(i,e,t){if(i.kind=="map"){assert(typeof e=="object"&&e!=null);const s={},o=Object.entries(e);switch(i.V.kind){case"scalar":for(const[c,u]of o)s[c.toString()]=writeScalar$1(i.V.T,u);break;case"message":for(const[c,u]of o)s[c.toString()]=u.toJson(t);break;case"enum":const a=i.V.T;for(const[c,u]of o)s[c.toString()]=writeEnum(a,u,t.enumAsInteger);break}return t.emitDefaultValues||o.length>0?s:void 0}if(i.repeated){assert(Array.isArray(e));const s=[];switch(i.kind){case"scalar":for(let o=0;o<e.length;o++)s.push(writeScalar$1(i.T,e[o]));break;case"enum":for(let o=0;o<e.length;o++)s.push(writeEnum(i.T,e[o],t.enumAsInteger));break;case"message":for(let o=0;o<e.length;o++)s.push(e[o].toJson(t));break}return t.emitDefaultValues||s.length>0?s:void 0}switch(i.kind){case"scalar":return writeScalar$1(i.T,e);case"enum":return writeEnum(i.T,e,t.enumAsInteger);case"message":return wrapField(i.T,e).toJson(t)}}function writeEnum(i,e,t){var s;if(assert(typeof e=="number"),i.typeName=="google.protobuf.NullValue")return null;if(t)return e;const o=i.findNumber(e);return(s=o==null?void 0:o.name)!==null&&s!==void 0?s:e}function writeScalar$1(i,e){switch(i){case ScalarType.INT32:case ScalarType.SFIXED32:case ScalarType.SINT32:case ScalarType.FIXED32:case ScalarType.UINT32:return assert(typeof e=="number"),e;case ScalarType.FLOAT:case ScalarType.DOUBLE:return assert(typeof e=="number"),Number.isNaN(e)?"NaN":e===Number.POSITIVE_INFINITY?"Infinity":e===Number.NEGATIVE_INFINITY?"-Infinity":e;case ScalarType.STRING:return assert(typeof e=="string"),e;case ScalarType.BOOL:return assert(typeof e=="boolean"),e;case ScalarType.UINT64:case ScalarType.FIXED64:case ScalarType.INT64:case ScalarType.SFIXED64:case ScalarType.SINT64:return assert(typeof e=="bigint"||typeof e=="string"||typeof e=="number"),e.toString();case ScalarType.BYTES:return assert(e instanceof Uint8Array),protoBase64.enc(e)}}const unknownFieldsSymbol=Symbol("@bufbuild/protobuf/unknown-fields"),readDefaults={readUnknownFields:!0,readerFactory:i=>new BinaryReader(i)},writeDefaults={writeUnknownFields:!0,writerFactory:()=>new BinaryWriter};function makeReadOptions(i){return i?Object.assign(Object.assign({},readDefaults),i):readDefaults}function makeWriteOptions(i){return i?Object.assign(Object.assign({},writeDefaults),i):writeDefaults}function makeBinaryFormat(){return{makeReadOptions,makeWriteOptions,listUnknownFields(i){var e;return(e=i[unknownFieldsSymbol])!==null&&e!==void 0?e:[]},discardUnknownFields(i){delete i[unknownFieldsSymbol]},writeUnknownFields(i,e){const s=i[unknownFieldsSymbol];if(s)for(const o of s)e.tag(o.no,o.wireType).raw(o.data)},onUnknownField(i,e,t,s){const o=i;Array.isArray(o[unknownFieldsSymbol])||(o[unknownFieldsSymbol]=[]),o[unknownFieldsSymbol].push({no:e,wireType:t,data:s})},readMessage(i,e,t,s,o){const a=i.getType(),c=o?e.len:e.pos+t;let u,d;for(;e.pos<c&&([u,d]=e.tag(),!(o===!0&&d==WireType.EndGroup));){const p=a.fields.find(u);if(!p){const v=e.skip(d,u);s.readUnknownFields&&this.onUnknownField(i,u,d,v);continue}readField(i,e,p,d,s)}if(o&&(d!=WireType.EndGroup||u!==t))throw new Error("invalid end group tag")},readField,writeMessage(i,e,t){const s=i.getType();for(const o of s.fields.byNumber()){if(!isFieldSet(o,i)){if(o.req)throw new Error("cannot encode field ".concat(s.typeName,".").concat(o.name," to binary: required field not set"));continue}const a=o.oneof?i[o.oneof.localName].value:i[o.localName];writeField(o,a,e,t)}return t.writeUnknownFields&&this.writeUnknownFields(i,e),e},writeField(i,e,t,s){e!==void 0&&writeField(i,e,t,s)}}}function readField(i,e,t,s,o){let{repeated:a,localName:c}=t;switch(t.oneof&&(i=i[t.oneof.localName],i.case!=c&&delete i.value,i.case=c,c="value"),t.kind){case"scalar":case"enum":const u=t.kind=="enum"?ScalarType.INT32:t.T;let d=readScalar;if(t.kind=="scalar"&&t.L>0&&(d=readScalarLTString),a){let m=i[c];if(s==WireType.LengthDelimited&&u!=ScalarType.STRING&&u!=ScalarType.BYTES){let y=e.uint32()+e.pos;for(;e.pos<y;)m.push(d(e,u))}else m.push(d(e,u))}else i[c]=d(e,u);break;case"message":const p=t.T;a?i[c].push(readMessageField(e,new p,o,t)):isMessage(i[c])?readMessageField(e,i[c],o,t):(i[c]=readMessageField(e,new p,o,t),p.fieldWrapper&&!t.oneof&&!t.repeated&&(i[c]=p.fieldWrapper.unwrapField(i[c])));break;case"map":let[v,g]=readMapEntry(t,e,o);i[c][v]=g;break}}function readMessageField(i,e,t,s){const o=e.getType().runtime.bin,a=s==null?void 0:s.delimited;return o.readMessage(e,i,a?s.no:i.uint32(),t,a),e}function readMapEntry(i,e,t){const s=e.uint32(),o=e.pos+s;let a,c;for(;e.pos<o;){const[u]=e.tag();switch(u){case 1:a=readScalar(e,i.K);break;case 2:switch(i.V.kind){case"scalar":c=readScalar(e,i.V.T);break;case"enum":c=e.int32();break;case"message":c=readMessageField(e,new i.V.T,t,void 0);break}break}}if(a===void 0&&(a=scalarZeroValue(i.K,LongType.BIGINT)),typeof a!="string"&&typeof a!="number"&&(a=a.toString()),c===void 0)switch(i.V.kind){case"scalar":c=scalarZeroValue(i.V.T,LongType.BIGINT);break;case"enum":c=i.V.T.values[0].no;break;case"message":c=new i.V.T;break}return[a,c]}function readScalarLTString(i,e){const t=readScalar(i,e);return typeof t=="bigint"?t.toString():t}function readScalar(i,e){switch(e){case ScalarType.STRING:return i.string();case ScalarType.BOOL:return i.bool();case ScalarType.DOUBLE:return i.double();case ScalarType.FLOAT:return i.float();case ScalarType.INT32:return i.int32();case ScalarType.INT64:return i.int64();case ScalarType.UINT64:return i.uint64();case ScalarType.FIXED64:return i.fixed64();case ScalarType.BYTES:return i.bytes();case ScalarType.FIXED32:return i.fixed32();case ScalarType.SFIXED32:return i.sfixed32();case ScalarType.SFIXED64:return i.sfixed64();case ScalarType.SINT64:return i.sint64();case ScalarType.UINT32:return i.uint32();case ScalarType.SINT32:return i.sint32()}}function writeField(i,e,t,s){assert(e!==void 0);const o=i.repeated;switch(i.kind){case"scalar":case"enum":let a=i.kind=="enum"?ScalarType.INT32:i.T;if(o)if(assert(Array.isArray(e)),i.packed)writePacked(t,a,i.no,e);else for(const c of e)writeScalar(t,a,i.no,c);else writeScalar(t,a,i.no,e);break;case"message":if(o){assert(Array.isArray(e));for(const c of e)writeMessageField(t,s,i,c)}else writeMessageField(t,s,i,e);break;case"map":assert(typeof e=="object"&&e!=null);for(const[c,u]of Object.entries(e))writeMapEntry(t,s,i,c,u);break}}function writeMapEntry(i,e,t,s,o){i.tag(t.no,WireType.LengthDelimited),i.fork();let a=s;switch(t.K){case ScalarType.INT32:case ScalarType.FIXED32:case ScalarType.UINT32:case ScalarType.SFIXED32:case ScalarType.SINT32:a=Number.parseInt(s);break;case ScalarType.BOOL:assert(s=="true"||s=="false"),a=s=="true";break}switch(writeScalar(i,t.K,1,a),t.V.kind){case"scalar":writeScalar(i,t.V.T,2,o);break;case"enum":writeScalar(i,ScalarType.INT32,2,o);break;case"message":assert(o!==void 0),i.tag(2,WireType.LengthDelimited).bytes(o.toBinary(e));break}i.join()}function writeMessageField(i,e,t,s){const o=wrapField(t.T,s);t.delimited?i.tag(t.no,WireType.StartGroup).raw(o.toBinary(e)).tag(t.no,WireType.EndGroup):i.tag(t.no,WireType.LengthDelimited).bytes(o.toBinary(e))}function writeScalar(i,e,t,s){assert(s!==void 0);let[o,a]=scalarTypeInfo(e);i.tag(t,o)[a](s)}function writePacked(i,e,t,s){if(!s.length)return;i.tag(t,WireType.LengthDelimited).fork();let[,o]=scalarTypeInfo(e);for(let a=0;a<s.length;a++)i[o](s[a]);i.join()}function scalarTypeInfo(i){let e=WireType.Varint;switch(i){case ScalarType.BYTES:case ScalarType.STRING:e=WireType.LengthDelimited;break;case ScalarType.DOUBLE:case ScalarType.FIXED64:case ScalarType.SFIXED64:e=WireType.Bit64;break;case ScalarType.FIXED32:case ScalarType.SFIXED32:case ScalarType.FLOAT:e=WireType.Bit32;break}const t=ScalarType[i].toLowerCase();return[e,t]}function makeUtilCommon(){return{setEnumType,initPartial(i,e){if(i===void 0)return;const t=e.getType();for(const s of t.fields.byMember()){const o=s.localName,a=e,c=i;if(c[o]!=null)switch(s.kind){case"oneof":const u=c[o].case;if(u===void 0)continue;const d=s.findField(u);let p=c[o].value;d&&d.kind=="message"&&!isMessage(p,d.T)?p=new d.T(p):d&&d.kind==="scalar"&&d.T===ScalarType.BYTES&&(p=toU8Arr(p)),a[o]={case:u,value:p};break;case"scalar":case"enum":let v=c[o];s.T===ScalarType.BYTES&&(v=s.repeated?v.map(toU8Arr):toU8Arr(v)),a[o]=v;break;case"map":switch(s.V.kind){case"scalar":case"enum":if(s.V.T===ScalarType.BYTES)for(const[S,y]of Object.entries(c[o]))a[o][S]=toU8Arr(y);else Object.assign(a[o],c[o]);break;case"message":const m=s.V.T;for(const S of Object.keys(c[o])){let y=c[o][S];m.fieldWrapper||(y=new m(y)),a[o][S]=y}break}break;case"message":const g=s.T;if(s.repeated)a[o]=c[o].map(m=>isMessage(m,g)?m:new g(m));else{const m=c[o];g.fieldWrapper?g.typeName==="google.protobuf.BytesValue"?a[o]=toU8Arr(m):a[o]=m:a[o]=isMessage(m,g)?m:new g(m)}break}}},equals(i,e,t){return e===t?!0:!e||!t?!1:i.fields.byMember().every(s=>{const o=e[s.localName],a=t[s.localName];if(s.repeated){if(o.length!==a.length)return!1;switch(s.kind){case"message":return o.every((c,u)=>s.T.equals(c,a[u]));case"scalar":return o.every((c,u)=>scalarEquals(s.T,c,a[u]));case"enum":return o.every((c,u)=>scalarEquals(ScalarType.INT32,c,a[u]))}throw new Error("repeated cannot contain ".concat(s.kind))}switch(s.kind){case"message":return s.T.equals(o,a);case"enum":return scalarEquals(ScalarType.INT32,o,a);case"scalar":return scalarEquals(s.T,o,a);case"oneof":if(o.case!==a.case)return!1;const c=s.findField(o.case);if(c===void 0)return!0;switch(c.kind){case"message":return c.T.equals(o.value,a.value);case"enum":return scalarEquals(ScalarType.INT32,o.value,a.value);case"scalar":return scalarEquals(c.T,o.value,a.value)}throw new Error("oneof cannot contain ".concat(c.kind));case"map":const u=Object.keys(o).concat(Object.keys(a));switch(s.V.kind){case"message":const d=s.V.T;return u.every(v=>d.equals(o[v],a[v]));case"enum":return u.every(v=>scalarEquals(ScalarType.INT32,o[v],a[v]));case"scalar":const p=s.V.T;return u.every(v=>scalarEquals(p,o[v],a[v]))}break}})},clone(i){const e=i.getType(),t=new e,s=t;for(const o of e.fields.byMember()){const a=i[o.localName];let c;if(o.repeated)c=a.map(cloneSingularField);else if(o.kind=="map"){c=s[o.localName];for(const[u,d]of Object.entries(a))c[u]=cloneSingularField(d)}else o.kind=="oneof"?c=o.findField(a.case)?{case:a.case,value:cloneSingularField(a.value)}:{case:void 0}:c=cloneSingularField(a);s[o.localName]=c}for(const o of e.runtime.bin.listUnknownFields(i))e.runtime.bin.onUnknownField(s,o.no,o.wireType,o.data);return t}}}function cloneSingularField(i){if(i===void 0)return i;if(isMessage(i))return i.clone();if(i instanceof Uint8Array){const e=new Uint8Array(i.byteLength);return e.set(i),e}return i}function toU8Arr(i){return i instanceof Uint8Array?i:new Uint8Array(i)}function makeProtoRuntime(i,e,t){return{syntax:i,json:makeJsonFormat(),bin:makeBinaryFormat(),util:Object.assign(Object.assign({},makeUtilCommon()),{newFieldList:e,initFields:t}),makeMessageType(s,o,a){return makeMessageType(this,s,o,a)},makeEnum,makeEnumType,getEnumType,makeExtension(s,o,a){return makeExtension(this,s,o,a)}}}class InternalFieldList{constructor(e,t){this._fields=e,this._normalizer=t}findJsonName(e){if(!this.jsonNames){const t={};for(const s of this.list())t[s.jsonName]=t[s.name]=s;this.jsonNames=t}return this.jsonNames[e]}find(e){if(!this.numbers){const t={};for(const s of this.list())t[s.no]=s;this.numbers=t}return this.numbers[e]}list(){return this.all||(this.all=this._normalizer(this._fields)),this.all}byNumber(){return this.numbersAsc||(this.numbersAsc=this.list().concat().sort((e,t)=>e.no-t.no)),this.numbersAsc}byMember(){if(!this.members){this.members=[];const e=this.members;let t;for(const s of this.list())s.oneof?s.oneof!==t&&(t=s.oneof,e.push(t)):e.push(s)}return this.members}}function localFieldName(i,e){const t=protoCamelCase(i);return e?t:safeObjectProperty(safeMessageProperty(t))}function localOneofName(i){return localFieldName(i,!1)}const fieldJsonName=protoCamelCase;function protoCamelCase(i){let e=!1;const t=[];for(let s=0;s<i.length;s++){let o=i.charAt(s);switch(o){case"_":e=!0;break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":t.push(o),e=!1;break;default:e&&(e=!1,o=o.toUpperCase()),t.push(o);break}}return t.join("")}const reservedObjectProperties=new Set(["constructor","toString","toJSON","valueOf"]),reservedMessageProperties=new Set(["getType","clone","equals","fromBinary","fromJson","fromJsonString","toBinary","toJson","toJsonString","toObject"]),fallback=i=>"".concat(i,"$"),safeMessageProperty=i=>reservedMessageProperties.has(i)?fallback(i):i,safeObjectProperty=i=>reservedObjectProperties.has(i)?fallback(i):i;class InternalOneofInfo{constructor(e){this.kind="oneof",this.repeated=!1,this.packed=!1,this.opt=!1,this.req=!1,this.default=void 0,this.fields=[],this.name=e,this.localName=localOneofName(e)}addField(e){assert(e.oneof===this,"field ".concat(e.name," not one of ").concat(this.name)),this.fields.push(e)}findField(e){if(!this._lookup){this._lookup=Object.create(null);for(let t=0;t<this.fields.length;t++)this._lookup[this.fields[t].localName]=this.fields[t]}return this._lookup[e]}}function normalizeFieldInfos(i,e){var t,s,o,a,c,u;const d=[];let p;for(const v of typeof i=="function"?i():i){const g=v;if(g.localName=localFieldName(v.name,v.oneof!==void 0),g.jsonName=(t=v.jsonName)!==null&&t!==void 0?t:fieldJsonName(v.name),g.repeated=(s=v.repeated)!==null&&s!==void 0?s:!1,v.kind=="scalar"&&(g.L=(o=v.L)!==null&&o!==void 0?o:LongType.BIGINT),g.delimited=(a=v.delimited)!==null&&a!==void 0?a:!1,g.req=(c=v.req)!==null&&c!==void 0?c:!1,g.opt=(u=v.opt)!==null&&u!==void 0?u:!1,v.packed===void 0&&(g.packed=v.kind=="enum"||v.kind=="scalar"&&v.T!=ScalarType.BYTES&&v.T!=ScalarType.STRING),v.oneof!==void 0){const m=typeof v.oneof=="string"?v.oneof:v.oneof.name;(!p||p.name!=m)&&(p=new InternalOneofInfo(m)),g.oneof=p,p.addField(g)}d.push(g)}return d}const proto3=makeProtoRuntime("proto3",i=>new InternalFieldList(i,e=>normalizeFieldInfos(e)),i=>{for(const e of i.getType().fields.byMember()){if(e.opt)continue;const t=e.localName,s=i;if(e.repeated){s[t]=[];continue}switch(e.kind){case"oneof":s[t]={case:void 0};break;case"enum":s[t]=0;break;case"map":s[t]={};break;case"scalar":s[t]=scalarZeroValue(e.T,e.L);break}}});class Timestamp extends Message$1{constructor(e){super(),this.seconds=protoInt64.zero,this.nanos=0,proto3.util.initPartial(e,this)}fromJson(e,t){if(typeof e!="string")throw new Error("cannot decode google.protobuf.Timestamp from JSON: ".concat(proto3.json.debug(e)));const s=e.match(/^([0-9]{4})-([0-9]{2})-([0-9]{2})T([0-9]{2}):([0-9]{2}):([0-9]{2})(?:Z|\.([0-9]{3,9})Z|([+-][0-9][0-9]:[0-9][0-9]))$/);if(!s)throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");const o=Date.parse(s[1]+"-"+s[2]+"-"+s[3]+"T"+s[4]+":"+s[5]+":"+s[6]+(s[8]?s[8]:"Z"));if(Number.isNaN(o))throw new Error("cannot decode google.protobuf.Timestamp from JSON: invalid RFC 3339 string");if(o<Date.parse("0001-01-01T00:00:00Z")||o>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot decode message google.protobuf.Timestamp from JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");return this.seconds=protoInt64.parse(o/1e3),this.nanos=0,s[7]&&(this.nanos=parseInt("1"+s[7]+"0".repeat(9-s[7].length))-1e9),this}toJson(e){const t=Number(this.seconds)*1e3;if(t<Date.parse("0001-01-01T00:00:00Z")||t>Date.parse("9999-12-31T23:59:59Z"))throw new Error("cannot encode google.protobuf.Timestamp to JSON: must be from 0001-01-01T00:00:00Z to 9999-12-31T23:59:59Z inclusive");if(this.nanos<0)throw new Error("cannot encode google.protobuf.Timestamp to JSON: nanos must not be negative");let s="Z";if(this.nanos>0){const o=(this.nanos+1e9).toString().substring(1);o.substring(3)==="000000"?s="."+o.substring(0,3)+"Z":o.substring(6)==="000"?s="."+o.substring(0,6)+"Z":s="."+o+"Z"}return new Date(t).toISOString().replace(".000Z",s)}toDate(){return new Date(Number(this.seconds)*1e3+Math.ceil(this.nanos/1e6))}static now(){return Timestamp.fromDate(new Date)}static fromDate(e){const t=e.getTime();return new Timestamp({seconds:protoInt64.parse(Math.floor(t/1e3)),nanos:t%1e3*1e6})}static fromBinary(e,t){return new Timestamp().fromBinary(e,t)}static fromJson(e,t){return new Timestamp().fromJson(e,t)}static fromJsonString(e,t){return new Timestamp().fromJsonString(e,t)}static equals(e,t){return proto3.util.equals(Timestamp,e,t)}}Timestamp.runtime=proto3;Timestamp.typeName="google.protobuf.Timestamp";Timestamp.fields=proto3.util.newFieldList(()=>[{no:1,name:"seconds",kind:"scalar",T:3},{no:2,name:"nanos",kind:"scalar",T:5}]);const MetricsBatch=proto3.makeMessageType("livekit.MetricsBatch",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"str_data",kind:"scalar",T:9,repeated:!0},{no:4,name:"time_series",kind:"message",T:TimeSeriesMetric,repeated:!0},{no:5,name:"events",kind:"message",T:EventMetric,repeated:!0}]),TimeSeriesMetric=proto3.makeMessageType("livekit.TimeSeriesMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"samples",kind:"message",T:MetricSample,repeated:!0},{no:5,name:"rid",kind:"scalar",T:13}]),MetricSample=proto3.makeMessageType("livekit.MetricSample",()=>[{no:1,name:"timestamp_ms",kind:"scalar",T:3},{no:2,name:"normalized_timestamp",kind:"message",T:Timestamp},{no:3,name:"value",kind:"scalar",T:2}]),EventMetric=proto3.makeMessageType("livekit.EventMetric",()=>[{no:1,name:"label",kind:"scalar",T:13},{no:2,name:"participant_identity",kind:"scalar",T:13},{no:3,name:"track_sid",kind:"scalar",T:13},{no:4,name:"start_timestamp_ms",kind:"scalar",T:3},{no:5,name:"end_timestamp_ms",kind:"scalar",T:3,opt:!0},{no:6,name:"normalized_start_timestamp",kind:"message",T:Timestamp},{no:7,name:"normalized_end_timestamp",kind:"message",T:Timestamp,opt:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"rid",kind:"scalar",T:13}]),TrackType=proto3.makeEnum("livekit.TrackType",[{no:0,name:"AUDIO"},{no:1,name:"VIDEO"},{no:2,name:"DATA"}]),TrackSource=proto3.makeEnum("livekit.TrackSource",[{no:0,name:"UNKNOWN"},{no:1,name:"CAMERA"},{no:2,name:"MICROPHONE"},{no:3,name:"SCREEN_SHARE"},{no:4,name:"SCREEN_SHARE_AUDIO"}]),VideoQuality$1=proto3.makeEnum("livekit.VideoQuality",[{no:0,name:"LOW"},{no:1,name:"MEDIUM"},{no:2,name:"HIGH"},{no:3,name:"OFF"}]),ConnectionQuality$1=proto3.makeEnum("livekit.ConnectionQuality",[{no:0,name:"POOR"},{no:1,name:"GOOD"},{no:2,name:"EXCELLENT"},{no:3,name:"LOST"}]),ClientConfigSetting=proto3.makeEnum("livekit.ClientConfigSetting",[{no:0,name:"UNSET"},{no:1,name:"DISABLED"},{no:2,name:"ENABLED"}]),DisconnectReason=proto3.makeEnum("livekit.DisconnectReason",[{no:0,name:"UNKNOWN_REASON"},{no:1,name:"CLIENT_INITIATED"},{no:2,name:"DUPLICATE_IDENTITY"},{no:3,name:"SERVER_SHUTDOWN"},{no:4,name:"PARTICIPANT_REMOVED"},{no:5,name:"ROOM_DELETED"},{no:6,name:"STATE_MISMATCH"},{no:7,name:"JOIN_FAILURE"},{no:8,name:"MIGRATION"},{no:9,name:"SIGNAL_CLOSE"},{no:10,name:"ROOM_CLOSED"},{no:11,name:"USER_UNAVAILABLE"},{no:12,name:"USER_REJECTED"}]),ReconnectReason=proto3.makeEnum("livekit.ReconnectReason",[{no:0,name:"RR_UNKNOWN"},{no:1,name:"RR_SIGNAL_DISCONNECTED"},{no:2,name:"RR_PUBLISHER_FAILED"},{no:3,name:"RR_SUBSCRIBER_FAILED"},{no:4,name:"RR_SWITCH_CANDIDATE"}]),SubscriptionError=proto3.makeEnum("livekit.SubscriptionError",[{no:0,name:"SE_UNKNOWN"},{no:1,name:"SE_CODEC_UNSUPPORTED"},{no:2,name:"SE_TRACK_NOTFOUND"}]),AudioTrackFeature=proto3.makeEnum("livekit.AudioTrackFeature",[{no:0,name:"TF_STEREO"},{no:1,name:"TF_NO_DTX"},{no:2,name:"TF_AUTO_GAIN_CONTROL"},{no:3,name:"TF_ECHO_CANCELLATION"},{no:4,name:"TF_NOISE_SUPPRESSION"},{no:5,name:"TF_ENHANCED_NOISE_CANCELLATION"}]),Room$1=proto3.makeMessageType("livekit.Room",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"empty_timeout",kind:"scalar",T:13},{no:14,name:"departure_timeout",kind:"scalar",T:13},{no:4,name:"max_participants",kind:"scalar",T:13},{no:5,name:"creation_time",kind:"scalar",T:3},{no:6,name:"turn_password",kind:"scalar",T:9},{no:7,name:"enabled_codecs",kind:"message",T:Codec,repeated:!0},{no:8,name:"metadata",kind:"scalar",T:9},{no:9,name:"num_participants",kind:"scalar",T:13},{no:11,name:"num_publishers",kind:"scalar",T:13},{no:10,name:"active_recording",kind:"scalar",T:8},{no:13,name:"version",kind:"message",T:TimedVersion}]),Codec=proto3.makeMessageType("livekit.Codec",()=>[{no:1,name:"mime",kind:"scalar",T:9},{no:2,name:"fmtp_line",kind:"scalar",T:9}]),ParticipantPermission=proto3.makeMessageType("livekit.ParticipantPermission",()=>[{no:1,name:"can_subscribe",kind:"scalar",T:8},{no:2,name:"can_publish",kind:"scalar",T:8},{no:3,name:"can_publish_data",kind:"scalar",T:8},{no:9,name:"can_publish_sources",kind:"enum",T:proto3.getEnumType(TrackSource),repeated:!0},{no:7,name:"hidden",kind:"scalar",T:8},{no:8,name:"recorder",kind:"scalar",T:8},{no:10,name:"can_update_metadata",kind:"scalar",T:8},{no:11,name:"agent",kind:"scalar",T:8},{no:12,name:"can_subscribe_metrics",kind:"scalar",T:8}]),ParticipantInfo=proto3.makeMessageType("livekit.ParticipantInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"identity",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3.getEnumType(ParticipantInfo_State)},{no:4,name:"tracks",kind:"message",T:TrackInfo,repeated:!0},{no:5,name:"metadata",kind:"scalar",T:9},{no:6,name:"joined_at",kind:"scalar",T:3},{no:9,name:"name",kind:"scalar",T:9},{no:10,name:"version",kind:"scalar",T:13},{no:11,name:"permission",kind:"message",T:ParticipantPermission},{no:12,name:"region",kind:"scalar",T:9},{no:13,name:"is_publisher",kind:"scalar",T:8},{no:14,name:"kind",kind:"enum",T:proto3.getEnumType(ParticipantInfo_Kind)},{no:15,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:16,name:"disconnect_reason",kind:"enum",T:proto3.getEnumType(DisconnectReason)}]),ParticipantInfo_State=proto3.makeEnum("livekit.ParticipantInfo.State",[{no:0,name:"JOINING"},{no:1,name:"JOINED"},{no:2,name:"ACTIVE"},{no:3,name:"DISCONNECTED"}]),ParticipantInfo_Kind=proto3.makeEnum("livekit.ParticipantInfo.Kind",[{no:0,name:"STANDARD"},{no:1,name:"INGRESS"},{no:2,name:"EGRESS"},{no:3,name:"SIP"},{no:4,name:"AGENT"}]),Encryption_Type=proto3.makeEnum("livekit.Encryption.Type",[{no:0,name:"NONE"},{no:1,name:"GCM"},{no:2,name:"CUSTOM"}]),SimulcastCodecInfo=proto3.makeMessageType("livekit.SimulcastCodecInfo",()=>[{no:1,name:"mime_type",kind:"scalar",T:9},{no:2,name:"mid",kind:"scalar",T:9},{no:3,name:"cid",kind:"scalar",T:9},{no:4,name:"layers",kind:"message",T:VideoLayer,repeated:!0}]),TrackInfo=proto3.makeMessageType("livekit.TrackInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"type",kind:"enum",T:proto3.getEnumType(TrackType)},{no:3,name:"name",kind:"scalar",T:9},{no:4,name:"muted",kind:"scalar",T:8},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"simulcast",kind:"scalar",T:8},{no:8,name:"disable_dtx",kind:"scalar",T:8},{no:9,name:"source",kind:"enum",T:proto3.getEnumType(TrackSource)},{no:10,name:"layers",kind:"message",T:VideoLayer,repeated:!0},{no:11,name:"mime_type",kind:"scalar",T:9},{no:12,name:"mid",kind:"scalar",T:9},{no:13,name:"codecs",kind:"message",T:SimulcastCodecInfo,repeated:!0},{no:14,name:"stereo",kind:"scalar",T:8},{no:15,name:"disable_red",kind:"scalar",T:8},{no:16,name:"encryption",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:17,name:"stream",kind:"scalar",T:9},{no:18,name:"version",kind:"message",T:TimedVersion},{no:19,name:"audio_features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0}]),VideoLayer=proto3.makeMessageType("livekit.VideoLayer",()=>[{no:1,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13},{no:4,name:"bitrate",kind:"scalar",T:13},{no:5,name:"ssrc",kind:"scalar",T:13}]),DataPacket=proto3.makeMessageType("livekit.DataPacket",()=>[{no:1,name:"kind",kind:"enum",T:proto3.getEnumType(DataPacket_Kind)},{no:4,name:"participant_identity",kind:"scalar",T:9},{no:5,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:2,name:"user",kind:"message",T:UserPacket,oneof:"value"},{no:3,name:"speaker",kind:"message",T:ActiveSpeakerUpdate,oneof:"value"},{no:6,name:"sip_dtmf",kind:"message",T:SipDTMF,oneof:"value"},{no:7,name:"transcription",kind:"message",T:Transcription,oneof:"value"},{no:8,name:"metrics",kind:"message",T:MetricsBatch,oneof:"value"},{no:9,name:"chat_message",kind:"message",T:ChatMessage,oneof:"value"},{no:10,name:"rpc_request",kind:"message",T:RpcRequest,oneof:"value"},{no:11,name:"rpc_ack",kind:"message",T:RpcAck,oneof:"value"},{no:12,name:"rpc_response",kind:"message",T:RpcResponse,oneof:"value"}]),DataPacket_Kind=proto3.makeEnum("livekit.DataPacket.Kind",[{no:0,name:"RELIABLE"},{no:1,name:"LOSSY"}]),ActiveSpeakerUpdate=proto3.makeMessageType("livekit.ActiveSpeakerUpdate",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo,repeated:!0}]),SpeakerInfo=proto3.makeMessageType("livekit.SpeakerInfo",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"level",kind:"scalar",T:2},{no:3,name:"active",kind:"scalar",T:8}]),UserPacket=proto3.makeMessageType("livekit.UserPacket",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:5,name:"participant_identity",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:12},{no:3,name:"destination_sids",kind:"scalar",T:9,repeated:!0},{no:6,name:"destination_identities",kind:"scalar",T:9,repeated:!0},{no:4,name:"topic",kind:"scalar",T:9,opt:!0},{no:8,name:"id",kind:"scalar",T:9,opt:!0},{no:9,name:"start_time",kind:"scalar",T:4,opt:!0},{no:10,name:"end_time",kind:"scalar",T:4,opt:!0}]),SipDTMF=proto3.makeMessageType("livekit.SipDTMF",()=>[{no:3,name:"code",kind:"scalar",T:13},{no:4,name:"digit",kind:"scalar",T:9}]),Transcription=proto3.makeMessageType("livekit.Transcription",()=>[{no:2,name:"transcribed_participant_identity",kind:"scalar",T:9},{no:3,name:"track_id",kind:"scalar",T:9},{no:4,name:"segments",kind:"message",T:TranscriptionSegment,repeated:!0}]),TranscriptionSegment=proto3.makeMessageType("livekit.TranscriptionSegment",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"text",kind:"scalar",T:9},{no:3,name:"start_time",kind:"scalar",T:4},{no:4,name:"end_time",kind:"scalar",T:4},{no:5,name:"final",kind:"scalar",T:8},{no:6,name:"language",kind:"scalar",T:9}]),ChatMessage=proto3.makeMessageType("livekit.ChatMessage",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"timestamp",kind:"scalar",T:3},{no:3,name:"edit_timestamp",kind:"scalar",T:3,opt:!0},{no:4,name:"message",kind:"scalar",T:9},{no:5,name:"deleted",kind:"scalar",T:8},{no:6,name:"generated",kind:"scalar",T:8}]),RpcRequest=proto3.makeMessageType("livekit.RpcRequest",()=>[{no:1,name:"id",kind:"scalar",T:9},{no:2,name:"method",kind:"scalar",T:9},{no:3,name:"payload",kind:"scalar",T:9},{no:4,name:"response_timeout_ms",kind:"scalar",T:13},{no:5,name:"version",kind:"scalar",T:13}]),RpcAck=proto3.makeMessageType("livekit.RpcAck",()=>[{no:1,name:"request_id",kind:"scalar",T:9}]),RpcResponse=proto3.makeMessageType("livekit.RpcResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:9},{no:2,name:"payload",kind:"scalar",T:9,oneof:"value"},{no:3,name:"error",kind:"message",T:RpcError,oneof:"value"}]),RpcError=proto3.makeMessageType("livekit.RpcError",()=>[{no:1,name:"code",kind:"scalar",T:13},{no:2,name:"message",kind:"scalar",T:9},{no:3,name:"data",kind:"scalar",T:9}]),ParticipantTracks=proto3.makeMessageType("livekit.ParticipantTracks",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sids",kind:"scalar",T:9,repeated:!0}]),ServerInfo=proto3.makeMessageType("livekit.ServerInfo",()=>[{no:1,name:"edition",kind:"enum",T:proto3.getEnumType(ServerInfo_Edition)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"region",kind:"scalar",T:9},{no:5,name:"node_id",kind:"scalar",T:9},{no:6,name:"debug_info",kind:"scalar",T:9},{no:7,name:"agent_protocol",kind:"scalar",T:5}]),ServerInfo_Edition=proto3.makeEnum("livekit.ServerInfo.Edition",[{no:0,name:"Standard"},{no:1,name:"Cloud"}]),ClientInfo=proto3.makeMessageType("livekit.ClientInfo",()=>[{no:1,name:"sdk",kind:"enum",T:proto3.getEnumType(ClientInfo_SDK)},{no:2,name:"version",kind:"scalar",T:9},{no:3,name:"protocol",kind:"scalar",T:5},{no:4,name:"os",kind:"scalar",T:9},{no:5,name:"os_version",kind:"scalar",T:9},{no:6,name:"device_model",kind:"scalar",T:9},{no:7,name:"browser",kind:"scalar",T:9},{no:8,name:"browser_version",kind:"scalar",T:9},{no:9,name:"address",kind:"scalar",T:9},{no:10,name:"network",kind:"scalar",T:9},{no:11,name:"other_sdks",kind:"scalar",T:9}]),ClientInfo_SDK=proto3.makeEnum("livekit.ClientInfo.SDK",[{no:0,name:"UNKNOWN"},{no:1,name:"JS"},{no:2,name:"SWIFT"},{no:3,name:"ANDROID"},{no:4,name:"FLUTTER"},{no:5,name:"GO"},{no:6,name:"UNITY"},{no:7,name:"REACT_NATIVE"},{no:8,name:"RUST"},{no:9,name:"PYTHON"},{no:10,name:"CPP"},{no:11,name:"UNITY_WEB"},{no:12,name:"NODE"}]),ClientConfiguration=proto3.makeMessageType("livekit.ClientConfiguration",()=>[{no:1,name:"video",kind:"message",T:VideoConfiguration},{no:2,name:"screen",kind:"message",T:VideoConfiguration},{no:3,name:"resume_connection",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)},{no:4,name:"disabled_codecs",kind:"message",T:DisabledCodecs},{no:5,name:"force_relay",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)}]),VideoConfiguration=proto3.makeMessageType("livekit.VideoConfiguration",()=>[{no:1,name:"hardware_encoder",kind:"enum",T:proto3.getEnumType(ClientConfigSetting)}]),DisabledCodecs=proto3.makeMessageType("livekit.DisabledCodecs",()=>[{no:1,name:"codecs",kind:"message",T:Codec,repeated:!0},{no:2,name:"publish",kind:"message",T:Codec,repeated:!0}]),TimedVersion=proto3.makeMessageType("livekit.TimedVersion",()=>[{no:1,name:"unix_micro",kind:"scalar",T:3},{no:2,name:"ticks",kind:"scalar",T:5}]),SignalTarget=proto3.makeEnum("livekit.SignalTarget",[{no:0,name:"PUBLISHER"},{no:1,name:"SUBSCRIBER"}]),StreamState=proto3.makeEnum("livekit.StreamState",[{no:0,name:"ACTIVE"},{no:1,name:"PAUSED"}]),CandidateProtocol=proto3.makeEnum("livekit.CandidateProtocol",[{no:0,name:"UDP"},{no:1,name:"TCP"},{no:2,name:"TLS"}]),SignalRequest=proto3.makeMessageType("livekit.SignalRequest",()=>[{no:1,name:"offer",kind:"message",T:SessionDescription,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription,oneof:"message"},{no:3,name:"trickle",kind:"message",T:TrickleRequest,oneof:"message"},{no:4,name:"add_track",kind:"message",T:AddTrackRequest,oneof:"message"},{no:5,name:"mute",kind:"message",T:MuteTrackRequest,oneof:"message"},{no:6,name:"subscription",kind:"message",T:UpdateSubscription,oneof:"message"},{no:7,name:"track_setting",kind:"message",T:UpdateTrackSettings,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest,oneof:"message"},{no:10,name:"update_layers",kind:"message",T:UpdateVideoLayers,oneof:"message"},{no:11,name:"subscription_permission",kind:"message",T:SubscriptionPermission,oneof:"message"},{no:12,name:"sync_state",kind:"message",T:SyncState,oneof:"message"},{no:13,name:"simulate",kind:"message",T:SimulateScenario,oneof:"message"},{no:14,name:"ping",kind:"scalar",T:3,oneof:"message"},{no:15,name:"update_metadata",kind:"message",T:UpdateParticipantMetadata,oneof:"message"},{no:16,name:"ping_req",kind:"message",T:Ping,oneof:"message"},{no:17,name:"update_audio_track",kind:"message",T:UpdateLocalAudioTrack,oneof:"message"},{no:18,name:"update_video_track",kind:"message",T:UpdateLocalVideoTrack,oneof:"message"}]),SignalResponse=proto3.makeMessageType("livekit.SignalResponse",()=>[{no:1,name:"join",kind:"message",T:JoinResponse,oneof:"message"},{no:2,name:"answer",kind:"message",T:SessionDescription,oneof:"message"},{no:3,name:"offer",kind:"message",T:SessionDescription,oneof:"message"},{no:4,name:"trickle",kind:"message",T:TrickleRequest,oneof:"message"},{no:5,name:"update",kind:"message",T:ParticipantUpdate,oneof:"message"},{no:6,name:"track_published",kind:"message",T:TrackPublishedResponse,oneof:"message"},{no:8,name:"leave",kind:"message",T:LeaveRequest,oneof:"message"},{no:9,name:"mute",kind:"message",T:MuteTrackRequest,oneof:"message"},{no:10,name:"speakers_changed",kind:"message",T:SpeakersChanged,oneof:"message"},{no:11,name:"room_update",kind:"message",T:RoomUpdate,oneof:"message"},{no:12,name:"connection_quality",kind:"message",T:ConnectionQualityUpdate,oneof:"message"},{no:13,name:"stream_state_update",kind:"message",T:StreamStateUpdate,oneof:"message"},{no:14,name:"subscribed_quality_update",kind:"message",T:SubscribedQualityUpdate,oneof:"message"},{no:15,name:"subscription_permission_update",kind:"message",T:SubscriptionPermissionUpdate,oneof:"message"},{no:16,name:"refresh_token",kind:"scalar",T:9,oneof:"message"},{no:17,name:"track_unpublished",kind:"message",T:TrackUnpublishedResponse,oneof:"message"},{no:18,name:"pong",kind:"scalar",T:3,oneof:"message"},{no:19,name:"reconnect",kind:"message",T:ReconnectResponse,oneof:"message"},{no:20,name:"pong_resp",kind:"message",T:Pong,oneof:"message"},{no:21,name:"subscription_response",kind:"message",T:SubscriptionResponse,oneof:"message"},{no:22,name:"request_response",kind:"message",T:RequestResponse,oneof:"message"},{no:23,name:"track_subscribed",kind:"message",T:TrackSubscribed,oneof:"message"}]),SimulcastCodec=proto3.makeMessageType("livekit.SimulcastCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"cid",kind:"scalar",T:9}]),AddTrackRequest=proto3.makeMessageType("livekit.AddTrackRequest",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"type",kind:"enum",T:proto3.getEnumType(TrackType)},{no:4,name:"width",kind:"scalar",T:13},{no:5,name:"height",kind:"scalar",T:13},{no:6,name:"muted",kind:"scalar",T:8},{no:7,name:"disable_dtx",kind:"scalar",T:8},{no:8,name:"source",kind:"enum",T:proto3.getEnumType(TrackSource)},{no:9,name:"layers",kind:"message",T:VideoLayer,repeated:!0},{no:10,name:"simulcast_codecs",kind:"message",T:SimulcastCodec,repeated:!0},{no:11,name:"sid",kind:"scalar",T:9},{no:12,name:"stereo",kind:"scalar",T:8},{no:13,name:"disable_red",kind:"scalar",T:8},{no:14,name:"encryption",kind:"enum",T:proto3.getEnumType(Encryption_Type)},{no:15,name:"stream",kind:"scalar",T:9}]),TrickleRequest=proto3.makeMessageType("livekit.TrickleRequest",()=>[{no:1,name:"candidateInit",kind:"scalar",T:9},{no:2,name:"target",kind:"enum",T:proto3.getEnumType(SignalTarget)},{no:3,name:"final",kind:"scalar",T:8}]),MuteTrackRequest=proto3.makeMessageType("livekit.MuteTrackRequest",()=>[{no:1,name:"sid",kind:"scalar",T:9},{no:2,name:"muted",kind:"scalar",T:8}]),JoinResponse=proto3.makeMessageType("livekit.JoinResponse",()=>[{no:1,name:"room",kind:"message",T:Room$1},{no:2,name:"participant",kind:"message",T:ParticipantInfo},{no:3,name:"other_participants",kind:"message",T:ParticipantInfo,repeated:!0},{no:4,name:"server_version",kind:"scalar",T:9},{no:5,name:"ice_servers",kind:"message",T:ICEServer,repeated:!0},{no:6,name:"subscriber_primary",kind:"scalar",T:8},{no:7,name:"alternative_url",kind:"scalar",T:9},{no:8,name:"client_configuration",kind:"message",T:ClientConfiguration},{no:9,name:"server_region",kind:"scalar",T:9},{no:10,name:"ping_timeout",kind:"scalar",T:5},{no:11,name:"ping_interval",kind:"scalar",T:5},{no:12,name:"server_info",kind:"message",T:ServerInfo},{no:13,name:"sif_trailer",kind:"scalar",T:12},{no:14,name:"enabled_publish_codecs",kind:"message",T:Codec,repeated:!0},{no:15,name:"fast_publish",kind:"scalar",T:8}]),ReconnectResponse=proto3.makeMessageType("livekit.ReconnectResponse",()=>[{no:1,name:"ice_servers",kind:"message",T:ICEServer,repeated:!0},{no:2,name:"client_configuration",kind:"message",T:ClientConfiguration}]),TrackPublishedResponse=proto3.makeMessageType("livekit.TrackPublishedResponse",()=>[{no:1,name:"cid",kind:"scalar",T:9},{no:2,name:"track",kind:"message",T:TrackInfo}]),TrackUnpublishedResponse=proto3.makeMessageType("livekit.TrackUnpublishedResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]),SessionDescription=proto3.makeMessageType("livekit.SessionDescription",()=>[{no:1,name:"type",kind:"scalar",T:9},{no:2,name:"sdp",kind:"scalar",T:9}]),ParticipantUpdate=proto3.makeMessageType("livekit.ParticipantUpdate",()=>[{no:1,name:"participants",kind:"message",T:ParticipantInfo,repeated:!0}]),UpdateSubscription=proto3.makeMessageType("livekit.UpdateSubscription",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:2,name:"subscribe",kind:"scalar",T:8},{no:3,name:"participant_tracks",kind:"message",T:ParticipantTracks,repeated:!0}]),UpdateTrackSettings=proto3.makeMessageType("livekit.UpdateTrackSettings",()=>[{no:1,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:3,name:"disabled",kind:"scalar",T:8},{no:4,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:5,name:"width",kind:"scalar",T:13},{no:6,name:"height",kind:"scalar",T:13},{no:7,name:"fps",kind:"scalar",T:13},{no:8,name:"priority",kind:"scalar",T:13}]),UpdateLocalAudioTrack=proto3.makeMessageType("livekit.UpdateLocalAudioTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"features",kind:"enum",T:proto3.getEnumType(AudioTrackFeature),repeated:!0}]),UpdateLocalVideoTrack=proto3.makeMessageType("livekit.UpdateLocalVideoTrack",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"width",kind:"scalar",T:13},{no:3,name:"height",kind:"scalar",T:13}]),LeaveRequest=proto3.makeMessageType("livekit.LeaveRequest",()=>[{no:1,name:"can_reconnect",kind:"scalar",T:8},{no:2,name:"reason",kind:"enum",T:proto3.getEnumType(DisconnectReason)},{no:3,name:"action",kind:"enum",T:proto3.getEnumType(LeaveRequest_Action)},{no:4,name:"regions",kind:"message",T:RegionSettings}]),LeaveRequest_Action=proto3.makeEnum("livekit.LeaveRequest.Action",[{no:0,name:"DISCONNECT"},{no:1,name:"RESUME"},{no:2,name:"RECONNECT"}]),UpdateVideoLayers=proto3.makeMessageType("livekit.UpdateVideoLayers",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"layers",kind:"message",T:VideoLayer,repeated:!0}]),UpdateParticipantMetadata=proto3.makeMessageType("livekit.UpdateParticipantMetadata",()=>[{no:1,name:"metadata",kind:"scalar",T:9},{no:2,name:"name",kind:"scalar",T:9},{no:3,name:"attributes",kind:"map",K:9,V:{kind:"scalar",T:9}},{no:4,name:"request_id",kind:"scalar",T:13}]),ICEServer=proto3.makeMessageType("livekit.ICEServer",()=>[{no:1,name:"urls",kind:"scalar",T:9,repeated:!0},{no:2,name:"username",kind:"scalar",T:9},{no:3,name:"credential",kind:"scalar",T:9}]),SpeakersChanged=proto3.makeMessageType("livekit.SpeakersChanged",()=>[{no:1,name:"speakers",kind:"message",T:SpeakerInfo,repeated:!0}]),RoomUpdate=proto3.makeMessageType("livekit.RoomUpdate",()=>[{no:1,name:"room",kind:"message",T:Room$1}]),ConnectionQualityInfo=proto3.makeMessageType("livekit.ConnectionQualityInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"quality",kind:"enum",T:proto3.getEnumType(ConnectionQuality$1)},{no:3,name:"score",kind:"scalar",T:2}]),ConnectionQualityUpdate=proto3.makeMessageType("livekit.ConnectionQualityUpdate",()=>[{no:1,name:"updates",kind:"message",T:ConnectionQualityInfo,repeated:!0}]),StreamStateInfo=proto3.makeMessageType("livekit.StreamStateInfo",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"state",kind:"enum",T:proto3.getEnumType(StreamState)}]),StreamStateUpdate=proto3.makeMessageType("livekit.StreamStateUpdate",()=>[{no:1,name:"stream_states",kind:"message",T:StreamStateInfo,repeated:!0}]),SubscribedQuality=proto3.makeMessageType("livekit.SubscribedQuality",()=>[{no:1,name:"quality",kind:"enum",T:proto3.getEnumType(VideoQuality$1)},{no:2,name:"enabled",kind:"scalar",T:8}]),SubscribedCodec=proto3.makeMessageType("livekit.SubscribedCodec",()=>[{no:1,name:"codec",kind:"scalar",T:9},{no:2,name:"qualities",kind:"message",T:SubscribedQuality,repeated:!0}]),SubscribedQualityUpdate=proto3.makeMessageType("livekit.SubscribedQualityUpdate",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"subscribed_qualities",kind:"message",T:SubscribedQuality,repeated:!0},{no:3,name:"subscribed_codecs",kind:"message",T:SubscribedCodec,repeated:!0}]),TrackPermission=proto3.makeMessageType("livekit.TrackPermission",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"all_tracks",kind:"scalar",T:8},{no:3,name:"track_sids",kind:"scalar",T:9,repeated:!0},{no:4,name:"participant_identity",kind:"scalar",T:9}]),SubscriptionPermission=proto3.makeMessageType("livekit.SubscriptionPermission",()=>[{no:1,name:"all_participants",kind:"scalar",T:8},{no:2,name:"track_permissions",kind:"message",T:TrackPermission,repeated:!0}]),SubscriptionPermissionUpdate=proto3.makeMessageType("livekit.SubscriptionPermissionUpdate",()=>[{no:1,name:"participant_sid",kind:"scalar",T:9},{no:2,name:"track_sid",kind:"scalar",T:9},{no:3,name:"allowed",kind:"scalar",T:8}]),SyncState=proto3.makeMessageType("livekit.SyncState",()=>[{no:1,name:"answer",kind:"message",T:SessionDescription},{no:2,name:"subscription",kind:"message",T:UpdateSubscription},{no:3,name:"publish_tracks",kind:"message",T:TrackPublishedResponse,repeated:!0},{no:4,name:"data_channels",kind:"message",T:DataChannelInfo,repeated:!0},{no:5,name:"offer",kind:"message",T:SessionDescription},{no:6,name:"track_sids_disabled",kind:"scalar",T:9,repeated:!0}]),DataChannelInfo=proto3.makeMessageType("livekit.DataChannelInfo",()=>[{no:1,name:"label",kind:"scalar",T:9},{no:2,name:"id",kind:"scalar",T:13},{no:3,name:"target",kind:"enum",T:proto3.getEnumType(SignalTarget)}]),SimulateScenario=proto3.makeMessageType("livekit.SimulateScenario",()=>[{no:1,name:"speaker_update",kind:"scalar",T:5,oneof:"scenario"},{no:2,name:"node_failure",kind:"scalar",T:8,oneof:"scenario"},{no:3,name:"migration",kind:"scalar",T:8,oneof:"scenario"},{no:4,name:"server_leave",kind:"scalar",T:8,oneof:"scenario"},{no:5,name:"switch_candidate_protocol",kind:"enum",T:proto3.getEnumType(CandidateProtocol),oneof:"scenario"},{no:6,name:"subscriber_bandwidth",kind:"scalar",T:3,oneof:"scenario"},{no:7,name:"disconnect_signal_on_resume",kind:"scalar",T:8,oneof:"scenario"},{no:8,name:"disconnect_signal_on_resume_no_messages",kind:"scalar",T:8,oneof:"scenario"},{no:9,name:"leave_request_full_reconnect",kind:"scalar",T:8,oneof:"scenario"}]),Ping=proto3.makeMessageType("livekit.Ping",()=>[{no:1,name:"timestamp",kind:"scalar",T:3},{no:2,name:"rtt",kind:"scalar",T:3}]),Pong=proto3.makeMessageType("livekit.Pong",()=>[{no:1,name:"last_ping_timestamp",kind:"scalar",T:3},{no:2,name:"timestamp",kind:"scalar",T:3}]),RegionSettings=proto3.makeMessageType("livekit.RegionSettings",()=>[{no:1,name:"regions",kind:"message",T:RegionInfo,repeated:!0}]),RegionInfo=proto3.makeMessageType("livekit.RegionInfo",()=>[{no:1,name:"region",kind:"scalar",T:9},{no:2,name:"url",kind:"scalar",T:9},{no:3,name:"distance",kind:"scalar",T:3}]),SubscriptionResponse=proto3.makeMessageType("livekit.SubscriptionResponse",()=>[{no:1,name:"track_sid",kind:"scalar",T:9},{no:2,name:"err",kind:"enum",T:proto3.getEnumType(SubscriptionError)}]),RequestResponse=proto3.makeMessageType("livekit.RequestResponse",()=>[{no:1,name:"request_id",kind:"scalar",T:13},{no:2,name:"reason",kind:"enum",T:proto3.getEnumType(RequestResponse_Reason)},{no:3,name:"message",kind:"scalar",T:9}]),RequestResponse_Reason=proto3.makeEnum("livekit.RequestResponse.Reason",[{no:0,name:"OK"},{no:1,name:"NOT_FOUND"},{no:2,name:"NOT_ALLOWED"},{no:3,name:"LIMIT_EXCEEDED"}]),TrackSubscribed=proto3.makeMessageType("livekit.TrackSubscribed",()=>[{no:1,name:"track_sid",kind:"scalar",T:9}]);function getDefaultExportFromCjs$1(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}var loglevel$1={exports:{}},loglevel=loglevel$1.exports,hasRequiredLoglevel;function requireLoglevel(){return hasRequiredLoglevel||(hasRequiredLoglevel=1,function(i){(function(e,t){i.exports?i.exports=t():e.log=t()})(loglevel,function(){var e=function(){},t="undefined",s=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),o=["trace","debug","info","warn","error"],a={},c=null;function u(C,R){var T=C[R];if(typeof T.bind=="function")return T.bind(C);try{return Function.prototype.bind.call(T,C)}catch{return function(){return Function.prototype.apply.apply(T,[C,arguments])}}}function d(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function p(C){return C==="debug"&&(C="log"),typeof console===t?!1:C==="trace"&&s?d:console[C]!==void 0?u(console,C):console.log!==void 0?u(console,"log"):e}function v(){for(var C=this.getLevel(),R=0;R<o.length;R++){var T=o[R];this[T]=R<C?e:this.methodFactory(T,C,this.name)}if(this.log=this.debug,typeof console===t&&C<this.levels.SILENT)return"No console available for logging"}function g(C){return function(){typeof console!==t&&(v.call(this),this[C].apply(this,arguments))}}function m(C,R,T){return p(C)||g.apply(this,arguments)}function S(C,R){var T=this,E,A,b,P="loglevel";typeof C=="string"?P+=":"+C:typeof C=="symbol"&&(P=void 0);function _(L){var j=(o[L]||"silent").toUpperCase();if(!(typeof window===t||!P)){try{window.localStorage[P]=j;return}catch{}try{window.document.cookie=encodeURIComponent(P)+"="+j+";"}catch{}}}function w(){var L;if(!(typeof window===t||!P)){try{L=window.localStorage[P]}catch{}if(typeof L===t)try{var j=window.document.cookie,z=encodeURIComponent(P),U=j.indexOf(z+"=");U!==-1&&(L=/^([^;]+)/.exec(j.slice(U+z.length+1))[1])}catch{}return T.levels[L]===void 0&&(L=void 0),L}}function I(){if(!(typeof window===t||!P)){try{window.localStorage.removeItem(P)}catch{}try{window.document.cookie=encodeURIComponent(P)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function D(L){var j=L;if(typeof j=="string"&&T.levels[j.toUpperCase()]!==void 0&&(j=T.levels[j.toUpperCase()]),typeof j=="number"&&j>=0&&j<=T.levels.SILENT)return j;throw new TypeError("log.setLevel() called with invalid level: "+L)}T.name=C,T.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},T.methodFactory=R||m,T.getLevel=function(){return b??A??E},T.setLevel=function(L,j){return b=D(L),j!==!1&&_(b),v.call(T)},T.setDefaultLevel=function(L){A=D(L),w()||T.setLevel(L,!1)},T.resetLevel=function(){b=null,I(),v.call(T)},T.enableAll=function(L){T.setLevel(T.levels.TRACE,L)},T.disableAll=function(L){T.setLevel(T.levels.SILENT,L)},T.rebuild=function(){if(c!==T&&(E=D(c.getLevel())),v.call(T),c===T)for(var L in a)a[L].rebuild()},E=D(c?c.getLevel():"WARN");var N=w();N!=null&&(b=D(N)),v.call(T)}c=new S,c.getLogger=function(R){if(typeof R!="symbol"&&typeof R!="string"||R==="")throw new TypeError("You must supply a name when creating a logger.");var T=a[R];return T||(T=a[R]=new S(R,c.methodFactory)),T};var y=typeof window!==t?window.log:void 0;return c.noConflict=function(){return typeof window!==t&&window.log===c&&(window.log=y),c},c.getLoggers=function(){return a},c.default=c,c})}(loglevel$1)),loglevel$1.exports}var loglevelExports=requireLoglevel(),LogLevel$1;(function(i){i[i.trace=0]="trace",i[i.debug=1]="debug",i[i.info=2]="info",i[i.warn=3]="warn",i[i.error=4]="error",i[i.silent=5]="silent"})(LogLevel$1||(LogLevel$1={}));var LoggerNames;(function(i){i.Default="livekit",i.Room="livekit-room",i.Participant="livekit-participant",i.Track="livekit-track",i.Publication="livekit-track-publication",i.Engine="livekit-engine",i.Signal="livekit-signal",i.PCManager="livekit-pc-manager",i.PCTransport="livekit-pc-transport",i.E2EE="lk-e2ee"})(LoggerNames||(LoggerNames={}));let livekitLogger=loglevelExports.getLogger("livekit");Object.values(LoggerNames).map(i=>loglevelExports.getLogger(i));livekitLogger.setDefaultLevel(LogLevel$1.info);function getLogger(i){const e=loglevelExports.getLogger(i);return e.setDefaultLevel(livekitLogger.getLevel()),e}const workerLogger=loglevelExports.getLogger("lk-e2ee"),maxRetryDelay=7e3,DEFAULT_RETRY_DELAYS_IN_MS=[0,300,2*2*300,3*3*300,4*4*300,maxRetryDelay,maxRetryDelay,maxRetryDelay,maxRetryDelay,maxRetryDelay];class DefaultReconnectPolicy{constructor(e){this._retryDelays=e!==void 0?[...e]:DEFAULT_RETRY_DELAYS_IN_MS}nextRetryDelayInMs(e){if(e.retryCount>=this._retryDelays.length)return null;const t=this._retryDelays[e.retryCount];return e.retryCount<=1?t:t+Math.random()*1e3}}function __awaiter$1(i,e,t,s){function o(a){return a instanceof t?a:new t(function(c){c(a)})}return new(t||(t=Promise))(function(a,c){function u(v){try{p(s.next(v))}catch(g){c(g)}}function d(v){try{p(s.throw(v))}catch(g){c(g)}}function p(v){v.done?a(v.value):o(v.value).then(u,d)}p((s=s.apply(i,e||[])).next())})}function __values(i){var e=typeof Symbol=="function"&&Symbol.iterator,t=e&&i[e],s=0;if(t)return t.call(i);if(i&&typeof i.length=="number")return{next:function(){return i&&s>=i.length&&(i=void 0),{value:i&&i[s++],done:!i}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function __asyncValues(i){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var e=i[Symbol.asyncIterator],t;return e?e.call(i):(i=typeof __values=="function"?__values(i):i[Symbol.iterator](),t={},s("next"),s("throw"),s("return"),t[Symbol.asyncIterator]=function(){return this},t);function s(a){t[a]=i[a]&&function(c){return new Promise(function(u,d){c=i[a](c),o(u,d,c.done,c.value)})}}function o(a,c,u,d){Promise.resolve(d).then(function(p){a({value:p,done:u})},c)}}typeof SuppressedError=="function"&&SuppressedError;var events={exports:{}},hasRequiredEvents;function requireEvents(){if(hasRequiredEvents)return events.exports;hasRequiredEvents=1;var i=typeof Reflect=="object"?Reflect:null,e=i&&typeof i.apply=="function"?i.apply:function(P,_,w){return Function.prototype.apply.call(P,_,w)},t;i&&typeof i.ownKeys=="function"?t=i.ownKeys:Object.getOwnPropertySymbols?t=function(P){return Object.getOwnPropertyNames(P).concat(Object.getOwnPropertySymbols(P))}:t=function(P){return Object.getOwnPropertyNames(P)};function s(b){console&&console.warn&&console.warn(b)}var o=Number.isNaN||function(P){return P!==P};function a(){a.init.call(this)}events.exports=a,events.exports.once=T,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function u(b){if(typeof b!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof b)}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(b){if(typeof b!="number"||b<0||o(b))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+b+".");c=b}}),a.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(P){if(typeof P!="number"||P<0||o(P))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+P+".");return this._maxListeners=P,this};function d(b){return b._maxListeners===void 0?a.defaultMaxListeners:b._maxListeners}a.prototype.getMaxListeners=function(){return d(this)},a.prototype.emit=function(P){for(var _=[],w=1;w<arguments.length;w++)_.push(arguments[w]);var I=P==="error",D=this._events;if(D!==void 0)I=I&&D.error===void 0;else if(!I)return!1;if(I){var N;if(_.length>0&&(N=_[0]),N instanceof Error)throw N;var L=new Error("Unhandled error."+(N?" ("+N.message+")":""));throw L.context=N,L}var j=D[P];if(j===void 0)return!1;if(typeof j=="function")e(j,this,_);else for(var z=j.length,U=y(j,z),w=0;w<z;++w)e(U[w],this,_);return!0};function p(b,P,_,w){var I,D,N;if(u(_),D=b._events,D===void 0?(D=b._events=Object.create(null),b._eventsCount=0):(D.newListener!==void 0&&(b.emit("newListener",P,_.listener?_.listener:_),D=b._events),N=D[P]),N===void 0)N=D[P]=_,++b._eventsCount;else if(typeof N=="function"?N=D[P]=w?[_,N]:[N,_]:w?N.unshift(_):N.push(_),I=d(b),I>0&&N.length>I&&!N.warned){N.warned=!0;var L=new Error("Possible EventEmitter memory leak detected. "+N.length+" "+String(P)+" listeners added. Use emitter.setMaxListeners() to increase limit");L.name="MaxListenersExceededWarning",L.emitter=b,L.type=P,L.count=N.length,s(L)}return b}a.prototype.addListener=function(P,_){return p(this,P,_,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(P,_){return p(this,P,_,!0)};function v(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function g(b,P,_){var w={fired:!1,wrapFn:void 0,target:b,type:P,listener:_},I=v.bind(w);return I.listener=_,w.wrapFn=I,I}a.prototype.once=function(P,_){return u(_),this.on(P,g(this,P,_)),this},a.prototype.prependOnceListener=function(P,_){return u(_),this.prependListener(P,g(this,P,_)),this},a.prototype.removeListener=function(P,_){var w,I,D,N,L;if(u(_),I=this._events,I===void 0)return this;if(w=I[P],w===void 0)return this;if(w===_||w.listener===_)--this._eventsCount===0?this._events=Object.create(null):(delete I[P],I.removeListener&&this.emit("removeListener",P,w.listener||_));else if(typeof w!="function"){for(D=-1,N=w.length-1;N>=0;N--)if(w[N]===_||w[N].listener===_){L=w[N].listener,D=N;break}if(D<0)return this;D===0?w.shift():C(w,D),w.length===1&&(I[P]=w[0]),I.removeListener!==void 0&&this.emit("removeListener",P,L||_)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(P){var _,w,I;if(w=this._events,w===void 0)return this;if(w.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):w[P]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete w[P]),this;if(arguments.length===0){var D=Object.keys(w),N;for(I=0;I<D.length;++I)N=D[I],N!=="removeListener"&&this.removeAllListeners(N);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(_=w[P],typeof _=="function")this.removeListener(P,_);else if(_!==void 0)for(I=_.length-1;I>=0;I--)this.removeListener(P,_[I]);return this};function m(b,P,_){var w=b._events;if(w===void 0)return[];var I=w[P];return I===void 0?[]:typeof I=="function"?_?[I.listener||I]:[I]:_?R(I):y(I,I.length)}a.prototype.listeners=function(P){return m(this,P,!0)},a.prototype.rawListeners=function(P){return m(this,P,!1)},a.listenerCount=function(b,P){return typeof b.listenerCount=="function"?b.listenerCount(P):S.call(b,P)},a.prototype.listenerCount=S;function S(b){var P=this._events;if(P!==void 0){var _=P[b];if(typeof _=="function")return 1;if(_!==void 0)return _.length}return 0}a.prototype.eventNames=function(){return this._eventsCount>0?t(this._events):[]};function y(b,P){for(var _=new Array(P),w=0;w<P;++w)_[w]=b[w];return _}function C(b,P){for(;P+1<b.length;P++)b[P]=b[P+1];b.pop()}function R(b){for(var P=new Array(b.length),_=0;_<P.length;++_)P[_]=b[_].listener||b[_];return P}function T(b,P){return new Promise(function(_,w){function I(N){b.removeListener(P,D),w(N)}function D(){typeof b.removeListener=="function"&&b.removeListener("error",I),_([].slice.call(arguments))}A(b,P,D,{once:!0}),P!=="error"&&E(b,I,{once:!0})})}function E(b,P,_){typeof b.on=="function"&&A(b,"error",P,_)}function A(b,P,_,w){if(typeof b.on=="function")w.once?b.once(P,_):b.on(P,_);else if(typeof b.addEventListener=="function")b.addEventListener(P,function I(D){w.once&&b.removeEventListener(P,I),_(D)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof b)}return events.exports}var eventsExports=requireEvents();let logDisabled_=!0,deprecationWarnings_=!0;function extractVersion(i,e,t){const s=i.match(e);return s&&s.length>=t&&parseInt(s[t],10)}function wrapPeerConnectionEvent(i,e,t){if(!i.RTCPeerConnection)return;const s=i.RTCPeerConnection.prototype,o=s.addEventListener;s.addEventListener=function(c,u){if(c!==e)return o.apply(this,arguments);const d=p=>{const v=t(p);v&&(u.handleEvent?u.handleEvent(v):u(v))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(u,d),o.apply(this,[c,d])};const a=s.removeEventListener;s.removeEventListener=function(c,u){if(c!==e||!this._eventMap||!this._eventMap[e])return a.apply(this,arguments);if(!this._eventMap[e].has(u))return a.apply(this,arguments);const d=this._eventMap[e].get(u);return this._eventMap[e].delete(u),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,a.apply(this,[c,d])},Object.defineProperty(s,"on"+e,{get(){return this["_on"+e]},set(c){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),c&&this.addEventListener(e,this["_on"+e]=c)},enumerable:!0,configurable:!0})}function disableLog(i){return typeof i!="boolean"?new Error("Argument type: "+typeof i+". Please use a boolean."):(logDisabled_=i,i?"adapter.js logging disabled":"adapter.js logging enabled")}function disableWarnings(i){return typeof i!="boolean"?new Error("Argument type: "+typeof i+". Please use a boolean."):(deprecationWarnings_=!i,"adapter.js deprecation warnings "+(i?"disabled":"enabled"))}function log(){if(typeof window=="object"){if(logDisabled_)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function deprecated(i,e){deprecationWarnings_&&console.warn(i+" is deprecated, please use "+e+" instead.")}function detectBrowser(i){const e={browser:null,version:null};if(typeof i>"u"||!i.navigator||!i.navigator.userAgent)return e.browser="Not a browser.",e;const{navigator:t}=i;if(t.userAgentData&&t.userAgentData.brands){const s=t.userAgentData.brands.find(o=>o.brand==="Chromium");if(s)return{browser:"chrome",version:parseInt(s.version,10)}}if(t.mozGetUserMedia)e.browser="firefox",e.version=extractVersion(t.userAgent,/Firefox\/(\d+)\./,1);else if(t.webkitGetUserMedia||i.isSecureContext===!1&&i.webkitRTCPeerConnection)e.browser="chrome",e.version=extractVersion(t.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else if(i.RTCPeerConnection&&t.userAgent.match(/AppleWebKit\/(\d+)\./))e.browser="safari",e.version=extractVersion(t.userAgent,/AppleWebKit\/(\d+)\./,1),e.supportsUnifiedPlan=i.RTCRtpTransceiver&&"currentDirection"in i.RTCRtpTransceiver.prototype;else return e.browser="Not a supported browser.",e;return e}function isObject(i){return Object.prototype.toString.call(i)==="[object Object]"}function compactObject(i){return isObject(i)?Object.keys(i).reduce(function(e,t){const s=isObject(i[t]),o=s?compactObject(i[t]):i[t],a=s&&!Object.keys(o).length;return o===void 0||a?e:Object.assign(e,{[t]:o})},{}):i}function walkStats(i,e,t){!e||t.has(e.id)||(t.set(e.id,e),Object.keys(e).forEach(s=>{s.endsWith("Id")?walkStats(i,i.get(e[s]),t):s.endsWith("Ids")&&e[s].forEach(o=>{walkStats(i,i.get(o),t)})}))}function filterStats(i,e,t){const s=t?"outbound-rtp":"inbound-rtp",o=new Map;if(e===null)return o;const a=[];return i.forEach(c=>{c.type==="track"&&c.trackIdentifier===e.id&&a.push(c)}),a.forEach(c=>{i.forEach(u=>{u.type===s&&u.trackId===c.id&&walkStats(i,u,o)})}),o}const logging=log;function shimGetUserMedia$2(i,e){const t=i&&i.navigator;if(!t.mediaDevices)return;const s=function(u){if(typeof u!="object"||u.mandatory||u.optional)return u;const d={};return Object.keys(u).forEach(p=>{if(p==="require"||p==="advanced"||p==="mediaSource")return;const v=typeof u[p]=="object"?u[p]:{ideal:u[p]};v.exact!==void 0&&typeof v.exact=="number"&&(v.min=v.max=v.exact);const g=function(m,S){return m?m+S.charAt(0).toUpperCase()+S.slice(1):S==="deviceId"?"sourceId":S};if(v.ideal!==void 0){d.optional=d.optional||[];let m={};typeof v.ideal=="number"?(m[g("min",p)]=v.ideal,d.optional.push(m),m={},m[g("max",p)]=v.ideal,d.optional.push(m)):(m[g("",p)]=v.ideal,d.optional.push(m))}v.exact!==void 0&&typeof v.exact!="number"?(d.mandatory=d.mandatory||{},d.mandatory[g("",p)]=v.exact):["min","max"].forEach(m=>{v[m]!==void 0&&(d.mandatory=d.mandatory||{},d.mandatory[g(m,p)]=v[m])})}),u.advanced&&(d.optional=(d.optional||[]).concat(u.advanced)),d},o=function(u,d){if(e.version>=61)return d(u);if(u=JSON.parse(JSON.stringify(u)),u&&typeof u.audio=="object"){const p=function(v,g,m){g in v&&!(m in v)&&(v[m]=v[g],delete v[g])};u=JSON.parse(JSON.stringify(u)),p(u.audio,"autoGainControl","googAutoGainControl"),p(u.audio,"noiseSuppression","googNoiseSuppression"),u.audio=s(u.audio)}if(u&&typeof u.video=="object"){let p=u.video.facingMode;p=p&&(typeof p=="object"?p:{ideal:p});const v=e.version<66;if(p&&(p.exact==="user"||p.exact==="environment"||p.ideal==="user"||p.ideal==="environment")&&!(t.mediaDevices.getSupportedConstraints&&t.mediaDevices.getSupportedConstraints().facingMode&&!v)){delete u.video.facingMode;let g;if(p.exact==="environment"||p.ideal==="environment"?g=["back","rear"]:(p.exact==="user"||p.ideal==="user")&&(g=["front"]),g)return t.mediaDevices.enumerateDevices().then(m=>{m=m.filter(y=>y.kind==="videoinput");let S=m.find(y=>g.some(C=>y.label.toLowerCase().includes(C)));return!S&&m.length&&g.includes("back")&&(S=m[m.length-1]),S&&(u.video.deviceId=p.exact?{exact:S.deviceId}:{ideal:S.deviceId}),u.video=s(u.video),logging("chrome: "+JSON.stringify(u)),d(u)})}u.video=s(u.video)}return logging("chrome: "+JSON.stringify(u)),d(u)},a=function(u){return e.version>=64?u:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[u.name]||u.name,message:u.message,constraint:u.constraint||u.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}},c=function(u,d,p){o(u,v=>{t.webkitGetUserMedia(v,d,g=>{p&&p(a(g))})})};if(t.getUserMedia=c.bind(t),t.mediaDevices.getUserMedia){const u=t.mediaDevices.getUserMedia.bind(t.mediaDevices);t.mediaDevices.getUserMedia=function(d){return o(d,p=>u(p).then(v=>{if(p.audio&&!v.getAudioTracks().length||p.video&&!v.getVideoTracks().length)throw v.getTracks().forEach(g=>{g.stop()}),new DOMException("","NotFoundError");return v},v=>Promise.reject(a(v))))}}}function shimMediaStream(i){i.MediaStream=i.MediaStream||i.webkitMediaStream}function shimOnTrack$1(i){if(typeof i=="object"&&i.RTCPeerConnection&&!("ontrack"in i.RTCPeerConnection.prototype)){Object.defineProperty(i.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(t){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=t)},enumerable:!0,configurable:!0});const e=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=s=>{s.stream.addEventListener("addtrack",o=>{let a;i.RTCPeerConnection.prototype.getReceivers?a=this.getReceivers().find(u=>u.track&&u.track.id===o.track.id):a={track:o.track};const c=new Event("track");c.track=o.track,c.receiver=a,c.transceiver={receiver:a},c.streams=[s.stream],this.dispatchEvent(c)}),s.stream.getTracks().forEach(o=>{let a;i.RTCPeerConnection.prototype.getReceivers?a=this.getReceivers().find(u=>u.track&&u.track.id===o.id):a={track:o};const c=new Event("track");c.track=o,c.receiver=a,c.transceiver={receiver:a},c.streams=[s.stream],this.dispatchEvent(c)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else wrapPeerConnectionEvent(i,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function shimGetSendersWithDtmf(i){if(typeof i=="object"&&i.RTCPeerConnection&&!("getSenders"in i.RTCPeerConnection.prototype)&&"createDTMFSender"in i.RTCPeerConnection.prototype){const e=function(o,a){return{track:a,get dtmf(){return this._dtmf===void 0&&(a.kind==="audio"?this._dtmf=o.createDTMFSender(a):this._dtmf=null),this._dtmf},_pc:o}};if(!i.RTCPeerConnection.prototype.getSenders){i.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};const o=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(u,d){let p=o.apply(this,arguments);return p||(p=e(this,u),this._senders.push(p)),p};const a=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(u){a.apply(this,arguments);const d=this._senders.indexOf(u);d!==-1&&this._senders.splice(d,1)}}const t=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(a){this._senders=this._senders||[],t.apply(this,[a]),a.getTracks().forEach(c=>{this._senders.push(e(this,c))})};const s=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(a){this._senders=this._senders||[],s.apply(this,[a]),a.getTracks().forEach(c=>{const u=this._senders.find(d=>d.track===c);u&&this._senders.splice(this._senders.indexOf(u),1)})}}else if(typeof i=="object"&&i.RTCPeerConnection&&"getSenders"in i.RTCPeerConnection.prototype&&"createDTMFSender"in i.RTCPeerConnection.prototype&&i.RTCRtpSender&&!("dtmf"in i.RTCRtpSender.prototype)){const e=i.RTCPeerConnection.prototype.getSenders;i.RTCPeerConnection.prototype.getSenders=function(){const s=e.apply(this,[]);return s.forEach(o=>o._pc=this),s},Object.defineProperty(i.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function shimSenderReceiverGetStats(i){if(!(typeof i=="object"&&i.RTCPeerConnection&&i.RTCRtpSender&&i.RTCRtpReceiver))return;if(!("getStats"in i.RTCRtpSender.prototype)){const t=i.RTCPeerConnection.prototype.getSenders;t&&(i.RTCPeerConnection.prototype.getSenders=function(){const a=t.apply(this,[]);return a.forEach(c=>c._pc=this),a});const s=i.RTCPeerConnection.prototype.addTrack;s&&(i.RTCPeerConnection.prototype.addTrack=function(){const a=s.apply(this,arguments);return a._pc=this,a}),i.RTCRtpSender.prototype.getStats=function(){const a=this;return this._pc.getStats().then(c=>filterStats(c,a.track,!0))}}if(!("getStats"in i.RTCRtpReceiver.prototype)){const t=i.RTCPeerConnection.prototype.getReceivers;t&&(i.RTCPeerConnection.prototype.getReceivers=function(){const o=t.apply(this,[]);return o.forEach(a=>a._pc=this),o}),wrapPeerConnectionEvent(i,"track",s=>(s.receiver._pc=s.srcElement,s)),i.RTCRtpReceiver.prototype.getStats=function(){const o=this;return this._pc.getStats().then(a=>filterStats(a,o.track,!1))}}if(!("getStats"in i.RTCRtpSender.prototype&&"getStats"in i.RTCRtpReceiver.prototype))return;const e=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof i.MediaStreamTrack){const s=arguments[0];let o,a,c;return this.getSenders().forEach(u=>{u.track===s&&(o?c=!0:o=u)}),this.getReceivers().forEach(u=>(u.track===s&&(a?c=!0:a=u),u.track===s)),c||o&&a?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):o?o.getStats():a?a.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function shimAddTrackRemoveTrackWithNative(i){i.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(c=>this._shimmedLocalStreams[c][0])};const e=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addTrack=function(c,u){if(!u)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};const d=e.apply(this,arguments);return this._shimmedLocalStreams[u.id]?this._shimmedLocalStreams[u.id].indexOf(d)===-1&&this._shimmedLocalStreams[u.id].push(d):this._shimmedLocalStreams[u.id]=[u,d],d};const t=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(c){this._shimmedLocalStreams=this._shimmedLocalStreams||{},c.getTracks().forEach(p=>{if(this.getSenders().find(g=>g.track===p))throw new DOMException("Track already exists.","InvalidAccessError")});const u=this.getSenders();t.apply(this,arguments);const d=this.getSenders().filter(p=>u.indexOf(p)===-1);this._shimmedLocalStreams[c.id]=[c].concat(d)};const s=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(c){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[c.id],s.apply(this,arguments)};const o=i.RTCPeerConnection.prototype.removeTrack;i.RTCPeerConnection.prototype.removeTrack=function(c){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},c&&Object.keys(this._shimmedLocalStreams).forEach(u=>{const d=this._shimmedLocalStreams[u].indexOf(c);d!==-1&&this._shimmedLocalStreams[u].splice(d,1),this._shimmedLocalStreams[u].length===1&&delete this._shimmedLocalStreams[u]}),o.apply(this,arguments)}}function shimAddTrackRemoveTrack(i,e){if(!i.RTCPeerConnection)return;if(i.RTCPeerConnection.prototype.addTrack&&e.version>=65)return shimAddTrackRemoveTrackWithNative(i);const t=i.RTCPeerConnection.prototype.getLocalStreams;i.RTCPeerConnection.prototype.getLocalStreams=function(){const v=t.apply(this);return this._reverseStreams=this._reverseStreams||{},v.map(g=>this._reverseStreams[g.id])};const s=i.RTCPeerConnection.prototype.addStream;i.RTCPeerConnection.prototype.addStream=function(v){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},v.getTracks().forEach(g=>{if(this.getSenders().find(S=>S.track===g))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[v.id]){const g=new i.MediaStream(v.getTracks());this._streams[v.id]=g,this._reverseStreams[g.id]=v,v=g}s.apply(this,[v])};const o=i.RTCPeerConnection.prototype.removeStream;i.RTCPeerConnection.prototype.removeStream=function(v){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},o.apply(this,[this._streams[v.id]||v]),delete this._reverseStreams[this._streams[v.id]?this._streams[v.id].id:v.id],delete this._streams[v.id]},i.RTCPeerConnection.prototype.addTrack=function(v,g){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");const m=[].slice.call(arguments,1);if(m.length!==1||!m[0].getTracks().find(C=>C===v))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(C=>C.track===v))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};const y=this._streams[g.id];if(y)y.addTrack(v),Promise.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{const C=new i.MediaStream([v]);this._streams[g.id]=C,this._reverseStreams[C.id]=g,this.addStream(C)}return this.getSenders().find(C=>C.track===v)};function a(p,v){let g=v.sdp;return Object.keys(p._reverseStreams||[]).forEach(m=>{const S=p._reverseStreams[m],y=p._streams[S.id];g=g.replace(new RegExp(y.id,"g"),S.id)}),new RTCSessionDescription({type:v.type,sdp:g})}function c(p,v){let g=v.sdp;return Object.keys(p._reverseStreams||[]).forEach(m=>{const S=p._reverseStreams[m],y=p._streams[S.id];g=g.replace(new RegExp(S.id,"g"),y.id)}),new RTCSessionDescription({type:v.type,sdp:g})}["createOffer","createAnswer"].forEach(function(p){const v=i.RTCPeerConnection.prototype[p],g={[p](){const m=arguments;return arguments.length&&typeof arguments[0]=="function"?v.apply(this,[y=>{const C=a(this,y);m[0].apply(null,[C])},y=>{m[1]&&m[1].apply(null,y)},arguments[2]]):v.apply(this,arguments).then(y=>a(this,y))}};i.RTCPeerConnection.prototype[p]=g[p]});const u=i.RTCPeerConnection.prototype.setLocalDescription;i.RTCPeerConnection.prototype.setLocalDescription=function(){return!arguments.length||!arguments[0].type?u.apply(this,arguments):(arguments[0]=c(this,arguments[0]),u.apply(this,arguments))};const d=Object.getOwnPropertyDescriptor(i.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(i.RTCPeerConnection.prototype,"localDescription",{get(){const p=d.get.apply(this);return p.type===""?p:a(this,p)}}),i.RTCPeerConnection.prototype.removeTrack=function(v){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!v._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(!(v._pc===this))throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};let m;Object.keys(this._streams).forEach(S=>{this._streams[S].getTracks().find(C=>v.track===C)&&(m=this._streams[S])}),m&&(m.getTracks().length===1?this.removeStream(this._reverseStreams[m.id]):m.removeTrack(v.track),this.dispatchEvent(new Event("negotiationneeded")))}}function shimPeerConnection$1(i,e){!i.RTCPeerConnection&&i.webkitRTCPeerConnection&&(i.RTCPeerConnection=i.webkitRTCPeerConnection),i.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(t){const s=i.RTCPeerConnection.prototype[t],o={[t](){return arguments[0]=new(t==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),s.apply(this,arguments)}};i.RTCPeerConnection.prototype[t]=o[t]})}function fixNegotiationNeeded(i,e){wrapPeerConnectionEvent(i,"negotiationneeded",t=>{const s=t.target;if(!((e.version<72||s.getConfiguration&&s.getConfiguration().sdpSemantics==="plan-b")&&s.signalingState!=="stable"))return t})}var chromeShim=Object.freeze({__proto__:null,fixNegotiationNeeded,shimAddTrackRemoveTrack,shimAddTrackRemoveTrackWithNative,shimGetSendersWithDtmf,shimGetUserMedia:shimGetUserMedia$2,shimMediaStream,shimOnTrack:shimOnTrack$1,shimPeerConnection:shimPeerConnection$1,shimSenderReceiverGetStats});function shimGetUserMedia$1(i,e){const t=i&&i.navigator,s=i&&i.MediaStreamTrack;if(t.getUserMedia=function(o,a,c){deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),t.mediaDevices.getUserMedia(o).then(a,c)},!(e.version>55&&"autoGainControl"in t.mediaDevices.getSupportedConstraints())){const o=function(c,u,d){u in c&&!(d in c)&&(c[d]=c[u],delete c[u])},a=t.mediaDevices.getUserMedia.bind(t.mediaDevices);if(t.mediaDevices.getUserMedia=function(c){return typeof c=="object"&&typeof c.audio=="object"&&(c=JSON.parse(JSON.stringify(c)),o(c.audio,"autoGainControl","mozAutoGainControl"),o(c.audio,"noiseSuppression","mozNoiseSuppression")),a(c)},s&&s.prototype.getSettings){const c=s.prototype.getSettings;s.prototype.getSettings=function(){const u=c.apply(this,arguments);return o(u,"mozAutoGainControl","autoGainControl"),o(u,"mozNoiseSuppression","noiseSuppression"),u}}if(s&&s.prototype.applyConstraints){const c=s.prototype.applyConstraints;s.prototype.applyConstraints=function(u){return this.kind==="audio"&&typeof u=="object"&&(u=JSON.parse(JSON.stringify(u)),o(u,"autoGainControl","mozAutoGainControl"),o(u,"noiseSuppression","mozNoiseSuppression")),c.apply(this,[u])}}}}function shimGetDisplayMedia(i,e){i.navigator.mediaDevices&&"getDisplayMedia"in i.navigator.mediaDevices||i.navigator.mediaDevices&&(i.navigator.mediaDevices.getDisplayMedia=function(s){if(!(s&&s.video)){const o=new DOMException("getDisplayMedia without video constraints is undefined");return o.name="NotFoundError",o.code=8,Promise.reject(o)}return s.video===!0?s.video={mediaSource:e}:s.video.mediaSource=e,i.navigator.mediaDevices.getUserMedia(s)})}function shimOnTrack(i){typeof i=="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimPeerConnection(i,e){if(typeof i!="object"||!(i.RTCPeerConnection||i.mozRTCPeerConnection))return;!i.RTCPeerConnection&&i.mozRTCPeerConnection&&(i.RTCPeerConnection=i.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(o){const a=i.RTCPeerConnection.prototype[o],c={[o](){return arguments[0]=new(o==="addIceCandidate"?i.RTCIceCandidate:i.RTCSessionDescription)(arguments[0]),a.apply(this,arguments)}};i.RTCPeerConnection.prototype[o]=c[o]});const t={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},s=i.RTCPeerConnection.prototype.getStats;i.RTCPeerConnection.prototype.getStats=function(){const[a,c,u]=arguments;return s.apply(this,[a||null]).then(d=>{if(e.version<53&&!c)try{d.forEach(p=>{p.type=t[p.type]||p.type})}catch(p){if(p.name!=="TypeError")throw p;d.forEach((v,g)=>{d.set(g,Object.assign({},v,{type:t[v.type]||v.type}))})}return d}).then(c,u)}}function shimSenderGetStats(i){if(!(typeof i=="object"&&i.RTCPeerConnection&&i.RTCRtpSender)||i.RTCRtpSender&&"getStats"in i.RTCRtpSender.prototype)return;const e=i.RTCPeerConnection.prototype.getSenders;e&&(i.RTCPeerConnection.prototype.getSenders=function(){const o=e.apply(this,[]);return o.forEach(a=>a._pc=this),o});const t=i.RTCPeerConnection.prototype.addTrack;t&&(i.RTCPeerConnection.prototype.addTrack=function(){const o=t.apply(this,arguments);return o._pc=this,o}),i.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}function shimReceiverGetStats(i){if(!(typeof i=="object"&&i.RTCPeerConnection&&i.RTCRtpSender)||i.RTCRtpSender&&"getStats"in i.RTCRtpReceiver.prototype)return;const e=i.RTCPeerConnection.prototype.getReceivers;e&&(i.RTCPeerConnection.prototype.getReceivers=function(){const s=e.apply(this,[]);return s.forEach(o=>o._pc=this),s}),wrapPeerConnectionEvent(i,"track",t=>(t.receiver._pc=t.srcElement,t)),i.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function shimRemoveStream(i){!i.RTCPeerConnection||"removeStream"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.removeStream=function(t){deprecated("removeStream","removeTrack"),this.getSenders().forEach(s=>{s.track&&t.getTracks().includes(s.track)&&this.removeTrack(s)})})}function shimRTCDataChannel(i){i.DataChannel&&!i.RTCDataChannel&&(i.RTCDataChannel=i.DataChannel)}function shimAddTransceiver(i){if(!(typeof i=="object"&&i.RTCPeerConnection))return;const e=i.RTCPeerConnection.prototype.addTransceiver;e&&(i.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let s=arguments[1]&&arguments[1].sendEncodings;s===void 0&&(s=[]),s=[...s];const o=s.length>0;o&&s.forEach(c=>{if("rid"in c&&!/^[a-z0-9]{0,16}$/i.test(c.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in c&&!(parseFloat(c.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in c&&!(parseFloat(c.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});const a=e.apply(this,arguments);if(o){const{sender:c}=a,u=c.getParameters();(!("encodings"in u)||u.encodings.length===1&&Object.keys(u.encodings[0]).length===0)&&(u.encodings=s,c.sendEncodings=s,this.setParametersPromises.push(c.setParameters(u).then(()=>{delete c.sendEncodings}).catch(()=>{delete c.sendEncodings})))}return a})}function shimGetParameters(i){if(!(typeof i=="object"&&i.RTCRtpSender))return;const e=i.RTCRtpSender.prototype.getParameters;e&&(i.RTCRtpSender.prototype.getParameters=function(){const s=e.apply(this,arguments);return"encodings"in s||(s.encodings=[].concat(this.sendEncodings||[{}])),s})}function shimCreateOffer(i){if(!(typeof i=="object"&&i.RTCPeerConnection))return;const e=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function shimCreateAnswer(i){if(!(typeof i=="object"&&i.RTCPeerConnection))return;const e=i.RTCPeerConnection.prototype.createAnswer;i.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var firefoxShim=Object.freeze({__proto__:null,shimAddTransceiver,shimCreateAnswer,shimCreateOffer,shimGetDisplayMedia,shimGetParameters,shimGetUserMedia:shimGetUserMedia$1,shimOnTrack,shimPeerConnection,shimRTCDataChannel,shimReceiverGetStats,shimRemoveStream,shimSenderGetStats});function shimLocalStreamsAPI(i){if(!(typeof i!="object"||!i.RTCPeerConnection)){if("getLocalStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in i.RTCPeerConnection.prototype)){const e=i.RTCPeerConnection.prototype.addTrack;i.RTCPeerConnection.prototype.addStream=function(s){this._localStreams||(this._localStreams=[]),this._localStreams.includes(s)||this._localStreams.push(s),s.getAudioTracks().forEach(o=>e.call(this,o,s)),s.getVideoTracks().forEach(o=>e.call(this,o,s))},i.RTCPeerConnection.prototype.addTrack=function(s){for(var o=arguments.length,a=new Array(o>1?o-1:0),c=1;c<o;c++)a[c-1]=arguments[c];return a&&a.forEach(u=>{this._localStreams?this._localStreams.includes(u)||this._localStreams.push(u):this._localStreams=[u]}),e.apply(this,arguments)}}"removeStream"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.removeStream=function(t){this._localStreams||(this._localStreams=[]);const s=this._localStreams.indexOf(t);if(s===-1)return;this._localStreams.splice(s,1);const o=t.getTracks();this.getSenders().forEach(a=>{o.includes(a.track)&&this.removeTrack(a)})})}}function shimRemoteStreamsAPI(i){if(!(typeof i!="object"||!i.RTCPeerConnection)&&("getRemoteStreams"in i.RTCPeerConnection.prototype||(i.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in i.RTCPeerConnection.prototype))){Object.defineProperty(i.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(t){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=t),this.addEventListener("track",this._onaddstreampoly=s=>{s.streams.forEach(o=>{if(this._remoteStreams||(this._remoteStreams=[]),this._remoteStreams.includes(o))return;this._remoteStreams.push(o);const a=new Event("addstream");a.stream=o,this.dispatchEvent(a)})})}});const e=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){const s=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(o){o.streams.forEach(a=>{if(s._remoteStreams||(s._remoteStreams=[]),s._remoteStreams.indexOf(a)>=0)return;s._remoteStreams.push(a);const c=new Event("addstream");c.stream=a,s.dispatchEvent(c)})}),e.apply(s,arguments)}}}function shimCallbacksAPI(i){if(typeof i!="object"||!i.RTCPeerConnection)return;const e=i.RTCPeerConnection.prototype,t=e.createOffer,s=e.createAnswer,o=e.setLocalDescription,a=e.setRemoteDescription,c=e.addIceCandidate;e.createOffer=function(p,v){const g=arguments.length>=2?arguments[2]:arguments[0],m=t.apply(this,[g]);return v?(m.then(p,v),Promise.resolve()):m},e.createAnswer=function(p,v){const g=arguments.length>=2?arguments[2]:arguments[0],m=s.apply(this,[g]);return v?(m.then(p,v),Promise.resolve()):m};let u=function(d,p,v){const g=o.apply(this,[d]);return v?(g.then(p,v),Promise.resolve()):g};e.setLocalDescription=u,u=function(d,p,v){const g=a.apply(this,[d]);return v?(g.then(p,v),Promise.resolve()):g},e.setRemoteDescription=u,u=function(d,p,v){const g=c.apply(this,[d]);return v?(g.then(p,v),Promise.resolve()):g},e.addIceCandidate=u}function shimGetUserMedia(i){const e=i&&i.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){const t=e.mediaDevices,s=t.getUserMedia.bind(t);e.mediaDevices.getUserMedia=o=>s(shimConstraints(o))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(s,o,a){e.mediaDevices.getUserMedia(s).then(o,a)}).bind(e))}function shimConstraints(i){return i&&i.video!==void 0?Object.assign({},i,{video:compactObject(i.video)}):i}function shimRTCIceServerUrls(i){if(!i.RTCPeerConnection)return;const e=i.RTCPeerConnection;i.RTCPeerConnection=function(s,o){if(s&&s.iceServers){const a=[];for(let c=0;c<s.iceServers.length;c++){let u=s.iceServers[c];u.urls===void 0&&u.url?(deprecated("RTCIceServer.url","RTCIceServer.urls"),u=JSON.parse(JSON.stringify(u)),u.urls=u.url,delete u.url,a.push(u)):a.push(s.iceServers[c])}s.iceServers=a}return new e(s,o)},i.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(i.RTCPeerConnection,"generateCertificate",{get(){return e.generateCertificate}})}function shimTrackEventTransceiver(i){typeof i=="object"&&i.RTCTrackEvent&&"receiver"in i.RTCTrackEvent.prototype&&!("transceiver"in i.RTCTrackEvent.prototype)&&Object.defineProperty(i.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function shimCreateOfferLegacy(i){const e=i.RTCPeerConnection.prototype.createOffer;i.RTCPeerConnection.prototype.createOffer=function(s){if(s){typeof s.offerToReceiveAudio<"u"&&(s.offerToReceiveAudio=!!s.offerToReceiveAudio);const o=this.getTransceivers().find(c=>c.receiver.track.kind==="audio");s.offerToReceiveAudio===!1&&o?o.direction==="sendrecv"?o.setDirection?o.setDirection("sendonly"):o.direction="sendonly":o.direction==="recvonly"&&(o.setDirection?o.setDirection("inactive"):o.direction="inactive"):s.offerToReceiveAudio===!0&&!o&&this.addTransceiver("audio",{direction:"recvonly"}),typeof s.offerToReceiveVideo<"u"&&(s.offerToReceiveVideo=!!s.offerToReceiveVideo);const a=this.getTransceivers().find(c=>c.receiver.track.kind==="video");s.offerToReceiveVideo===!1&&a?a.direction==="sendrecv"?a.setDirection?a.setDirection("sendonly"):a.direction="sendonly":a.direction==="recvonly"&&(a.setDirection?a.setDirection("inactive"):a.direction="inactive"):s.offerToReceiveVideo===!0&&!a&&this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function shimAudioContext(i){typeof i!="object"||i.AudioContext||(i.AudioContext=i.webkitAudioContext)}var safariShim=Object.freeze({__proto__:null,shimAudioContext,shimCallbacksAPI,shimConstraints,shimCreateOfferLegacy,shimGetUserMedia,shimLocalStreamsAPI,shimRTCIceServerUrls,shimRemoteStreamsAPI,shimTrackEventTransceiver}),sdp$1={exports:{}},hasRequiredSdp;function requireSdp(){return hasRequiredSdp||(hasRequiredSdp=1,function(i){const e={};e.generateIdentifier=function(){return Math.random().toString(36).substring(2,12)},e.localCName=e.generateIdentifier(),e.splitLines=function(t){return t.trim().split(`
`).map(s=>s.trim())},e.splitSections=function(t){return t.split(`
m=`).map((o,a)=>(a>0?"m="+o:o).trim()+`\r
`)},e.getDescription=function(t){const s=e.splitSections(t);return s&&s[0]},e.getMediaSections=function(t){const s=e.splitSections(t);return s.shift(),s},e.matchPrefix=function(t,s){return e.splitLines(t).filter(o=>o.indexOf(s)===0)},e.parseCandidate=function(t){let s;t.indexOf("a=candidate:")===0?s=t.substring(12).split(" "):s=t.substring(10).split(" ");const o={foundation:s[0],component:{1:"rtp",2:"rtcp"}[s[1]]||s[1],protocol:s[2].toLowerCase(),priority:parseInt(s[3],10),ip:s[4],address:s[4],port:parseInt(s[5],10),type:s[7]};for(let a=8;a<s.length;a+=2)switch(s[a]){case"raddr":o.relatedAddress=s[a+1];break;case"rport":o.relatedPort=parseInt(s[a+1],10);break;case"tcptype":o.tcpType=s[a+1];break;case"ufrag":o.ufrag=s[a+1],o.usernameFragment=s[a+1];break;default:o[s[a]]===void 0&&(o[s[a]]=s[a+1]);break}return o},e.writeCandidate=function(t){const s=[];s.push(t.foundation);const o=t.component;o==="rtp"?s.push(1):o==="rtcp"?s.push(2):s.push(o),s.push(t.protocol.toUpperCase()),s.push(t.priority),s.push(t.address||t.ip),s.push(t.port);const a=t.type;return s.push("typ"),s.push(a),a!=="host"&&t.relatedAddress&&t.relatedPort&&(s.push("raddr"),s.push(t.relatedAddress),s.push("rport"),s.push(t.relatedPort)),t.tcpType&&t.protocol.toLowerCase()==="tcp"&&(s.push("tcptype"),s.push(t.tcpType)),(t.usernameFragment||t.ufrag)&&(s.push("ufrag"),s.push(t.usernameFragment||t.ufrag)),"candidate:"+s.join(" ")},e.parseIceOptions=function(t){return t.substring(14).split(" ")},e.parseRtpMap=function(t){let s=t.substring(9).split(" ");const o={payloadType:parseInt(s.shift(),10)};return s=s[0].split("/"),o.name=s[0],o.clockRate=parseInt(s[1],10),o.channels=s.length===3?parseInt(s[2],10):1,o.numChannels=o.channels,o},e.writeRtpMap=function(t){let s=t.payloadType;t.preferredPayloadType!==void 0&&(s=t.preferredPayloadType);const o=t.channels||t.numChannels||1;return"a=rtpmap:"+s+" "+t.name+"/"+t.clockRate+(o!==1?"/"+o:"")+`\r
`},e.parseExtmap=function(t){const s=t.substring(9).split(" ");return{id:parseInt(s[0],10),direction:s[0].indexOf("/")>0?s[0].split("/")[1]:"sendrecv",uri:s[1],attributes:s.slice(2).join(" ")}},e.writeExtmap=function(t){return"a=extmap:"+(t.id||t.preferredId)+(t.direction&&t.direction!=="sendrecv"?"/"+t.direction:"")+" "+t.uri+(t.attributes?" "+t.attributes:"")+`\r
`},e.parseFmtp=function(t){const s={};let o;const a=t.substring(t.indexOf(" ")+1).split(";");for(let c=0;c<a.length;c++)o=a[c].trim().split("="),s[o[0].trim()]=o[1];return s},e.writeFmtp=function(t){let s="",o=t.payloadType;if(t.preferredPayloadType!==void 0&&(o=t.preferredPayloadType),t.parameters&&Object.keys(t.parameters).length){const a=[];Object.keys(t.parameters).forEach(c=>{t.parameters[c]!==void 0?a.push(c+"="+t.parameters[c]):a.push(c)}),s+="a=fmtp:"+o+" "+a.join(";")+`\r
`}return s},e.parseRtcpFb=function(t){const s=t.substring(t.indexOf(" ")+1).split(" ");return{type:s.shift(),parameter:s.join(" ")}},e.writeRtcpFb=function(t){let s="",o=t.payloadType;return t.preferredPayloadType!==void 0&&(o=t.preferredPayloadType),t.rtcpFeedback&&t.rtcpFeedback.length&&t.rtcpFeedback.forEach(a=>{s+="a=rtcp-fb:"+o+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+`\r
`}),s},e.parseSsrcMedia=function(t){const s=t.indexOf(" "),o={ssrc:parseInt(t.substring(7,s),10)},a=t.indexOf(":",s);return a>-1?(o.attribute=t.substring(s+1,a),o.value=t.substring(a+1)):o.attribute=t.substring(s+1),o},e.parseSsrcGroup=function(t){const s=t.substring(13).split(" ");return{semantics:s.shift(),ssrcs:s.map(o=>parseInt(o,10))}},e.getMid=function(t){const s=e.matchPrefix(t,"a=mid:")[0];if(s)return s.substring(6)},e.parseFingerprint=function(t){const s=t.substring(14).split(" ");return{algorithm:s[0].toLowerCase(),value:s[1].toUpperCase()}},e.getDtlsParameters=function(t,s){return{role:"auto",fingerprints:e.matchPrefix(t+s,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(t,s){let o="a=setup:"+s+`\r
`;return t.fingerprints.forEach(a=>{o+="a=fingerprint:"+a.algorithm+" "+a.value+`\r
`}),o},e.parseCryptoLine=function(t){const s=t.substring(9).split(" ");return{tag:parseInt(s[0],10),cryptoSuite:s[1],keyParams:s[2],sessionParams:s.slice(3)}},e.writeCryptoLine=function(t){return"a=crypto:"+t.tag+" "+t.cryptoSuite+" "+(typeof t.keyParams=="object"?e.writeCryptoKeyParams(t.keyParams):t.keyParams)+(t.sessionParams?" "+t.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(t){if(t.indexOf("inline:")!==0)return null;const s=t.substring(7).split("|");return{keyMethod:"inline",keySalt:s[0],lifeTime:s[1],mkiValue:s[2]?s[2].split(":")[0]:void 0,mkiLength:s[2]?s[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(t){return t.keyMethod+":"+t.keySalt+(t.lifeTime?"|"+t.lifeTime:"")+(t.mkiValue&&t.mkiLength?"|"+t.mkiValue+":"+t.mkiLength:"")},e.getCryptoParameters=function(t,s){return e.matchPrefix(t+s,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(t,s){const o=e.matchPrefix(t+s,"a=ice-ufrag:")[0],a=e.matchPrefix(t+s,"a=ice-pwd:")[0];return o&&a?{usernameFragment:o.substring(12),password:a.substring(10)}:null},e.writeIceParameters=function(t){let s="a=ice-ufrag:"+t.usernameFragment+`\r
a=ice-pwd:`+t.password+`\r
`;return t.iceLite&&(s+=`a=ice-lite\r
`),s},e.parseRtpParameters=function(t){const s={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},a=e.splitLines(t)[0].split(" ");s.profile=a[2];for(let u=3;u<a.length;u++){const d=a[u],p=e.matchPrefix(t,"a=rtpmap:"+d+" ")[0];if(p){const v=e.parseRtpMap(p),g=e.matchPrefix(t,"a=fmtp:"+d+" ");switch(v.parameters=g.length?e.parseFmtp(g[0]):{},v.rtcpFeedback=e.matchPrefix(t,"a=rtcp-fb:"+d+" ").map(e.parseRtcpFb),s.codecs.push(v),v.name.toUpperCase()){case"RED":case"ULPFEC":s.fecMechanisms.push(v.name.toUpperCase());break}}}e.matchPrefix(t,"a=extmap:").forEach(u=>{s.headerExtensions.push(e.parseExtmap(u))});const c=e.matchPrefix(t,"a=rtcp-fb:* ").map(e.parseRtcpFb);return s.codecs.forEach(u=>{c.forEach(d=>{u.rtcpFeedback.find(v=>v.type===d.type&&v.parameter===d.parameter)||u.rtcpFeedback.push(d)})}),s},e.writeRtpDescription=function(t,s){let o="";o+="m="+t+" ",o+=s.codecs.length>0?"9":"0",o+=" "+(s.profile||"UDP/TLS/RTP/SAVPF")+" ",o+=s.codecs.map(c=>c.preferredPayloadType!==void 0?c.preferredPayloadType:c.payloadType).join(" ")+`\r
`,o+=`c=IN IP4 0.0.0.0\r
`,o+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,s.codecs.forEach(c=>{o+=e.writeRtpMap(c),o+=e.writeFmtp(c),o+=e.writeRtcpFb(c)});let a=0;return s.codecs.forEach(c=>{c.maxptime>a&&(a=c.maxptime)}),a>0&&(o+="a=maxptime:"+a+`\r
`),s.headerExtensions&&s.headerExtensions.forEach(c=>{o+=e.writeExtmap(c)}),o},e.parseRtpEncodingParameters=function(t){const s=[],o=e.parseRtpParameters(t),a=o.fecMechanisms.indexOf("RED")!==-1,c=o.fecMechanisms.indexOf("ULPFEC")!==-1,u=e.matchPrefix(t,"a=ssrc:").map(m=>e.parseSsrcMedia(m)).filter(m=>m.attribute==="cname"),d=u.length>0&&u[0].ssrc;let p;const v=e.matchPrefix(t,"a=ssrc-group:FID").map(m=>m.substring(17).split(" ").map(y=>parseInt(y,10)));v.length>0&&v[0].length>1&&v[0][0]===d&&(p=v[0][1]),o.codecs.forEach(m=>{if(m.name.toUpperCase()==="RTX"&&m.parameters.apt){let S={ssrc:d,codecPayloadType:parseInt(m.parameters.apt,10)};d&&p&&(S.rtx={ssrc:p}),s.push(S),a&&(S=JSON.parse(JSON.stringify(S)),S.fec={ssrc:d,mechanism:c?"red+ulpfec":"red"},s.push(S))}}),s.length===0&&d&&s.push({ssrc:d});let g=e.matchPrefix(t,"b=");return g.length&&(g[0].indexOf("b=TIAS:")===0?g=parseInt(g[0].substring(7),10):g[0].indexOf("b=AS:")===0?g=parseInt(g[0].substring(5),10)*1e3*.95-50*40*8:g=void 0,s.forEach(m=>{m.maxBitrate=g})),s},e.parseRtcpParameters=function(t){const s={},o=e.matchPrefix(t,"a=ssrc:").map(u=>e.parseSsrcMedia(u)).filter(u=>u.attribute==="cname")[0];o&&(s.cname=o.value,s.ssrc=o.ssrc);const a=e.matchPrefix(t,"a=rtcp-rsize");s.reducedSize=a.length>0,s.compound=a.length===0;const c=e.matchPrefix(t,"a=rtcp-mux");return s.mux=c.length>0,s},e.writeRtcpParameters=function(t){let s="";return t.reducedSize&&(s+=`a=rtcp-rsize\r
`),t.mux&&(s+=`a=rtcp-mux\r
`),t.ssrc!==void 0&&t.cname&&(s+="a=ssrc:"+t.ssrc+" cname:"+t.cname+`\r
`),s},e.parseMsid=function(t){let s;const o=e.matchPrefix(t,"a=msid:");if(o.length===1)return s=o[0].substring(7).split(" "),{stream:s[0],track:s[1]};const a=e.matchPrefix(t,"a=ssrc:").map(c=>e.parseSsrcMedia(c)).filter(c=>c.attribute==="msid");if(a.length>0)return s=a[0].value.split(" "),{stream:s[0],track:s[1]}},e.parseSctpDescription=function(t){const s=e.parseMLine(t),o=e.matchPrefix(t,"a=max-message-size:");let a;o.length>0&&(a=parseInt(o[0].substring(19),10)),isNaN(a)&&(a=65536);const c=e.matchPrefix(t,"a=sctp-port:");if(c.length>0)return{port:parseInt(c[0].substring(12),10),protocol:s.fmt,maxMessageSize:a};const u=e.matchPrefix(t,"a=sctpmap:");if(u.length>0){const d=u[0].substring(10).split(" ");return{port:parseInt(d[0],10),protocol:d[1],maxMessageSize:a}}},e.writeSctpDescription=function(t,s){let o=[];return t.protocol!=="DTLS/SCTP"?o=["m="+t.kind+" 9 "+t.protocol+" "+s.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+s.port+`\r
`]:o=["m="+t.kind+" 9 "+t.protocol+" "+s.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+s.port+" "+s.protocol+` 65535\r
`],s.maxMessageSize!==void 0&&o.push("a=max-message-size:"+s.maxMessageSize+`\r
`),o.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(t,s,o){let a;const c=s!==void 0?s:2;return t?a=t:a=e.generateSessionId(),`v=0\r
o=`+(o||"thisisadapterortc")+" "+a+" "+c+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(t,s){const o=e.splitLines(t);for(let a=0;a<o.length;a++)switch(o[a]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return o[a].substring(2)}return s?e.getDirection(s):"sendrecv"},e.getKind=function(t){return e.splitLines(t)[0].split(" ")[0].substring(2)},e.isRejected=function(t){return t.split(" ",2)[1]==="0"},e.parseMLine=function(t){const o=e.splitLines(t)[0].substring(2).split(" ");return{kind:o[0],port:parseInt(o[1],10),protocol:o[2],fmt:o.slice(3).join(" ")}},e.parseOLine=function(t){const o=e.matchPrefix(t,"o=")[0].substring(2).split(" ");return{username:o[0],sessionId:o[1],sessionVersion:parseInt(o[2],10),netType:o[3],addressType:o[4],address:o[5]}},e.isValidSDP=function(t){if(typeof t!="string"||t.length===0)return!1;const s=e.splitLines(t);for(let o=0;o<s.length;o++)if(s[o].length<2||s[o].charAt(1)!=="=")return!1;return!0},i.exports=e}(sdp$1)),sdp$1.exports}var sdpExports=requireSdp(),SDPUtils=getDefaultExportFromCjs$1(sdpExports),sdp=_mergeNamespaces({__proto__:null,default:SDPUtils},[sdpExports]);function shimRTCIceCandidate(i){if(!i.RTCIceCandidate||i.RTCIceCandidate&&"foundation"in i.RTCIceCandidate.prototype)return;const e=i.RTCIceCandidate;i.RTCIceCandidate=function(s){if(typeof s=="object"&&s.candidate&&s.candidate.indexOf("a=")===0&&(s=JSON.parse(JSON.stringify(s)),s.candidate=s.candidate.substring(2)),s.candidate&&s.candidate.length){const o=new e(s),a=SDPUtils.parseCandidate(s.candidate);for(const c in a)c in o||Object.defineProperty(o,c,{value:a[c]});return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(s)},i.RTCIceCandidate.prototype=e.prototype,wrapPeerConnectionEvent(i,"icecandidate",t=>(t.candidate&&Object.defineProperty(t,"candidate",{value:new i.RTCIceCandidate(t.candidate),writable:"false"}),t))}function shimRTCIceCandidateRelayProtocol(i){!i.RTCIceCandidate||i.RTCIceCandidate&&"relayProtocol"in i.RTCIceCandidate.prototype||wrapPeerConnectionEvent(i,"icecandidate",e=>{if(e.candidate){const t=SDPUtils.parseCandidate(e.candidate.candidate);t.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[t.priority>>24])}return e})}function shimMaxMessageSize(i,e){if(!i.RTCPeerConnection)return;"sctp"in i.RTCPeerConnection.prototype||Object.defineProperty(i.RTCPeerConnection.prototype,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp}});const t=function(u){if(!u||!u.sdp)return!1;const d=SDPUtils.splitSections(u.sdp);return d.shift(),d.some(p=>{const v=SDPUtils.parseMLine(p);return v&&v.kind==="application"&&v.protocol.indexOf("SCTP")!==-1})},s=function(u){const d=u.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(d===null||d.length<2)return-1;const p=parseInt(d[1],10);return p!==p?-1:p},o=function(u){let d=65536;return e.browser==="firefox"&&(e.version<57?u===-1?d=16384:d=2147483637:e.version<60?d=e.version===57?65535:65536:d=2147483637),d},a=function(u,d){let p=65536;e.browser==="firefox"&&e.version===57&&(p=65535);const v=SDPUtils.matchPrefix(u.sdp,"a=max-message-size:");return v.length>0?p=parseInt(v[0].substring(19),10):e.browser==="firefox"&&d!==-1&&(p=2147483637),p},c=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){const{sdpSemantics:d}=this.getConfiguration();d==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return typeof this._sctp>"u"?null:this._sctp},enumerable:!0,configurable:!0})}if(t(arguments[0])){const d=s(arguments[0]),p=o(d),v=a(arguments[0],d);let g;p===0&&v===0?g=Number.POSITIVE_INFINITY:p===0||v===0?g=Math.max(p,v):g=Math.min(p,v);const m={};Object.defineProperty(m,"maxMessageSize",{get(){return g}}),this._sctp=m}return c.apply(this,arguments)}}function shimSendThrowTypeError(i){if(!(i.RTCPeerConnection&&"createDataChannel"in i.RTCPeerConnection.prototype))return;function e(s,o){const a=s.send;s.send=function(){const u=arguments[0],d=u.length||u.size||u.byteLength;if(s.readyState==="open"&&o.sctp&&d>o.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+o.sctp.maxMessageSize+" bytes)");return a.apply(s,arguments)}}const t=i.RTCPeerConnection.prototype.createDataChannel;i.RTCPeerConnection.prototype.createDataChannel=function(){const o=t.apply(this,arguments);return e(o,this),o},wrapPeerConnectionEvent(i,"datachannel",s=>(e(s.channel,s.target),s))}function shimConnectionState(i){if(!i.RTCPeerConnection||"connectionState"in i.RTCPeerConnection.prototype)return;const e=i.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(t){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),t&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=t)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(t=>{const s=e[t];e[t]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=o=>{const a=o.target;if(a._lastConnectionState!==a.connectionState){a._lastConnectionState=a.connectionState;const c=new Event("connectionstatechange",o);a.dispatchEvent(c)}return o},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),s.apply(this,arguments)}})}function removeExtmapAllowMixed(i,e){if(!i.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;const t=i.RTCPeerConnection.prototype.setRemoteDescription;i.RTCPeerConnection.prototype.setRemoteDescription=function(o){if(o&&o.sdp&&o.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){const a=o.sdp.split(`
`).filter(c=>c.trim()!=="a=extmap-allow-mixed").join(`
`);i.RTCSessionDescription&&o instanceof i.RTCSessionDescription?arguments[0]=new i.RTCSessionDescription({type:o.type,sdp:a}):o.sdp=a}return t.apply(this,arguments)}}function shimAddIceCandidateNullOrEmpty(i,e){if(!(i.RTCPeerConnection&&i.RTCPeerConnection.prototype))return;const t=i.RTCPeerConnection.prototype.addIceCandidate;!t||t.length===0||(i.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Promise.resolve():t.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Promise.resolve())})}function shimParameterlessSetLocalDescription(i,e){if(!(i.RTCPeerConnection&&i.RTCPeerConnection.prototype))return;const t=i.RTCPeerConnection.prototype.setLocalDescription;!t||t.length===0||(i.RTCPeerConnection.prototype.setLocalDescription=function(){let o=arguments[0]||{};if(typeof o!="object"||o.type&&o.sdp)return t.apply(this,arguments);if(o={type:o.type,sdp:o.sdp},!o.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":o.type="offer";break;default:o.type="answer";break}return o.sdp||o.type!=="offer"&&o.type!=="answer"?t.apply(this,[o]):(o.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(c=>t.apply(this,[c]))})}var commonShim=Object.freeze({__proto__:null,removeExtmapAllowMixed,shimAddIceCandidateNullOrEmpty,shimConnectionState,shimMaxMessageSize,shimParameterlessSetLocalDescription,shimRTCIceCandidate,shimRTCIceCandidateRelayProtocol,shimSendThrowTypeError});function adapterFactory(){let{window:i}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0};const t=log,s=detectBrowser(i),o={browserDetails:s,commonShim,extractVersion,disableLog,disableWarnings,sdp};switch(s.browser){case"chrome":if(!chromeShim||!shimPeerConnection$1||!e.shimChrome)return t("Chrome shim is not included in this adapter release."),o;if(s.version===null)return t("Chrome shim can not determine version, not shimming."),o;t("adapter.js shimming chrome."),o.browserShim=chromeShim,shimAddIceCandidateNullOrEmpty(i,s),shimParameterlessSetLocalDescription(i),shimGetUserMedia$2(i,s),shimMediaStream(i),shimPeerConnection$1(i,s),shimOnTrack$1(i),shimAddTrackRemoveTrack(i,s),shimGetSendersWithDtmf(i),shimSenderReceiverGetStats(i),fixNegotiationNeeded(i,s),shimRTCIceCandidate(i),shimRTCIceCandidateRelayProtocol(i),shimConnectionState(i),shimMaxMessageSize(i,s),shimSendThrowTypeError(i),removeExtmapAllowMixed(i,s);break;case"firefox":if(!firefoxShim||!shimPeerConnection||!e.shimFirefox)return t("Firefox shim is not included in this adapter release."),o;t("adapter.js shimming firefox."),o.browserShim=firefoxShim,shimAddIceCandidateNullOrEmpty(i,s),shimParameterlessSetLocalDescription(i),shimGetUserMedia$1(i,s),shimPeerConnection(i,s),shimOnTrack(i),shimRemoveStream(i),shimSenderGetStats(i),shimReceiverGetStats(i),shimRTCDataChannel(i),shimAddTransceiver(i),shimGetParameters(i),shimCreateOffer(i),shimCreateAnswer(i),shimRTCIceCandidate(i),shimConnectionState(i),shimMaxMessageSize(i,s),shimSendThrowTypeError(i);break;case"safari":if(!safariShim||!e.shimSafari)return t("Safari shim is not included in this adapter release."),o;t("adapter.js shimming safari."),o.browserShim=safariShim,shimAddIceCandidateNullOrEmpty(i,s),shimParameterlessSetLocalDescription(i),shimRTCIceServerUrls(i),shimCreateOfferLegacy(i),shimCallbacksAPI(i),shimLocalStreamsAPI(i),shimRemoteStreamsAPI(i),shimTrackEventTransceiver(i),shimGetUserMedia(i),shimAudioContext(i),shimRTCIceCandidate(i),shimRTCIceCandidateRelayProtocol(i),shimMaxMessageSize(i,s),shimSendThrowTypeError(i),removeExtmapAllowMixed(i,s);break;default:t("Unsupported browser!");break}return o}adapterFactory({window:typeof window>"u"?void 0:window});const DECRYPTION_FAILURE_TOLERANCE=10,E2EE_FLAG="lk_e2ee",SALT="LKFrameEncryptionKey",KEY_PROVIDER_DEFAULTS={sharedKey:!1,ratchetSalt:SALT,ratchetWindowSize:8,failureTolerance:DECRYPTION_FAILURE_TOLERANCE,keyringSize:16};var KeyProviderEvent;(function(i){i.SetKey="setKey",i.RatchetRequest="ratchetRequest",i.KeyRatcheted="keyRatcheted"})(KeyProviderEvent||(KeyProviderEvent={}));var KeyHandlerEvent;(function(i){i.KeyRatcheted="keyRatcheted"})(KeyHandlerEvent||(KeyHandlerEvent={}));var EncryptionEvent;(function(i){i.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",i.EncryptionError="encryptionError"})(EncryptionEvent||(EncryptionEvent={}));var CryptorEvent;(function(i){i.Error="cryptorError"})(CryptorEvent||(CryptorEvent={}));function isE2EESupported(){return isInsertableStreamSupported()||isScriptTransformSupported()}function isScriptTransformSupported(){return typeof window.RTCRtpScriptTransform<"u"}function isInsertableStreamSupported(){return typeof window.RTCRtpSender<"u"&&typeof window.RTCRtpSender.prototype.createEncodedStreams<"u"}class BaseKeyProvider extends eventsExports.EventEmitter{constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};super(),this.onKeyRatcheted=(t,s)=>{livekitLogger.debug("key ratcheted event received",{material:t,keyIndex:s})},this.keyInfoMap=new Map,this.options=Object.assign(Object.assign({},KEY_PROVIDER_DEFAULTS),e),this.on(KeyProviderEvent.KeyRatcheted,this.onKeyRatcheted)}onSetEncryptionKey(e,t,s){const o={key:e,participantIdentity:t,keyIndex:s};if(!this.options.sharedKey&&!t)throw new Error("participant identity needs to be passed for encryption key if sharedKey option is false");this.keyInfoMap.set("".concat(t??"shared","-").concat(s??0),o),this.emit(KeyProviderEvent.SetKey,o)}getKeys(){return Array.from(this.keyInfoMap.values())}getOptions(){return this.options}ratchetKey(e,t){this.emit(KeyProviderEvent.RatchetRequest,e,t)}}class LivekitError extends Error{constructor(e,t){super(t||"an error has occured"),this.code=e}}var ConnectionErrorReason;(function(i){i[i.NotAllowed=0]="NotAllowed",i[i.ServerUnreachable=1]="ServerUnreachable",i[i.InternalError=2]="InternalError",i[i.Cancelled=3]="Cancelled",i[i.LeaveRequest=4]="LeaveRequest"})(ConnectionErrorReason||(ConnectionErrorReason={}));class ConnectionError extends LivekitError{constructor(e,t,s){super(1,e),this.status=s,this.reason=t}}class DeviceUnsupportedError extends LivekitError{constructor(e){super(21,e??"device is unsupported")}}class TrackInvalidError extends LivekitError{constructor(e){super(20,e??"track is invalid")}}class UnsupportedServer extends LivekitError{constructor(e){super(10,e??"unsupported server")}}class UnexpectedConnectionState extends LivekitError{constructor(e){super(12,e??"unexpected connection state")}}class NegotiationError extends LivekitError{constructor(e){super(13,e??"unable to negotiate")}}class SignalRequestError extends LivekitError{constructor(e,t){super(15,e),this.reason=t}}var MediaDeviceFailure;(function(i){i.PermissionDenied="PermissionDenied",i.NotFound="NotFound",i.DeviceInUse="DeviceInUse",i.Other="Other"})(MediaDeviceFailure||(MediaDeviceFailure={}));(function(i){function e(t){if(t&&"name"in t)return t.name==="NotFoundError"||t.name==="DevicesNotFoundError"?i.NotFound:t.name==="NotAllowedError"||t.name==="PermissionDeniedError"?i.PermissionDenied:t.name==="NotReadableError"||t.name==="TrackStartError"?i.DeviceInUse:i.Other}i.getFailure=e})(MediaDeviceFailure||(MediaDeviceFailure={}));var CryptorErrorReason;(function(i){i[i.InvalidKey=0]="InvalidKey",i[i.MissingKey=1]="MissingKey",i[i.InternalError=2]="InternalError"})(CryptorErrorReason||(CryptorErrorReason={}));var RoomEvent;(function(i){i.Connected="connected",i.Reconnecting="reconnecting",i.SignalReconnecting="signalReconnecting",i.Reconnected="reconnected",i.Disconnected="disconnected",i.ConnectionStateChanged="connectionStateChanged",i.MediaDevicesChanged="mediaDevicesChanged",i.ParticipantConnected="participantConnected",i.ParticipantDisconnected="participantDisconnected",i.TrackPublished="trackPublished",i.TrackSubscribed="trackSubscribed",i.TrackSubscriptionFailed="trackSubscriptionFailed",i.TrackUnpublished="trackUnpublished",i.TrackUnsubscribed="trackUnsubscribed",i.TrackMuted="trackMuted",i.TrackUnmuted="trackUnmuted",i.LocalTrackPublished="localTrackPublished",i.LocalTrackUnpublished="localTrackUnpublished",i.LocalAudioSilenceDetected="localAudioSilenceDetected",i.ActiveSpeakersChanged="activeSpeakersChanged",i.ParticipantMetadataChanged="participantMetadataChanged",i.ParticipantNameChanged="participantNameChanged",i.ParticipantAttributesChanged="participantAttributesChanged",i.RoomMetadataChanged="roomMetadataChanged",i.DataReceived="dataReceived",i.SipDTMFReceived="sipDTMFReceived",i.TranscriptionReceived="transcriptionReceived",i.ConnectionQualityChanged="connectionQualityChanged",i.TrackStreamStateChanged="trackStreamStateChanged",i.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",i.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",i.AudioPlaybackStatusChanged="audioPlaybackChanged",i.VideoPlaybackStatusChanged="videoPlaybackChanged",i.MediaDevicesError="mediaDevicesError",i.ParticipantPermissionsChanged="participantPermissionsChanged",i.SignalConnected="signalConnected",i.RecordingStatusChanged="recordingStatusChanged",i.ParticipantEncryptionStatusChanged="participantEncryptionStatusChanged",i.EncryptionError="encryptionError",i.DCBufferStatusChanged="dcBufferStatusChanged",i.ActiveDeviceChanged="activeDeviceChanged",i.ChatMessage="chatMessage",i.LocalTrackSubscribed="localTrackSubscribed",i.MetricsReceived="metricsReceived"})(RoomEvent||(RoomEvent={}));var ParticipantEvent;(function(i){i.TrackPublished="trackPublished",i.TrackSubscribed="trackSubscribed",i.TrackSubscriptionFailed="trackSubscriptionFailed",i.TrackUnpublished="trackUnpublished",i.TrackUnsubscribed="trackUnsubscribed",i.TrackMuted="trackMuted",i.TrackUnmuted="trackUnmuted",i.LocalTrackPublished="localTrackPublished",i.LocalTrackUnpublished="localTrackUnpublished",i.ParticipantMetadataChanged="participantMetadataChanged",i.ParticipantNameChanged="participantNameChanged",i.DataReceived="dataReceived",i.SipDTMFReceived="sipDTMFReceived",i.TranscriptionReceived="transcriptionReceived",i.IsSpeakingChanged="isSpeakingChanged",i.ConnectionQualityChanged="connectionQualityChanged",i.TrackStreamStateChanged="trackStreamStateChanged",i.TrackSubscriptionPermissionChanged="trackSubscriptionPermissionChanged",i.TrackSubscriptionStatusChanged="trackSubscriptionStatusChanged",i.MediaDevicesError="mediaDevicesError",i.AudioStreamAcquired="audioStreamAcquired",i.ParticipantPermissionsChanged="participantPermissionsChanged",i.PCTrackAdded="pcTrackAdded",i.AttributesChanged="attributesChanged",i.LocalTrackSubscribed="localTrackSubscribed",i.ChatMessage="chatMessage"})(ParticipantEvent||(ParticipantEvent={}));var EngineEvent;(function(i){i.TransportsCreated="transportsCreated",i.Connected="connected",i.Disconnected="disconnected",i.Resuming="resuming",i.Resumed="resumed",i.Restarting="restarting",i.Restarted="restarted",i.SignalResumed="signalResumed",i.SignalRestarted="signalRestarted",i.Closing="closing",i.MediaTrackAdded="mediaTrackAdded",i.ActiveSpeakersUpdate="activeSpeakersUpdate",i.DataPacketReceived="dataPacketReceived",i.RTPVideoMapUpdate="rtpVideoMapUpdate",i.DCBufferStatusChanged="dcBufferStatusChanged",i.ParticipantUpdate="participantUpdate",i.RoomUpdate="roomUpdate",i.SpeakersChanged="speakersChanged",i.StreamStateChanged="streamStateChanged",i.ConnectionQualityUpdate="connectionQualityUpdate",i.SubscriptionError="subscriptionError",i.SubscriptionPermissionUpdate="subscriptionPermissionUpdate",i.RemoteMute="remoteMute",i.SubscribedQualityUpdate="subscribedQualityUpdate",i.LocalTrackUnpublished="localTrackUnpublished",i.LocalTrackSubscribed="localTrackSubscribed",i.Offline="offline",i.SignalRequestResponse="signalRequestResponse"})(EngineEvent||(EngineEvent={}));var TrackEvent;(function(i){i.Message="message",i.Muted="muted",i.Unmuted="unmuted",i.Restarted="restarted",i.Ended="ended",i.Subscribed="subscribed",i.Unsubscribed="unsubscribed",i.UpdateSettings="updateSettings",i.UpdateSubscription="updateSubscription",i.AudioPlaybackStarted="audioPlaybackStarted",i.AudioPlaybackFailed="audioPlaybackFailed",i.AudioSilenceDetected="audioSilenceDetected",i.VisibilityChanged="visibilityChanged",i.VideoDimensionsChanged="videoDimensionsChanged",i.VideoPlaybackStarted="videoPlaybackStarted",i.VideoPlaybackFailed="videoPlaybackFailed",i.ElementAttached="elementAttached",i.ElementDetached="elementDetached",i.UpstreamPaused="upstreamPaused",i.UpstreamResumed="upstreamResumed",i.SubscriptionPermissionChanged="subscriptionPermissionChanged",i.SubscriptionStatusChanged="subscriptionStatusChanged",i.SubscriptionFailed="subscriptionFailed",i.TrackProcessorUpdate="trackProcessorUpdate",i.AudioTrackFeatureUpdate="audioTrackFeatureUpdate",i.TranscriptionReceived="transcriptionReceived",i.TimeSyncUpdate="timeSyncUpdate"})(TrackEvent||(TrackEvent={}));function r(i,e,t){var s,o,a;e===void 0&&(e=50),t===void 0&&(t={});var c=(s=t.isImmediate)!=null&&s,u=(o=t.callback)!=null&&o,d=t.maxWait,p=Date.now(),v=[];function g(){if(d!==void 0){var S=Date.now()-p;if(S+e>=d)return d-S}return e}var m=function(){var S=[].slice.call(arguments),y=this;return new Promise(function(C,R){var T=c&&a===void 0;if(a!==void 0&&clearTimeout(a),a=setTimeout(function(){if(a=void 0,p=Date.now(),!c){var A=i.apply(y,S);u&&u(A),v.forEach(function(b){return(0,b.resolve)(A)}),v=[]}},g()),T){var E=i.apply(y,S);return u&&u(E),C(E)}v.push({resolve:C,reject:R})})};return m.cancel=function(S){a!==void 0&&clearTimeout(a),v.forEach(function(y){return(0,y.reject)(S)}),v=[]},m}const commonVersionIdentifier=/version\/(\d+(\.?_?\d+)+)/i;let browserDetails;function getBrowser(i){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;if(typeof navigator>"u")return;const t=navigator.userAgent.toLowerCase();if(browserDetails===void 0||e){const s=browsersList.find(o=>{let{test:a}=o;return a.test(t)});browserDetails=s==null?void 0:s.describe(t)}return browserDetails}const browsersList=[{test:/firefox|iceweasel|fxios/i,describe(i){return{name:"Firefox",version:getMatch(/(?:firefox|iceweasel|fxios)[\s/](\d+(\.?_?\d+)+)/i,i),os:i.toLowerCase().includes("fxios")?"iOS":void 0,osVersion:getOSVersion(i)}}},{test:/chrom|crios|crmo/i,describe(i){return{name:"Chrome",version:getMatch(/(?:chrome|chromium|crios|crmo)\/(\d+(\.?_?\d+)+)/i,i),os:i.toLowerCase().includes("crios")?"iOS":void 0,osVersion:getOSVersion(i)}}},{test:/safari|applewebkit/i,describe(i){return{name:"Safari",version:getMatch(commonVersionIdentifier,i),os:i.includes("mobile/")?"iOS":"macOS",osVersion:getOSVersion(i)}}}];function getMatch(i,e){let t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1;const s=e.match(i);return s&&s.length>=t&&s[t]||""}function getOSVersion(i){return i.includes("mac os")?getMatch(/\(.+?(\d+_\d+(:?_\d+)?)/,i,1).replace(/_/g,"."):void 0}var version$1$1="2.5.10";const version$2=version$1$1,protocolVersion=15;class CriticalTimers{}CriticalTimers.setTimeout=function(){return setTimeout(...arguments)};CriticalTimers.setInterval=function(){return setInterval(...arguments)};CriticalTimers.clearTimeout=function(){return clearTimeout(...arguments)};CriticalTimers.clearInterval=function(){return clearInterval(...arguments)};class VideoPreset{constructor(e,t,s,o,a){if(typeof e=="object")this.width=e.width,this.height=e.height,this.aspectRatio=e.aspectRatio,this.encoding={maxBitrate:e.maxBitrate,maxFramerate:e.maxFramerate,priority:e.priority};else if(t!==void 0&&s!==void 0)this.width=e,this.height=t,this.aspectRatio=e/t,this.encoding={maxBitrate:s,maxFramerate:o,priority:a};else throw new TypeError("Unsupported options: provide at least width, height and maxBitrate")}get resolution(){return{width:this.width,height:this.height,frameRate:this.encoding.maxFramerate,aspectRatio:this.aspectRatio}}}const backupCodecs=["vp8","h264"],videoCodecs=["vp8","h264","vp9","av1"];function isBackupCodec(i){return!!backupCodecs.find(e=>e===i)}var AudioPresets;(function(i){i.telephone={maxBitrate:12e3},i.speech={maxBitrate:24e3},i.music={maxBitrate:48e3},i.musicStereo={maxBitrate:64e3},i.musicHighQuality={maxBitrate:96e3},i.musicHighQualityStereo={maxBitrate:128e3}})(AudioPresets||(AudioPresets={}));const VideoPresets={h90:new VideoPreset(160,90,9e4,20),h180:new VideoPreset(320,180,16e4,20),h216:new VideoPreset(384,216,18e4,20),h360:new VideoPreset(640,360,45e4,20),h540:new VideoPreset(960,540,8e5,25),h720:new VideoPreset(1280,720,17e5,30),h1080:new VideoPreset(1920,1080,3e6,30),h1440:new VideoPreset(2560,1440,5e6,30),h2160:new VideoPreset(3840,2160,8e6,30)},VideoPresets43={h120:new VideoPreset(160,120,7e4,20),h180:new VideoPreset(240,180,125e3,20),h240:new VideoPreset(320,240,14e4,20),h360:new VideoPreset(480,360,33e4,20),h480:new VideoPreset(640,480,5e5,20),h540:new VideoPreset(720,540,6e5,25),h720:new VideoPreset(960,720,13e5,30),h1080:new VideoPreset(1440,1080,23e5,30),h1440:new VideoPreset(1920,1440,38e5,30)},ScreenSharePresets={h360fps3:new VideoPreset(640,360,2e5,3,"medium"),h360fps15:new VideoPreset(640,360,4e5,15,"medium"),h720fps5:new VideoPreset(1280,720,8e5,5,"medium"),h720fps15:new VideoPreset(1280,720,15e5,15,"medium"),h720fps30:new VideoPreset(1280,720,2e6,30,"medium"),h1080fps15:new VideoPreset(1920,1080,25e5,15,"medium"),h1080fps30:new VideoPreset(1920,1080,5e6,30,"medium"),original:new VideoPreset(0,0,7e6,30,"medium")};function cloneDeep(i){if(!(typeof i>"u"))return typeof structuredClone=="function"?structuredClone(i):JSON.parse(JSON.stringify(i))}const BACKGROUND_REACTION_DELAY=5e3,recycledElements=[];var VideoQuality;(function(i){i[i.LOW=0]="LOW",i[i.MEDIUM=1]="MEDIUM",i[i.HIGH=2]="HIGH"})(VideoQuality||(VideoQuality={}));class Track extends eventsExports.EventEmitter{constructor(e,t){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};var o;super(),this.attachedElements=[],this.isMuted=!1,this.streamState=Track.StreamState.Active,this.isInBackground=!1,this._currentBitrate=0,this.log=livekitLogger,this.appVisibilityChangedListener=()=>{this.backgroundTimeout&&clearTimeout(this.backgroundTimeout),document.visibilityState==="hidden"?this.backgroundTimeout=setTimeout(()=>this.handleAppVisibilityChanged(),BACKGROUND_REACTION_DELAY):this.handleAppVisibilityChanged()},this.log=getLogger((o=s.loggerName)!==null&&o!==void 0?o:LoggerNames.Track),this.loggerContextCb=s.loggerContextCb,this.setMaxListeners(100),this.kind=t,this._mediaStreamTrack=e,this._mediaStreamID=e.id,this.source=Track.Source.Unknown}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),getLogContextFromTrack(this))}get currentBitrate(){return this._currentBitrate}get mediaStreamTrack(){return this._mediaStreamTrack}get mediaStreamID(){return this._mediaStreamID}attach(e){let t="audio";this.kind===Track.Kind.Video&&(t="video"),this.attachedElements.length===0&&this.kind===Track.Kind.Video&&this.addAppVisibilityListener(),e||(t==="audio"&&(recycledElements.forEach(a=>{a.parentElement===null&&!e&&(e=a)}),e&&recycledElements.splice(recycledElements.indexOf(e),1)),e||(e=document.createElement(t))),this.attachedElements.includes(e)||this.attachedElements.push(e),attachToElement(this.mediaStreamTrack,e);const s=e.srcObject.getTracks(),o=s.some(a=>a.kind==="audio");return e.play().then(()=>{this.emit(o?TrackEvent.AudioPlaybackStarted:TrackEvent.VideoPlaybackStarted)}).catch(a=>{a.name==="NotAllowedError"?this.emit(o?TrackEvent.AudioPlaybackFailed:TrackEvent.VideoPlaybackFailed,a):a.name==="AbortError"?livekitLogger.debug("".concat(o?"audio":"video"," playback aborted, likely due to new play request")):livekitLogger.warn("could not playback ".concat(o?"audio":"video"),a),o&&e&&s.some(c=>c.kind==="video")&&a.name==="NotAllowedError"&&(e.muted=!0,e.play().catch(()=>{}))}),this.emit(TrackEvent.ElementAttached,e),e}detach(e){try{if(e){detachTrack(this.mediaStreamTrack,e);const s=this.attachedElements.indexOf(e);return s>=0&&(this.attachedElements.splice(s,1),this.recycleElement(e),this.emit(TrackEvent.ElementDetached,e)),e}const t=[];return this.attachedElements.forEach(s=>{detachTrack(this.mediaStreamTrack,s),t.push(s),this.recycleElement(s),this.emit(TrackEvent.ElementDetached,s)}),this.attachedElements=[],t}finally{this.attachedElements.length===0&&this.removeAppVisibilityListener()}}stop(){this.stopMonitor(),this._mediaStreamTrack.stop()}enable(){this._mediaStreamTrack.enabled=!0}disable(){this._mediaStreamTrack.enabled=!1}stopMonitor(){this.monitorInterval&&clearInterval(this.monitorInterval),this.timeSyncHandle&&cancelAnimationFrame(this.timeSyncHandle)}updateLoggerOptions(e){e.loggerName&&(this.log=getLogger(e.loggerName)),e.loggerContextCb&&(this.loggerContextCb=e.loggerContextCb)}recycleElement(e){if(e instanceof HTMLAudioElement){let t=!0;e.pause(),recycledElements.forEach(s=>{s.parentElement||(t=!1)}),t&&recycledElements.push(e)}}handleAppVisibilityChanged(){return __awaiter$1(this,void 0,void 0,function*(){this.isInBackground=document.visibilityState==="hidden",!this.isInBackground&&this.kind===Track.Kind.Video&&setTimeout(()=>this.attachedElements.forEach(e=>e.play().catch(()=>{})),0)})}addAppVisibilityListener(){isWeb()?(this.isInBackground=document.visibilityState==="hidden",document.addEventListener("visibilitychange",this.appVisibilityChangedListener)):this.isInBackground=!1}removeAppVisibilityListener(){isWeb()&&document.removeEventListener("visibilitychange",this.appVisibilityChangedListener)}}function attachToElement(i,e){let t;e.srcObject instanceof MediaStream?t=e.srcObject:t=new MediaStream;let s;i.kind==="audio"?s=t.getAudioTracks():s=t.getVideoTracks(),s.includes(i)||(s.forEach(o=>{t.removeTrack(o)}),t.addTrack(i)),(!isSafari()||!(e instanceof HTMLVideoElement))&&(e.autoplay=!0),e.muted=t.getAudioTracks().length===0,e instanceof HTMLVideoElement&&(e.playsInline=!0),e.srcObject!==t&&(e.srcObject=t,(isSafari()||isFireFox())&&e instanceof HTMLVideoElement&&setTimeout(()=>{e.srcObject=t,e.play().catch(()=>{})},0))}function detachTrack(i,e){if(e.srcObject instanceof MediaStream){const t=e.srcObject;t.removeTrack(i),t.getTracks().length>0?e.srcObject=t:e.srcObject=null}}(function(i){let e;(function(p){p.Audio="audio",p.Video="video",p.Unknown="unknown"})(e=i.Kind||(i.Kind={}));let t;(function(p){p.Camera="camera",p.Microphone="microphone",p.ScreenShare="screen_share",p.ScreenShareAudio="screen_share_audio",p.Unknown="unknown"})(t=i.Source||(i.Source={}));let s;(function(p){p.Active="active",p.Paused="paused",p.Unknown="unknown"})(s=i.StreamState||(i.StreamState={}));function o(p){switch(p){case e.Audio:return TrackType.AUDIO;case e.Video:return TrackType.VIDEO;default:return TrackType.DATA}}i.kindToProto=o;function a(p){switch(p){case TrackType.AUDIO:return e.Audio;case TrackType.VIDEO:return e.Video;default:return e.Unknown}}i.kindFromProto=a;function c(p){switch(p){case t.Camera:return TrackSource.CAMERA;case t.Microphone:return TrackSource.MICROPHONE;case t.ScreenShare:return TrackSource.SCREEN_SHARE;case t.ScreenShareAudio:return TrackSource.SCREEN_SHARE_AUDIO;default:return TrackSource.UNKNOWN}}i.sourceToProto=c;function u(p){switch(p){case TrackSource.CAMERA:return t.Camera;case TrackSource.MICROPHONE:return t.Microphone;case TrackSource.SCREEN_SHARE:return t.ScreenShare;case TrackSource.SCREEN_SHARE_AUDIO:return t.ScreenShareAudio;default:return t.Unknown}}i.sourceFromProto=u;function d(p){switch(p){case StreamState.ACTIVE:return s.Active;case StreamState.PAUSED:return s.Paused;default:return s.Unknown}}i.streamStateFromProto=d})(Track||(Track={}));function mergeDefaultOptions(i,e,t){var s;const o=(s=cloneDeep(i))!==null&&s!==void 0?s:{};return o.audio===!0&&(o.audio={}),o.video===!0&&(o.video={}),o.audio&&mergeObjectWithoutOverwriting(o.audio,e),o.video&&mergeObjectWithoutOverwriting(o.video,t),o}function mergeObjectWithoutOverwriting(i,e){return Object.keys(e).forEach(t=>{i[t]===void 0&&(i[t]=e[t])}),i}function constraintsForOptions(i){const e={};if(i.video)if(typeof i.video=="object"){const t={},s=t,o=i.video;Object.keys(o).forEach(a=>{switch(a){case"resolution":mergeObjectWithoutOverwriting(s,o.resolution);break;default:s[a]=o[a]}}),e.video=t}else e.video=i.video;else e.video=!1;return i.audio?typeof i.audio=="object"?e.audio=i.audio:e.audio=!0:e.audio=!1,e}function detectSilence(i){return __awaiter$1(this,arguments,void 0,function(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:200;return function*(){const s=getNewAudioContext();if(s){const o=s.createAnalyser();o.fftSize=2048;const a=o.frequencyBinCount,c=new Uint8Array(a);s.createMediaStreamSource(new MediaStream([e.mediaStreamTrack])).connect(o),yield sleep$1(t),o.getByteTimeDomainData(c);const d=c.some(p=>p!==128&&p!==0);return s.close(),!d}return!1}()})}function getNewAudioContext(){const i=typeof window<"u"&&(window.AudioContext||window.webkitAudioContext);if(i)return new i({latencyHint:"interactive"})}function sourceToKind(i){return i===Track.Source.Microphone?"audioinput":i===Track.Source.Camera?"videoinput":void 0}function screenCaptureToDisplayMediaStreamOptions(i){var e,t;let s=(e=i.video)!==null&&e!==void 0?e:!0;return i.resolution&&i.resolution.width>0&&i.resolution.height>0&&(s=typeof s=="boolean"?{}:s,isSafari()?s=Object.assign(Object.assign({},s),{width:{max:i.resolution.width},height:{max:i.resolution.height},frameRate:i.resolution.frameRate}):s=Object.assign(Object.assign({},s),{width:{ideal:i.resolution.width},height:{ideal:i.resolution.height},frameRate:i.resolution.frameRate})),{audio:(t=i.audio)!==null&&t!==void 0?t:!1,video:s,controller:i.controller,selfBrowserSurface:i.selfBrowserSurface,surfaceSwitching:i.surfaceSwitching,systemAudio:i.systemAudio,preferCurrentTab:i.preferCurrentTab}}function mimeTypeToVideoCodecString(i){const e=i.split("/")[1].toLowerCase();if(!videoCodecs.includes(e))throw Error("Video codec not supported: ".concat(e));return e}function getTrackPublicationInfo(i){const e=[];return i.forEach(t=>{t.track!==void 0&&e.push(new TrackPublishedResponse({cid:t.track.mediaStreamID,track:t.trackInfo}))}),e}function getLogContextFromTrack(i){return i instanceof Track?{trackID:i.sid,source:i.source,muted:i.isMuted,enabled:i.mediaStreamTrack.enabled,kind:i.kind,streamID:i.mediaStreamID,streamTrackID:i.mediaStreamTrack.id}:{trackID:i.trackSid,enabled:i.isEnabled,muted:i.isMuted,trackInfo:Object.assign({mimeType:i.mimeType,name:i.trackName,encrypted:i.isEncrypted,kind:i.kind,source:i.source},i.track?getLogContextFromTrack(i.track):{})}}function supportsSynchronizationSources(){return typeof RTCRtpReceiver<"u"&&"getSynchronizationSources"in RTCRtpReceiver}function diffAttributes(i,e){var t;i===void 0&&(i={}),e===void 0&&(e={});const s=[...Object.keys(e),...Object.keys(i)],o={};for(const a of s)i[a]!==e[a]&&(o[a]=(t=e[a])!==null&&t!==void 0?t:"");return o}const separator="|",ddExtensionURI="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension";function unpackStreamId(i){const e=i.split(separator);return e.length>1?[e[0],i.substr(e[0].length+1)]:[i,""]}function sleep$1(i){return __awaiter$1(this,void 0,void 0,function*(){return new Promise(e=>CriticalTimers.setTimeout(e,i))})}function supportsTransceiver(){return"addTransceiver"in RTCPeerConnection.prototype}function supportsAddTrack(){return"addTrack"in RTCPeerConnection.prototype}function supportsAV1(){if(!("getCapabilities"in RTCRtpSender)||isSafari())return!1;const i=RTCRtpSender.getCapabilities("video");let e=!1;if(i){for(const t of i.codecs)if(t.mimeType==="video/AV1"){e=!0;break}}return e}function supportsVP9(){if(!("getCapabilities"in RTCRtpSender)||isFireFox())return!1;if(isSafari()){const t=getBrowser();if(t!=null&&t.version&&compareVersions(t.version,"16")<0)return!1}const i=RTCRtpSender.getCapabilities("video");let e=!1;if(i){for(const t of i.codecs)if(t.mimeType==="video/VP9"){e=!0;break}}return e}function isSVCCodec(i){return i==="av1"||i==="vp9"}function supportsSetSinkId(i){return document?(i||(i=document.createElement("audio")),"setSinkId"in i):!1}function isBrowserSupported(){return typeof RTCPeerConnection>"u"?!1:supportsTransceiver()||supportsAddTrack()}function isFireFox(){var i;return((i=getBrowser())===null||i===void 0?void 0:i.name)==="Firefox"}function isSafari(){var i;return((i=getBrowser())===null||i===void 0?void 0:i.name)==="Safari"}function isSafari17(){const i=getBrowser();return(i==null?void 0:i.name)==="Safari"&&i.version.startsWith("17.")}function isMobile(){var i,e;return isWeb()?(e=(i=navigator.userAgentData)===null||i===void 0?void 0:i.mobile)!==null&&e!==void 0?e:/Tablet|iPad|Mobile|Android|BlackBerry/.test(navigator.userAgent):!1}function isE2EESimulcastSupported(){const i=getBrowser(),e="17.2";if(i)return i.name!=="Safari"&&i.os!=="iOS"||i.os==="iOS"&&i.osVersion&&compareVersions(e,i.osVersion)>=0?!0:i.name==="Safari"&&compareVersions(e,i.version)>=0}function isWeb(){return typeof document<"u"}function isReactNative(){return navigator.product=="ReactNative"}function isCloud(i){return i.hostname.endsWith(".livekit.cloud")||i.hostname.endsWith(".livekit.run")}function getLKReactNativeInfo(){if(global&&global.LiveKitReactNativeGlobal)return global.LiveKitReactNativeGlobal}function getReactNativeOs(){if(!isReactNative())return;let i=getLKReactNativeInfo();if(i)return i.platform}function getDevicePixelRatio(){if(isWeb())return window.devicePixelRatio;if(isReactNative()){let i=getLKReactNativeInfo();if(i)return i.devicePixelRatio}return 1}function compareVersions(i,e){const t=i.split("."),s=e.split("."),o=Math.min(t.length,s.length);for(let a=0;a<o;++a){const c=parseInt(t[a],10),u=parseInt(s[a],10);if(c>u)return 1;if(c<u)return-1;if(a===o-1&&c===u)return 0}return i===""&&e!==""?-1:e===""?1:t.length==s.length?0:t.length<s.length?-1:1}function roDispatchCallback(i){for(const e of i)e.target.handleResize(e)}function ioDispatchCallback(i){for(const e of i)e.target.handleVisibilityChanged(e)}let resizeObserver=null;const getResizeObserver=()=>(resizeObserver||(resizeObserver=new ResizeObserver(roDispatchCallback)),resizeObserver);let intersectionObserver=null;const getIntersectionObserver=()=>(intersectionObserver||(intersectionObserver=new IntersectionObserver(ioDispatchCallback,{root:null,rootMargin:"0px"})),intersectionObserver);function getClientInfo(){var i;const e=new ClientInfo({sdk:ClientInfo_SDK.JS,protocol:protocolVersion,version:version$2});return isReactNative()&&(e.os=(i=getReactNativeOs())!==null&&i!==void 0?i:""),e}function createDummyVideoStreamTrack(){let i=arguments.length>0&&arguments[0]!==void 0?arguments[0]:16,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1;const o=document.createElement("canvas");o.width=i,o.height=e;const a=o.getContext("2d");a==null||a.fillRect(0,0,o.width,o.height),s&&a&&(a.beginPath(),a.arc(i/2,e/2,50,0,Math.PI*2,!0),a.closePath(),a.fillStyle="grey",a.fill());const c=o.captureStream(),[u]=c.getTracks();if(!u)throw Error("Could not get empty media stream video track");return u.enabled=t,u}let emptyAudioStreamTrack;function getEmptyAudioStreamTrack(){if(!emptyAudioStreamTrack){const i=new AudioContext,e=i.createOscillator(),t=i.createGain();t.gain.setValueAtTime(0,0);const s=i.createMediaStreamDestination();if(e.connect(t),t.connect(s),e.start(),[emptyAudioStreamTrack]=s.stream.getAudioTracks(),!emptyAudioStreamTrack)throw Error("Could not get empty media stream audio track");emptyAudioStreamTrack.enabled=!1}return emptyAudioStreamTrack.clone()}class Future{constructor(e,t){this.onFinally=t,this.promise=new Promise((s,o)=>__awaiter$1(this,void 0,void 0,function*(){this.resolve=s,this.reject=o,e&&(yield e(s,o))})).finally(()=>{var s;return(s=this.onFinally)===null||s===void 0?void 0:s.call(this)})}}function isVideoCodec(i){return videoCodecs.includes(i)}function unwrapConstraint(i){if(typeof i=="string"||typeof i=="number")return i;if(Array.isArray(i))return i[0];if(i.exact)return Array.isArray(i.exact)?i.exact[0]:i.exact;if(i.ideal)return Array.isArray(i.ideal)?i.ideal[0]:i.ideal;throw Error("could not unwrap constraint")}function toWebsocketUrl(i){return i.startsWith("http")?i.replace(/^(http)/,"ws"):i}function toHttpUrl(i){return i.startsWith("ws")?i.replace(/^(ws)/,"http"):i}function extractTranscriptionSegments(i,e){return i.segments.map(t=>{let{id:s,text:o,language:a,startTime:c,endTime:u,final:d}=t;var p;const v=(p=e.get(s))!==null&&p!==void 0?p:Date.now(),g=Date.now();return d?e.delete(s):e.set(s,v),{id:s,text:o,startTime:Number.parseInt(c.toString()),endTime:Number.parseInt(u.toString()),final:d,language:a,firstReceivedTime:v,lastReceivedTime:g}})}function extractChatMessage(i){const{id:e,timestamp:t,message:s,editTimestamp:o}=i;return{id:e,timestamp:Number.parseInt(t.toString()),editTimestamp:o?Number.parseInt(o.toString()):void 0,message:s}}const defaultId="default";class DeviceManager{static getInstance(){return this.instance===void 0&&(this.instance=new DeviceManager),this.instance}getDevices(e){return __awaiter$1(this,arguments,void 0,function(t){var s=this;let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var a;if(((a=DeviceManager.userMediaPromiseMap)===null||a===void 0?void 0:a.size)>0){livekitLogger.debug("awaiting getUserMedia promise");try{t?yield DeviceManager.userMediaPromiseMap.get(t):yield Promise.all(DeviceManager.userMediaPromiseMap.values())}catch{livekitLogger.warn("error waiting for media permissons")}}let c=yield navigator.mediaDevices.enumerateDevices();if(o&&!(isSafari()&&s.hasDeviceInUse(t))&&(c.filter(d=>d.kind===t).length===0||c.some(d=>{const p=d.label==="",v=t?d.kind===t:!0;return p&&v}))){const d={video:t!=="audioinput"&&t!=="audiooutput",audio:t!=="videoinput"},p=yield navigator.mediaDevices.getUserMedia(d);c=yield navigator.mediaDevices.enumerateDevices(),p.getTracks().forEach(v=>{v.stop()})}return t&&(c=c.filter(u=>u.kind===t)),c}()})}normalizeDeviceId(e,t,s){return __awaiter$1(this,void 0,void 0,function*(){if(t!==defaultId)return t;const o=yield this.getDevices(e),a=o.find(u=>u.deviceId===defaultId);if(!a){livekitLogger.warn("could not reliably determine default device");return}const c=o.find(u=>u.deviceId!==defaultId&&u.groupId===(s??a.groupId));if(!c){livekitLogger.warn("could not reliably determine default device");return}return c==null?void 0:c.deviceId})}hasDeviceInUse(e){return e?DeviceManager.userMediaPromiseMap.has(e):DeviceManager.userMediaPromiseMap.size>0}}DeviceManager.mediaDeviceKinds=["audioinput","audiooutput","videoinput"];DeviceManager.userMediaPromiseMap=new Map;const defaultDimensionsTimeout=1e3;class LocalTrack extends Track{get sender(){return this._sender}set sender(e){this._sender=e}get constraints(){return this._constraints}constructor(e,t,s){let o=arguments.length>3&&arguments[3]!==void 0?arguments[3]:!1,a=arguments.length>4?arguments[4]:void 0;super(e,t,a),this.manuallyStopped=!1,this._isUpstreamPaused=!1,this.handleTrackMuteEvent=()=>this.debouncedTrackMuteHandler().catch(()=>this.log.debug("track mute bounce got cancelled by an unmute event",this.logContext)),this.debouncedTrackMuteHandler=r(()=>__awaiter$1(this,void 0,void 0,function*(){yield this.pauseUpstream()}),5e3),this.handleTrackUnmuteEvent=()=>__awaiter$1(this,void 0,void 0,function*(){this.debouncedTrackMuteHandler.cancel("unmute"),yield this.resumeUpstream()}),this.handleEnded=()=>{this.isInBackground&&(this.reacquireTrack=!0),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),this.emit(TrackEvent.Ended,this)},this.reacquireTrack=!1,this.providedByUser=o,this.muteLock=new h,this.pauseUpstreamLock=new h,this.processorLock=new h,this.restartLock=new h,this.setMediaStreamTrack(e,!0),this._constraints=e.getConstraints(),s&&(this._constraints=s)}get id(){return this._mediaStreamTrack.id}get dimensions(){if(this.kind!==Track.Kind.Video)return;const{width:e,height:t}=this._mediaStreamTrack.getSettings();if(e&&t)return{width:e,height:t}}get isUpstreamPaused(){return this._isUpstreamPaused}get isUserProvided(){return this.providedByUser}get mediaStreamTrack(){var e,t;return(t=(e=this.processor)===null||e===void 0?void 0:e.processedTrack)!==null&&t!==void 0?t:this._mediaStreamTrack}setMediaStreamTrack(e,t){return __awaiter$1(this,void 0,void 0,function*(){if(e===this._mediaStreamTrack&&!t)return;this._mediaStreamTrack&&(this.attachedElements.forEach(o=>{detachTrack(this._mediaStreamTrack,o)}),this.debouncedTrackMuteHandler.cancel("new-track"),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent)),this.mediaStream=new MediaStream([e]),e&&(e.addEventListener("ended",this.handleEnded),e.addEventListener("mute",this.handleTrackMuteEvent),e.addEventListener("unmute",this.handleTrackUnmuteEvent),this._constraints=e.getConstraints());let s;if(this.processor&&e){const o=yield this.processorLock.lock();try{if(this.log.debug("restarting processor",this.logContext),this.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");this.processorElement&&(attachToElement(e,this.processorElement),this.processorElement.muted=!0),yield this.processor.restart({track:e,kind:this.kind,element:this.processorElement}),s=this.processor.processedTrack}finally{o()}}this.sender&&(yield this.sender.replaceTrack(s??e)),!this.providedByUser&&this._mediaStreamTrack!==e&&this._mediaStreamTrack.stop(),this._mediaStreamTrack=e,e&&(this._mediaStreamTrack.enabled=!this.isMuted,yield this.resumeUpstream(),this.attachedElements.forEach(o=>{attachToElement(s??e,o)}))})}waitForDimensions(){return __awaiter$1(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:defaultDimensionsTimeout;return function*(){var s;if(e.kind===Track.Kind.Audio)throw new Error("cannot get dimensions for audio tracks");((s=getBrowser())===null||s===void 0?void 0:s.os)==="iOS"&&(yield sleep$1(10));const o=Date.now();for(;Date.now()-o<t;){const a=e.dimensions;if(a)return a;yield sleep$1(50)}throw new TrackInvalidError("unable to get track dimensions after timeout")}()})}getDeviceId(){return __awaiter$1(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){if(e.source===Track.Source.ScreenShare)return;const{deviceId:s,groupId:o}=e._mediaStreamTrack.getSettings(),a=e.kind===Track.Kind.Audio?"audioinput":"videoinput";return t?DeviceManager.getInstance().normalizeDeviceId(a,s,o):s}()})}mute(){return __awaiter$1(this,void 0,void 0,function*(){return this.setTrackMuted(!0),this})}unmute(){return __awaiter$1(this,void 0,void 0,function*(){return this.setTrackMuted(!1),this})}replaceTrack(e,t){return __awaiter$1(this,void 0,void 0,function*(){if(!this.sender)throw new TrackInvalidError("unable to replace an unpublished track");let s,o;return typeof t=="boolean"?s=t:t!==void 0&&(s=t.userProvidedTrack,o=t.stopProcessor),this.providedByUser=s??!0,this.log.debug("replace MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(e),o&&this.processor&&(yield this.stopProcessor()),this})}restart(e){return __awaiter$1(this,void 0,void 0,function*(){this.manuallyStopped=!1;const t=yield this.restartLock.lock();try{e||(e=this._constraints),this.log.debug("restarting track with constraints",Object.assign(Object.assign({},this.logContext),{constraints:e}));const s={audio:!1,video:!1};this.kind===Track.Kind.Video?s.video=e:s.audio=e,this.attachedElements.forEach(c=>{detachTrack(this.mediaStreamTrack,c)}),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.stop();const a=(yield navigator.mediaDevices.getUserMedia(s)).getTracks()[0];return a.addEventListener("ended",this.handleEnded),this.log.debug("re-acquired MediaStreamTrack",this.logContext),yield this.setMediaStreamTrack(a),this._constraints=e,this.emit(TrackEvent.Restarted,this),this.manuallyStopped&&(this.log.warn("track was stopped during a restart, stopping restarted track",this.logContext),this.stop()),this}finally{t()}})}setTrackMuted(e){this.log.debug("setting ".concat(this.kind," track ").concat(e?"muted":"unmuted"),this.logContext),!(this.isMuted===e&&this._mediaStreamTrack.enabled!==e)&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?TrackEvent.Muted:TrackEvent.Unmuted,this))}get needsReAcquisition(){return this._mediaStreamTrack.readyState!=="live"||this._mediaStreamTrack.muted||!this._mediaStreamTrack.enabled||this.reacquireTrack}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$1(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),isMobile()&&(this.log.debug("visibility changed, is in Background: ".concat(this.isInBackground),this.logContext),!this.isInBackground&&this.needsReAcquisition&&!this.isUserProvided&&!this.isMuted&&(this.log.debug("track needs to be reacquired, restarting ".concat(this.source),this.logContext),yield this.restart(),this.reacquireTrack=!1))})}stop(){var e;this.manuallyStopped=!0,super.stop(),this._mediaStreamTrack.removeEventListener("ended",this.handleEnded),this._mediaStreamTrack.removeEventListener("mute",this.handleTrackMuteEvent),this._mediaStreamTrack.removeEventListener("unmute",this.handleTrackUnmuteEvent),(e=this.processor)===null||e===void 0||e.destroy(),this.processor=void 0}pauseUpstream(){return __awaiter$1(this,void 0,void 0,function*(){const e=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!0)return;if(!this.sender){this.log.warn("unable to pause upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!0,this.emit(TrackEvent.UpstreamPaused,this);const t=getBrowser();if((t==null?void 0:t.name)==="Safari"&&compareVersions(t.version,"12.0")<0)throw new DeviceUnsupportedError("pauseUpstream is not supported on Safari < 12.");yield this.sender.replaceTrack(null)}finally{e()}})}resumeUpstream(){return __awaiter$1(this,void 0,void 0,function*(){const e=yield this.pauseUpstreamLock.lock();try{if(this._isUpstreamPaused===!1)return;if(!this.sender){this.log.warn("unable to resume upstream for an unpublished track",this.logContext);return}this._isUpstreamPaused=!1,this.emit(TrackEvent.UpstreamResumed,this),yield this.sender.replaceTrack(this.mediaStreamTrack)}finally{e()}})}getRTCStatsReport(){return __awaiter$1(this,void 0,void 0,function*(){var e;return!((e=this.sender)===null||e===void 0)&&e.getStats?yield this.sender.getStats():void 0})}setProcessor(e){return __awaiter$1(this,arguments,void 0,function(t){var s=this;let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var a;const c=yield s.processorLock.lock();try{s.log.debug("setting up processor",s.logContext);const u=document.createElement(s.kind),d={kind:s.kind,track:s._mediaStreamTrack,element:u,audioContext:s.audioContext};if(yield t.init(d),s.log.debug("processor initialized",s.logContext),s.processor&&(yield s.stopProcessor()),s.kind==="unknown")throw TypeError("cannot set processor on track of unknown kind");if(attachToElement(s._mediaStreamTrack,u),u.muted=!0,u.play().catch(p=>s.log.error("failed to play processor element",Object.assign(Object.assign({},s.logContext),{error:p}))),s.processor=t,s.processorElement=u,s.processor.processedTrack){for(const p of s.attachedElements)p!==s.processorElement&&o&&(detachTrack(s._mediaStreamTrack,p),attachToElement(s.processor.processedTrack,p));yield(a=s.sender)===null||a===void 0?void 0:a.replaceTrack(s.processor.processedTrack)}s.emit(TrackEvent.TrackProcessorUpdate,s.processor)}finally{c()}}()})}getProcessor(){return this.processor}stopProcessor(){return __awaiter$1(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){var s,o;e.processor&&(e.log.debug("stopping processor",e.logContext),(s=e.processor.processedTrack)===null||s===void 0||s.stop(),yield e.processor.destroy(),e.processor=void 0,t||((o=e.processorElement)===null||o===void 0||o.remove(),e.processorElement=void 0),yield e._mediaStreamTrack.applyConstraints(e._constraints),yield e.setMediaStreamTrack(e._mediaStreamTrack,!0),e.emit(TrackEvent.TrackProcessorUpdate))}()})}}class E2EEManager extends eventsExports.EventEmitter{constructor(e){super(),this.onWorkerMessage=t=>{var s,o;const{kind:a,data:c}=t.data;switch(a){case"error":livekitLogger.error(c.error.message),this.emit(EncryptionEvent.EncryptionError,c.error);break;case"initAck":c.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)});break;case"enable":if(c.enabled&&this.keyProvider.getKeys().forEach(u=>{this.postKey(u)}),this.encryptionEnabled!==c.enabled&&c.participantIdentity===((s=this.room)===null||s===void 0?void 0:s.localParticipant.identity))this.emit(EncryptionEvent.ParticipantEncryptionStatusChanged,c.enabled,this.room.localParticipant),this.encryptionEnabled=c.enabled;else if(c.participantIdentity){const u=(o=this.room)===null||o===void 0?void 0:o.getParticipantByIdentity(c.participantIdentity);if(!u)throw TypeError("couldn't set encryption status, participant not found".concat(c.participantIdentity));this.emit(EncryptionEvent.ParticipantEncryptionStatusChanged,c.enabled,u)}break;case"ratchetKey":this.keyProvider.emit(KeyProviderEvent.KeyRatcheted,c.material,c.keyIndex);break}},this.onWorkerError=t=>{livekitLogger.error("e2ee worker encountered an error:",{error:t.error}),this.emit(EncryptionEvent.EncryptionError,t.error)},this.keyProvider=e.keyProvider,this.worker=e.worker,this.encryptionEnabled=!1}setup(e){if(!isE2EESupported())throw new DeviceUnsupportedError("tried to setup end-to-end encryption on an unsupported browser");if(livekitLogger.info("setting up e2ee"),e!==this.room){this.room=e,this.setupEventListeners(e,this.keyProvider);const t={kind:"init",data:{keyProviderOptions:this.keyProvider.getOptions(),loglevel:workerLogger.getLevel()}};this.worker&&(livekitLogger.info("initializing worker",{worker:this.worker}),this.worker.onmessage=this.onWorkerMessage,this.worker.onerror=this.onWorkerError,this.worker.postMessage(t))}}setParticipantCryptorEnabled(e,t){livekitLogger.debug("set e2ee to ".concat(e," for participant ").concat(t)),this.postEnable(e,t)}setSifTrailer(e){!e||e.length===0?livekitLogger.warn("ignoring server sent trailer as it's empty"):this.postSifTrailer(e)}setupEngine(e){e.on(EngineEvent.RTPVideoMapUpdate,t=>{this.postRTPMap(t)})}setupEventListeners(e,t){e.on(RoomEvent.TrackPublished,(s,o)=>this.setParticipantCryptorEnabled(s.trackInfo.encryption!==Encryption_Type.NONE,o.identity)),e.on(RoomEvent.ConnectionStateChanged,s=>{s===ConnectionState.Connected&&e.remoteParticipants.forEach(o=>{o.trackPublications.forEach(a=>{this.setParticipantCryptorEnabled(a.trackInfo.encryption!==Encryption_Type.NONE,o.identity)})})}).on(RoomEvent.TrackUnsubscribed,(s,o,a)=>{var c;const u={kind:"removeTransform",data:{participantIdentity:a.identity,trackId:s.mediaStreamID}};(c=this.worker)===null||c===void 0||c.postMessage(u)}).on(RoomEvent.TrackSubscribed,(s,o,a)=>{this.setupE2EEReceiver(s,a.identity,o.trackInfo)}).on(RoomEvent.SignalConnected,()=>{if(!this.room)throw new TypeError("expected room to be present on signal connect");t.getKeys().forEach(s=>{this.postKey(s)}),this.setParticipantCryptorEnabled(this.room.localParticipant.isE2EEEnabled,this.room.localParticipant.identity)}),e.localParticipant.on(ParticipantEvent.LocalTrackPublished,s=>__awaiter$1(this,void 0,void 0,function*(){this.setupE2EESender(s.track,s.track.sender)})),t.on(KeyProviderEvent.SetKey,s=>this.postKey(s)).on(KeyProviderEvent.RatchetRequest,(s,o)=>this.postRatchetRequest(s,o))}postRatchetRequest(e,t){if(!this.worker)throw Error("could not ratchet key, worker is missing");const s={kind:"ratchetRequest",data:{participantIdentity:e,keyIndex:t}};this.worker.postMessage(s)}postKey(e){let{key:t,participantIdentity:s,keyIndex:o}=e;var a;if(!this.worker)throw Error("could not set key, worker is missing");const c={kind:"setKey",data:{participantIdentity:s,isPublisher:s===((a=this.room)===null||a===void 0?void 0:a.localParticipant.identity),key:t,keyIndex:o}};this.worker.postMessage(c)}postEnable(e,t){if(this.worker){const s={kind:"enable",data:{enabled:e,participantIdentity:t}};this.worker.postMessage(s)}else throw new ReferenceError("failed to enable e2ee, worker is not ready")}postRTPMap(e){var t;if(!this.worker)throw TypeError("could not post rtp map, worker is missing");if(!(!((t=this.room)===null||t===void 0)&&t.localParticipant.identity))throw TypeError("could not post rtp map, local participant identity is missing");const s={kind:"setRTPMap",data:{map:e,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(s)}postSifTrailer(e){if(!this.worker)throw Error("could not post SIF trailer, worker is missing");const t={kind:"setSifTrailer",data:{trailer:e}};this.worker.postMessage(t)}setupE2EEReceiver(e,t,s){if(e.receiver){if(!(s!=null&&s.mimeType)||s.mimeType==="")throw new TypeError("MimeType missing from trackInfo, cannot set up E2EE cryptor");this.handleReceiver(e.receiver,e.mediaStreamID,t,e.kind==="video"?mimeTypeToVideoCodecString(s.mimeType):void 0)}}setupE2EESender(e,t){if(!(e instanceof LocalTrack)||!t){t||livekitLogger.warn("early return because sender is not ready");return}this.handleSender(t,e.mediaStreamID,void 0)}handleReceiver(e,t,s,o){return __awaiter$1(this,void 0,void 0,function*(){if(this.worker){if(isScriptTransformSupported()){const a={kind:"decode",participantIdentity:s,trackId:t,codec:o};e.transform=new RTCRtpScriptTransform(this.worker,a)}else{if(E2EE_FLAG in e&&o){const d={kind:"updateCodec",data:{trackId:t,codec:o,participantIdentity:s}};this.worker.postMessage(d);return}let a=e.writableStream,c=e.readableStream;if(!a||!c){const d=e.createEncodedStreams();e.writableStream=d.writable,a=d.writable,e.readableStream=d.readable,c=d.readable}const u={kind:"decode",data:{readableStream:c,writableStream:a,trackId:t,codec:o,participantIdentity:s}};this.worker.postMessage(u,[c,a])}e[E2EE_FLAG]=!0}})}handleSender(e,t,s){var o;if(!(E2EE_FLAG in e||!this.worker)){if(!(!((o=this.room)===null||o===void 0)&&o.localParticipant.identity)||this.room.localParticipant.identity==="")throw TypeError("local identity needs to be known in order to set up encrypted sender");if(isScriptTransformSupported()){livekitLogger.info("initialize script transform");const a={kind:"encode",participantIdentity:this.room.localParticipant.identity,trackId:t,codec:s};e.transform=new RTCRtpScriptTransform(this.worker,a)}else{livekitLogger.info("initialize encoded streams");const a=e.createEncodedStreams(),c={kind:"encode",data:{readableStream:a.readable,writableStream:a.writable,codec:s,trackId:t,participantIdentity:this.room.localParticipant.identity}};this.worker.postMessage(c,[a.readable,a.writable])}e[E2EE_FLAG]=!0}}}var QueueTaskStatus;(function(i){i[i.WAITING=0]="WAITING",i[i.RUNNING=1]="RUNNING",i[i.COMPLETED=2]="COMPLETED"})(QueueTaskStatus||(QueueTaskStatus={}));class AsyncQueue{constructor(){this.pendingTasks=new Map,this.taskMutex=new h,this.nextTaskIndex=0}run(e){return __awaiter$1(this,void 0,void 0,function*(){const t={id:this.nextTaskIndex++,enqueuedAt:Date.now(),status:QueueTaskStatus.WAITING};this.pendingTasks.set(t.id,t);const s=yield this.taskMutex.lock();try{return t.executedAt=Date.now(),t.status=QueueTaskStatus.RUNNING,yield e()}finally{t.status=QueueTaskStatus.COMPLETED,this.pendingTasks.delete(t.id),s()}})}flush(){return __awaiter$1(this,void 0,void 0,function*(){return this.run(()=>__awaiter$1(this,void 0,void 0,function*(){}))})}snapshot(){return Array.from(this.pendingTasks.values())}}const passThroughQueueSignals=["syncState","trickle","offer","answer","simulate","leave"];function canPassThroughQueue(i){const e=passThroughQueueSignals.indexOf(i.case)>=0;return livekitLogger.trace("request allowed to bypass queue:",{canPass:e,req:i}),e}var SignalConnectionState;(function(i){i[i.CONNECTING=0]="CONNECTING",i[i.CONNECTED=1]="CONNECTED",i[i.RECONNECTING=2]="RECONNECTING",i[i.DISCONNECTING=3]="DISCONNECTING",i[i.DISCONNECTED=4]="DISCONNECTED"})(SignalConnectionState||(SignalConnectionState={}));class SignalClient{get currentState(){return this.state}get isDisconnected(){return this.state===SignalConnectionState.DISCONNECTING||this.state===SignalConnectionState.DISCONNECTED}get isEstablishingConnection(){return this.state===SignalConnectionState.CONNECTING||this.state===SignalConnectionState.RECONNECTING}getNextRequestId(){return this._requestId+=1,this._requestId}constructor(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!1,t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var s;this.rtt=0,this.state=SignalConnectionState.DISCONNECTED,this.log=livekitLogger,this._requestId=0,this.resetCallbacks=()=>{this.onAnswer=void 0,this.onLeave=void 0,this.onLocalTrackPublished=void 0,this.onLocalTrackUnpublished=void 0,this.onNegotiateRequested=void 0,this.onOffer=void 0,this.onRemoteMuteChanged=void 0,this.onSubscribedQualityUpdate=void 0,this.onTokenRefresh=void 0,this.onTrickle=void 0,this.onClose=void 0},this.log=getLogger((s=t.loggerName)!==null&&s!==void 0?s:LoggerNames.Signal),this.loggerContextCb=t.loggerContextCb,this.useJSON=e,this.requestQueue=new AsyncQueue,this.queuedRequests=[],this.closingLock=new h,this.connectionLock=new h,this.state=SignalConnectionState.DISCONNECTED}get logContext(){var e,t;return(t=(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this))!==null&&t!==void 0?t:{}}join(e,t,s,o){return __awaiter$1(this,void 0,void 0,function*(){return this.state=SignalConnectionState.CONNECTING,this.options=s,yield this.connect(e,t,s,o)})}reconnect(e,t,s,o){return __awaiter$1(this,void 0,void 0,function*(){if(!this.options){this.log.warn("attempted to reconnect without signal options being set, ignoring",this.logContext);return}return this.state=SignalConnectionState.RECONNECTING,this.clearPingInterval(),yield this.connect(e,t,Object.assign(Object.assign({},this.options),{reconnect:!0,sid:s,reconnectReason:o}))})}connect(e,t,s,o){this.connectOptions=s,e=toWebsocketUrl(e),e=e.replace(/\/$/,""),e+="/rtc";const a=getClientInfo(),c=createConnectionParams(t,a,s);return new Promise((u,d)=>__awaiter$1(this,void 0,void 0,function*(){const p=yield this.connectionLock.lock();try{const v=()=>__awaiter$1(this,void 0,void 0,function*(){this.close(),clearTimeout(g),d(new ConnectionError("room connection has been cancelled (signal)"))}),g=setTimeout(()=>{this.close(),d(new ConnectionError("room connection has timed out (signal)"))},s.websocketTimeout);o!=null&&o.aborted&&v(),o==null||o.addEventListener("abort",v),this.log.debug("connecting to ".concat(e+c),this.logContext),this.ws&&(yield this.close(!1)),this.ws=new WebSocket(e+c),this.ws.binaryType="arraybuffer",this.ws.onopen=()=>{clearTimeout(g)},this.ws.onerror=m=>__awaiter$1(this,void 0,void 0,function*(){if(this.state!==SignalConnectionState.CONNECTED){this.state=SignalConnectionState.DISCONNECTED,clearTimeout(g);try{const S=yield fetch("http".concat(e.substring(2),"/validate").concat(c));if(S.status.toFixed(0).startsWith("4")){const y=yield S.text();d(new ConnectionError(y,ConnectionErrorReason.NotAllowed,S.status))}else d(new ConnectionError("Internal error",ConnectionErrorReason.InternalError,S.status))}catch{d(new ConnectionError("server was not reachable",ConnectionErrorReason.ServerUnreachable))}return}this.handleWSError(m)}),this.ws.onmessage=m=>__awaiter$1(this,void 0,void 0,function*(){var S,y,C;let R;if(typeof m.data=="string"){const T=JSON.parse(m.data);R=SignalResponse.fromJson(T,{ignoreUnknownFields:!0})}else if(m.data instanceof ArrayBuffer)R=SignalResponse.fromBinary(new Uint8Array(m.data));else{this.log.error("could not decode websocket message: ".concat(typeof m.data),this.logContext);return}if(this.state!==SignalConnectionState.CONNECTED){let T=!1;if(((S=R.message)===null||S===void 0?void 0:S.case)==="join"?(this.state=SignalConnectionState.CONNECTED,o==null||o.removeEventListener("abort",v),this.pingTimeoutDuration=R.message.value.pingTimeout,this.pingIntervalDuration=R.message.value.pingInterval,this.pingTimeoutDuration&&this.pingTimeoutDuration>0&&(this.log.debug("ping config",Object.assign(Object.assign({},this.logContext),{timeout:this.pingTimeoutDuration,interval:this.pingIntervalDuration})),this.startPingInterval()),u(R.message.value)):this.state===SignalConnectionState.RECONNECTING&&R.message.case!=="leave"?(this.state=SignalConnectionState.CONNECTED,o==null||o.removeEventListener("abort",v),this.startPingInterval(),((y=R.message)===null||y===void 0?void 0:y.case)==="reconnect"?u(R.message.value):(this.log.debug("declaring signal reconnected without reconnect response received",this.logContext),u(void 0),T=!0)):this.isEstablishingConnection&&R.message.case==="leave"?d(new ConnectionError("Received leave request while trying to (re)connect",ConnectionErrorReason.LeaveRequest)):s.reconnect||d(new ConnectionError("did not receive join response, got ".concat((C=R.message)===null||C===void 0?void 0:C.case," instead"))),!T)return}this.signalLatency&&(yield sleep$1(this.signalLatency)),this.handleSignalResponse(R)}),this.ws.onclose=m=>{this.isEstablishingConnection&&d(new ConnectionError("Websocket got closed during a (re)connection attempt")),this.log.warn("websocket closed",Object.assign(Object.assign({},this.logContext),{reason:m.reason,code:m.code,wasClean:m.wasClean,state:this.state})),this.handleOnClose(m.reason)}}finally{p()}}))}close(){return __awaiter$1(this,arguments,void 0,function(){var e=this;let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){const s=yield e.closingLock.lock();try{if(e.clearPingInterval(),t&&(e.state=SignalConnectionState.DISCONNECTING),e.ws){e.ws.onmessage=null,e.ws.onopen=null,e.ws.onclose=null;const o=new Promise(a=>{e.ws?e.ws.onclose=()=>{a()}:a()});e.ws.readyState<e.ws.CLOSING&&(e.ws.close(),yield Promise.race([o,sleep$1(250)])),e.ws=void 0}}finally{t&&(e.state=SignalConnectionState.DISCONNECTED),s()}}()})}sendOffer(e){this.log.debug("sending offer",Object.assign(Object.assign({},this.logContext),{offerSdp:e.sdp})),this.sendRequest({case:"offer",value:toProtoSessionDescription(e)})}sendAnswer(e){return this.log.debug("sending answer",Object.assign(Object.assign({},this.logContext),{answerSdp:e.sdp})),this.sendRequest({case:"answer",value:toProtoSessionDescription(e)})}sendIceCandidate(e,t){return this.log.trace("sending ice candidate",Object.assign(Object.assign({},this.logContext),{candidate:e})),this.sendRequest({case:"trickle",value:new TrickleRequest({candidateInit:JSON.stringify(e),target:t})})}sendMuteTrack(e,t){return this.sendRequest({case:"mute",value:new MuteTrackRequest({sid:e,muted:t})})}sendAddTrack(e){return this.sendRequest({case:"addTrack",value:e})}sendUpdateLocalMetadata(e,t){return __awaiter$1(this,arguments,void 0,function(s,o){var a=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};return function*(){const u=a.getNextRequestId();return yield a.sendRequest({case:"updateMetadata",value:new UpdateParticipantMetadata({requestId:u,metadata:s,name:o,attributes:c})}),u}()})}sendUpdateTrackSettings(e){this.sendRequest({case:"trackSetting",value:e})}sendUpdateSubscription(e){return this.sendRequest({case:"subscription",value:e})}sendSyncState(e){return this.sendRequest({case:"syncState",value:e})}sendUpdateVideoLayers(e,t){return this.sendRequest({case:"updateLayers",value:new UpdateVideoLayers({trackSid:e,layers:t})})}sendUpdateSubscriptionPermissions(e,t){return this.sendRequest({case:"subscriptionPermission",value:new SubscriptionPermission({allParticipants:e,trackPermissions:t})})}sendSimulateScenario(e){return this.sendRequest({case:"simulate",value:e})}sendPing(){return Promise.all([this.sendRequest({case:"ping",value:protoInt64.parse(Date.now())}),this.sendRequest({case:"pingReq",value:new Ping({timestamp:protoInt64.parse(Date.now()),rtt:protoInt64.parse(this.rtt)})})])}sendUpdateLocalAudioTrack(e,t){return this.sendRequest({case:"updateAudioTrack",value:new UpdateLocalAudioTrack({trackSid:e,features:t})})}sendLeave(){return this.sendRequest({case:"leave",value:new LeaveRequest({reason:DisconnectReason.CLIENT_INITIATED,action:LeaveRequest_Action.DISCONNECT})})}sendRequest(e){return __awaiter$1(this,arguments,void 0,function(t){var s=this;let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1;return function*(){if(!o&&!canPassThroughQueue(t)&&s.state===SignalConnectionState.RECONNECTING){s.queuedRequests.push(()=>__awaiter$1(s,void 0,void 0,function*(){yield this.sendRequest(t,!0)}));return}if(o||(yield s.requestQueue.flush()),s.signalLatency&&(yield sleep$1(s.signalLatency)),!s.ws||s.ws.readyState!==s.ws.OPEN){s.log.error("cannot send signal request before connected, type: ".concat(t==null?void 0:t.case),s.logContext);return}const c=new SignalRequest({message:t});try{s.useJSON?s.ws.send(c.toJsonString()):s.ws.send(c.toBinary())}catch(u){s.log.error("error sending signal message",Object.assign(Object.assign({},s.logContext),{error:u}))}}()})}handleSignalResponse(e){var t,s;const o=e.message;if(o==null){this.log.debug("received unsupported message",this.logContext);return}let a=!1;if(o.case==="answer"){const c=fromProtoSessionDescription(o.value);this.onAnswer&&this.onAnswer(c)}else if(o.case==="offer"){const c=fromProtoSessionDescription(o.value);this.onOffer&&this.onOffer(c)}else if(o.case==="trickle"){const c=JSON.parse(o.value.candidateInit);this.onTrickle&&this.onTrickle(c,o.value.target)}else o.case==="update"?this.onParticipantUpdate&&this.onParticipantUpdate((t=o.value.participants)!==null&&t!==void 0?t:[]):o.case==="trackPublished"?this.onLocalTrackPublished&&this.onLocalTrackPublished(o.value):o.case==="speakersChanged"?this.onSpeakersChanged&&this.onSpeakersChanged((s=o.value.speakers)!==null&&s!==void 0?s:[]):o.case==="leave"?this.onLeave&&this.onLeave(o.value):o.case==="mute"?this.onRemoteMuteChanged&&this.onRemoteMuteChanged(o.value.sid,o.value.muted):o.case==="roomUpdate"?this.onRoomUpdate&&o.value.room&&this.onRoomUpdate(o.value.room):o.case==="connectionQuality"?this.onConnectionQuality&&this.onConnectionQuality(o.value):o.case==="streamStateUpdate"?this.onStreamStateUpdate&&this.onStreamStateUpdate(o.value):o.case==="subscribedQualityUpdate"?this.onSubscribedQualityUpdate&&this.onSubscribedQualityUpdate(o.value):o.case==="subscriptionPermissionUpdate"?this.onSubscriptionPermissionUpdate&&this.onSubscriptionPermissionUpdate(o.value):o.case==="refreshToken"?this.onTokenRefresh&&this.onTokenRefresh(o.value):o.case==="trackUnpublished"?this.onLocalTrackUnpublished&&this.onLocalTrackUnpublished(o.value):o.case==="subscriptionResponse"?this.onSubscriptionError&&this.onSubscriptionError(o.value):o.case==="pong"||(o.case==="pongResp"?(this.rtt=Date.now()-Number.parseInt(o.value.lastPingTimestamp.toString()),this.resetPingTimeout(),a=!0):o.case==="requestResponse"?this.onRequestResponse&&this.onRequestResponse(o.value):o.case==="trackSubscribed"?this.onLocalTrackSubscribed&&this.onLocalTrackSubscribed(o.value.trackSid):this.log.debug("unsupported message",Object.assign(Object.assign({},this.logContext),{msgCase:o.case})));a||this.resetPingTimeout()}setReconnected(){for(;this.queuedRequests.length>0;){const e=this.queuedRequests.shift();e&&this.requestQueue.run(e)}}handleOnClose(e){return __awaiter$1(this,void 0,void 0,function*(){if(this.state===SignalConnectionState.DISCONNECTED)return;const t=this.onClose;yield this.close(),this.log.debug("websocket connection closed: ".concat(e),Object.assign(Object.assign({},this.logContext),{reason:e})),t&&t(e)})}handleWSError(e){this.log.error("websocket error",Object.assign(Object.assign({},this.logContext),{error:e}))}resetPingTimeout(){if(this.clearPingTimeout(),!this.pingTimeoutDuration){this.log.warn("ping timeout duration not set",this.logContext);return}this.pingTimeout=CriticalTimers.setTimeout(()=>{this.log.warn("ping timeout triggered. last pong received at: ".concat(new Date(Date.now()-this.pingTimeoutDuration*1e3).toUTCString()),this.logContext),this.handleOnClose("ping timeout")},this.pingTimeoutDuration*1e3)}clearPingTimeout(){this.pingTimeout&&CriticalTimers.clearTimeout(this.pingTimeout)}startPingInterval(){if(this.clearPingInterval(),this.resetPingTimeout(),!this.pingIntervalDuration){this.log.warn("ping interval duration not set",this.logContext);return}this.log.debug("start ping interval",this.logContext),this.pingInterval=CriticalTimers.setInterval(()=>{this.sendPing()},this.pingIntervalDuration*1e3)}clearPingInterval(){this.log.debug("clearing ping interval",this.logContext),this.clearPingTimeout(),this.pingInterval&&CriticalTimers.clearInterval(this.pingInterval)}}function fromProtoSessionDescription(i){const e={type:"offer",sdp:i.sdp};switch(i.type){case"answer":case"offer":case"pranswer":case"rollback":e.type=i.type;break}return e}function toProtoSessionDescription(i){return new SessionDescription({sdp:i.sdp,type:i.type})}function createConnectionParams(i,e,t){var s;const o=new URLSearchParams;return o.set("access_token",i),t.reconnect&&(o.set("reconnect","1"),t.sid&&o.set("sid",t.sid)),o.set("auto_subscribe",t.autoSubscribe?"1":"0"),o.set("sdk",isReactNative()?"reactnative":"js"),o.set("version",e.version),o.set("protocol",e.protocol.toString()),e.deviceModel&&o.set("device_model",e.deviceModel),e.os&&o.set("os",e.os),e.osVersion&&o.set("os_version",e.osVersion),e.browser&&o.set("browser",e.browser),e.browserVersion&&o.set("browser_version",e.browserVersion),t.adaptiveStream&&o.set("adaptive_stream","1"),t.reconnectReason&&o.set("reconnect_reason",t.reconnectReason.toString()),!((s=navigator.connection)===null||s===void 0)&&s.type&&o.set("network",navigator.connection.type),"?".concat(o.toString())}var lib={},parser={},grammar={exports:{}},hasRequiredGrammar;function requireGrammar(){if(hasRequiredGrammar)return grammar.exports;hasRequiredGrammar=1;var i=grammar.exports={v:[{name:"version",reg:/^(\d*)$/}],o:[{name:"origin",reg:/^(\S*) (\d*) (\d*) (\S*) IP(\d) (\S*)/,names:["username","sessionId","sessionVersion","netType","ipVer","address"],format:"%s %s %d %s IP%d %s"}],s:[{name:"name"}],i:[{name:"description"}],u:[{name:"uri"}],e:[{name:"email"}],p:[{name:"phone"}],z:[{name:"timezones"}],r:[{name:"repeats"}],t:[{name:"timing",reg:/^(\d*) (\d*)/,names:["start","stop"],format:"%d %d"}],c:[{name:"connection",reg:/^IN IP(\d) (\S*)/,names:["version","ip"],format:"IN IP%d %s"}],b:[{push:"bandwidth",reg:/^(TIAS|AS|CT|RR|RS):(\d*)/,names:["type","limit"],format:"%s:%s"}],m:[{reg:/^(\w*) (\d*) ([\w/]*)(?: (.*))?/,names:["type","port","protocol","payloads"],format:"%s %d %s %s"}],a:[{push:"rtp",reg:/^rtpmap:(\d*) ([\w\-.]*)(?:\s*\/(\d*)(?:\s*\/(\S*))?)?/,names:["payload","codec","rate","encoding"],format:function(e){return e.encoding?"rtpmap:%d %s/%s/%s":e.rate?"rtpmap:%d %s/%s":"rtpmap:%d %s"}},{push:"fmtp",reg:/^fmtp:(\d*) ([\S| ]*)/,names:["payload","config"],format:"fmtp:%d %s"},{name:"control",reg:/^control:(.*)/,format:"control:%s"},{name:"rtcp",reg:/^rtcp:(\d*)(?: (\S*) IP(\d) (\S*))?/,names:["port","netType","ipVer","address"],format:function(e){return e.address!=null?"rtcp:%d %s IP%d %s":"rtcp:%d"}},{push:"rtcpFbTrrInt",reg:/^rtcp-fb:(\*|\d*) trr-int (\d*)/,names:["payload","value"],format:"rtcp-fb:%s trr-int %d"},{push:"rtcpFb",reg:/^rtcp-fb:(\*|\d*) ([\w-_]*)(?: ([\w-_]*))?/,names:["payload","type","subtype"],format:function(e){return e.subtype!=null?"rtcp-fb:%s %s %s":"rtcp-fb:%s %s"}},{push:"ext",reg:/^extmap:(\d+)(?:\/(\w+))?(?: (urn:ietf:params:rtp-hdrext:encrypt))? (\S*)(?: (\S*))?/,names:["value","direction","encrypt-uri","uri","config"],format:function(e){return"extmap:%d"+(e.direction?"/%s":"%v")+(e["encrypt-uri"]?" %s":"%v")+" %s"+(e.config?" %s":"")}},{name:"extmapAllowMixed",reg:/^(extmap-allow-mixed)/},{push:"crypto",reg:/^crypto:(\d*) ([\w_]*) (\S*)(?: (\S*))?/,names:["id","suite","config","sessionConfig"],format:function(e){return e.sessionConfig!=null?"crypto:%d %s %s %s":"crypto:%d %s %s"}},{name:"setup",reg:/^setup:(\w*)/,format:"setup:%s"},{name:"connectionType",reg:/^connection:(new|existing)/,format:"connection:%s"},{name:"mid",reg:/^mid:([^\s]*)/,format:"mid:%s"},{name:"msid",reg:/^msid:(.*)/,format:"msid:%s"},{name:"ptime",reg:/^ptime:(\d*(?:\.\d*)*)/,format:"ptime:%d"},{name:"maxptime",reg:/^maxptime:(\d*(?:\.\d*)*)/,format:"maxptime:%d"},{name:"direction",reg:/^(sendrecv|recvonly|sendonly|inactive)/},{name:"icelite",reg:/^(ice-lite)/},{name:"iceUfrag",reg:/^ice-ufrag:(\S*)/,format:"ice-ufrag:%s"},{name:"icePwd",reg:/^ice-pwd:(\S*)/,format:"ice-pwd:%s"},{name:"fingerprint",reg:/^fingerprint:(\S*) (\S*)/,names:["type","hash"],format:"fingerprint:%s %s"},{push:"candidates",reg:/^candidate:(\S*) (\d*) (\S*) (\d*) (\S*) (\d*) typ (\S*)(?: raddr (\S*) rport (\d*))?(?: tcptype (\S*))?(?: generation (\d*))?(?: network-id (\d*))?(?: network-cost (\d*))?/,names:["foundation","component","transport","priority","ip","port","type","raddr","rport","tcptype","generation","network-id","network-cost"],format:function(e){var t="candidate:%s %d %s %d %s %d typ %s";return t+=e.raddr!=null?" raddr %s rport %d":"%v%v",t+=e.tcptype!=null?" tcptype %s":"%v",e.generation!=null&&(t+=" generation %d"),t+=e["network-id"]!=null?" network-id %d":"%v",t+=e["network-cost"]!=null?" network-cost %d":"%v",t}},{name:"endOfCandidates",reg:/^(end-of-candidates)/},{name:"remoteCandidates",reg:/^remote-candidates:(.*)/,format:"remote-candidates:%s"},{name:"iceOptions",reg:/^ice-options:(\S*)/,format:"ice-options:%s"},{push:"ssrcs",reg:/^ssrc:(\d*) ([\w_-]*)(?::(.*))?/,names:["id","attribute","value"],format:function(e){var t="ssrc:%d";return e.attribute!=null&&(t+=" %s",e.value!=null&&(t+=":%s")),t}},{push:"ssrcGroups",reg:/^ssrc-group:([\x21\x23\x24\x25\x26\x27\x2A\x2B\x2D\x2E\w]*) (.*)/,names:["semantics","ssrcs"],format:"ssrc-group:%s %s"},{name:"msidSemantic",reg:/^msid-semantic:\s?(\w*) (\S*)/,names:["semantic","token"],format:"msid-semantic: %s %s"},{push:"groups",reg:/^group:(\w*) (.*)/,names:["type","mids"],format:"group:%s %s"},{name:"rtcpMux",reg:/^(rtcp-mux)/},{name:"rtcpRsize",reg:/^(rtcp-rsize)/},{name:"sctpmap",reg:/^sctpmap:([\w_/]*) (\S*)(?: (\S*))?/,names:["sctpmapNumber","app","maxMessageSize"],format:function(e){return e.maxMessageSize!=null?"sctpmap:%s %s %s":"sctpmap:%s %s"}},{name:"xGoogleFlag",reg:/^x-google-flag:([^\s]*)/,format:"x-google-flag:%s"},{push:"rids",reg:/^rid:([\d\w]+) (\w+)(?: ([\S| ]*))?/,names:["id","direction","params"],format:function(e){return e.params?"rid:%s %s %s":"rid:%s %s"}},{push:"imageattrs",reg:new RegExp("^imageattr:(\\d+|\\*)[\\s\\t]+(send|recv)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*)(?:[\\s\\t]+(recv|send)[\\s\\t]+(\\*|\\[\\S+\\](?:[\\s\\t]+\\[\\S+\\])*))?"),names:["pt","dir1","attrs1","dir2","attrs2"],format:function(e){return"imageattr:%s %s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast",reg:new RegExp("^simulcast:(send|recv) ([a-zA-Z0-9\\-_~;,]+)(?:\\s?(send|recv) ([a-zA-Z0-9\\-_~;,]+))?$"),names:["dir1","list1","dir2","list2"],format:function(e){return"simulcast:%s %s"+(e.dir2?" %s %s":"")}},{name:"simulcast_03",reg:/^simulcast:[\s\t]+([\S+\s\t]+)$/,names:["value"],format:"simulcast: %s"},{name:"framerate",reg:/^framerate:(\d+(?:$|\.\d+))/,format:"framerate:%s"},{name:"sourceFilter",reg:/^source-filter: *(excl|incl) (\S*) (IP4|IP6|\*) (\S*) (.*)/,names:["filterMode","netType","addressTypes","destAddress","srcList"],format:"source-filter: %s %s %s %s %s"},{name:"bundleOnly",reg:/^(bundle-only)/},{name:"label",reg:/^label:(.+)/,format:"label:%s"},{name:"sctpPort",reg:/^sctp-port:(\d+)$/,format:"sctp-port:%s"},{name:"maxMessageSize",reg:/^max-message-size:(\d+)$/,format:"max-message-size:%s"},{push:"tsRefClocks",reg:/^ts-refclk:([^\s=]*)(?:=(\S*))?/,names:["clksrc","clksrcExt"],format:function(e){return"ts-refclk:%s"+(e.clksrcExt!=null?"=%s":"")}},{name:"mediaClk",reg:/^mediaclk:(?:id=(\S*))? *([^\s=]*)(?:=(\S*))?(?: *rate=(\d+)\/(\d+))?/,names:["id","mediaClockName","mediaClockValue","rateNumerator","rateDenominator"],format:function(e){var t="mediaclk:";return t+=e.id!=null?"id=%s %s":"%v%s",t+=e.mediaClockValue!=null?"=%s":"",t+=e.rateNumerator!=null?" rate=%s":"",t+=e.rateDenominator!=null?"/%s":"",t}},{name:"keywords",reg:/^keywds:(.+)$/,format:"keywds:%s"},{name:"content",reg:/^content:(.+)/,format:"content:%s"},{name:"bfcpFloorCtrl",reg:/^floorctrl:(c-only|s-only|c-s)/,format:"floorctrl:%s"},{name:"bfcpConfId",reg:/^confid:(\d+)/,format:"confid:%s"},{name:"bfcpUserId",reg:/^userid:(\d+)/,format:"userid:%s"},{name:"bfcpFloorId",reg:/^floorid:(.+) (?:m-stream|mstrm):(.+)/,names:["id","mStream"],format:"floorid:%s mstrm:%s"},{push:"invalid",names:["value"]}]};return Object.keys(i).forEach(function(e){var t=i[e];t.forEach(function(s){s.reg||(s.reg=/(.*)/),s.format||(s.format="%s")})}),grammar.exports}var hasRequiredParser;function requireParser(){return hasRequiredParser||(hasRequiredParser=1,function(i){var e=function(u){return String(Number(u))===u?Number(u):u},t=function(u,d,p,v){if(v&&!p)d[v]=e(u[1]);else for(var g=0;g<p.length;g+=1)u[g+1]!=null&&(d[p[g]]=e(u[g+1]))},s=function(u,d,p){var v=u.name&&u.names;u.push&&!d[u.push]?d[u.push]=[]:v&&!d[u.name]&&(d[u.name]={});var g=u.push?{}:v?d[u.name]:d;t(p.match(u.reg),g,u.names,u.name),u.push&&d[u.push].push(g)},o=requireGrammar(),a=RegExp.prototype.test.bind(/^([a-z])=(.*)/);i.parse=function(u){var d={},p=[],v=d;return u.split(/(\r\n|\r|\n)/).filter(a).forEach(function(g){var m=g[0],S=g.slice(2);m==="m"&&(p.push({rtp:[],fmtp:[]}),v=p[p.length-1]);for(var y=0;y<(o[m]||[]).length;y+=1){var C=o[m][y];if(C.reg.test(S))return s(C,v,S)}}),d.media=p,d};var c=function(u,d){var p=d.split(/=(.+)/,2);return p.length===2?u[p[0]]=e(p[1]):p.length===1&&d.length>1&&(u[p[0]]=void 0),u};i.parseParams=function(u){return u.split(/;\s?/).reduce(c,{})},i.parseFmtpConfig=i.parseParams,i.parsePayloads=function(u){return u.toString().split(" ").map(Number)},i.parseRemoteCandidates=function(u){for(var d=[],p=u.split(" ").map(e),v=0;v<p.length;v+=3)d.push({component:p[v],ip:p[v+1],port:p[v+2]});return d},i.parseImageAttributes=function(u){return u.split(" ").map(function(d){return d.substring(1,d.length-1).split(",").reduce(c,{})})},i.parseSimulcastStreamList=function(u){return u.split(";").map(function(d){return d.split(",").map(function(p){var v,g=!1;return p[0]!=="~"?v=e(p):(v=e(p.substring(1,p.length)),g=!0),{scid:v,paused:g}})})}}(parser)),parser}var writer$1,hasRequiredWriter;function requireWriter(){if(hasRequiredWriter)return writer$1;hasRequiredWriter=1;var i=requireGrammar(),e=/%[sdv%]/g,t=function(c){var u=1,d=arguments,p=d.length;return c.replace(e,function(v){if(u>=p)return v;var g=d[u];switch(u+=1,v){case"%%":return"%";case"%s":return String(g);case"%d":return Number(g);case"%v":return""}})},s=function(c,u,d){var p=u.format instanceof Function?u.format(u.push?d:d[u.name]):u.format,v=[c+"="+p];if(u.names)for(var g=0;g<u.names.length;g+=1){var m=u.names[g];u.name?v.push(d[u.name][m]):v.push(d[u.names[g]])}else v.push(d[u.name]);return t.apply(null,v)},o=["v","o","s","i","u","e","p","c","b","t","r","z","a"],a=["i","c","b","a"];return writer$1=function(c,u){u=u||{},c.version==null&&(c.version=0),c.name==null&&(c.name=" "),c.media.forEach(function(g){g.payloads==null&&(g.payloads="")});var d=u.outerOrder||o,p=u.innerOrder||a,v=[];return d.forEach(function(g){i[g].forEach(function(m){m.name in c&&c[m.name]!=null?v.push(s(g,m,c)):m.push in c&&c[m.push]!=null&&c[m.push].forEach(function(S){v.push(s(g,m,S))})})}),c.media.forEach(function(g){v.push(s("m",i.m[0],g)),p.forEach(function(m){i[m].forEach(function(S){S.name in g&&g[S.name]!=null?v.push(s(m,S,g)):S.push in g&&g[S.push]!=null&&g[S.push].forEach(function(y){v.push(s(m,S,y))})})})}),v.join(`\r
`)+`\r
`},writer$1}var hasRequiredLib;function requireLib(){if(hasRequiredLib)return lib;hasRequiredLib=1;var i=requireParser(),e=requireWriter();return lib.write=e,lib.parse=i.parse,lib.parseParams=i.parseParams,lib.parseFmtpConfig=i.parseFmtpConfig,lib.parsePayloads=i.parsePayloads,lib.parseRemoteCandidates=i.parseRemoteCandidates,lib.parseImageAttributes=i.parseImageAttributes,lib.parseSimulcastStreamList=i.parseSimulcastStreamList,lib}var libExports=requireLib();const startBitrateForSVC=.7,debounceInterval=20,PCEvents={NegotiationStarted:"negotiationStarted",NegotiationComplete:"negotiationComplete",RTPVideoPayloadTypes:"rtpVideoPayloadTypes"};class PCTransport extends eventsExports.EventEmitter{get pc(){return this._pc||(this._pc=this.createPC()),this._pc}constructor(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var s;super(),this.log=livekitLogger,this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate=!1,this.trackBitrates=[],this.remoteStereoMids=[],this.remoteNackMids=[],this.negotiate=r(o=>__awaiter$1(this,void 0,void 0,function*(){this.emit(PCEvents.NegotiationStarted);try{yield this.createAndSendOffer()}catch(a){if(o)o(a);else throw a}}),debounceInterval),this.close=()=>{this._pc&&(this._pc.close(),this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc.onicegatheringstatechange=null,this._pc.ondatachannel=null,this._pc.onnegotiationneeded=null,this._pc.onsignalingstatechange=null,this._pc.onicecandidate=null,this._pc.ondatachannel=null,this._pc.ontrack=null,this._pc.onconnectionstatechange=null,this._pc.oniceconnectionstatechange=null,this._pc=null)},this.log=getLogger((s=t.loggerName)!==null&&s!==void 0?s:LoggerNames.PCTransport),this.loggerOptions=t,this.config=e,this._pc=this.createPC()}createPC(){const e=new RTCPeerConnection(this.config);return e.onicecandidate=t=>{var s;t.candidate&&((s=this.onIceCandidate)===null||s===void 0||s.call(this,t.candidate))},e.onicecandidateerror=t=>{var s;(s=this.onIceCandidateError)===null||s===void 0||s.call(this,t)},e.oniceconnectionstatechange=()=>{var t;(t=this.onIceConnectionStateChange)===null||t===void 0||t.call(this,e.iceConnectionState)},e.onsignalingstatechange=()=>{var t;(t=this.onSignalingStatechange)===null||t===void 0||t.call(this,e.signalingState)},e.onconnectionstatechange=()=>{var t;(t=this.onConnectionStateChange)===null||t===void 0||t.call(this,e.connectionState)},e.ondatachannel=t=>{var s;(s=this.onDataChannel)===null||s===void 0||s.call(this,t)},e.ontrack=t=>{var s;(s=this.onTrack)===null||s===void 0||s.call(this,t)},e}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isICEConnected(){return this._pc!==null&&(this.pc.iceConnectionState==="connected"||this.pc.iceConnectionState==="completed")}addIceCandidate(e){return __awaiter$1(this,void 0,void 0,function*(){if(this.pc.remoteDescription&&!this.restartingIce)return this.pc.addIceCandidate(e);this.pendingCandidates.push(e)})}setRemoteDescription(e){return __awaiter$1(this,void 0,void 0,function*(){var t;let s;if(e.type==="offer"){let{stereoMids:o,nackMids:a}=extractStereoAndNackAudioFromOffer(e);this.remoteStereoMids=o,this.remoteNackMids=a}else if(e.type==="answer"){const o=libExports.parse((t=e.sdp)!==null&&t!==void 0?t:"");o.media.forEach(a=>{a.type==="audio"&&this.trackBitrates.some(c=>{if(!c.transceiver||a.mid!=c.transceiver.mid)return!1;let u=0;if(a.rtp.some(p=>p.codec.toUpperCase()===c.codec.toUpperCase()?(u=p.payload,!0):!1),u===0)return!0;let d=!1;for(const p of a.fmtp)if(p.payload===u){p.config=p.config.split(";").filter(v=>!v.includes("maxaveragebitrate")).join(";"),c.maxbr>0&&(p.config+=";maxaveragebitrate=".concat(c.maxbr*1e3)),d=!0;break}return d||c.maxbr>0&&a.fmtp.push({payload:u,config:"maxaveragebitrate=".concat(c.maxbr*1e3)}),!0})}),s=libExports.write(o)}yield this.setMungedSDP(e,s,!0),this.pendingCandidates.forEach(o=>{this.pc.addIceCandidate(o)}),this.pendingCandidates=[],this.restartingIce=!1,this.renegotiate?(this.renegotiate=!1,yield this.createAndSendOffer()):e.type==="answer"&&(this.emit(PCEvents.NegotiationComplete),e.sdp&&libExports.parse(e.sdp).media.forEach(a=>{a.type==="video"&&this.emit(PCEvents.RTPVideoPayloadTypes,a.rtp)}))})}createAndSendOffer(e){return __awaiter$1(this,void 0,void 0,function*(){var t;if(this.onOffer===void 0)return;if(e!=null&&e.iceRestart&&(this.log.debug("restarting ICE",this.logContext),this.restartingIce=!0),this._pc&&this._pc.signalingState==="have-local-offer"){const a=this._pc.remoteDescription;if(e!=null&&e.iceRestart&&a)yield this._pc.setRemoteDescription(a);else{this.renegotiate=!0;return}}else if(!this._pc||this._pc.signalingState==="closed"){this.log.warn("could not createOffer with closed peer connection",this.logContext);return}this.log.debug("starting to negotiate",this.logContext);const s=yield this.pc.createOffer(e);this.log.debug("original offer",Object.assign({sdp:s.sdp},this.logContext));const o=libExports.parse((t=s.sdp)!==null&&t!==void 0?t:"");o.media.forEach(a=>{a.type==="audio"?ensureAudioNackAndStereo(a,[],[]):a.type==="video"&&this.trackBitrates.some(c=>{if(!a.msid||!c.cid||!a.msid.includes(c.cid))return!1;let u=0;if(a.rtp.some(p=>p.codec.toUpperCase()===c.codec.toUpperCase()?(u=p.payload,!0):!1),u===0||(isSVCCodec(c.codec)&&ensureVideoDDExtensionForSVC(a),c.codec!=="av1"))return!0;const d=Math.round(c.maxbr*startBitrateForSVC);for(const p of a.fmtp)if(p.payload===u){p.config.includes("x-google-start-bitrate")||(p.config+=";x-google-start-bitrate=".concat(d));break}return!0})}),yield this.setMungedSDP(s,libExports.write(o)),this.onOffer(s)})}createAndSetAnswer(){return __awaiter$1(this,void 0,void 0,function*(){var e;const t=yield this.pc.createAnswer(),s=libExports.parse((e=t.sdp)!==null&&e!==void 0?e:"");return s.media.forEach(o=>{o.type==="audio"&&ensureAudioNackAndStereo(o,this.remoteStereoMids,this.remoteNackMids)}),yield this.setMungedSDP(t,libExports.write(s)),t})}createDataChannel(e,t){return this.pc.createDataChannel(e,t)}addTransceiver(e,t){return this.pc.addTransceiver(e,t)}addTrack(e){if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot add track");return this._pc.addTrack(e)}setTrackCodecBitrate(e){this.trackBitrates.push(e)}setConfiguration(e){var t;if(!this._pc)throw new UnexpectedConnectionState("PC closed, cannot configure");return(t=this._pc)===null||t===void 0?void 0:t.setConfiguration(e)}canRemoveTrack(){var e;return!!(!((e=this._pc)===null||e===void 0)&&e.removeTrack)}removeTrack(e){var t;return(t=this._pc)===null||t===void 0?void 0:t.removeTrack(e)}getConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.connectionState)!==null&&t!==void 0?t:"closed"}getICEConnectionState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.iceConnectionState)!==null&&t!==void 0?t:"closed"}getSignallingState(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.signalingState)!==null&&t!==void 0?t:"closed"}getTransceivers(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getTransceivers())!==null&&t!==void 0?t:[]}getSenders(){var e,t;return(t=(e=this._pc)===null||e===void 0?void 0:e.getSenders())!==null&&t!==void 0?t:[]}getLocalDescription(){var e;return(e=this._pc)===null||e===void 0?void 0:e.localDescription}getRemoteDescription(){var e;return(e=this.pc)===null||e===void 0?void 0:e.remoteDescription}getStats(){return this.pc.getStats()}getConnectedAddress(){return __awaiter$1(this,void 0,void 0,function*(){var e;if(!this._pc)return;let t="";const s=new Map,o=new Map;if((yield this._pc.getStats()).forEach(u=>{switch(u.type){case"transport":t=u.selectedCandidatePairId;break;case"candidate-pair":t===""&&u.selected&&(t=u.id),s.set(u.id,u);break;case"remote-candidate":o.set(u.id,"".concat(u.address,":").concat(u.port));break}}),t==="")return;const c=(e=s.get(t))===null||e===void 0?void 0:e.remoteCandidateId;if(c!==void 0)return o.get(c)})}setMungedSDP(e,t,s){return __awaiter$1(this,void 0,void 0,function*(){if(t){const o=e.sdp;e.sdp=t;try{this.log.debug("setting munged ".concat(s?"remote":"local"," description"),this.logContext),s?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e);return}catch(a){this.log.warn("not able to set ".concat(e.type,", falling back to unmodified sdp"),Object.assign(Object.assign({},this.logContext),{error:a,sdp:t})),e.sdp=o}}try{s?yield this.pc.setRemoteDescription(e):yield this.pc.setLocalDescription(e)}catch(o){let a="unknown error";o instanceof Error?a=o.message:typeof o=="string"&&(a=o);const c={error:a,sdp:e.sdp};throw!s&&this.pc.remoteDescription&&(c.remoteSdp=this.pc.remoteDescription),this.log.error("unable to set ".concat(e.type),Object.assign(Object.assign({},this.logContext),{fields:c})),new NegotiationError(a)}})}}function ensureAudioNackAndStereo(i,e,t){let s=0;i.rtp.some(o=>o.codec==="opus"?(s=o.payload,!0):!1),s>0&&(i.rtcpFb||(i.rtcpFb=[]),t.includes(i.mid)&&!i.rtcpFb.some(o=>o.payload===s&&o.type==="nack")&&i.rtcpFb.push({payload:s,type:"nack"}),e.includes(i.mid)&&i.fmtp.some(o=>o.payload===s?(o.config.includes("stereo=1")||(o.config+=";stereo=1"),!0):!1))}function ensureVideoDDExtensionForSVC(i){var e,t;let s=0;((e=i.ext)===null||e===void 0?void 0:e.some(a=>a.uri===ddExtensionURI?!0:(a.value>s&&(s=a.value),!1)))||(t=i.ext)===null||t===void 0||t.push({value:s+1,uri:ddExtensionURI})}function extractStereoAndNackAudioFromOffer(i){var e;const t=[],s=[],o=libExports.parse((e=i.sdp)!==null&&e!==void 0?e:"");let a=0;return o.media.forEach(c=>{var u;c.type==="audio"&&(c.rtp.some(d=>d.codec==="opus"?(a=d.payload,!0):!1),!((u=c.rtcpFb)===null||u===void 0)&&u.some(d=>d.payload===a&&d.type==="nack")&&s.push(c.mid),c.fmtp.some(d=>d.payload===a?(d.config.includes("sprop-stereo=1")&&t.push(c.mid),!0):!1))}),{stereoMids:t,nackMids:s}}const defaultVideoCodec="vp8",publishDefaults={audioPreset:AudioPresets.music,dtx:!0,red:!0,forceStereo:!1,simulcast:!0,screenShareEncoding:ScreenSharePresets.h1080fps15.encoding,stopMicTrackOnMute:!1,videoCodec:defaultVideoCodec,backupCodec:!0},audioDefaults={autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0},videoDefaults={resolution:VideoPresets.h720.resolution},roomOptionDefaults={adaptiveStream:!1,dynacast:!1,stopLocalTrackOnUnpublish:!0,reconnectPolicy:new DefaultReconnectPolicy,disconnectOnPageLeave:!0,webAudioMix:!1},roomConnectOptionDefaults={autoSubscribe:!0,maxRetries:1,peerConnectionTimeout:15e3,websocketTimeout:15e3};var PCTransportState;(function(i){i[i.NEW=0]="NEW",i[i.CONNECTING=1]="CONNECTING",i[i.CONNECTED=2]="CONNECTED",i[i.FAILED=3]="FAILED",i[i.CLOSING=4]="CLOSING",i[i.CLOSED=5]="CLOSED"})(PCTransportState||(PCTransportState={}));class PCTransportManager{get needsPublisher(){return this.isPublisherConnectionRequired}get needsSubscriber(){return this.isSubscriberConnectionRequired}get currentState(){return this.state}constructor(e,t,s){var o;this.peerConnectionTimeout=roomConnectOptionDefaults.peerConnectionTimeout,this.log=livekitLogger,this.updateState=()=>{var a;const c=this.state,u=this.requiredTransports.map(d=>d.getConnectionState());u.every(d=>d==="connected")?this.state=PCTransportState.CONNECTED:u.some(d=>d==="failed")?this.state=PCTransportState.FAILED:u.some(d=>d==="connecting")?this.state=PCTransportState.CONNECTING:u.every(d=>d==="closed")?this.state=PCTransportState.CLOSED:u.some(d=>d==="closed")?this.state=PCTransportState.CLOSING:u.every(d=>d==="new")&&(this.state=PCTransportState.NEW),c!==this.state&&(this.log.debug("pc state change: from ".concat(PCTransportState[c]," to ").concat(PCTransportState[this.state]),this.logContext),(a=this.onStateChange)===null||a===void 0||a.call(this,this.state,this.publisher.getConnectionState(),this.subscriber.getConnectionState()))},this.log=getLogger((o=s.loggerName)!==null&&o!==void 0?o:LoggerNames.PCManager),this.loggerOptions=s,this.isPublisherConnectionRequired=!t,this.isSubscriberConnectionRequired=t,this.publisher=new PCTransport(e,s),this.subscriber=new PCTransport(e,s),this.publisher.onConnectionStateChange=this.updateState,this.subscriber.onConnectionStateChange=this.updateState,this.publisher.onIceConnectionStateChange=this.updateState,this.subscriber.onIceConnectionStateChange=this.updateState,this.publisher.onSignalingStatechange=this.updateState,this.subscriber.onSignalingStatechange=this.updateState,this.publisher.onIceCandidate=a=>{var c;(c=this.onIceCandidate)===null||c===void 0||c.call(this,a,SignalTarget.PUBLISHER)},this.subscriber.onIceCandidate=a=>{var c;(c=this.onIceCandidate)===null||c===void 0||c.call(this,a,SignalTarget.SUBSCRIBER)},this.subscriber.onDataChannel=a=>{var c;(c=this.onDataChannel)===null||c===void 0||c.call(this,a)},this.subscriber.onTrack=a=>{var c;(c=this.onTrack)===null||c===void 0||c.call(this,a)},this.publisher.onOffer=a=>{var c;(c=this.onPublisherOffer)===null||c===void 0||c.call(this,a)},this.state=PCTransportState.NEW,this.connectionLock=new h,this.remoteOfferLock=new h}get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions).loggerContextCb)===null||t===void 0?void 0:t.call(e))}requirePublisher(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isPublisherConnectionRequired=e,this.updateState()}requireSubscriber(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;this.isSubscriberConnectionRequired=e,this.updateState()}createAndSendPublisherOffer(e){return this.publisher.createAndSendOffer(e)}setPublisherAnswer(e){return this.publisher.setRemoteDescription(e)}removeTrack(e){return this.publisher.removeTrack(e)}close(){return __awaiter$1(this,void 0,void 0,function*(){if(this.publisher&&this.publisher.getSignallingState()!=="closed"){const e=this.publisher;for(const t of e.getSenders())try{e.canRemoveTrack()&&e.removeTrack(t)}catch(s){this.log.warn("could not removeTrack",Object.assign(Object.assign({},this.logContext),{error:s}))}}yield Promise.all([this.publisher.close(),this.subscriber.close()]),this.updateState()})}triggerIceRestart(){return __awaiter$1(this,void 0,void 0,function*(){this.subscriber.restartingIce=!0,this.needsPublisher&&(yield this.createAndSendPublisherOffer({iceRestart:!0}))})}addIceCandidate(e,t){return __awaiter$1(this,void 0,void 0,function*(){t===SignalTarget.PUBLISHER?yield this.publisher.addIceCandidate(e):yield this.subscriber.addIceCandidate(e)})}createSubscriberAnswerFromOffer(e){return __awaiter$1(this,void 0,void 0,function*(){this.log.debug("received server offer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type,sdp:e.sdp,signalingState:this.subscriber.getSignallingState().toString()}));const t=yield this.remoteOfferLock.lock();try{return yield this.subscriber.setRemoteDescription(e),yield this.subscriber.createAndSetAnswer()}finally{t()}})}updateConfiguration(e,t){this.publisher.setConfiguration(e),this.subscriber.setConfiguration(e),t&&this.triggerIceRestart()}ensurePCTransportConnection(e,t){return __awaiter$1(this,void 0,void 0,function*(){var s;const o=yield this.connectionLock.lock();try{this.isPublisherConnectionRequired&&this.publisher.getConnectionState()!=="connected"&&this.publisher.getConnectionState()!=="connecting"&&(this.log.debug("negotiation required, start negotiating",this.logContext),this.publisher.negotiate()),yield Promise.all((s=this.requiredTransports)===null||s===void 0?void 0:s.map(a=>this.ensureTransportConnected(a,e,t)))}finally{o()}})}negotiate(e){return __awaiter$1(this,void 0,void 0,function*(){return new Promise((t,s)=>__awaiter$1(this,void 0,void 0,function*(){const o=setTimeout(()=>{s("negotiation timed out")},this.peerConnectionTimeout),a=()=>{clearTimeout(o),s("negotiation aborted")};e.signal.addEventListener("abort",a),this.publisher.once(PCEvents.NegotiationStarted,()=>{e.signal.aborted||this.publisher.once(PCEvents.NegotiationComplete,()=>{clearTimeout(o),t()})}),yield this.publisher.negotiate(c=>{clearTimeout(o),s(c)})}))})}addPublisherTransceiver(e,t){return this.publisher.addTransceiver(e,t)}addPublisherTrack(e){return this.publisher.addTrack(e)}createPublisherDataChannel(e,t){return this.publisher.createDataChannel(e,t)}getConnectedAddress(e){return e===SignalTarget.PUBLISHER?this.publisher.getConnectedAddress():e===SignalTarget.SUBSCRIBER?this.publisher.getConnectedAddress():this.requiredTransports[0].getConnectedAddress()}get requiredTransports(){const e=[];return this.isPublisherConnectionRequired&&e.push(this.publisher),this.isSubscriberConnectionRequired&&e.push(this.subscriber),e}ensureTransportConnected(e,t){return __awaiter$1(this,arguments,void 0,function(s,o){var a=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:this.peerConnectionTimeout;return function*(){if(s.getConnectionState()!=="connected")return new Promise((d,p)=>__awaiter$1(a,void 0,void 0,function*(){const v=()=>{this.log.warn("abort transport connection",this.logContext),CriticalTimers.clearTimeout(g),p(new ConnectionError("room connection has been cancelled",ConnectionErrorReason.Cancelled))};o!=null&&o.signal.aborted&&v(),o==null||o.signal.addEventListener("abort",v);const g=CriticalTimers.setTimeout(()=>{o==null||o.signal.removeEventListener("abort",v),p(new ConnectionError("could not establish pc connection"))},c);for(;this.state!==PCTransportState.CONNECTED;)if(yield sleep$1(50),o!=null&&o.signal.aborted){p(new ConnectionError("room connection has been cancelled",ConnectionErrorReason.Cancelled));return}CriticalTimers.clearTimeout(g),o==null||o.signal.removeEventListener("abort",v),d()}))}()})}}const monitorFrequency=2e3;function computeBitrate(i,e){if(!e)return 0;let t,s;return"bytesReceived"in i?(t=i.bytesReceived,s=e.bytesReceived):"bytesSent"in i&&(t=i.bytesSent,s=e.bytesSent),t===void 0||s===void 0||i.timestamp===void 0||e.timestamp===void 0?0:(t-s)*8*1e3/(i.timestamp-e.timestamp)}class LocalAudioTrack extends LocalTrack{get enhancedNoiseCancellation(){return this.isKrispNoiseFilterEnabled}constructor(e,t){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,o=arguments.length>3?arguments[3]:void 0,a=arguments.length>4?arguments[4]:void 0;super(e,Track.Kind.Audio,t,s,a),this.stopOnMute=!1,this.isKrispNoiseFilterEnabled=!1,this.monitorSender=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let c;try{c=yield this.getSenderStats()}catch(u){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:u}));return}c&&this.prevStats&&(this._currentBitrate=computeBitrate(c,this.prevStats)),this.prevStats=c}),this.handleKrispNoiseFilterEnable=()=>{this.isKrispNoiseFilterEnabled=!0,this.log.debug("Krisp noise filter enabled",this.logContext),this.emit(TrackEvent.AudioTrackFeatureUpdate,this,AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION,!0)},this.handleKrispNoiseFilterDisable=()=>{this.isKrispNoiseFilterEnabled=!1,this.log.debug("Krisp noise filter disabled",this.logContext),this.emit(TrackEvent.AudioTrackFeatureUpdate,this,AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION,!1)},this.audioContext=o,this.checkForSilence()}setDeviceId(e){return __awaiter$1(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===unwrapConstraint(e)?!0:(this._constraints.deviceId=e,this.isMuted||(yield this.restartTrack()),this.isMuted||unwrapConstraint(e)===this._mediaStreamTrack.getSettings().deviceId)})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter$1(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track.Source.Microphone&&this.stopOnMute&&!this.isUserProvided&&(this.log.debug("stopping mic track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter$1(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{if(!this.isMuted)return this.log.debug("Track already unmuted",this.logContext),this;const s=this._constraints.deviceId&&this._mediaStreamTrack.getSettings().deviceId!==unwrapConstraint(this._constraints.deviceId);return this.source===Track.Source.Microphone&&(this.stopOnMute||this._mediaStreamTrack.readyState==="ended"||s)&&!this.isUserProvided&&(this.log.debug("reacquiring mic track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this}finally{t()}})}restartTrack(e){return __awaiter$1(this,void 0,void 0,function*(){let t;if(e){const s=constraintsForOptions({audio:e});typeof s.audio!="boolean"&&(t=s.audio)}yield this.restart(t)})}restart(e){const t=Object.create(null,{restart:{get:()=>super.restart}});return __awaiter$1(this,void 0,void 0,function*(){const s=yield t.restart.call(this,e);return this.checkForSilence(),s})}startMonitor(){isWeb()&&(this.monitorInterval||(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency)))}setProcessor(e){return __awaiter$1(this,void 0,void 0,function*(){var t;const s=yield this.processorLock.lock();try{if(!this.audioContext)throw Error("Audio context needs to be set on LocalAudioTrack in order to enable processors");this.processor&&(yield this.stopProcessor());const o={kind:this.kind,track:this._mediaStreamTrack,audioContext:this.audioContext};this.log.debug("setting up audio processor ".concat(e.name),this.logContext),yield e.init(o),this.processor=e,this.processor.processedTrack&&(yield(t=this.sender)===null||t===void 0?void 0:t.replaceTrack(this.processor.processedTrack),this.processor.processedTrack.addEventListener("enable-lk-krisp-noise-filter",this.handleKrispNoiseFilterEnable),this.processor.processedTrack.addEventListener("disable-lk-krisp-noise-filter",this.handleKrispNoiseFilterDisable)),this.emit(TrackEvent.TrackProcessorUpdate,this.processor)}finally{s()}})}setAudioContext(e){this.audioContext=e}getSenderStats(){return __awaiter$1(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return;const t=yield this.sender.getStats();let s;return t.forEach(o=>{o.type==="outbound-rtp"&&(s={type:"audio",streamId:o.id,packetsSent:o.packetsSent,packetsLost:o.packetsLost,bytesSent:o.bytesSent,timestamp:o.timestamp,roundTripTime:o.roundTripTime,jitter:o.jitter})}),s})}checkForSilence(){return __awaiter$1(this,void 0,void 0,function*(){const e=yield detectSilence(this);return e&&(this.isMuted||this.log.warn("silence detected on local audio track",this.logContext),this.emit(TrackEvent.AudioSilenceDetected)),e})}}function mediaTrackToLocalTrack(i,e,t){switch(i.kind){case"audio":return new LocalAudioTrack(i,e,!1,void 0,t);case"video":return new LocalVideoTrack(i,e,!1,t);default:throw new TrackInvalidError("unsupported track type: ".concat(i.kind))}}const presets169=Object.values(VideoPresets),presets43=Object.values(VideoPresets43),presetsScreenShare=Object.values(ScreenSharePresets),defaultSimulcastPresets169=[VideoPresets.h180,VideoPresets.h360],defaultSimulcastPresets43=[VideoPresets43.h180,VideoPresets43.h360],computeDefaultScreenShareSimulcastPresets=i=>[{scaleResolutionDownBy:2,fps:i.encoding.maxFramerate}].map(t=>{var s,o;return new VideoPreset(Math.floor(i.width/t.scaleResolutionDownBy),Math.floor(i.height/t.scaleResolutionDownBy),Math.max(15e4,Math.floor(i.encoding.maxBitrate/(Math.pow(t.scaleResolutionDownBy,2)*(((s=i.encoding.maxFramerate)!==null&&s!==void 0?s:30)/((o=t.fps)!==null&&o!==void 0?o:30))))),t.fps,i.encoding.priority)}),videoRids=["q","h","f"];function computeVideoEncodings(i,e,t,s){var o,a;let c=s==null?void 0:s.videoEncoding;i&&(c=s==null?void 0:s.screenShareEncoding);const u=s==null?void 0:s.simulcast,d=s==null?void 0:s.scalabilityMode,p=s==null?void 0:s.videoCodec;if(!c&&!u&&!d||!e||!t)return[{}];c||(c=determineAppropriateEncoding(i,e,t,p),livekitLogger.debug("using video encoding",c));const v=new VideoPreset(e,t,c.maxBitrate,c.maxFramerate,c.priority);if(d&&isSVCCodec(p)){const S=new ScalabilityMode(d),y=[];if(S.spatial>3)throw new Error("unsupported scalabilityMode: ".concat(d));const C=getBrowser();if(isSafari()||isReactNative()||(C==null?void 0:C.name)==="Chrome"&&compareVersions(C==null?void 0:C.version,"113")<0){const R=S.suffix=="h"?2:3;for(let T=0;T<S.spatial;T+=1)y.push({rid:videoRids[2-T],maxBitrate:c.maxBitrate/Math.pow(R,T),maxFramerate:v.encoding.maxFramerate});y[0].scalabilityMode=d}else y.push({maxBitrate:c.maxBitrate,maxFramerate:v.encoding.maxFramerate,scalabilityMode:d});return v.encoding.priority&&(y[0].priority=v.encoding.priority,y[0].networkPriority=v.encoding.priority),livekitLogger.debug("using svc encoding",{encodings:y}),y}if(!u)return[c];let g=[];i?g=(o=sortPresets(s==null?void 0:s.screenShareSimulcastLayers))!==null&&o!==void 0?o:defaultSimulcastLayers(i,v):g=(a=sortPresets(s==null?void 0:s.videoSimulcastLayers))!==null&&a!==void 0?a:defaultSimulcastLayers(i,v);let m;if(g.length>0){const S=g[0];g.length>1&&([,m]=g);const y=Math.max(e,t);if(y>=960&&m)return encodingsFromPresets(e,t,[S,m,v]);if(y>=480)return encodingsFromPresets(e,t,[S,v])}return encodingsFromPresets(e,t,[v])}function computeTrackBackupEncodings(i,e,t){var s,o,a,c;if(!t.backupCodec||t.backupCodec===!0||t.backupCodec.codec===t.videoCodec)return;e!==t.backupCodec.codec&&livekitLogger.warn("requested a different codec than specified as backup",{serverRequested:e,backup:t.backupCodec.codec}),t.videoCodec=e,t.videoEncoding=t.backupCodec.encoding;const u=i.mediaStreamTrack.getSettings(),d=(s=u.width)!==null&&s!==void 0?s:(o=i.dimensions)===null||o===void 0?void 0:o.width,p=(a=u.height)!==null&&a!==void 0?a:(c=i.dimensions)===null||c===void 0?void 0:c.height;return computeVideoEncodings(i.source===Track.Source.ScreenShare,d,p,t)}function determineAppropriateEncoding(i,e,t,s){const o=presetsForResolution(i,e,t);let{encoding:a}=o[0];const c=Math.max(e,t);for(let u=0;u<o.length;u+=1){const d=o[u];if(a=d.encoding,d.width>=c)break}if(s)switch(s){case"av1":a=Object.assign({},a),a.maxBitrate=a.maxBitrate*.7;break;case"vp9":a=Object.assign({},a),a.maxBitrate=a.maxBitrate*.85;break}return a}function presetsForResolution(i,e,t){if(i)return presetsScreenShare;const s=e>t?e/t:t/e;return Math.abs(s-16/9)<Math.abs(s-4/3)?presets169:presets43}function defaultSimulcastLayers(i,e){if(i)return computeDefaultScreenShareSimulcastPresets(e);const{width:t,height:s}=e,o=t>s?t/s:s/t;return Math.abs(o-16/9)<Math.abs(o-4/3)?defaultSimulcastPresets169:defaultSimulcastPresets43}function encodingsFromPresets(i,e,t){const s=[];if(t.forEach((o,a)=>{if(a>=videoRids.length)return;const c=Math.min(i,e),d={rid:videoRids[a],scaleResolutionDownBy:Math.max(1,c/Math.min(o.width,o.height)),maxBitrate:o.encoding.maxBitrate};o.encoding.maxFramerate&&(d.maxFramerate=o.encoding.maxFramerate);const p=isFireFox()||a===0;o.encoding.priority&&p&&(d.priority=o.encoding.priority,d.networkPriority=o.encoding.priority),s.push(d)}),isReactNative()&&getReactNativeOs()==="ios"){let o;s.forEach(c=>{o?c.maxFramerate&&c.maxFramerate>o&&(o=c.maxFramerate):o=c.maxFramerate});let a=!0;s.forEach(c=>{var u;c.maxFramerate!=o&&(a&&(a=!1,livekitLogger.info("Simulcast on iOS React-Native requires all encodings to share the same framerate.")),livekitLogger.info('Setting framerate of encoding "'.concat((u=c.rid)!==null&&u!==void 0?u:"",'" to ').concat(o)),c.maxFramerate=o)})}return s}function sortPresets(i){if(i)return i.sort((e,t)=>{const{encoding:s}=e,{encoding:o}=t;return s.maxBitrate>o.maxBitrate?1:s.maxBitrate<o.maxBitrate?-1:s.maxBitrate===o.maxBitrate&&s.maxFramerate&&o.maxFramerate?s.maxFramerate>o.maxFramerate?1:-1:0})}class ScalabilityMode{constructor(e){const t=e.match(/^L(\d)T(\d)(h|_KEY|_KEY_SHIFT){0,1}$/);if(!t)throw new Error("invalid scalability mode");if(this.spatial=parseInt(t[1]),this.temporal=parseInt(t[2]),t.length>3)switch(t[3]){case"h":case"_KEY":case"_KEY_SHIFT":this.suffix=t[3]}}toString(){var e;return"L".concat(this.spatial,"T").concat(this.temporal).concat((e=this.suffix)!==null&&e!==void 0?e:"")}}function getDefaultDegradationPreference(i){return i.source===Track.Source.ScreenShare||i.constraints.height&&unwrapConstraint(i.constraints.height)>=1080?"maintain-resolution":"balanced"}const refreshSubscribedCodecAfterNewCodec=5e3;class LocalVideoTrack extends LocalTrack{get sender(){return this._sender}set sender(e){this._sender=e,this.degradationPreference&&this.setDegradationPreference(this.degradationPreference)}constructor(e,t){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!0,o=arguments.length>3?arguments[3]:void 0;super(e,Track.Kind.Video,t,s,o),this.simulcastCodecs=new Map,this.degradationPreference="balanced",this.monitorSender=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.sender){this._currentBitrate=0;return}let a;try{a=yield this.getSenderStats()}catch(u){this.log.error("could not get audio sender stats",Object.assign(Object.assign({},this.logContext),{error:u}));return}const c=new Map(a.map(u=>[u.rid,u]));if(this.prevStats){let u=0;c.forEach((d,p)=>{var v;const g=(v=this.prevStats)===null||v===void 0?void 0:v.get(p);u+=computeBitrate(d,g)}),this._currentBitrate=u}this.prevStats=c}),this.senderLock=new h}get isSimulcast(){return!!(this.sender&&this.sender.getParameters().encodings.length>1)}startMonitor(e){var t;if(this.signalClient=e,!isWeb())return;const s=(t=this.sender)===null||t===void 0?void 0:t.getParameters();s&&(this.encodings=s.encodings),!this.monitorInterval&&(this.monitorInterval=setInterval(()=>{this.monitorSender()},monitorFrequency))}stop(){this._mediaStreamTrack.getConstraints(),this.simulcastCodecs.forEach(e=>{e.mediaStreamTrack.stop()}),super.stop()}pauseUpstream(){const e=Object.create(null,{pauseUpstream:{get:()=>super.pauseUpstream}});return __awaiter$1(this,void 0,void 0,function*(){var t,s,o,a,c;yield e.pauseUpstream.call(this);try{for(var u=!0,d=__asyncValues(this.simulcastCodecs.values()),p;p=yield d.next(),t=p.done,!t;u=!0)a=p.value,u=!1,yield(c=a.sender)===null||c===void 0?void 0:c.replaceTrack(null)}catch(v){s={error:v}}finally{try{!u&&!t&&(o=d.return)&&(yield o.call(d))}finally{if(s)throw s.error}}})}resumeUpstream(){const e=Object.create(null,{resumeUpstream:{get:()=>super.resumeUpstream}});return __awaiter$1(this,void 0,void 0,function*(){var t,s,o,a,c;yield e.resumeUpstream.call(this);try{for(var u=!0,d=__asyncValues(this.simulcastCodecs.values()),p;p=yield d.next(),t=p.done,!t;u=!0){a=p.value,u=!1;const v=a;yield(c=v.sender)===null||c===void 0?void 0:c.replaceTrack(v.mediaStreamTrack)}}catch(v){s={error:v}}finally{try{!u&&!t&&(o=d.return)&&(yield o.call(d))}finally{if(s)throw s.error}}})}mute(){const e=Object.create(null,{mute:{get:()=>super.mute}});return __awaiter$1(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.log.debug("Track already muted",this.logContext),this):(this.source===Track.Source.Camera&&!this.isUserProvided&&(this.log.debug("stopping camera track",this.logContext),this._mediaStreamTrack.stop()),yield e.mute.call(this),this)}finally{t()}})}unmute(){const e=Object.create(null,{unmute:{get:()=>super.unmute}});return __awaiter$1(this,void 0,void 0,function*(){const t=yield this.muteLock.lock();try{return this.isMuted?(this.source===Track.Source.Camera&&!this.isUserProvided&&(this.log.debug("reacquiring camera track",this.logContext),yield this.restartTrack()),yield e.unmute.call(this),this):(this.log.debug("Track already unmuted",this.logContext),this)}finally{t()}})}setTrackMuted(e){super.setTrackMuted(e);for(const t of this.simulcastCodecs.values())t.mediaStreamTrack.enabled=!e}getSenderStats(){return __awaiter$1(this,void 0,void 0,function*(){var e;if(!(!((e=this.sender)===null||e===void 0)&&e.getStats))return[];const t=[],s=yield this.sender.getStats();return s.forEach(o=>{var a;if(o.type==="outbound-rtp"){const c={type:"video",streamId:o.id,frameHeight:o.frameHeight,frameWidth:o.frameWidth,framesPerSecond:o.framesPerSecond,framesSent:o.framesSent,firCount:o.firCount,pliCount:o.pliCount,nackCount:o.nackCount,packetsSent:o.packetsSent,bytesSent:o.bytesSent,qualityLimitationReason:o.qualityLimitationReason,qualityLimitationDurations:o.qualityLimitationDurations,qualityLimitationResolutionChanges:o.qualityLimitationResolutionChanges,rid:(a=o.rid)!==null&&a!==void 0?a:o.id,retransmittedPacketsSent:o.retransmittedPacketsSent,targetBitrate:o.targetBitrate,timestamp:o.timestamp},u=s.get(o.remoteId);u&&(c.jitter=u.jitter,c.packetsLost=u.packetsLost,c.roundTripTime=u.roundTripTime),t.push(c)}}),t.sort((o,a)=>{var c,u;return((c=a.frameWidth)!==null&&c!==void 0?c:0)-((u=o.frameWidth)!==null&&u!==void 0?u:0)}),t})}setPublishingQuality(e){const t=[];for(let s=VideoQuality.LOW;s<=VideoQuality.HIGH;s+=1)t.push(new SubscribedQuality({quality:s,enabled:s<=e}));this.log.debug("setting publishing quality. max quality ".concat(e),this.logContext),this.setPublishingLayers(t)}setDeviceId(e){return __awaiter$1(this,void 0,void 0,function*(){return this._constraints.deviceId===e&&this._mediaStreamTrack.getSettings().deviceId===unwrapConstraint(e)?!0:(this._constraints.deviceId=e,this.isMuted||(yield this.restartTrack()),this.isMuted||unwrapConstraint(e)===this._mediaStreamTrack.getSettings().deviceId)})}restartTrack(e){return __awaiter$1(this,void 0,void 0,function*(){var t,s,o,a;let c;if(e){const v=constraintsForOptions({video:e});typeof v.video!="boolean"&&(c=v.video)}yield this.restart(c);try{for(var u=!0,d=__asyncValues(this.simulcastCodecs.values()),p;p=yield d.next(),t=p.done,!t;u=!0){a=p.value,u=!1;const v=a;v.sender&&(v.mediaStreamTrack=this.mediaStreamTrack.clone(),yield v.sender.replaceTrack(v.mediaStreamTrack))}}catch(v){s={error:v}}finally{try{!u&&!t&&(o=d.return)&&(yield o.call(d))}finally{if(s)throw s.error}}})}setProcessor(e){const t=Object.create(null,{setProcessor:{get:()=>super.setProcessor}});return __awaiter$1(this,arguments,void 0,function(s){var o=this;let a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){var c,u,d,p,v,g;if(yield t.setProcessor.call(o,s,a),!((v=o.processor)===null||v===void 0)&&v.processedTrack)try{for(var m=!0,S=__asyncValues(o.simulcastCodecs.values()),y;y=yield S.next(),c=y.done,!c;m=!0)p=y.value,m=!1,yield(g=p.sender)===null||g===void 0?void 0:g.replaceTrack(o.processor.processedTrack)}catch(C){u={error:C}}finally{try{!m&&!c&&(d=S.return)&&(yield d.call(S))}finally{if(u)throw u.error}}}()})}setDegradationPreference(e){return __awaiter$1(this,void 0,void 0,function*(){if(this.degradationPreference=e,this.sender)try{this.log.debug("setting degradationPreference to ".concat(e),this.logContext);const t=this.sender.getParameters();t.degradationPreference=e,this.sender.setParameters(t)}catch(t){this.log.warn("failed to set degradationPreference",Object.assign({error:t},this.logContext))}})}addSimulcastTrack(e,t){if(this.simulcastCodecs.has(e)){this.log.error("".concat(e," already added, skipping adding simulcast codec"),this.logContext);return}const s={codec:e,mediaStreamTrack:this.mediaStreamTrack.clone(),sender:void 0,encodings:t};return this.simulcastCodecs.set(e,s),s}setSimulcastTrackSender(e,t){const s=this.simulcastCodecs.get(e);s&&(s.sender=t,setTimeout(()=>{this.subscribedCodecs&&this.setPublishingCodecs(this.subscribedCodecs)},refreshSubscribedCodecAfterNewCodec))}setPublishingCodecs(e){return __awaiter$1(this,void 0,void 0,function*(){var t,s,o,a,c,u,d;if(this.log.debug("setting publishing codecs",Object.assign(Object.assign({},this.logContext),{codecs:e,currentCodec:this.codec})),!this.codec&&e.length>0)return yield this.setPublishingLayers(e[0].qualities),[];this.subscribedCodecs=e;const p=[];try{for(t=!0,s=__asyncValues(e);o=yield s.next(),a=o.done,!a;t=!0){d=o.value,t=!1;const v=d;if(!this.codec||this.codec===v.codec)yield this.setPublishingLayers(v.qualities);else{const g=this.simulcastCodecs.get(v.codec);if(this.log.debug("try setPublishingCodec for ".concat(v.codec),Object.assign(Object.assign({},this.logContext),{simulcastCodecInfo:g})),!g||!g.sender){for(const m of v.qualities)if(m.enabled){p.push(v.codec);break}}else g.encodings&&(this.log.debug("try setPublishingLayersForSender ".concat(v.codec),this.logContext),yield setPublishingLayersForSender(g.sender,g.encodings,v.qualities,this.senderLock,this.log,this.logContext))}}}catch(v){c={error:v}}finally{try{!t&&!a&&(u=s.return)&&(yield u.call(s))}finally{if(c)throw c.error}}return p})}setPublishingLayers(e){return __awaiter$1(this,void 0,void 0,function*(){this.log.debug("setting publishing layers",Object.assign(Object.assign({},this.logContext),{qualities:e})),!(!this.sender||!this.encodings)&&(yield setPublishingLayersForSender(this.sender,this.encodings,e,this.senderLock,this.log,this.logContext))})}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$1(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),isMobile()&&this.isInBackground&&this.source===Track.Source.Camera&&(this._mediaStreamTrack.enabled=!1)})}}function setPublishingLayersForSender(i,e,t,s,o,a){return __awaiter$1(this,void 0,void 0,function*(){const c=yield s.lock();o.debug("setPublishingLayersForSender",Object.assign(Object.assign({},a),{sender:i,qualities:t,senderEncodings:e}));try{const u=i.getParameters(),{encodings:d}=u;if(!d)return;if(d.length!==e.length){o.warn("cannot set publishing layers, encodings mismatch",Object.assign(Object.assign({},a),{encodings:d,senderEncodings:e}));return}let p=!1;!1&&d[0].scalabilityMode||d.forEach((g,m)=>{var S;let y=(S=g.rid)!==null&&S!==void 0?S:"";y===""&&(y="q");const C=videoQualityForRid(y),R=t.find(T=>T.quality===C);R&&g.active!==R.enabled&&(p=!0,g.active=R.enabled,o.debug("setting layer ".concat(R.quality," to ").concat(g.active?"enabled":"disabled"),a),isFireFox()&&(R.enabled?(g.scaleResolutionDownBy=e[m].scaleResolutionDownBy,g.maxBitrate=e[m].maxBitrate,g.maxFrameRate=e[m].maxFrameRate):(g.scaleResolutionDownBy=4,g.maxBitrate=10,g.maxFrameRate=2)))}),p&&(u.encodings=d,o.debug("setting encodings",Object.assign(Object.assign({},a),{encodings:u.encodings})),yield i.setParameters(u))}finally{c()}})}function videoQualityForRid(i){switch(i){case"f":return VideoQuality.HIGH;case"h":return VideoQuality.MEDIUM;case"q":return VideoQuality.LOW;default:return VideoQuality.HIGH}}function videoLayersFromEncodings(i,e,t,s){if(!t)return[new VideoLayer({quality:VideoQuality.HIGH,width:i,height:e,bitrate:0,ssrc:0})];if(s){const o=t[0].scalabilityMode,a=new ScalabilityMode(o),c=[],u=a.suffix=="h"?1.5:2,d=a.suffix=="h"?2:3;for(let p=0;p<a.spatial;p+=1)c.push(new VideoLayer({quality:Math.min(VideoQuality.HIGH,a.spatial-1)-p,width:Math.ceil(i/Math.pow(u,p)),height:Math.ceil(e/Math.pow(u,p)),bitrate:t[0].maxBitrate?Math.ceil(t[0].maxBitrate/Math.pow(d,p)):0,ssrc:0}));return c}return t.map(o=>{var a,c,u;const d=(a=o.scaleResolutionDownBy)!==null&&a!==void 0?a:1;let p=videoQualityForRid((c=o.rid)!==null&&c!==void 0?c:"");return new VideoLayer({quality:p,width:Math.ceil(i/d),height:Math.ceil(e/d),bitrate:(u=o.maxBitrate)!==null&&u!==void 0?u:0,ssrc:0})})}const lossyDataChannel="_lossy",reliableDataChannel="_reliable",minReconnectWait=2*1e3,leaveReconnect="leave-reconnect";var PCState;(function(i){i[i.New=0]="New",i[i.Connected=1]="Connected",i[i.Disconnected=2]="Disconnected",i[i.Reconnecting=3]="Reconnecting",i[i.Closed=4]="Closed"})(PCState||(PCState={}));class RTCEngine extends eventsExports.EventEmitter{get isClosed(){return this._isClosed}get pendingReconnect(){return!!this.reconnectTimeout}constructor(e){var t;super(),this.options=e,this.rtcConfig={},this.peerConnectionTimeout=roomConnectOptionDefaults.peerConnectionTimeout,this.fullReconnectOnNext=!1,this.subscriberPrimary=!1,this.pcState=PCState.New,this._isClosed=!0,this.pendingTrackResolvers={},this.reconnectAttempts=0,this.reconnectStart=0,this.attemptingReconnect=!1,this.joinAttempts=0,this.maxJoinAttempts=1,this.shouldFailNext=!1,this.log=livekitLogger,this.handleDataChannel=s=>__awaiter$1(this,[s],void 0,function(o){var a=this;let{channel:c}=o;return function*(){if(c){if(c.label===reliableDataChannel)a.reliableDCSub=c;else if(c.label===lossyDataChannel)a.lossyDCSub=c;else return;a.log.debug("on data channel ".concat(c.id,", ").concat(c.label),a.logContext),c.onmessage=a.handleDataMessage}}()}),this.handleDataMessage=s=>__awaiter$1(this,void 0,void 0,function*(){var o,a;const c=yield this.dataProcessLock.lock();try{let u;if(s.data instanceof ArrayBuffer)u=s.data;else if(s.data instanceof Blob)u=yield s.data.arrayBuffer();else{this.log.error("unsupported data type",Object.assign(Object.assign({},this.logContext),{data:s.data}));return}const d=DataPacket.fromBinary(new Uint8Array(u));((o=d.value)===null||o===void 0?void 0:o.case)==="speaker"?this.emit(EngineEvent.ActiveSpeakersUpdate,d.value.value.speakers):(((a=d.value)===null||a===void 0?void 0:a.case)==="user"&&applyUserDataCompat(d,d.value.value),this.emit(EngineEvent.DataPacketReceived,d))}finally{c()}}),this.handleDataError=s=>{const a=s.currentTarget.maxRetransmits===0?"lossy":"reliable";if(s instanceof ErrorEvent&&s.error){const{error:c}=s.error;this.log.error("DataChannel error on ".concat(a,": ").concat(s.message),Object.assign(Object.assign({},this.logContext),{error:c}))}else this.log.error("Unknown DataChannel error on ".concat(a),Object.assign(Object.assign({},this.logContext),{event:s}))},this.handleBufferedAmountLow=s=>{const a=s.currentTarget.maxRetransmits===0?DataPacket_Kind.LOSSY:DataPacket_Kind.RELIABLE;this.updateAndEmitDCBufferStatus(a)},this.handleDisconnect=(s,o)=>{if(this._isClosed)return;this.log.warn("".concat(s," disconnected"),this.logContext),this.reconnectAttempts===0&&(this.reconnectStart=Date.now());const a=d=>{this.log.warn("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(d,"ms. giving up"),this.logContext),this.emit(EngineEvent.Disconnected),this.close()},c=Date.now()-this.reconnectStart;let u=this.getNextRetryDelay({elapsedMs:c,retryCount:this.reconnectAttempts});if(u===null){a(c);return}s===leaveReconnect&&(u=0),this.log.debug("reconnecting in ".concat(u,"ms"),this.logContext),this.clearReconnectTimeout(),this.token&&this.regionUrlProvider&&this.regionUrlProvider.updateToken(this.token),this.reconnectTimeout=CriticalTimers.setTimeout(()=>this.attemptReconnect(o).finally(()=>this.reconnectTimeout=void 0),u)},this.waitForRestarted=()=>new Promise((s,o)=>{this.pcState===PCState.Connected&&s();const a=()=>{this.off(EngineEvent.Disconnected,c),s()},c=()=>{this.off(EngineEvent.Restarted,a),o()};this.once(EngineEvent.Restarted,a),this.once(EngineEvent.Disconnected,c)}),this.updateAndEmitDCBufferStatus=s=>{const o=this.isBufferStatusLow(s);typeof o<"u"&&o!==this.dcBufferStatus.get(s)&&(this.dcBufferStatus.set(s,o),this.emit(EngineEvent.DCBufferStatusChanged,o,s))},this.isBufferStatusLow=s=>{const o=this.dataChannelForKind(s);if(o)return o.bufferedAmount<=o.bufferedAmountLowThreshold},this.handleBrowserOnLine=()=>{this.client.currentState===SignalConnectionState.RECONNECTING&&(this.clearReconnectTimeout(),this.attemptReconnect(ReconnectReason.RR_SIGNAL_DISCONNECTED))},this.log=getLogger((t=e.loggerName)!==null&&t!==void 0?t:LoggerNames.Engine),this.loggerOptions={loggerName:e.loggerName,loggerContextCb:()=>this.logContext},this.client=new SignalClient(void 0,this.loggerOptions),this.client.signalLatency=this.options.expSignalLatency,this.reconnectPolicy=this.options.reconnectPolicy,this.registerOnLineListener(),this.closingLock=new h,this.dataProcessLock=new h,this.dcBufferStatus=new Map([[DataPacket_Kind.LOSSY,!0],[DataPacket_Kind.RELIABLE,!0]]),this.client.onParticipantUpdate=s=>this.emit(EngineEvent.ParticipantUpdate,s),this.client.onConnectionQuality=s=>this.emit(EngineEvent.ConnectionQualityUpdate,s),this.client.onRoomUpdate=s=>this.emit(EngineEvent.RoomUpdate,s),this.client.onSubscriptionError=s=>this.emit(EngineEvent.SubscriptionError,s),this.client.onSubscriptionPermissionUpdate=s=>this.emit(EngineEvent.SubscriptionPermissionUpdate,s),this.client.onSpeakersChanged=s=>this.emit(EngineEvent.SpeakersChanged,s),this.client.onStreamStateUpdate=s=>this.emit(EngineEvent.StreamStateChanged,s),this.client.onRequestResponse=s=>this.emit(EngineEvent.SignalRequestResponse,s)}get logContext(){var e,t,s,o,a,c,u,d;return{room:(t=(e=this.latestJoinResponse)===null||e===void 0?void 0:e.room)===null||t===void 0?void 0:t.name,roomID:(o=(s=this.latestJoinResponse)===null||s===void 0?void 0:s.room)===null||o===void 0?void 0:o.sid,participant:(c=(a=this.latestJoinResponse)===null||a===void 0?void 0:a.participant)===null||c===void 0?void 0:c.identity,pID:(d=(u=this.latestJoinResponse)===null||u===void 0?void 0:u.participant)===null||d===void 0?void 0:d.sid}}join(e,t,s,o){return __awaiter$1(this,void 0,void 0,function*(){this.url=e,this.token=t,this.signalOpts=s,this.maxJoinAttempts=s.maxRetries;try{this.joinAttempts+=1,this.setupSignalClientCallbacks();const a=yield this.client.join(e,t,s,o);return this._isClosed=!1,this.latestJoinResponse=a,this.subscriberPrimary=a.subscriberPrimary,this.pcManager||(yield this.configure(a)),(!this.subscriberPrimary||a.fastPublish)&&this.negotiate(),this.clientConfiguration=a.clientConfiguration,a}catch(a){if(a instanceof ConnectionError&&a.reason===ConnectionErrorReason.ServerUnreachable&&(this.log.warn("Couldn't connect to server, attempt ".concat(this.joinAttempts," of ").concat(this.maxJoinAttempts),this.logContext),this.joinAttempts<this.maxJoinAttempts))return this.join(e,t,s,o);throw a}})}close(){return __awaiter$1(this,void 0,void 0,function*(){const e=yield this.closingLock.lock();if(this.isClosed){e();return}try{this._isClosed=!0,this.joinAttempts=0,this.emit(EngineEvent.Closing),this.removeAllListeners(),this.deregisterOnLineListener(),this.clearPendingReconnect(),yield this.cleanupPeerConnections(),yield this.cleanupClient()}finally{e()}})}cleanupPeerConnections(){return __awaiter$1(this,void 0,void 0,function*(){var e;yield(e=this.pcManager)===null||e===void 0?void 0:e.close(),this.pcManager=void 0;const t=s=>{s&&(s.close(),s.onbufferedamountlow=null,s.onclose=null,s.onclosing=null,s.onerror=null,s.onmessage=null,s.onopen=null)};t(this.lossyDC),t(this.lossyDCSub),t(this.reliableDC),t(this.reliableDCSub),this.lossyDC=void 0,this.lossyDCSub=void 0,this.reliableDC=void 0,this.reliableDCSub=void 0})}cleanupClient(){return __awaiter$1(this,void 0,void 0,function*(){yield this.client.close(),this.client.resetCallbacks()})}addTrack(e){if(this.pendingTrackResolvers[e.cid])throw new TrackInvalidError("a track with the same ID has already been published");return new Promise((t,s)=>{const o=setTimeout(()=>{delete this.pendingTrackResolvers[e.cid],s(new ConnectionError("publication of local track timed out, no response from server"))},1e4);this.pendingTrackResolvers[e.cid]={resolve:a=>{clearTimeout(o),t(a)},reject:()=>{clearTimeout(o),s(new Error("Cancelled publication by calling unpublish"))}},this.client.sendAddTrack(e)})}removeTrack(e){if(e.track&&this.pendingTrackResolvers[e.track.id]){const{reject:t}=this.pendingTrackResolvers[e.track.id];t&&t(),delete this.pendingTrackResolvers[e.track.id]}try{return this.pcManager.removeTrack(e),!0}catch(t){this.log.warn("failed to remove track",Object.assign(Object.assign({},this.logContext),{error:t}))}return!1}updateMuteStatus(e,t){this.client.sendMuteTrack(e,t)}get dataSubscriberReadyState(){var e;return(e=this.reliableDCSub)===null||e===void 0?void 0:e.readyState}getConnectedServerAddress(){return __awaiter$1(this,void 0,void 0,function*(){var e;return(e=this.pcManager)===null||e===void 0?void 0:e.getConnectedAddress()})}setRegionUrlProvider(e){this.regionUrlProvider=e}configure(e){return __awaiter$1(this,void 0,void 0,function*(){var t,s;if(this.pcManager&&this.pcManager.currentState!==PCTransportState.NEW)return;this.participantSid=(t=e.participant)===null||t===void 0?void 0:t.sid;const o=this.makeRTCConfiguration(e);this.pcManager=new PCTransportManager(o,e.subscriberPrimary,this.loggerOptions),this.emit(EngineEvent.TransportsCreated,this.pcManager.publisher,this.pcManager.subscriber),this.pcManager.onIceCandidate=(a,c)=>{this.client.sendIceCandidate(a,c)},this.pcManager.onPublisherOffer=a=>{this.client.sendOffer(a)},this.pcManager.onDataChannel=this.handleDataChannel,this.pcManager.onStateChange=(a,c,u)=>__awaiter$1(this,void 0,void 0,function*(){if(this.log.debug("primary PC state changed ".concat(a),this.logContext),["closed","disconnected","failed"].includes(c)&&(this.publisherConnectionPromise=void 0),a===PCTransportState.CONNECTED){const v=this.pcState===PCState.New;this.pcState=PCState.Connected,v&&this.emit(EngineEvent.Connected,e)}else a===PCTransportState.FAILED&&this.pcState===PCState.Connected&&(this.pcState=PCState.Disconnected,this.handleDisconnect("peerconnection failed",u==="failed"?ReconnectReason.RR_SUBSCRIBER_FAILED:ReconnectReason.RR_PUBLISHER_FAILED));const d=this.client.isDisconnected||this.client.currentState===SignalConnectionState.RECONNECTING,p=[PCTransportState.FAILED,PCTransportState.CLOSING,PCTransportState.CLOSED].includes(a);d&&p&&!this._isClosed&&this.emit(EngineEvent.Offline)}),this.pcManager.onTrack=a=>{this.emit(EngineEvent.MediaTrackAdded,a.track,a.streams[0],a.receiver)},supportOptionalDatachannel((s=e.serverInfo)===null||s===void 0?void 0:s.protocol)||this.createDataChannels()})}setupSignalClientCallbacks(){this.client.onAnswer=e=>__awaiter$1(this,void 0,void 0,function*(){this.pcManager&&(this.log.debug("received server answer",Object.assign(Object.assign({},this.logContext),{RTCSdpType:e.type})),yield this.pcManager.setPublisherAnswer(e))}),this.client.onTrickle=(e,t)=>{this.pcManager&&(this.log.trace("got ICE candidate from peer",Object.assign(Object.assign({},this.logContext),{candidate:e,target:t})),this.pcManager.addIceCandidate(e,t))},this.client.onOffer=e=>__awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)return;const t=yield this.pcManager.createSubscriberAnswerFromOffer(e);this.client.sendAnswer(t)}),this.client.onLocalTrackPublished=e=>{var t;if(this.log.debug("received trackPublishedResponse",Object.assign(Object.assign({},this.logContext),{cid:e.cid,track:(t=e.track)===null||t===void 0?void 0:t.sid})),!this.pendingTrackResolvers[e.cid]){this.log.error("missing track resolver for ".concat(e.cid),Object.assign(Object.assign({},this.logContext),{cid:e.cid}));return}const{resolve:s}=this.pendingTrackResolvers[e.cid];delete this.pendingTrackResolvers[e.cid],s(e.track)},this.client.onLocalTrackUnpublished=e=>{this.emit(EngineEvent.LocalTrackUnpublished,e)},this.client.onLocalTrackSubscribed=e=>{this.emit(EngineEvent.LocalTrackSubscribed,e)},this.client.onTokenRefresh=e=>{this.token=e},this.client.onRemoteMuteChanged=(e,t)=>{this.emit(EngineEvent.RemoteMute,e,t)},this.client.onSubscribedQualityUpdate=e=>{this.emit(EngineEvent.SubscribedQualityUpdate,e)},this.client.onClose=()=>{this.handleDisconnect("signal",ReconnectReason.RR_SIGNAL_DISCONNECTED)},this.client.onLeave=e=>{switch(this.log.debug("client leave request",Object.assign(Object.assign({},this.logContext),{reason:e==null?void 0:e.reason})),e.regions&&this.regionUrlProvider&&(this.log.debug("updating regions",this.logContext),this.regionUrlProvider.setServerReportedRegions(e.regions)),e.action){case LeaveRequest_Action.DISCONNECT:this.emit(EngineEvent.Disconnected,e==null?void 0:e.reason),this.close();break;case LeaveRequest_Action.RECONNECT:this.fullReconnectOnNext=!0,this.handleDisconnect(leaveReconnect);break;case LeaveRequest_Action.RESUME:this.handleDisconnect(leaveReconnect)}}}makeRTCConfiguration(e){var t;const s=Object.assign({},this.rtcConfig);if(!((t=this.signalOpts)===null||t===void 0)&&t.e2eeEnabled&&(this.log.debug("E2EE - setting up transports with insertable streams",this.logContext),s.encodedInsertableStreams=!0),e.iceServers&&!s.iceServers){const o=[];e.iceServers.forEach(a=>{const c={urls:a.urls};a.username&&(c.username=a.username),a.credential&&(c.credential=a.credential),o.push(c)}),s.iceServers=o}return e.clientConfiguration&&e.clientConfiguration.forceRelay===ClientConfigSetting.ENABLED&&(s.iceTransportPolicy="relay"),s.sdpSemantics="unified-plan",s.continualGatheringPolicy="gather_continually",s}createDataChannels(){this.pcManager&&(this.lossyDC&&(this.lossyDC.onmessage=null,this.lossyDC.onerror=null),this.reliableDC&&(this.reliableDC.onmessage=null,this.reliableDC.onerror=null),this.lossyDC=this.pcManager.createPublisherDataChannel(lossyDataChannel,{ordered:!0,maxRetransmits:0}),this.reliableDC=this.pcManager.createPublisherDataChannel(reliableDataChannel,{ordered:!0}),this.lossyDC.onmessage=this.handleDataMessage,this.reliableDC.onmessage=this.handleDataMessage,this.lossyDC.onerror=this.handleDataError,this.reliableDC.onerror=this.handleDataError,this.lossyDC.bufferedAmountLowThreshold=65535,this.reliableDC.bufferedAmountLowThreshold=65535,this.lossyDC.onbufferedamountlow=this.handleBufferedAmountLow,this.reliableDC.onbufferedamountlow=this.handleBufferedAmountLow)}createSender(e,t,s){return __awaiter$1(this,void 0,void 0,function*(){if(supportsTransceiver())return yield this.createTransceiverRTCRtpSender(e,t,s);if(supportsAddTrack())return this.log.warn("using add-track fallback",this.logContext),yield this.createRTCRtpSender(e.mediaStreamTrack);throw new UnexpectedConnectionState("Required webRTC APIs not supported on this device")})}createSimulcastSender(e,t,s,o){return __awaiter$1(this,void 0,void 0,function*(){if(supportsTransceiver())return this.createSimulcastTransceiverSender(e,t,s,o);if(supportsAddTrack())return this.log.debug("using add-track fallback",this.logContext),this.createRTCRtpSender(e.mediaStreamTrack);throw new UnexpectedConnectionState("Cannot stream on this device")})}createTransceiverRTCRtpSender(e,t,s){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const o=[];e.mediaStream&&o.push(e.mediaStream),e instanceof LocalVideoTrack&&(e.codec=t.videoCodec);const a={direction:"sendonly",streams:o};return s&&(a.sendEncodings=s),(yield this.pcManager.addPublisherTransceiver(e.mediaStreamTrack,a)).sender})}createSimulcastTransceiverSender(e,t,s,o){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");const a={direction:"sendonly"};o&&(a.sendEncodings=o);const c=yield this.pcManager.addPublisherTransceiver(t.mediaStreamTrack,a);if(s.videoCodec)return e.setSimulcastTrackSender(s.videoCodec,c.sender),c.sender})}createRTCRtpSender(e){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("publisher is closed");return this.pcManager.addPublisherTrack(e)})}attemptReconnect(e){return __awaiter$1(this,void 0,void 0,function*(){var t,s,o;if(!this._isClosed){if(this.attemptingReconnect){livekitLogger.warn("already attempting reconnect, returning early",this.logContext);return}(((t=this.clientConfiguration)===null||t===void 0?void 0:t.resumeConnection)===ClientConfigSetting.DISABLED||((o=(s=this.pcManager)===null||s===void 0?void 0:s.currentState)!==null&&o!==void 0?o:PCTransportState.NEW)===PCTransportState.NEW)&&(this.fullReconnectOnNext=!0);try{this.attemptingReconnect=!0,this.fullReconnectOnNext?yield this.restartConnection():yield this.resumeConnection(e),this.clearPendingReconnect(),this.fullReconnectOnNext=!1}catch(a){this.reconnectAttempts+=1;let c=!0;a instanceof UnexpectedConnectionState?(this.log.debug("received unrecoverable error",Object.assign(Object.assign({},this.logContext),{error:a})),c=!1):a instanceof SignalReconnectError||(this.fullReconnectOnNext=!0),c?this.handleDisconnect("reconnect",ReconnectReason.RR_UNKNOWN):(this.log.info("could not recover connection after ".concat(this.reconnectAttempts," attempts, ").concat(Date.now()-this.reconnectStart,"ms. giving up"),this.logContext),this.emit(EngineEvent.Disconnected),yield this.close())}finally{this.attemptingReconnect=!1}}})}getNextRetryDelay(e){try{return this.reconnectPolicy.nextRetryDelayInMs(e)}catch(t){this.log.warn("encountered error in reconnect policy",Object.assign(Object.assign({},this.logContext),{error:t}))}return null}restartConnection(e){return __awaiter$1(this,void 0,void 0,function*(){var t,s,o;try{if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");this.log.info("reconnecting, attempt: ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent.Restarting),this.client.isDisconnected||(yield this.client.sendLeave()),yield this.cleanupPeerConnections(),yield this.cleanupClient();let a;try{if(!this.signalOpts)throw this.log.warn("attempted connection restart, without signal options present",this.logContext),new SignalReconnectError;a=yield this.join(e??this.url,this.token,this.signalOpts)}catch(c){throw c instanceof ConnectionError&&c.reason===ConnectionErrorReason.NotAllowed?new UnexpectedConnectionState("could not reconnect, token might be expired"):new SignalReconnectError}if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(this.client.setReconnected(),this.emit(EngineEvent.SignalRestarted,a),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");(t=this.regionUrlProvider)===null||t===void 0||t.resetAttempts(),this.emit(EngineEvent.Restarted)}catch(a){const c=yield(s=this.regionUrlProvider)===null||s===void 0?void 0:s.getNextBestRegionUrl();if(c){yield this.restartConnection(c);return}else throw(o=this.regionUrlProvider)===null||o===void 0||o.resetAttempts(),a}})}resumeConnection(e){return __awaiter$1(this,void 0,void 0,function*(){var t;if(!this.url||!this.token)throw new UnexpectedConnectionState("could not reconnect, url or token not saved");if(!this.pcManager)throw new UnexpectedConnectionState("publisher and subscriber connections unset");this.log.info("resuming signal connection, attempt ".concat(this.reconnectAttempts),this.logContext),this.emit(EngineEvent.Resuming);let s;try{this.setupSignalClientCallbacks(),s=yield this.client.reconnect(this.url,this.token,this.participantSid,e)}catch(o){let a="";throw o instanceof Error&&(a=o.message,this.log.error(o.message,Object.assign(Object.assign({},this.logContext),{error:o}))),o instanceof ConnectionError&&o.reason===ConnectionErrorReason.NotAllowed?new UnexpectedConnectionState("could not reconnect, token might be expired"):o instanceof ConnectionError&&o.reason===ConnectionErrorReason.LeaveRequest?o:new SignalReconnectError(a)}if(this.emit(EngineEvent.SignalResumed),s){const o=this.makeRTCConfiguration(s);this.pcManager.updateConfiguration(o)}else this.log.warn("Did not receive reconnect response",this.logContext);if(this.shouldFailNext)throw this.shouldFailNext=!1,new Error("simulated failure");if(yield this.pcManager.triggerIceRestart(),yield this.waitForPCReconnected(),this.client.currentState!==SignalConnectionState.CONNECTED)throw new SignalReconnectError("Signal connection got severed during reconnect");this.client.setReconnected(),((t=this.reliableDC)===null||t===void 0?void 0:t.readyState)==="open"&&this.reliableDC.id===null&&this.createDataChannels(),this.emit(EngineEvent.Resumed)})}waitForPCInitialConnection(e,t){return __awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(t,e)})}waitForPCReconnected(){return __awaiter$1(this,void 0,void 0,function*(){this.pcState=PCState.Reconnecting,this.log.debug("waiting for peer connection to reconnect",this.logContext);try{if(yield sleep$1(minReconnectWait),!this.pcManager)throw new UnexpectedConnectionState("PC manager is closed");yield this.pcManager.ensurePCTransportConnection(void 0,this.peerConnectionTimeout),this.pcState=PCState.Connected}catch(e){throw this.pcState=PCState.Disconnected,new ConnectionError("could not establish PC connection, ".concat(e.message))}})}sendDataPacket(e,t){return __awaiter$1(this,void 0,void 0,function*(){const s=e.toBinary();yield this.ensurePublisherConnected(t);const o=this.dataChannelForKind(t);o&&o.send(s),this.updateAndEmitDCBufferStatus(t)})}ensureDataTransportConnected(e){return __awaiter$1(this,arguments,void 0,function(t){var s=this;let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:this.subscriberPrimary;return function*(){var a;if(!s.pcManager)throw new UnexpectedConnectionState("PC manager is closed");const c=o?s.pcManager.subscriber:s.pcManager.publisher,u=o?"Subscriber":"Publisher";if(!c)throw new ConnectionError("".concat(u," connection not set"));let d=!1;!o&&!s.dataChannelForKind(t,o)&&(s.createDataChannels(),d=!0),!d&&!o&&!s.pcManager.publisher.isICEConnected&&s.pcManager.publisher.getICEConnectionState()!=="checking"&&(d=!0),d&&s.negotiate();const p=s.dataChannelForKind(t,o);if((p==null?void 0:p.readyState)==="open")return;const v=new Date().getTime()+s.peerConnectionTimeout;for(;new Date().getTime()<v;){if(c.isICEConnected&&((a=s.dataChannelForKind(t,o))===null||a===void 0?void 0:a.readyState)==="open")return;yield sleep$1(50)}throw new ConnectionError("could not establish ".concat(u," connection, state: ").concat(c.getICEConnectionState()))}()})}ensurePublisherConnected(e){return __awaiter$1(this,void 0,void 0,function*(){this.publisherConnectionPromise||(this.publisherConnectionPromise=this.ensureDataTransportConnected(e,!1)),yield this.publisherConnectionPromise})}verifyTransport(){return!(!this.pcManager||this.pcManager.currentState!==PCTransportState.CONNECTED||!this.client.ws||this.client.ws.readyState===WebSocket.CLOSED)}negotiate(){return __awaiter$1(this,void 0,void 0,function*(){return new Promise((e,t)=>__awaiter$1(this,void 0,void 0,function*(){if(!this.pcManager){t(new NegotiationError("PC manager is closed"));return}this.pcManager.requirePublisher(),this.pcManager.publisher.getTransceivers().length==0&&!this.lossyDC&&!this.reliableDC&&this.createDataChannels();const s=new AbortController,o=()=>{s.abort(),this.log.debug("engine disconnected while negotiation was ongoing",this.logContext),e()};this.isClosed&&t("cannot negotiate on closed engine"),this.on(EngineEvent.Closing,o),this.pcManager.publisher.once(PCEvents.RTPVideoPayloadTypes,a=>{const c=new Map;a.forEach(u=>{const d=u.codec.toLowerCase();isVideoCodec(d)&&c.set(u.payload,d)}),this.emit(EngineEvent.RTPVideoMapUpdate,c)});try{yield this.pcManager.negotiate(s),e()}catch(a){a instanceof NegotiationError&&(this.fullReconnectOnNext=!0),this.handleDisconnect("negotiation",ReconnectReason.RR_UNKNOWN),t(a)}finally{this.off(EngineEvent.Closing,o)}}))})}dataChannelForKind(e,t){if(t){if(e===DataPacket_Kind.LOSSY)return this.lossyDCSub;if(e===DataPacket_Kind.RELIABLE)return this.reliableDCSub}else{if(e===DataPacket_Kind.LOSSY)return this.lossyDC;if(e===DataPacket_Kind.RELIABLE)return this.reliableDC}}sendSyncState(e,t){var s,o;if(!this.pcManager){this.log.warn("sync state cannot be sent without peer connection setup",this.logContext);return}const a=this.pcManager.subscriber.getLocalDescription(),c=this.pcManager.subscriber.getRemoteDescription(),u=(o=(s=this.signalOpts)===null||s===void 0?void 0:s.autoSubscribe)!==null&&o!==void 0?o:!0,d=new Array,p=new Array;e.forEach(v=>{v.isDesired!==u&&d.push(v.trackSid),v.isEnabled||p.push(v.trackSid)}),this.client.sendSyncState(new SyncState({answer:a?toProtoSessionDescription({sdp:a.sdp,type:a.type}):void 0,offer:c?toProtoSessionDescription({sdp:c.sdp,type:c.type}):void 0,subscription:new UpdateSubscription({trackSids:d,subscribe:!u,participantTracks:[]}),publishTracks:getTrackPublicationInfo(t),dataChannels:this.dataChannelsInfo(),trackSidsDisabled:p}))}failNext(){this.shouldFailNext=!0}dataChannelsInfo(){const e=[],t=(s,o)=>{(s==null?void 0:s.id)!==void 0&&s.id!==null&&e.push(new DataChannelInfo({label:s.label,id:s.id,target:o}))};return t(this.dataChannelForKind(DataPacket_Kind.LOSSY),SignalTarget.PUBLISHER),t(this.dataChannelForKind(DataPacket_Kind.RELIABLE),SignalTarget.PUBLISHER),t(this.dataChannelForKind(DataPacket_Kind.LOSSY,!0),SignalTarget.SUBSCRIBER),t(this.dataChannelForKind(DataPacket_Kind.RELIABLE,!0),SignalTarget.SUBSCRIBER),e}clearReconnectTimeout(){this.reconnectTimeout&&CriticalTimers.clearTimeout(this.reconnectTimeout)}clearPendingReconnect(){this.clearReconnectTimeout(),this.reconnectAttempts=0}registerOnLineListener(){isWeb()&&window.addEventListener("online",this.handleBrowserOnLine)}deregisterOnLineListener(){isWeb()&&window.removeEventListener("online",this.handleBrowserOnLine)}}class SignalReconnectError extends Error{}function supportOptionalDatachannel(i){return i!==void 0&&i>13}function applyUserDataCompat(i,e){const t=i.participantIdentity?i.participantIdentity:e.participantIdentity;i.participantIdentity=t,e.participantIdentity=t;const s=i.destinationIdentities.length!==0?i.destinationIdentities:e.destinationIdentities;i.destinationIdentities=s,e.destinationIdentities=s}class RegionUrlProvider{constructor(e,t){this.lastUpdateAt=0,this.settingsCacheTime=3e3,this.attemptedRegions=[],this.serverUrl=new URL(e),this.token=t}updateToken(e){this.token=e}isCloud(){return isCloud(this.serverUrl)}getServerUrl(){return this.serverUrl}getNextBestRegionUrl(e){return __awaiter$1(this,void 0,void 0,function*(){if(!this.isCloud())throw Error("region availability is only supported for LiveKit Cloud domains");(!this.regionSettings||Date.now()-this.lastUpdateAt>this.settingsCacheTime)&&(this.regionSettings=yield this.fetchRegionSettings(e));const t=this.regionSettings.regions.filter(s=>!this.attemptedRegions.find(o=>o.url===s.url));if(t.length>0){const s=t[0];return this.attemptedRegions.push(s),livekitLogger.debug("next region: ".concat(s.region)),s.url}else return null})}resetAttempts(){this.attemptedRegions=[]}fetchRegionSettings(e){return __awaiter$1(this,void 0,void 0,function*(){const t=yield fetch("".concat(getCloudConfigUrl(this.serverUrl),"/regions"),{headers:{authorization:"Bearer ".concat(this.token)},signal:e});if(t.ok){const s=yield t.json();return this.lastUpdateAt=Date.now(),s}else throw new ConnectionError("Could not fetch region settings: ".concat(t.statusText),t.status===401?ConnectionErrorReason.NotAllowed:void 0,t.status)})}setServerReportedRegions(e){this.regionSettings=e,this.lastUpdateAt=Date.now()}}function getCloudConfigUrl(i){return"".concat(i.protocol.replace("ws","http"),"//").concat(i.host,"/settings")}class RemoteTrack extends Track{constructor(e,t,s,o,a){super(e,s,a),this.sid=t,this.receiver=o}setMuted(e){this.isMuted!==e&&(this.isMuted=e,this._mediaStreamTrack.enabled=!e,this.emit(e?TrackEvent.Muted:TrackEvent.Unmuted,this))}setMediaStream(e){this.mediaStream=e;const t=s=>{s.track===this._mediaStreamTrack&&(e.removeEventListener("removetrack",t),this.receiver&&"playoutDelayHint"in this.receiver&&(this.receiver.playoutDelayHint=void 0),this.receiver=void 0,this._currentBitrate=0,this.emit(TrackEvent.Ended,this))};e.addEventListener("removetrack",t)}start(){this.startMonitor(),super.enable()}stop(){this.stopMonitor(),super.disable()}getRTCStatsReport(){return __awaiter$1(this,void 0,void 0,function*(){var e;return!((e=this.receiver)===null||e===void 0)&&e.getStats?yield this.receiver.getStats():void 0})}setPlayoutDelay(e){this.receiver?"playoutDelayHint"in this.receiver?this.receiver.playoutDelayHint=e:this.log.warn("Playout delay not supported in this browser"):this.log.warn("Cannot set playout delay, track already ended")}getPlayoutDelay(){if(this.receiver){if("playoutDelayHint"in this.receiver)return this.receiver.playoutDelayHint;this.log.warn("Playout delay not supported in this browser")}else this.log.warn("Cannot get playout delay, track already ended");return 0}startMonitor(){this.monitorInterval||(this.monitorInterval=setInterval(()=>this.monitorReceiver(),monitorFrequency)),supportsSynchronizationSources()&&this.registerTimeSyncUpdate()}registerTimeSyncUpdate(){const e=()=>{var t;this.timeSyncHandle=requestAnimationFrame(()=>e());const s=(t=this.receiver)===null||t===void 0?void 0:t.getSynchronizationSources()[0];if(s){const{timestamp:o,rtpTimestamp:a}=s;a&&this.rtpTimestamp!==a&&(this.emit(TrackEvent.TimeSyncUpdate,{timestamp:o,rtpTimestamp:a}),this.rtpTimestamp=a)}};e()}}class RemoteAudioTrack extends RemoteTrack{constructor(e,t,s,o,a,c){super(e,t,Track.Kind.Audio,s,c),this.monitorReceiver=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const u=yield this.getReceiverStats();u&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate(u,this.prevStats)),this.prevStats=u}),this.audioContext=o,this.webAudioPluginNodes=[],a&&(this.sinkId=a.deviceId)}setVolume(e){var t;for(const s of this.attachedElements)this.audioContext?(t=this.gainNode)===null||t===void 0||t.gain.setTargetAtTime(e,0,.1):s.volume=e;isReactNative()&&this._mediaStreamTrack._setVolume(e),this.elementVolume=e}getVolume(){if(this.elementVolume)return this.elementVolume;if(isReactNative())return 1;let e=0;return this.attachedElements.forEach(t=>{t.volume>e&&(e=t.volume)}),e}setSinkId(e){return __awaiter$1(this,void 0,void 0,function*(){this.sinkId=e,yield Promise.all(this.attachedElements.map(t=>{if(supportsSetSinkId(t))return t.setSinkId(e)}))})}attach(e){const t=this.attachedElements.length===0;return e?super.attach(e):e=super.attach(),this.sinkId&&supportsSetSinkId(e)&&e.setSinkId(this.sinkId),this.audioContext&&t&&(this.log.debug("using audio context mapping",this.logContext),this.connectWebAudio(this.audioContext,e),e.volume=0,e.muted=!0),this.elementVolume&&this.setVolume(this.elementVolume),e}detach(e){let t;return e?(t=super.detach(e),this.audioContext&&(this.attachedElements.length>0?this.connectWebAudio(this.audioContext,this.attachedElements[0]):this.disconnectWebAudio())):(t=super.detach(),this.disconnectWebAudio()),t}setAudioContext(e){this.audioContext=e,e&&this.attachedElements.length>0?this.connectWebAudio(e,this.attachedElements[0]):e||this.disconnectWebAudio()}setWebAudioPlugins(e){this.webAudioPluginNodes=e,this.attachedElements.length>0&&this.audioContext&&this.connectWebAudio(this.audioContext,this.attachedElements[0])}connectWebAudio(e,t){this.disconnectWebAudio(),this.sourceNode=e.createMediaStreamSource(t.srcObject);let s=this.sourceNode;this.webAudioPluginNodes.forEach(o=>{s.connect(o),s=o}),this.gainNode=e.createGain(),s.connect(this.gainNode),this.gainNode.connect(e.destination),this.elementVolume&&this.gainNode.gain.setTargetAtTime(this.elementVolume,0,.1),e.state!=="running"&&e.resume().then(()=>{e.state!=="running"&&this.emit(TrackEvent.AudioPlaybackFailed,new Error("Audio Context couldn't be started automatically"))}).catch(o=>{this.emit(TrackEvent.AudioPlaybackFailed,o)})}disconnectWebAudio(){var e,t;(e=this.gainNode)===null||e===void 0||e.disconnect(),(t=this.sourceNode)===null||t===void 0||t.disconnect(),this.gainNode=void 0,this.sourceNode=void 0}getReceiverStats(){return __awaiter$1(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t;return e.forEach(s=>{s.type==="inbound-rtp"&&(t={type:"audio",timestamp:s.timestamp,jitter:s.jitter,bytesReceived:s.bytesReceived,concealedSamples:s.concealedSamples,concealmentEvents:s.concealmentEvents,silentConcealedSamples:s.silentConcealedSamples,silentConcealmentEvents:s.silentConcealmentEvents,totalAudioEnergy:s.totalAudioEnergy,totalSamplesDuration:s.totalSamplesDuration})}),t})}}const REACTION_DELAY=100;class RemoteVideoTrack extends RemoteTrack{constructor(e,t,s,o,a){super(e,t,Track.Kind.Video,s,a),this.elementInfos=[],this.monitorReceiver=()=>__awaiter$1(this,void 0,void 0,function*(){if(!this.receiver){this._currentBitrate=0;return}const c=yield this.getReceiverStats();c&&this.prevStats&&this.receiver&&(this._currentBitrate=computeBitrate(c,this.prevStats)),this.prevStats=c}),this.debouncedHandleResize=r(()=>{this.updateDimensions()},REACTION_DELAY),this.adaptiveStreamSettings=o}get isAdaptiveStream(){return this.adaptiveStreamSettings!==void 0}get mediaStreamTrack(){return this._mediaStreamTrack}setMuted(e){super.setMuted(e),this.attachedElements.forEach(t=>{e?detachTrack(this._mediaStreamTrack,t):attachToElement(this._mediaStreamTrack,t)})}attach(e){if(e?super.attach(e):e=super.attach(),this.adaptiveStreamSettings&&this.elementInfos.find(t=>t.element===e)===void 0){const t=new HTMLElementInfo(e);this.observeElementInfo(t)}return e}observeElementInfo(e){this.adaptiveStreamSettings&&this.elementInfos.find(t=>t===e)===void 0?(e.handleResize=()=>{this.debouncedHandleResize()},e.handleVisibilityChanged=()=>{this.updateVisibility()},this.elementInfos.push(e),e.observe(),this.debouncedHandleResize(),this.updateVisibility()):this.log.warn("visibility resize observer not triggered",this.logContext)}stopObservingElementInfo(e){if(!this.isAdaptiveStream){this.log.warn("stopObservingElementInfo ignored",this.logContext);return}const t=this.elementInfos.filter(s=>s===e);for(const s of t)s.stopObserving();this.elementInfos=this.elementInfos.filter(s=>s!==e),this.updateVisibility(),this.debouncedHandleResize()}detach(e){let t=[];if(e)return this.stopObservingElement(e),super.detach(e);t=super.detach();for(const s of t)this.stopObservingElement(s);return t}getDecoderImplementation(){var e;return(e=this.prevStats)===null||e===void 0?void 0:e.decoderImplementation}getReceiverStats(){return __awaiter$1(this,void 0,void 0,function*(){if(!this.receiver||!this.receiver.getStats)return;const e=yield this.receiver.getStats();let t,s="",o=new Map;return e.forEach(a=>{a.type==="inbound-rtp"?(s=a.codecId,t={type:"video",framesDecoded:a.framesDecoded,framesDropped:a.framesDropped,framesReceived:a.framesReceived,packetsReceived:a.packetsReceived,packetsLost:a.packetsLost,frameWidth:a.frameWidth,frameHeight:a.frameHeight,pliCount:a.pliCount,firCount:a.firCount,nackCount:a.nackCount,jitter:a.jitter,timestamp:a.timestamp,bytesReceived:a.bytesReceived,decoderImplementation:a.decoderImplementation}):a.type==="codec"&&o.set(a.id,a)}),t&&s!==""&&o.get(s)&&(t.mimeType=o.get(s).mimeType),t})}stopObservingElement(e){const t=this.elementInfos.filter(s=>s.element===e);for(const s of t)this.stopObservingElementInfo(s)}handleAppVisibilityChanged(){const e=Object.create(null,{handleAppVisibilityChanged:{get:()=>super.handleAppVisibilityChanged}});return __awaiter$1(this,void 0,void 0,function*(){yield e.handleAppVisibilityChanged.call(this),this.isAdaptiveStream&&this.updateVisibility()})}updateVisibility(){var e,t;const s=this.elementInfos.reduce((u,d)=>Math.max(u,d.visibilityChangedAt||0),0),o=!((t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pauseVideoInBackground)!==null&&t!==void 0)||t?this.isInBackground:!1,a=this.elementInfos.some(u=>u.pictureInPicture),c=this.elementInfos.some(u=>u.visible)&&!o||a;if(this.lastVisible!==c){if(!c&&Date.now()-s<REACTION_DELAY){CriticalTimers.setTimeout(()=>{this.updateVisibility()},REACTION_DELAY);return}this.lastVisible=c,this.emit(TrackEvent.VisibilityChanged,c,this)}}updateDimensions(){var e,t;let s=0,o=0;const a=this.getPixelDensity();for(const c of this.elementInfos){const u=c.width()*a,d=c.height()*a;u+d>s+o&&(s=u,o=d)}((e=this.lastDimensions)===null||e===void 0?void 0:e.width)===s&&((t=this.lastDimensions)===null||t===void 0?void 0:t.height)===o||(this.lastDimensions={width:s,height:o},this.emit(TrackEvent.VideoDimensionsChanged,this.lastDimensions,this))}getPixelDensity(){var e;const t=(e=this.adaptiveStreamSettings)===null||e===void 0?void 0:e.pixelDensity;return t==="screen"?getDevicePixelRatio():t||(getDevicePixelRatio()>2?2:1)}}class HTMLElementInfo{get visible(){return this.isPiP||this.isIntersecting}get pictureInPicture(){return this.isPiP}constructor(e,t){this.onVisibilityChanged=s=>{var o;const{target:a,isIntersecting:c}=s;a===this.element&&(this.isIntersecting=c,this.visibilityChangedAt=Date.now(),(o=this.handleVisibilityChanged)===null||o===void 0||o.call(this))},this.onEnterPiP=()=>{var s;this.isPiP=!0,(s=this.handleVisibilityChanged)===null||s===void 0||s.call(this)},this.onLeavePiP=()=>{var s;this.isPiP=!1,(s=this.handleVisibilityChanged)===null||s===void 0||s.call(this)},this.element=e,this.isIntersecting=t??isElementInViewport(e),this.isPiP=isWeb()&&document.pictureInPictureElement===e,this.visibilityChangedAt=0}width(){return this.element.clientWidth}height(){return this.element.clientHeight}observe(){this.isIntersecting=isElementInViewport(this.element),this.isPiP=document.pictureInPictureElement===this.element,this.element.handleResize=()=>{var e;(e=this.handleResize)===null||e===void 0||e.call(this)},this.element.handleVisibilityChanged=this.onVisibilityChanged,getIntersectionObserver().observe(this.element),getResizeObserver().observe(this.element),this.element.addEventListener("enterpictureinpicture",this.onEnterPiP),this.element.addEventListener("leavepictureinpicture",this.onLeavePiP)}stopObserving(){var e,t;(e=getIntersectionObserver())===null||e===void 0||e.unobserve(this.element),(t=getResizeObserver())===null||t===void 0||t.unobserve(this.element),this.element.removeEventListener("enterpictureinpicture",this.onEnterPiP),this.element.removeEventListener("leavepictureinpicture",this.onLeavePiP)}}function isElementInViewport(i){let e=i.offsetTop,t=i.offsetLeft;const s=i.offsetWidth,o=i.offsetHeight,{hidden:a}=i,{opacity:c,display:u}=getComputedStyle(i);for(;i.offsetParent;)i=i.offsetParent,e+=i.offsetTop,t+=i.offsetLeft;return e<window.pageYOffset+window.innerHeight&&t<window.pageXOffset+window.innerWidth&&e+o>window.pageYOffset&&t+s>window.pageXOffset&&!a&&(c!==""?parseFloat(c)>0:!0)&&u!=="none"}class TrackPublication extends eventsExports.EventEmitter{constructor(e,t,s,o){var a;super(),this.metadataMuted=!1,this.encryption=Encryption_Type.NONE,this.log=livekitLogger,this.handleMuted=()=>{this.emit(TrackEvent.Muted)},this.handleUnmuted=()=>{this.emit(TrackEvent.Unmuted)},this.log=getLogger((a=o==null?void 0:o.loggerName)!==null&&a!==void 0?a:LoggerNames.Publication),this.loggerContextCb=this.loggerContextCb,this.setMaxListeners(100),this.kind=e,this.trackSid=t,this.trackName=s,this.source=Track.Source.Unknown}setTrack(e){this.track&&(this.track.off(TrackEvent.Muted,this.handleMuted),this.track.off(TrackEvent.Unmuted,this.handleUnmuted)),this.track=e,e&&(e.on(TrackEvent.Muted,this.handleMuted),e.on(TrackEvent.Unmuted,this.handleUnmuted))}get logContext(){var e;return Object.assign(Object.assign({},(e=this.loggerContextCb)===null||e===void 0?void 0:e.call(this)),getLogContextFromTrack(this))}get isMuted(){return this.metadataMuted}get isEnabled(){return!0}get isSubscribed(){return this.track!==void 0}get isEncrypted(){return this.encryption!==Encryption_Type.NONE}get audioTrack(){if(this.track instanceof LocalAudioTrack||this.track instanceof RemoteAudioTrack)return this.track}get videoTrack(){if(this.track instanceof LocalVideoTrack||this.track instanceof RemoteVideoTrack)return this.track}updateInfo(e){this.trackSid=e.sid,this.trackName=e.name,this.source=Track.sourceFromProto(e.source),this.mimeType=e.mimeType,this.kind===Track.Kind.Video&&e.width>0&&(this.dimensions={width:e.width,height:e.height},this.simulcasted=e.simulcast),this.encryption=e.encryption,this.trackInfo=e,this.log.debug("update publication info",Object.assign(Object.assign({},this.logContext),{info:e}))}}(function(i){(function(e){e.Desired="desired",e.Subscribed="subscribed",e.Unsubscribed="unsubscribed"})(i.SubscriptionStatus||(i.SubscriptionStatus={})),function(e){e.Allowed="allowed",e.NotAllowed="not_allowed"}(i.PermissionStatus||(i.PermissionStatus={}))})(TrackPublication||(TrackPublication={}));class LocalTrackPublication extends TrackPublication{get isUpstreamPaused(){var e;return(e=this.track)===null||e===void 0?void 0:e.isUpstreamPaused}constructor(e,t,s,o){super(e,t.sid,t.name,o),this.track=void 0,this.handleTrackEnded=()=>{this.emit(TrackEvent.Ended)},this.updateInfo(t),this.setTrack(s)}setTrack(e){this.track&&this.track.off(TrackEvent.Ended,this.handleTrackEnded),super.setTrack(e),e&&e.on(TrackEvent.Ended,this.handleTrackEnded)}get isMuted(){return this.track?this.track.isMuted:super.isMuted}get audioTrack(){return super.audioTrack}get videoTrack(){return super.videoTrack}mute(){return __awaiter$1(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.mute()})}unmute(){return __awaiter$1(this,void 0,void 0,function*(){var e;return(e=this.track)===null||e===void 0?void 0:e.unmute()})}pauseUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.pauseUpstream()})}resumeUpstream(){return __awaiter$1(this,void 0,void 0,function*(){var e;yield(e=this.track)===null||e===void 0?void 0:e.resumeUpstream()})}getTrackFeatures(){var e;if(this.track instanceof LocalAudioTrack){const t=this.track.mediaStreamTrack.getSettings(),s=new Set;return t.autoGainControl&&s.add(AudioTrackFeature.TF_AUTO_GAIN_CONTROL),t.echoCancellation&&s.add(AudioTrackFeature.TF_ECHO_CANCELLATION),t.noiseSuppression&&s.add(AudioTrackFeature.TF_NOISE_SUPPRESSION),t.channelCount&&t.channelCount>1&&s.add(AudioTrackFeature.TF_STEREO),!((e=this.options)===null||e===void 0)&&e.dtx||s.add(AudioTrackFeature.TF_NO_DTX),this.track.enhancedNoiseCancellation&&s.add(AudioTrackFeature.TF_ENHANCED_NOISE_CANCELLATION),Array.from(s.values())}else return[]}}function extractProcessorsFromOptions(i){let e,t;return typeof i.audio=="object"&&i.audio.processor&&(e=i.audio.processor),typeof i.video=="object"&&i.video.processor&&(t=i.video.processor),{audioProcessor:e,videoProcessor:t}}function createLocalTracks(i){return __awaiter$1(this,void 0,void 0,function*(){var e,t;i??(i={}),(e=i.audio)!==null&&e!==void 0||(i.audio=!0),(t=i.video)!==null&&t!==void 0||(i.video=!0);const{audioProcessor:s,videoProcessor:o}=extractProcessorsFromOptions(i),a=mergeDefaultOptions(i,audioDefaults,videoDefaults),c=constraintsForOptions(a),u=navigator.mediaDevices.getUserMedia(c);i.audio&&(DeviceManager.userMediaPromiseMap.set("audioinput",u),u.catch(()=>DeviceManager.userMediaPromiseMap.delete("audioinput"))),i.video&&(DeviceManager.userMediaPromiseMap.set("videoinput",u),u.catch(()=>DeviceManager.userMediaPromiseMap.delete("videoinput")));const d=yield u;return Promise.all(d.getTracks().map(p=>__awaiter$1(this,void 0,void 0,function*(){const v=p.kind==="audio";v?a.audio:a.video;let g;const m=v?c.audio:c.video;typeof m!="boolean"&&(g=m),g?g.deviceId=p.getSettings().deviceId:g={deviceId:p.getSettings().deviceId};const S=mediaTrackToLocalTrack(p,g);return S.kind===Track.Kind.Video?S.source=Track.Source.Camera:S.kind===Track.Kind.Audio&&(S.source=Track.Source.Microphone),S.mediaStream=d,S instanceof LocalAudioTrack&&s?yield S.setProcessor(s):S instanceof LocalVideoTrack&&o&&(yield S.setProcessor(o)),S})))})}function createLocalVideoTrack(i){return __awaiter$1(this,void 0,void 0,function*(){return(yield createLocalTracks({audio:!1,video:i}))[0]})}function createLocalAudioTrack(i){return __awaiter$1(this,void 0,void 0,function*(){return(yield createLocalTracks({audio:i,video:!1}))[0]})}var ConnectionQuality;(function(i){i.Excellent="excellent",i.Good="good",i.Poor="poor",i.Lost="lost",i.Unknown="unknown"})(ConnectionQuality||(ConnectionQuality={}));function qualityFromProto(i){switch(i){case ConnectionQuality$1.EXCELLENT:return ConnectionQuality.Excellent;case ConnectionQuality$1.GOOD:return ConnectionQuality.Good;case ConnectionQuality$1.POOR:return ConnectionQuality.Poor;case ConnectionQuality$1.LOST:return ConnectionQuality.Lost;default:return ConnectionQuality.Unknown}}class Participant extends eventsExports.EventEmitter{get logContext(){var e,t;return Object.assign({},(t=(e=this.loggerOptions)===null||e===void 0?void 0:e.loggerContextCb)===null||t===void 0?void 0:t.call(e))}get isEncrypted(){return this.trackPublications.size>0&&Array.from(this.trackPublications.values()).every(e=>e.isEncrypted)}get isAgent(){var e;return((e=this.permissions)===null||e===void 0?void 0:e.agent)||this.kind===ParticipantInfo_Kind.AGENT}get kind(){return this._kind}get attributes(){return Object.freeze(Object.assign({},this._attributes))}constructor(e,t,s,o,a){let c=arguments.length>5&&arguments[5]!==void 0?arguments[5]:ParticipantInfo_Kind.STANDARD;var u;super(),this.audioLevel=0,this.isSpeaking=!1,this._connectionQuality=ConnectionQuality.Unknown,this.log=livekitLogger,this.log=getLogger((u=a==null?void 0:a.loggerName)!==null&&u!==void 0?u:LoggerNames.Participant),this.loggerOptions=a,this.setMaxListeners(100),this.sid=e,this.identity=t,this.name=s,this.metadata=o,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this._kind=c,this._attributes={}}getTrackPublications(){return Array.from(this.trackPublications.values())}getTrackPublication(e){for(const[,t]of this.trackPublications)if(t.source===e)return t}getTrackPublicationByName(e){for(const[,t]of this.trackPublications)if(t.trackName===e)return t}get connectionQuality(){return this._connectionQuality}get isCameraEnabled(){var e;const t=this.getTrackPublication(Track.Source.Camera);return!(!((e=t==null?void 0:t.isMuted)!==null&&e!==void 0)||e)}get isMicrophoneEnabled(){var e;const t=this.getTrackPublication(Track.Source.Microphone);return!(!((e=t==null?void 0:t.isMuted)!==null&&e!==void 0)||e)}get isScreenShareEnabled(){return!!this.getTrackPublication(Track.Source.ScreenShare)}get isLocal(){return!1}get joinedAt(){return this.participantInfo?new Date(Number.parseInt(this.participantInfo.joinedAt.toString())*1e3):new Date}updateInfo(e){return this.participantInfo&&this.participantInfo.sid===e.sid&&this.participantInfo.version>e.version?!1:(this.identity=e.identity,this.sid=e.sid,this._setName(e.name),this._setMetadata(e.metadata),this._setAttributes(e.attributes),e.permission&&this.setPermissions(e.permission),this.participantInfo=e,this.log.trace("update participant info",Object.assign(Object.assign({},this.logContext),{info:e})),!0)}_setMetadata(e){const t=this.metadata!==e,s=this.metadata;this.metadata=e,t&&this.emit(ParticipantEvent.ParticipantMetadataChanged,s)}_setName(e){const t=this.name!==e;this.name=e,t&&this.emit(ParticipantEvent.ParticipantNameChanged,e)}_setAttributes(e){const t=diffAttributes(this.attributes,e);this._attributes=e,Object.keys(t).length>0&&this.emit(ParticipantEvent.AttributesChanged,t)}setPermissions(e){var t,s,o,a,c,u;const d=this.permissions,p=e.canPublish!==((t=this.permissions)===null||t===void 0?void 0:t.canPublish)||e.canSubscribe!==((s=this.permissions)===null||s===void 0?void 0:s.canSubscribe)||e.canPublishData!==((o=this.permissions)===null||o===void 0?void 0:o.canPublishData)||e.hidden!==((a=this.permissions)===null||a===void 0?void 0:a.hidden)||e.recorder!==((c=this.permissions)===null||c===void 0?void 0:c.recorder)||e.canPublishSources.length!==this.permissions.canPublishSources.length||e.canPublishSources.some((v,g)=>{var m;return v!==((m=this.permissions)===null||m===void 0?void 0:m.canPublishSources[g])})||e.canSubscribeMetrics!==((u=this.permissions)===null||u===void 0?void 0:u.canSubscribeMetrics);return this.permissions=e,p&&this.emit(ParticipantEvent.ParticipantPermissionsChanged,d),p}setIsSpeaking(e){e!==this.isSpeaking&&(this.isSpeaking=e,e&&(this.lastSpokeAt=new Date),this.emit(ParticipantEvent.IsSpeakingChanged,e))}setConnectionQuality(e){const t=this._connectionQuality;this._connectionQuality=qualityFromProto(e),t!==this._connectionQuality&&this.emit(ParticipantEvent.ConnectionQualityChanged,this._connectionQuality)}setAudioContext(e){this.audioContext=e,this.audioTrackPublications.forEach(t=>(t.track instanceof RemoteAudioTrack||t.track instanceof LocalAudioTrack)&&t.track.setAudioContext(e))}addTrackPublication(e){e.on(TrackEvent.Muted,()=>{this.emit(ParticipantEvent.TrackMuted,e)}),e.on(TrackEvent.Unmuted,()=>{this.emit(ParticipantEvent.TrackUnmuted,e)});const t=e;switch(t.track&&(t.track.sid=e.trackSid),this.trackPublications.set(e.trackSid,e),e.kind){case Track.Kind.Audio:this.audioTrackPublications.set(e.trackSid,e);break;case Track.Kind.Video:this.videoTrackPublications.set(e.trackSid,e);break}}}function trackPermissionToProto(i){var e,t,s;if(!i.participantSid&&!i.participantIdentity)throw new Error("Invalid track permission, must provide at least one of participantIdentity and participantSid");return new TrackPermission({participantIdentity:(e=i.participantIdentity)!==null&&e!==void 0?e:"",participantSid:(t=i.participantSid)!==null&&t!==void 0?t:"",allTracks:(s=i.allowAll)!==null&&s!==void 0?s:!1,trackSids:i.allowedTrackSids||[]})}class LocalParticipant extends Participant{constructor(e,t,s,o){super(e,t,void 0,void 0,{loggerName:o.loggerName,loggerContextCb:()=>this.engine.logContext}),this.pendingPublishing=new Set,this.pendingPublishPromises=new Map,this.participantTrackPermissions=[],this.allParticipantsAllowedToSubscribe=!0,this.encryptionType=Encryption_Type.NONE,this.enabledPublishVideoCodecs=[],this.handleReconnecting=()=>{this.reconnectFuture||(this.reconnectFuture=new Future)},this.handleReconnected=()=>{var a,c;(c=(a=this.reconnectFuture)===null||a===void 0?void 0:a.resolve)===null||c===void 0||c.call(a),this.reconnectFuture=void 0,this.updateTrackSubscriptionPermissions()},this.handleDisconnected=()=>{var a,c;this.reconnectFuture&&(this.reconnectFuture.promise.catch(u=>this.log.warn(u.message,this.logContext)),(c=(a=this.reconnectFuture)===null||a===void 0?void 0:a.reject)===null||c===void 0||c.call(a,"Got disconnected during reconnection attempt"),this.reconnectFuture=void 0)},this.handleSignalRequestResponse=a=>{const{requestId:c,reason:u,message:d}=a,p=this.pendingSignalRequests.get(c);p&&(u!==RequestResponse_Reason.OK&&p.reject(new SignalRequestError(d,u)),this.pendingSignalRequests.delete(c))},this.updateTrackSubscriptionPermissions=()=>{this.log.debug("updating track subscription permissions",Object.assign(Object.assign({},this.logContext),{allParticipantsAllowed:this.allParticipantsAllowedToSubscribe,participantTrackPermissions:this.participantTrackPermissions})),this.engine.client.sendUpdateSubscriptionPermissions(this.allParticipantsAllowedToSubscribe,this.participantTrackPermissions.map(a=>trackPermissionToProto(a)))},this.onTrackUnmuted=a=>{this.onTrackMuted(a,a.isUpstreamPaused)},this.onTrackMuted=(a,c)=>{if(c===void 0&&(c=!0),!a.sid){this.log.error("could not update mute status for unpublished track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(a)));return}this.engine.updateMuteStatus(a.sid,c)},this.onTrackUpstreamPaused=a=>{this.log.debug("upstream paused",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(a))),this.onTrackMuted(a,!0)},this.onTrackUpstreamResumed=a=>{this.log.debug("upstream resumed",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(a))),this.onTrackMuted(a,a.isMuted)},this.onTrackFeatureUpdate=a=>{const c=this.audioTrackPublications.get(a.sid);if(!c){this.log.warn("Could not update local audio track settings, missing publication for track ".concat(a.sid),this.logContext);return}this.engine.client.sendUpdateLocalAudioTrack(c.trackSid,c.getTrackFeatures())},this.handleSubscribedQualityUpdate=a=>__awaiter$1(this,void 0,void 0,function*(){var c,u,d,p,v,g;if(!(!((v=this.roomOptions)===null||v===void 0)&&v.dynacast))return;const m=this.videoTrackPublications.get(a.trackSid);if(!m){this.log.warn("received subscribed quality update for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:a.trackSid}));return}if(a.subscribedCodecs.length>0){if(!m.videoTrack)return;const R=yield m.videoTrack.setPublishingCodecs(a.subscribedCodecs);try{for(var S=!0,y=__asyncValues(R),C;C=yield y.next(),c=C.done,!c;S=!0){p=C.value,S=!1;const T=p;isBackupCodec(T)&&(this.log.debug("publish ".concat(T," for ").concat(m.videoTrack.sid),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(m))),yield this.publishAdditionalCodecForTrack(m.videoTrack,T,m.options))}}catch(T){u={error:T}}finally{try{!S&&!c&&(d=y.return)&&(yield d.call(y))}finally{if(u)throw u.error}}}else a.subscribedQualities.length>0&&(yield(g=m.videoTrack)===null||g===void 0?void 0:g.setPublishingLayers(a.subscribedQualities))}),this.handleLocalTrackUnpublished=a=>{const c=this.trackPublications.get(a.trackSid);if(!c){this.log.warn("received unpublished event for unknown track",Object.assign(Object.assign({},this.logContext),{trackSid:a.trackSid}));return}this.unpublishTrack(c.track)},this.handleTrackEnded=a=>__awaiter$1(this,void 0,void 0,function*(){if(a.source===Track.Source.ScreenShare||a.source===Track.Source.ScreenShareAudio)this.log.debug("unpublishing local track due to TrackEnded",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(a))),this.unpublishTrack(a);else if(a.isUserProvided)yield a.mute();else if(a instanceof LocalAudioTrack||a instanceof LocalVideoTrack)try{if(isWeb())try{const c=yield navigator==null?void 0:navigator.permissions.query({name:a.source===Track.Source.Camera?"camera":"microphone"});if(c&&c.state==="denied")throw this.log.warn("user has revoked access to ".concat(a.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(a))),c.onchange=()=>{c.state!=="denied"&&(a.isMuted||a.restartTrack(),c.onchange=null)},new Error("GetUserMedia Permission denied")}catch{}a.isMuted||(this.log.debug("track ended, attempting to use a different device",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(a))),a instanceof LocalAudioTrack?yield a.restartTrack({deviceId:"default"}):yield a.restartTrack())}catch{this.log.warn("could not restart track, muting instead",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(a))),yield a.mute()}}),this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.trackPublications=new Map,this.engine=s,this.roomOptions=o,this.setupEngine(s),this.activeDeviceMap=new Map,this.pendingSignalRequests=new Map}get lastCameraError(){return this.cameraError}get lastMicrophoneError(){return this.microphoneError}get isE2EEEnabled(){return this.encryptionType!==Encryption_Type.NONE}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setupEngine(e){this.engine=e,this.engine.on(EngineEvent.RemoteMute,(t,s)=>{const o=this.trackPublications.get(t);!o||!o.track||(s?o.mute():o.unmute())}),this.engine.on(EngineEvent.Connected,this.handleReconnected).on(EngineEvent.SignalRestarted,this.handleReconnected).on(EngineEvent.SignalResumed,this.handleReconnected).on(EngineEvent.Restarting,this.handleReconnecting).on(EngineEvent.Resuming,this.handleReconnecting).on(EngineEvent.LocalTrackUnpublished,this.handleLocalTrackUnpublished).on(EngineEvent.SubscribedQualityUpdate,this.handleSubscribedQualityUpdate).on(EngineEvent.Disconnected,this.handleDisconnected).on(EngineEvent.SignalRequestResponse,this.handleSignalRequestResponse)}setMetadata(e){return __awaiter$1(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({metadata:e})})}setName(e){return __awaiter$1(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({name:e})})}setAttributes(e){return __awaiter$1(this,void 0,void 0,function*(){yield this.requestMetadataUpdate({attributes:e})})}requestMetadataUpdate(e){return __awaiter$1(this,arguments,void 0,function(t){var s=this;let{metadata:o,name:a,attributes:c}=t;return function*(){return new Promise((u,d)=>__awaiter$1(s,void 0,void 0,function*(){var p,v;try{let g=!1;const m=yield this.engine.client.sendUpdateLocalMetadata((p=o??this.metadata)!==null&&p!==void 0?p:"",(v=a??this.name)!==null&&v!==void 0?v:"",c),S=performance.now();for(this.pendingSignalRequests.set(m,{resolve:u,reject:y=>{d(y),g=!0},values:{name:a,metadata:o,attributes:c}});performance.now()-S<5e3&&!g;){if((!a||this.name===a)&&(!o||this.metadata===o)&&(!c||Object.entries(c).every(y=>{let[C,R]=y;return this.attributes[C]===R||R===""&&!this.attributes[C]}))){this.pendingSignalRequests.delete(m),u();return}yield sleep$1(50)}d(new SignalRequestError("Request to update local metadata timed out","TimeoutError"))}catch(g){g instanceof Error&&d(g)}}))}()})}setCameraEnabled(e,t,s){return this.setTrackEnabled(Track.Source.Camera,e,t,s)}setMicrophoneEnabled(e,t,s){return this.setTrackEnabled(Track.Source.Microphone,e,t,s)}setScreenShareEnabled(e,t,s){return this.setTrackEnabled(Track.Source.ScreenShare,e,t,s)}setPermissions(e){const t=this.permissions,s=super.setPermissions(e);return s&&t&&this.emit(ParticipantEvent.ParticipantPermissionsChanged,t),s}setE2EEEnabled(e){return __awaiter$1(this,void 0,void 0,function*(){this.encryptionType=e?Encryption_Type.GCM:Encryption_Type.NONE,yield this.republishAllTracks(void 0,!1)})}setTrackEnabled(e,t,s,o){return __awaiter$1(this,void 0,void 0,function*(){var a,c;this.log.debug("setTrackEnabled",Object.assign(Object.assign({},this.logContext),{source:e,enabled:t})),this.republishPromise&&(yield this.republishPromise);let u=this.getTrackPublication(e);if(t)if(u)yield u.unmute();else{let d;if(this.pendingPublishing.has(e)){const p=yield this.waitForPendingPublicationOfSource(e);return p||this.log.info("skipping duplicate published source",Object.assign(Object.assign({},this.logContext),{source:e})),yield p==null?void 0:p.unmute(),p}this.pendingPublishing.add(e);try{switch(e){case Track.Source.Camera:d=yield this.createTracks({video:(a=s)!==null&&a!==void 0?a:!0});break;case Track.Source.Microphone:d=yield this.createTracks({audio:(c=s)!==null&&c!==void 0?c:!0});break;case Track.Source.ScreenShare:d=yield this.createScreenTracks(Object.assign({},s));break;default:throw new TrackInvalidError(e)}const p=[];for(const g of d)this.log.info("publishing track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(g))),p.push(this.publishTrack(g,o));[u]=yield Promise.all(p)}catch(p){throw d==null||d.forEach(v=>{v.stop()}),p instanceof Error&&!(p instanceof TrackInvalidError)&&this.emit(ParticipantEvent.MediaDevicesError,p),p}finally{this.pendingPublishing.delete(e)}}else if(u!=null&&u.track||(u=yield this.waitForPendingPublicationOfSource(e)),u&&u.track)if(e===Track.Source.ScreenShare){u=yield this.unpublishTrack(u.track);const d=this.getTrackPublication(Track.Source.ScreenShareAudio);d&&d.track&&this.unpublishTrack(d.track)}else yield u.mute();return u})}enableCameraAndMicrophone(){return __awaiter$1(this,void 0,void 0,function*(){if(!(this.pendingPublishing.has(Track.Source.Camera)||this.pendingPublishing.has(Track.Source.Microphone))){this.pendingPublishing.add(Track.Source.Camera),this.pendingPublishing.add(Track.Source.Microphone);try{const e=yield this.createTracks({audio:!0,video:!0});yield Promise.all(e.map(t=>this.publishTrack(t)))}finally{this.pendingPublishing.delete(Track.Source.Camera),this.pendingPublishing.delete(Track.Source.Microphone)}}})}createTracks(e){return __awaiter$1(this,void 0,void 0,function*(){var t,s;e??(e={});const{audioProcessor:o,videoProcessor:a}=extractProcessorsFromOptions(e),c=mergeDefaultOptions(e,(t=this.roomOptions)===null||t===void 0?void 0:t.audioCaptureDefaults,(s=this.roomOptions)===null||s===void 0?void 0:s.videoCaptureDefaults),u=constraintsForOptions(c);let d;try{d=yield navigator.mediaDevices.getUserMedia(u)}catch(p){throw p instanceof Error&&(u.audio&&(this.microphoneError=p),u.video&&(this.cameraError=p)),p}return u.audio&&(this.microphoneError=void 0,this.emit(ParticipantEvent.AudioStreamAcquired)),u.video&&(this.cameraError=void 0),Promise.all(d.getTracks().map(p=>__awaiter$1(this,void 0,void 0,function*(){const v=p.kind==="audio";v?c.audio:c.video;let g;const m=v?u.audio:u.video;typeof m!="boolean"&&(g=m);const S=mediaTrackToLocalTrack(p,g,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return S.kind===Track.Kind.Video?S.source=Track.Source.Camera:S.kind===Track.Kind.Audio&&(S.source=Track.Source.Microphone,S.setAudioContext(this.audioContext)),S.mediaStream=d,S instanceof LocalAudioTrack&&o?yield S.setProcessor(o):S instanceof LocalVideoTrack&&a&&(yield S.setProcessor(a)),S})))})}createScreenTracks(e){return __awaiter$1(this,void 0,void 0,function*(){if(e===void 0&&(e={}),navigator.mediaDevices.getDisplayMedia===void 0)throw new DeviceUnsupportedError("getDisplayMedia not supported");e.resolution===void 0&&!isSafari17()&&(e.resolution=ScreenSharePresets.h1080fps30.resolution);const t=screenCaptureToDisplayMediaStreamOptions(e),s=yield navigator.mediaDevices.getDisplayMedia(t),o=s.getVideoTracks();if(o.length===0)throw new TrackInvalidError("no video track found");const a=new LocalVideoTrack(o[0],void 0,!1,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});a.source=Track.Source.ScreenShare,e.contentHint&&(a.mediaStreamTrack.contentHint=e.contentHint);const c=[a];if(s.getAudioTracks().length>0){this.emit(ParticipantEvent.AudioStreamAcquired);const u=new LocalAudioTrack(s.getAudioTracks()[0],void 0,!1,this.audioContext,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});u.source=Track.Source.ScreenShareAudio,c.push(u)}return c})}publishTrack(e,t){return __awaiter$1(this,void 0,void 0,function*(){return this.publishOrRepublishTrack(e,t)})}publishOrRepublishTrack(e,t){return __awaiter$1(this,arguments,void 0,function(s,o){var a=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return function*(){var u,d,p,v;s instanceof LocalAudioTrack&&s.setAudioContext(a.audioContext),yield(u=a.reconnectFuture)===null||u===void 0?void 0:u.promise,a.republishPromise&&!c&&(yield a.republishPromise),s instanceof LocalTrack&&a.pendingPublishPromises.has(s)&&(yield a.pendingPublishPromises.get(s));let g;if(s instanceof MediaStreamTrack)g=s.getConstraints();else{g=s.constraints;let T;switch(s.source){case Track.Source.Microphone:T="audioinput";break;case Track.Source.Camera:T="videoinput"}T&&a.activeDeviceMap.has(T)&&(g=Object.assign(Object.assign({},g),{deviceId:a.activeDeviceMap.get(T)}))}if(s instanceof MediaStreamTrack)switch(s.kind){case"audio":s=new LocalAudioTrack(s,g,!0,a.audioContext,{loggerName:a.roomOptions.loggerName,loggerContextCb:()=>a.logContext});break;case"video":s=new LocalVideoTrack(s,g,!0,{loggerName:a.roomOptions.loggerName,loggerContextCb:()=>a.logContext});break;default:throw new TrackInvalidError("unsupported MediaStreamTrack kind ".concat(s.kind))}else s.updateLoggerOptions({loggerName:a.roomOptions.loggerName,loggerContextCb:()=>a.logContext});let m;if(a.trackPublications.forEach(T=>{T.track&&T.track===s&&(m=T)}),m)return a.log.warn("track has already been published, skipping",Object.assign(Object.assign({},a.logContext),getLogContextFromTrack(m))),m;const S="channelCount"in s.mediaStreamTrack.getSettings()&&s.mediaStreamTrack.getSettings().channelCount===2||s.mediaStreamTrack.getConstraints().channelCount===2,y=(d=o==null?void 0:o.forceStereo)!==null&&d!==void 0?d:S;y&&(o||(o={}),o.dtx===void 0&&a.log.info("Opus DTX will be disabled for stereo tracks by default. Enable them explicitly to make it work.",Object.assign(Object.assign({},a.logContext),getLogContextFromTrack(s))),o.red===void 0&&a.log.info("Opus RED will be disabled for stereo tracks by default. Enable them explicitly to make it work."),(p=o.dtx)!==null&&p!==void 0||(o.dtx=!1),(v=o.red)!==null&&v!==void 0||(o.red=!1));const C=Object.assign(Object.assign({},a.roomOptions.publishDefaults),o);!isE2EESimulcastSupported()&&a.roomOptions.e2ee&&(a.log.info("End-to-end encryption is set up, simulcast publishing will be disabled on Safari versions and iOS browsers running iOS < v17.2",Object.assign({},a.logContext)),C.simulcast=!1),C.source&&(s.source=C.source);const R=a.publish(s,C,y);a.pendingPublishPromises.set(s,R);try{return yield R}catch(T){throw T}finally{a.pendingPublishPromises.delete(s)}}()})}publish(e,t,s){return __awaiter$1(this,void 0,void 0,function*(){var o,a,c,u,d,p,v,g,m,S;Array.from(this.trackPublications.values()).find(P=>e instanceof LocalTrack&&P.source===e.source)&&e.source!==Track.Source.Unknown&&this.log.info("publishing a second track with the same source: ".concat(e.source),Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(e))),t.stopMicTrackOnMute&&e instanceof LocalAudioTrack&&(e.stopOnMute=!0),e.source===Track.Source.ScreenShare&&isFireFox()&&(t.simulcast=!1),t.videoCodec==="av1"&&!supportsAV1()&&(t.videoCodec=void 0),t.videoCodec==="vp9"&&!supportsVP9()&&(t.videoCodec=void 0),t.videoCodec===void 0&&(t.videoCodec=defaultVideoCodec),this.enabledPublishVideoCodecs.length>0&&(this.enabledPublishVideoCodecs.some(P=>t.videoCodec===mimeTypeToVideoCodecString(P.mime))||(t.videoCodec=mimeTypeToVideoCodecString(this.enabledPublishVideoCodecs[0].mime)));const C=t.videoCodec;e.on(TrackEvent.Muted,this.onTrackMuted),e.on(TrackEvent.Unmuted,this.onTrackUnmuted),e.on(TrackEvent.Ended,this.handleTrackEnded),e.on(TrackEvent.UpstreamPaused,this.onTrackUpstreamPaused),e.on(TrackEvent.UpstreamResumed,this.onTrackUpstreamResumed),e.on(TrackEvent.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate);const R=new AddTrackRequest({cid:e.mediaStreamTrack.id,name:t.name,type:Track.kindToProto(e.kind),muted:e.isMuted,source:Track.sourceToProto(e.source),disableDtx:!(!((o=t.dtx)!==null&&o!==void 0)||o),encryption:this.encryptionType,stereo:s,disableRed:this.isE2EEEnabled||!(!((a=t.red)!==null&&a!==void 0)||a),stream:t==null?void 0:t.stream});let T;if(e.kind===Track.Kind.Video){let P={width:0,height:0};try{P=yield e.waitForDimensions()}catch{const w=(u=(c=this.roomOptions.videoCaptureDefaults)===null||c===void 0?void 0:c.resolution)!==null&&u!==void 0?u:VideoPresets.h720.resolution;P={width:w.width,height:w.height},this.log.error("could not determine track dimensions, using defaults",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(e)),{dims:P}))}R.width=P.width,R.height=P.height,e instanceof LocalVideoTrack&&(isSVCCodec(C)&&(e.source===Track.Source.ScreenShare&&(t.scalabilityMode="L1T3","contentHint"in e.mediaStreamTrack&&(e.mediaStreamTrack.contentHint="motion",this.log.info("forcing contentHint to motion for screenshare with SVC codecs",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(e))))),t.scalabilityMode=(d=t.scalabilityMode)!==null&&d!==void 0?d:"L3T3_KEY"),R.simulcastCodecs=[new SimulcastCodec({codec:C,cid:e.mediaStreamTrack.id})],t.backupCodec===!0&&(t.backupCodec={codec:defaultVideoCodec}),t.backupCodec&&C!==t.backupCodec.codec&&R.encryption===Encryption_Type.NONE&&(this.roomOptions.dynacast||(this.roomOptions.dynacast=!0),R.simulcastCodecs.push(new SimulcastCodec({codec:t.backupCodec.codec,cid:""})))),T=computeVideoEncodings(e.source===Track.Source.ScreenShare,R.width,R.height,t),R.layers=videoLayersFromEncodings(R.width,R.height,T,isSVCCodec(t.videoCodec))}else e.kind===Track.Kind.Audio&&(T=[{maxBitrate:(p=t.audioPreset)===null||p===void 0?void 0:p.maxBitrate,priority:(g=(v=t.audioPreset)===null||v===void 0?void 0:v.priority)!==null&&g!==void 0?g:"high",networkPriority:(S=(m=t.audioPreset)===null||m===void 0?void 0:m.priority)!==null&&S!==void 0?S:"high"}]);if(!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const E=()=>__awaiter$1(this,void 0,void 0,function*(){var P,_,w;if(!this.engine.pcManager)throw new UnexpectedConnectionState("pcManager is not ready");if(e.sender=yield this.engine.createSender(e,t,T),e instanceof LocalVideoTrack&&((P=t.degradationPreference)!==null&&P!==void 0||(t.degradationPreference=getDefaultDegradationPreference(e)),e.setDegradationPreference(t.degradationPreference)),T)if(isFireFox()&&e.kind===Track.Kind.Audio){let I;for(const D of this.engine.pcManager.publisher.getTransceivers())if(D.sender===e.sender){I=D;break}I&&this.engine.pcManager.publisher.setTrackCodecBitrate({transceiver:I,codec:"opus",maxbr:!((_=T[0])===null||_===void 0)&&_.maxBitrate?T[0].maxBitrate/1e3:0})}else e.codec&&isSVCCodec(e.codec)&&(!((w=T[0])===null||w===void 0)&&w.maxBitrate)&&this.engine.pcManager.publisher.setTrackCodecBitrate({cid:R.cid,codec:e.codec,maxbr:T[0].maxBitrate/1e3});yield this.engine.negotiate()});let A;if(this.enabledPublishVideoCodecs.length>0)A=(yield Promise.all([this.engine.addTrack(R),E()]))[0];else{A=yield this.engine.addTrack(R);let P;if(A.codecs.forEach(_=>{P===void 0&&(P=_.mimeType)}),P&&e.kind===Track.Kind.Video){const _=mimeTypeToVideoCodecString(P);_!==C&&(this.log.debug("falling back to server selected codec",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(e)),{codec:_})),t.videoCodec=_,T=computeVideoEncodings(e.source===Track.Source.ScreenShare,R.width,R.height,t))}yield E()}const b=new LocalTrackPublication(e.kind,A,e,{loggerName:this.roomOptions.loggerName,loggerContextCb:()=>this.logContext});return b.options=t,e.sid=A.sid,this.log.debug("publishing ".concat(e.kind," with encodings"),Object.assign(Object.assign({},this.logContext),{encodings:T,trackInfo:A})),e instanceof LocalVideoTrack?e.startMonitor(this.engine.client):e instanceof LocalAudioTrack&&e.startMonitor(),this.addTrackPublication(b),this.emit(ParticipantEvent.LocalTrackPublished,b),b})}get isLocal(){return!0}publishAdditionalCodecForTrack(e,t,s){return __awaiter$1(this,void 0,void 0,function*(){var o;if(this.encryptionType!==Encryption_Type.NONE)return;let a;if(this.trackPublications.forEach(S=>{S.track&&S.track===e&&(a=S)}),!a)throw new TrackInvalidError("track is not published");if(!(e instanceof LocalVideoTrack))throw new TrackInvalidError("track is not a video track");const c=Object.assign(Object.assign({},(o=this.roomOptions)===null||o===void 0?void 0:o.publishDefaults),s),u=computeTrackBackupEncodings(e,t,c);if(!u){this.log.info("backup codec has been disabled, ignoring request to add additional codec for track",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(e)));return}const d=e.addSimulcastTrack(t,u);if(!d)return;const p=new AddTrackRequest({cid:d.mediaStreamTrack.id,type:Track.kindToProto(e.kind),muted:e.isMuted,source:Track.sourceToProto(e.source),sid:e.sid,simulcastCodecs:[{codec:c.videoCodec,cid:d.mediaStreamTrack.id}]});if(p.layers=videoLayersFromEncodings(p.width,p.height,u),!this.engine||this.engine.isClosed)throw new UnexpectedConnectionState("cannot publish track when not connected");const v=()=>__awaiter$1(this,void 0,void 0,function*(){yield this.engine.createSimulcastSender(e,d,c,u),yield this.engine.negotiate()}),m=(yield Promise.all([this.engine.addTrack(p),v()]))[0];this.log.debug("published ".concat(t," for track ").concat(e.sid),Object.assign(Object.assign({},this.logContext),{encodings:u,trackInfo:m}))})}unpublishTrack(e,t){return __awaiter$1(this,void 0,void 0,function*(){var s,o;if(e instanceof LocalTrack){const p=this.pendingPublishPromises.get(e);p&&(this.log.info("awaiting publish promise before attempting to unpublish",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(e))),yield p)}const a=this.getPublicationForTrack(e),c=a?getLogContextFromTrack(a):void 0;if(this.log.debug("unpublishing track",Object.assign(Object.assign({},this.logContext),c)),!a||!a.track){this.log.warn("track was not unpublished because no publication was found",Object.assign(Object.assign({},this.logContext),c));return}e=a.track,e.off(TrackEvent.Muted,this.onTrackMuted),e.off(TrackEvent.Unmuted,this.onTrackUnmuted),e.off(TrackEvent.Ended,this.handleTrackEnded),e.off(TrackEvent.UpstreamPaused,this.onTrackUpstreamPaused),e.off(TrackEvent.UpstreamResumed,this.onTrackUpstreamResumed),e.off(TrackEvent.AudioTrackFeatureUpdate,this.onTrackFeatureUpdate),t===void 0&&(t=(o=(s=this.roomOptions)===null||s===void 0?void 0:s.stopLocalTrackOnUnpublish)!==null&&o!==void 0?o:!0),t&&e.stop();let u=!1;const d=e.sender;if(e.sender=void 0,this.engine.pcManager&&this.engine.pcManager.currentState<PCTransportState.FAILED&&d)try{for(const p of this.engine.pcManager.publisher.getTransceivers())p.sender===d&&(p.direction="inactive",u=!0);if(this.engine.removeTrack(d)&&(u=!0),e instanceof LocalVideoTrack){for(const[,p]of e.simulcastCodecs)p.sender&&(this.engine.removeTrack(p.sender)&&(u=!0),p.sender=void 0);e.simulcastCodecs.clear()}}catch(p){this.log.warn("failed to unpublish track",Object.assign(Object.assign(Object.assign({},this.logContext),c),{error:p}))}switch(this.trackPublications.delete(a.trackSid),a.kind){case Track.Kind.Audio:this.audioTrackPublications.delete(a.trackSid);break;case Track.Kind.Video:this.videoTrackPublications.delete(a.trackSid);break}return this.emit(ParticipantEvent.LocalTrackUnpublished,a),a.setTrack(void 0),u&&(yield this.engine.negotiate()),a})}unpublishTracks(e){return __awaiter$1(this,void 0,void 0,function*(){return(yield Promise.all(e.map(s=>this.unpublishTrack(s)))).filter(s=>s instanceof LocalTrackPublication)})}republishAllTracks(e){return __awaiter$1(this,arguments,void 0,function(t){var s=this;let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return function*(){s.republishPromise&&(yield s.republishPromise),s.republishPromise=new Promise((a,c)=>__awaiter$1(s,void 0,void 0,function*(){try{const u=[];this.trackPublications.forEach(d=>{d.track&&(t&&(d.options=Object.assign(Object.assign({},d.options),t)),u.push(d))}),yield Promise.all(u.map(d=>__awaiter$1(this,void 0,void 0,function*(){const p=d.track;yield this.unpublishTrack(p,!1),o&&!p.isMuted&&p.source!==Track.Source.ScreenShare&&p.source!==Track.Source.ScreenShareAudio&&(p instanceof LocalAudioTrack||p instanceof LocalVideoTrack)&&!p.isUserProvided&&(this.log.debug("restarting existing track",Object.assign(Object.assign({},this.logContext),{track:d.trackSid})),yield p.restartTrack()),yield this.publishOrRepublishTrack(p,d.options,!0)}))),a()}catch(u){c(u)}finally{this.republishPromise=void 0}})),yield s.republishPromise}()})}publishData(e){return __awaiter$1(this,arguments,void 0,function(t){var s=this;let o=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};return function*(){const a=o.reliable?DataPacket_Kind.RELIABLE:DataPacket_Kind.LOSSY,c=o.destinationIdentities,u=o.topic,d=new DataPacket({kind:a,value:{case:"user",value:new UserPacket({participantIdentity:s.identity,payload:t,destinationIdentities:c,topic:u})}});yield s.engine.sendDataPacket(d,a)}()})}publishDtmf(e,t){return __awaiter$1(this,void 0,void 0,function*(){const s=new DataPacket({kind:DataPacket_Kind.RELIABLE,value:{case:"sipDtmf",value:new SipDTMF({code:e,digit:t})}});yield this.engine.sendDataPacket(s,DataPacket_Kind.RELIABLE)})}sendChatMessage(e){return __awaiter$1(this,void 0,void 0,function*(){const t={id:crypto.randomUUID(),message:e,timestamp:Date.now()},s=new DataPacket({value:{case:"chatMessage",value:new ChatMessage(Object.assign(Object.assign({},t),{timestamp:protoInt64.parse(t.timestamp)}))}});return yield this.engine.sendDataPacket(s,DataPacket_Kind.RELIABLE),this.emit(ParticipantEvent.ChatMessage,t),t})}editChatMessage(e,t){return __awaiter$1(this,void 0,void 0,function*(){const s=Object.assign(Object.assign({},t),{message:e,editTimestamp:Date.now()}),o=new DataPacket({value:{case:"chatMessage",value:new ChatMessage(Object.assign(Object.assign({},s),{timestamp:protoInt64.parse(s.timestamp),editTimestamp:protoInt64.parse(s.editTimestamp)}))}});return yield this.engine.sendDataPacket(o,DataPacket_Kind.RELIABLE),this.emit(ParticipantEvent.ChatMessage,s),s})}setTrackSubscriptionPermissions(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[];this.participantTrackPermissions=t,this.allParticipantsAllowedToSubscribe=e,this.engine.client.isDisconnected||this.updateTrackSubscriptionPermissions()}setEnabledPublishCodecs(e){this.enabledPublishVideoCodecs=e.filter(t=>t.mime.split("/")[0].toLowerCase()==="video")}updateInfo(e){return e.sid!==this.sid||!super.updateInfo(e)?!1:(e.tracks.forEach(t=>{var s,o;const a=this.trackPublications.get(t.sid);if(a){const c=a.isMuted||((o=(s=a.track)===null||s===void 0?void 0:s.isUpstreamPaused)!==null&&o!==void 0?o:!1);c!==t.muted&&(this.log.debug("updating server mute state after reconcile",Object.assign(Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(a)),{mutedOnServer:c})),this.engine.client.sendMuteTrack(t.sid,c))}}),!0)}getPublicationForTrack(e){let t;return this.trackPublications.forEach(s=>{const o=s.track;o&&(e instanceof MediaStreamTrack?(o instanceof LocalAudioTrack||o instanceof LocalVideoTrack)&&o.mediaStreamTrack===e&&(t=s):e===o&&(t=s))}),t}waitForPendingPublicationOfSource(e){return __awaiter$1(this,void 0,void 0,function*(){const t=Array.from(this.pendingPublishPromises.entries()).find(s=>{let[o]=s;return o.source===e});if(t)return t[1]})}}class RemoteTrackPublication extends TrackPublication{constructor(e,t,s,o){super(e,t.sid,t.name,o),this.track=void 0,this.allowed=!0,this.disabled=!1,this.currentVideoQuality=VideoQuality.HIGH,this.handleEnded=a=>{this.setTrack(void 0),this.emit(TrackEvent.Ended,a)},this.handleVisibilityChange=a=>{this.log.debug("adaptivestream video visibility ".concat(this.trackSid,", visible=").concat(a),this.logContext),this.disabled=!a,this.emitTrackUpdate()},this.handleVideoDimensionsChange=a=>{this.log.debug("adaptivestream video dimensions ".concat(a.width,"x").concat(a.height),this.logContext),this.videoDimensions=a,this.emitTrackUpdate()},this.subscribed=s,this.updateInfo(t)}setSubscribed(e){const t=this.subscriptionStatus,s=this.permissionStatus;this.subscribed=e,e&&(this.allowed=!0);const o=new UpdateSubscription({trackSids:[this.trackSid],subscribe:this.subscribed,participantTracks:[new ParticipantTracks({participantSid:"",trackSids:[this.trackSid]})]});this.emit(TrackEvent.UpdateSubscription,o),this.emitSubscriptionUpdateIfChanged(t),this.emitPermissionUpdateIfChanged(s)}get subscriptionStatus(){return this.subscribed===!1?TrackPublication.SubscriptionStatus.Unsubscribed:super.isSubscribed?TrackPublication.SubscriptionStatus.Subscribed:TrackPublication.SubscriptionStatus.Desired}get permissionStatus(){return this.allowed?TrackPublication.PermissionStatus.Allowed:TrackPublication.PermissionStatus.NotAllowed}get isSubscribed(){return this.subscribed===!1?!1:super.isSubscribed}get isDesired(){return this.subscribed!==!1}get isEnabled(){return!this.disabled}setEnabled(e){!this.isManualOperationAllowed()||this.disabled===!e||(this.disabled=!e,this.emitTrackUpdate())}setVideoQuality(e){!this.isManualOperationAllowed()||this.currentVideoQuality===e||(this.currentVideoQuality=e,this.videoDimensions=void 0,this.emitTrackUpdate())}setVideoDimensions(e){var t,s;this.isManualOperationAllowed()&&(((t=this.videoDimensions)===null||t===void 0?void 0:t.width)===e.width&&((s=this.videoDimensions)===null||s===void 0?void 0:s.height)===e.height||(this.track instanceof RemoteVideoTrack&&(this.videoDimensions=e),this.currentVideoQuality=void 0,this.emitTrackUpdate()))}setVideoFPS(e){this.isManualOperationAllowed()&&this.track instanceof RemoteVideoTrack&&this.fps!==e&&(this.fps=e,this.emitTrackUpdate())}get videoQuality(){return this.currentVideoQuality}setTrack(e){const t=this.subscriptionStatus,s=this.permissionStatus,o=this.track;o!==e&&(o&&(o.off(TrackEvent.VideoDimensionsChanged,this.handleVideoDimensionsChange),o.off(TrackEvent.VisibilityChanged,this.handleVisibilityChange),o.off(TrackEvent.Ended,this.handleEnded),o.detach(),o.stopMonitor(),this.emit(TrackEvent.Unsubscribed,o)),super.setTrack(e),e&&(e.sid=this.trackSid,e.on(TrackEvent.VideoDimensionsChanged,this.handleVideoDimensionsChange),e.on(TrackEvent.VisibilityChanged,this.handleVisibilityChange),e.on(TrackEvent.Ended,this.handleEnded),this.emit(TrackEvent.Subscribed,e)),this.emitPermissionUpdateIfChanged(s),this.emitSubscriptionUpdateIfChanged(t))}setAllowed(e){const t=this.subscriptionStatus,s=this.permissionStatus;this.allowed=e,this.emitPermissionUpdateIfChanged(s),this.emitSubscriptionUpdateIfChanged(t)}setSubscriptionError(e){this.emit(TrackEvent.SubscriptionFailed,e)}updateInfo(e){super.updateInfo(e);const t=this.metadataMuted;this.metadataMuted=e.muted,this.track?this.track.setMuted(e.muted):t!==e.muted&&this.emit(e.muted?TrackEvent.Muted:TrackEvent.Unmuted)}emitSubscriptionUpdateIfChanged(e){const t=this.subscriptionStatus;e!==t&&this.emit(TrackEvent.SubscriptionStatusChanged,t,e)}emitPermissionUpdateIfChanged(e){this.permissionStatus!==e&&this.emit(TrackEvent.SubscriptionPermissionChanged,this.permissionStatus,e)}isManualOperationAllowed(){return this.kind===Track.Kind.Video&&this.isAdaptiveStream?(this.log.warn("adaptive stream is enabled, cannot change video track settings",this.logContext),!1):this.isDesired?!0:(this.log.warn("cannot update track settings when not subscribed",this.logContext),!1)}get isAdaptiveStream(){return this.track instanceof RemoteVideoTrack&&this.track.isAdaptiveStream}emitTrackUpdate(){const e=new UpdateTrackSettings({trackSids:[this.trackSid],disabled:this.disabled,fps:this.fps});this.videoDimensions?(e.width=Math.ceil(this.videoDimensions.width),e.height=Math.ceil(this.videoDimensions.height)):this.currentVideoQuality!==void 0?e.quality=this.currentVideoQuality:e.quality=VideoQuality.HIGH,this.emit(TrackEvent.UpdateSettings,e)}}class RemoteParticipant extends Participant{static fromParticipantInfo(e,t,s){return new RemoteParticipant(e,t.sid,t.identity,t.name,t.metadata,s,t.kind)}get logContext(){return Object.assign(Object.assign({},super.logContext),{rpID:this.sid,remoteParticipant:this.identity})}constructor(e,t,s,o,a,c){let u=arguments.length>6&&arguments[6]!==void 0?arguments[6]:ParticipantInfo_Kind.STANDARD;super(t,s||"",o,a,c,u),this.signalClient=e,this.trackPublications=new Map,this.audioTrackPublications=new Map,this.videoTrackPublications=new Map,this.volumeMap=new Map}addTrackPublication(e){super.addTrackPublication(e),e.on(TrackEvent.UpdateSettings,t=>{this.log.debug("send update settings",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(e))),this.signalClient.sendUpdateTrackSettings(t)}),e.on(TrackEvent.UpdateSubscription,t=>{t.participantTracks.forEach(s=>{s.participantSid=this.sid}),this.signalClient.sendUpdateSubscription(t)}),e.on(TrackEvent.SubscriptionPermissionChanged,t=>{this.emit(ParticipantEvent.TrackSubscriptionPermissionChanged,e,t)}),e.on(TrackEvent.SubscriptionStatusChanged,t=>{this.emit(ParticipantEvent.TrackSubscriptionStatusChanged,e,t)}),e.on(TrackEvent.Subscribed,t=>{this.emit(ParticipantEvent.TrackSubscribed,t,e)}),e.on(TrackEvent.Unsubscribed,t=>{this.emit(ParticipantEvent.TrackUnsubscribed,t,e)}),e.on(TrackEvent.SubscriptionFailed,t=>{this.emit(ParticipantEvent.TrackSubscriptionFailed,e.trackSid,t)})}getTrackPublication(e){const t=super.getTrackPublication(e);if(t)return t}getTrackPublicationByName(e){const t=super.getTrackPublicationByName(e);if(t)return t}setVolume(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Track.Source.Microphone;this.volumeMap.set(t,e);const s=this.getTrackPublication(t);s&&s.track&&s.track.setVolume(e)}getVolume(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Track.Source.Microphone;const t=this.getTrackPublication(e);return t&&t.track?t.track.getVolume():this.volumeMap.get(e)}addSubscribedMediaTrack(e,t,s,o,a,c){let u=this.getTrackPublicationBySid(t);if(u||t.startsWith("TR")||this.trackPublications.forEach(v=>{!u&&e.kind===v.kind.toString()&&(u=v)}),!u){if(c===0){this.log.error("could not find published track",Object.assign(Object.assign({},this.logContext),{trackSid:t})),this.emit(ParticipantEvent.TrackSubscriptionFailed,t);return}c===void 0&&(c=20),setTimeout(()=>{this.addSubscribedMediaTrack(e,t,s,o,a,c-1)},150);return}if(e.readyState==="ended"){this.log.error("unable to subscribe because MediaStreamTrack is ended. Do not call MediaStreamTrack.stop()",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(u))),this.emit(ParticipantEvent.TrackSubscriptionFailed,t);return}const d=e.kind==="video";let p;return d?p=new RemoteVideoTrack(e,t,o,a):p=new RemoteAudioTrack(e,t,o,this.audioContext,this.audioOutput),p.source=u.source,p.isMuted=u.isMuted,p.setMediaStream(s),p.start(),u.setTrack(p),this.volumeMap.has(u.source)&&p instanceof RemoteAudioTrack&&p.setVolume(this.volumeMap.get(u.source)),u}get hasMetadata(){return!!this.participantInfo}getTrackPublicationBySid(e){return this.trackPublications.get(e)}updateInfo(e){if(!super.updateInfo(e))return!1;const t=new Map,s=new Map;return e.tracks.forEach(o=>{var a,c;let u=this.getTrackPublicationBySid(o.sid);if(u)u.updateInfo(o);else{const d=Track.kindFromProto(o.type);if(!d)return;u=new RemoteTrackPublication(d,o,(a=this.signalClient.connectOptions)===null||a===void 0?void 0:a.autoSubscribe,{loggerContextCb:()=>this.logContext,loggerName:(c=this.loggerOptions)===null||c===void 0?void 0:c.loggerName}),u.updateInfo(o),s.set(o.sid,u);const p=Array.from(this.trackPublications.values()).find(v=>v.source===(u==null?void 0:u.source));p&&u.source!==Track.Source.Unknown&&this.log.debug("received a second track publication for ".concat(this.identity," with the same source: ").concat(u.source),Object.assign(Object.assign({},this.logContext),{oldTrack:getLogContextFromTrack(p),newTrack:getLogContextFromTrack(u)})),this.addTrackPublication(u)}t.set(o.sid,u)}),this.trackPublications.forEach(o=>{t.has(o.trackSid)||(this.log.trace("detected removed track on remote participant, unpublishing",Object.assign(Object.assign({},this.logContext),getLogContextFromTrack(o))),this.unpublishTrack(o.trackSid,!0))}),s.forEach(o=>{this.emit(ParticipantEvent.TrackPublished,o)}),!0}unpublishTrack(e,t){const s=this.trackPublications.get(e);if(!s)return;const{track:o}=s;switch(o&&(o.stop(),s.setTrack(void 0)),this.trackPublications.delete(e),s.kind){case Track.Kind.Audio:this.audioTrackPublications.delete(e);break;case Track.Kind.Video:this.videoTrackPublications.delete(e);break}t&&this.emit(ParticipantEvent.TrackUnpublished,s)}setAudioOutput(e){return __awaiter$1(this,void 0,void 0,function*(){this.audioOutput=e;const t=[];this.audioTrackPublications.forEach(s=>{var o;s.track instanceof RemoteAudioTrack&&t.push(s.track.setSinkId((o=e.deviceId)!==null&&o!==void 0?o:"default"))}),yield Promise.all(t)})}emit(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),o=1;o<t;o++)s[o-1]=arguments[o];return this.log.trace("participant event",Object.assign(Object.assign({},this.logContext),{event:e,args:s})),super.emit(e,...s)}}var ConnectionState;(function(i){i.Disconnected="disconnected",i.Connecting="connecting",i.Connected="connected",i.Reconnecting="reconnecting",i.SignalReconnecting="signalReconnecting"})(ConnectionState||(ConnectionState={}));const connectionReconcileFrequency=4*1e3;class Room extends eventsExports.EventEmitter{constructor(e){var t,s,o;super(),t=this,this.state=ConnectionState.Disconnected,this.activeSpeakers=[],this.isE2EEEnabled=!1,this.audioEnabled=!0,this.isVideoPlaybackBlocked=!1,this.log=livekitLogger,this.bufferedEvents=[],this.isResuming=!1,this.connect=(a,c,u)=>__awaiter$1(this,void 0,void 0,function*(){var d;if(!isBrowserSupported())throw isReactNative()?Error("WebRTC isn't detected, have you called registerGlobals?"):Error("LiveKit doesn't seem to be supported on this browser. Try to update your browser and make sure no browser extensions are disabling webRTC.");const p=yield this.disconnectLock.lock();if(this.state===ConnectionState.Connected)return this.log.info("already connected to room ".concat(this.name),this.logContext),p(),Promise.resolve();if(this.connectFuture)return p(),this.connectFuture.promise;this.setAndEmitConnectionState(ConnectionState.Connecting),((d=this.regionUrlProvider)===null||d===void 0?void 0:d.getServerUrl().toString())!==a&&(this.regionUrl=void 0,this.regionUrlProvider=void 0),isCloud(new URL(a))&&(this.regionUrlProvider===void 0?this.regionUrlProvider=new RegionUrlProvider(a,c):this.regionUrlProvider.updateToken(c),this.regionUrlProvider.fetchRegionSettings().then(m=>{var S;(S=this.regionUrlProvider)===null||S===void 0||S.setServerReportedRegions(m)}).catch(m=>{this.log.warn("could not fetch region settings",Object.assign(Object.assign({},this.logContext),{error:m}))}));const v=(m,S,y)=>__awaiter$1(this,void 0,void 0,function*(){var C,R;this.abortController&&this.abortController.abort();const T=new AbortController;this.abortController=T,p==null||p();try{yield this.attemptConnection(y??a,c,u,T),this.abortController=void 0,m()}catch(E){if(this.regionUrlProvider&&E instanceof ConnectionError&&E.reason!==ConnectionErrorReason.Cancelled&&E.reason!==ConnectionErrorReason.NotAllowed){let A=null;try{A=yield this.regionUrlProvider.getNextBestRegionUrl((C=this.abortController)===null||C===void 0?void 0:C.signal)}catch(b){if(b instanceof ConnectionError&&(b.status===401||b.reason===ConnectionErrorReason.Cancelled)){this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),S(b);return}}A&&!(!((R=this.abortController)===null||R===void 0)&&R.signal.aborted)?(this.log.info("Initial connection failed with ConnectionError: ".concat(E.message,". Retrying with another region: ").concat(A),this.logContext),this.recreateEngine(),yield v(m,S,A)):(this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),S(E))}else this.handleDisconnect(this.options.stopLocalTrackOnUnpublish),S(E)}}),g=this.regionUrl;return this.regionUrl=void 0,this.connectFuture=new Future((m,S)=>{v(m,S,g)},()=>{this.clearConnectionFutures()}),this.connectFuture.promise}),this.connectSignal=(a,c,u,d,p,v)=>__awaiter$1(this,void 0,void 0,function*(){var g,m,S;const y=yield u.join(a,c,{autoSubscribe:d.autoSubscribe,adaptiveStream:typeof p.adaptiveStream=="object"?!0:p.adaptiveStream,maxRetries:d.maxRetries,e2eeEnabled:!!this.e2eeManager,websocketTimeout:d.websocketTimeout},v.signal);let C=y.serverInfo;if(C||(C={version:y.serverVersion,region:y.serverRegion}),this.serverInfo=C,this.log.debug("connected to Livekit Server ".concat(Object.entries(C).map(R=>{let[T,E]=R;return"".concat(T,": ").concat(E)}).join(", ")),{room:(g=y.room)===null||g===void 0?void 0:g.name,roomSid:(m=y.room)===null||m===void 0?void 0:m.sid,identity:(S=y.participant)===null||S===void 0?void 0:S.identity}),!C.version)throw new UnsupportedServer("unknown server version");return C.version==="0.15.1"&&this.options.dynacast&&(this.log.debug("disabling dynacast due to server version",this.logContext),p.dynacast=!1),y}),this.applyJoinResponse=a=>{const c=a.participant;if(this.localParticipant.sid=c.sid,this.localParticipant.identity=c.identity,this.localParticipant.setEnabledPublishCodecs(a.enabledPublishCodecs),this.options.e2ee&&this.e2eeManager)try{this.e2eeManager.setSifTrailer(a.sifTrailer)}catch(u){this.log.error(u instanceof Error?u.message:"Could not set SifTrailer",Object.assign(Object.assign({},this.logContext),{error:u}))}this.handleParticipantUpdates([c,...a.otherParticipants]),a.room&&this.handleRoomUpdate(a.room)},this.attemptConnection=(a,c,u,d)=>__awaiter$1(this,void 0,void 0,function*(){var p,v,g;this.state===ConnectionState.Reconnecting||this.isResuming||!((p=this.engine)===null||p===void 0)&&p.pendingReconnect?(this.log.info("Reconnection attempt replaced by new connection attempt",this.logContext),this.recreateEngine()):this.maybeCreateEngine(),!((v=this.regionUrlProvider)===null||v===void 0)&&v.isCloud()&&this.engine.setRegionUrlProvider(this.regionUrlProvider),this.acquireAudioContext(),this.connOptions=Object.assign(Object.assign({},roomConnectOptionDefaults),u),this.connOptions.rtcConfig&&(this.engine.rtcConfig=this.connOptions.rtcConfig),this.connOptions.peerConnectionTimeout&&(this.engine.peerConnectionTimeout=this.connOptions.peerConnectionTimeout);try{const m=yield this.connectSignal(a,c,this.engine,this.connOptions,this.options,d);this.applyJoinResponse(m),this.setupLocalParticipantEvents(),this.emit(RoomEvent.SignalConnected)}catch(m){yield this.engine.close(),this.recreateEngine();const S=new ConnectionError("could not establish signal connection");throw m instanceof Error&&(S.message="".concat(S.message,": ").concat(m.message)),m instanceof ConnectionError&&(S.reason=m.reason,S.status=m.status),this.log.debug("error trying to establish signal connection",Object.assign(Object.assign({},this.logContext),{error:m})),S}if(d.signal.aborted)throw yield this.engine.close(),this.recreateEngine(),new ConnectionError("Connection attempt aborted");try{yield this.engine.waitForPCInitialConnection(this.connOptions.peerConnectionTimeout,d)}catch(m){throw yield this.engine.close(),this.recreateEngine(),m}isWeb()&&this.options.disconnectOnPageLeave&&(window.addEventListener("pagehide",this.onPageLeave),window.addEventListener("beforeunload",this.onPageLeave)),isWeb()&&(document.addEventListener("freeze",this.onPageLeave),(g=navigator.mediaDevices)===null||g===void 0||g.addEventListener("devicechange",this.handleDeviceChange)),this.setAndEmitConnectionState(ConnectionState.Connected),this.emit(RoomEvent.Connected),this.registerConnectionReconcile()}),this.disconnect=function(){for(var a=arguments.length,c=new Array(a),u=0;u<a;u++)c[u]=arguments[u];return __awaiter$1(t,[...c],void 0,function(){var d=this;let p=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0;return function*(){var v,g,m,S;const y=yield d.disconnectLock.lock();try{if(d.state===ConnectionState.Disconnected){d.log.debug("already disconnected",d.logContext);return}d.log.info("disconnect from room",Object.assign({},d.logContext)),(d.state===ConnectionState.Connecting||d.state===ConnectionState.Reconnecting||d.isResuming)&&(d.log.warn("abort connection attempt",d.logContext),(v=d.abortController)===null||v===void 0||v.abort(),(m=(g=d.connectFuture)===null||g===void 0?void 0:g.reject)===null||m===void 0||m.call(g,new ConnectionError("Client initiated disconnect")),d.connectFuture=void 0),!((S=d.engine)===null||S===void 0)&&S.client.isDisconnected||(yield d.engine.client.sendLeave()),d.engine&&(yield d.engine.close()),d.handleDisconnect(p,DisconnectReason.CLIENT_INITIATED),d.engine=void 0}finally{y()}}()})},this.onPageLeave=()=>__awaiter$1(this,void 0,void 0,function*(){this.log.info("Page leave detected, disconnecting",this.logContext),yield this.disconnect()}),this.startAudio=()=>__awaiter$1(this,void 0,void 0,function*(){const a=[],c=getBrowser();if(c&&c.os==="iOS"){const u="livekit-dummy-audio-el";let d=document.getElementById(u);if(!d){d=document.createElement("audio"),d.id=u,d.autoplay=!0,d.hidden=!0;const p=getEmptyAudioStreamTrack();p.enabled=!0;const v=new MediaStream([p]);d.srcObject=v,document.addEventListener("visibilitychange",()=>{d&&(d.srcObject=document.hidden?null:v,document.hidden||(this.log.debug("page visible again, triggering startAudio to resume playback and update playback status",this.logContext),this.startAudio()))}),document.body.append(d),this.once(RoomEvent.Disconnected,()=>{d==null||d.remove(),d=null})}a.push(d)}this.remoteParticipants.forEach(u=>{u.audioTrackPublications.forEach(d=>{d.track&&d.track.attachedElements.forEach(p=>{a.push(p)})})});try{yield Promise.all([this.acquireAudioContext(),...a.map(u=>(u.muted=!1,u.play()))]),this.handleAudioPlaybackStarted()}catch(u){throw this.handleAudioPlaybackFailed(u),u}}),this.startVideo=()=>__awaiter$1(this,void 0,void 0,function*(){const a=[];for(const c of this.remoteParticipants.values())c.videoTrackPublications.forEach(u=>{var d;(d=u.track)===null||d===void 0||d.attachedElements.forEach(p=>{a.includes(p)||a.push(p)})});yield Promise.all(a.map(c=>c.play())).then(()=>{this.handleVideoPlaybackStarted()}).catch(c=>{c.name==="NotAllowedError"?this.handleVideoPlaybackFailed():this.log.warn("Resuming video playback failed, make sure you call `startVideo` directly in a user gesture handler",this.logContext)})}),this.handleRestarting=()=>{this.clearConnectionReconcile(),this.isResuming=!1;for(const a of this.remoteParticipants.values())this.handleParticipantDisconnected(a.identity,a);this.setAndEmitConnectionState(ConnectionState.Reconnecting)&&this.emit(RoomEvent.Reconnecting)},this.handleSignalRestarted=a=>__awaiter$1(this,void 0,void 0,function*(){this.log.debug("signal reconnected to server, region ".concat(a.serverRegion),Object.assign(Object.assign({},this.logContext),{region:a.serverRegion})),this.bufferedEvents=[],this.applyJoinResponse(a);try{yield this.localParticipant.republishAllTracks(void 0,!0)}catch(c){this.log.error("error trying to re-publish tracks after reconnection",Object.assign(Object.assign({},this.logContext),{error:c}))}try{yield this.engine.waitForRestarted(),this.log.debug("fully reconnected to server",Object.assign(Object.assign({},this.logContext),{region:a.serverRegion}))}catch{return}this.setAndEmitConnectionState(ConnectionState.Connected),this.emit(RoomEvent.Reconnected),this.registerConnectionReconcile(),this.emitBufferedEvents()}),this.handleParticipantUpdates=a=>{a.forEach(c=>{var u;if(c.identity===this.localParticipant.identity){this.localParticipant.updateInfo(c);return}c.identity===""&&(c.identity=(u=this.sidToIdentity.get(c.sid))!==null&&u!==void 0?u:"");let d=this.remoteParticipants.get(c.identity);c.state===ParticipantInfo_State.DISCONNECTED?this.handleParticipantDisconnected(c.identity,d):d=this.getOrCreateParticipant(c.identity,c)})},this.handleActiveSpeakersUpdate=a=>{const c=[],u={};a.forEach(d=>{if(u[d.sid]=!0,d.sid===this.localParticipant.sid)this.localParticipant.audioLevel=d.level,this.localParticipant.setIsSpeaking(!0),c.push(this.localParticipant);else{const p=this.getRemoteParticipantBySid(d.sid);p&&(p.audioLevel=d.level,p.setIsSpeaking(!0),c.push(p))}}),u[this.localParticipant.sid]||(this.localParticipant.audioLevel=0,this.localParticipant.setIsSpeaking(!1)),this.remoteParticipants.forEach(d=>{u[d.sid]||(d.audioLevel=0,d.setIsSpeaking(!1))}),this.activeSpeakers=c,this.emitWhenConnected(RoomEvent.ActiveSpeakersChanged,c)},this.handleSpeakersChanged=a=>{const c=new Map;this.activeSpeakers.forEach(d=>{const p=this.remoteParticipants.get(d.identity);p&&p.sid!==d.sid||c.set(d.sid,d)}),a.forEach(d=>{let p=this.getRemoteParticipantBySid(d.sid);d.sid===this.localParticipant.sid&&(p=this.localParticipant),p&&(p.audioLevel=d.level,p.setIsSpeaking(d.active),d.active?c.set(d.sid,p):c.delete(d.sid))});const u=Array.from(c.values());u.sort((d,p)=>p.audioLevel-d.audioLevel),this.activeSpeakers=u,this.emitWhenConnected(RoomEvent.ActiveSpeakersChanged,u)},this.handleStreamStateUpdate=a=>{a.streamStates.forEach(c=>{const u=this.getRemoteParticipantBySid(c.participantSid);if(!u)return;const d=u.getTrackPublicationBySid(c.trackSid);if(!d||!d.track)return;const p=Track.streamStateFromProto(c.state);p!==d.track.streamState&&(d.track.streamState=p,u.emit(ParticipantEvent.TrackStreamStateChanged,d,d.track.streamState),this.emitWhenConnected(RoomEvent.TrackStreamStateChanged,d,d.track.streamState,u))})},this.handleSubscriptionPermissionUpdate=a=>{const c=this.getRemoteParticipantBySid(a.participantSid);if(!c)return;const u=c.getTrackPublicationBySid(a.trackSid);u&&u.setAllowed(a.allowed)},this.handleSubscriptionError=a=>{const c=Array.from(this.remoteParticipants.values()).find(d=>d.trackPublications.has(a.trackSid));if(!c)return;const u=c.getTrackPublicationBySid(a.trackSid);u&&u.setSubscriptionError(a.err)},this.handleDataPacket=a=>{const c=this.remoteParticipants.get(a.participantIdentity);a.value.case==="user"?this.handleUserPacket(c,a.value.value,a.kind):a.value.case==="transcription"?this.handleTranscription(c,a.value.value):a.value.case==="sipDtmf"?this.handleSipDtmf(c,a.value.value):a.value.case==="chatMessage"?this.handleChatMessage(c,a.value.value):a.value.case==="metrics"&&this.handleMetrics(a.value.value,c)},this.handleUserPacket=(a,c,u)=>{this.emit(RoomEvent.DataReceived,c.payload,a,u,c.topic),a==null||a.emit(ParticipantEvent.DataReceived,c.payload,u)},this.handleSipDtmf=(a,c)=>{this.emit(RoomEvent.SipDTMFReceived,c,a),a==null||a.emit(ParticipantEvent.SipDTMFReceived,c)},this.bufferedSegments=new Map,this.handleTranscription=(a,c)=>{const u=c.transcribedParticipantIdentity===this.localParticipant.identity?this.localParticipant:this.getParticipantByIdentity(c.transcribedParticipantIdentity),d=u==null?void 0:u.trackPublications.get(c.trackId),p=extractTranscriptionSegments(c,this.transcriptionReceivedTimes);d==null||d.emit(TrackEvent.TranscriptionReceived,p),u==null||u.emit(ParticipantEvent.TranscriptionReceived,p,d),this.emit(RoomEvent.TranscriptionReceived,p,u,d)},this.handleChatMessage=(a,c)=>{const u=extractChatMessage(c);this.emit(RoomEvent.ChatMessage,u,a)},this.handleMetrics=(a,c)=>{this.emit(RoomEvent.MetricsReceived,a,c)},this.handleAudioPlaybackStarted=()=>{this.canPlaybackAudio||(this.audioEnabled=!0,this.emit(RoomEvent.AudioPlaybackStatusChanged,!0))},this.handleAudioPlaybackFailed=a=>{this.log.warn("could not playback audio",Object.assign(Object.assign({},this.logContext),{error:a})),this.canPlaybackAudio&&(this.audioEnabled=!1,this.emit(RoomEvent.AudioPlaybackStatusChanged,!1))},this.handleVideoPlaybackStarted=()=>{this.isVideoPlaybackBlocked&&(this.isVideoPlaybackBlocked=!1,this.emit(RoomEvent.VideoPlaybackStatusChanged,!0))},this.handleVideoPlaybackFailed=()=>{this.isVideoPlaybackBlocked||(this.isVideoPlaybackBlocked=!0,this.emit(RoomEvent.VideoPlaybackStatusChanged,!1))},this.handleDeviceChange=()=>__awaiter$1(this,void 0,void 0,function*(){const a=yield DeviceManager.getInstance().getDevices(void 0,!1),c=["audiooutput"];for(let u of c){const d=a.filter(p=>p.kind===u);d.length>0&&!d.find(p=>p.deviceId===this.getActiveDevice(u))&&(yield this.switchActiveDevice(u,d[0].deviceId))}this.emit(RoomEvent.MediaDevicesChanged)}),this.handleRoomUpdate=a=>{const c=this.roomInfo;this.roomInfo=a,c&&c.metadata!==a.metadata&&this.emitWhenConnected(RoomEvent.RoomMetadataChanged,a.metadata),(c==null?void 0:c.activeRecording)!==a.activeRecording&&this.emitWhenConnected(RoomEvent.RecordingStatusChanged,a.activeRecording)},this.handleConnectionQualityUpdate=a=>{a.updates.forEach(c=>{if(c.participantSid===this.localParticipant.sid){this.localParticipant.setConnectionQuality(c.quality);return}const u=this.getRemoteParticipantBySid(c.participantSid);u&&u.setConnectionQuality(c.quality)})},this.onLocalParticipantMetadataChanged=a=>{this.emit(RoomEvent.ParticipantMetadataChanged,a,this.localParticipant)},this.onLocalParticipantNameChanged=a=>{this.emit(RoomEvent.ParticipantNameChanged,a,this.localParticipant)},this.onLocalAttributesChanged=a=>{this.emit(RoomEvent.ParticipantAttributesChanged,a,this.localParticipant)},this.onLocalTrackMuted=a=>{this.emit(RoomEvent.TrackMuted,a,this.localParticipant)},this.onLocalTrackUnmuted=a=>{this.emit(RoomEvent.TrackUnmuted,a,this.localParticipant)},this.onTrackProcessorUpdate=a=>{var c;(c=a==null?void 0:a.onPublish)===null||c===void 0||c.call(a,this)},this.onLocalTrackPublished=a=>__awaiter$1(this,void 0,void 0,function*(){var c,u,d,p,v,g;(c=a.track)===null||c===void 0||c.on(TrackEvent.TrackProcessorUpdate,this.onTrackProcessorUpdate),(u=a.track)===null||u===void 0||u.on(TrackEvent.Restarted,this.onLocalTrackRestarted),(v=(p=(d=a.track)===null||d===void 0?void 0:d.getProcessor())===null||p===void 0?void 0:p.onPublish)===null||v===void 0||v.call(p,this),this.emit(RoomEvent.LocalTrackPublished,a,this.localParticipant),a.track instanceof LocalAudioTrack&&(yield a.track.checkForSilence())&&this.emit(RoomEvent.LocalAudioSilenceDetected,a);const m=yield(g=a.track)===null||g===void 0?void 0:g.getDeviceId(),S=sourceToKind(a.source);S&&m&&m!==this.localParticipant.activeDeviceMap.get(S)&&(this.localParticipant.activeDeviceMap.set(S,m),this.emit(RoomEvent.ActiveDeviceChanged,S,m))}),this.onLocalTrackUnpublished=a=>{var c,u;(c=a.track)===null||c===void 0||c.off(TrackEvent.TrackProcessorUpdate,this.onTrackProcessorUpdate),(u=a.track)===null||u===void 0||u.off(TrackEvent.Restarted,this.onLocalTrackRestarted),this.emit(RoomEvent.LocalTrackUnpublished,a,this.localParticipant)},this.onLocalTrackRestarted=a=>__awaiter$1(this,void 0,void 0,function*(){const c=yield a.getDeviceId(!1),u=sourceToKind(a.source);u&&c&&c!==this.localParticipant.activeDeviceMap.get(u)&&(this.log.debug("local track restarted, setting ".concat(u," ").concat(c," active"),this.logContext),this.localParticipant.activeDeviceMap.set(u,c),this.emit(RoomEvent.ActiveDeviceChanged,u,c))}),this.onLocalConnectionQualityChanged=a=>{this.emit(RoomEvent.ConnectionQualityChanged,a,this.localParticipant)},this.onMediaDevicesError=a=>{this.emit(RoomEvent.MediaDevicesError,a)},this.onLocalParticipantPermissionsChanged=a=>{this.emit(RoomEvent.ParticipantPermissionsChanged,a,this.localParticipant)},this.onLocalChatMessageSent=a=>{this.emit(RoomEvent.ChatMessage,a,this.localParticipant)},this.setMaxListeners(100),this.remoteParticipants=new Map,this.sidToIdentity=new Map,this.options=Object.assign(Object.assign({},roomOptionDefaults),e),this.log=getLogger((s=this.options.loggerName)!==null&&s!==void 0?s:LoggerNames.Room),this.transcriptionReceivedTimes=new Map,this.options.audioCaptureDefaults=Object.assign(Object.assign({},audioDefaults),e==null?void 0:e.audioCaptureDefaults),this.options.videoCaptureDefaults=Object.assign(Object.assign({},videoDefaults),e==null?void 0:e.videoCaptureDefaults),this.options.publishDefaults=Object.assign(Object.assign({},publishDefaults),e==null?void 0:e.publishDefaults),this.maybeCreateEngine(),this.disconnectLock=new h,this.localParticipant=new LocalParticipant("","",this.engine,this.options),this.options.videoCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("videoinput",unwrapConstraint(this.options.videoCaptureDefaults.deviceId)),this.options.audioCaptureDefaults.deviceId&&this.localParticipant.activeDeviceMap.set("audioinput",unwrapConstraint(this.options.audioCaptureDefaults.deviceId)),!((o=this.options.audioOutput)===null||o===void 0)&&o.deviceId&&this.switchActiveDevice("audiooutput",unwrapConstraint(this.options.audioOutput.deviceId)).catch(a=>this.log.warn("Could not set audio output: ".concat(a.message),this.logContext)),this.options.e2ee&&this.setupE2EE()}setE2EEEnabled(e){return __awaiter$1(this,void 0,void 0,function*(){if(this.e2eeManager)yield Promise.all([this.localParticipant.setE2EEEnabled(e)]),this.localParticipant.identity!==""&&this.e2eeManager.setParticipantCryptorEnabled(e,this.localParticipant.identity);else throw Error("e2ee not configured, please set e2ee settings within the room options")})}setupE2EE(){var e;this.options.e2ee&&(this.e2eeManager=new E2EEManager(this.options.e2ee),this.e2eeManager.on(EncryptionEvent.ParticipantEncryptionStatusChanged,(t,s)=>{s instanceof LocalParticipant&&(this.isE2EEEnabled=t),this.emit(RoomEvent.ParticipantEncryptionStatusChanged,t,s)}),this.e2eeManager.on(EncryptionEvent.EncryptionError,t=>this.emit(RoomEvent.EncryptionError,t)),(e=this.e2eeManager)===null||e===void 0||e.setup(this))}get logContext(){var e;return{room:this.name,roomID:(e=this.roomInfo)===null||e===void 0?void 0:e.sid,participant:this.localParticipant.identity,pID:this.localParticipant.sid}}get isRecording(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.activeRecording)!==null&&t!==void 0?t:!1}getSid(){return __awaiter$1(this,void 0,void 0,function*(){return this.state===ConnectionState.Disconnected?"":this.roomInfo&&this.roomInfo.sid!==""?this.roomInfo.sid:new Promise((e,t)=>{const s=o=>{o.sid!==""&&(this.engine.off(EngineEvent.RoomUpdate,s),e(o.sid))};this.engine.on(EngineEvent.RoomUpdate,s),this.once(RoomEvent.Disconnected,()=>{this.engine.off(EngineEvent.RoomUpdate,s),t("Room disconnected before room server id was available")})})})}get name(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.name)!==null&&t!==void 0?t:""}get metadata(){var e;return(e=this.roomInfo)===null||e===void 0?void 0:e.metadata}get numParticipants(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numParticipants)!==null&&t!==void 0?t:0}get numPublishers(){var e,t;return(t=(e=this.roomInfo)===null||e===void 0?void 0:e.numPublishers)!==null&&t!==void 0?t:0}maybeCreateEngine(){this.engine&&!this.engine.isClosed||(this.engine=new RTCEngine(this.options),this.engine.on(EngineEvent.ParticipantUpdate,this.handleParticipantUpdates).on(EngineEvent.RoomUpdate,this.handleRoomUpdate).on(EngineEvent.SpeakersChanged,this.handleSpeakersChanged).on(EngineEvent.StreamStateChanged,this.handleStreamStateUpdate).on(EngineEvent.ConnectionQualityUpdate,this.handleConnectionQualityUpdate).on(EngineEvent.SubscriptionError,this.handleSubscriptionError).on(EngineEvent.SubscriptionPermissionUpdate,this.handleSubscriptionPermissionUpdate).on(EngineEvent.MediaTrackAdded,(e,t,s)=>{this.onTrackAdded(e,t,s)}).on(EngineEvent.Disconnected,e=>{this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,e)}).on(EngineEvent.ActiveSpeakersUpdate,this.handleActiveSpeakersUpdate).on(EngineEvent.DataPacketReceived,this.handleDataPacket).on(EngineEvent.Resuming,()=>{this.clearConnectionReconcile(),this.isResuming=!0,this.log.info("Resuming signal connection",this.logContext),this.setAndEmitConnectionState(ConnectionState.SignalReconnecting)&&this.emit(RoomEvent.SignalReconnecting)}).on(EngineEvent.Resumed,()=>{this.registerConnectionReconcile(),this.isResuming=!1,this.log.info("Resumed signal connection",this.logContext),this.updateSubscriptions(),this.emitBufferedEvents(),this.setAndEmitConnectionState(ConnectionState.Connected)&&this.emit(RoomEvent.Reconnected)}).on(EngineEvent.SignalResumed,()=>{this.bufferedEvents=[],(this.state===ConnectionState.Reconnecting||this.isResuming)&&this.sendSyncState()}).on(EngineEvent.Restarting,this.handleRestarting).on(EngineEvent.SignalRestarted,this.handleSignalRestarted).on(EngineEvent.Offline,()=>{this.setAndEmitConnectionState(ConnectionState.Reconnecting)&&this.emit(RoomEvent.Reconnecting)}).on(EngineEvent.DCBufferStatusChanged,(e,t)=>{this.emit(RoomEvent.DCBufferStatusChanged,e,t)}).on(EngineEvent.LocalTrackSubscribed,e=>{const t=this.localParticipant.getTrackPublications().find(s=>{let{trackSid:o}=s;return o===e});if(!t){this.log.warn("could not find local track subscription for subscribed event",this.logContext);return}this.localParticipant.emit(ParticipantEvent.LocalTrackSubscribed,t),this.emitWhenConnected(RoomEvent.LocalTrackSubscribed,t,this.localParticipant)}),this.localParticipant&&this.localParticipant.setupEngine(this.engine),this.e2eeManager&&this.e2eeManager.setupEngine(this.engine))}static getLocalDevices(e){let t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0;return DeviceManager.getInstance().getDevices(e,t)}prepareConnection(e,t){return __awaiter$1(this,void 0,void 0,function*(){if(this.state===ConnectionState.Disconnected){this.log.debug("prepareConnection to ".concat(e),this.logContext);try{if(isCloud(new URL(e))&&t){this.regionUrlProvider=new RegionUrlProvider(e,t);const s=yield this.regionUrlProvider.getNextBestRegionUrl();s&&this.state===ConnectionState.Disconnected&&(this.regionUrl=s,yield fetch(toHttpUrl(s),{method:"HEAD"}),this.log.debug("prepared connection to ".concat(s),this.logContext))}else yield fetch(toHttpUrl(e),{method:"HEAD"})}catch(s){this.log.warn("could not prepare connection",Object.assign(Object.assign({},this.logContext),{error:s}))}}})}getParticipantByIdentity(e){return this.localParticipant.identity===e?this.localParticipant:this.remoteParticipants.get(e)}clearConnectionFutures(){this.connectFuture=void 0}simulateScenario(e,t){return __awaiter$1(this,void 0,void 0,function*(){let s=()=>{},o;switch(e){case"signal-reconnect":yield this.engine.client.handleOnClose("simulate disconnect");break;case"speaker":o=new SimulateScenario({scenario:{case:"speakerUpdate",value:3}});break;case"node-failure":o=new SimulateScenario({scenario:{case:"nodeFailure",value:!0}});break;case"server-leave":o=new SimulateScenario({scenario:{case:"serverLeave",value:!0}});break;case"migration":o=new SimulateScenario({scenario:{case:"migration",value:!0}});break;case"resume-reconnect":this.engine.failNext(),yield this.engine.client.handleOnClose("simulate resume-disconnect");break;case"disconnect-signal-on-resume":s=()=>__awaiter$1(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),o=new SimulateScenario({scenario:{case:"disconnectSignalOnResume",value:!0}});break;case"disconnect-signal-on-resume-no-messages":s=()=>__awaiter$1(this,void 0,void 0,function*(){yield this.engine.client.handleOnClose("simulate resume-disconnect")}),o=new SimulateScenario({scenario:{case:"disconnectSignalOnResumeNoMessages",value:!0}});break;case"full-reconnect":this.engine.fullReconnectOnNext=!0,yield this.engine.client.handleOnClose("simulate full-reconnect");break;case"force-tcp":case"force-tls":o=new SimulateScenario({scenario:{case:"switchCandidateProtocol",value:e==="force-tls"?2:1}}),s=()=>__awaiter$1(this,void 0,void 0,function*(){const a=this.engine.client.onLeave;a&&a(new LeaveRequest({reason:DisconnectReason.CLIENT_INITIATED,action:LeaveRequest_Action.RECONNECT}))});break;case"subscriber-bandwidth":if(t===void 0||typeof t!="number")throw new Error("subscriber-bandwidth requires a number as argument");o=new SimulateScenario({scenario:{case:"subscriberBandwidth",value:BigInt(t)}});break;case"leave-full-reconnect":o=new SimulateScenario({scenario:{case:"leaveRequestFullReconnect",value:!0}})}o&&(yield this.engine.client.sendSimulateScenario(o),yield s())})}get canPlaybackAudio(){return this.audioEnabled}get canPlaybackVideo(){return!this.isVideoPlaybackBlocked}getActiveDevice(e){return this.localParticipant.activeDeviceMap.get(e)}switchActiveDevice(e,t){return __awaiter$1(this,arguments,void 0,function(s,o){var a=this;let c=arguments.length>2&&arguments[2]!==void 0?arguments[2]:!1;return function*(){var u,d,p,v,g,m,S;let y=!1,C=!0;const R=c?{exact:o}:o;if(s==="audioinput"){const T=(u=a.getActiveDevice(s))!==null&&u!==void 0?u:a.options.audioCaptureDefaults.deviceId;a.options.audioCaptureDefaults.deviceId=R,y=T!==R;const E=Array.from(a.localParticipant.audioTrackPublications.values()).filter(A=>A.source===Track.Source.Microphone);try{C=(yield Promise.all(E.map(A=>{var b;return(b=A.audioTrack)===null||b===void 0?void 0:b.setDeviceId(R)}))).every(A=>A===!0)}catch(A){throw a.options.audioCaptureDefaults.deviceId=T,A}}else if(s==="videoinput"){const T=(d=a.getActiveDevice(s))!==null&&d!==void 0?d:a.options.videoCaptureDefaults.deviceId;a.options.videoCaptureDefaults.deviceId=R,y=T!==R;const E=Array.from(a.localParticipant.videoTrackPublications.values()).filter(A=>A.source===Track.Source.Camera);try{C=(yield Promise.all(E.map(A=>{var b;return(b=A.videoTrack)===null||b===void 0?void 0:b.setDeviceId(R)}))).every(A=>A===!0)}catch(A){throw a.options.videoCaptureDefaults.deviceId=T,A}}else if(s==="audiooutput"){if(!supportsSetSinkId()&&!a.options.webAudioMix||a.options.webAudioMix&&a.audioContext&&!("setSinkId"in a.audioContext))throw new Error("cannot switch audio output, setSinkId not supported");a.options.webAudioMix&&(o=(p=yield DeviceManager.getInstance().normalizeDeviceId("audiooutput",o))!==null&&p!==void 0?p:""),(v=(S=a.options).audioOutput)!==null&&v!==void 0||(S.audioOutput={});const T=(g=a.getActiveDevice(s))!==null&&g!==void 0?g:a.options.audioOutput.deviceId;a.options.audioOutput.deviceId=o,y=T!==R;try{a.options.webAudioMix&&((m=a.audioContext)===null||m===void 0||m.setSinkId(o)),yield Promise.all(Array.from(a.remoteParticipants.values()).map(E=>E.setAudioOutput({deviceId:o})))}catch(E){throw a.options.audioOutput.deviceId=T,E}}return y&&C&&(a.localParticipant.activeDeviceMap.set(s,o),a.emit(RoomEvent.ActiveDeviceChanged,s,o)),C}()})}setupLocalParticipantEvents(){this.localParticipant.on(ParticipantEvent.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).on(ParticipantEvent.ParticipantNameChanged,this.onLocalParticipantNameChanged).on(ParticipantEvent.AttributesChanged,this.onLocalAttributesChanged).on(ParticipantEvent.TrackMuted,this.onLocalTrackMuted).on(ParticipantEvent.TrackUnmuted,this.onLocalTrackUnmuted).on(ParticipantEvent.LocalTrackPublished,this.onLocalTrackPublished).on(ParticipantEvent.LocalTrackUnpublished,this.onLocalTrackUnpublished).on(ParticipantEvent.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).on(ParticipantEvent.MediaDevicesError,this.onMediaDevicesError).on(ParticipantEvent.AudioStreamAcquired,this.startAudio).on(ParticipantEvent.ChatMessage,this.onLocalChatMessageSent).on(ParticipantEvent.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged)}recreateEngine(){var e;(e=this.engine)===null||e===void 0||e.close(),this.engine=void 0,this.isResuming=!1,this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.bufferedEvents=[],this.maybeCreateEngine()}onTrackAdded(e,t,s){if(this.state===ConnectionState.Connecting||this.state===ConnectionState.Reconnecting){const v=()=>{this.onTrackAdded(e,t,s),g()},g=()=>{this.off(RoomEvent.Reconnected,v),this.off(RoomEvent.Connected,v),this.off(RoomEvent.Disconnected,g)};this.once(RoomEvent.Reconnected,v),this.once(RoomEvent.Connected,v),this.once(RoomEvent.Disconnected,g);return}if(this.state===ConnectionState.Disconnected){this.log.warn("skipping incoming track after Room disconnected",this.logContext);return}const o=unpackStreamId(t.id),a=o[0];let c=o[1],u=e.id;if(c&&c.startsWith("TR")&&(u=c),a===this.localParticipant.sid){this.log.warn("tried to create RemoteParticipant for local participant",this.logContext);return}const d=Array.from(this.remoteParticipants.values()).find(v=>v.sid===a);if(!d){this.log.error("Tried to add a track for a participant, that's not present. Sid: ".concat(a),this.logContext);return}let p;this.options.adaptiveStream&&(typeof this.options.adaptiveStream=="object"?p=this.options.adaptiveStream:p={}),d.addSubscribedMediaTrack(e,u,t,s,p)}handleDisconnect(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:!0,t=arguments.length>1?arguments[1]:void 0;var s;if(this.clearConnectionReconcile(),this.isResuming=!1,this.bufferedEvents=[],this.transcriptionReceivedTimes.clear(),this.state!==ConnectionState.Disconnected){this.regionUrl=void 0;try{this.remoteParticipants.forEach(o=>{o.trackPublications.forEach(a=>{o.unpublishTrack(a.trackSid)})}),this.localParticipant.trackPublications.forEach(o=>{var a,c;o.track&&this.localParticipant.unpublishTrack(o.track,e),e&&((a=o.track)===null||a===void 0||a.detach(),(c=o.track)===null||c===void 0||c.stop())}),this.localParticipant.off(ParticipantEvent.ParticipantMetadataChanged,this.onLocalParticipantMetadataChanged).off(ParticipantEvent.ParticipantNameChanged,this.onLocalParticipantNameChanged).off(ParticipantEvent.AttributesChanged,this.onLocalAttributesChanged).off(ParticipantEvent.TrackMuted,this.onLocalTrackMuted).off(ParticipantEvent.TrackUnmuted,this.onLocalTrackUnmuted).off(ParticipantEvent.LocalTrackPublished,this.onLocalTrackPublished).off(ParticipantEvent.LocalTrackUnpublished,this.onLocalTrackUnpublished).off(ParticipantEvent.ConnectionQualityChanged,this.onLocalConnectionQualityChanged).off(ParticipantEvent.MediaDevicesError,this.onMediaDevicesError).off(ParticipantEvent.AudioStreamAcquired,this.startAudio).off(ParticipantEvent.ChatMessage,this.onLocalChatMessageSent).off(ParticipantEvent.ParticipantPermissionsChanged,this.onLocalParticipantPermissionsChanged),this.localParticipant.trackPublications.clear(),this.localParticipant.videoTrackPublications.clear(),this.localParticipant.audioTrackPublications.clear(),this.remoteParticipants.clear(),this.sidToIdentity.clear(),this.activeSpeakers=[],this.audioContext&&typeof this.options.webAudioMix=="boolean"&&(this.audioContext.close(),this.audioContext=void 0),isWeb()&&(window.removeEventListener("beforeunload",this.onPageLeave),window.removeEventListener("pagehide",this.onPageLeave),window.removeEventListener("freeze",this.onPageLeave),(s=navigator.mediaDevices)===null||s===void 0||s.removeEventListener("devicechange",this.handleDeviceChange))}finally{this.setAndEmitConnectionState(ConnectionState.Disconnected),this.emit(RoomEvent.Disconnected,t)}}}handleParticipantDisconnected(e,t){this.remoteParticipants.delete(e),t&&(t.trackPublications.forEach(s=>{t.unpublishTrack(s.trackSid,!0)}),this.emit(RoomEvent.ParticipantDisconnected,t))}acquireAudioContext(){return __awaiter$1(this,void 0,void 0,function*(){var e,t;if(typeof this.options.webAudioMix!="boolean"&&this.options.webAudioMix.audioContext?this.audioContext=this.options.webAudioMix.audioContext:(!this.audioContext||this.audioContext.state==="closed")&&(this.audioContext=(e=getNewAudioContext())!==null&&e!==void 0?e:void 0),this.audioContext&&this.audioContext.state==="suspended")try{yield this.audioContext.resume()}catch(o){this.log.warn("Could not resume audio context",Object.assign(Object.assign({},this.logContext),{error:o}))}this.options.webAudioMix&&this.remoteParticipants.forEach(o=>o.setAudioContext(this.audioContext)),this.localParticipant.setAudioContext(this.audioContext);const s=((t=this.audioContext)===null||t===void 0?void 0:t.state)==="running";s!==this.canPlaybackAudio&&(this.audioEnabled=s,this.emit(RoomEvent.AudioPlaybackStatusChanged,s))})}createParticipant(e,t){var s;let o;return t?o=RemoteParticipant.fromParticipantInfo(this.engine.client,t,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}):o=new RemoteParticipant(this.engine.client,"",e,void 0,void 0,{loggerContextCb:()=>this.logContext,loggerName:this.options.loggerName}),this.options.webAudioMix&&o.setAudioContext(this.audioContext),!((s=this.options.audioOutput)===null||s===void 0)&&s.deviceId&&o.setAudioOutput(this.options.audioOutput).catch(a=>this.log.warn("Could not set audio output: ".concat(a.message),this.logContext)),o}getOrCreateParticipant(e,t){if(this.remoteParticipants.has(e)){const o=this.remoteParticipants.get(e);return t&&o.updateInfo(t)&&this.sidToIdentity.set(t.sid,t.identity),o}const s=this.createParticipant(e,t);return this.remoteParticipants.set(e,s),this.sidToIdentity.set(t.sid,t.identity),this.emitWhenConnected(RoomEvent.ParticipantConnected,s),s.on(ParticipantEvent.TrackPublished,o=>{this.emitWhenConnected(RoomEvent.TrackPublished,o,s)}).on(ParticipantEvent.TrackSubscribed,(o,a)=>{o.kind===Track.Kind.Audio?(o.on(TrackEvent.AudioPlaybackStarted,this.handleAudioPlaybackStarted),o.on(TrackEvent.AudioPlaybackFailed,this.handleAudioPlaybackFailed)):o.kind===Track.Kind.Video&&(o.on(TrackEvent.VideoPlaybackFailed,this.handleVideoPlaybackFailed),o.on(TrackEvent.VideoPlaybackStarted,this.handleVideoPlaybackStarted)),this.emit(RoomEvent.TrackSubscribed,o,a,s)}).on(ParticipantEvent.TrackUnpublished,o=>{this.emit(RoomEvent.TrackUnpublished,o,s)}).on(ParticipantEvent.TrackUnsubscribed,(o,a)=>{this.emit(RoomEvent.TrackUnsubscribed,o,a,s)}).on(ParticipantEvent.TrackSubscriptionFailed,o=>{this.emit(RoomEvent.TrackSubscriptionFailed,o,s)}).on(ParticipantEvent.TrackMuted,o=>{this.emitWhenConnected(RoomEvent.TrackMuted,o,s)}).on(ParticipantEvent.TrackUnmuted,o=>{this.emitWhenConnected(RoomEvent.TrackUnmuted,o,s)}).on(ParticipantEvent.ParticipantMetadataChanged,o=>{this.emitWhenConnected(RoomEvent.ParticipantMetadataChanged,o,s)}).on(ParticipantEvent.ParticipantNameChanged,o=>{this.emitWhenConnected(RoomEvent.ParticipantNameChanged,o,s)}).on(ParticipantEvent.AttributesChanged,o=>{this.emitWhenConnected(RoomEvent.ParticipantAttributesChanged,o,s)}).on(ParticipantEvent.ConnectionQualityChanged,o=>{this.emitWhenConnected(RoomEvent.ConnectionQualityChanged,o,s)}).on(ParticipantEvent.ParticipantPermissionsChanged,o=>{this.emitWhenConnected(RoomEvent.ParticipantPermissionsChanged,o,s)}).on(ParticipantEvent.TrackSubscriptionStatusChanged,(o,a)=>{this.emitWhenConnected(RoomEvent.TrackSubscriptionStatusChanged,o,a,s)}).on(ParticipantEvent.TrackSubscriptionFailed,(o,a)=>{this.emit(RoomEvent.TrackSubscriptionFailed,o,s,a)}).on(ParticipantEvent.TrackSubscriptionPermissionChanged,(o,a)=>{this.emitWhenConnected(RoomEvent.TrackSubscriptionPermissionChanged,o,a,s)}),t&&s.updateInfo(t),s}sendSyncState(){const e=Array.from(this.remoteParticipants.values()).reduce((s,o)=>(s.push(...o.getTrackPublications()),s),[]),t=this.localParticipant.getTrackPublications();this.engine.sendSyncState(e,t)}updateSubscriptions(){for(const e of this.remoteParticipants.values())for(const t of e.videoTrackPublications.values())t.isSubscribed&&t instanceof RemoteTrackPublication&&t.emitTrackUpdate()}getRemoteParticipantBySid(e){const t=this.sidToIdentity.get(e);if(t)return this.remoteParticipants.get(t)}registerConnectionReconcile(){this.clearConnectionReconcile();let e=0;this.connectionReconcileInterval=CriticalTimers.setInterval(()=>{!this.engine||this.engine.isClosed||!this.engine.verifyTransport()?(e++,this.log.warn("detected connection state mismatch",Object.assign(Object.assign({},this.logContext),{numFailures:e,engine:{closed:this.engine.isClosed,transportsConnected:this.engine.verifyTransport()}})),e>=3&&(this.recreateEngine(),this.handleDisconnect(this.options.stopLocalTrackOnUnpublish,DisconnectReason.STATE_MISMATCH))):e=0},connectionReconcileFrequency)}clearConnectionReconcile(){this.connectionReconcileInterval&&CriticalTimers.clearInterval(this.connectionReconcileInterval)}setAndEmitConnectionState(e){return e===this.state?!1:(this.state=e,this.emit(RoomEvent.ConnectionStateChanged,this.state),!0)}emitBufferedEvents(){this.bufferedEvents.forEach(e=>{let[t,s]=e;this.emit(t,...s)}),this.bufferedEvents=[]}emitWhenConnected(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),o=1;o<t;o++)s[o-1]=arguments[o];if(this.state===ConnectionState.Reconnecting||this.isResuming||!this.engine||this.engine.pendingReconnect)this.bufferedEvents.push([e,s]);else if(this.state===ConnectionState.Connected)return this.emit(e,...s);return!1}simulateParticipants(e){return __awaiter$1(this,void 0,void 0,function*(){var t,s;const o=Object.assign({audio:!0,video:!0,useRealTracks:!1},e.publish),a=Object.assign({count:9,audio:!1,video:!0,aspectRatios:[1.66,1.7,1.3]},e.participants);if(this.handleDisconnect(),this.roomInfo=new Room$1({sid:"RM_SIMULATED",name:"simulated-room",emptyTimeout:0,maxParticipants:0,creationTime:protoInt64.parse(new Date().getTime()),metadata:"",numParticipants:1,numPublishers:1,turnPassword:"",enabledCodecs:[],activeRecording:!1}),this.localParticipant.updateInfo(new ParticipantInfo({identity:"simulated-local",name:"local-name"})),this.setupLocalParticipantEvents(),this.emit(RoomEvent.SignalConnected),this.emit(RoomEvent.Connected),this.setAndEmitConnectionState(ConnectionState.Connected),o.video){const c=new LocalTrackPublication(Track.Kind.Video,new TrackInfo({source:TrackSource.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO,name:"video-dummy"}),new LocalVideoTrack(o.useRealTracks?(yield window.navigator.mediaDevices.getUserMedia({video:!0})).getVideoTracks()[0]:createDummyVideoStreamTrack(160*((t=a.aspectRatios[0])!==null&&t!==void 0?t:1),160,!0,!0),void 0,!1,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(c),this.localParticipant.emit(ParticipantEvent.LocalTrackPublished,c)}if(o.audio){const c=new LocalTrackPublication(Track.Kind.Audio,new TrackInfo({source:TrackSource.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO}),new LocalAudioTrack(o.useRealTracks?(yield navigator.mediaDevices.getUserMedia({audio:!0})).getAudioTracks()[0]:getEmptyAudioStreamTrack(),void 0,!1,this.audioContext,{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext}),{loggerName:this.options.loggerName,loggerContextCb:()=>this.logContext});this.localParticipant.addTrackPublication(c),this.localParticipant.emit(ParticipantEvent.LocalTrackPublished,c)}for(let c=0;c<a.count-1;c+=1){let u=new ParticipantInfo({sid:Math.floor(Math.random()*1e4).toString(),identity:"simulated-".concat(c),state:ParticipantInfo_State.ACTIVE,tracks:[],joinedAt:protoInt64.parse(Date.now())});const d=this.getOrCreateParticipant(u.identity,u);if(a.video){const p=createDummyVideoStreamTrack(160*((s=a.aspectRatios[c%a.aspectRatios.length])!==null&&s!==void 0?s:1),160,!1,!0),v=new TrackInfo({source:TrackSource.CAMERA,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO});d.addSubscribedMediaTrack(p,v.sid,new MediaStream([p]),new RTCRtpReceiver),u.tracks=[...u.tracks,v]}if(a.audio){const p=getEmptyAudioStreamTrack(),v=new TrackInfo({source:TrackSource.MICROPHONE,sid:Math.floor(Math.random()*1e4).toString(),type:TrackType.AUDIO});d.addSubscribedMediaTrack(p,v.sid,new MediaStream([p]),new RTCRtpReceiver),u.tracks=[...u.tracks,v]}d.updateInfo(u)}})}emit(e){for(var t=arguments.length,s=new Array(t>1?t-1:0),o=1;o<t;o++)s[o-1]=arguments[o];if(e!==RoomEvent.ActiveSpeakersChanged){const a=mapArgs(s).filter(c=>c!==void 0);this.log.debug("room event ".concat(e),Object.assign(Object.assign({},this.logContext),{event:e,args:a}))}return super.emit(e,...s)}}function mapArgs(i){return i.map(e=>{if(e)return Array.isArray(e)?mapArgs(e):typeof e=="object"?"logContext"in e&&e.logContext:e})}var CheckStatus;(function(i){i[i.IDLE=0]="IDLE",i[i.RUNNING=1]="RUNNING",i[i.SKIPPED=2]="SKIPPED",i[i.SUCCESS=3]="SUCCESS",i[i.FAILED=4]="FAILED"})(CheckStatus||(CheckStatus={}));class Checker extends eventsExports.EventEmitter{constructor(e,t){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.status=CheckStatus.IDLE,this.logs=[],this.errorsAsWarnings=!1,this.url=e,this.token=t,this.name=this.constructor.name,this.room=new Room(s.roomOptions),this.connectOptions=s.connectOptions,s.errorsAsWarnings&&(this.errorsAsWarnings=s.errorsAsWarnings)}run(e){return __awaiter$1(this,void 0,void 0,function*(){if(this.status!==CheckStatus.IDLE)throw Error("check is running already");this.setStatus(CheckStatus.RUNNING);try{yield this.perform()}catch(t){t instanceof Error&&(this.errorsAsWarnings?this.appendWarning(t.message):this.appendError(t.message))}return yield this.disconnect(),yield new Promise(t=>setTimeout(t,500)),this.status!==CheckStatus.SKIPPED&&this.setStatus(this.isSuccess()?CheckStatus.SUCCESS:CheckStatus.FAILED),e&&e(),this.getInfo()})}isSuccess(){return!this.logs.some(e=>e.level==="error")}connect(){return __awaiter$1(this,void 0,void 0,function*(){return this.room.state===ConnectionState.Connected?this.room:(yield this.room.connect(this.url,this.token,this.connectOptions),this.room)})}disconnect(){return __awaiter$1(this,void 0,void 0,function*(){this.room&&this.room.state!==ConnectionState.Disconnected&&(yield this.room.disconnect(),yield new Promise(e=>setTimeout(e,500)))})}skip(){this.setStatus(CheckStatus.SKIPPED)}appendMessage(e){this.logs.push({level:"info",message:e}),this.emit("update",this.getInfo())}appendWarning(e){this.logs.push({level:"warning",message:e}),this.emit("update",this.getInfo())}appendError(e){this.logs.push({level:"error",message:e}),this.emit("update",this.getInfo())}setStatus(e){this.status=e,this.emit("update",this.getInfo())}get engine(){var e;return(e=this.room)===null||e===void 0?void 0:e.engine}getInfo(){return{logs:this.logs,name:this.name,status:this.status,description:this.description}}}class PublishAudioCheck extends Checker{get description(){return"Can publish audio"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var e;const t=yield this.connect(),s=yield createLocalAudioTrack();t.localParticipant.publishTrack(s),yield new Promise(c=>setTimeout(c,3e3));const o=yield(e=s.sender)===null||e===void 0?void 0:e.getStats();if(!o)throw new Error("Could not get RTCStats");let a=0;if(o.forEach(c=>{c.type==="outbound-rtp"&&(c.kind==="audio"||!c.kind&&c.mediaType==="audio")&&(a=c.packetsSent)}),a===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(a," audio packets"))})}}class PublishVideoCheck extends Checker{get description(){return"Can publish video"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var e;const t=yield this.connect(),s=yield createLocalVideoTrack();t.localParticipant.publishTrack(s),yield new Promise(c=>setTimeout(c,5e3));const o=yield(e=s.sender)===null||e===void 0?void 0:e.getStats();if(!o)throw new Error("Could not get RTCStats");let a=0;if(o.forEach(c=>{c.type==="outbound-rtp"&&(c.kind==="video"||!c.kind&&c.mediaType==="video")&&(a+=c.packetsSent)}),a===0)throw new Error("Could not determine packets are sent");this.appendMessage("published ".concat(a," video packets"))})}}class ReconnectCheck extends Checker{get description(){return"Resuming connection after interruption"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var e;const t=yield this.connect();let s=!1,o=!1,a;const c=new Promise(p=>{setTimeout(p,5e3),a=p}),u=()=>{s=!0};t.on(RoomEvent.SignalReconnecting,u).on(RoomEvent.Reconnecting,u).on(RoomEvent.Reconnected,()=>{o=!0,a(!0)}),(e=t.engine.client.ws)===null||e===void 0||e.close();const d=t.engine.client.onClose;if(d&&d(""),yield c,s){if(!o||t.state!==ConnectionState.Connected)throw this.appendWarning("reconnection is only possible in Redis-based configurations"),new Error("Not able to reconnect")}else throw new Error("Did not attempt to reconnect")})}}class TURNCheck extends Checker{get description(){return"Can connect via TURN"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var e,t;const s=new SignalClient,o=yield s.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});let a=!1,c=!1,u=!1;for(let d of o.iceServers)for(let p of d.urls)p.startsWith("turn:")?(c=!0,u=!0):p.startsWith("turns:")&&(c=!0,u=!0,a=!0),p.startsWith("stun:")&&(u=!0);u?c&&!a&&this.appendWarning("TURN is configured server side, but TURN/TLS is unavailable."):this.appendWarning("No STUN servers configured on server side."),yield s.close(),!((t=(e=this.connectOptions)===null||e===void 0?void 0:e.rtcConfig)===null||t===void 0)&&t.iceServers||c?yield this.room.connect(this.url,this.token,{rtcConfig:{iceTransportPolicy:"relay"}}):(this.appendWarning("No TURN servers configured."),this.skip(),yield new Promise(d=>setTimeout(d,0)))})}}class WebRTCCheck extends Checker{get description(){return"Establishing WebRTC connection"}perform(){return __awaiter$1(this,void 0,void 0,function*(){let e=!1,t=!1;this.room.on(RoomEvent.SignalConnected,()=>{const s=this.room.engine.client.onTrickle;this.room.engine.client.onTrickle=(o,a)=>{if(o.candidate){const c=new RTCIceCandidate(o);let u="".concat(c.protocol," ").concat(c.address,":").concat(c.port," ").concat(c.type);c.address&&(isIPPrivate(c.address)?u+=" (private)":c.protocol==="tcp"&&c.tcpType==="passive"?(e=!0,u+=" (passive)"):c.protocol==="udp"&&(t=!0)),this.appendMessage(u)}s&&s(o,a)},this.room.engine.pcManager&&(this.room.engine.pcManager.subscriber.onIceCandidateError=o=>{o instanceof RTCPeerConnectionIceErrorEvent&&this.appendWarning("error with ICE candidate: ".concat(o.errorCode," ").concat(o.errorText," ").concat(o.url))})});try{yield this.connect(),livekitLogger.info("now the room is connected")}catch(s){throw this.appendWarning("ports need to be open on firewall in order to connect."),s}e||this.appendWarning("Server is not configured for ICE/TCP"),t||this.appendWarning("No public IPv4 UDP candidates were found. Your server is likely not configured correctly")})}}function isIPPrivate(i){const e=i.split(".");if(e.length===4){if(e[0]==="10")return!0;if(e[0]==="192"&&e[1]==="168")return!0;if(e[0]==="172"){const t=parseInt(e[1],10);if(t>=16&&t<=31)return!0}}return!1}class WebSocketCheck extends Checker{get description(){return"Connecting to signal connection via WebSocket"}perform(){return __awaiter$1(this,void 0,void 0,function*(){var e,t,s;(this.url.startsWith("ws:")||this.url.startsWith("http:"))&&this.appendWarning("Server is insecure, clients may block connections to it");let o=new SignalClient;const a=yield o.join(this.url,this.token,{autoSubscribe:!0,maxRetries:0,e2eeEnabled:!1,websocketTimeout:15e3});this.appendMessage("Connected to server, version ".concat(a.serverVersion,".")),((e=a.serverInfo)===null||e===void 0?void 0:e.edition)===ServerInfo_Edition.Cloud&&(!((t=a.serverInfo)===null||t===void 0)&&t.region)&&this.appendMessage("LiveKit Cloud: ".concat((s=a.serverInfo)===null||s===void 0?void 0:s.region)),yield o.close()})}}class ConnectionCheck extends eventsExports.EventEmitter{constructor(e,t){let s=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};super(),this.options={},this.checkResults=new Map,this.url=e,this.token=t,this.options=s}getNextCheckId(){const e=this.checkResults.size;return this.checkResults.set(e,{logs:[],status:CheckStatus.IDLE,name:"",description:""}),e}updateCheck(e,t){this.checkResults.set(e,t),this.emit("checkUpdate",e,t)}isSuccess(){return Array.from(this.checkResults.values()).every(e=>e.status!==CheckStatus.FAILED)}getResults(){return Array.from(this.checkResults.values())}createAndRunCheck(e){return __awaiter$1(this,void 0,void 0,function*(){const t=this.getNextCheckId(),s=new e(this.url,this.token,this.options),o=c=>{this.updateCheck(t,c)};s.on("update",o);const a=yield s.run();return s.off("update",o),a})}checkWebsocket(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(WebSocketCheck)})}checkWebRTC(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(WebRTCCheck)})}checkTURN(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(TURNCheck)})}checkReconnect(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(ReconnectCheck)})}checkPublishAudio(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishAudioCheck)})}checkPublishVideo(){return __awaiter$1(this,void 0,void 0,function*(){return this.createAndRunCheck(PublishVideoCheck)})}}var commonjsGlobal=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function getDefaultExportFromCjs(i){return i&&i.__esModule&&Object.prototype.hasOwnProperty.call(i,"default")?i.default:i}function getAugmentedNamespace(i){if(i.__esModule)return i;var e=i.default;if(typeof e=="function"){var t=function s(){return this instanceof s?Reflect.construct(e,arguments,this.constructor):e.apply(this,arguments)};t.prototype=e.prototype}else t={};return Object.defineProperty(t,"__esModule",{value:!0}),Object.keys(i).forEach(function(s){var o=Object.getOwnPropertyDescriptor(i,s);Object.defineProperty(t,s,o.get?o:{enumerable:!0,get:function(){return i[s]}})}),t}var src={exports:{}},indexLight={exports:{}},indexMinimal={},minimal={},aspromise=asPromise$1;function asPromise$1(i,e){for(var t=new Array(arguments.length-1),s=0,o=2,a=!0;o<arguments.length;)t[s++]=arguments[o++];return new Promise(function(u,d){t[s]=function(v){if(a)if(a=!1,v)d(v);else{for(var g=new Array(arguments.length-1),m=0;m<g.length;)g[m++]=arguments[m];u.apply(null,g)}};try{i.apply(e||null,t)}catch(p){a&&(a=!1,d(p))}})}var base64$1={};(function(i){var e=i;e.length=function(u){var d=u.length;if(!d)return 0;for(var p=0;--d%4>1&&u.charAt(d)==="=";)++p;return Math.ceil(u.length*3)/4-p};for(var t=new Array(64),s=new Array(123),o=0;o<64;)s[t[o]=o<26?o+65:o<52?o+71:o<62?o-4:o-59|43]=o++;e.encode=function(u,d,p){for(var v=null,g=[],m=0,S=0,y;d<p;){var C=u[d++];switch(S){case 0:g[m++]=t[C>>2],y=(C&3)<<4,S=1;break;case 1:g[m++]=t[y|C>>4],y=(C&15)<<2,S=2;break;case 2:g[m++]=t[y|C>>6],g[m++]=t[C&63],S=0;break}m>8191&&((v||(v=[])).push(String.fromCharCode.apply(String,g)),m=0)}return S&&(g[m++]=t[y],g[m++]=61,S===1&&(g[m++]=61)),v?(m&&v.push(String.fromCharCode.apply(String,g.slice(0,m))),v.join("")):String.fromCharCode.apply(String,g.slice(0,m))};var a="invalid encoding";e.decode=function(u,d,p){for(var v=p,g=0,m,S=0;S<u.length;){var y=u.charCodeAt(S++);if(y===61&&g>1)break;if((y=s[y])===void 0)throw Error(a);switch(g){case 0:m=y,g=1;break;case 1:d[p++]=m<<2|(y&48)>>4,m=y,g=2;break;case 2:d[p++]=(m&15)<<4|(y&60)>>2,m=y,g=3;break;case 3:d[p++]=(m&3)<<6|y,g=0;break}}if(g===1)throw Error(a);return p-v},e.test=function(u){return/^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$/.test(u)}})(base64$1);var eventemitter=EventEmitter;function EventEmitter(){this._listeners={}}EventEmitter.prototype.on=function(e,t,s){return(this._listeners[e]||(this._listeners[e]=[])).push({fn:t,ctx:s||this}),this};EventEmitter.prototype.off=function(e,t){if(e===void 0)this._listeners={};else if(t===void 0)this._listeners[e]=[];else for(var s=this._listeners[e],o=0;o<s.length;)s[o].fn===t?s.splice(o,1):++o;return this};EventEmitter.prototype.emit=function(e){var t=this._listeners[e];if(t){for(var s=[],o=1;o<arguments.length;)s.push(arguments[o++]);for(o=0;o<t.length;)t[o].fn.apply(t[o++].ctx,s)}return this};var float=factory(factory);function factory(i){return typeof Float32Array<"u"?function(){var e=new Float32Array([-0]),t=new Uint8Array(e.buffer),s=t[3]===128;function o(d,p,v){e[0]=d,p[v]=t[0],p[v+1]=t[1],p[v+2]=t[2],p[v+3]=t[3]}function a(d,p,v){e[0]=d,p[v]=t[3],p[v+1]=t[2],p[v+2]=t[1],p[v+3]=t[0]}i.writeFloatLE=s?o:a,i.writeFloatBE=s?a:o;function c(d,p){return t[0]=d[p],t[1]=d[p+1],t[2]=d[p+2],t[3]=d[p+3],e[0]}function u(d,p){return t[3]=d[p],t[2]=d[p+1],t[1]=d[p+2],t[0]=d[p+3],e[0]}i.readFloatLE=s?c:u,i.readFloatBE=s?u:c}():function(){function e(s,o,a,c){var u=o<0?1:0;if(u&&(o=-o),o===0)s(1/o>0?0:2147483648,a,c);else if(isNaN(o))s(2143289344,a,c);else if(o>34028234663852886e22)s((u<<31|2139095040)>>>0,a,c);else if(o<11754943508222875e-54)s((u<<31|Math.round(o/1401298464324817e-60))>>>0,a,c);else{var d=Math.floor(Math.log(o)/Math.LN2),p=Math.round(o*Math.pow(2,-d)*8388608)&8388607;s((u<<31|d+127<<23|p)>>>0,a,c)}}i.writeFloatLE=e.bind(null,writeUintLE),i.writeFloatBE=e.bind(null,writeUintBE);function t(s,o,a){var c=s(o,a),u=(c>>31)*2+1,d=c>>>23&255,p=c&8388607;return d===255?p?NaN:u*(1/0):d===0?u*1401298464324817e-60*p:u*Math.pow(2,d-150)*(p+8388608)}i.readFloatLE=t.bind(null,readUintLE),i.readFloatBE=t.bind(null,readUintBE)}(),typeof Float64Array<"u"?function(){var e=new Float64Array([-0]),t=new Uint8Array(e.buffer),s=t[7]===128;function o(d,p,v){e[0]=d,p[v]=t[0],p[v+1]=t[1],p[v+2]=t[2],p[v+3]=t[3],p[v+4]=t[4],p[v+5]=t[5],p[v+6]=t[6],p[v+7]=t[7]}function a(d,p,v){e[0]=d,p[v]=t[7],p[v+1]=t[6],p[v+2]=t[5],p[v+3]=t[4],p[v+4]=t[3],p[v+5]=t[2],p[v+6]=t[1],p[v+7]=t[0]}i.writeDoubleLE=s?o:a,i.writeDoubleBE=s?a:o;function c(d,p){return t[0]=d[p],t[1]=d[p+1],t[2]=d[p+2],t[3]=d[p+3],t[4]=d[p+4],t[5]=d[p+5],t[6]=d[p+6],t[7]=d[p+7],e[0]}function u(d,p){return t[7]=d[p],t[6]=d[p+1],t[5]=d[p+2],t[4]=d[p+3],t[3]=d[p+4],t[2]=d[p+5],t[1]=d[p+6],t[0]=d[p+7],e[0]}i.readDoubleLE=s?c:u,i.readDoubleBE=s?u:c}():function(){function e(s,o,a,c,u,d){var p=c<0?1:0;if(p&&(c=-c),c===0)s(0,u,d+o),s(1/c>0?0:2147483648,u,d+a);else if(isNaN(c))s(0,u,d+o),s(2146959360,u,d+a);else if(c>17976931348623157e292)s(0,u,d+o),s((p<<31|2146435072)>>>0,u,d+a);else{var v;if(c<22250738585072014e-324)v=c/5e-324,s(v>>>0,u,d+o),s((p<<31|v/4294967296)>>>0,u,d+a);else{var g=Math.floor(Math.log(c)/Math.LN2);g===1024&&(g=1023),v=c*Math.pow(2,-g),s(v*4503599627370496>>>0,u,d+o),s((p<<31|g+1023<<20|v*1048576&1048575)>>>0,u,d+a)}}}i.writeDoubleLE=e.bind(null,writeUintLE,0,4),i.writeDoubleBE=e.bind(null,writeUintBE,4,0);function t(s,o,a,c,u){var d=s(c,u+o),p=s(c,u+a),v=(p>>31)*2+1,g=p>>>20&2047,m=4294967296*(p&1048575)+d;return g===2047?m?NaN:v*(1/0):g===0?v*5e-324*m:v*Math.pow(2,g-1075)*(m+4503599627370496)}i.readDoubleLE=t.bind(null,readUintLE,0,4),i.readDoubleBE=t.bind(null,readUintBE,4,0)}(),i}function writeUintLE(i,e,t){e[t]=i&255,e[t+1]=i>>>8&255,e[t+2]=i>>>16&255,e[t+3]=i>>>24}function writeUintBE(i,e,t){e[t]=i>>>24,e[t+1]=i>>>16&255,e[t+2]=i>>>8&255,e[t+3]=i&255}function readUintLE(i,e){return(i[e]|i[e+1]<<8|i[e+2]<<16|i[e+3]<<24)>>>0}function readUintBE(i,e){return(i[e]<<24|i[e+1]<<16|i[e+2]<<8|i[e+3])>>>0}var inquire_1=inquire$1;function inquire$1(moduleName){try{var mod=eval("quire".replace(/^/,"re"))(moduleName);if(mod&&(mod.length||Object.keys(mod).length))return mod}catch(i){}return null}var utf8$2={};(function(i){var e=i;e.length=function(s){for(var o=0,a=0,c=0;c<s.length;++c)a=s.charCodeAt(c),a<128?o+=1:a<2048?o+=2:(a&64512)===55296&&(s.charCodeAt(c+1)&64512)===56320?(++c,o+=4):o+=3;return o},e.read=function(s,o,a){var c=a-o;if(c<1)return"";for(var u=null,d=[],p=0,v;o<a;)v=s[o++],v<128?d[p++]=v:v>191&&v<224?d[p++]=(v&31)<<6|s[o++]&63:v>239&&v<365?(v=((v&7)<<18|(s[o++]&63)<<12|(s[o++]&63)<<6|s[o++]&63)-65536,d[p++]=55296+(v>>10),d[p++]=56320+(v&1023)):d[p++]=(v&15)<<12|(s[o++]&63)<<6|s[o++]&63,p>8191&&((u||(u=[])).push(String.fromCharCode.apply(String,d)),p=0);return u?(p&&u.push(String.fromCharCode.apply(String,d.slice(0,p))),u.join("")):String.fromCharCode.apply(String,d.slice(0,p))},e.write=function(s,o,a){for(var c=a,u,d,p=0;p<s.length;++p)u=s.charCodeAt(p),u<128?o[a++]=u:u<2048?(o[a++]=u>>6|192,o[a++]=u&63|128):(u&64512)===55296&&((d=s.charCodeAt(p+1))&64512)===56320?(u=65536+((u&1023)<<10)+(d&1023),++p,o[a++]=u>>18|240,o[a++]=u>>12&63|128,o[a++]=u>>6&63|128,o[a++]=u&63|128):(o[a++]=u>>12|224,o[a++]=u>>6&63|128,o[a++]=u&63|128);return a-c}})(utf8$2);var pool_1=pool;function pool(i,e,t){var s=t||8192,o=s>>>1,a=null,c=s;return function(d){if(d<1||d>o)return i(d);c+d>s&&(a=i(s),c=0);var p=e.call(a,c,c+=d);return c&7&&(c=(c|7)+1),p}}var longbits,hasRequiredLongbits;function requireLongbits(){if(hasRequiredLongbits)return longbits;hasRequiredLongbits=1,longbits=e;var i=requireMinimal();function e(a,c){this.lo=a>>>0,this.hi=c>>>0}var t=e.zero=new e(0,0);t.toNumber=function(){return 0},t.zzEncode=t.zzDecode=function(){return this},t.length=function(){return 1};var s=e.zeroHash="\0\0\0\0\0\0\0\0";e.fromNumber=function(c){if(c===0)return t;var u=c<0;u&&(c=-c);var d=c>>>0,p=(c-d)/4294967296>>>0;return u&&(p=~p>>>0,d=~d>>>0,++d>4294967295&&(d=0,++p>4294967295&&(p=0))),new e(d,p)},e.from=function(c){if(typeof c=="number")return e.fromNumber(c);if(i.isString(c))if(i.Long)c=i.Long.fromString(c);else return e.fromNumber(parseInt(c,10));return c.low||c.high?new e(c.low>>>0,c.high>>>0):t},e.prototype.toNumber=function(c){if(!c&&this.hi>>>31){var u=~this.lo+1>>>0,d=~this.hi>>>0;return u||(d=d+1>>>0),-(u+d*4294967296)}return this.lo+this.hi*4294967296},e.prototype.toLong=function(c){return i.Long?new i.Long(this.lo|0,this.hi|0,!!c):{low:this.lo|0,high:this.hi|0,unsigned:!!c}};var o=String.prototype.charCodeAt;return e.fromHash=function(c){return c===s?t:new e((o.call(c,0)|o.call(c,1)<<8|o.call(c,2)<<16|o.call(c,3)<<24)>>>0,(o.call(c,4)|o.call(c,5)<<8|o.call(c,6)<<16|o.call(c,7)<<24)>>>0)},e.prototype.toHash=function(){return String.fromCharCode(this.lo&255,this.lo>>>8&255,this.lo>>>16&255,this.lo>>>24,this.hi&255,this.hi>>>8&255,this.hi>>>16&255,this.hi>>>24)},e.prototype.zzEncode=function(){var c=this.hi>>31;return this.hi=((this.hi<<1|this.lo>>>31)^c)>>>0,this.lo=(this.lo<<1^c)>>>0,this},e.prototype.zzDecode=function(){var c=-(this.lo&1);return this.lo=((this.lo>>>1|this.hi<<31)^c)>>>0,this.hi=(this.hi>>>1^c)>>>0,this},e.prototype.length=function(){var c=this.lo,u=(this.lo>>>28|this.hi<<4)>>>0,d=this.hi>>>24;return d===0?u===0?c<16384?c<128?1:2:c<2097152?3:4:u<16384?u<128?5:6:u<2097152?7:8:d<128?9:10},longbits}var hasRequiredMinimal;function requireMinimal(){return hasRequiredMinimal||(hasRequiredMinimal=1,function(i){var e=i;e.asPromise=aspromise,e.base64=base64$1,e.EventEmitter=eventemitter,e.float=float,e.inquire=inquire_1,e.utf8=utf8$2,e.pool=pool_1,e.LongBits=requireLongbits(),e.isNode=!!(typeof commonjsGlobal<"u"&&commonjsGlobal&&commonjsGlobal.process&&commonjsGlobal.process.versions&&commonjsGlobal.process.versions.node),e.global=e.isNode&&commonjsGlobal||typeof window<"u"&&window||typeof self<"u"&&self||commonjsGlobal,e.emptyArray=Object.freeze?Object.freeze([]):[],e.emptyObject=Object.freeze?Object.freeze({}):{},e.isInteger=Number.isInteger||function(a){return typeof a=="number"&&isFinite(a)&&Math.floor(a)===a},e.isString=function(a){return typeof a=="string"||a instanceof String},e.isObject=function(a){return a&&typeof a=="object"},e.isset=e.isSet=function(a,c){var u=a[c];return u!=null&&a.hasOwnProperty(c)?typeof u!="object"||(Array.isArray(u)?u.length:Object.keys(u).length)>0:!1},e.Buffer=function(){try{var o=e.inquire("buffer").Buffer;return o.prototype.utf8Write?o:null}catch{return null}}(),e._Buffer_from=null,e._Buffer_allocUnsafe=null,e.newBuffer=function(a){return typeof a=="number"?e.Buffer?e._Buffer_allocUnsafe(a):new e.Array(a):e.Buffer?e._Buffer_from(a):typeof Uint8Array>"u"?a:new Uint8Array(a)},e.Array=typeof Uint8Array<"u"?Uint8Array:Array,e.Long=e.global.dcodeIO&&e.global.dcodeIO.Long||e.global.Long||e.inquire("long"),e.key2Re=/^true|false|0|1$/,e.key32Re=/^-?(?:0|[1-9][0-9]*)$/,e.key64Re=/^(?:[\\x00-\\xff]{8}|-?(?:0|[1-9][0-9]*))$/,e.longToHash=function(a){return a?e.LongBits.from(a).toHash():e.LongBits.zeroHash},e.longFromHash=function(a,c){var u=e.LongBits.fromHash(a);return e.Long?e.Long.fromBits(u.lo,u.hi,c):u.toNumber(!!c)};function t(o,a,c){for(var u=Object.keys(a),d=0;d<u.length;++d)(o[u[d]]===void 0||!c)&&(o[u[d]]=a[u[d]]);return o}e.merge=t,e.lcFirst=function(a){return a.charAt(0).toLowerCase()+a.substring(1)};function s(o){function a(c,u){if(!(this instanceof a))return new a(c,u);Object.defineProperty(this,"message",{get:function(){return c}}),Error.captureStackTrace?Error.captureStackTrace(this,a):Object.defineProperty(this,"stack",{value:new Error().stack||""}),u&&t(this,u)}return a.prototype=Object.create(Error.prototype,{constructor:{value:a,writable:!0,enumerable:!1,configurable:!0},name:{get:function(){return o},set:void 0,enumerable:!1,configurable:!0},toString:{value:function(){return this.name+": "+this.message},writable:!0,enumerable:!1,configurable:!0}}),a}e.newError=s,e.ProtocolError=s("ProtocolError"),e.oneOfGetter=function(a){for(var c={},u=0;u<a.length;++u)c[a[u]]=1;return function(){for(var d=Object.keys(this),p=d.length-1;p>-1;--p)if(c[d[p]]===1&&this[d[p]]!==void 0&&this[d[p]]!==null)return d[p]}},e.oneOfSetter=function(a){return function(c){for(var u=0;u<a.length;++u)a[u]!==c&&delete this[a[u]]}},e.toJSONOptions={longs:String,enums:String,bytes:String,json:!0},e._configure=function(){var o=e.Buffer;if(!o){e._Buffer_from=e._Buffer_allocUnsafe=null;return}e._Buffer_from=o.from!==Uint8Array.from&&o.from||function(c,u){return new o(c,u)},e._Buffer_allocUnsafe=o.allocUnsafe||function(c){return new o(c)}}}(minimal)),minimal}var writer=Writer$1,util$7=requireMinimal(),BufferWriter$1,LongBits$1=util$7.LongBits,base64=util$7.base64,utf8$1=util$7.utf8;function Op(i,e,t){this.fn=i,this.len=e,this.next=void 0,this.val=t}function noop(){}function State(i){this.head=i.head,this.tail=i.tail,this.len=i.len,this.next=i.states}function Writer$1(){this.len=0,this.head=new Op(noop,0,0),this.tail=this.head,this.states=null}var create$1=function i(){return util$7.Buffer?function(){return(Writer$1.create=function(){return new BufferWriter$1})()}:function(){return new Writer$1}};Writer$1.create=create$1();Writer$1.alloc=function i(e){return new util$7.Array(e)};util$7.Array!==Array&&(Writer$1.alloc=util$7.pool(Writer$1.alloc,util$7.Array.prototype.subarray));Writer$1.prototype._push=function i(e,t,s){return this.tail=this.tail.next=new Op(e,t,s),this.len+=t,this};function writeByte(i,e,t){e[t]=i&255}function writeVarint32(i,e,t){for(;i>127;)e[t++]=i&127|128,i>>>=7;e[t]=i}function VarintOp(i,e){this.len=i,this.next=void 0,this.val=e}VarintOp.prototype=Object.create(Op.prototype);VarintOp.prototype.fn=writeVarint32;Writer$1.prototype.uint32=function i(e){return this.len+=(this.tail=this.tail.next=new VarintOp((e=e>>>0)<128?1:e<16384?2:e<2097152?3:e<268435456?4:5,e)).len,this};Writer$1.prototype.int32=function i(e){return e<0?this._push(writeVarint64,10,LongBits$1.fromNumber(e)):this.uint32(e)};Writer$1.prototype.sint32=function i(e){return this.uint32((e<<1^e>>31)>>>0)};function writeVarint64(i,e,t){for(;i.hi;)e[t++]=i.lo&127|128,i.lo=(i.lo>>>7|i.hi<<25)>>>0,i.hi>>>=7;for(;i.lo>127;)e[t++]=i.lo&127|128,i.lo=i.lo>>>7;e[t++]=i.lo}Writer$1.prototype.uint64=function i(e){var t=LongBits$1.from(e);return this._push(writeVarint64,t.length(),t)};Writer$1.prototype.int64=Writer$1.prototype.uint64;Writer$1.prototype.sint64=function i(e){var t=LongBits$1.from(e).zzEncode();return this._push(writeVarint64,t.length(),t)};Writer$1.prototype.bool=function i(e){return this._push(writeByte,1,e?1:0)};function writeFixed32(i,e,t){e[t]=i&255,e[t+1]=i>>>8&255,e[t+2]=i>>>16&255,e[t+3]=i>>>24}Writer$1.prototype.fixed32=function i(e){return this._push(writeFixed32,4,e>>>0)};Writer$1.prototype.sfixed32=Writer$1.prototype.fixed32;Writer$1.prototype.fixed64=function i(e){var t=LongBits$1.from(e);return this._push(writeFixed32,4,t.lo)._push(writeFixed32,4,t.hi)};Writer$1.prototype.sfixed64=Writer$1.prototype.fixed64;Writer$1.prototype.float=function i(e){return this._push(util$7.float.writeFloatLE,4,e)};Writer$1.prototype.double=function i(e){return this._push(util$7.float.writeDoubleLE,8,e)};var writeBytes=util$7.Array.prototype.set?function i(e,t,s){t.set(e,s)}:function i(e,t,s){for(var o=0;o<e.length;++o)t[s+o]=e[o]};Writer$1.prototype.bytes=function i(e){var t=e.length>>>0;if(!t)return this._push(writeByte,1,0);if(util$7.isString(e)){var s=Writer$1.alloc(t=base64.length(e));base64.decode(e,s,0),e=s}return this.uint32(t)._push(writeBytes,t,e)};Writer$1.prototype.string=function i(e){var t=utf8$1.length(e);return t?this.uint32(t)._push(utf8$1.write,t,e):this._push(writeByte,1,0)};Writer$1.prototype.fork=function i(){return this.states=new State(this),this.head=this.tail=new Op(noop,0,0),this.len=0,this};Writer$1.prototype.reset=function i(){return this.states?(this.head=this.states.head,this.tail=this.states.tail,this.len=this.states.len,this.states=this.states.next):(this.head=this.tail=new Op(noop,0,0),this.len=0),this};Writer$1.prototype.ldelim=function i(){var e=this.head,t=this.tail,s=this.len;return this.reset().uint32(s),s&&(this.tail.next=e.next,this.tail=t,this.len+=s),this};Writer$1.prototype.finish=function i(){for(var e=this.head.next,t=this.constructor.alloc(this.len),s=0;e;)e.fn(e.val,t,s),s+=e.len,e=e.next;return t};Writer$1._configure=function(i){BufferWriter$1=i,Writer$1.create=create$1(),BufferWriter$1._configure()};var writer_buffer=BufferWriter,Writer=writer;(BufferWriter.prototype=Object.create(Writer.prototype)).constructor=BufferWriter;var util$6=requireMinimal();function BufferWriter(){Writer.call(this)}BufferWriter._configure=function(){BufferWriter.alloc=util$6._Buffer_allocUnsafe,BufferWriter.writeBytesBuffer=util$6.Buffer&&util$6.Buffer.prototype instanceof Uint8Array&&util$6.Buffer.prototype.set.name==="set"?function(e,t,s){t.set(e,s)}:function(e,t,s){if(e.copy)e.copy(t,s,0,e.length);else for(var o=0;o<e.length;)t[s++]=e[o++]}};BufferWriter.prototype.bytes=function i(e){util$6.isString(e)&&(e=util$6._Buffer_from(e,"base64"));var t=e.length>>>0;return this.uint32(t),t&&this._push(BufferWriter.writeBytesBuffer,t,e),this};function writeStringBuffer(i,e,t){i.length<40?util$6.utf8.write(i,e,t):e.utf8Write?e.utf8Write(i,t):e.write(i,t)}BufferWriter.prototype.string=function i(e){var t=util$6.Buffer.byteLength(e);return this.uint32(t),t&&this._push(writeStringBuffer,t,e),this};BufferWriter._configure();var reader=Reader$1,util$5=requireMinimal(),BufferReader$1,LongBits=util$5.LongBits,utf8=util$5.utf8;function indexOutOfRange(i,e){return RangeError("index out of range: "+i.pos+" + "+(e||1)+" > "+i.len)}function Reader$1(i){this.buf=i,this.pos=0,this.len=i.length}var create_array=typeof Uint8Array<"u"?function i(e){if(e instanceof Uint8Array||Array.isArray(e))return new Reader$1(e);throw Error("illegal buffer")}:function i(e){if(Array.isArray(e))return new Reader$1(e);throw Error("illegal buffer")},create=function i(){return util$5.Buffer?function(t){return(Reader$1.create=function(o){return util$5.Buffer.isBuffer(o)?new BufferReader$1(o):create_array(o)})(t)}:create_array};Reader$1.create=create();Reader$1.prototype._slice=util$5.Array.prototype.subarray||util$5.Array.prototype.slice;Reader$1.prototype.uint32=function i(){var e=4294967295;return function(){if(e=(this.buf[this.pos]&127)>>>0,this.buf[this.pos++]<128||(e=(e|(this.buf[this.pos]&127)<<7)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<14)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&127)<<21)>>>0,this.buf[this.pos++]<128)||(e=(e|(this.buf[this.pos]&15)<<28)>>>0,this.buf[this.pos++]<128))return e;if((this.pos+=5)>this.len)throw this.pos=this.len,indexOutOfRange(this,10);return e}}();Reader$1.prototype.int32=function i(){return this.uint32()|0};Reader$1.prototype.sint32=function i(){var e=this.uint32();return e>>>1^-(e&1)|0};function readLongVarint(){var i=new LongBits(0,0),e=0;if(this.len-this.pos>4){for(;e<4;++e)if(i.lo=(i.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return i;if(i.lo=(i.lo|(this.buf[this.pos]&127)<<28)>>>0,i.hi=(i.hi|(this.buf[this.pos]&127)>>4)>>>0,this.buf[this.pos++]<128)return i;e=0}else{for(;e<3;++e){if(this.pos>=this.len)throw indexOutOfRange(this);if(i.lo=(i.lo|(this.buf[this.pos]&127)<<e*7)>>>0,this.buf[this.pos++]<128)return i}return i.lo=(i.lo|(this.buf[this.pos++]&127)<<e*7)>>>0,i}if(this.len-this.pos>4){for(;e<5;++e)if(i.hi=(i.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return i}else for(;e<5;++e){if(this.pos>=this.len)throw indexOutOfRange(this);if(i.hi=(i.hi|(this.buf[this.pos]&127)<<e*7+3)>>>0,this.buf[this.pos++]<128)return i}throw Error("invalid varint encoding")}Reader$1.prototype.bool=function i(){return this.uint32()!==0};function readFixed32_end(i,e){return(i[e-4]|i[e-3]<<8|i[e-2]<<16|i[e-1]<<24)>>>0}Reader$1.prototype.fixed32=function i(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)};Reader$1.prototype.sfixed32=function i(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);return readFixed32_end(this.buf,this.pos+=4)|0};function readFixed64(){if(this.pos+8>this.len)throw indexOutOfRange(this,8);return new LongBits(readFixed32_end(this.buf,this.pos+=4),readFixed32_end(this.buf,this.pos+=4))}Reader$1.prototype.float=function i(){if(this.pos+4>this.len)throw indexOutOfRange(this,4);var e=util$5.float.readFloatLE(this.buf,this.pos);return this.pos+=4,e};Reader$1.prototype.double=function i(){if(this.pos+8>this.len)throw indexOutOfRange(this,4);var e=util$5.float.readDoubleLE(this.buf,this.pos);return this.pos+=8,e};Reader$1.prototype.bytes=function i(){var e=this.uint32(),t=this.pos,s=this.pos+e;if(s>this.len)throw indexOutOfRange(this,e);if(this.pos+=e,Array.isArray(this.buf))return this.buf.slice(t,s);if(t===s){var o=util$5.Buffer;return o?o.alloc(0):new this.buf.constructor(0)}return this._slice.call(this.buf,t,s)};Reader$1.prototype.string=function i(){var e=this.bytes();return utf8.read(e,0,e.length)};Reader$1.prototype.skip=function i(e){if(typeof e=="number"){if(this.pos+e>this.len)throw indexOutOfRange(this,e);this.pos+=e}else do if(this.pos>=this.len)throw indexOutOfRange(this);while(this.buf[this.pos++]&128);return this};Reader$1.prototype.skipType=function(i){switch(i){case 0:this.skip();break;case 1:this.skip(8);break;case 2:this.skip(this.uint32());break;case 3:for(;(i=this.uint32()&7)!==4;)this.skipType(i);break;case 5:this.skip(4);break;default:throw Error("invalid wire type "+i+" at offset "+this.pos)}return this};Reader$1._configure=function(i){BufferReader$1=i,Reader$1.create=create(),BufferReader$1._configure();var e=util$5.Long?"toLong":"toNumber";util$5.merge(Reader$1.prototype,{int64:function(){return readLongVarint.call(this)[e](!1)},uint64:function(){return readLongVarint.call(this)[e](!0)},sint64:function(){return readLongVarint.call(this).zzDecode()[e](!1)},fixed64:function(){return readFixed64.call(this)[e](!0)},sfixed64:function(){return readFixed64.call(this)[e](!1)}})};var reader_buffer=BufferReader,Reader=reader;(BufferReader.prototype=Object.create(Reader.prototype)).constructor=BufferReader;var util$4=requireMinimal();function BufferReader(i){Reader.call(this,i)}BufferReader._configure=function(){util$4.Buffer&&(BufferReader.prototype._slice=util$4.Buffer.prototype.slice)};BufferReader.prototype.string=function i(){var e=this.uint32();return this.buf.utf8Slice?this.buf.utf8Slice(this.pos,this.pos=Math.min(this.pos+e,this.len)):this.buf.toString("utf-8",this.pos,this.pos=Math.min(this.pos+e,this.len))};BufferReader._configure();var rpc={},service$1=Service$1,util$3=requireMinimal();(Service$1.prototype=Object.create(util$3.EventEmitter.prototype)).constructor=Service$1;function Service$1(i,e,t){if(typeof i!="function")throw TypeError("rpcImpl must be a function");util$3.EventEmitter.call(this),this.rpcImpl=i,this.requestDelimited=!!e,this.responseDelimited=!!t}Service$1.prototype.rpcCall=function i(e,t,s,o,a){if(!o)throw TypeError("request must be specified");var c=this;if(!a)return util$3.asPromise(i,c,e,t,s,o);if(!c.rpcImpl){setTimeout(function(){a(Error("already ended"))},0);return}try{return c.rpcImpl(e,t[c.requestDelimited?"encodeDelimited":"encode"](o).finish(),function(d,p){if(d)return c.emit("error",d,e),a(d);if(p===null){c.end(!0);return}if(!(p instanceof s))try{p=s[c.responseDelimited?"decodeDelimited":"decode"](p)}catch(v){return c.emit("error",v,e),a(v)}return c.emit("data",p,e),a(null,p)})}catch(u){c.emit("error",u,e),setTimeout(function(){a(u)},0);return}};Service$1.prototype.end=function i(e){return this.rpcImpl&&(e||this.rpcImpl(null,null,null),this.rpcImpl=null,this.emit("end").off()),this};(function(i){var e=i;e.Service=service$1})(rpc);var roots={};(function(i){var e=i;e.build="minimal",e.Writer=writer,e.BufferWriter=writer_buffer,e.Reader=reader,e.BufferReader=reader_buffer,e.util=requireMinimal(),e.rpc=rpc,e.roots=roots,e.configure=t;function t(){e.util._configure(),e.Writer._configure(e.BufferWriter),e.Reader._configure(e.BufferReader)}t()})(indexMinimal);var util$2={exports:{}},codegen_1=codegen;function codegen(i,e){typeof i=="string"&&(e=i,i=void 0);var t=[];function s(a){if(typeof a!="string"){var c=o();if(codegen.verbose&&console.log("codegen: "+c),c="return "+c,a){for(var u=Object.keys(a),d=new Array(u.length+1),p=new Array(u.length),v=0;v<u.length;)d[v]=u[v],p[v]=a[u[v++]];return d[v]=c,Function.apply(null,d).apply(null,p)}return Function(c)()}for(var g=new Array(arguments.length-1),m=0;m<g.length;)g[m]=arguments[++m];if(m=0,a=a.replace(/%([%dfijs])/g,function(y,C){var R=g[m++];switch(C){case"d":case"f":return String(Number(R));case"i":return String(Math.floor(R));case"j":return JSON.stringify(R);case"s":return String(R)}return"%"}),m!==g.length)throw Error("parameter count mismatch");return t.push(a),s}function o(a){return"function "+(a||e||"")+"("+(i&&i.join(",")||"")+`){
  `+t.join(`
  `)+`
}`}return s.toString=o,s}codegen.verbose=!1;var fetch_1=fetch$1,asPromise=aspromise,inquire=inquire_1,fs$2=inquire("fs");function fetch$1(i,e,t){return typeof e=="function"?(t=e,e={}):e||(e={}),t?!e.xhr&&fs$2&&fs$2.readFile?fs$2.readFile(i,function(o,a){return o&&typeof XMLHttpRequest<"u"?fetch$1.xhr(i,e,t):o?t(o):t(null,e.binary?a:a.toString("utf8"))}):fetch$1.xhr(i,e,t):asPromise(fetch$1,this,i,e)}fetch$1.xhr=function i(e,t,s){var o=new XMLHttpRequest;o.onreadystatechange=function(){if(o.readyState===4){if(o.status!==0&&o.status!==200)return s(Error("status "+o.status));if(t.binary){var c=o.response;if(!c){c=[];for(var u=0;u<o.responseText.length;++u)c.push(o.responseText.charCodeAt(u)&255)}return s(null,typeof Uint8Array<"u"?new Uint8Array(c):c)}return s(null,o.responseText)}},t.binary&&("overrideMimeType"in o&&o.overrideMimeType("text/plain; charset=x-user-defined"),o.responseType="arraybuffer"),o.open("GET",e),o.send()};var path={};(function(i){var e=i,t=e.isAbsolute=function(a){return/^(?:\/|\w+:)/.test(a)},s=e.normalize=function(a){a=a.replace(/\\/g,"/").replace(/\/{2,}/g,"/");var c=a.split("/"),u=t(a),d="";u&&(d=c.shift()+"/");for(var p=0;p<c.length;)c[p]===".."?p>0&&c[p-1]!==".."?c.splice(--p,2):u?c.splice(p,1):++p:c[p]==="."?c.splice(p,1):++p;return d+c.join("/")};e.resolve=function(a,c,u){return u||(c=s(c)),t(c)?c:(u||(a=s(a)),(a=a.replace(/(?:\/|^)[^/]+$/,"")).length?s(a+"/"+c):c)}})(path);var types$1={},hasRequiredTypes;function requireTypes(){return hasRequiredTypes||(hasRequiredTypes=1,function(i){var e=i,t=requireUtil(),s=["double","float","int32","uint32","sint32","fixed32","sfixed32","int64","uint64","sint64","fixed64","sfixed64","bool","string","bytes"];function o(a,c){var u=0,d={};for(c|=0;u<a.length;)d[s[u+c]]=a[u++];return d}e.basic=o([1,5,0,0,0,5,5,0,0,0,1,1,0,2,2]),e.defaults=o([0,0,0,0,0,0,0,0,0,0,0,0,!1,"",t.emptyArray,null]),e.long=o([0,0,0,1,1],7),e.mapKey=o([0,0,0,5,5,0,0,0,1,1,0,2],2),e.packed=o([1,5,0,0,0,5,5,0,0,0,1,1,0])}(types$1)),types$1}var field,hasRequiredField;function requireField(){if(hasRequiredField)return field;hasRequiredField=1,field=c;var i=requireObject();((c.prototype=Object.create(i.prototype)).constructor=c).className="Field";var e=require_enum(),t=requireTypes(),s=requireUtil(),o,a=/^required|optional|repeated$/;c.fromJSON=function(d,p){return new c(d,p.id,p.type,p.rule,p.extend,p.options,p.comment)};function c(u,d,p,v,g,m,S){if(s.isObject(v)?(S=g,m=v,v=g=void 0):s.isObject(g)&&(S=m,m=g,g=void 0),i.call(this,u,m),!s.isInteger(d)||d<0)throw TypeError("id must be a non-negative integer");if(!s.isString(p))throw TypeError("type must be a string");if(v!==void 0&&!a.test(v=v.toString().toLowerCase()))throw TypeError("rule must be a string rule");if(g!==void 0&&!s.isString(g))throw TypeError("extend must be a string");v==="proto3_optional"&&(v="optional"),this.rule=v&&v!=="optional"?v:void 0,this.type=p,this.id=d,this.extend=g||void 0,this.required=v==="required",this.optional=!this.required,this.repeated=v==="repeated",this.map=!1,this.message=null,this.partOf=null,this.typeDefault=null,this.defaultValue=null,this.long=s.Long?t.long[p]!==void 0:!1,this.bytes=p==="bytes",this.resolvedType=null,this.extensionField=null,this.declaringField=null,this._packed=null,this.comment=S}return Object.defineProperty(c.prototype,"packed",{get:function(){return this._packed===null&&(this._packed=this.getOption("packed")!==!1),this._packed}}),c.prototype.setOption=function(d,p,v){return d==="packed"&&(this._packed=null),i.prototype.setOption.call(this,d,p,v)},c.prototype.toJSON=function(d){var p=d?!!d.keepComments:!1;return s.toObject(["rule",this.rule!=="optional"&&this.rule||void 0,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",p?this.comment:void 0])},c.prototype.resolve=function(){if(this.resolved)return this;if((this.typeDefault=t.defaults[this.type])===void 0?(this.resolvedType=(this.declaringField?this.declaringField.parent:this.parent).lookupTypeOrEnum(this.type),this.resolvedType instanceof o?this.typeDefault=null:this.typeDefault=this.resolvedType.values[Object.keys(this.resolvedType.values)[0]]):this.options&&this.options.proto3_optional&&(this.typeDefault=null),this.options&&this.options.default!=null&&(this.typeDefault=this.options.default,this.resolvedType instanceof e&&typeof this.typeDefault=="string"&&(this.typeDefault=this.resolvedType.values[this.typeDefault])),this.options&&((this.options.packed===!0||this.options.packed!==void 0&&this.resolvedType&&!(this.resolvedType instanceof e))&&delete this.options.packed,Object.keys(this.options).length||(this.options=void 0)),this.long)this.typeDefault=s.Long.fromNumber(this.typeDefault,this.type.charAt(0)==="u"),Object.freeze&&Object.freeze(this.typeDefault);else if(this.bytes&&typeof this.typeDefault=="string"){var d;s.base64.test(this.typeDefault)?s.base64.decode(this.typeDefault,d=s.newBuffer(s.base64.length(this.typeDefault)),0):s.utf8.write(this.typeDefault,d=s.newBuffer(s.utf8.length(this.typeDefault)),0),this.typeDefault=d}return this.map?this.defaultValue=s.emptyObject:this.repeated?this.defaultValue=s.emptyArray:this.defaultValue=this.typeDefault,this.parent instanceof o&&(this.parent.ctor.prototype[this.name]=this.defaultValue),i.prototype.resolve.call(this)},c.d=function(d,p,v,g){return typeof p=="function"?p=s.decorateType(p).name:p&&typeof p=="object"&&(p=s.decorateEnum(p).name),function(S,y){s.decorateType(S.constructor).add(new c(y,d,p,v,{default:g}))}},c._configure=function(d){o=d},field}var oneof,hasRequiredOneof;function requireOneof(){if(hasRequiredOneof)return oneof;hasRequiredOneof=1,oneof=s;var i=requireObject();((s.prototype=Object.create(i.prototype)).constructor=s).className="OneOf";var e=requireField(),t=requireUtil();function s(a,c,u,d){if(Array.isArray(c)||(u=c,c=void 0),i.call(this,a,u),!(c===void 0||Array.isArray(c)))throw TypeError("fieldNames must be an Array");this.oneof=c||[],this.fieldsArray=[],this.comment=d}s.fromJSON=function(c,u){return new s(c,u.oneof,u.options,u.comment)},s.prototype.toJSON=function(c){var u=c?!!c.keepComments:!1;return t.toObject(["options",this.options,"oneof",this.oneof,"comment",u?this.comment:void 0])};function o(a){if(a.parent)for(var c=0;c<a.fieldsArray.length;++c)a.fieldsArray[c].parent||a.parent.add(a.fieldsArray[c])}return s.prototype.add=function(c){if(!(c instanceof e))throw TypeError("field must be a Field");return c.parent&&c.parent!==this.parent&&c.parent.remove(c),this.oneof.push(c.name),this.fieldsArray.push(c),c.partOf=this,o(this),this},s.prototype.remove=function(c){if(!(c instanceof e))throw TypeError("field must be a Field");var u=this.fieldsArray.indexOf(c);if(u<0)throw Error(c+" is not a member of "+this);return this.fieldsArray.splice(u,1),u=this.oneof.indexOf(c.name),u>-1&&this.oneof.splice(u,1),c.partOf=null,this},s.prototype.onAdd=function(c){i.prototype.onAdd.call(this,c);for(var u=this,d=0;d<this.oneof.length;++d){var p=c.get(this.oneof[d]);p&&!p.partOf&&(p.partOf=u,u.fieldsArray.push(p))}o(this)},s.prototype.onRemove=function(c){for(var u=0,d;u<this.fieldsArray.length;++u)(d=this.fieldsArray[u]).parent&&d.parent.remove(d);i.prototype.onRemove.call(this,c)},s.d=function(){for(var c=new Array(arguments.length),u=0;u<arguments.length;)c[u]=arguments[u++];return function(p,v){t.decorateType(p.constructor).add(new s(v,c)),Object.defineProperty(p,v,{get:t.oneOfGetter(c),set:t.oneOfSetter(c)})}},oneof}var namespace,hasRequiredNamespace;function requireNamespace(){if(hasRequiredNamespace)return namespace;hasRequiredNamespace=1,namespace=d;var i=requireObject();((d.prototype=Object.create(i.prototype)).constructor=d).className="Namespace";var e=requireField(),t=requireUtil(),s=requireOneof(),o,a,c;d.fromJSON=function(g,m){return new d(g,m.options).addJSON(m.nested)};function u(v,g){if(v&&v.length){for(var m={},S=0;S<v.length;++S)m[v[S].name]=v[S].toJSON(g);return m}}d.arrayToJSON=u,d.isReservedId=function(g,m){if(g){for(var S=0;S<g.length;++S)if(typeof g[S]!="string"&&g[S][0]<=m&&g[S][1]>m)return!0}return!1},d.isReservedName=function(g,m){if(g){for(var S=0;S<g.length;++S)if(g[S]===m)return!0}return!1};function d(v,g){i.call(this,v,g),this.nested=void 0,this._nestedArray=null}function p(v){return v._nestedArray=null,v}return Object.defineProperty(d.prototype,"nestedArray",{get:function(){return this._nestedArray||(this._nestedArray=t.toArray(this.nested))}}),d.prototype.toJSON=function(g){return t.toObject(["options",this.options,"nested",u(this.nestedArray,g)])},d.prototype.addJSON=function(g){var m=this;if(g)for(var S=Object.keys(g),y=0,C;y<S.length;++y)C=g[S[y]],m.add((C.fields!==void 0?o.fromJSON:C.values!==void 0?c.fromJSON:C.methods!==void 0?a.fromJSON:C.id!==void 0?e.fromJSON:d.fromJSON)(S[y],C));return this},d.prototype.get=function(g){return this.nested&&this.nested[g]||null},d.prototype.getEnum=function(g){if(this.nested&&this.nested[g]instanceof c)return this.nested[g].values;throw Error("no such enum: "+g)},d.prototype.add=function(g){if(!(g instanceof e&&g.extend!==void 0||g instanceof o||g instanceof s||g instanceof c||g instanceof a||g instanceof d))throw TypeError("object must be a valid nested object");if(!this.nested)this.nested={};else{var m=this.get(g.name);if(m)if(m instanceof d&&g instanceof d&&!(m instanceof o||m instanceof a)){for(var S=m.nestedArray,y=0;y<S.length;++y)g.add(S[y]);this.remove(m),this.nested||(this.nested={}),g.setOptions(m.options,!0)}else throw Error("duplicate name '"+g.name+"' in "+this)}return this.nested[g.name]=g,g.onAdd(this),p(this)},d.prototype.remove=function(g){if(!(g instanceof i))throw TypeError("object must be a ReflectionObject");if(g.parent!==this)throw Error(g+" is not a member of "+this);return delete this.nested[g.name],Object.keys(this.nested).length||(this.nested=void 0),g.onRemove(this),p(this)},d.prototype.define=function(g,m){if(t.isString(g))g=g.split(".");else if(!Array.isArray(g))throw TypeError("illegal path");if(g&&g.length&&g[0]==="")throw Error("path must be relative");for(var S=this;g.length>0;){var y=g.shift();if(S.nested&&S.nested[y]){if(S=S.nested[y],!(S instanceof d))throw Error("path conflicts with non-namespace objects")}else S.add(S=new d(y))}return m&&S.addJSON(m),S},d.prototype.resolveAll=function(){for(var g=this.nestedArray,m=0;m<g.length;)g[m]instanceof d?g[m++].resolveAll():g[m++].resolve();return this.resolve()},d.prototype.lookup=function(g,m,S){if(typeof m=="boolean"?(S=m,m=void 0):m&&!Array.isArray(m)&&(m=[m]),t.isString(g)&&g.length){if(g===".")return this.root;g=g.split(".")}else if(!g.length)return this;if(g[0]==="")return this.root.lookup(g.slice(1),m);var y=this.get(g[0]);if(y){if(g.length===1){if(!m||m.indexOf(y.constructor)>-1)return y}else if(y instanceof d&&(y=y.lookup(g.slice(1),m,!0)))return y}else for(var C=0;C<this.nestedArray.length;++C)if(this._nestedArray[C]instanceof d&&(y=this._nestedArray[C].lookup(g,m,!0)))return y;return this.parent===null||S?null:this.parent.lookup(g,m)},d.prototype.lookupType=function(g){var m=this.lookup(g,[o]);if(!m)throw Error("no such type: "+g);return m},d.prototype.lookupEnum=function(g){var m=this.lookup(g,[c]);if(!m)throw Error("no such Enum '"+g+"' in "+this);return m},d.prototype.lookupTypeOrEnum=function(g){var m=this.lookup(g,[o,c]);if(!m)throw Error("no such Type or Enum '"+g+"' in "+this);return m},d.prototype.lookupService=function(g){var m=this.lookup(g,[a]);if(!m)throw Error("no such Service '"+g+"' in "+this);return m},d._configure=function(v,g,m){o=v,a=g,c=m},namespace}var mapfield,hasRequiredMapfield;function requireMapfield(){if(hasRequiredMapfield)return mapfield;hasRequiredMapfield=1,mapfield=s;var i=requireField();((s.prototype=Object.create(i.prototype)).constructor=s).className="MapField";var e=requireTypes(),t=requireUtil();function s(o,a,c,u,d,p){if(i.call(this,o,a,u,void 0,void 0,d,p),!t.isString(c))throw TypeError("keyType must be a string");this.keyType=c,this.resolvedKeyType=null,this.map=!0}return s.fromJSON=function(a,c){return new s(a,c.id,c.keyType,c.type,c.options,c.comment)},s.prototype.toJSON=function(a){var c=a?!!a.keepComments:!1;return t.toObject(["keyType",this.keyType,"type",this.type,"id",this.id,"extend",this.extend,"options",this.options,"comment",c?this.comment:void 0])},s.prototype.resolve=function(){if(this.resolved)return this;if(e.mapKey[this.keyType]===void 0)throw Error("invalid key type: "+this.keyType);return i.prototype.resolve.call(this)},s.d=function(a,c,u){return typeof u=="function"?u=t.decorateType(u).name:u&&typeof u=="object"&&(u=t.decorateEnum(u).name),function(p,v){t.decorateType(p.constructor).add(new s(v,a,c,u))}},mapfield}var method,hasRequiredMethod;function requireMethod(){if(hasRequiredMethod)return method;hasRequiredMethod=1,method=t;var i=requireObject();((t.prototype=Object.create(i.prototype)).constructor=t).className="Method";var e=requireUtil();function t(s,o,a,c,u,d,p,v,g){if(e.isObject(u)?(p=u,u=d=void 0):e.isObject(d)&&(p=d,d=void 0),!(o===void 0||e.isString(o)))throw TypeError("type must be a string");if(!e.isString(a))throw TypeError("requestType must be a string");if(!e.isString(c))throw TypeError("responseType must be a string");i.call(this,s,p),this.type=o||"rpc",this.requestType=a,this.requestStream=u?!0:void 0,this.responseType=c,this.responseStream=d?!0:void 0,this.resolvedRequestType=null,this.resolvedResponseType=null,this.comment=v,this.parsedOptions=g}return t.fromJSON=function(o,a){return new t(o,a.type,a.requestType,a.responseType,a.requestStream,a.responseStream,a.options,a.comment,a.parsedOptions)},t.prototype.toJSON=function(o){var a=o?!!o.keepComments:!1;return e.toObject(["type",this.type!=="rpc"&&this.type||void 0,"requestType",this.requestType,"requestStream",this.requestStream,"responseType",this.responseType,"responseStream",this.responseStream,"options",this.options,"comment",a?this.comment:void 0,"parsedOptions",this.parsedOptions])},t.prototype.resolve=function(){return this.resolved?this:(this.resolvedRequestType=this.parent.lookupType(this.requestType),this.resolvedResponseType=this.parent.lookupType(this.responseType),i.prototype.resolve.call(this))},method}var service,hasRequiredService;function requireService(){if(hasRequiredService)return service;hasRequiredService=1,service=o;var i=requireNamespace();((o.prototype=Object.create(i.prototype)).constructor=o).className="Service";var e=requireMethod(),t=requireUtil(),s=rpc;function o(c,u){i.call(this,c,u),this.methods={},this._methodsArray=null}o.fromJSON=function(u,d){var p=new o(u,d.options);if(d.methods)for(var v=Object.keys(d.methods),g=0;g<v.length;++g)p.add(e.fromJSON(v[g],d.methods[v[g]]));return d.nested&&p.addJSON(d.nested),p.comment=d.comment,p},o.prototype.toJSON=function(u){var d=i.prototype.toJSON.call(this,u),p=u?!!u.keepComments:!1;return t.toObject(["options",d&&d.options||void 0,"methods",i.arrayToJSON(this.methodsArray,u)||{},"nested",d&&d.nested||void 0,"comment",p?this.comment:void 0])},Object.defineProperty(o.prototype,"methodsArray",{get:function(){return this._methodsArray||(this._methodsArray=t.toArray(this.methods))}});function a(c){return c._methodsArray=null,c}return o.prototype.get=function(u){return this.methods[u]||i.prototype.get.call(this,u)},o.prototype.resolveAll=function(){for(var u=this.methodsArray,d=0;d<u.length;++d)u[d].resolve();return i.prototype.resolve.call(this)},o.prototype.add=function(u){if(this.get(u.name))throw Error("duplicate name '"+u.name+"' in "+this);return u instanceof e?(this.methods[u.name]=u,u.parent=this,a(this)):i.prototype.add.call(this,u)},o.prototype.remove=function(u){if(u instanceof e){if(this.methods[u.name]!==u)throw Error(u+" is not a member of "+this);return delete this.methods[u.name],u.parent=null,a(this)}return i.prototype.remove.call(this,u)},o.prototype.create=function(u,d,p){for(var v=new s.Service(u,d,p),g=0,m;g<this.methodsArray.length;++g){var S=t.lcFirst((m=this._methodsArray[g]).resolve().name).replace(/[^$\w_]/g,"");v[S]=t.codegen(["r","c"],t.isReserved(S)?S+"_":S)("return this.rpcCall(m,q,s,r,c)")({m,q:m.resolvedRequestType.ctor,s:m.resolvedResponseType.ctor})}return v},service}var message=Message,util$1=requireMinimal();function Message(i){if(i)for(var e=Object.keys(i),t=0;t<e.length;++t)this[e[t]]=i[e[t]]}Message.create=function i(e){return this.$type.create(e)};Message.encode=function i(e,t){return this.$type.encode(e,t)};Message.encodeDelimited=function i(e,t){return this.$type.encodeDelimited(e,t)};Message.decode=function i(e){return this.$type.decode(e)};Message.decodeDelimited=function i(e){return this.$type.decodeDelimited(e)};Message.verify=function i(e){return this.$type.verify(e)};Message.fromObject=function i(e){return this.$type.fromObject(e)};Message.toObject=function i(e,t){return this.$type.toObject(e,t)};Message.prototype.toJSON=function i(){return this.$type.toObject(this,util$1.toJSONOptions)};var decoder_1,hasRequiredDecoder;function requireDecoder(){if(hasRequiredDecoder)return decoder_1;hasRequiredDecoder=1,decoder_1=o;var i=require_enum(),e=requireTypes(),t=requireUtil();function s(a){return"missing required '"+a.name+"'"}function o(a){var c=t.codegen(["r","l"],a.name+"$decode")("if(!(r instanceof Reader))")("r=Reader.create(r)")("var c=l===undefined?r.len:r.pos+l,m=new this.ctor"+(a.fieldsArray.filter(function(m){return m.map}).length?",k,value":""))("while(r.pos<c){")("var t=r.uint32()");a.group&&c("if((t&7)===4)")("break"),c("switch(t>>>3){");for(var u=0;u<a.fieldsArray.length;++u){var d=a._fieldsArray[u].resolve(),p=d.resolvedType instanceof i?"int32":d.type,v="m"+t.safeProp(d.name);c("case %i: {",d.id),d.map?(c("if(%s===util.emptyObject)",v)("%s={}",v)("var c2 = r.uint32()+r.pos"),e.defaults[d.keyType]!==void 0?c("k=%j",e.defaults[d.keyType]):c("k=null"),e.defaults[p]!==void 0?c("value=%j",e.defaults[p]):c("value=null"),c("while(r.pos<c2){")("var tag2=r.uint32()")("switch(tag2>>>3){")("case 1: k=r.%s(); break",d.keyType)("case 2:"),e.basic[p]===void 0?c("value=types[%i].decode(r,r.uint32())",u):c("value=r.%s()",p),c("break")("default:")("r.skipType(tag2&7)")("break")("}")("}"),e.long[d.keyType]!==void 0?c('%s[typeof k==="object"?util.longToHash(k):k]=value',v):c("%s[k]=value",v)):d.repeated?(c("if(!(%s&&%s.length))",v,v)("%s=[]",v),e.packed[p]!==void 0&&c("if((t&7)===2){")("var c2=r.uint32()+r.pos")("while(r.pos<c2)")("%s.push(r.%s())",v,p)("}else"),e.basic[p]===void 0?c(d.resolvedType.group?"%s.push(types[%i].decode(r))":"%s.push(types[%i].decode(r,r.uint32()))",v,u):c("%s.push(r.%s())",v,p)):e.basic[p]===void 0?c(d.resolvedType.group?"%s=types[%i].decode(r)":"%s=types[%i].decode(r,r.uint32())",v,u):c("%s=r.%s()",v,p),c("break")("}")}for(c("default:")("r.skipType(t&7)")("break")("}")("}"),u=0;u<a._fieldsArray.length;++u){var g=a._fieldsArray[u];g.required&&c("if(!m.hasOwnProperty(%j))",g.name)("throw util.ProtocolError(%j,{instance:m})",s(g))}return c("return m")}return decoder_1}var verifier_1,hasRequiredVerifier;function requireVerifier(){if(hasRequiredVerifier)return verifier_1;hasRequiredVerifier=1,verifier_1=a;var i=require_enum(),e=requireUtil();function t(c,u){return c.name+": "+u+(c.repeated&&u!=="array"?"[]":c.map&&u!=="object"?"{k:"+c.keyType+"}":"")+" expected"}function s(c,u,d,p){if(u.resolvedType)if(u.resolvedType instanceof i){c("switch(%s){",p)("default:")("return%j",t(u,"enum value"));for(var v=Object.keys(u.resolvedType.values),g=0;g<v.length;++g)c("case %i:",u.resolvedType.values[v[g]]);c("break")("}")}else c("{")("var e=types[%i].verify(%s);",d,p)("if(e)")("return%j+e",u.name+".")("}");else switch(u.type){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":c("if(!util.isInteger(%s))",p)("return%j",t(u,"integer"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":c("if(!util.isInteger(%s)&&!(%s&&util.isInteger(%s.low)&&util.isInteger(%s.high)))",p,p,p,p)("return%j",t(u,"integer|Long"));break;case"float":case"double":c('if(typeof %s!=="number")',p)("return%j",t(u,"number"));break;case"bool":c('if(typeof %s!=="boolean")',p)("return%j",t(u,"boolean"));break;case"string":c("if(!util.isString(%s))",p)("return%j",t(u,"string"));break;case"bytes":c('if(!(%s&&typeof %s.length==="number"||util.isString(%s)))',p,p,p)("return%j",t(u,"buffer"));break}return c}function o(c,u,d){switch(u.keyType){case"int32":case"uint32":case"sint32":case"fixed32":case"sfixed32":c("if(!util.key32Re.test(%s))",d)("return%j",t(u,"integer key"));break;case"int64":case"uint64":case"sint64":case"fixed64":case"sfixed64":c("if(!util.key64Re.test(%s))",d)("return%j",t(u,"integer|Long key"));break;case"bool":c("if(!util.key2Re.test(%s))",d)("return%j",t(u,"boolean key"));break}return c}function a(c){var u=e.codegen(["m"],c.name+"$verify")('if(typeof m!=="object"||m===null)')("return%j","object expected"),d=c.oneofsArray,p={};d.length&&u("var p={}");for(var v=0;v<c.fieldsArray.length;++v){var g=c._fieldsArray[v].resolve(),m="m"+e.safeProp(g.name);if(g.optional&&u("if(%s!=null&&m.hasOwnProperty(%j)){",m,g.name),g.map)u("if(!util.isObject(%s))",m)("return%j",t(g,"object"))("var k=Object.keys(%s)",m)("for(var i=0;i<k.length;++i){"),o(u,g,"k[i]"),s(u,g,v,m+"[k[i]]")("}");else if(g.repeated)u("if(!Array.isArray(%s))",m)("return%j",t(g,"array"))("for(var i=0;i<%s.length;++i){",m),s(u,g,v,m+"[i]")("}");else{if(g.partOf){var S=e.safeProp(g.partOf.name);p[g.partOf.name]===1&&u("if(p%s===1)",S)("return%j",g.partOf.name+": multiple values"),p[g.partOf.name]=1,u("p%s=1",S)}s(u,g,v,m)}g.optional&&u("}")}return u("return null")}return verifier_1}var converter={},hasRequiredConverter;function requireConverter(){return hasRequiredConverter||(hasRequiredConverter=1,function(i){var e=i,t=require_enum(),s=requireUtil();function o(c,u,d,p){var v=!1;if(u.resolvedType)if(u.resolvedType instanceof t){c("switch(d%s){",p);for(var g=u.resolvedType.values,m=Object.keys(g),S=0;S<m.length;++S)g[m[S]]===u.typeDefault&&!v&&(c("default:")('if(typeof(d%s)==="number"){m%s=d%s;break}',p,p,p),u.repeated||c("break"),v=!0),c("case%j:",m[S])("case %i:",g[m[S]])("m%s=%j",p,g[m[S]])("break");c("}")}else c('if(typeof d%s!=="object")',p)("throw TypeError(%j)",u.fullName+": object expected")("m%s=types[%i].fromObject(d%s)",p,d,p);else{var y=!1;switch(u.type){case"double":case"float":c("m%s=Number(d%s)",p,p);break;case"uint32":case"fixed32":c("m%s=d%s>>>0",p,p);break;case"int32":case"sint32":case"sfixed32":c("m%s=d%s|0",p,p);break;case"uint64":y=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":c("if(util.Long)")("(m%s=util.Long.fromValue(d%s)).unsigned=%j",p,p,y)('else if(typeof d%s==="string")',p)("m%s=parseInt(d%s,10)",p,p)('else if(typeof d%s==="number")',p)("m%s=d%s",p,p)('else if(typeof d%s==="object")',p)("m%s=new util.LongBits(d%s.low>>>0,d%s.high>>>0).toNumber(%s)",p,p,p,y?"true":"");break;case"bytes":c('if(typeof d%s==="string")',p)("util.base64.decode(d%s,m%s=util.newBuffer(util.base64.length(d%s)),0)",p,p,p)("else if(d%s.length >= 0)",p)("m%s=d%s",p,p);break;case"string":c("m%s=String(d%s)",p,p);break;case"bool":c("m%s=Boolean(d%s)",p,p);break}}return c}e.fromObject=function(u){var d=u.fieldsArray,p=s.codegen(["d"],u.name+"$fromObject")("if(d instanceof this.ctor)")("return d");if(!d.length)return p("return new this.ctor");p("var m=new this.ctor");for(var v=0;v<d.length;++v){var g=d[v].resolve(),m=s.safeProp(g.name);g.map?(p("if(d%s){",m)('if(typeof d%s!=="object")',m)("throw TypeError(%j)",g.fullName+": object expected")("m%s={}",m)("for(var ks=Object.keys(d%s),i=0;i<ks.length;++i){",m),o(p,g,v,m+"[ks[i]]")("}")("}")):g.repeated?(p("if(d%s){",m)("if(!Array.isArray(d%s))",m)("throw TypeError(%j)",g.fullName+": array expected")("m%s=[]",m)("for(var i=0;i<d%s.length;++i){",m),o(p,g,v,m+"[i]")("}")("}")):(g.resolvedType instanceof t||p("if(d%s!=null){",m),o(p,g,v,m),g.resolvedType instanceof t||p("}"))}return p("return m")};function a(c,u,d,p){if(u.resolvedType)u.resolvedType instanceof t?c("d%s=o.enums===String?(types[%i].values[m%s]===undefined?m%s:types[%i].values[m%s]):m%s",p,d,p,p,d,p,p):c("d%s=types[%i].toObject(m%s,o)",p,d,p);else{var v=!1;switch(u.type){case"double":case"float":c("d%s=o.json&&!isFinite(m%s)?String(m%s):m%s",p,p,p,p);break;case"uint64":v=!0;case"int64":case"sint64":case"fixed64":case"sfixed64":c('if(typeof m%s==="number")',p)("d%s=o.longs===String?String(m%s):m%s",p,p,p)("else")("d%s=o.longs===String?util.Long.prototype.toString.call(m%s):o.longs===Number?new util.LongBits(m%s.low>>>0,m%s.high>>>0).toNumber(%s):m%s",p,p,p,p,v?"true":"",p);break;case"bytes":c("d%s=o.bytes===String?util.base64.encode(m%s,0,m%s.length):o.bytes===Array?Array.prototype.slice.call(m%s):m%s",p,p,p,p,p);break;default:c("d%s=m%s",p,p);break}}return c}e.toObject=function(u){var d=u.fieldsArray.slice().sort(s.compareFieldsById);if(!d.length)return s.codegen()("return {}");for(var p=s.codegen(["m","o"],u.name+"$toObject")("if(!o)")("o={}")("var d={}"),v=[],g=[],m=[],S=0;S<d.length;++S)d[S].partOf||(d[S].resolve().repeated?v:d[S].map?g:m).push(d[S]);if(v.length){for(p("if(o.arrays||o.defaults){"),S=0;S<v.length;++S)p("d%s=[]",s.safeProp(v[S].name));p("}")}if(g.length){for(p("if(o.objects||o.defaults){"),S=0;S<g.length;++S)p("d%s={}",s.safeProp(g[S].name));p("}")}if(m.length){for(p("if(o.defaults){"),S=0;S<m.length;++S){var y=m[S],C=s.safeProp(y.name);if(y.resolvedType instanceof t)p("d%s=o.enums===String?%j:%j",C,y.resolvedType.valuesById[y.typeDefault],y.typeDefault);else if(y.long)p("if(util.Long){")("var n=new util.Long(%i,%i,%j)",y.typeDefault.low,y.typeDefault.high,y.typeDefault.unsigned)("d%s=o.longs===String?n.toString():o.longs===Number?n.toNumber():n",C)("}else")("d%s=o.longs===String?%j:%i",C,y.typeDefault.toString(),y.typeDefault.toNumber());else if(y.bytes){var R="["+Array.prototype.slice.call(y.typeDefault).join(",")+"]";p("if(o.bytes===String)d%s=%j",C,String.fromCharCode.apply(String,y.typeDefault))("else{")("d%s=%s",C,R)("if(o.bytes!==Array)d%s=util.newBuffer(d%s)",C,C)("}")}else p("d%s=%j",C,y.typeDefault)}p("}")}var T=!1;for(S=0;S<d.length;++S){var y=d[S],E=u._fieldsArray.indexOf(y),C=s.safeProp(y.name);y.map?(T||(T=!0,p("var ks2")),p("if(m%s&&(ks2=Object.keys(m%s)).length){",C,C)("d%s={}",C)("for(var j=0;j<ks2.length;++j){"),a(p,y,E,C+"[ks2[j]]")("}")):y.repeated?(p("if(m%s&&m%s.length){",C,C)("d%s=[]",C)("for(var j=0;j<m%s.length;++j){",C),a(p,y,E,C+"[j]")("}")):(p("if(m%s!=null&&m.hasOwnProperty(%j)){",C,y.name),a(p,y,E,C),y.partOf&&p("if(o.oneofs)")("d%s=%j",s.safeProp(y.partOf.name),y.name)),p("}")}return p("return d")}}(converter)),converter}var wrappers={};(function(i){var e=i,t=message;e[".google.protobuf.Any"]={fromObject:function(s){if(s&&s["@type"]){var o=s["@type"].substring(s["@type"].lastIndexOf("/")+1),a=this.lookup(o);if(a){var c=s["@type"].charAt(0)==="."?s["@type"].slice(1):s["@type"];return c.indexOf("/")===-1&&(c="/"+c),this.create({type_url:c,value:a.encode(a.fromObject(s)).finish()})}}return this.fromObject(s)},toObject:function(s,o){var a="type.googleapis.com/",c="",u="";if(o&&o.json&&s.type_url&&s.value){u=s.type_url.substring(s.type_url.lastIndexOf("/")+1),c=s.type_url.substring(0,s.type_url.lastIndexOf("/")+1);var d=this.lookup(u);d&&(s=d.decode(s.value))}if(!(s instanceof this.ctor)&&s instanceof t){var p=s.$type.toObject(s,o),v=s.$type.fullName[0]==="."?s.$type.fullName.slice(1):s.$type.fullName;return c===""&&(c=a),u=c+v,p["@type"]=u,p}return this.toObject(s,o)}}})(wrappers);var type,hasRequiredType;function requireType(){if(hasRequiredType)return type;hasRequiredType=1,type=C;var i=requireNamespace();((C.prototype=Object.create(i.prototype)).constructor=C).className="Type";var e=require_enum(),t=requireOneof(),s=requireField(),o=requireMapfield(),a=requireService(),c=message,u=reader,d=writer,p=requireUtil(),v=requireEncoder(),g=requireDecoder(),m=requireVerifier(),S=requireConverter(),y=wrappers;function C(T,E){i.call(this,T,E),this.fields={},this.oneofs=void 0,this.extensions=void 0,this.reserved=void 0,this.group=void 0,this._fieldsById=null,this._fieldsArray=null,this._oneofsArray=null,this._ctor=null}Object.defineProperties(C.prototype,{fieldsById:{get:function(){if(this._fieldsById)return this._fieldsById;this._fieldsById={};for(var T=Object.keys(this.fields),E=0;E<T.length;++E){var A=this.fields[T[E]],b=A.id;if(this._fieldsById[b])throw Error("duplicate id "+b+" in "+this);this._fieldsById[b]=A}return this._fieldsById}},fieldsArray:{get:function(){return this._fieldsArray||(this._fieldsArray=p.toArray(this.fields))}},oneofsArray:{get:function(){return this._oneofsArray||(this._oneofsArray=p.toArray(this.oneofs))}},ctor:{get:function(){return this._ctor||(this.ctor=C.generateConstructor(this)())},set:function(T){var E=T.prototype;E instanceof c||((T.prototype=new c).constructor=T,p.merge(T.prototype,E)),T.$type=T.prototype.$type=this,p.merge(T,c,!0),this._ctor=T;for(var A=0;A<this.fieldsArray.length;++A)this._fieldsArray[A].resolve();var b={};for(A=0;A<this.oneofsArray.length;++A)b[this._oneofsArray[A].resolve().name]={get:p.oneOfGetter(this._oneofsArray[A].oneof),set:p.oneOfSetter(this._oneofsArray[A].oneof)};A&&Object.defineProperties(T.prototype,b)}}}),C.generateConstructor=function(E){for(var A=p.codegen(["p"],E.name),b=0,P;b<E.fieldsArray.length;++b)(P=E._fieldsArray[b]).map?A("this%s={}",p.safeProp(P.name)):P.repeated&&A("this%s=[]",p.safeProp(P.name));return A("if(p)for(var ks=Object.keys(p),i=0;i<ks.length;++i)if(p[ks[i]]!=null)")("this[ks[i]]=p[ks[i]]")};function R(T){return T._fieldsById=T._fieldsArray=T._oneofsArray=null,delete T.encode,delete T.decode,delete T.verify,T}return C.fromJSON=function(E,A){var b=new C(E,A.options);b.extensions=A.extensions,b.reserved=A.reserved;for(var P=Object.keys(A.fields),_=0;_<P.length;++_)b.add((typeof A.fields[P[_]].keyType<"u"?o.fromJSON:s.fromJSON)(P[_],A.fields[P[_]]));if(A.oneofs)for(P=Object.keys(A.oneofs),_=0;_<P.length;++_)b.add(t.fromJSON(P[_],A.oneofs[P[_]]));if(A.nested)for(P=Object.keys(A.nested),_=0;_<P.length;++_){var w=A.nested[P[_]];b.add((w.id!==void 0?s.fromJSON:w.fields!==void 0?C.fromJSON:w.values!==void 0?e.fromJSON:w.methods!==void 0?a.fromJSON:i.fromJSON)(P[_],w))}return A.extensions&&A.extensions.length&&(b.extensions=A.extensions),A.reserved&&A.reserved.length&&(b.reserved=A.reserved),A.group&&(b.group=!0),A.comment&&(b.comment=A.comment),b},C.prototype.toJSON=function(E){var A=i.prototype.toJSON.call(this,E),b=E?!!E.keepComments:!1;return p.toObject(["options",A&&A.options||void 0,"oneofs",i.arrayToJSON(this.oneofsArray,E),"fields",i.arrayToJSON(this.fieldsArray.filter(function(P){return!P.declaringField}),E)||{},"extensions",this.extensions&&this.extensions.length?this.extensions:void 0,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"group",this.group||void 0,"nested",A&&A.nested||void 0,"comment",b?this.comment:void 0])},C.prototype.resolveAll=function(){for(var E=this.fieldsArray,A=0;A<E.length;)E[A++].resolve();var b=this.oneofsArray;for(A=0;A<b.length;)b[A++].resolve();return i.prototype.resolveAll.call(this)},C.prototype.get=function(E){return this.fields[E]||this.oneofs&&this.oneofs[E]||this.nested&&this.nested[E]||null},C.prototype.add=function(E){if(this.get(E.name))throw Error("duplicate name '"+E.name+"' in "+this);if(E instanceof s&&E.extend===void 0){if(this._fieldsById?this._fieldsById[E.id]:this.fieldsById[E.id])throw Error("duplicate id "+E.id+" in "+this);if(this.isReservedId(E.id))throw Error("id "+E.id+" is reserved in "+this);if(this.isReservedName(E.name))throw Error("name '"+E.name+"' is reserved in "+this);return E.parent&&E.parent.remove(E),this.fields[E.name]=E,E.message=this,E.onAdd(this),R(this)}return E instanceof t?(this.oneofs||(this.oneofs={}),this.oneofs[E.name]=E,E.onAdd(this),R(this)):i.prototype.add.call(this,E)},C.prototype.remove=function(E){if(E instanceof s&&E.extend===void 0){if(!this.fields||this.fields[E.name]!==E)throw Error(E+" is not a member of "+this);return delete this.fields[E.name],E.parent=null,E.onRemove(this),R(this)}if(E instanceof t){if(!this.oneofs||this.oneofs[E.name]!==E)throw Error(E+" is not a member of "+this);return delete this.oneofs[E.name],E.parent=null,E.onRemove(this),R(this)}return i.prototype.remove.call(this,E)},C.prototype.isReservedId=function(E){return i.isReservedId(this.reserved,E)},C.prototype.isReservedName=function(E){return i.isReservedName(this.reserved,E)},C.prototype.create=function(E){return new this.ctor(E)},C.prototype.setup=function(){for(var E=this.fullName,A=[],b=0;b<this.fieldsArray.length;++b)A.push(this._fieldsArray[b].resolve().resolvedType);this.encode=v(this)({Writer:d,types:A,util:p}),this.decode=g(this)({Reader:u,types:A,util:p}),this.verify=m(this)({types:A,util:p}),this.fromObject=S.fromObject(this)({types:A,util:p}),this.toObject=S.toObject(this)({types:A,util:p});var P=y[E];if(P){var _=Object.create(this);_.fromObject=this.fromObject,this.fromObject=P.fromObject.bind(_),_.toObject=this.toObject,this.toObject=P.toObject.bind(_)}return this},C.prototype.encode=function(E,A){return this.setup().encode(E,A)},C.prototype.encodeDelimited=function(E,A){return this.encode(E,A&&A.len?A.fork():A).ldelim()},C.prototype.decode=function(E,A){return this.setup().decode(E,A)},C.prototype.decodeDelimited=function(E){return E instanceof u||(E=u.create(E)),this.decode(E,E.uint32())},C.prototype.verify=function(E){return this.setup().verify(E)},C.prototype.fromObject=function(E){return this.setup().fromObject(E)},C.prototype.toObject=function(E,A){return this.setup().toObject(E,A)},C.d=function(E){return function(b){p.decorateType(b,E)}},type}var root,hasRequiredRoot;function requireRoot(){if(hasRequiredRoot)return root;hasRequiredRoot=1,root=d;var i=requireNamespace();((d.prototype=Object.create(i.prototype)).constructor=d).className="Root";var e=requireField(),t=require_enum(),s=requireOneof(),o=requireUtil(),a,c,u;function d(m){i.call(this,"",m),this.deferred=[],this.files=[]}d.fromJSON=function(S,y){return y||(y=new d),S.options&&y.setOptions(S.options),y.addJSON(S.nested)},d.prototype.resolvePath=o.path.resolve,d.prototype.fetch=o.fetch;function p(){}d.prototype.load=function m(S,y,C){typeof y=="function"&&(C=y,y=void 0);var R=this;if(!C)return o.asPromise(m,R,S,y);var T=C===p;function E(D,N){if(C){if(T)throw D;var L=C;C=null,L(D,N)}}function A(D){var N=D.lastIndexOf("google/protobuf/");if(N>-1){var L=D.substring(N);if(L in u)return L}return null}function b(D,N){try{if(o.isString(N)&&N.charAt(0)==="{"&&(N=JSON.parse(N)),!o.isString(N))R.setOptions(N.options).addJSON(N.nested);else{c.filename=D;var L=c(N,R,y),j,z=0;if(L.imports)for(;z<L.imports.length;++z)(j=A(L.imports[z])||R.resolvePath(D,L.imports[z]))&&P(j);if(L.weakImports)for(z=0;z<L.weakImports.length;++z)(j=A(L.weakImports[z])||R.resolvePath(D,L.weakImports[z]))&&P(j,!0)}}catch(U){E(U)}!T&&!_&&E(null,R)}function P(D,N){if(D=A(D)||D,!(R.files.indexOf(D)>-1)){if(R.files.push(D),D in u){T?b(D,u[D]):(++_,setTimeout(function(){--_,b(D,u[D])}));return}if(T){var L;try{L=o.fs.readFileSync(D).toString("utf8")}catch(j){N||E(j);return}b(D,L)}else++_,R.fetch(D,function(j,z){if(--_,!!C){if(j){N?_||E(null,R):E(j);return}b(D,z)}})}}var _=0;o.isString(S)&&(S=[S]);for(var w=0,I;w<S.length;++w)(I=R.resolvePath("",S[w]))&&P(I);if(T)return R;_||E(null,R)},d.prototype.loadSync=function(S,y){if(!o.isNode)throw Error("not supported");return this.load(S,y,p)},d.prototype.resolveAll=function(){if(this.deferred.length)throw Error("unresolvable extensions: "+this.deferred.map(function(S){return"'extend "+S.extend+"' in "+S.parent.fullName}).join(", "));return i.prototype.resolveAll.call(this)};var v=/^[A-Z]/;function g(m,S){var y=S.parent.lookup(S.extend);if(y){var C=new e(S.fullName,S.id,S.type,S.rule,void 0,S.options);return y.get(C.name)||(C.declaringField=S,S.extensionField=C,y.add(C)),!0}return!1}return d.prototype._handleAdd=function(S){if(S instanceof e)S.extend!==void 0&&!S.extensionField&&(g(this,S)||this.deferred.push(S));else if(S instanceof t)v.test(S.name)&&(S.parent[S.name]=S.values);else if(!(S instanceof s)){if(S instanceof a)for(var y=0;y<this.deferred.length;)g(this,this.deferred[y])?this.deferred.splice(y,1):++y;for(var C=0;C<S.nestedArray.length;++C)this._handleAdd(S._nestedArray[C]);v.test(S.name)&&(S.parent[S.name]=S)}},d.prototype._handleRemove=function(S){if(S instanceof e){if(S.extend!==void 0)if(S.extensionField)S.extensionField.parent.remove(S.extensionField),S.extensionField=null;else{var y=this.deferred.indexOf(S);y>-1&&this.deferred.splice(y,1)}}else if(S instanceof t)v.test(S.name)&&delete S.parent[S.name];else if(S instanceof i){for(var C=0;C<S.nestedArray.length;++C)this._handleRemove(S._nestedArray[C]);v.test(S.name)&&delete S.parent[S.name]}},d._configure=function(m,S,y){a=m,c=S,u=y},root}var hasRequiredUtil;function requireUtil(){if(hasRequiredUtil)return util$2.exports;hasRequiredUtil=1;var i=util$2.exports=requireMinimal(),e=roots,t,s;i.codegen=codegen_1,i.fetch=fetch_1,i.path=path,i.fs=i.inquire("fs"),i.toArray=function(p){if(p){for(var v=Object.keys(p),g=new Array(v.length),m=0;m<v.length;)g[m]=p[v[m++]];return g}return[]},i.toObject=function(p){for(var v={},g=0;g<p.length;){var m=p[g++],S=p[g++];S!==void 0&&(v[m]=S)}return v};var o=/\\/g,a=/"/g;i.isReserved=function(p){return/^(?:do|if|in|for|let|new|try|var|case|else|enum|eval|false|null|this|true|void|with|break|catch|class|const|super|throw|while|yield|delete|export|import|public|return|static|switch|typeof|default|extends|finally|package|private|continue|debugger|function|arguments|interface|protected|implements|instanceof)$/.test(p)},i.safeProp=function(p){return!/^[$\w_]+$/.test(p)||i.isReserved(p)?'["'+p.replace(o,"\\\\").replace(a,'\\"')+'"]':"."+p},i.ucFirst=function(p){return p.charAt(0).toUpperCase()+p.substring(1)};var c=/_([a-z])/g;i.camelCase=function(p){return p.substring(0,1)+p.substring(1).replace(c,function(v,g){return g.toUpperCase()})},i.compareFieldsById=function(p,v){return p.id-v.id},i.decorateType=function(p,v){if(p.$type)return v&&p.$type.name!==v&&(i.decorateRoot.remove(p.$type),p.$type.name=v,i.decorateRoot.add(p.$type)),p.$type;t||(t=requireType());var g=new t(v||p.name);return i.decorateRoot.add(g),g.ctor=p,Object.defineProperty(p,"$type",{value:g,enumerable:!1}),Object.defineProperty(p.prototype,"$type",{value:g,enumerable:!1}),g};var u=0;return i.decorateEnum=function(p){if(p.$type)return p.$type;s||(s=require_enum());var v=new s("Enum"+u++,p);return i.decorateRoot.add(v),Object.defineProperty(p,"$type",{value:v,enumerable:!1}),v},i.setProperty=function(p,v,g){function m(S,y,C){var R=y.shift();if(R==="__proto__"||R==="prototype")return S;if(y.length>0)S[R]=m(S[R]||{},y,C);else{var T=S[R];T&&(C=[].concat(T).concat(C)),S[R]=C}return S}if(typeof p!="object")throw TypeError("dst must be an object");if(!v)throw TypeError("path must be specified");return v=v.split("."),m(p,v,g)},Object.defineProperty(i,"decorateRoot",{get:function(){return e.decorated||(e.decorated=new(requireRoot()))}}),util$2.exports}var object,hasRequiredObject;function requireObject(){if(hasRequiredObject)return object;hasRequiredObject=1,object=t,t.className="ReflectionObject";var i=requireUtil(),e;function t(s,o){if(!i.isString(s))throw TypeError("name must be a string");if(o&&!i.isObject(o))throw TypeError("options must be an object");this.options=o,this.parsedOptions=null,this.name=s,this.parent=null,this.resolved=!1,this.comment=null,this.filename=null}return Object.defineProperties(t.prototype,{root:{get:function(){for(var s=this;s.parent!==null;)s=s.parent;return s}},fullName:{get:function(){for(var s=[this.name],o=this.parent;o;)s.unshift(o.name),o=o.parent;return s.join(".")}}}),t.prototype.toJSON=function(){throw Error()},t.prototype.onAdd=function(o){this.parent&&this.parent!==o&&this.parent.remove(this),this.parent=o,this.resolved=!1;var a=o.root;a instanceof e&&a._handleAdd(this)},t.prototype.onRemove=function(o){var a=o.root;a instanceof e&&a._handleRemove(this),this.parent=null,this.resolved=!1},t.prototype.resolve=function(){return this.resolved?this:(this.root instanceof e&&(this.resolved=!0),this)},t.prototype.getOption=function(o){if(this.options)return this.options[o]},t.prototype.setOption=function(o,a,c){return(!c||!this.options||this.options[o]===void 0)&&((this.options||(this.options={}))[o]=a),this},t.prototype.setParsedOption=function(o,a,c){this.parsedOptions||(this.parsedOptions=[]);var u=this.parsedOptions;if(c){var d=u.find(function(g){return Object.prototype.hasOwnProperty.call(g,o)});if(d){var p=d[o];i.setProperty(p,c,a)}else d={},d[o]=i.setProperty({},c,a),u.push(d)}else{var v={};v[o]=a,u.push(v)}return this},t.prototype.setOptions=function(o,a){if(o)for(var c=Object.keys(o),u=0;u<c.length;++u)this.setOption(c[u],o[c[u]],a);return this},t.prototype.toString=function(){var o=this.constructor.className,a=this.fullName;return a.length?o+" "+a:o},t._configure=function(s){e=s},object}var _enum,hasRequired_enum;function require_enum(){if(hasRequired_enum)return _enum;hasRequired_enum=1,_enum=s;var i=requireObject();((s.prototype=Object.create(i.prototype)).constructor=s).className="Enum";var e=requireNamespace(),t=requireUtil();function s(o,a,c,u,d,p){if(i.call(this,o,c),a&&typeof a!="object")throw TypeError("values must be an object");if(this.valuesById={},this.values=Object.create(this.valuesById),this.comment=u,this.comments=d||{},this.valuesOptions=p,this.reserved=void 0,a)for(var v=Object.keys(a),g=0;g<v.length;++g)typeof a[v[g]]=="number"&&(this.valuesById[this.values[v[g]]=a[v[g]]]=v[g])}return s.fromJSON=function(a,c){var u=new s(a,c.values,c.options,c.comment,c.comments);return u.reserved=c.reserved,u},s.prototype.toJSON=function(a){var c=a?!!a.keepComments:!1;return t.toObject(["options",this.options,"valuesOptions",this.valuesOptions,"values",this.values,"reserved",this.reserved&&this.reserved.length?this.reserved:void 0,"comment",c?this.comment:void 0,"comments",c?this.comments:void 0])},s.prototype.add=function(a,c,u,d){if(!t.isString(a))throw TypeError("name must be a string");if(!t.isInteger(c))throw TypeError("id must be an integer");if(this.values[a]!==void 0)throw Error("duplicate name '"+a+"' in "+this);if(this.isReservedId(c))throw Error("id "+c+" is reserved in "+this);if(this.isReservedName(a))throw Error("name '"+a+"' is reserved in "+this);if(this.valuesById[c]!==void 0){if(!(this.options&&this.options.allow_alias))throw Error("duplicate id "+c+" in "+this);this.values[a]=c}else this.valuesById[this.values[a]=c]=a;return d&&(this.valuesOptions===void 0&&(this.valuesOptions={}),this.valuesOptions[a]=d||null),this.comments[a]=u||null,this},s.prototype.remove=function(a){if(!t.isString(a))throw TypeError("name must be a string");var c=this.values[a];if(c==null)throw Error("name '"+a+"' does not exist in "+this);return delete this.valuesById[c],delete this.values[a],delete this.comments[a],this.valuesOptions&&delete this.valuesOptions[a],this},s.prototype.isReservedId=function(a){return e.isReservedId(this.reserved,a)},s.prototype.isReservedName=function(a){return e.isReservedName(this.reserved,a)},_enum}var encoder_1,hasRequiredEncoder;function requireEncoder(){if(hasRequiredEncoder)return encoder_1;hasRequiredEncoder=1,encoder_1=o;var i=require_enum(),e=requireTypes(),t=requireUtil();function s(a,c,u,d){return c.resolvedType.group?a("types[%i].encode(%s,w.uint32(%i)).uint32(%i)",u,d,(c.id<<3|3)>>>0,(c.id<<3|4)>>>0):a("types[%i].encode(%s,w.uint32(%i).fork()).ldelim()",u,d,(c.id<<3|2)>>>0)}function o(a){for(var c=t.codegen(["m","w"],a.name+"$encode")("if(!w)")("w=Writer.create()"),u,d,p=a.fieldsArray.slice().sort(t.compareFieldsById),u=0;u<p.length;++u){var v=p[u].resolve(),g=a._fieldsArray.indexOf(v),m=v.resolvedType instanceof i?"int32":v.type,S=e.basic[m];d="m"+t.safeProp(v.name),v.map?(c("if(%s!=null&&Object.hasOwnProperty.call(m,%j)){",d,v.name)("for(var ks=Object.keys(%s),i=0;i<ks.length;++i){",d)("w.uint32(%i).fork().uint32(%i).%s(ks[i])",(v.id<<3|2)>>>0,8|e.mapKey[v.keyType],v.keyType),S===void 0?c("types[%i].encode(%s[ks[i]],w.uint32(18).fork()).ldelim().ldelim()",g,d):c(".uint32(%i).%s(%s[ks[i]]).ldelim()",16|S,m,d),c("}")("}")):v.repeated?(c("if(%s!=null&&%s.length){",d,d),v.packed&&e.packed[m]!==void 0?c("w.uint32(%i).fork()",(v.id<<3|2)>>>0)("for(var i=0;i<%s.length;++i)",d)("w.%s(%s[i])",m,d)("w.ldelim()"):(c("for(var i=0;i<%s.length;++i)",d),S===void 0?s(c,v,g,d+"[i]"):c("w.uint32(%i).%s(%s[i])",(v.id<<3|S)>>>0,m,d)),c("}")):(v.optional&&c("if(%s!=null&&Object.hasOwnProperty.call(m,%j))",d,v.name),S===void 0?s(c,v,g,d):c("w.uint32(%i).%s(%s)",(v.id<<3|S)>>>0,m,d))}return c("return w")}return encoder_1}var protobuf$2=indexLight.exports=indexMinimal;protobuf$2.build="light";function load(i,e,t){return typeof e=="function"?(t=e,e=new protobuf$2.Root):e||(e=new protobuf$2.Root),e.load(i,t)}protobuf$2.load=load;function loadSync(i,e){return e||(e=new protobuf$2.Root),e.loadSync(i)}protobuf$2.loadSync=loadSync;protobuf$2.encoder=requireEncoder();protobuf$2.decoder=requireDecoder();protobuf$2.verifier=requireVerifier();protobuf$2.converter=requireConverter();protobuf$2.ReflectionObject=requireObject();protobuf$2.Namespace=requireNamespace();protobuf$2.Root=requireRoot();protobuf$2.Enum=require_enum();protobuf$2.Type=requireType();protobuf$2.Field=requireField();protobuf$2.OneOf=requireOneof();protobuf$2.MapField=requireMapfield();protobuf$2.Service=requireService();protobuf$2.Method=requireMethod();protobuf$2.Message=message;protobuf$2.wrappers=wrappers;protobuf$2.types=requireTypes();protobuf$2.util=requireUtil();protobuf$2.ReflectionObject._configure(protobuf$2.Root);protobuf$2.Namespace._configure(protobuf$2.Type,protobuf$2.Service,protobuf$2.Enum);protobuf$2.Root._configure(protobuf$2.Type);protobuf$2.Field._configure(protobuf$2.Type);var indexLightExports=indexLight.exports,tokenize_1=tokenize$1,delimRe=/[\s{}=;:[\],'"()<>]/g,stringDoubleRe=/(?:"([^"\\]*(?:\\.[^"\\]*)*)")/g,stringSingleRe=/(?:'([^'\\]*(?:\\.[^'\\]*)*)')/g,setCommentRe=/^ *[*/]+ */,setCommentAltRe=/^\s*\*?\/*/,setCommentSplitRe=/\n/g,whitespaceRe=/\s/,unescapeRe=/\\(.?)/g,unescapeMap={0:"\0",r:"\r",n:`
`,t:"	"};function unescape$1(i){return i.replace(unescapeRe,function(e,t){switch(t){case"\\":case"":return t;default:return unescapeMap[t]||""}})}tokenize$1.unescape=unescape$1;function tokenize$1(i,e){i=i.toString();var t=0,s=i.length,o=1,a=0,c={},u=[],d=null;function p(b){return Error("illegal "+b+" (line "+o+")")}function v(){var b=d==="'"?stringSingleRe:stringDoubleRe;b.lastIndex=t-1;var P=b.exec(i);if(!P)throw p("string");return t=b.lastIndex,R(d),d=null,unescape$1(P[1])}function g(b){return i.charAt(b)}function m(b,P,_){var w={type:i.charAt(b++),lineEmpty:!1,leading:_},I;e?I=2:I=3;var D=b-I,N;do if(--D<0||(N=i.charAt(D))===`
`){w.lineEmpty=!0;break}while(N===" "||N==="	");for(var L=i.substring(b,P).split(setCommentSplitRe),j=0;j<L.length;++j)L[j]=L[j].replace(e?setCommentAltRe:setCommentRe,"").trim();w.text=L.join(`
`).trim(),c[o]=w,a=o}function S(b){var P=y(b),_=i.substring(b,P),w=/^\s*\/\//.test(_);return w}function y(b){for(var P=b;P<s&&g(P)!==`
`;)P++;return P}function C(){if(u.length>0)return u.shift();if(d)return v();var b,P,_,w,I,D=t===0;do{if(t===s)return null;for(b=!1;whitespaceRe.test(_=g(t));)if(_===`
`&&(D=!0,++o),++t===s)return null;if(g(t)==="/"){if(++t===s)throw p("comment");if(g(t)==="/")if(e){if(w=t,I=!1,S(t-1)){I=!0;do if(t=y(t),t===s||(t++,!D))break;while(S(t))}else t=Math.min(s,y(t)+1);I&&(m(w,t,D),D=!0),o++,b=!0}else{for(I=g(w=t+1)==="/";g(++t)!==`
`;)if(t===s)return null;++t,I&&(m(w,t-1,D),D=!0),++o,b=!0}else if((_=g(t))==="*"){w=t+1,I=e||g(w)==="*";do{if(_===`
`&&++o,++t===s)throw p("comment");P=_,_=g(t)}while(P!=="*"||_!=="/");++t,I&&(m(w,t-2,D),D=!0),b=!0}else return"/"}}while(b);var N=t;delimRe.lastIndex=0;var L=delimRe.test(g(N++));if(!L)for(;N<s&&!delimRe.test(g(N));)++N;var j=i.substring(t,t=N);return(j==='"'||j==="'")&&(d=j),j}function R(b){u.push(b)}function T(){if(!u.length){var b=C();if(b===null)return null;R(b)}return u[0]}function E(b,P){var _=T(),w=_===b;if(w)return C(),!0;if(!P)throw p("token '"+_+"', '"+b+"' expected");return!1}function A(b){var P=null,_;return b===void 0?(_=c[o-1],delete c[o-1],_&&(e||_.type==="*"||_.lineEmpty)&&(P=_.leading?_.text:null)):(a<b&&T(),_=c[b],delete c[b],_&&!_.lineEmpty&&(e||_.type==="/")&&(P=_.leading?null:_.text)),P}return Object.defineProperty({next:C,peek:T,push:R,skip:E,cmnt:A},"line",{get:function(){return o}})}var parse_1=parse$2;parse$2.filename=null;parse$2.defaults={keepCase:!1};var tokenize=tokenize_1,Root=requireRoot(),Type=requireType(),Field=requireField(),MapField=requireMapfield(),OneOf=requireOneof(),Enum=require_enum(),Service=requireService(),Method=requireMethod(),types=requireTypes(),util=requireUtil(),base10Re=/^[1-9][0-9]*$/,base10NegRe=/^-?[1-9][0-9]*$/,base16Re=/^0[x][0-9a-fA-F]+$/,base16NegRe=/^-?0[x][0-9a-fA-F]+$/,base8Re=/^0[0-7]+$/,base8NegRe=/^-?0[0-7]+$/,numberRe=/^(?![eE])[0-9]*(?:\.[0-9]*)?(?:[eE][+-]?[0-9]+)?$/,nameRe=/^[a-zA-Z_][a-zA-Z_0-9]*$/,typeRefRe=/^(?:\.?[a-zA-Z_][a-zA-Z_0-9]*)(?:\.[a-zA-Z_][a-zA-Z_0-9]*)*$/,fqTypeRefRe=/^(?:\.[a-zA-Z_][a-zA-Z_0-9]*)+$/;function parse$2(i,e,t){e instanceof Root||(t=e,e=new Root),t||(t=parse$2.defaults);var s=t.preferTrailingComment||!1,o=tokenize(i,t.alternateCommentMode||!1),a=o.next,c=o.push,u=o.peek,d=o.skip,p=o.cmnt,v=!0,g,m,S,y,C=!1,R=e,T=t.keepCase?function(M){return M}:util.camelCase;function E(M,O,x){var q=parse$2.filename;return x||(parse$2.filename=null),Error("illegal "+(O||"token")+" '"+M+"' ("+(q?q+", ":"")+"line "+o.line+")")}function A(){var M=[],O;do{if((O=a())!=='"'&&O!=="'")throw E(O);M.push(a()),d(O),O=u()}while(O==='"'||O==="'");return M.join("")}function b(M){var O=a();switch(O){case"'":case'"':return c(O),A();case"true":case"TRUE":return!0;case"false":case"FALSE":return!1}try{return _(O,!0)}catch{if(typeRefRe.test(O))return O;throw E(O,"value")}}function P(M,O){var x,q;do O&&((x=u())==='"'||x==="'")?M.push(A()):M.push([q=w(a()),d("to",!0)?w(a()):q]);while(d(",",!0));var $={options:void 0};$.setOption=function(F,B){this.options===void 0&&(this.options={}),this.options[F]=B},j($,function(B){if(B==="option")K($,B),d(";");else throw E(B)},function(){J($)})}function _(M,O){var x=1;switch(M.charAt(0)==="-"&&(x=-1,M=M.substring(1)),M){case"inf":case"INF":case"Inf":return x*(1/0);case"nan":case"NAN":case"Nan":case"NaN":return NaN;case"0":return 0}if(base10Re.test(M))return x*parseInt(M,10);if(base16Re.test(M))return x*parseInt(M,16);if(base8Re.test(M))return x*parseInt(M,8);if(numberRe.test(M))return x*parseFloat(M);throw E(M,"number",O)}function w(M,O){switch(M){case"max":case"MAX":case"Max":return 536870911;case"0":return 0}if(!O&&M.charAt(0)==="-")throw E(M,"id");if(base10NegRe.test(M))return parseInt(M,10);if(base16NegRe.test(M))return parseInt(M,16);if(base8NegRe.test(M))return parseInt(M,8);throw E(M,"id")}function I(){if(g!==void 0)throw E("package");if(g=a(),!typeRefRe.test(g))throw E(g,"name");R=R.define(g),d(";")}function D(){var M=u(),O;switch(M){case"weak":O=S||(S=[]),a();break;case"public":a();default:O=m||(m=[]);break}M=A(),d(";"),O.push(M)}function N(){if(d("="),y=A(),C=y==="proto3",!C&&y!=="proto2")throw E(y,"syntax");e.setOption("syntax",y),d(";")}function L(M,O){switch(O){case"option":return K(M,O),d(";"),!0;case"message":return z(M,O),!0;case"enum":return te(M,O),!0;case"service":return ce(M,O),!0;case"extend":return de(M,O),!0}return!1}function j(M,O,x){var q=o.line;if(M&&(typeof M.comment!="string"&&(M.comment=p()),M.filename=parse$2.filename),d("{",!0)){for(var $;($=a())!=="}";)O($);d(";",!0)}else x&&x(),d(";"),M&&(typeof M.comment!="string"||s)&&(M.comment=p(q)||M.comment)}function z(M,O){if(!nameRe.test(O=a()))throw E(O,"type name");var x=new Type(O);j(x,function($){if(!L(x,$))switch($){case"map":ne(x);break;case"required":case"repeated":U(x,$);break;case"optional":C?U(x,"proto3_optional"):U(x,"optional");break;case"oneof":se(x,$);break;case"extensions":P(x.extensions||(x.extensions=[]));break;case"reserved":P(x.reserved||(x.reserved=[]),!0);break;default:if(!C||!typeRefRe.test($))throw E($);c($),U(x,"optional");break}}),M.add(x)}function U(M,O,x){var q=a();if(q==="group"){Y(M,O);return}for(;q.endsWith(".")||u().startsWith(".");)q+=a();if(!typeRefRe.test(q))throw E(q,"type");var $=a();if(!nameRe.test($))throw E($,"name");$=T($),d("=");var F=new Field($,w(a()),q,O,x);if(j(F,function(W){if(W==="option")K(F,W),d(";");else throw E(W)},function(){J(F)}),O==="proto3_optional"){var B=new OneOf("_"+$);F.setOption("proto3_optional",!0),B.add(F),M.add(B)}else M.add(F);!C&&F.repeated&&(types.packed[q]!==void 0||types.basic[q]===void 0)&&F.setOption("packed",!1,!0)}function Y(M,O){var x=a();if(!nameRe.test(x))throw E(x,"name");var q=util.lcFirst(x);x===q&&(x=util.ucFirst(x)),d("=");var $=w(a()),F=new Type(x);F.group=!0;var B=new Field(q,$,x,O);B.filename=parse$2.filename,j(F,function(W){switch(W){case"option":K(F,W),d(";");break;case"required":case"repeated":U(F,W);break;case"optional":C?U(F,"proto3_optional"):U(F,"optional");break;case"message":z(F,W);break;case"enum":te(F,W);break;default:throw E(W)}}),M.add(F).add(B)}function ne(M){d("<");var O=a();if(types.mapKey[O]===void 0)throw E(O,"type");d(",");var x=a();if(!typeRefRe.test(x))throw E(x,"type");d(">");var q=a();if(!nameRe.test(q))throw E(q,"name");d("=");var $=new MapField(T(q),w(a()),O,x);j($,function(B){if(B==="option")K($,B),d(";");else throw E(B)},function(){J($)}),M.add($)}function se(M,O){if(!nameRe.test(O=a()))throw E(O,"name");var x=new OneOf(T(O));j(x,function($){$==="option"?(K(x,$),d(";")):(c($),U(x,"optional"))}),M.add(x)}function te(M,O){if(!nameRe.test(O=a()))throw E(O,"name");var x=new Enum(O);j(x,function($){switch($){case"option":K(x,$),d(";");break;case"reserved":P(x.reserved||(x.reserved=[]),!0);break;default:oe(x,$)}}),M.add(x)}function oe(M,O){if(!nameRe.test(O))throw E(O,"name");d("=");var x=w(a(),!0),q={options:void 0};q.setOption=function($,F){this.options===void 0&&(this.options={}),this.options[$]=F},j(q,function(F){if(F==="option")K(q,F),d(";");else throw E(F)},function(){J(q)}),M.add(O,x,q.comment,q.options)}function K(M,O){var x=d("(",!0);if(!typeRefRe.test(O=a()))throw E(O,"name");var q=O,$=q,F;x&&(d(")"),q="("+q+")",$=q,O=u(),fqTypeRefRe.test(O)&&(F=O.slice(1),q+=O,a())),d("=");var B=re(M,q);ae(M,$,B,F)}function re(M,O){if(d("{",!0)){for(var x={};!d("}",!0);){if(!nameRe.test(V=a()))throw E(V,"name");if(V===null)throw E(V,"end of input");var q,$=V;if(d(":",!0),u()==="{")q=re(M,O+"."+V);else if(u()==="["){q=[];var F;if(d("[",!0)){do F=b(),q.push(F);while(d(",",!0));d("]"),typeof F<"u"&&X(M,O+"."+V,F)}}else q=b(),X(M,O+"."+V,q);var B=x[$];B&&(q=[].concat(B).concat(q)),x[$]=q,d(",",!0),d(";",!0)}return x}var G=b();return X(M,O,G),G}function X(M,O,x){M.setOption&&M.setOption(O,x)}function ae(M,O,x,q){M.setParsedOption&&M.setParsedOption(O,x,q)}function J(M){if(d("[",!0)){do K(M,"option");while(d(",",!0));d("]")}return M}function ce(M,O){if(!nameRe.test(O=a()))throw E(O,"service name");var x=new Service(O);j(x,function($){if(!L(x,$))if($==="rpc")ue(x,$);else throw E($)}),M.add(x)}function ue(M,O){var x=p(),q=O;if(!nameRe.test(O=a()))throw E(O,"name");var $=O,F,B,G,W;if(d("("),d("stream",!0)&&(B=!0),!typeRefRe.test(O=a())||(F=O,d(")"),d("returns"),d("("),d("stream",!0)&&(W=!0),!typeRefRe.test(O=a())))throw E(O);G=O,d(")");var Q=new Method($,q,F,G,B,W);Q.comment=x,j(Q,function(Z){if(Z==="option")K(Q,Z),d(";");else throw E(Z)}),M.add(Q)}function de(M,O){if(!typeRefRe.test(O=a()))throw E(O,"reference");var x=O;j(null,function($){switch($){case"required":case"repeated":U(M,$,x);break;case"optional":C?U(M,"proto3_optional",x):U(M,"optional",x);break;default:if(!C||!typeRefRe.test($))throw E($);c($),U(M,"optional",x);break}})}for(var V;(V=a())!==null;)switch(V){case"package":if(!v)throw E(V);I();break;case"import":if(!v)throw E(V);D();break;case"syntax":if(!v)throw E(V);N();break;case"option":K(R,V),d(";");break;default:if(L(R,V)){v=!1;continue}throw E(V)}return parse$2.filename=null,{package:g,imports:m,weakImports:S,syntax:y,root:e}}var common_1=common,commonRe=/\/|\./;function common(i,e){commonRe.test(i)||(i="google/protobuf/"+i+".proto",e={nested:{google:{nested:{protobuf:{nested:e}}}}}),common[i]=e}common("any",{Any:{fields:{type_url:{type:"string",id:1},value:{type:"bytes",id:2}}}});var timeType;common("duration",{Duration:timeType={fields:{seconds:{type:"int64",id:1},nanos:{type:"int32",id:2}}}});common("timestamp",{Timestamp:timeType});common("empty",{Empty:{fields:{}}});common("struct",{Struct:{fields:{fields:{keyType:"string",type:"Value",id:1}}},Value:{oneofs:{kind:{oneof:["nullValue","numberValue","stringValue","boolValue","structValue","listValue"]}},fields:{nullValue:{type:"NullValue",id:1},numberValue:{type:"double",id:2},stringValue:{type:"string",id:3},boolValue:{type:"bool",id:4},structValue:{type:"Struct",id:5},listValue:{type:"ListValue",id:6}}},NullValue:{values:{NULL_VALUE:0}},ListValue:{fields:{values:{rule:"repeated",type:"Value",id:1}}}});common("wrappers",{DoubleValue:{fields:{value:{type:"double",id:1}}},FloatValue:{fields:{value:{type:"float",id:1}}},Int64Value:{fields:{value:{type:"int64",id:1}}},UInt64Value:{fields:{value:{type:"uint64",id:1}}},Int32Value:{fields:{value:{type:"int32",id:1}}},UInt32Value:{fields:{value:{type:"uint32",id:1}}},BoolValue:{fields:{value:{type:"bool",id:1}}},StringValue:{fields:{value:{type:"string",id:1}}},BytesValue:{fields:{value:{type:"bytes",id:1}}}});common("field_mask",{FieldMask:{fields:{paths:{rule:"repeated",type:"string",id:1}}}});common.get=function i(e){return common[e]||null};var protobuf$1=src.exports=indexLightExports;protobuf$1.build="full";protobuf$1.tokenize=tokenize_1;protobuf$1.parse=parse_1;protobuf$1.common=common_1;protobuf$1.Root._configure(protobuf$1.Type,protobuf$1.parse,protobuf$1.common);var srcExports=src.exports,protobufjs=srcExports;const protobuf=getDefaultExportFromCjs(protobufjs);var extendStatics=function(i,e){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,s){t.__proto__=s}||function(t,s){for(var o in s)Object.prototype.hasOwnProperty.call(s,o)&&(t[o]=s[o])},extendStatics(i,e)};function __extends(i,e){if(typeof e!="function"&&e!==null)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");extendStatics(i,e);function t(){this.constructor=i}i.prototype=e===null?Object.create(e):(t.prototype=e.prototype,new t)}function __awaiter(i,e,t,s){function o(a){return a instanceof t?a:new t(function(c){c(a)})}return new(t||(t=Promise))(function(a,c){function u(v){try{p(s.next(v))}catch(g){c(g)}}function d(v){try{p(s.throw(v))}catch(g){c(g)}}function p(v){v.done?a(v.value):o(v.value).then(u,d)}p((s=s.apply(i,e||[])).next())})}function __generator(i,e){var t={label:0,sent:function(){if(a[0]&1)throw a[1];return a[1]},trys:[],ops:[]},s,o,a,c;return c={next:u(0),throw:u(1),return:u(2)},typeof Symbol=="function"&&(c[Symbol.iterator]=function(){return this}),c;function u(p){return function(v){return d([p,v])}}function d(p){if(s)throw new TypeError("Generator is already executing.");for(;c&&(c=0,p[0]&&(t=0)),t;)try{if(s=1,o&&(a=p[0]&2?o.return:p[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,p[1])).done)return a;switch(o=0,a&&(p=[p[0]&2,a.value]),p[0]){case 0:case 1:a=p;break;case 4:return t.label++,{value:p[1],done:!1};case 5:t.label++,o=p[1],p=[0];continue;case 7:p=t.ops.pop(),t.trys.pop();continue;default:if(a=t.trys,!(a=a.length>0&&a[a.length-1])&&(p[0]===6||p[0]===2)){t=0;continue}if(p[0]===3&&(!a||p[1]>a[0]&&p[1]<a[3])){t.label=p[1];break}if(p[0]===6&&t.label<a[1]){t.label=a[1],a=p;break}if(a&&t.label<a[2]){t.label=a[2],t.ops.push(p);break}a[2]&&t.ops.pop(),t.trys.pop();continue}p=e.call(i,t)}catch(v){p=[6,v],o=0}finally{s=a=0}if(p[0]&5)throw p[1];return{value:p[0]?p[1]:void 0,done:!0}}}typeof SuppressedError=="function"&&SuppressedError;function sleep(i){return new Promise(function(e){return setTimeout(e,i)})}function convertFloat32ToS16PCM(i){for(var e=new Int16Array(i.length),t=0;t<i.length;t++){var s=Math.max(-1,Math.min(1,i[t]));e[t]=s<0?s*32768:s*32767}return e}var options={syntax:"proto3"},nested={pipecat:{nested:{TextFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},text:{type:"string",id:3}}},AudioRawFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},audio:{type:"bytes",id:3},sampleRate:{type:"uint32",id:4},numChannels:{type:"uint32",id:5}}},TranscriptionFrame:{fields:{id:{type:"uint64",id:1},name:{type:"string",id:2},text:{type:"string",id:3},userId:{type:"string",id:4},timestamp:{type:"string",id:5}}},Frame:{oneofs:{frame:{oneof:["text","audio","transcription"]}},fields:{text:{type:"TextFrame",id:1},audio:{type:"AudioRawFrame",id:2},transcription:{type:"TranscriptionFrame",id:3}}}}}},jsonDescriptor={options,nested},AvatarQuality;(function(i){i.Low="low",i.Medium="medium",i.High="high"})(AvatarQuality||(AvatarQuality={}));var VoiceEmotion;(function(i){i.EXCITED="excited",i.SERIOUS="serious",i.FRIENDLY="friendly",i.SOOTHING="soothing",i.BROADCASTER="broadcaster"})(VoiceEmotion||(VoiceEmotion={}));var TaskType;(function(i){i.TALK="talk",i.REPEAT="repeat"})(TaskType||(TaskType={}));var TaskMode;(function(i){i.SYNC="sync",i.ASYNC="async"})(TaskMode||(TaskMode={}));var StreamingEvents;(function(i){i.AVATAR_START_TALKING="avatar_start_talking",i.AVATAR_STOP_TALKING="avatar_stop_talking",i.AVATAR_TALKING_MESSAGE="avatar_talking_message",i.AVATAR_END_MESSAGE="avatar_end_message",i.USER_TALKING_MESSAGE="user_talking_message",i.USER_END_MESSAGE="user_end_message",i.USER_START="user_start",i.USER_STOP="user_stop",i.USER_SILENCE="user_silence",i.STREAM_READY="stream_ready",i.STREAM_DISCONNECTED="stream_disconnected"})(StreamingEvents||(StreamingEvents={}));var APIError=function(i){__extends(e,i);function e(t,s,o){var a=i.call(this,t)||this;return a.name="APIError",a.status=s,a.responseText=o,a}return e}(Error),StreamingAvatar=function(){function i(e){var t=e.token,s=e.basePath,o=s===void 0?"https://api.heygen.com":s;this.room=null,this.mediaStream=null,this.eventTarget=new EventTarget,this.audioContext=null,this.webSocket=null,this.scriptProcessor=null,this.mediaStreamAudioSource=null,this.mediaDevicesStream=null,this.sessionId=null,this.token=t,this.basePath=o}return i.prototype.createStartAvatar=function(e){return __awaiter(this,void 0,void 0,function(){var t,s,o,a=this;return __generator(this,function(c){switch(c.label){case 0:return[4,this.newSession(e)];case 1:t=c.sent(),this.sessionId=t.session_id,this.language=e.language,s=new Room({adaptiveStream:!0,dynacast:!0,videoCaptureDefaults:{resolution:VideoPresets.h720.resolution}}),this.room=s,this.mediaStream=null,s.on(RoomEvent.DataReceived,function(u){var d=null;try{var p=new TextDecoder().decode(u);d=JSON.parse(p)}catch(v){console.error(v)}d&&a.emit(d.type,d)}),o=new MediaStream,s.on(RoomEvent.TrackSubscribed,function(u){if(u.kind==="video"||u.kind==="audio"){o.addTrack(u.mediaStreamTrack);var d=o.getVideoTracks().length>0,p=o.getAudioTracks().length>0;d&&p&&!a.mediaStream&&(a.mediaStream=o,a.emit(StreamingEvents.STREAM_READY,a.mediaStream))}}),s.on(RoomEvent.TrackUnsubscribed,function(u){var d=u.mediaStreamTrack;d&&o.removeTrack(d)}),s.on(RoomEvent.Disconnected,function(u){a.emit(StreamingEvents.STREAM_DISCONNECTED,u)}),c.label=2;case 2:return c.trys.push([2,4,,5]),[4,s.prepareConnection(t.url,t.access_token)];case 3:return c.sent(),[3,5];case 4:return c.sent(),[3,5];case 5:return[4,this.startSession()];case 6:return c.sent(),[4,s.connect(t.url,t.access_token)];case 7:return c.sent(),[2,t]}})})},i.prototype.startVoiceChat=function(){return __awaiter(this,arguments,void 0,function(e){var t,s,o=this,a,c,u;return e===void 0&&(e={}),__generator(this,function(d){switch(d.label){case 0:if(e.useSilencePrompt=e.useSilencePrompt||!1,!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return[2];d.label=1;case 1:return d.trys.push([1,6,,7]),[4,this.loadAudioRawFrame()];case 2:return d.sent(),[4,this.connectWebSocket({useSilencePrompt:e.useSilencePrompt})];case 3:return d.sent(),this.audioContext=new window.AudioContext({latencyHint:"interactive",sampleRate:16e3}),[4,navigator.mediaDevices.getUserMedia({audio:{sampleRate:16e3,channelCount:1,autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0}})];case 4:return t=d.sent(),this.mediaDevicesStream=t,this.mediaStreamAudioSource=(a=this.audioContext)===null||a===void 0?void 0:a.createMediaStreamSource(t),this.scriptProcessor=(c=this.audioContext)===null||c===void 0?void 0:c.createScriptProcessor(512,1,1),this.mediaStreamAudioSource.connect(this.scriptProcessor),this.scriptProcessor.connect((u=this.audioContext)===null||u===void 0?void 0:u.destination),this.scriptProcessor.onaudioprocess=function(p){var v,g,m;if(o.webSocket){var S=p.inputBuffer.getChannelData(0),y=convertFloat32ToS16PCM(S),C=new Uint8Array(y.buffer),R=(v=o.audioRawFrame)===null||v===void 0?void 0:v.create({audio:{audio:Array.from(C),sampleRate:16e3,numChannels:1}}),T=new Uint8Array((g=o.audioRawFrame)===null||g===void 0?void 0:g.encode(R).finish());(m=o.webSocket)===null||m===void 0||m.send(T)}},[4,sleep(2e3)];case 5:return d.sent(),[3,7];case 6:throw s=d.sent(),console.error(s),s;case 7:return[2]}})})},i.prototype.closeVoiceChat=function(){var e,t;try{this.audioContext&&(this.audioContext=null),this.scriptProcessor&&(this.scriptProcessor.disconnect(),this.scriptProcessor=null),this.mediaStreamAudioSource&&(this.mediaStreamAudioSource.disconnect(),this.mediaStreamAudioSource=null),this.mediaDevicesStream&&((t=(e=this.mediaDevicesStream)===null||e===void 0?void 0:e.getTracks())===null||t===void 0||t.forEach(function(s){return s.stop()}),this.mediaDevicesStream=null),this.webSocket&&this.webSocket.close()}catch{}},i.prototype.newSession=function(e){return __awaiter(this,void 0,void 0,function(){var t,s,o;return __generator(this,function(a){return[2,this.request("/v1/streaming.new",{avatar_name:e.avatarName,quality:e.quality,knowledge_base_id:e.knowledgeId,knowledge_base:e.knowledgeBase,voice:{voice_id:(t=e.voice)===null||t===void 0?void 0:t.voiceId,rate:(s=e.voice)===null||s===void 0?void 0:s.rate,emotion:(o=e.voice)===null||o===void 0?void 0:o.emotion},language:e.language,version:"v2",video_encoding:"H264",source:"sdk"})]})})},i.prototype.startSession=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,this.request("/v1/streaming.start",{session_id:this.sessionId})]})})},i.prototype.speak=function(e){return __awaiter(this,void 0,void 0,function(){var t,s,o,a,c;return __generator(this,function(u){return e.taskType=e.taskType||e.task_type||TaskType.TALK,e.taskMode=e.taskMode||TaskMode.ASYNC,this.webSocket&&this.audioRawFrame&&e.task_type===TaskType.TALK&&e.taskMode!==TaskMode.SYNC?(t=(o=this.audioRawFrame)===null||o===void 0?void 0:o.create({text:{text:e.text}}),s=new Uint8Array((a=this.audioRawFrame)===null||a===void 0?void 0:a.encode(t).finish()),(c=this.webSocket)===null||c===void 0||c.send(s),[2]):[2,this.request("/v1/streaming.task",{text:e.text,session_id:this.sessionId,task_mode:e.taskMode,task_type:e.taskType})]})})},i.prototype.startListening=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,this.request("/v1/streaming.start_listening",{session_id:this.sessionId})]})})},i.prototype.stopListening=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,this.request("/v1/streaming.stop_listening",{session_id:this.sessionId})]})})},i.prototype.interrupt=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,this.request("/v1/streaming.interrupt",{session_id:this.sessionId})]})})},i.prototype.stopAvatar=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return this.closeVoiceChat(),[2,this.request("/v1/streaming.stop",{session_id:this.sessionId})]})})},i.prototype.on=function(e,t){return this.eventTarget.addEventListener(e,t),this},i.prototype.off=function(e,t){return this.eventTarget.removeEventListener(e,t),this},i.prototype.request=function(e,t,s){return __awaiter(this,void 0,void 0,function(){var o,a,c,u;return __generator(this,function(d){switch(d.label){case 0:return d.trys.push([0,5,,6]),[4,fetch(this.getRequestUrl(e),{method:"POST",headers:{Authorization:"Bearer ".concat(this.token),"Content-Type":"application/json"},body:JSON.stringify(t)})];case 1:return o=d.sent(),o.ok?[3,3]:[4,o.text()];case 2:throw a=d.sent(),new APIError("API request failed with status ".concat(o.status),o.status,a);case 3:return[4,o.json()];case 4:return c=d.sent(),[2,c.data];case 5:throw u=d.sent(),u;case 6:return[2]}})})},i.prototype.emit=function(e,t){var s=new CustomEvent(e,{detail:t});this.eventTarget.dispatchEvent(s)},i.prototype.getRequestUrl=function(e){return"".concat(this.basePath).concat(e)},i.prototype.connectWebSocket=function(e){return __awaiter(this,void 0,void 0,function(){var t,s=this;return __generator(this,function(o){return t="wss://".concat(new URL(this.basePath).hostname,"/v1/ws/streaming.chat?session_id=").concat(this.sessionId,"&session_token=").concat(this.token,"&silence_response=").concat(e.useSilencePrompt),this.language&&(t+="&stt_language=".concat(this.language)),this.webSocket=new WebSocket(t),this.webSocket.addEventListener("message",function(a){var c=null;try{c=JSON.parse(a.data)}catch(u){console.error(u);return}s.emit(c.event_type,c)}),this.webSocket.addEventListener("close",function(a){s.webSocket=null}),[2,new Promise(function(a,c){var u,d;(u=s.webSocket)===null||u===void 0||u.addEventListener("error",function(p){s.webSocket=null,c(p)}),(d=s.webSocket)===null||d===void 0||d.addEventListener("open",function(){a(!0)})})]})})},i.prototype.loadAudioRawFrame=function(){return __awaiter(this,void 0,void 0,function(){var e;return __generator(this,function(t){return this.audioRawFrame||(e=protobuf.Root.fromJSON(jsonDescriptor),this.audioRawFrame=e==null?void 0:e.lookupType("pipecat.Frame")),[2]})})},i}(),microsoft_cognitiveservices_speech_sdk={},Exports$6={},CognitiveSubscriptionKeyAuthentication$1={},Exports$5={},AudioSourceEvents={},PlatformEvent={},Guid={},commonjsBrowser={},v1$1={},rng$1={};Object.defineProperty(rng$1,"__esModule",{value:!0});rng$1.default=rng;let getRandomValues;const rnds8=new Uint8Array(16);function rng(){if(!getRandomValues&&(getRandomValues=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!getRandomValues))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return getRandomValues(rnds8)}var stringify$1={},validate$1={},regex={};Object.defineProperty(regex,"__esModule",{value:!0});regex.default=void 0;var _default$c=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;regex.default=_default$c;Object.defineProperty(validate$1,"__esModule",{value:!0});validate$1.default=void 0;var _regex=_interopRequireDefault$8(regex);function _interopRequireDefault$8(i){return i&&i.__esModule?i:{default:i}}function validate(i){return typeof i=="string"&&_regex.default.test(i)}var _default$b=validate;validate$1.default=_default$b;Object.defineProperty(stringify$1,"__esModule",{value:!0});stringify$1.default=void 0;stringify$1.unsafeStringify=unsafeStringify;var _validate$2=_interopRequireDefault$7(validate$1);function _interopRequireDefault$7(i){return i&&i.__esModule?i:{default:i}}const byteToHex=[];for(let i=0;i<256;++i)byteToHex.push((i+256).toString(16).slice(1));function unsafeStringify(i,e=0){return byteToHex[i[e+0]]+byteToHex[i[e+1]]+byteToHex[i[e+2]]+byteToHex[i[e+3]]+"-"+byteToHex[i[e+4]]+byteToHex[i[e+5]]+"-"+byteToHex[i[e+6]]+byteToHex[i[e+7]]+"-"+byteToHex[i[e+8]]+byteToHex[i[e+9]]+"-"+byteToHex[i[e+10]]+byteToHex[i[e+11]]+byteToHex[i[e+12]]+byteToHex[i[e+13]]+byteToHex[i[e+14]]+byteToHex[i[e+15]]}function stringify(i,e=0){const t=unsafeStringify(i,e);if(!(0,_validate$2.default)(t))throw TypeError("Stringified UUID is invalid");return t}var _default$a=stringify;stringify$1.default=_default$a;Object.defineProperty(v1$1,"__esModule",{value:!0});v1$1.default=void 0;var _rng$1=_interopRequireDefault$6(rng$1),_stringify$2=stringify$1;function _interopRequireDefault$6(i){return i&&i.__esModule?i:{default:i}}let _nodeId,_clockseq,_lastMSecs=0,_lastNSecs=0;function v1(i,e,t){let s=e&&t||0;const o=e||new Array(16);i=i||{};let a=i.node||_nodeId,c=i.clockseq!==void 0?i.clockseq:_clockseq;if(a==null||c==null){const m=i.random||(i.rng||_rng$1.default)();a==null&&(a=_nodeId=[m[0]|1,m[1],m[2],m[3],m[4],m[5]]),c==null&&(c=_clockseq=(m[6]<<8|m[7])&16383)}let u=i.msecs!==void 0?i.msecs:Date.now(),d=i.nsecs!==void 0?i.nsecs:_lastNSecs+1;const p=u-_lastMSecs+(d-_lastNSecs)/1e4;if(p<0&&i.clockseq===void 0&&(c=c+1&16383),(p<0||u>_lastMSecs)&&i.nsecs===void 0&&(d=0),d>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");_lastMSecs=u,_lastNSecs=d,_clockseq=c,u+=122192928e5;const v=((u&268435455)*1e4+d)%4294967296;o[s++]=v>>>24&255,o[s++]=v>>>16&255,o[s++]=v>>>8&255,o[s++]=v&255;const g=u/4294967296*1e4&268435455;o[s++]=g>>>8&255,o[s++]=g&255,o[s++]=g>>>24&15|16,o[s++]=g>>>16&255,o[s++]=c>>>8|128,o[s++]=c&255;for(let m=0;m<6;++m)o[s+m]=a[m];return e||(0,_stringify$2.unsafeStringify)(o)}var _default$9=v1;v1$1.default=_default$9;var v3$1={},v35$1={},parse$1={};Object.defineProperty(parse$1,"__esModule",{value:!0});parse$1.default=void 0;var _validate$1=_interopRequireDefault$5(validate$1);function _interopRequireDefault$5(i){return i&&i.__esModule?i:{default:i}}function parse(i){if(!(0,_validate$1.default)(i))throw TypeError("Invalid UUID");let e;const t=new Uint8Array(16);return t[0]=(e=parseInt(i.slice(0,8),16))>>>24,t[1]=e>>>16&255,t[2]=e>>>8&255,t[3]=e&255,t[4]=(e=parseInt(i.slice(9,13),16))>>>8,t[5]=e&255,t[6]=(e=parseInt(i.slice(14,18),16))>>>8,t[7]=e&255,t[8]=(e=parseInt(i.slice(19,23),16))>>>8,t[9]=e&255,t[10]=(e=parseInt(i.slice(24,36),16))/1099511627776&255,t[11]=e/4294967296&255,t[12]=e>>>24&255,t[13]=e>>>16&255,t[14]=e>>>8&255,t[15]=e&255,t}var _default$8=parse;parse$1.default=_default$8;Object.defineProperty(v35$1,"__esModule",{value:!0});v35$1.URL=v35$1.DNS=void 0;v35$1.default=v35;var _stringify$1=stringify$1,_parse=_interopRequireDefault$4(parse$1);function _interopRequireDefault$4(i){return i&&i.__esModule?i:{default:i}}function stringToBytes(i){i=unescape(encodeURIComponent(i));const e=[];for(let t=0;t<i.length;++t)e.push(i.charCodeAt(t));return e}const DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8";v35$1.DNS=DNS;const URL$1="6ba7b811-9dad-11d1-80b4-00c04fd430c8";v35$1.URL=URL$1;function v35(i,e,t){function s(o,a,c,u){var d;if(typeof o=="string"&&(o=stringToBytes(o)),typeof a=="string"&&(a=(0,_parse.default)(a)),((d=a)===null||d===void 0?void 0:d.length)!==16)throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let p=new Uint8Array(16+o.length);if(p.set(a),p.set(o,a.length),p=t(p),p[6]=p[6]&15|e,p[8]=p[8]&63|128,c){u=u||0;for(let v=0;v<16;++v)c[u+v]=p[v];return c}return(0,_stringify$1.unsafeStringify)(p)}try{s.name=i}catch{}return s.DNS=DNS,s.URL=URL$1,s}var md5$1={};Object.defineProperty(md5$1,"__esModule",{value:!0});md5$1.default=void 0;function md5(i){if(typeof i=="string"){const e=unescape(encodeURIComponent(i));i=new Uint8Array(e.length);for(let t=0;t<e.length;++t)i[t]=e.charCodeAt(t)}return md5ToHexEncodedArray(wordsToMd5(bytesToWords(i),i.length*8))}function md5ToHexEncodedArray(i){const e=[],t=i.length*32,s="0123456789abcdef";for(let o=0;o<t;o+=8){const a=i[o>>5]>>>o%32&255,c=parseInt(s.charAt(a>>>4&15)+s.charAt(a&15),16);e.push(c)}return e}function getOutputLength(i){return(i+64>>>9<<4)+14+1}function wordsToMd5(i,e){i[e>>5]|=128<<e%32,i[getOutputLength(e)-1]=e;let t=1732584193,s=-271733879,o=-1732584194,a=271733878;for(let c=0;c<i.length;c+=16){const u=t,d=s,p=o,v=a;t=md5ff(t,s,o,a,i[c],7,-680876936),a=md5ff(a,t,s,o,i[c+1],12,-389564586),o=md5ff(o,a,t,s,i[c+2],17,606105819),s=md5ff(s,o,a,t,i[c+3],22,-1044525330),t=md5ff(t,s,o,a,i[c+4],7,-176418897),a=md5ff(a,t,s,o,i[c+5],12,1200080426),o=md5ff(o,a,t,s,i[c+6],17,-1473231341),s=md5ff(s,o,a,t,i[c+7],22,-45705983),t=md5ff(t,s,o,a,i[c+8],7,1770035416),a=md5ff(a,t,s,o,i[c+9],12,-1958414417),o=md5ff(o,a,t,s,i[c+10],17,-42063),s=md5ff(s,o,a,t,i[c+11],22,-1990404162),t=md5ff(t,s,o,a,i[c+12],7,1804603682),a=md5ff(a,t,s,o,i[c+13],12,-40341101),o=md5ff(o,a,t,s,i[c+14],17,-1502002290),s=md5ff(s,o,a,t,i[c+15],22,1236535329),t=md5gg(t,s,o,a,i[c+1],5,-165796510),a=md5gg(a,t,s,o,i[c+6],9,-1069501632),o=md5gg(o,a,t,s,i[c+11],14,643717713),s=md5gg(s,o,a,t,i[c],20,-373897302),t=md5gg(t,s,o,a,i[c+5],5,-701558691),a=md5gg(a,t,s,o,i[c+10],9,38016083),o=md5gg(o,a,t,s,i[c+15],14,-660478335),s=md5gg(s,o,a,t,i[c+4],20,-405537848),t=md5gg(t,s,o,a,i[c+9],5,568446438),a=md5gg(a,t,s,o,i[c+14],9,-1019803690),o=md5gg(o,a,t,s,i[c+3],14,-187363961),s=md5gg(s,o,a,t,i[c+8],20,1163531501),t=md5gg(t,s,o,a,i[c+13],5,-1444681467),a=md5gg(a,t,s,o,i[c+2],9,-51403784),o=md5gg(o,a,t,s,i[c+7],14,1735328473),s=md5gg(s,o,a,t,i[c+12],20,-1926607734),t=md5hh(t,s,o,a,i[c+5],4,-378558),a=md5hh(a,t,s,o,i[c+8],11,-2022574463),o=md5hh(o,a,t,s,i[c+11],16,1839030562),s=md5hh(s,o,a,t,i[c+14],23,-35309556),t=md5hh(t,s,o,a,i[c+1],4,-1530992060),a=md5hh(a,t,s,o,i[c+4],11,1272893353),o=md5hh(o,a,t,s,i[c+7],16,-155497632),s=md5hh(s,o,a,t,i[c+10],23,-1094730640),t=md5hh(t,s,o,a,i[c+13],4,681279174),a=md5hh(a,t,s,o,i[c],11,-358537222),o=md5hh(o,a,t,s,i[c+3],16,-722521979),s=md5hh(s,o,a,t,i[c+6],23,76029189),t=md5hh(t,s,o,a,i[c+9],4,-640364487),a=md5hh(a,t,s,o,i[c+12],11,-421815835),o=md5hh(o,a,t,s,i[c+15],16,530742520),s=md5hh(s,o,a,t,i[c+2],23,-995338651),t=md5ii(t,s,o,a,i[c],6,-198630844),a=md5ii(a,t,s,o,i[c+7],10,1126891415),o=md5ii(o,a,t,s,i[c+14],15,-1416354905),s=md5ii(s,o,a,t,i[c+5],21,-57434055),t=md5ii(t,s,o,a,i[c+12],6,1700485571),a=md5ii(a,t,s,o,i[c+3],10,-1894986606),o=md5ii(o,a,t,s,i[c+10],15,-1051523),s=md5ii(s,o,a,t,i[c+1],21,-2054922799),t=md5ii(t,s,o,a,i[c+8],6,1873313359),a=md5ii(a,t,s,o,i[c+15],10,-30611744),o=md5ii(o,a,t,s,i[c+6],15,-1560198380),s=md5ii(s,o,a,t,i[c+13],21,1309151649),t=md5ii(t,s,o,a,i[c+4],6,-145523070),a=md5ii(a,t,s,o,i[c+11],10,-1120210379),o=md5ii(o,a,t,s,i[c+2],15,718787259),s=md5ii(s,o,a,t,i[c+9],21,-343485551),t=safeAdd(t,u),s=safeAdd(s,d),o=safeAdd(o,p),a=safeAdd(a,v)}return[t,s,o,a]}function bytesToWords(i){if(i.length===0)return[];const e=i.length*8,t=new Uint32Array(getOutputLength(e));for(let s=0;s<e;s+=8)t[s>>5]|=(i[s/8]&255)<<s%32;return t}function safeAdd(i,e){const t=(i&65535)+(e&65535);return(i>>16)+(e>>16)+(t>>16)<<16|t&65535}function bitRotateLeft(i,e){return i<<e|i>>>32-e}function md5cmn(i,e,t,s,o,a){return safeAdd(bitRotateLeft(safeAdd(safeAdd(e,i),safeAdd(s,a)),o),t)}function md5ff(i,e,t,s,o,a,c){return md5cmn(e&t|~e&s,i,e,o,a,c)}function md5gg(i,e,t,s,o,a,c){return md5cmn(e&s|t&~s,i,e,o,a,c)}function md5hh(i,e,t,s,o,a,c){return md5cmn(e^t^s,i,e,o,a,c)}function md5ii(i,e,t,s,o,a,c){return md5cmn(t^(e|~s),i,e,o,a,c)}var _default$7=md5;md5$1.default=_default$7;Object.defineProperty(v3$1,"__esModule",{value:!0});v3$1.default=void 0;var _v$1=_interopRequireDefault$3(v35$1),_md=_interopRequireDefault$3(md5$1);function _interopRequireDefault$3(i){return i&&i.__esModule?i:{default:i}}const v3=(0,_v$1.default)("v3",48,_md.default);var _default$6=v3;v3$1.default=_default$6;var v4$1={},native={};Object.defineProperty(native,"__esModule",{value:!0});native.default=void 0;const randomUUID=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto);var _default$5={randomUUID};native.default=_default$5;Object.defineProperty(v4$1,"__esModule",{value:!0});v4$1.default=void 0;var _native=_interopRequireDefault$2(native),_rng=_interopRequireDefault$2(rng$1),_stringify=stringify$1;function _interopRequireDefault$2(i){return i&&i.__esModule?i:{default:i}}function v4(i,e,t){if(_native.default.randomUUID&&!e&&!i)return _native.default.randomUUID();i=i||{};const s=i.random||(i.rng||_rng.default)();if(s[6]=s[6]&15|64,s[8]=s[8]&63|128,e){t=t||0;for(let o=0;o<16;++o)e[t+o]=s[o];return e}return(0,_stringify.unsafeStringify)(s)}var _default$4=v4;v4$1.default=_default$4;var v5$1={},sha1$1={};Object.defineProperty(sha1$1,"__esModule",{value:!0});sha1$1.default=void 0;function f(i,e,t,s){switch(i){case 0:return e&t^~e&s;case 1:return e^t^s;case 2:return e&t^e&s^t&s;case 3:return e^t^s}}function ROTL(i,e){return i<<e|i>>>32-e}function sha1(i){const e=[1518500249,1859775393,2400959708,3395469782],t=[1732584193,4023233417,2562383102,271733878,3285377520];if(typeof i=="string"){const c=unescape(encodeURIComponent(i));i=[];for(let u=0;u<c.length;++u)i.push(c.charCodeAt(u))}else Array.isArray(i)||(i=Array.prototype.slice.call(i));i.push(128);const s=i.length/4+2,o=Math.ceil(s/16),a=new Array(o);for(let c=0;c<o;++c){const u=new Uint32Array(16);for(let d=0;d<16;++d)u[d]=i[c*64+d*4]<<24|i[c*64+d*4+1]<<16|i[c*64+d*4+2]<<8|i[c*64+d*4+3];a[c]=u}a[o-1][14]=(i.length-1)*8/Math.pow(2,32),a[o-1][14]=Math.floor(a[o-1][14]),a[o-1][15]=(i.length-1)*8&4294967295;for(let c=0;c<o;++c){const u=new Uint32Array(80);for(let S=0;S<16;++S)u[S]=a[c][S];for(let S=16;S<80;++S)u[S]=ROTL(u[S-3]^u[S-8]^u[S-14]^u[S-16],1);let d=t[0],p=t[1],v=t[2],g=t[3],m=t[4];for(let S=0;S<80;++S){const y=Math.floor(S/20),C=ROTL(d,5)+f(y,p,v,g)+m+e[y]+u[S]>>>0;m=g,g=v,v=ROTL(p,30)>>>0,p=d,d=C}t[0]=t[0]+d>>>0,t[1]=t[1]+p>>>0,t[2]=t[2]+v>>>0,t[3]=t[3]+g>>>0,t[4]=t[4]+m>>>0}return[t[0]>>24&255,t[0]>>16&255,t[0]>>8&255,t[0]&255,t[1]>>24&255,t[1]>>16&255,t[1]>>8&255,t[1]&255,t[2]>>24&255,t[2]>>16&255,t[2]>>8&255,t[2]&255,t[3]>>24&255,t[3]>>16&255,t[3]>>8&255,t[3]&255,t[4]>>24&255,t[4]>>16&255,t[4]>>8&255,t[4]&255]}var _default$3=sha1;sha1$1.default=_default$3;Object.defineProperty(v5$1,"__esModule",{value:!0});v5$1.default=void 0;var _v=_interopRequireDefault$1(v35$1),_sha=_interopRequireDefault$1(sha1$1);function _interopRequireDefault$1(i){return i&&i.__esModule?i:{default:i}}const v5=(0,_v.default)("v5",80,_sha.default);var _default$2=v5;v5$1.default=_default$2;var nil={};Object.defineProperty(nil,"__esModule",{value:!0});nil.default=void 0;var _default$1="00000000-0000-0000-0000-000000000000";nil.default=_default$1;var version$1={};Object.defineProperty(version$1,"__esModule",{value:!0});version$1.default=void 0;var _validate=_interopRequireDefault(validate$1);function _interopRequireDefault(i){return i&&i.__esModule?i:{default:i}}function version(i){if(!(0,_validate.default)(i))throw TypeError("Invalid UUID");return parseInt(i.slice(14,15),16)}var _default=version;version$1.default=_default;(function(i){Object.defineProperty(i,"__esModule",{value:!0}),Object.defineProperty(i,"NIL",{enumerable:!0,get:function(){return a.default}}),Object.defineProperty(i,"parse",{enumerable:!0,get:function(){return p.default}}),Object.defineProperty(i,"stringify",{enumerable:!0,get:function(){return d.default}}),Object.defineProperty(i,"v1",{enumerable:!0,get:function(){return e.default}}),Object.defineProperty(i,"v3",{enumerable:!0,get:function(){return t.default}}),Object.defineProperty(i,"v4",{enumerable:!0,get:function(){return s.default}}),Object.defineProperty(i,"v5",{enumerable:!0,get:function(){return o.default}}),Object.defineProperty(i,"validate",{enumerable:!0,get:function(){return u.default}}),Object.defineProperty(i,"version",{enumerable:!0,get:function(){return c.default}});var e=v(v1$1),t=v(v3$1),s=v(v4$1),o=v(v5$1),a=v(nil),c=v(version$1),u=v(validate$1),d=v(stringify$1),p=v(parse$1);function v(g){return g&&g.__esModule?g:{default:g}}})(commonjsBrowser);Object.defineProperty(Guid,"__esModule",{value:!0});Guid.createNoDashGuid=Guid.createGuid=void 0;const uuid_1=commonjsBrowser,createGuid=()=>uuid_1.v4();Guid.createGuid=createGuid;const createNoDashGuid=()=>createGuid().replace(new RegExp("-","g"),"").toUpperCase();Guid.createNoDashGuid=createNoDashGuid;(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.PlatformEvent=i.EventType=void 0;const e=Guid;(function(s){s[s.Debug=0]="Debug",s[s.Info=1]="Info",s[s.Warning=2]="Warning",s[s.Error=3]="Error",s[s.None=4]="None"})(i.EventType||(i.EventType={}));class t{constructor(o,a){this.privName=o,this.privEventId=e.createNoDashGuid(),this.privEventTime=new Date().toISOString(),this.privEventType=a,this.privMetadata={}}get name(){return this.privName}get eventId(){return this.privEventId}get eventTime(){return this.privEventTime}get eventType(){return this.privEventType}get metadata(){return this.privMetadata}}i.PlatformEvent=t})(PlatformEvent);Object.defineProperty(AudioSourceEvents,"__esModule",{value:!0});AudioSourceEvents.AudioStreamNodeErrorEvent=AudioSourceEvents.AudioStreamNodeDetachedEvent=AudioSourceEvents.AudioStreamNodeAttachedEvent=AudioSourceEvents.AudioStreamNodeAttachingEvent=AudioSourceEvents.AudioStreamNodeEvent=AudioSourceEvents.AudioSourceErrorEvent=AudioSourceEvents.AudioSourceOffEvent=AudioSourceEvents.AudioSourceReadyEvent=AudioSourceEvents.AudioSourceInitializingEvent=AudioSourceEvents.AudioSourceEvent=void 0;const PlatformEvent_js_1$3=PlatformEvent;class AudioSourceEvent extends PlatformEvent_js_1$3.PlatformEvent{constructor(e,t,s=PlatformEvent_js_1$3.EventType.Info){super(e,s),this.privAudioSourceId=t}get audioSourceId(){return this.privAudioSourceId}}AudioSourceEvents.AudioSourceEvent=AudioSourceEvent;class AudioSourceInitializingEvent extends AudioSourceEvent{constructor(e){super("AudioSourceInitializingEvent",e)}}AudioSourceEvents.AudioSourceInitializingEvent=AudioSourceInitializingEvent;class AudioSourceReadyEvent extends AudioSourceEvent{constructor(e){super("AudioSourceReadyEvent",e)}}AudioSourceEvents.AudioSourceReadyEvent=AudioSourceReadyEvent;class AudioSourceOffEvent extends AudioSourceEvent{constructor(e){super("AudioSourceOffEvent",e)}}AudioSourceEvents.AudioSourceOffEvent=AudioSourceOffEvent;class AudioSourceErrorEvent extends AudioSourceEvent{constructor(e,t){super("AudioSourceErrorEvent",e,PlatformEvent_js_1$3.EventType.Error),this.privError=t}get error(){return this.privError}}AudioSourceEvents.AudioSourceErrorEvent=AudioSourceErrorEvent;class AudioStreamNodeEvent extends AudioSourceEvent{constructor(e,t,s){super(e,t),this.privAudioNodeId=s}get audioNodeId(){return this.privAudioNodeId}}AudioSourceEvents.AudioStreamNodeEvent=AudioStreamNodeEvent;class AudioStreamNodeAttachingEvent extends AudioStreamNodeEvent{constructor(e,t){super("AudioStreamNodeAttachingEvent",e,t)}}AudioSourceEvents.AudioStreamNodeAttachingEvent=AudioStreamNodeAttachingEvent;class AudioStreamNodeAttachedEvent extends AudioStreamNodeEvent{constructor(e,t){super("AudioStreamNodeAttachedEvent",e,t)}}AudioSourceEvents.AudioStreamNodeAttachedEvent=AudioStreamNodeAttachedEvent;class AudioStreamNodeDetachedEvent extends AudioStreamNodeEvent{constructor(e,t){super("AudioStreamNodeDetachedEvent",e,t)}}AudioSourceEvents.AudioStreamNodeDetachedEvent=AudioStreamNodeDetachedEvent;class AudioStreamNodeErrorEvent extends AudioStreamNodeEvent{constructor(e,t,s){super("AudioStreamNodeErrorEvent",e,t),this.privError=s}get error(){return this.privError}}AudioSourceEvents.AudioStreamNodeErrorEvent=AudioStreamNodeErrorEvent;var ConnectionEvents={};Object.defineProperty(ConnectionEvents,"__esModule",{value:!0});ConnectionEvents.ConnectionMessageSentEvent=ConnectionEvents.ConnectionMessageReceivedEvent=ConnectionEvents.ConnectionEstablishErrorEvent=ConnectionEvents.ConnectionErrorEvent=ConnectionEvents.ConnectionClosedEvent=ConnectionEvents.ConnectionEstablishedEvent=ConnectionEvents.ConnectionStartEvent=ConnectionEvents.ConnectionEvent=ConnectionEvents.ServiceEvent=void 0;const PlatformEvent_js_1$2=PlatformEvent;class ServiceEvent extends PlatformEvent_js_1$2.PlatformEvent{constructor(e,t,s=PlatformEvent_js_1$2.EventType.Info){super(e,s),this.privJsonResult=t}get jsonString(){return this.privJsonResult}}ConnectionEvents.ServiceEvent=ServiceEvent;class ConnectionEvent extends PlatformEvent_js_1$2.PlatformEvent{constructor(e,t,s=PlatformEvent_js_1$2.EventType.Info){super(e,s),this.privConnectionId=t}get connectionId(){return this.privConnectionId}}ConnectionEvents.ConnectionEvent=ConnectionEvent;class ConnectionStartEvent extends ConnectionEvent{constructor(e,t,s){super("ConnectionStartEvent",e),this.privUri=t,this.privHeaders=s}get uri(){return this.privUri}get headers(){return this.privHeaders}}ConnectionEvents.ConnectionStartEvent=ConnectionStartEvent;class ConnectionEstablishedEvent extends ConnectionEvent{constructor(e){super("ConnectionEstablishedEvent",e)}}ConnectionEvents.ConnectionEstablishedEvent=ConnectionEstablishedEvent;class ConnectionClosedEvent extends ConnectionEvent{constructor(e,t,s){super("ConnectionClosedEvent",e,PlatformEvent_js_1$2.EventType.Debug),this.privReason=s,this.privStatusCode=t}get reason(){return this.privReason}get statusCode(){return this.privStatusCode}}ConnectionEvents.ConnectionClosedEvent=ConnectionClosedEvent;class ConnectionErrorEvent extends ConnectionEvent{constructor(e,t,s){super("ConnectionErrorEvent",e,PlatformEvent_js_1$2.EventType.Debug),this.privMessage=t,this.privType=s}get message(){return this.privMessage}get type(){return this.privType}}ConnectionEvents.ConnectionErrorEvent=ConnectionErrorEvent;class ConnectionEstablishErrorEvent extends ConnectionEvent{constructor(e,t,s){super("ConnectionEstablishErrorEvent",e,PlatformEvent_js_1$2.EventType.Error),this.privStatusCode=t,this.privReason=s}get reason(){return this.privReason}get statusCode(){return this.privStatusCode}}ConnectionEvents.ConnectionEstablishErrorEvent=ConnectionEstablishErrorEvent;class ConnectionMessageReceivedEvent extends ConnectionEvent{constructor(e,t,s){super("ConnectionMessageReceivedEvent",e),this.privNetworkReceivedTime=t,this.privMessage=s}get networkReceivedTime(){return this.privNetworkReceivedTime}get message(){return this.privMessage}}ConnectionEvents.ConnectionMessageReceivedEvent=ConnectionMessageReceivedEvent;class ConnectionMessageSentEvent extends ConnectionEvent{constructor(e,t,s){super("ConnectionMessageSentEvent",e),this.privNetworkSentTime=t,this.privMessage=s}get networkSentTime(){return this.privNetworkSentTime}get message(){return this.privMessage}}ConnectionEvents.ConnectionMessageSentEvent=ConnectionMessageSentEvent;var ConnectionMessage$1={},_Error={};Object.defineProperty(_Error,"__esModule",{value:!0});_Error.ObjectDisposedError=_Error.InvalidOperationError=_Error.ArgumentNullError=void 0;class ArgumentNullError extends Error{constructor(e){super(e),this.name="ArgumentNull",this.message=e}}_Error.ArgumentNullError=ArgumentNullError;class InvalidOperationError extends Error{constructor(e){super(e),this.name="InvalidOperation",this.message=e}}_Error.InvalidOperationError=InvalidOperationError;class ObjectDisposedError extends Error{constructor(e,t){super(t),this.name=e+"ObjectDisposed",this.message=t}}_Error.ObjectDisposedError=ObjectDisposedError;(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.ConnectionMessage=i.MessageType=void 0;const e=_Error,t=Guid;var s;(function(a){a[a.Text=0]="Text",a[a.Binary=1]="Binary"})(s=i.MessageType||(i.MessageType={}));class o{constructor(c,u,d,p){if(this.privBody=null,c===s.Text&&u&&typeof u!="string")throw new e.InvalidOperationError("Payload must be a string");if(c===s.Binary&&u&&!(u instanceof ArrayBuffer))throw new e.InvalidOperationError("Payload must be ArrayBuffer");switch(this.privMessageType=c,this.privBody=u,this.privHeaders=d||{},this.privId=p||t.createNoDashGuid(),this.messageType){case s.Binary:this.privSize=this.binaryBody!==null?this.binaryBody.byteLength:0;break;case s.Text:this.privSize=this.textBody.length}}get messageType(){return this.privMessageType}get headers(){return this.privHeaders}get body(){return this.privBody}get textBody(){if(this.privMessageType===s.Binary)throw new e.InvalidOperationError("Not supported for binary message");return this.privBody}get binaryBody(){if(this.privMessageType===s.Text)throw new e.InvalidOperationError("Not supported for text message");return this.privBody}get id(){return this.privId}}i.ConnectionMessage=o})(ConnectionMessage$1);var ConnectionOpenResponse$1={};Object.defineProperty(ConnectionOpenResponse$1,"__esModule",{value:!0});ConnectionOpenResponse$1.ConnectionOpenResponse=void 0;class ConnectionOpenResponse{constructor(e,t){this.privStatusCode=e,this.privReason=t}get statusCode(){return this.privStatusCode}get reason(){return this.privReason}}ConnectionOpenResponse$1.ConnectionOpenResponse=ConnectionOpenResponse;var DeferralMap$1={};Object.defineProperty(DeferralMap$1,"__esModule",{value:!0});DeferralMap$1.DeferralMap=void 0;class DeferralMap{constructor(){this.privMap={}}add(e,t){this.privMap[e]=t}getId(e){return this.privMap[e]}complete(e,t){try{this.privMap[e].resolve(t)}catch(s){this.privMap[e].reject(s)}finally{this.privMap[e]=void 0}}}DeferralMap$1.DeferralMap=DeferralMap;var DialogEvents={};Object.defineProperty(DialogEvents,"__esModule",{value:!0});DialogEvents.SendingAgentContextMessageEvent=DialogEvents.DialogEvent=void 0;const PlatformEvent_js_1$1=PlatformEvent;class DialogEvent extends PlatformEvent_js_1$1.PlatformEvent{constructor(e,t=PlatformEvent_js_1$1.EventType.Info){super(e,t)}}DialogEvents.DialogEvent=DialogEvent;class SendingAgentContextMessageEvent extends DialogEvent{constructor(e){super("SendingAgentContextMessageEvent"),this.privAgentConfig=e}get agentConfig(){return this.privAgentConfig}}DialogEvents.SendingAgentContextMessageEvent=SendingAgentContextMessageEvent;var Events$1={},EventSource$1={};Object.defineProperty(EventSource$1,"__esModule",{value:!0});EventSource$1.EventSource=void 0;const Error_js_1$6=_Error,Guid_js_1$2=Guid;class EventSource{constructor(e){this.privEventListeners={},this.privIsDisposed=!1,this.privConsoleListener=void 0,this.privMetadata=e}onEvent(e){if(this.isDisposed())throw new Error_js_1$6.ObjectDisposedError("EventSource");if(this.metadata)for(const t in this.metadata)t&&e.metadata&&(e.metadata[t]||(e.metadata[t]=this.metadata[t]));for(const t in this.privEventListeners)t&&this.privEventListeners[t]&&this.privEventListeners[t](e)}attach(e){const t=Guid_js_1$2.createNoDashGuid();return this.privEventListeners[t]=e,{detach:()=>(delete this.privEventListeners[t],Promise.resolve())}}attachListener(e){return this.attach(t=>e.onEvent(t))}attachConsoleListener(e){return this.privConsoleListener&&this.privConsoleListener.detach(),this.privConsoleListener=this.attach(t=>e.onEvent(t)),this.privConsoleListener}isDisposed(){return this.privIsDisposed}dispose(){this.privEventListeners=null,this.privIsDisposed=!0}get metadata(){return this.privMetadata}}EventSource$1.EventSource=EventSource;Object.defineProperty(Events$1,"__esModule",{value:!0});Events$1.Events=void 0;const Error_js_1$5=_Error,EventSource_js_1=EventSource$1;class Events{static setEventSource(e){if(!e)throw new Error_js_1$5.ArgumentNullError("eventSource");Events.privInstance=e}static get instance(){return Events.privInstance}}Events$1.Events=Events;Events.privInstance=new EventSource_js_1.EventSource;var IAudioSource={};Object.defineProperty(IAudioSource,"__esModule",{value:!0});var IConnection={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.ConnectionState=void 0,function(e){e[e.None=0]="None",e[e.Connected=1]="Connected",e[e.Connecting=2]="Connecting",e[e.Disconnected=3]="Disconnected"}(i.ConnectionState||(i.ConnectionState={}))})(IConnection);var IDetachable={};Object.defineProperty(IDetachable,"__esModule",{value:!0});var IDictionary={};Object.defineProperty(IDictionary,"__esModule",{value:!0});var IDisposable={};Object.defineProperty(IDisposable,"__esModule",{value:!0});var IEventListener={};Object.defineProperty(IEventListener,"__esModule",{value:!0});var IEventSource={};Object.defineProperty(IEventSource,"__esModule",{value:!0});var IErrorMessages={};Object.defineProperty(IErrorMessages,"__esModule",{value:!0});var ITimer={};Object.defineProperty(ITimer,"__esModule",{value:!0});var IWebsocketMessageFormatter={};Object.defineProperty(IWebsocketMessageFormatter,"__esModule",{value:!0});var List$1={};Object.defineProperty(List$1,"__esModule",{value:!0});List$1.List=void 0;const Error_js_1$4=_Error;class List{constructor(e){if(this.privSubscriptionIdCounter=0,this.privAddSubscriptions={},this.privRemoveSubscriptions={},this.privDisposedSubscriptions={},this.privDisposeReason=null,this.privList=[],e)for(const t of e)this.privList.push(t)}get(e){return this.throwIfDisposed(),this.privList[e]}first(){return this.get(0)}last(){return this.get(this.length()-1)}add(e){this.throwIfDisposed(),this.insertAt(this.privList.length,e)}insertAt(e,t){this.throwIfDisposed(),e===0?this.privList.unshift(t):e===this.privList.length?this.privList.push(t):this.privList.splice(e,0,t),this.triggerSubscriptions(this.privAddSubscriptions)}removeFirst(){return this.throwIfDisposed(),this.removeAt(0)}removeLast(){return this.throwIfDisposed(),this.removeAt(this.length()-1)}removeAt(e){return this.throwIfDisposed(),this.remove(e,1)[0]}remove(e,t){this.throwIfDisposed();const s=this.privList.splice(e,t);return this.triggerSubscriptions(this.privRemoveSubscriptions),s}clear(){this.throwIfDisposed(),this.remove(0,this.length())}length(){return this.throwIfDisposed(),this.privList.length}onAdded(e){this.throwIfDisposed();const t=this.privSubscriptionIdCounter++;return this.privAddSubscriptions[t]=e,{detach:()=>(delete this.privAddSubscriptions[t],Promise.resolve())}}onRemoved(e){this.throwIfDisposed();const t=this.privSubscriptionIdCounter++;return this.privRemoveSubscriptions[t]=e,{detach:()=>(delete this.privRemoveSubscriptions[t],Promise.resolve())}}onDisposed(e){this.throwIfDisposed();const t=this.privSubscriptionIdCounter++;return this.privDisposedSubscriptions[t]=e,{detach:()=>(delete this.privDisposedSubscriptions[t],Promise.resolve())}}join(e){return this.throwIfDisposed(),this.privList.join(e)}toArray(){const e=Array();return this.privList.forEach(t=>{e.push(t)}),e}any(e){return this.throwIfDisposed(),e?this.where(e).length()>0:this.length()>0}all(e){return this.throwIfDisposed(),this.where(e).length()===this.length()}forEach(e){this.throwIfDisposed();for(let t=0;t<this.length();t++)e(this.privList[t],t)}select(e){this.throwIfDisposed();const t=[];for(let s=0;s<this.privList.length;s++)t.push(e(this.privList[s],s));return new List(t)}where(e){this.throwIfDisposed();const t=new List;for(let s=0;s<this.privList.length;s++)e(this.privList[s],s)&&t.add(this.privList[s]);return t}orderBy(e){this.throwIfDisposed();const s=this.toArray().sort(e);return new List(s)}orderByDesc(e){return this.throwIfDisposed(),this.orderBy((t,s)=>e(s,t))}clone(){return this.throwIfDisposed(),new List(this.toArray())}concat(e){return this.throwIfDisposed(),new List(this.privList.concat(e.toArray()))}concatArray(e){return this.throwIfDisposed(),new List(this.privList.concat(e))}isDisposed(){return this.privList==null}dispose(e){this.isDisposed()||(this.privDisposeReason=e,this.privList=null,this.privAddSubscriptions=null,this.privRemoveSubscriptions=null,this.triggerSubscriptions(this.privDisposedSubscriptions))}throwIfDisposed(){if(this.isDisposed())throw new Error_js_1$4.ObjectDisposedError("List",this.privDisposeReason)}triggerSubscriptions(e){if(e)for(const t in e)t&&e[t]()}}List$1.List=List;var _Promise={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.marshalPromiseToCallbacks=i.Sink=i.Deferred=i.PromiseResultEventSource=i.PromiseResult=i.PromiseState=void 0;var e;(function(u){u[u.None=0]="None",u[u.Resolved=1]="Resolved",u[u.Rejected=2]="Rejected"})(e=i.PromiseState||(i.PromiseState={}));class t{constructor(d){this.throwIfError=()=>{if(this.isError)throw this.error},d.on(p=>{this.privIsCompleted||(this.privIsCompleted=!0,this.privIsError=!1,this.privResult=p)},p=>{this.privIsCompleted||(this.privIsCompleted=!0,this.privIsError=!0,this.privError=p)})}get isCompleted(){return this.privIsCompleted}get isError(){return this.privIsError}get error(){return this.privError}get result(){return this.privResult}}i.PromiseResult=t;class s{constructor(){this.setResult=d=>{this.privOnSetResult(d)},this.setError=d=>{this.privOnSetError(d)},this.on=(d,p)=>{this.privOnSetResult=d,this.privOnSetError=p}}}i.PromiseResultEventSource=s;class o{constructor(){this.resolve=d=>(this.privResolve(d),this),this.reject=d=>(this.privReject(d),this),this.privPromise=new Promise((d,p)=>{this.privResolve=d,this.privReject=p})}get promise(){return this.privPromise}}i.Deferred=o;class a{constructor(){this.privState=e.None,this.privPromiseResult=null,this.privPromiseResultEvents=null,this.privSuccessHandlers=[],this.privErrorHandlers=[],this.privPromiseResultEvents=new s,this.privPromiseResult=new t(this.privPromiseResultEvents)}get state(){return this.privState}get result(){return this.privPromiseResult}resolve(d){if(this.privState!==e.None)throw new Error("'Cannot resolve a completed promise'");this.privState=e.Resolved,this.privPromiseResultEvents.setResult(d);for(let p=0;p<this.privSuccessHandlers.length;p++)this.executeSuccessCallback(d,this.privSuccessHandlers[p],this.privErrorHandlers[p]);this.detachHandlers()}reject(d){if(this.privState!==e.None)throw new Error("'Cannot reject a completed promise'");this.privState=e.Rejected,this.privPromiseResultEvents.setError(d);for(const p of this.privErrorHandlers)this.executeErrorCallback(d,p);this.detachHandlers()}on(d,p){d==null&&(d=()=>{}),this.privState===e.None?(this.privSuccessHandlers.push(d),this.privErrorHandlers.push(p)):(this.privState===e.Resolved?this.executeSuccessCallback(this.privPromiseResult.result,d,p):this.privState===e.Rejected&&this.executeErrorCallback(this.privPromiseResult.error,p),this.detachHandlers())}executeSuccessCallback(d,p,v){try{p(d)}catch(g){this.executeErrorCallback(`'Unhandled callback error: ${g}'`,v)}}executeErrorCallback(d,p){if(p)try{p(d)}catch(v){throw new Error(`'Unhandled callback error: ${v}. InnerError: ${d}'`)}else throw new Error(`'Unhandled error: ${d}'`)}detachHandlers(){this.privErrorHandlers=[],this.privSuccessHandlers=[]}}i.Sink=a;function c(u,d,p){u.then(v=>{try{d&&d(v)}catch(g){if(p)try{if(g instanceof Error){const m=g;p(m.name+": "+m.message)}else p(g)}catch{}}},v=>{if(p)try{if(v instanceof Error){const g=v;p(g.name+": "+g.message)}else p(v)}catch{}})}i.marshalPromiseToCallbacks=c})(_Promise);var Queue$1={};Object.defineProperty(Queue$1,"__esModule",{value:!0});Queue$1.Queue=void 0;const Error_js_1$3=_Error,List_js_1=List$1,Promise_js_1=_Promise;var SubscriberType;(function(i){i[i.Dequeue=0]="Dequeue",i[i.Peek=1]="Peek"})(SubscriberType||(SubscriberType={}));class Queue{constructor(e){this.privPromiseStore=new List_js_1.List,this.privIsDrainInProgress=!1,this.privIsDisposing=!1,this.privDisposeReason=null,this.privList=e||new List_js_1.List,this.privDetachables=[],this.privSubscribers=new List_js_1.List,this.privDetachables.push(this.privList.onAdded(()=>this.drain()))}enqueue(e){this.throwIfDispose(),this.enqueueFromPromise(new Promise(t=>t(e)))}enqueueFromPromise(e){this.throwIfDispose(),e.then(t=>{this.privList.add(t)},()=>{})}dequeue(){this.throwIfDispose();const e=new Promise_js_1.Deferred;return this.privSubscribers&&(this.privSubscribers.add({deferral:e,type:SubscriberType.Dequeue}),this.drain()),e.promise}peek(){this.throwIfDispose();const e=new Promise_js_1.Deferred;return this.privSubscribers&&(this.privSubscribers.add({deferral:e,type:SubscriberType.Peek}),this.drain()),e.promise}length(){return this.throwIfDispose(),this.privList.length()}isDisposed(){return this.privSubscribers==null}async drainAndDispose(e,t){if(!this.isDisposed()&&!this.privIsDisposing){this.privDisposeReason=t,this.privIsDisposing=!0;const s=this.privSubscribers;if(s){for(;s.length()>0;)s.removeFirst().deferral.resolve(void 0);this.privSubscribers===s&&(this.privSubscribers=s)}for(const o of this.privDetachables)await o.detach();if(this.privPromiseStore.length()>0&&e){const o=[];return this.privPromiseStore.toArray().forEach(a=>{o.push(a)}),Promise.all(o).finally(()=>{this.privSubscribers=null,this.privList.forEach(a=>{e(a)}),this.privList=null}).then()}else this.privSubscribers=null,this.privList=null}}async dispose(e){await this.drainAndDispose(null,e)}drain(){if(!this.privIsDrainInProgress&&!this.privIsDisposing){this.privIsDrainInProgress=!0;const e=this.privSubscribers,t=this.privList;if(e&&t){for(;t.length()>0&&e.length()>0&&!this.privIsDisposing;){const s=e.removeFirst();if(s.type===SubscriberType.Peek)s.deferral.resolve(t.first());else{const o=t.removeFirst();s.deferral.resolve(o)}}this.privSubscribers===e&&(this.privSubscribers=e),this.privList===t&&(this.privList=t)}this.privIsDrainInProgress=!1}}throwIfDispose(){if(this.isDisposed())throw this.privDisposeReason?new Error_js_1$3.InvalidOperationError(this.privDisposeReason):new Error_js_1$3.ObjectDisposedError("Queue");if(this.privIsDisposing)throw new Error_js_1$3.InvalidOperationError("Queue disposing")}}Queue$1.Queue=Queue;var RawWebsocketMessage$1={};Object.defineProperty(RawWebsocketMessage$1,"__esModule",{value:!0});RawWebsocketMessage$1.RawWebsocketMessage=void 0;const ConnectionMessage_js_1=ConnectionMessage$1,Error_js_1$2=_Error,Guid_js_1$1=Guid;class RawWebsocketMessage{constructor(e,t,s){if(this.privPayload=null,!t)throw new Error_js_1$2.ArgumentNullError("payload");if(e===ConnectionMessage_js_1.MessageType.Binary&&Object.getPrototypeOf(t).constructor.name!=="ArrayBuffer")throw new Error_js_1$2.InvalidOperationError("Payload must be ArrayBuffer");if(e===ConnectionMessage_js_1.MessageType.Text&&typeof t!="string")throw new Error_js_1$2.InvalidOperationError("Payload must be a string");this.privMessageType=e,this.privPayload=t,this.privId=s||Guid_js_1$1.createNoDashGuid()}get messageType(){return this.privMessageType}get payload(){return this.privPayload}get textContent(){if(this.privMessageType===ConnectionMessage_js_1.MessageType.Binary)throw new Error_js_1$2.InvalidOperationError("Not supported for binary message");return this.privPayload}get binaryContent(){if(this.privMessageType===ConnectionMessage_js_1.MessageType.Text)throw new Error_js_1$2.InvalidOperationError("Not supported for text message");return this.privPayload}get id(){return this.privId}}RawWebsocketMessage$1.RawWebsocketMessage=RawWebsocketMessage;var RiffPcmEncoder$1={};Object.defineProperty(RiffPcmEncoder$1,"__esModule",{value:!0});RiffPcmEncoder$1.RiffPcmEncoder=void 0;class RiffPcmEncoder{constructor(e,t){this.privActualSampleRate=e,this.privDesiredSampleRate=t}encode(e){const t=this.downSampleAudioFrame(e,this.privActualSampleRate,this.privDesiredSampleRate);if(!t)return null;const s=t.length*2,o=new ArrayBuffer(s),a=new DataView(o);return this.floatTo16BitPCM(a,0,t),o}setString(e,t,s){for(let o=0;o<s.length;o++)e.setUint8(t+o,s.charCodeAt(o))}floatTo16BitPCM(e,t,s){for(let o=0;o<s.length;o++,t+=2){const a=Math.max(-1,Math.min(1,s[o]));e.setInt16(t,a<0?a*32768:a*32767,!0)}}downSampleAudioFrame(e,t,s){if(!e)return null;if(s===t||s>t)return e;const o=t/s,a=Math.round(e.length/o),c=new Float32Array(a);let u=0,d=0;for(;d<a;){const p=Math.round((d+1)*o);let v=0,g=0;for(;u<p&&u<e.length;)v+=e[u++],g++;c[d++]=v/g}return c}}RiffPcmEncoder$1.RiffPcmEncoder=RiffPcmEncoder;var Stream$1={};Object.defineProperty(Stream$1,"__esModule",{value:!0});Stream$1.Stream=void 0;const Error_js_1$1=_Error,Guid_js_1=Guid,Queue_js_1=Queue$1;class Stream{constructor(e){this.privIsWriteEnded=!1,this.privIsReadEnded=!1,this.privId=e||Guid_js_1.createNoDashGuid(),this.privReaderQueue=new Queue_js_1.Queue}get isClosed(){return this.privIsWriteEnded}get isReadEnded(){return this.privIsReadEnded}get id(){return this.privId}close(){this.privIsWriteEnded||(this.writeStreamChunk({buffer:null,isEnd:!0,timeReceived:Date.now()}),this.privIsWriteEnded=!0)}writeStreamChunk(e){if(this.throwIfClosed(),!this.privReaderQueue.isDisposed())try{this.privReaderQueue.enqueue(e)}catch{}}read(){if(this.privIsReadEnded)throw new Error_js_1$1.InvalidOperationError("Stream read has already finished");return this.privReaderQueue.dequeue().then(async e=>((e===void 0||e.isEnd)&&await this.privReaderQueue.dispose("End of stream reached"),e))}readEnded(){this.privIsReadEnded||(this.privIsReadEnded=!0,this.privReaderQueue=new Queue_js_1.Queue)}throwIfClosed(){if(this.privIsWriteEnded)throw new Error_js_1$1.InvalidOperationError("Stream closed")}}Stream$1.Stream=Stream;var TranslationStatus={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.TranslationStatus=void 0,function(e){e[e.Success=0]="Success",e[e.Error=1]="Error"}(i.TranslationStatus||(i.TranslationStatus={}))})(TranslationStatus);var ChunkedArrayBufferStream={},hasRequiredChunkedArrayBufferStream;function requireChunkedArrayBufferStream(){if(hasRequiredChunkedArrayBufferStream)return ChunkedArrayBufferStream;hasRequiredChunkedArrayBufferStream=1,Object.defineProperty(ChunkedArrayBufferStream,"__esModule",{value:!0}),ChunkedArrayBufferStream.ChunkedArrayBufferStream=void 0;const i=requireExports$5();let e=class extends i.Stream{constructor(s,o){super(o),this.privTargetChunkSize=Math.round(s),this.privNextBufferReadyBytes=0}writeStreamChunk(s){if(s.isEnd||this.privNextBufferReadyBytes===0&&s.buffer.byteLength===this.privTargetChunkSize){super.writeStreamChunk(s);return}let o=0;for(;o<s.buffer.byteLength;){this.privNextBufferToWrite===void 0&&(this.privNextBufferToWrite=new ArrayBuffer(this.privTargetChunkSize),this.privNextBufferStartTime=s.timeReceived);const a=Math.min(s.buffer.byteLength-o,this.privTargetChunkSize-this.privNextBufferReadyBytes),c=new Uint8Array(this.privNextBufferToWrite),u=new Uint8Array(s.buffer.slice(o,a+o));c.set(u,this.privNextBufferReadyBytes),this.privNextBufferReadyBytes+=a,o+=a,this.privNextBufferReadyBytes===this.privTargetChunkSize&&(super.writeStreamChunk({buffer:this.privNextBufferToWrite,isEnd:!1,timeReceived:this.privNextBufferStartTime}),this.privNextBufferReadyBytes=0,this.privNextBufferToWrite=void 0)}}close(){this.privNextBufferReadyBytes!==0&&!this.isClosed&&super.writeStreamChunk({buffer:this.privNextBufferToWrite.slice(0,this.privNextBufferReadyBytes),isEnd:!1,timeReceived:this.privNextBufferStartTime}),super.close()}};return ChunkedArrayBufferStream.ChunkedArrayBufferStream=e,ChunkedArrayBufferStream}var IAudioDestination={};Object.defineProperty(IAudioDestination,"__esModule",{value:!0});var Timeout$1={};Object.defineProperty(Timeout$1,"__esModule",{value:!0});Timeout$1.Timeout=void 0;class Timeout{static load(){const e=new Map([[0,()=>{}]]),t=new Map,o="data:text/javascript;base64,"+btoa(`!function(e){var t={};function n(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)n.d(r,o,function(t){return e[t]}.bind(null,o));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=14)}([function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return u})),n.d(t,"c",(function(){return a})),n.d(t,"d",(function(){return d}));const r=new Map,o=new Map,i=e=>{const t=r.get(e);if(void 0===t)throw new Error('There is no interval scheduled with the given id "'.concat(e,'".'));clearTimeout(t),r.delete(e)},u=e=>{const t=o.get(e);if(void 0===t)throw new Error('There is no timeout scheduled with the given id "'.concat(e,'".'));clearTimeout(t),o.delete(e)},f=(e,t)=>{let n,r;if("performance"in self){const o=performance.now();n=o,r=e-Math.max(0,o-t)}else n=Date.now(),r=e;return{expected:n+r,remainingDelay:r}},c=(e,t,n,r)=>{const o="performance"in self?performance.now():Date.now();o>n?postMessage({id:null,method:"call",params:{timerId:t}}):e.set(t,setTimeout(c,n-o,e,t,n))},a=(e,t,n)=>{const{expected:o,remainingDelay:i}=f(e,n);r.set(t,setTimeout(c,i,r,t,o))},d=(e,t,n)=>{const{expected:r,remainingDelay:i}=f(e,n);o.set(t,setTimeout(c,i,o,t,r))}},function(e,t,n){"use strict";n.r(t);var r=n(2);for(var o in r)"default"!==o&&function(e){n.d(t,e,(function(){return r[e]}))}(o);var i=n(3);for(var o in i)"default"!==o&&function(e){n.d(t,e,(function(){return i[e]}))}(o);var u=n(4);for(var o in u)"default"!==o&&function(e){n.d(t,e,(function(){return u[e]}))}(o);var f=n(5);for(var o in f)"default"!==o&&function(e){n.d(t,e,(function(){return f[e]}))}(o);var c=n(6);for(var o in c)"default"!==o&&function(e){n.d(t,e,(function(){return c[e]}))}(o);var a=n(7);for(var o in a)"default"!==o&&function(e){n.d(t,e,(function(){return a[e]}))}(o);var d=n(8);for(var o in d)"default"!==o&&function(e){n.d(t,e,(function(){return d[e]}))}(o);var s=n(9);for(var o in s)"default"!==o&&function(e){n.d(t,e,(function(){return s[e]}))}(o)},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t){},function(e,t,n){"use strict";n.r(t);var r=n(11);for(var o in r)"default"!==o&&function(e){n.d(t,e,(function(){return r[e]}))}(o);var i=n(12);for(var o in i)"default"!==o&&function(e){n.d(t,e,(function(){return i[e]}))}(o);var u=n(13);for(var o in u)"default"!==o&&function(e){n.d(t,e,(function(){return u[e]}))}(o)},function(e,t){},function(e,t){},function(e,t){},function(e,t,n){"use strict";n.r(t);var r=n(0),o=n(1);for(var i in o)"default"!==i&&function(e){n.d(t,e,(function(){return o[e]}))}(i);var u=n(10);for(var i in u)"default"!==i&&function(e){n.d(t,e,(function(){return u[e]}))}(i);addEventListener("message",({data:e})=>{try{if("clear"===e.method){const{id:t,params:{timerId:n}}=e;Object(r.b)(n),postMessage({error:null,id:t})}else{if("set"!==e.method)throw new Error('The given method "'.concat(e.method,'" is not supported'));{const{params:{delay:t,now:n,timerId:o}}=e;Object(r.d)(t,o,n)}}}catch(t){postMessage({error:{message:t.message},id:e.id,result:null})}})}]);`),a=new Worker(o);return a.addEventListener("message",({data:d})=>{if(Timeout.isCallNotification(d)){const{params:{timerId:p}}=d,v=e.get(p);if(typeof v=="number"){const g=t.get(v);if(g===void 0||g!==p)throw new Error("The timer is in an undefined state.")}else if(typeof v<"u")v(),e.delete(p);else throw new Error("The timer is in an undefined state.")}else if(Timeout.isClearResponse(d)){const{id:p}=d,v=t.get(p);if(v===void 0)throw new Error("The timer is in an undefined state.");t.delete(p),e.delete(v)}else{const{error:{message:p}}=d;throw new Error(p)}}),{clearTimeout:d=>{const p=Math.random();t.set(p,d),e.set(d,p),a.postMessage({id:p,method:"clear",params:{timerId:d}})},setTimeout:(d,p)=>{const v=Math.random();return e.set(v,d),a.postMessage({id:null,method:"set",params:{delay:p,now:performance.now(),timerId:v}}),v}}}static loadWorkerTimers(){return()=>(Timeout.workerTimers!==null||(Timeout.workerTimers=Timeout.load()),Timeout.workerTimers)}static isCallNotification(e){return e.method!==void 0&&e.method==="call"}static isClearResponse(e){return e.error===null&&typeof e.id=="number"}}Timeout$1.Timeout=Timeout;Timeout.workerTimers=null;Timeout.clearTimeout=i=>Timeout.timers().clearTimeout(i);Timeout.setTimeout=(i,e)=>Timeout.timers().setTimeout(i,e);Timeout.timers=Timeout.loadWorkerTimers();var OCSPEvents={};Object.defineProperty(OCSPEvents,"__esModule",{value:!0});OCSPEvents.OCSPCacheUpdateErrorEvent=OCSPEvents.OCSPResponseRetrievedEvent=OCSPEvents.OCSPCacheFetchErrorEvent=OCSPEvents.OCSPVerificationFailedEvent=OCSPEvents.OCSPCacheHitEvent=OCSPEvents.OCSPCacheEntryNeedsRefreshEvent=OCSPEvents.OCSPCacheEntryExpiredEvent=OCSPEvents.OCSPWSUpgradeStartedEvent=OCSPEvents.OCSPStapleReceivedEvent=OCSPEvents.OCSPCacheUpdateCompleteEvent=OCSPEvents.OCSPDiskCacheStoreEvent=OCSPEvents.OCSPMemoryCacheStoreEvent=OCSPEvents.OCSPCacheUpdateNeededEvent=OCSPEvents.OCSPDiskCacheHitEvent=OCSPEvents.OCSPCacheMissEvent=OCSPEvents.OCSPMemoryCacheHitEvent=OCSPEvents.OCSPEvent=void 0;const PlatformEvent_js_1=PlatformEvent;class OCSPEvent extends PlatformEvent_js_1.PlatformEvent{constructor(e,t,s){super(e,t),this.privSignature=s}}OCSPEvents.OCSPEvent=OCSPEvent;class OCSPMemoryCacheHitEvent extends OCSPEvent{constructor(e){super("OCSPMemoryCacheHitEvent",PlatformEvent_js_1.EventType.Debug,e)}}OCSPEvents.OCSPMemoryCacheHitEvent=OCSPMemoryCacheHitEvent;class OCSPCacheMissEvent extends OCSPEvent{constructor(e){super("OCSPCacheMissEvent",PlatformEvent_js_1.EventType.Debug,e)}}OCSPEvents.OCSPCacheMissEvent=OCSPCacheMissEvent;class OCSPDiskCacheHitEvent extends OCSPEvent{constructor(e){super("OCSPDiskCacheHitEvent",PlatformEvent_js_1.EventType.Debug,e)}}OCSPEvents.OCSPDiskCacheHitEvent=OCSPDiskCacheHitEvent;class OCSPCacheUpdateNeededEvent extends OCSPEvent{constructor(e){super("OCSPCacheUpdateNeededEvent",PlatformEvent_js_1.EventType.Debug,e)}}OCSPEvents.OCSPCacheUpdateNeededEvent=OCSPCacheUpdateNeededEvent;class OCSPMemoryCacheStoreEvent extends OCSPEvent{constructor(e){super("OCSPMemoryCacheStoreEvent",PlatformEvent_js_1.EventType.Debug,e)}}OCSPEvents.OCSPMemoryCacheStoreEvent=OCSPMemoryCacheStoreEvent;class OCSPDiskCacheStoreEvent extends OCSPEvent{constructor(e){super("OCSPDiskCacheStoreEvent",PlatformEvent_js_1.EventType.Debug,e)}}OCSPEvents.OCSPDiskCacheStoreEvent=OCSPDiskCacheStoreEvent;class OCSPCacheUpdateCompleteEvent extends OCSPEvent{constructor(e){super("OCSPCacheUpdateCompleteEvent",PlatformEvent_js_1.EventType.Debug,e)}}OCSPEvents.OCSPCacheUpdateCompleteEvent=OCSPCacheUpdateCompleteEvent;class OCSPStapleReceivedEvent extends OCSPEvent{constructor(){super("OCSPStapleReceivedEvent",PlatformEvent_js_1.EventType.Debug,"")}}OCSPEvents.OCSPStapleReceivedEvent=OCSPStapleReceivedEvent;class OCSPWSUpgradeStartedEvent extends OCSPEvent{constructor(e){super("OCSPWSUpgradeStartedEvent",PlatformEvent_js_1.EventType.Debug,e)}}OCSPEvents.OCSPWSUpgradeStartedEvent=OCSPWSUpgradeStartedEvent;class OCSPCacheEntryExpiredEvent extends OCSPEvent{constructor(e,t){super("OCSPCacheEntryExpiredEvent",PlatformEvent_js_1.EventType.Debug,e),this.privExpireTime=t}}OCSPEvents.OCSPCacheEntryExpiredEvent=OCSPCacheEntryExpiredEvent;class OCSPCacheEntryNeedsRefreshEvent extends OCSPEvent{constructor(e,t,s){super("OCSPCacheEntryNeedsRefreshEvent",PlatformEvent_js_1.EventType.Debug,e),this.privExpireTime=s,this.privStartTime=t}}OCSPEvents.OCSPCacheEntryNeedsRefreshEvent=OCSPCacheEntryNeedsRefreshEvent;class OCSPCacheHitEvent extends OCSPEvent{constructor(e,t,s){super("OCSPCacheHitEvent",PlatformEvent_js_1.EventType.Debug,e),this.privExpireTime=s,this.privExpireTimeString=new Date(s).toLocaleDateString(),this.privStartTime=t,this.privStartTimeString=new Date(t).toLocaleTimeString()}}OCSPEvents.OCSPCacheHitEvent=OCSPCacheHitEvent;class OCSPVerificationFailedEvent extends OCSPEvent{constructor(e,t){super("OCSPVerificationFailedEvent",PlatformEvent_js_1.EventType.Debug,e),this.privError=t}}OCSPEvents.OCSPVerificationFailedEvent=OCSPVerificationFailedEvent;class OCSPCacheFetchErrorEvent extends OCSPEvent{constructor(e,t){super("OCSPCacheFetchErrorEvent",PlatformEvent_js_1.EventType.Debug,e),this.privError=t}}OCSPEvents.OCSPCacheFetchErrorEvent=OCSPCacheFetchErrorEvent;class OCSPResponseRetrievedEvent extends OCSPEvent{constructor(e){super("OCSPResponseRetrievedEvent",PlatformEvent_js_1.EventType.Debug,e)}}OCSPEvents.OCSPResponseRetrievedEvent=OCSPResponseRetrievedEvent;class OCSPCacheUpdateErrorEvent extends OCSPEvent{constructor(e,t){super("OCSPCacheUpdateErrorEvent",PlatformEvent_js_1.EventType.Debug,e),this.privError=t}}OCSPEvents.OCSPCacheUpdateErrorEvent=OCSPCacheUpdateErrorEvent;var BackgroundError={},hasRequiredBackgroundError;function requireBackgroundError(){if(hasRequiredBackgroundError)return BackgroundError;hasRequiredBackgroundError=1,Object.defineProperty(BackgroundError,"__esModule",{value:!0}),BackgroundError.BackgroundEvent=void 0;const i=requireExports$5();class e extends i.PlatformEvent{constructor(s){super("BackgroundEvent",i.EventType.Error),this.privError=s}get error(){return this.privError}}return BackgroundError.BackgroundEvent=e,BackgroundError}var hasRequiredExports$5;function requireExports$5(){return hasRequiredExports$5||(hasRequiredExports$5=1,function(i){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(o,a,c,u){u===void 0&&(u=c),Object.defineProperty(o,u,{enumerable:!0,get:function(){return a[c]}})}:function(o,a,c,u){u===void 0&&(u=c),o[u]=a[c]}),t=commonjsGlobal&&commonjsGlobal.__exportStar||function(o,a){for(var c in o)c!=="default"&&!a.hasOwnProperty(c)&&e(a,o,c)};Object.defineProperty(i,"__esModule",{value:!0}),t(AudioSourceEvents,i),t(ConnectionEvents,i),t(ConnectionMessage$1,i),t(ConnectionOpenResponse$1,i),t(DeferralMap$1,i),t(DialogEvents,i),t(_Error,i),t(Events$1,i),t(EventSource$1,i),t(Guid,i),t(IAudioSource,i),t(IConnection,i),t(IDetachable,i),t(IDictionary,i),t(IDisposable,i),t(IEventListener,i),t(IEventSource,i),t(IErrorMessages,i),t(ITimer,i),t(IWebsocketMessageFormatter,i),t(List$1,i),t(PlatformEvent,i),t(_Promise,i),t(Queue$1,i),t(RawWebsocketMessage$1,i),t(RiffPcmEncoder$1,i),t(Stream$1,i);var s=TranslationStatus;Object.defineProperty(i,"TranslationStatus",{enumerable:!0,get:function(){return s.TranslationStatus}}),t(requireChunkedArrayBufferStream(),i),t(IAudioDestination,i),t(Timeout$1,i),t(OCSPEvents,i),t(requireBackgroundError(),i)}(Exports$5)),Exports$5}var HeaderNames$1={};Object.defineProperty(HeaderNames$1,"__esModule",{value:!0});HeaderNames$1.HeaderNames=void 0;class HeaderNames{}HeaderNames$1.HeaderNames=HeaderNames;HeaderNames.AuthKey="Ocp-Apim-Subscription-Key";HeaderNames.Authorization="Authorization";HeaderNames.SpIDAuthKey="Apim-Subscription-Id";HeaderNames.ConnectionId="X-ConnectionId";HeaderNames.ContentType="Content-Type";HeaderNames.CustomCommandsAppId="X-CommandsAppId";HeaderNames.Path="Path";HeaderNames.RequestId="X-RequestId";HeaderNames.RequestStreamId="X-StreamId";HeaderNames.RequestTimestamp="X-Timestamp";var IAuthentication={};Object.defineProperty(IAuthentication,"__esModule",{value:!0});IAuthentication.AuthInfo=void 0;class AuthInfo{constructor(e,t){this.privHeaderName=e,this.privToken=t}get headerName(){return this.privHeaderName}get token(){return this.privToken}}IAuthentication.AuthInfo=AuthInfo;Object.defineProperty(CognitiveSubscriptionKeyAuthentication$1,"__esModule",{value:!0});CognitiveSubscriptionKeyAuthentication$1.CognitiveSubscriptionKeyAuthentication=void 0;const Exports_js_1$d=requireExports$5(),HeaderNames_js_1$3=HeaderNames$1,IAuthentication_js_1$1=IAuthentication;class CognitiveSubscriptionKeyAuthentication{constructor(e){if(!e)throw new Exports_js_1$d.ArgumentNullError("subscriptionKey");this.privAuthInfo=new IAuthentication_js_1$1.AuthInfo(HeaderNames_js_1$3.HeaderNames.AuthKey,e)}fetch(e){return Promise.resolve(this.privAuthInfo)}fetchOnExpiry(e){return Promise.resolve(this.privAuthInfo)}}CognitiveSubscriptionKeyAuthentication$1.CognitiveSubscriptionKeyAuthentication=CognitiveSubscriptionKeyAuthentication;var CognitiveTokenAuthentication$1={};Object.defineProperty(CognitiveTokenAuthentication$1,"__esModule",{value:!0});CognitiveTokenAuthentication$1.CognitiveTokenAuthentication=void 0;const Exports_js_1$c=requireExports$5(),IAuthentication_js_1=IAuthentication,HeaderNames_js_1$2=HeaderNames$1;class CognitiveTokenAuthentication{constructor(e,t){if(!e)throw new Exports_js_1$c.ArgumentNullError("fetchCallback");if(!t)throw new Exports_js_1$c.ArgumentNullError("fetchOnExpiryCallback");this.privFetchCallback=e,this.privFetchOnExpiryCallback=t}fetch(e){return this.privFetchCallback(e).then(t=>new IAuthentication_js_1.AuthInfo(HeaderNames_js_1$2.HeaderNames.Authorization,t===void 0?void 0:CognitiveTokenAuthentication.privTokenPrefix+t))}fetchOnExpiry(e){return this.privFetchOnExpiryCallback(e).then(t=>new IAuthentication_js_1.AuthInfo(HeaderNames_js_1$2.HeaderNames.Authorization,t===void 0?void 0:CognitiveTokenAuthentication.privTokenPrefix+t))}}CognitiveTokenAuthentication$1.CognitiveTokenAuthentication=CognitiveTokenAuthentication;CognitiveTokenAuthentication.privTokenPrefix="Bearer ";var IConnectionFactory={};Object.defineProperty(IConnectionFactory,"__esModule",{value:!0});var ISynthesisConnectionFactory={};Object.defineProperty(ISynthesisConnectionFactory,"__esModule",{value:!0});var IntentConnectionFactory={},Exports$4={},ConsoleLoggingListener$1={};const __viteBrowserExternal={},__viteBrowserExternal$1=Object.freeze(Object.defineProperty({__proto__:null,default:__viteBrowserExternal},Symbol.toStringTag,{value:"Module"})),require$$0=getAugmentedNamespace(__viteBrowserExternal$1);var LogLevel={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.LogLevel=void 0;const e=requireExports$5();Object.defineProperty(i,"LogLevel",{enumerable:!0,get:function(){return e.EventType}})})(LogLevel);var Contracts$1={};Object.defineProperty(Contracts$1,"__esModule",{value:!0});Contracts$1.Contracts=void 0;class Contracts{static throwIfNullOrUndefined(e,t){if(e==null)throw new Error("throwIfNullOrUndefined:"+t)}static throwIfNull(e,t){if(e===null)throw new Error("throwIfNull:"+t)}static throwIfNullOrWhitespace(e,t){if(Contracts.throwIfNullOrUndefined(e,t),(""+e).trim().length<1)throw new Error("throwIfNullOrWhitespace:"+t)}static throwIfNullOrTooLong(e,t,s){if(Contracts.throwIfNullOrUndefined(e,t),(""+e).length>s)throw new Error("throwIfNullOrTooLong:"+t+" (more than "+s.toString()+" characters)")}static throwIfNullOrTooShort(e,t,s){if(Contracts.throwIfNullOrUndefined(e,t),(""+e).length<s)throw new Error("throwIfNullOrTooShort:"+t+" (less than "+s.toString()+" characters)")}static throwIfDisposed(e){if(e)throw new Error("the object is already disposed")}static throwIfArrayEmptyOrWhitespace(e,t){if(Contracts.throwIfNullOrUndefined(e,t),e.length===0)throw new Error("throwIfArrayEmptyOrWhitespace:"+t);for(const s of e)Contracts.throwIfNullOrWhitespace(s,t)}static throwIfFileDoesNotExist(e,t){Contracts.throwIfNullOrWhitespace(e,t)}static throwIfNotUndefined(e,t){if(e!==void 0)throw new Error("throwIfNotUndefined:"+t)}}Contracts$1.Contracts=Contracts;var __createBinding$2=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t),Object.defineProperty(i,s,{enumerable:!0,get:function(){return e[t]}})}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),__setModuleDefault$2=commonjsGlobal&&commonjsGlobal.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),__importStar$2=commonjsGlobal&&commonjsGlobal.__importStar||function(i){if(i&&i.__esModule)return i;var e={};if(i!=null)for(var t in i)t!=="default"&&Object.hasOwnProperty.call(i,t)&&__createBinding$2(e,i,t);return __setModuleDefault$2(e,i),e};Object.defineProperty(ConsoleLoggingListener$1,"__esModule",{value:!0});ConsoleLoggingListener$1.ConsoleLoggingListener=void 0;const fs$1=__importStar$2(require$$0),LogLevel_js_1=LogLevel,Contracts_js_1$7=Contracts$1;class ConsoleLoggingListener{constructor(e=LogLevel_js_1.LogLevel.None){this.privLogPath=void 0,this.privEnableConsoleOutput=!0,this.privLogLevelFilter=e}set logPath(e){Contracts_js_1$7.Contracts.throwIfNullOrUndefined(fs$1.openSync,`
File System access not available`),this.privLogPath=e}set enableConsoleOutput(e){this.privEnableConsoleOutput=e}onEvent(e){if(e.eventType>=this.privLogLevelFilter){const t=this.toString(e);if(this.logCallback&&this.logCallback(t),this.privLogPath&&fs$1.writeFileSync(this.privLogPath,t+`
`,{flag:"a+"}),this.privEnableConsoleOutput)switch(e.eventType){case LogLevel_js_1.LogLevel.Debug:console.debug(t);break;case LogLevel_js_1.LogLevel.Info:console.info(t);break;case LogLevel_js_1.LogLevel.Warning:console.warn(t);break;case LogLevel_js_1.LogLevel.Error:console.error(t);break;default:console.log(t);break}}}toString(e){const t=[`${e.eventTime}`,`${e.name}`],s=e;for(const o in s)if(o&&e.hasOwnProperty(o)&&o!=="eventTime"&&o!=="eventType"&&o!=="eventId"&&o!=="name"&&o!=="constructor"){const a=s[o];let c="<NULL>";a!=null&&(typeof a=="number"||typeof a=="string"?c=a.toString():c=JSON.stringify(a)),t.push(`${o}: ${c}`)}return t.join(" | ")}}ConsoleLoggingListener$1.ConsoleLoggingListener=ConsoleLoggingListener;var IRecorder={};Object.defineProperty(IRecorder,"__esModule",{value:!0});var MicAudioSource={},AudioStreamFormat={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.AudioStreamFormatImpl=i.AudioStreamFormat=i.AudioFormatTag=void 0;var e;(function(o){o[o.PCM=1]="PCM",o[o.MuLaw=2]="MuLaw",o[o.Siren=3]="Siren",o[o.MP3=4]="MP3",o[o.SILKSkype=5]="SILKSkype",o[o.OGG_OPUS=6]="OGG_OPUS",o[o.WEBM_OPUS=7]="WEBM_OPUS",o[o.ALaw=8]="ALaw",o[o.FLAC=9]="FLAC",o[o.OPUS=10]="OPUS",o[o.AMR_WB=11]="AMR_WB",o[o.G722=12]="G722"})(e=i.AudioFormatTag||(i.AudioFormatTag={}));class t{static getDefaultInputFormat(){return s.getDefaultInputFormat()}static getWaveFormat(a,c,u,d){return new s(a,c,u,d)}static getWaveFormatPCM(a,c,u){return new s(a,c,u)}}i.AudioStreamFormat=t;class s extends t{constructor(a=16e3,c=16,u=1,d=e.PCM){super();let p=!0;switch(d){case e.PCM:this.formatTag=1;break;case e.ALaw:this.formatTag=6;break;case e.MuLaw:this.formatTag=7;break;default:p=!1}if(this.bitsPerSample=c,this.samplesPerSec=a,this.channels=u,this.avgBytesPerSec=this.samplesPerSec*this.channels*(this.bitsPerSample/8),this.blockAlign=this.channels*Math.max(this.bitsPerSample,8),p){this.privHeader=new ArrayBuffer(44);const v=new DataView(this.privHeader);this.setString(v,0,"RIFF"),v.setUint32(4,0,!0),this.setString(v,8,"WAVEfmt "),v.setUint32(16,16,!0),v.setUint16(20,this.formatTag,!0),v.setUint16(22,this.channels,!0),v.setUint32(24,this.samplesPerSec,!0),v.setUint32(28,this.avgBytesPerSec,!0),v.setUint16(32,this.channels*(this.bitsPerSample/8),!0),v.setUint16(34,this.bitsPerSample,!0),this.setString(v,36,"data"),v.setUint32(40,0,!0)}}static getDefaultInputFormat(){return new s}static getAudioContext(a){const c=window.AudioContext||window.webkitAudioContext||!1;if(c)return a!==void 0&&navigator.mediaDevices.getSupportedConstraints().sampleRate?new c({sampleRate:a}):new c;throw new Error("Browser does not support Web Audio API (AudioContext is not available).")}close(){}get header(){return this.privHeader}setString(a,c,u){for(let d=0;d<u.length;d++)a.setUint8(c+d,u.charCodeAt(d))}}i.AudioStreamFormatImpl=s})(AudioStreamFormat);var hasRequiredMicAudioSource;function requireMicAudioSource(){return hasRequiredMicAudioSource||(hasRequiredMicAudioSource=1,function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.MicAudioSource=i.AudioWorkletSourceURLPropertyName=void 0;const e=requireExports(),t=requireExports$5(),s=AudioStreamFormat;i.AudioWorkletSourceURLPropertyName="MICROPHONE-WorkletSourceUrl";class o{constructor(c,u,d,p){this.privRecorder=c,this.deviceId=u,this.privStreams={},this.privOutputChunkSize=o.AUDIOFORMAT.avgBytesPerSec/10,this.privId=d||t.createNoDashGuid(),this.privEvents=new t.EventSource,this.privMediaStream=p||null,this.privIsClosing=!1}get format(){return Promise.resolve(o.AUDIOFORMAT)}turnOn(){if(this.privInitializeDeferral)return this.privInitializeDeferral.promise;this.privInitializeDeferral=new t.Deferred;try{this.createAudioContext()}catch(d){if(d instanceof Error){const p=d;this.privInitializeDeferral.reject(p.name+": "+p.message)}else this.privInitializeDeferral.reject(d);return this.privInitializeDeferral.promise}const c=window.navigator;let u=c.getUserMedia||c.webkitGetUserMedia||c.mozGetUserMedia||c.msGetUserMedia;if(c.mediaDevices&&(u=(d,p,v)=>{c.mediaDevices.getUserMedia(d).then(p).catch(v)}),u){const d=()=>{this.onEvent(new t.AudioSourceInitializingEvent(this.privId)),this.privMediaStream&&this.privMediaStream.active?(this.onEvent(new t.AudioSourceReadyEvent(this.privId)),this.privInitializeDeferral.resolve()):u({audio:this.deviceId?{deviceId:this.deviceId}:!0,video:!1},p=>{this.privMediaStream=p,this.onEvent(new t.AudioSourceReadyEvent(this.privId)),this.privInitializeDeferral.resolve()},p=>{const v=`Error occurred during microphone initialization: ${p}`;this.privInitializeDeferral.reject(v),this.onEvent(new t.AudioSourceErrorEvent(this.privId,v))})};this.privContext.state==="suspended"?this.privContext.resume().then(d).catch(p=>{this.privInitializeDeferral.reject(`Failed to initialize audio context: ${p}`)}):d()}else{const d="Browser does not support getUserMedia.";this.privInitializeDeferral.reject(d),this.onEvent(new t.AudioSourceErrorEvent(d,""))}return this.privInitializeDeferral.promise}id(){return this.privId}attach(c){return this.onEvent(new t.AudioStreamNodeAttachingEvent(this.privId,c)),this.listen(c).then(u=>(this.onEvent(new t.AudioStreamNodeAttachedEvent(this.privId,c)),{detach:async()=>(u.readEnded(),delete this.privStreams[c],this.onEvent(new t.AudioStreamNodeDetachedEvent(this.privId,c)),this.turnOff()),id:()=>c,read:()=>u.read()}))}detach(c){c&&this.privStreams[c]&&(this.privStreams[c].close(),delete this.privStreams[c],this.onEvent(new t.AudioStreamNodeDetachedEvent(this.privId,c)))}async turnOff(){for(const c in this.privStreams)if(c){const u=this.privStreams[c];u&&u.close()}this.onEvent(new t.AudioSourceOffEvent(this.privId)),this.privInitializeDeferral&&(await this.privInitializeDeferral,this.privInitializeDeferral=null),await this.destroyAudioContext()}get events(){return this.privEvents}get deviceInfo(){return this.getMicrophoneLabel().then(c=>({bitspersample:o.AUDIOFORMAT.bitsPerSample,channelcount:o.AUDIOFORMAT.channels,connectivity:e.connectivity.Unknown,manufacturer:"Speech SDK",model:c,samplerate:o.AUDIOFORMAT.samplesPerSec,type:e.type.Microphones}))}setProperty(c,u){if(c===i.AudioWorkletSourceURLPropertyName)this.privRecorder.setWorkletUrl(u);else throw new Error("Property '"+c+"' is not supported on Microphone.")}getMicrophoneLabel(){const c="microphone";if(this.privMicrophoneLabel!==void 0)return Promise.resolve(this.privMicrophoneLabel);if(this.privMediaStream===void 0||!this.privMediaStream.active)return Promise.resolve(c);this.privMicrophoneLabel=c;const u=this.privMediaStream.getTracks()[0].getSettings().deviceId;if(u===void 0)return Promise.resolve(this.privMicrophoneLabel);const d=new t.Deferred;return navigator.mediaDevices.enumerateDevices().then(p=>{for(const v of p)if(v.deviceId===u){this.privMicrophoneLabel=v.label;break}d.resolve(this.privMicrophoneLabel)},()=>d.resolve(this.privMicrophoneLabel)),d.promise}async listen(c){await this.turnOn();const u=new t.ChunkedArrayBufferStream(this.privOutputChunkSize,c);this.privStreams[c]=u;try{this.privRecorder.record(this.privContext,this.privMediaStream,u)}catch(p){throw this.onEvent(new t.AudioStreamNodeErrorEvent(this.privId,c,p)),p}return u}onEvent(c){this.privEvents.onEvent(c),t.Events.instance.onEvent(c)}createAudioContext(){this.privContext||(this.privContext=s.AudioStreamFormatImpl.getAudioContext(o.AUDIOFORMAT.samplesPerSec))}async destroyAudioContext(){if(!this.privContext)return;this.privRecorder.releaseMediaResources(this.privContext);let c=!1;"close"in this.privContext&&(c=!0),c?this.privIsClosing||(this.privIsClosing=!0,await this.privContext.close(),this.privContext=null,this.privIsClosing=!1):this.privContext!==null&&this.privContext.state==="running"&&await this.privContext.suspend()}}i.MicAudioSource=o,o.AUDIOFORMAT=s.AudioStreamFormat.getDefaultInputFormat()}(MicAudioSource)),MicAudioSource}var FileAudioSource={},hasRequiredFileAudioSource;function requireFileAudioSource(){if(hasRequiredFileAudioSource)return FileAudioSource;hasRequiredFileAudioSource=1,Object.defineProperty(FileAudioSource,"__esModule",{value:!0}),FileAudioSource.FileAudioSource=void 0;const i=requireExports(),e=requireExports$5(),t=AudioStreamFormat;let s=class{constructor(a,c,u){this.privStreams={},this.privHeaderEnd=44,this.privId=u||e.createNoDashGuid(),this.privEvents=new e.EventSource,this.privSource=a,typeof window<"u"&&typeof Blob<"u"&&this.privSource instanceof Blob?this.privFilename=a.name:this.privFilename=c||"unknown.wav",this.privAudioFormatPromise=this.readHeader()}get format(){return this.privAudioFormatPromise}turnOn(){if(this.privFilename.lastIndexOf(".wav")!==this.privFilename.length-4){const a=this.privFilename+" is not supported. Only WAVE files are allowed at the moment.";return this.onEvent(new e.AudioSourceErrorEvent(a,"")),Promise.reject(a)}this.onEvent(new e.AudioSourceInitializingEvent(this.privId)),this.onEvent(new e.AudioSourceReadyEvent(this.privId))}id(){return this.privId}async attach(a){this.onEvent(new e.AudioStreamNodeAttachingEvent(this.privId,a));const c=await this.upload(a);return this.onEvent(new e.AudioStreamNodeAttachedEvent(this.privId,a)),Promise.resolve({detach:async()=>{c.readEnded(),delete this.privStreams[a],this.onEvent(new e.AudioStreamNodeDetachedEvent(this.privId,a)),await this.turnOff()},id:()=>a,read:()=>c.read()})}detach(a){a&&this.privStreams[a]&&(this.privStreams[a].close(),delete this.privStreams[a],this.onEvent(new e.AudioStreamNodeDetachedEvent(this.privId,a)))}turnOff(){for(const a in this.privStreams)if(a){const c=this.privStreams[a];c&&!c.isClosed&&c.close()}return this.onEvent(new e.AudioSourceOffEvent(this.privId)),Promise.resolve()}get events(){return this.privEvents}get deviceInfo(){return this.privAudioFormatPromise.then(a=>Promise.resolve({bitspersample:a.bitsPerSample,channelcount:a.channels,connectivity:i.connectivity.Unknown,manufacturer:"Speech SDK",model:"File",samplerate:a.samplesPerSec,type:i.type.File}))}readHeader(){const c=this.privSource.slice(0,4296),u=new e.Deferred,d=p=>{const v=new DataView(p),g=T=>String.fromCharCode(v.getUint8(T),v.getUint8(T+1),v.getUint8(T+2),v.getUint8(T+3));if(g(0)!=="RIFF"){u.reject("Invalid WAV header in file, RIFF was not found");return}if(g(8)!=="WAVE"||g(12)!=="fmt "){u.reject("Invalid WAV header in file, WAVEfmt was not found");return}const m=v.getInt32(16,!0),S=v.getUint16(22,!0),y=v.getUint32(24,!0),C=v.getUint16(34,!0);let R=36+Math.max(m-16,0);for(;g(R)!=="data";R+=2)if(R>4288){u.reject("Invalid WAV header in file, data block was not found");return}this.privHeaderEnd=R+8,u.resolve(t.AudioStreamFormat.getWaveFormatPCM(y,C,S))};if(typeof window<"u"&&typeof Blob<"u"&&c instanceof Blob){const p=new FileReader;p.onload=v=>{const g=v.target.result;d(g)},p.readAsArrayBuffer(c)}else{const p=c;d(p.buffer.slice(p.byteOffset,p.byteOffset+p.byteLength))}return u.promise}async upload(a){const c=u=>{const d=`Error occurred while processing '${this.privFilename}'. ${u}`;throw this.onEvent(new e.AudioStreamNodeErrorEvent(this.privId,a,d)),new Error(d)};try{await this.turnOn();const u=await this.privAudioFormatPromise,d=new e.ChunkedArrayBufferStream(u.avgBytesPerSec/10,a);this.privStreams[a]=d;const p=this.privSource.slice(this.privHeaderEnd),v=g=>{d.isClosed||(d.writeStreamChunk({buffer:g,isEnd:!1,timeReceived:Date.now()}),d.close())};if(typeof window<"u"&&typeof Blob<"u"&&p instanceof Blob){const g=new FileReader;g.onerror=m=>c(m.toString()),g.onload=m=>{const S=m.target.result;v(S)},g.readAsArrayBuffer(p)}else{const g=p;v(g.buffer.slice(g.byteOffset,g.byteOffset+g.byteLength))}return d}catch(u){c(u)}}onEvent(a){this.privEvents.onEvent(a),e.Events.instance.onEvent(a)}};return FileAudioSource.FileAudioSource=s,FileAudioSource}var PCMRecorder={};Object.defineProperty(PCMRecorder,"__esModule",{value:!0});PCMRecorder.PcmRecorder=void 0;const Exports_1=requireExports$5();class PcmRecorder{constructor(e){this.privStopInputOnRelease=e}record(e,t,s){const a=new Exports_1.RiffPcmEncoder(e.sampleRate,16e3),c=e.createMediaStreamSource(t),u=()=>{const p=(()=>{let v=0;try{return e.createScriptProcessor(v,1,1)}catch{v=2048;let m=e.sampleRate;for(;v<16384&&m>=32e3;)v<<=1,m>>=1;return e.createScriptProcessor(v,1,1)}})();p.onaudioprocess=v=>{const g=v.inputBuffer.getChannelData(0);if(s&&!s.isClosed){const m=a.encode(g);m&&s.writeStreamChunk({buffer:m,isEnd:!1,timeReceived:Date.now()})}},c.connect(p),p.connect(e.destination),this.privMediaResources={scriptProcessorNode:p,source:c,stream:t}},d=!!this.privSpeechProcessorScript&&this.privSpeechProcessorScript.toLowerCase()==="ignore";if(e.audioWorklet&&!d){if(!this.privSpeechProcessorScript){const p=`class SP extends AudioWorkletProcessor {
                    constructor(options) {
                      super(options);
                    }
                    process(inputs, outputs) {
                      const input = inputs[0];
                      const output = [];
                      for (let channel = 0; channel < input.length; channel += 1) {
                        output[channel] = input[channel];
                      }
                      this.port.postMessage(output[0]);
                      return true;
                    }
                  }
                  registerProcessor('speech-processor', SP);`,v=new Blob([p],{type:"application/javascript; charset=utf-8"});this.privSpeechProcessorScript=URL.createObjectURL(v)}e.audioWorklet.addModule(this.privSpeechProcessorScript).then(()=>{const p=new AudioWorkletNode(e,"speech-processor");p.port.onmessage=v=>{const g=v.data;if(s&&!s.isClosed){const m=a.encode(g);m&&s.writeStreamChunk({buffer:m,isEnd:!1,timeReceived:Date.now()})}},c.connect(p),p.connect(e.destination),this.privMediaResources={scriptProcessorNode:p,source:c,stream:t}}).catch(()=>{u()})}else try{u()}catch(p){throw new Error(`Unable to start audio worklet node for PCMRecorder: ${p}`)}}releaseMediaResources(e){this.privMediaResources&&(this.privMediaResources.scriptProcessorNode&&(this.privMediaResources.scriptProcessorNode.disconnect(e.destination),this.privMediaResources.scriptProcessorNode=null),this.privMediaResources.source&&(this.privMediaResources.source.disconnect(),this.privStopInputOnRelease&&this.privMediaResources.stream.getTracks().forEach(t=>t.stop()),this.privMediaResources.source=null))}setWorkletUrl(e){this.privSpeechProcessorScript=e}}PCMRecorder.PcmRecorder=PcmRecorder;var WebsocketConnection$1={},WebsocketMessageAdapter$1={},__createBinding$1=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t),Object.defineProperty(i,s,{enumerable:!0,get:function(){return e[t]}})}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),__setModuleDefault$1=commonjsGlobal&&commonjsGlobal.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),__importStar$1=commonjsGlobal&&commonjsGlobal.__importStar||function(i){if(i&&i.__esModule)return i;var e={};if(i!=null)for(var t in i)t!=="default"&&Object.hasOwnProperty.call(i,t)&&__createBinding$1(e,i,t);return __setModuleDefault$1(e,i),e},__importDefault=commonjsGlobal&&commonjsGlobal.__importDefault||function(i){return i&&i.__esModule?i:{default:i}};Object.defineProperty(WebsocketMessageAdapter$1,"__esModule",{value:!0});WebsocketMessageAdapter$1.WebsocketMessageAdapter=void 0;const net=__importStar$1(require$$0),tls=__importStar$1(require$$0),agent_base_1=__importDefault(require$$0),https_proxy_agent_1=__importDefault(require$$0),ws_1=__importDefault(require$$0),HeaderNames_js_1$1=HeaderNames$1,Exports_js_1$b=requireExports$5();class WebsocketMessageAdapter{constructor(e,t,s,o,a,c){if(!e)throw new Exports_js_1$b.ArgumentNullError("uri");if(!s)throw new Exports_js_1$b.ArgumentNullError("messageFormatter");this.proxyInfo=o,this.privConnectionEvents=new Exports_js_1$b.EventSource,this.privConnectionId=t,this.privMessageFormatter=s,this.privConnectionState=Exports_js_1$b.ConnectionState.None,this.privUri=e,this.privHeaders=a,this.privEnableCompression=c,this.privHeaders[HeaderNames_js_1$1.HeaderNames.ConnectionId]=this.privConnectionId,this.privLastErrorReceived=""}get state(){return this.privConnectionState}open(){if(this.privConnectionState===Exports_js_1$b.ConnectionState.Disconnected)return Promise.reject(`Cannot open a connection that is in ${this.privConnectionState} state`);if(this.privConnectionEstablishDeferral)return this.privConnectionEstablishDeferral.promise;this.privConnectionEstablishDeferral=new Exports_js_1$b.Deferred,this.privCertificateValidatedDeferral=new Exports_js_1$b.Deferred,this.privConnectionState=Exports_js_1$b.ConnectionState.Connecting;try{if(typeof WebSocket<"u"&&!WebsocketMessageAdapter.forceNpmWebSocket)this.privCertificateValidatedDeferral.resolve(),this.privWebsocketClient=new WebSocket(this.privUri);else{const e={headers:this.privHeaders,perMessageDeflate:this.privEnableCompression};this.privCertificateValidatedDeferral.resolve(),e.agent=this.getAgent();let s=new URL(this.privUri).protocol;(s==null?void 0:s.toLocaleLowerCase())==="wss:"?s="https:":(s==null?void 0:s.toLocaleLowerCase())==="ws:"&&(s="http:"),e.agent.protocol=s,this.privWebsocketClient=new ws_1.default(this.privUri,e)}this.privWebsocketClient.binaryType="arraybuffer",this.privReceivingMessageQueue=new Exports_js_1$b.Queue,this.privDisconnectDeferral=new Exports_js_1$b.Deferred,this.privSendMessageQueue=new Exports_js_1$b.Queue,this.processSendQueue().catch(e=>{Exports_js_1$b.Events.instance.onEvent(new Exports_js_1$b.BackgroundEvent(e))})}catch(e){return this.privConnectionEstablishDeferral.resolve(new Exports_js_1$b.ConnectionOpenResponse(500,e)),this.privConnectionEstablishDeferral.promise}return this.onEvent(new Exports_js_1$b.ConnectionStartEvent(this.privConnectionId,this.privUri)),this.privWebsocketClient.onopen=()=>{this.privCertificateValidatedDeferral.promise.then(()=>{this.privConnectionState=Exports_js_1$b.ConnectionState.Connected,this.onEvent(new Exports_js_1$b.ConnectionEstablishedEvent(this.privConnectionId)),this.privConnectionEstablishDeferral.resolve(new Exports_js_1$b.ConnectionOpenResponse(200,""))},e=>{this.privConnectionEstablishDeferral.reject(e)})},this.privWebsocketClient.onerror=e=>{this.onEvent(new Exports_js_1$b.ConnectionErrorEvent(this.privConnectionId,e.message,e.type)),this.privLastErrorReceived=e.message},this.privWebsocketClient.onclose=e=>{this.privConnectionState===Exports_js_1$b.ConnectionState.Connecting?(this.privConnectionState=Exports_js_1$b.ConnectionState.Disconnected,this.privConnectionEstablishDeferral.resolve(new Exports_js_1$b.ConnectionOpenResponse(e.code,e.reason+" "+this.privLastErrorReceived))):(this.privConnectionState=Exports_js_1$b.ConnectionState.Disconnected,this.privWebsocketClient=null,this.onEvent(new Exports_js_1$b.ConnectionClosedEvent(this.privConnectionId,e.code,e.reason))),this.onClose(e.code,e.reason).catch(t=>{Exports_js_1$b.Events.instance.onEvent(new Exports_js_1$b.BackgroundEvent(t))})},this.privWebsocketClient.onmessage=e=>{const t=new Date().toISOString();if(this.privConnectionState===Exports_js_1$b.ConnectionState.Connected){const s=new Exports_js_1$b.Deferred;if(this.privReceivingMessageQueue.enqueueFromPromise(s.promise),e.data instanceof ArrayBuffer){const o=new Exports_js_1$b.RawWebsocketMessage(Exports_js_1$b.MessageType.Binary,e.data);this.privMessageFormatter.toConnectionMessage(o).then(a=>{this.onEvent(new Exports_js_1$b.ConnectionMessageReceivedEvent(this.privConnectionId,t,a)),s.resolve(a)},a=>{s.reject(`Invalid binary message format. Error: ${a}`)})}else{const o=new Exports_js_1$b.RawWebsocketMessage(Exports_js_1$b.MessageType.Text,e.data);this.privMessageFormatter.toConnectionMessage(o).then(a=>{this.onEvent(new Exports_js_1$b.ConnectionMessageReceivedEvent(this.privConnectionId,t,a)),s.resolve(a)},a=>{s.reject(`Invalid text message format. Error: ${a}`)})}}},this.privConnectionEstablishDeferral.promise}send(e){if(this.privConnectionState!==Exports_js_1$b.ConnectionState.Connected)return Promise.reject(`Cannot send on connection that is in ${Exports_js_1$b.ConnectionState[this.privConnectionState]} state`);const t=new Exports_js_1$b.Deferred,s=new Exports_js_1$b.Deferred;return this.privSendMessageQueue.enqueueFromPromise(s.promise),this.privMessageFormatter.fromConnectionMessage(e).then(o=>{s.resolve({Message:e,RawWebsocketMessage:o,sendStatusDeferral:t})},o=>{s.reject(`Error formatting the message. ${o}`)}),t.promise}read(){return this.privConnectionState!==Exports_js_1$b.ConnectionState.Connected?Promise.reject(`Cannot read on connection that is in ${this.privConnectionState} state`):this.privReceivingMessageQueue.dequeue()}close(e){if(this.privWebsocketClient)this.privConnectionState!==Exports_js_1$b.ConnectionState.Disconnected&&this.privWebsocketClient.close(1e3,e||"Normal closure by client");else return Promise.resolve();return this.privDisconnectDeferral.promise}get events(){return this.privConnectionEvents}sendRawMessage(e){try{if(!e)return Promise.resolve();if(this.onEvent(new Exports_js_1$b.ConnectionMessageSentEvent(this.privConnectionId,new Date().toISOString(),e.Message)),this.isWebsocketOpen)this.privWebsocketClient.send(e.RawWebsocketMessage.payload);else return Promise.reject("websocket send error: Websocket not ready "+this.privConnectionId+" "+e.Message.id+" "+new Error().stack);return Promise.resolve()}catch(t){return Promise.reject(`websocket send error: ${t}`)}}async onClose(e,t){const s=`Connection closed. ${e}: ${t}`;this.privConnectionState=Exports_js_1$b.ConnectionState.Disconnected,this.privDisconnectDeferral.resolve(),await this.privReceivingMessageQueue.drainAndDispose(()=>{},s),await this.privSendMessageQueue.drainAndDispose(o=>{o.sendStatusDeferral.reject(s)},s)}async processSendQueue(){for(;;){const t=await this.privSendMessageQueue.dequeue();if(!t)return;try{await this.sendRawMessage(t),t.sendStatusDeferral.resolve()}catch(s){t.sendStatusDeferral.reject(s)}}}onEvent(e){this.privConnectionEvents.onEvent(e),Exports_js_1$b.Events.instance.onEvent(e)}getAgent(){const e=new agent_base_1.default.Agent(this.createConnection);return this.proxyInfo!==void 0&&this.proxyInfo.HostName!==void 0&&this.proxyInfo.Port>0&&(e.proxyInfo=this.proxyInfo),e}static GetProxyAgent(e){const t={host:e.HostName,port:e.Port};return e.UserName?t.headers={"Proxy-Authentication":"Basic "+new Buffer(`${e.UserName}:${e.Password===void 0?"":e.Password}`).toString("base64")}:t.headers={},t.headers.requestOCSP="true",new https_proxy_agent_1.default(t)}createConnection(e,t){let s;if(t={...t,requestOCSP:!0,servername:t.host},this.proxyInfo){const a=WebsocketMessageAdapter.GetProxyAgent(this.proxyInfo);s=new Promise((c,u)=>{a.callback(e,t,(d,p)=>{d?u(d):c(p)})})}else t.secureEndpoint?s=Promise.resolve(tls.connect(t)):s=Promise.resolve(net.connect(t));return s}get isWebsocketOpen(){return this.privWebsocketClient&&this.privWebsocketClient.readyState===this.privWebsocketClient.OPEN}}WebsocketMessageAdapter$1.WebsocketMessageAdapter=WebsocketMessageAdapter;WebsocketMessageAdapter.forceNpmWebSocket=!1;Object.defineProperty(WebsocketConnection$1,"__esModule",{value:!0});WebsocketConnection$1.WebsocketConnection=void 0;const Exports_js_1$a=requireExports$5(),WebsocketMessageAdapter_js_1=WebsocketMessageAdapter$1;class WebsocketConnection{constructor(e,t,s,o,a,c=!1,u){if(this.privIsDisposed=!1,!e)throw new Exports_js_1$a.ArgumentNullError("uri");if(!o)throw new Exports_js_1$a.ArgumentNullError("messageFormatter");this.privMessageFormatter=o;let d="",p=0;if(t){for(const v in t)if(v){d+=p===0&&e.indexOf("?")===-1?"?":"&";const g=encodeURIComponent(v);d+=g;let m=t[v];m&&(m=encodeURIComponent(m),d+=`=${m}`),p++}}if(s){for(const v in s)if(v){d+=p===0&&e.indexOf("?")===-1?"?":"&";const g=encodeURIComponent(s[v]);d+=`${v}=${g}`,p++}}this.privUri=e+d,this.privId=u||Exports_js_1$a.createNoDashGuid(),this.privConnectionMessageAdapter=new WebsocketMessageAdapter_js_1.WebsocketMessageAdapter(this.privUri,this.id,this.privMessageFormatter,a,s,c)}async dispose(){this.privIsDisposed=!0,this.privConnectionMessageAdapter&&await this.privConnectionMessageAdapter.close()}isDisposed(){return this.privIsDisposed}get id(){return this.privId}get uri(){return this.privUri}state(){return this.privConnectionMessageAdapter.state}open(){return this.privConnectionMessageAdapter.open()}send(e){return this.privConnectionMessageAdapter.send(e)}read(){return this.privConnectionMessageAdapter.read()}get events(){return this.privConnectionMessageAdapter.events}}WebsocketConnection$1.WebsocketConnection=WebsocketConnection;var ReplayableAudioNode$1={};Object.defineProperty(ReplayableAudioNode$1,"__esModule",{value:!0});ReplayableAudioNode$1.ReplayableAudioNode=void 0;class ReplayableAudioNode{constructor(e,t){this.privBuffers=[],this.privReplayOffset=0,this.privLastShrinkOffset=0,this.privBufferStartOffset=0,this.privBufferSerial=0,this.privBufferedBytes=0,this.privReplay=!1,this.privLastChunkAcquiredTime=0,this.privAudioNode=e,this.privBytesPerSecond=t}id(){return this.privAudioNode.id()}read(){if(this.privReplay&&this.privBuffers.length!==0){const e=this.privReplayOffset-this.privBufferStartOffset;let t=Math.round(e*this.privBytesPerSecond*1e-7);t%2!==0&&t++;let s=0;for(;s<this.privBuffers.length&&t>=this.privBuffers[s].chunk.buffer.byteLength;)t-=this.privBuffers[s++].chunk.buffer.byteLength;if(s<this.privBuffers.length){const o=this.privBuffers[s].chunk.buffer.slice(t);return this.privReplayOffset+=o.byteLength/this.privBytesPerSecond*1e7,s===this.privBuffers.length-1&&(this.privReplay=!1),Promise.resolve({buffer:o,isEnd:!1,timeReceived:this.privBuffers[s].chunk.timeReceived})}}return this.privAudioNode.read().then(e=>(e&&e.buffer&&(this.privBuffers.push(new BufferEntry(e,this.privBufferSerial++,this.privBufferedBytes)),this.privBufferedBytes+=e.buffer.byteLength),e))}detach(){return this.privBuffers=void 0,this.privAudioNode.detach()}replay(){this.privBuffers&&this.privBuffers.length!==0&&(this.privReplay=!0,this.privReplayOffset=this.privLastShrinkOffset)}shrinkBuffers(e){if(this.privBuffers===void 0||this.privBuffers.length===0)return;this.privLastShrinkOffset=e;const t=e-this.privBufferStartOffset;let s=Math.round(t*this.privBytesPerSecond*1e-7),o=0;for(;o<this.privBuffers.length&&s>=this.privBuffers[o].chunk.buffer.byteLength;)s-=this.privBuffers[o++].chunk.buffer.byteLength;this.privBufferStartOffset=Math.round(e-s/this.privBytesPerSecond*1e7),this.privBuffers=this.privBuffers.slice(o)}findTimeAtOffset(e){if(e<this.privBufferStartOffset||this.privBuffers===void 0)return 0;for(const t of this.privBuffers){const s=t.byteOffset/this.privBytesPerSecond*1e7,o=s+t.chunk.buffer.byteLength/this.privBytesPerSecond*1e7;if(e>=s&&e<=o)return t.chunk.timeReceived}return 0}}ReplayableAudioNode$1.ReplayableAudioNode=ReplayableAudioNode;class BufferEntry{constructor(e,t,s){this.chunk=e,this.serial=t,this.byteOffset=s}}var ProxyInfo={},Exports$3={},AudioConfig={},AudioFileWriter$1={},__createBinding=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(i,e,t,s){s===void 0&&(s=t),Object.defineProperty(i,s,{enumerable:!0,get:function(){return e[t]}})}:function(i,e,t,s){s===void 0&&(s=t),i[s]=e[t]}),__setModuleDefault=commonjsGlobal&&commonjsGlobal.__setModuleDefault||(Object.create?function(i,e){Object.defineProperty(i,"default",{enumerable:!0,value:e})}:function(i,e){i.default=e}),__importStar=commonjsGlobal&&commonjsGlobal.__importStar||function(i){if(i&&i.__esModule)return i;var e={};if(i!=null)for(var t in i)t!=="default"&&Object.hasOwnProperty.call(i,t)&&__createBinding(e,i,t);return __setModuleDefault(e,i),e};Object.defineProperty(AudioFileWriter$1,"__esModule",{value:!0});AudioFileWriter$1.AudioFileWriter=void 0;const fs=__importStar(require$$0),Contracts_js_1$6=Contracts$1;class AudioFileWriter{constructor(e){Contracts_js_1$6.Contracts.throwIfNullOrUndefined(fs.openSync,`
File System access not available, please use Push or PullAudioOutputStream`),this.privFd=fs.openSync(e,"w")}set format(e){Contracts_js_1$6.Contracts.throwIfNotUndefined(this.privAudioFormat,"format is already set"),this.privAudioFormat=e;let t=0;this.privAudioFormat.hasHeader&&(t=this.privAudioFormat.header.byteLength),this.privFd!==void 0&&(this.privWriteStream=fs.createWriteStream("",{fd:this.privFd,start:t,autoClose:!1}))}write(e){Contracts_js_1$6.Contracts.throwIfNullOrUndefined(this.privAudioFormat,"must set format before writing."),this.privWriteStream!==void 0&&this.privWriteStream.write(new Uint8Array(e.slice(0)))}close(){this.privFd!==void 0&&(this.privWriteStream.on("finish",()=>{this.privAudioFormat.hasHeader&&(this.privAudioFormat.updateHeader(this.privWriteStream.bytesWritten),fs.writeSync(this.privFd,new Int8Array(this.privAudioFormat.header),0,this.privAudioFormat.header.byteLength,0)),fs.closeSync(this.privFd),this.privFd=void 0}),this.privWriteStream.end())}id(){return this.privId}}AudioFileWriter$1.AudioFileWriter=AudioFileWriter;var AudioInputStream={},hasRequiredAudioInputStream;function requireAudioInputStream(){if(hasRequiredAudioInputStream)return AudioInputStream;hasRequiredAudioInputStream=1,Object.defineProperty(AudioInputStream,"__esModule",{value:!0}),AudioInputStream.PullAudioInputStreamImpl=AudioInputStream.PullAudioInputStream=AudioInputStream.PushAudioInputStreamImpl=AudioInputStream.PushAudioInputStream=AudioInputStream.AudioInputStream=void 0;const i=requireExports(),e=requireExports$5(),t=Guid,s=requireExports$3(),o=AudioStreamFormat;let a=class{constructor(){}static createPushStream(g){return c.create(g)}static createPullStream(g,m){return d.create(g,m)}};AudioInputStream.AudioInputStream=a;class c extends a{static create(g){return new u(g)}}AudioInputStream.PushAudioInputStream=c;class u extends c{constructor(g){super(),g===void 0?this.privFormat=o.AudioStreamFormatImpl.getDefaultInputFormat():this.privFormat=g,this.privEvents=new e.EventSource,this.privId=t.createNoDashGuid(),this.privStream=new e.ChunkedArrayBufferStream(this.privFormat.avgBytesPerSec/10)}get format(){return Promise.resolve(this.privFormat)}write(g){this.privStream.writeStreamChunk({buffer:g,isEnd:!1,timeReceived:Date.now()})}close(){this.privStream.close()}id(){return this.privId}turnOn(){this.onEvent(new e.AudioSourceInitializingEvent(this.privId)),this.onEvent(new e.AudioSourceReadyEvent(this.privId))}async attach(g){this.onEvent(new e.AudioStreamNodeAttachingEvent(this.privId,g)),await this.turnOn();const m=this.privStream;return this.onEvent(new e.AudioStreamNodeAttachedEvent(this.privId,g)),{detach:async()=>(this.onEvent(new e.AudioStreamNodeDetachedEvent(this.privId,g)),this.turnOff()),id:()=>g,read:()=>m.read()}}detach(g){this.onEvent(new e.AudioStreamNodeDetachedEvent(this.privId,g))}turnOff(){}get events(){return this.privEvents}get deviceInfo(){return Promise.resolve({bitspersample:this.privFormat.bitsPerSample,channelcount:this.privFormat.channels,connectivity:i.connectivity.Unknown,manufacturer:"Speech SDK",model:"PushStream",samplerate:this.privFormat.samplesPerSec,type:i.type.Stream})}onEvent(g){this.privEvents.onEvent(g),e.Events.instance.onEvent(g)}toBuffer(g){const m=Buffer.alloc(g.byteLength),S=new Uint8Array(g);for(let y=0;y<m.length;++y)m[y]=S[y];return m}}AudioInputStream.PushAudioInputStreamImpl=u;class d extends a{constructor(){super()}static create(g,m){return new p(g,m)}}AudioInputStream.PullAudioInputStream=d;class p extends d{constructor(g,m){super(),m===void 0?this.privFormat=s.AudioStreamFormat.getDefaultInputFormat():this.privFormat=m,this.privEvents=new e.EventSource,this.privId=t.createNoDashGuid(),this.privCallback=g,this.privIsClosed=!1,this.privBufferSize=this.privFormat.avgBytesPerSec/10}get format(){return Promise.resolve(this.privFormat)}close(){this.privIsClosed=!0,this.privCallback.close()}id(){return this.privId}turnOn(){this.onEvent(new e.AudioSourceInitializingEvent(this.privId)),this.onEvent(new e.AudioSourceReadyEvent(this.privId))}async attach(g){return this.onEvent(new e.AudioStreamNodeAttachingEvent(this.privId,g)),await this.turnOn(),this.onEvent(new e.AudioStreamNodeAttachedEvent(this.privId,g)),{detach:()=>(this.privCallback.close(),this.onEvent(new e.AudioStreamNodeDetachedEvent(this.privId,g)),this.turnOff()),id:()=>g,read:()=>{let m=0,S;for(;m<this.privBufferSize;){const y=new ArrayBuffer(this.privBufferSize-m),C=this.privCallback.read(y);if(S===void 0?S=y:new Int8Array(S).set(new Int8Array(y),m),C===0)break;m+=C}return Promise.resolve({buffer:S.slice(0,m),isEnd:this.privIsClosed||m===0,timeReceived:Date.now()})}}}detach(g){this.onEvent(new e.AudioStreamNodeDetachedEvent(this.privId,g))}turnOff(){}get events(){return this.privEvents}get deviceInfo(){return Promise.resolve({bitspersample:this.privFormat.bitsPerSample,channelcount:this.privFormat.channels,connectivity:i.connectivity.Unknown,manufacturer:"Speech SDK",model:"PullStream",samplerate:this.privFormat.samplesPerSec,type:i.type.Stream})}onEvent(g){this.privEvents.onEvent(g),e.Events.instance.onEvent(g)}}return AudioInputStream.PullAudioInputStreamImpl=p,AudioInputStream}var AudioOutputStream$1={},AudioOutputFormat={},SpeechSynthesisOutputFormat={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.SpeechSynthesisOutputFormat=void 0,function(e){e[e.Raw8Khz8BitMonoMULaw=0]="Raw8Khz8BitMonoMULaw",e[e.Riff16Khz16KbpsMonoSiren=1]="Riff16Khz16KbpsMonoSiren",e[e.Audio16Khz16KbpsMonoSiren=2]="Audio16Khz16KbpsMonoSiren",e[e.Audio16Khz32KBitRateMonoMp3=3]="Audio16Khz32KBitRateMonoMp3",e[e.Audio16Khz128KBitRateMonoMp3=4]="Audio16Khz128KBitRateMonoMp3",e[e.Audio16Khz64KBitRateMonoMp3=5]="Audio16Khz64KBitRateMonoMp3",e[e.Audio24Khz48KBitRateMonoMp3=6]="Audio24Khz48KBitRateMonoMp3",e[e.Audio24Khz96KBitRateMonoMp3=7]="Audio24Khz96KBitRateMonoMp3",e[e.Audio24Khz160KBitRateMonoMp3=8]="Audio24Khz160KBitRateMonoMp3",e[e.Raw16Khz16BitMonoTrueSilk=9]="Raw16Khz16BitMonoTrueSilk",e[e.Riff16Khz16BitMonoPcm=10]="Riff16Khz16BitMonoPcm",e[e.Riff8Khz16BitMonoPcm=11]="Riff8Khz16BitMonoPcm",e[e.Riff24Khz16BitMonoPcm=12]="Riff24Khz16BitMonoPcm",e[e.Riff8Khz8BitMonoMULaw=13]="Riff8Khz8BitMonoMULaw",e[e.Raw16Khz16BitMonoPcm=14]="Raw16Khz16BitMonoPcm",e[e.Raw24Khz16BitMonoPcm=15]="Raw24Khz16BitMonoPcm",e[e.Raw8Khz16BitMonoPcm=16]="Raw8Khz16BitMonoPcm",e[e.Ogg16Khz16BitMonoOpus=17]="Ogg16Khz16BitMonoOpus",e[e.Ogg24Khz16BitMonoOpus=18]="Ogg24Khz16BitMonoOpus",e[e.Raw48Khz16BitMonoPcm=19]="Raw48Khz16BitMonoPcm",e[e.Riff48Khz16BitMonoPcm=20]="Riff48Khz16BitMonoPcm",e[e.Audio48Khz96KBitRateMonoMp3=21]="Audio48Khz96KBitRateMonoMp3",e[e.Audio48Khz192KBitRateMonoMp3=22]="Audio48Khz192KBitRateMonoMp3",e[e.Ogg48Khz16BitMonoOpus=23]="Ogg48Khz16BitMonoOpus",e[e.Webm16Khz16BitMonoOpus=24]="Webm16Khz16BitMonoOpus",e[e.Webm24Khz16BitMonoOpus=25]="Webm24Khz16BitMonoOpus",e[e.Raw24Khz16BitMonoTrueSilk=26]="Raw24Khz16BitMonoTrueSilk",e[e.Raw8Khz8BitMonoALaw=27]="Raw8Khz8BitMonoALaw",e[e.Riff8Khz8BitMonoALaw=28]="Riff8Khz8BitMonoALaw",e[e.Webm24Khz16Bit24KbpsMonoOpus=29]="Webm24Khz16Bit24KbpsMonoOpus",e[e.Audio16Khz16Bit32KbpsMonoOpus=30]="Audio16Khz16Bit32KbpsMonoOpus",e[e.Audio24Khz16Bit48KbpsMonoOpus=31]="Audio24Khz16Bit48KbpsMonoOpus",e[e.Audio24Khz16Bit24KbpsMonoOpus=32]="Audio24Khz16Bit24KbpsMonoOpus",e[e.Raw22050Hz16BitMonoPcm=33]="Raw22050Hz16BitMonoPcm",e[e.Riff22050Hz16BitMonoPcm=34]="Riff22050Hz16BitMonoPcm",e[e.Raw44100Hz16BitMonoPcm=35]="Raw44100Hz16BitMonoPcm",e[e.Riff44100Hz16BitMonoPcm=36]="Riff44100Hz16BitMonoPcm",e[e.AmrWb16000Hz=37]="AmrWb16000Hz",e[e.G72216Khz64Kbps=38]="G72216Khz64Kbps"}(i.SpeechSynthesisOutputFormat||(i.SpeechSynthesisOutputFormat={}))})(SpeechSynthesisOutputFormat);Object.defineProperty(AudioOutputFormat,"__esModule",{value:!0});AudioOutputFormat.AudioOutputFormatImpl=void 0;const SpeechSynthesisOutputFormat_js_1=SpeechSynthesisOutputFormat,AudioStreamFormat_js_1$1=AudioStreamFormat;class AudioOutputFormatImpl extends AudioStreamFormat_js_1$1.AudioStreamFormatImpl{constructor(e,t,s,o,a,c,u,d,p){super(s,c,t,e),this.formatTag=e,this.avgBytesPerSec=o,this.blockAlign=a,this.priAudioFormatString=u,this.priRequestAudioFormatString=d,this.priHasHeader=p}static fromSpeechSynthesisOutputFormat(e){return e===void 0?AudioOutputFormatImpl.getDefaultOutputFormat():AudioOutputFormatImpl.fromSpeechSynthesisOutputFormatString(AudioOutputFormatImpl.SpeechSynthesisOutputFormatToString[e])}static fromSpeechSynthesisOutputFormatString(e){switch(e){case"raw-8khz-8bit-mono-mulaw":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MuLaw,1,8e3,8e3,1,8,e,e,!1);case"riff-16khz-16kbps-mono-siren":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.Siren,1,16e3,2e3,40,0,e,"audio-16khz-16kbps-mono-siren",!0);case"audio-16khz-16kbps-mono-siren":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.Siren,1,16e3,2e3,40,0,e,e,!1);case"audio-16khz-32kbitrate-mono-mp3":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MP3,1,16e3,4096,2,16,e,e,!1);case"audio-16khz-128kbitrate-mono-mp3":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MP3,1,16e3,16384,2,16,e,e,!1);case"audio-16khz-64kbitrate-mono-mp3":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MP3,1,16e3,8192,2,16,e,e,!1);case"audio-24khz-48kbitrate-mono-mp3":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MP3,1,24e3,6144,2,16,e,e,!1);case"audio-24khz-96kbitrate-mono-mp3":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MP3,1,24e3,12288,2,16,e,e,!1);case"audio-24khz-160kbitrate-mono-mp3":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MP3,1,24e3,20480,2,16,e,e,!1);case"raw-16khz-16bit-mono-truesilk":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.SILKSkype,1,16e3,32e3,2,16,e,e,!1);case"riff-8khz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,8e3,16e3,2,16,e,"raw-8khz-16bit-mono-pcm",!0);case"riff-24khz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,24e3,48e3,2,16,e,"raw-24khz-16bit-mono-pcm",!0);case"riff-8khz-8bit-mono-mulaw":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MuLaw,1,8e3,8e3,1,8,e,"raw-8khz-8bit-mono-mulaw",!0);case"raw-16khz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,16e3,32e3,2,16,e,"raw-16khz-16bit-mono-pcm",!1);case"raw-24khz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,24e3,48e3,2,16,e,"raw-24khz-16bit-mono-pcm",!1);case"raw-8khz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,8e3,16e3,2,16,e,"raw-8khz-16bit-mono-pcm",!1);case"ogg-16khz-16bit-mono-opus":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.OGG_OPUS,1,16e3,8192,2,16,e,e,!1);case"ogg-24khz-16bit-mono-opus":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.OGG_OPUS,1,24e3,8192,2,16,e,e,!1);case"raw-48khz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,48e3,96e3,2,16,e,"raw-48khz-16bit-mono-pcm",!1);case"riff-48khz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,48e3,96e3,2,16,e,"raw-48khz-16bit-mono-pcm",!0);case"audio-48khz-96kbitrate-mono-mp3":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MP3,1,48e3,12288,2,16,e,e,!1);case"audio-48khz-192kbitrate-mono-mp3":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.MP3,1,48e3,24576,2,16,e,e,!1);case"ogg-48khz-16bit-mono-opus":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.OGG_OPUS,1,48e3,12e3,2,16,e,e,!1);case"webm-16khz-16bit-mono-opus":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.WEBM_OPUS,1,16e3,4e3,2,16,e,e,!1);case"webm-24khz-16bit-mono-opus":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.WEBM_OPUS,1,24e3,6e3,2,16,e,e,!1);case"webm-24khz-16bit-24kbps-mono-opus":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.WEBM_OPUS,1,24e3,3e3,2,16,e,e,!1);case"audio-16khz-16bit-32kbps-mono-opus":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.OPUS,1,16e3,4e3,2,16,e,e,!1);case"audio-24khz-16bit-48kbps-mono-opus":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.OPUS,1,24e3,6e3,2,16,e,e,!1);case"audio-24khz-16bit-24kbps-mono-opus":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.OPUS,1,24e3,3e3,2,16,e,e,!1);case"audio-24khz-16bit-mono-flac":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.FLAC,1,24e3,24e3,2,16,e,e,!1);case"audio-48khz-16bit-mono-flac":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.FLAC,1,48e3,3e4,2,16,e,e,!1);case"raw-24khz-16bit-mono-truesilk":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.SILKSkype,1,24e3,48e3,2,16,e,e,!1);case"raw-8khz-8bit-mono-alaw":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.ALaw,1,8e3,8e3,1,8,e,e,!1);case"riff-8khz-8bit-mono-alaw":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.ALaw,1,8e3,8e3,1,8,e,"raw-8khz-8bit-mono-alaw",!0);case"raw-22050hz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,22050,44100,2,16,e,e,!1);case"riff-22050hz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,22050,44100,2,16,e,"raw-22050hz-16bit-mono-pcm",!0);case"raw-44100hz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,44100,88200,2,16,e,e,!1);case"riff-44100hz-16bit-mono-pcm":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,44100,88200,2,16,e,"raw-44100hz-16bit-mono-pcm",!0);case"amr-wb-16000h":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.AMR_WB,1,16e3,3052,2,16,e,e,!1);case"g722-16khz-64kbps":return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.G722,1,16e3,8e3,2,16,e,e,!1);case"riff-16khz-16bit-mono-pcm":default:return new AudioOutputFormatImpl(AudioStreamFormat_js_1$1.AudioFormatTag.PCM,1,16e3,32e3,2,16,"riff-16khz-16bit-mono-pcm","raw-16khz-16bit-mono-pcm",!0)}}static getDefaultOutputFormat(){return AudioOutputFormatImpl.fromSpeechSynthesisOutputFormatString(typeof window<"u"?"audio-24khz-48kbitrate-mono-mp3":"riff-16khz-16bit-mono-pcm")}get hasHeader(){return this.priHasHeader}get header(){if(this.hasHeader)return this.privHeader}updateHeader(e){if(this.priHasHeader){const t=new DataView(this.privHeader);t.setUint32(4,e+this.privHeader.byteLength-8,!0),t.setUint32(40,e,!0)}}get requestAudioFormatString(){return this.priRequestAudioFormatString}addHeader(e){if(!this.hasHeader)return e;this.updateHeader(e.byteLength);const t=new Uint8Array(e.byteLength+this.header.byteLength);return t.set(new Uint8Array(this.header),0),t.set(new Uint8Array(e),this.header.byteLength),t.buffer}}AudioOutputFormat.AudioOutputFormatImpl=AudioOutputFormatImpl;AudioOutputFormatImpl.SpeechSynthesisOutputFormatToString={[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw8Khz8BitMonoMULaw]:"raw-8khz-8bit-mono-mulaw",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Riff16Khz16KbpsMonoSiren]:"riff-16khz-16kbps-mono-siren",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio16Khz16KbpsMonoSiren]:"audio-16khz-16kbps-mono-siren",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio16Khz32KBitRateMonoMp3]:"audio-16khz-32kbitrate-mono-mp3",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio16Khz128KBitRateMonoMp3]:"audio-16khz-128kbitrate-mono-mp3",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio16Khz64KBitRateMonoMp3]:"audio-16khz-64kbitrate-mono-mp3",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio24Khz48KBitRateMonoMp3]:"audio-24khz-48kbitrate-mono-mp3",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio24Khz96KBitRateMonoMp3]:"audio-24khz-96kbitrate-mono-mp3",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio24Khz160KBitRateMonoMp3]:"audio-24khz-160kbitrate-mono-mp3",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw16Khz16BitMonoTrueSilk]:"raw-16khz-16bit-mono-truesilk",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Riff16Khz16BitMonoPcm]:"riff-16khz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Riff8Khz16BitMonoPcm]:"riff-8khz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Riff24Khz16BitMonoPcm]:"riff-24khz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Riff8Khz8BitMonoMULaw]:"riff-8khz-8bit-mono-mulaw",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw16Khz16BitMonoPcm]:"raw-16khz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw24Khz16BitMonoPcm]:"raw-24khz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw8Khz16BitMonoPcm]:"raw-8khz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Ogg16Khz16BitMonoOpus]:"ogg-16khz-16bit-mono-opus",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Ogg24Khz16BitMonoOpus]:"ogg-24khz-16bit-mono-opus",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw48Khz16BitMonoPcm]:"raw-48khz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Riff48Khz16BitMonoPcm]:"riff-48khz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio48Khz96KBitRateMonoMp3]:"audio-48khz-96kbitrate-mono-mp3",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio48Khz192KBitRateMonoMp3]:"audio-48khz-192kbitrate-mono-mp3",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Ogg48Khz16BitMonoOpus]:"ogg-48khz-16bit-mono-opus",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Webm16Khz16BitMonoOpus]:"webm-16khz-16bit-mono-opus",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Webm24Khz16BitMonoOpus]:"webm-24khz-16bit-mono-opus",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Webm24Khz16Bit24KbpsMonoOpus]:"webm-24khz-16bit-24kbps-mono-opus",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw24Khz16BitMonoTrueSilk]:"raw-24khz-16bit-mono-truesilk",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw8Khz8BitMonoALaw]:"raw-8khz-8bit-mono-alaw",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Riff8Khz8BitMonoALaw]:"riff-8khz-8bit-mono-alaw",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio16Khz16Bit32KbpsMonoOpus]:"audio-16khz-16bit-32kbps-mono-opus",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio24Khz16Bit48KbpsMonoOpus]:"audio-24khz-16bit-48kbps-mono-opus",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Audio24Khz16Bit24KbpsMonoOpus]:"audio-24khz-16bit-24kbps-mono-opus",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw22050Hz16BitMonoPcm]:"raw-22050hz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Riff22050Hz16BitMonoPcm]:"riff-22050hz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Raw44100Hz16BitMonoPcm]:"raw-44100hz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.Riff44100Hz16BitMonoPcm]:"riff-44100hz-16bit-mono-pcm",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.AmrWb16000Hz]:"amr-wb-16000hz",[SpeechSynthesisOutputFormat_js_1.SpeechSynthesisOutputFormat.G72216Khz64Kbps]:"g722-16khz-64kbps"};Object.defineProperty(AudioOutputStream$1,"__esModule",{value:!0});AudioOutputStream$1.PushAudioOutputStreamImpl=AudioOutputStream$1.PushAudioOutputStream=AudioOutputStream$1.PullAudioOutputStreamImpl=AudioOutputStream$1.PullAudioOutputStream=AudioOutputStream$1.AudioOutputStream=void 0;const Exports_js_1$9=requireExports$5(),Contracts_js_1$5=Contracts$1,AudioOutputFormat_js_1$1=AudioOutputFormat;class AudioOutputStream{constructor(){}static createPullStream(){return PullAudioOutputStream.create()}}AudioOutputStream$1.AudioOutputStream=AudioOutputStream;class PullAudioOutputStream extends AudioOutputStream{static create(){return new PullAudioOutputStreamImpl}}AudioOutputStream$1.PullAudioOutputStream=PullAudioOutputStream;class PullAudioOutputStreamImpl extends PullAudioOutputStream{constructor(){super(),this.privId=Exports_js_1$9.createNoDashGuid(),this.privStream=new Exports_js_1$9.Stream}set format(e){e==null&&(this.privFormat=AudioOutputFormat_js_1$1.AudioOutputFormatImpl.getDefaultOutputFormat()),this.privFormat=e}get format(){return this.privFormat}get isClosed(){return this.privStream.isClosed}id(){return this.privId}async read(e){const t=new Int8Array(e);let s=0;if(this.privLastChunkView!==void 0){if(this.privLastChunkView.length>e.byteLength)return t.set(this.privLastChunkView.slice(0,e.byteLength)),this.privLastChunkView=this.privLastChunkView.slice(e.byteLength),Promise.resolve(e.byteLength);t.set(this.privLastChunkView),s=this.privLastChunkView.length,this.privLastChunkView=void 0}for(;s<e.byteLength&&!this.privStream.isReadEnded;){const o=await this.privStream.read();if(o!==void 0&&!o.isEnd){let a;o.buffer.byteLength>e.byteLength-s?(a=o.buffer.slice(0,e.byteLength-s),this.privLastChunkView=new Int8Array(o.buffer.slice(e.byteLength-s))):a=o.buffer,t.set(new Int8Array(a),s),s+=a.byteLength}else this.privStream.readEnded()}return s}write(e){Contracts_js_1$5.Contracts.throwIfNullOrUndefined(this.privStream,"must set format before writing"),this.privStream.writeStreamChunk({buffer:e,isEnd:!1,timeReceived:Date.now()})}close(){this.privStream.close()}}AudioOutputStream$1.PullAudioOutputStreamImpl=PullAudioOutputStreamImpl;class PushAudioOutputStream extends AudioOutputStream{constructor(){super()}static create(e){return new PushAudioOutputStreamImpl(e)}}AudioOutputStream$1.PushAudioOutputStream=PushAudioOutputStream;class PushAudioOutputStreamImpl extends PushAudioOutputStream{constructor(e){super(),this.privId=Exports_js_1$9.createNoDashGuid(),this.privCallback=e}set format(e){}write(e){this.privCallback.write&&this.privCallback.write(e)}close(){this.privCallback.close&&this.privCallback.close()}id(){return this.privId}}AudioOutputStream$1.PushAudioOutputStreamImpl=PushAudioOutputStreamImpl;var hasRequiredAudioConfig;function requireAudioConfig(){if(hasRequiredAudioConfig)return AudioConfig;hasRequiredAudioConfig=1,Object.defineProperty(AudioConfig,"__esModule",{value:!0}),AudioConfig.AudioOutputConfigImpl=AudioConfig.AudioConfigImpl=AudioConfig.AudioConfig=void 0;const i=requireExports$2(),e=Contracts$1,t=requireExports$3(),s=AudioFileWriter$1,o=requireAudioInputStream(),a=AudioOutputStream$1;let c=class Ce{static fromDefaultMicrophoneInput(){const v=new i.PcmRecorder(!0);return new u(new i.MicAudioSource(v))}static fromMicrophoneInput(v){const g=new i.PcmRecorder(!0);return new u(new i.MicAudioSource(g,v))}static fromWavFileInput(v,g="unnamedBuffer.wav"){return new u(new i.FileAudioSource(v,g))}static fromStreamInput(v){if(v instanceof t.PullAudioInputStreamCallback)return new u(new o.PullAudioInputStreamImpl(v));if(v instanceof t.AudioInputStream)return new u(v);if(typeof MediaStream<"u"&&v instanceof MediaStream){const g=new i.PcmRecorder(!1);return new u(new i.MicAudioSource(g,null,null,v))}throw new Error("Not Supported Type")}static fromDefaultSpeakerOutput(){return new d(new t.SpeakerAudioDestination)}static fromSpeakerOutput(v){if(v===void 0)return Ce.fromDefaultSpeakerOutput();if(v instanceof t.SpeakerAudioDestination)return new d(v);throw new Error("Not Supported Type")}static fromAudioFileOutput(v){return new d(new s.AudioFileWriter(v))}static fromStreamOutput(v){if(v instanceof t.PushAudioOutputStreamCallback)return new d(new a.PushAudioOutputStreamImpl(v));if(v instanceof t.PushAudioOutputStream)return new d(v);if(v instanceof t.PullAudioOutputStream)return new d(v);throw new Error("Not Supported Type")}};AudioConfig.AudioConfig=c;class u extends c{constructor(v){super(),this.privSource=v}get format(){return this.privSource.format}close(v,g){this.privSource.turnOff().then(()=>{v&&v()},m=>{g&&g(m)})}id(){return this.privSource.id()}turnOn(){return this.privSource.turnOn()}attach(v){return this.privSource.attach(v)}detach(v){return this.privSource.detach(v)}turnOff(){return this.privSource.turnOff()}get events(){return this.privSource.events}setProperty(v,g){if(e.Contracts.throwIfNull(g,"value"),this.privSource.setProperty!==void 0)this.privSource.setProperty(v,g);else throw new Error("This AudioConfig instance does not support setting properties.")}getProperty(v,g){if(this.privSource.getProperty!==void 0)return this.privSource.getProperty(v,g);throw new Error("This AudioConfig instance does not support getting properties.")}get deviceInfo(){return this.privSource.deviceInfo}}AudioConfig.AudioConfigImpl=u;class d extends c{constructor(v){super(),this.privDestination=v}set format(v){this.privDestination.format=v}write(v){this.privDestination.write(v)}close(){this.privDestination.close()}id(){return this.privDestination.id()}setProperty(){throw new Error("This AudioConfig instance does not support setting properties.")}getProperty(){throw new Error("This AudioConfig instance does not support getting properties.")}}return AudioConfig.AudioOutputConfigImpl=d,AudioConfig}var CancellationReason={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.CancellationReason=void 0,function(e){e[e.Error=0]="Error",e[e.EndOfStream=1]="EndOfStream"}(i.CancellationReason||(i.CancellationReason={}))})(CancellationReason);var PullAudioInputStreamCallback$1={};Object.defineProperty(PullAudioInputStreamCallback$1,"__esModule",{value:!0});PullAudioInputStreamCallback$1.PullAudioInputStreamCallback=void 0;class PullAudioInputStreamCallback{}PullAudioInputStreamCallback$1.PullAudioInputStreamCallback=PullAudioInputStreamCallback;var PushAudioOutputStreamCallback$1={};Object.defineProperty(PushAudioOutputStreamCallback$1,"__esModule",{value:!0});PushAudioOutputStreamCallback$1.PushAudioOutputStreamCallback=void 0;class PushAudioOutputStreamCallback{}PushAudioOutputStreamCallback$1.PushAudioOutputStreamCallback=PushAudioOutputStreamCallback;var KeywordRecognitionModel$1={};Object.defineProperty(KeywordRecognitionModel$1,"__esModule",{value:!0});KeywordRecognitionModel$1.KeywordRecognitionModel=void 0;const Contracts_js_1$4=Contracts$1;class KeywordRecognitionModel{constructor(){this.privDisposed=!1}static fromFile(e){throw Contracts_js_1$4.Contracts.throwIfFileDoesNotExist(e,"fileName"),new Error("Not yet implemented.")}static fromStream(e){throw Contracts_js_1$4.Contracts.throwIfNull(e,"file"),new Error("Not yet implemented.")}close(){this.privDisposed||(this.privDisposed=!0)}}KeywordRecognitionModel$1.KeywordRecognitionModel=KeywordRecognitionModel;var SessionEventArgs$1={};Object.defineProperty(SessionEventArgs$1,"__esModule",{value:!0});SessionEventArgs$1.SessionEventArgs=void 0;class SessionEventArgs{constructor(e){this.privSessionId=e}get sessionId(){return this.privSessionId}}SessionEventArgs$1.SessionEventArgs=SessionEventArgs;var RecognitionEventArgs={},hasRequiredRecognitionEventArgs;function requireRecognitionEventArgs(){if(hasRequiredRecognitionEventArgs)return RecognitionEventArgs;hasRequiredRecognitionEventArgs=1,Object.defineProperty(RecognitionEventArgs,"__esModule",{value:!0}),RecognitionEventArgs.RecognitionEventArgs=void 0;const i=requireExports$3();let e=class extends i.SessionEventArgs{constructor(s,o){super(o),this.privOffset=s}get offset(){return this.privOffset}};return RecognitionEventArgs.RecognitionEventArgs=e,RecognitionEventArgs}var OutputFormat={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.OutputFormat=void 0,function(e){e[e.Simple=0]="Simple",e[e.Detailed=1]="Detailed"}(i.OutputFormat||(i.OutputFormat={}))})(OutputFormat);var IntentRecognitionEventArgs={},hasRequiredIntentRecognitionEventArgs;function requireIntentRecognitionEventArgs(){if(hasRequiredIntentRecognitionEventArgs)return IntentRecognitionEventArgs;hasRequiredIntentRecognitionEventArgs=1,Object.defineProperty(IntentRecognitionEventArgs,"__esModule",{value:!0}),IntentRecognitionEventArgs.IntentRecognitionEventArgs=void 0;const i=requireExports$3();let e=class extends i.RecognitionEventArgs{constructor(s,o,a){super(o,a),this.privResult=s}get result(){return this.privResult}};return IntentRecognitionEventArgs.IntentRecognitionEventArgs=e,IntentRecognitionEventArgs}var RecognitionResult$1={};Object.defineProperty(RecognitionResult$1,"__esModule",{value:!0});RecognitionResult$1.RecognitionResult=void 0;class RecognitionResult{constructor(e,t,s,o,a,c,u,d,p,v){this.privResultId=e,this.privReason=t,this.privText=s,this.privDuration=o,this.privOffset=a,this.privLanguage=c,this.privLanguageDetectionConfidence=u,this.privErrorDetails=d,this.privJson=p,this.privProperties=v}get resultId(){return this.privResultId}get reason(){return this.privReason}get text(){return this.privText}get duration(){return this.privDuration}get offset(){return this.privOffset}get language(){return this.privLanguage}get languageDetectionConfidence(){return this.privLanguageDetectionConfidence}get errorDetails(){return this.privErrorDetails}get json(){return this.privJson}get properties(){return this.privProperties}}RecognitionResult$1.RecognitionResult=RecognitionResult;var SpeechRecognitionResult={},hasRequiredSpeechRecognitionResult;function requireSpeechRecognitionResult(){if(hasRequiredSpeechRecognitionResult)return SpeechRecognitionResult;hasRequiredSpeechRecognitionResult=1,Object.defineProperty(SpeechRecognitionResult,"__esModule",{value:!0}),SpeechRecognitionResult.SpeechRecognitionResult=void 0;const i=requireExports$3();let e=class extends i.RecognitionResult{constructor(s,o,a,c,u,d,p,v,g,m,S){super(s,o,a,c,u,d,p,g,m,S),this.privSpeakerId=v}get speakerId(){return this.privSpeakerId}};return SpeechRecognitionResult.SpeechRecognitionResult=e,SpeechRecognitionResult}var IntentRecognitionResult={},hasRequiredIntentRecognitionResult;function requireIntentRecognitionResult(){if(hasRequiredIntentRecognitionResult)return IntentRecognitionResult;hasRequiredIntentRecognitionResult=1,Object.defineProperty(IntentRecognitionResult,"__esModule",{value:!0}),IntentRecognitionResult.IntentRecognitionResult=void 0;const i=requireExports$3();let e=class extends i.SpeechRecognitionResult{constructor(s,o,a,c,u,d,p,v,g,m,S){super(o,a,c,u,d,p,v,void 0,g,m,S),this.privIntentId=s}get intentId(){return this.privIntentId}};return IntentRecognitionResult.IntentRecognitionResult=e,IntentRecognitionResult}var LanguageUnderstandingModel$1={};Object.defineProperty(LanguageUnderstandingModel$1,"__esModule",{value:!0});LanguageUnderstandingModel$1.LanguageUnderstandingModelImpl=LanguageUnderstandingModel$1.LanguageUnderstandingModel=void 0;const Contracts_js_1$3=Contracts$1;class LanguageUnderstandingModel{constructor(){}static fromEndpoint(e){Contracts_js_1$3.Contracts.throwIfNull(e,"uri"),Contracts_js_1$3.Contracts.throwIfNullOrWhitespace(e.hostname,"uri");const t=new LanguageUnderstandingModelImpl,s=e.host.indexOf(".");if(s===-1)throw new Error("Could not determine region from endpoint");t.region=e.host.substr(0,s);const o=e.pathname.lastIndexOf("/")+1;if(o===-1)throw new Error("Could not determine appId from endpoint");if(t.appId=e.pathname.substr(o),t.subscriptionKey=e.searchParams.get("subscription-key"),t.subscriptionKey===void 0)throw new Error("Could not determine subscription key from endpoint");return t}static fromAppId(e){Contracts_js_1$3.Contracts.throwIfNullOrWhitespace(e,"appId");const t=new LanguageUnderstandingModelImpl;return t.appId=e,t}static fromSubscription(e,t,s){Contracts_js_1$3.Contracts.throwIfNullOrWhitespace(e,"subscriptionKey"),Contracts_js_1$3.Contracts.throwIfNullOrWhitespace(t,"appId"),Contracts_js_1$3.Contracts.throwIfNullOrWhitespace(s,"region");const o=new LanguageUnderstandingModelImpl;return o.appId=t,o.region=s,o.subscriptionKey=e,o}}LanguageUnderstandingModel$1.LanguageUnderstandingModel=LanguageUnderstandingModel;class LanguageUnderstandingModelImpl extends LanguageUnderstandingModel{}LanguageUnderstandingModel$1.LanguageUnderstandingModelImpl=LanguageUnderstandingModelImpl;var SpeechRecognitionEventArgs={},hasRequiredSpeechRecognitionEventArgs;function requireSpeechRecognitionEventArgs(){if(hasRequiredSpeechRecognitionEventArgs)return SpeechRecognitionEventArgs;hasRequiredSpeechRecognitionEventArgs=1,Object.defineProperty(SpeechRecognitionEventArgs,"__esModule",{value:!0}),SpeechRecognitionEventArgs.MeetingTranscriptionEventArgs=SpeechRecognitionEventArgs.ConversationTranscriptionEventArgs=SpeechRecognitionEventArgs.SpeechRecognitionEventArgs=void 0;const i=requireExports$3();let e=class extends i.RecognitionEventArgs{constructor(a,c,u){super(c,u),this.privResult=a}get result(){return this.privResult}};SpeechRecognitionEventArgs.SpeechRecognitionEventArgs=e;class t extends i.RecognitionEventArgs{constructor(a,c,u){super(c,u),this.privResult=a}get result(){return this.privResult}}SpeechRecognitionEventArgs.ConversationTranscriptionEventArgs=t;class s extends e{}return SpeechRecognitionEventArgs.MeetingTranscriptionEventArgs=s,SpeechRecognitionEventArgs}var SpeechRecognitionCanceledEventArgs={},CancellationEventArgsBase={},hasRequiredCancellationEventArgsBase;function requireCancellationEventArgsBase(){if(hasRequiredCancellationEventArgsBase)return CancellationEventArgsBase;hasRequiredCancellationEventArgsBase=1,Object.defineProperty(CancellationEventArgsBase,"__esModule",{value:!0}),CancellationEventArgsBase.CancellationEventArgsBase=void 0;const i=requireExports$3();let e=class extends i.RecognitionEventArgs{constructor(s,o,a,c,u){super(c,u),this.privReason=s,this.privErrorDetails=o,this.privErrorCode=a}get reason(){return this.privReason}get errorCode(){return this.privErrorCode}get errorDetails(){return this.privErrorDetails}};return CancellationEventArgsBase.CancellationEventArgsBase=e,CancellationEventArgsBase}var hasRequiredSpeechRecognitionCanceledEventArgs;function requireSpeechRecognitionCanceledEventArgs(){if(hasRequiredSpeechRecognitionCanceledEventArgs)return SpeechRecognitionCanceledEventArgs;hasRequiredSpeechRecognitionCanceledEventArgs=1,Object.defineProperty(SpeechRecognitionCanceledEventArgs,"__esModule",{value:!0}),SpeechRecognitionCanceledEventArgs.SpeechRecognitionCanceledEventArgs=void 0;const i=requireCancellationEventArgsBase();let e=class extends i.CancellationEventArgsBase{};return SpeechRecognitionCanceledEventArgs.SpeechRecognitionCanceledEventArgs=e,SpeechRecognitionCanceledEventArgs}var TranslationRecognitionEventArgs={},hasRequiredTranslationRecognitionEventArgs;function requireTranslationRecognitionEventArgs(){if(hasRequiredTranslationRecognitionEventArgs)return TranslationRecognitionEventArgs;hasRequiredTranslationRecognitionEventArgs=1,Object.defineProperty(TranslationRecognitionEventArgs,"__esModule",{value:!0}),TranslationRecognitionEventArgs.TranslationRecognitionEventArgs=void 0;const i=requireExports$3();let e=class extends i.RecognitionEventArgs{constructor(s,o,a){super(o,a),this.privResult=s}get result(){return this.privResult}};return TranslationRecognitionEventArgs.TranslationRecognitionEventArgs=e,TranslationRecognitionEventArgs}var TranslationSynthesisEventArgs={},hasRequiredTranslationSynthesisEventArgs;function requireTranslationSynthesisEventArgs(){if(hasRequiredTranslationSynthesisEventArgs)return TranslationSynthesisEventArgs;hasRequiredTranslationSynthesisEventArgs=1,Object.defineProperty(TranslationSynthesisEventArgs,"__esModule",{value:!0}),TranslationSynthesisEventArgs.TranslationSynthesisEventArgs=void 0;const i=requireExports$3();let e=class extends i.SessionEventArgs{constructor(s,o){super(o),this.privResult=s}get result(){return this.privResult}};return TranslationSynthesisEventArgs.TranslationSynthesisEventArgs=e,TranslationSynthesisEventArgs}var TranslationRecognitionResult={},hasRequiredTranslationRecognitionResult;function requireTranslationRecognitionResult(){if(hasRequiredTranslationRecognitionResult)return TranslationRecognitionResult;hasRequiredTranslationRecognitionResult=1,Object.defineProperty(TranslationRecognitionResult,"__esModule",{value:!0}),TranslationRecognitionResult.TranslationRecognitionResult=void 0;const i=requireExports$3();let e=class Re extends i.SpeechRecognitionResult{constructor(s,o,a,c,u,d,p,v,g,m,S){super(o,a,c,u,d,p,v,void 0,g,m,S),this.privTranslations=s}static fromSpeechRecognitionResult(s){return new Re(void 0,s.resultId,s.reason,s.text,s.duration,s.offset,s.language,s.languageDetectionConfidence,s.errorDetails,s.json,s.properties)}get translations(){return this.privTranslations}};return TranslationRecognitionResult.TranslationRecognitionResult=e,TranslationRecognitionResult}var TranslationSynthesisResult$1={};Object.defineProperty(TranslationSynthesisResult$1,"__esModule",{value:!0});TranslationSynthesisResult$1.TranslationSynthesisResult=void 0;class TranslationSynthesisResult{constructor(e,t){this.privReason=e,this.privAudio=t}get audio(){return this.privAudio}get reason(){return this.privReason}}TranslationSynthesisResult$1.TranslationSynthesisResult=TranslationSynthesisResult;var ResultReason={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.ResultReason=void 0,function(e){e[e.NoMatch=0]="NoMatch",e[e.Canceled=1]="Canceled",e[e.RecognizingSpeech=2]="RecognizingSpeech",e[e.RecognizedSpeech=3]="RecognizedSpeech",e[e.RecognizedKeyword=4]="RecognizedKeyword",e[e.RecognizingIntent=5]="RecognizingIntent",e[e.RecognizedIntent=6]="RecognizedIntent",e[e.TranslatingSpeech=7]="TranslatingSpeech",e[e.TranslatedSpeech=8]="TranslatedSpeech",e[e.SynthesizingAudio=9]="SynthesizingAudio",e[e.SynthesizingAudioCompleted=10]="SynthesizingAudioCompleted",e[e.SynthesizingAudioStarted=11]="SynthesizingAudioStarted",e[e.EnrollingVoiceProfile=12]="EnrollingVoiceProfile",e[e.EnrolledVoiceProfile=13]="EnrolledVoiceProfile",e[e.RecognizedSpeakers=14]="RecognizedSpeakers",e[e.RecognizedSpeaker=15]="RecognizedSpeaker",e[e.ResetVoiceProfile=16]="ResetVoiceProfile",e[e.DeletedVoiceProfile=17]="DeletedVoiceProfile",e[e.VoicesListRetrieved=18]="VoicesListRetrieved",e[e.TranslatingParticipantSpeech=19]="TranslatingParticipantSpeech",e[e.TranslatedParticipantSpeech=20]="TranslatedParticipantSpeech",e[e.TranslatedInstantMessage=21]="TranslatedInstantMessage",e[e.TranslatedParticipantInstantMessage=22]="TranslatedParticipantInstantMessage"}(i.ResultReason||(i.ResultReason={}))})(ResultReason);var SpeechConfig={},hasRequiredSpeechConfig;function requireSpeechConfig(){if(hasRequiredSpeechConfig)return SpeechConfig;hasRequiredSpeechConfig=1,Object.defineProperty(SpeechConfig,"__esModule",{value:!0}),SpeechConfig.SpeechConfigImpl=SpeechConfig.SpeechConfig=void 0;const i=requireExports(),e=Contracts$1,t=requireExports$3();let s=class{constructor(){}static fromSubscription(c,u){e.Contracts.throwIfNullOrWhitespace(c,"subscriptionKey"),e.Contracts.throwIfNullOrWhitespace(u,"region");const d=new o;return d.setProperty(t.PropertyId.SpeechServiceConnection_Region,u),d.setProperty(t.PropertyId.SpeechServiceConnection_IntentRegion,u),d.setProperty(t.PropertyId.SpeechServiceConnection_Key,c),d}static fromEndpoint(c,u){e.Contracts.throwIfNull(c,"endpoint");const d=new o;return d.setProperty(t.PropertyId.SpeechServiceConnection_Endpoint,c.href),u!==void 0&&d.setProperty(t.PropertyId.SpeechServiceConnection_Key,u),d}static fromHost(c,u){e.Contracts.throwIfNull(c,"hostName");const d=new o;return d.setProperty(t.PropertyId.SpeechServiceConnection_Host,c.protocol+"//"+c.hostname+(c.port===""?"":":"+c.port)),u!==void 0&&d.setProperty(t.PropertyId.SpeechServiceConnection_Key,u),d}static fromAuthorizationToken(c,u){e.Contracts.throwIfNull(c,"authorizationToken"),e.Contracts.throwIfNullOrWhitespace(u,"region");const d=new o;return d.setProperty(t.PropertyId.SpeechServiceConnection_Region,u),d.setProperty(t.PropertyId.SpeechServiceConnection_IntentRegion,u),d.authorizationToken=c,d}close(){}};SpeechConfig.SpeechConfig=s;class o extends s{constructor(){super(),this.privProperties=new t.PropertyCollection,this.speechRecognitionLanguage="en-US",this.outputFormat=t.OutputFormat.Simple}get properties(){return this.privProperties}get endPoint(){return new URL(this.privProperties.getProperty(t.PropertyId.SpeechServiceConnection_Endpoint))}get subscriptionKey(){return this.privProperties.getProperty(t.PropertyId.SpeechServiceConnection_Key)}get region(){return this.privProperties.getProperty(t.PropertyId.SpeechServiceConnection_Region)}get authorizationToken(){return this.privProperties.getProperty(t.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(c){this.privProperties.setProperty(t.PropertyId.SpeechServiceAuthorization_Token,c)}get speechRecognitionLanguage(){return this.privProperties.getProperty(t.PropertyId.SpeechServiceConnection_RecoLanguage)}set speechRecognitionLanguage(c){this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_RecoLanguage,c)}get autoDetectSourceLanguages(){return this.privProperties.getProperty(t.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages)}set autoDetectSourceLanguages(c){this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages,c)}get outputFormat(){return t.OutputFormat[this.privProperties.getProperty(i.OutputFormatPropertyName,void 0)]}set outputFormat(c){this.privProperties.setProperty(i.OutputFormatPropertyName,t.OutputFormat[c])}get endpointId(){return this.privProperties.getProperty(t.PropertyId.SpeechServiceConnection_EndpointId)}set endpointId(c){this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_EndpointId,c)}setProperty(c,u){e.Contracts.throwIfNull(u,"value"),this.privProperties.setProperty(c,u)}getProperty(c,u){return this.privProperties.getProperty(c,u)}setProxy(c,u,d,p){this.setProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_ProxyHostName],c),this.setProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_ProxyPort],u),this.setProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_ProxyUserName],d),this.setProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_ProxyPassword],p)}setServiceProperty(c,u){const d=JSON.parse(this.privProperties.getProperty(i.ServicePropertiesPropertyName,"{}"));d[c]=u,this.privProperties.setProperty(i.ServicePropertiesPropertyName,JSON.stringify(d))}setProfanity(c){this.privProperties.setProperty(t.PropertyId.SpeechServiceResponse_ProfanityOption,t.ProfanityOption[c])}enableAudioLogging(){this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_EnableAudioLogging,"true")}requestWordLevelTimestamps(){this.privProperties.setProperty(t.PropertyId.SpeechServiceResponse_RequestWordLevelTimestamps,"true")}enableDictation(){this.privProperties.setProperty(i.ForceDictationPropertyName,"true")}clone(){const c=new o;return c.privProperties=this.privProperties.clone(),c}get speechSynthesisLanguage(){return this.privProperties.getProperty(t.PropertyId.SpeechServiceConnection_SynthLanguage)}set speechSynthesisLanguage(c){this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_SynthLanguage,c)}get speechSynthesisVoiceName(){return this.privProperties.getProperty(t.PropertyId.SpeechServiceConnection_SynthVoice)}set speechSynthesisVoiceName(c){this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_SynthVoice,c)}get speechSynthesisOutputFormat(){return t.SpeechSynthesisOutputFormat[this.privProperties.getProperty(t.PropertyId.SpeechServiceConnection_SynthOutputFormat,void 0)]}set speechSynthesisOutputFormat(c){this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_SynthOutputFormat,t.SpeechSynthesisOutputFormat[c])}}return SpeechConfig.SpeechConfigImpl=o,SpeechConfig}var SpeechTranslationConfig={},hasRequiredSpeechTranslationConfig;function requireSpeechTranslationConfig(){if(hasRequiredSpeechTranslationConfig)return SpeechTranslationConfig;hasRequiredSpeechTranslationConfig=1,Object.defineProperty(SpeechTranslationConfig,"__esModule",{value:!0}),SpeechTranslationConfig.SpeechTranslationConfigImpl=SpeechTranslationConfig.SpeechTranslationConfig=void 0;const i=requireExports(),e=Contracts$1,t=requireExports$3();let s=class extends t.SpeechConfig{constructor(){super()}static fromSubscription(c,u){e.Contracts.throwIfNullOrWhitespace(c,"subscriptionKey"),e.Contracts.throwIfNullOrWhitespace(u,"region");const d=new o;return d.properties.setProperty(t.PropertyId.SpeechServiceConnection_Key,c),d.properties.setProperty(t.PropertyId.SpeechServiceConnection_Region,u),d}static fromAuthorizationToken(c,u){e.Contracts.throwIfNullOrWhitespace(c,"authorizationToken"),e.Contracts.throwIfNullOrWhitespace(u,"region");const d=new o;return d.properties.setProperty(t.PropertyId.SpeechServiceAuthorization_Token,c),d.properties.setProperty(t.PropertyId.SpeechServiceConnection_Region,u),d}static fromHost(c,u){e.Contracts.throwIfNull(c,"hostName");const d=new o;return d.setProperty(t.PropertyId.SpeechServiceConnection_Host,c.protocol+"//"+c.hostname+(c.port===""?"":":"+c.port)),u!==void 0&&d.setProperty(t.PropertyId.SpeechServiceConnection_Key,u),d}static fromEndpoint(c,u){e.Contracts.throwIfNull(c,"endpoint"),e.Contracts.throwIfNull(u,"subscriptionKey");const d=new o;return d.properties.setProperty(t.PropertyId.SpeechServiceConnection_Endpoint,c.href),d.properties.setProperty(t.PropertyId.SpeechServiceConnection_Key,u),d}};SpeechTranslationConfig.SpeechTranslationConfig=s;class o extends s{constructor(){super(),this.privSpeechProperties=new t.PropertyCollection,this.outputFormat=t.OutputFormat.Simple}set authorizationToken(c){e.Contracts.throwIfNullOrWhitespace(c,"value"),this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceAuthorization_Token,c)}set speechRecognitionLanguage(c){e.Contracts.throwIfNullOrWhitespace(c,"value"),this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceConnection_RecoLanguage,c)}get speechRecognitionLanguage(){return this.privSpeechProperties.getProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_RecoLanguage])}get subscriptionKey(){return this.privSpeechProperties.getProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_Key])}get outputFormat(){return t.OutputFormat[this.privSpeechProperties.getProperty(i.OutputFormatPropertyName,void 0)]}set outputFormat(c){this.privSpeechProperties.setProperty(i.OutputFormatPropertyName,t.OutputFormat[c])}get endpointId(){return this.privSpeechProperties.getProperty(t.PropertyId.SpeechServiceConnection_EndpointId)}set endpointId(c){this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceConnection_EndpointId,c)}addTargetLanguage(c){e.Contracts.throwIfNullOrWhitespace(c,"value");const u=this.targetLanguages;u.includes(c)||(u.push(c),this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceConnection_TranslationToLanguages,u.join(",")))}get targetLanguages(){return this.privSpeechProperties.getProperty(t.PropertyId.SpeechServiceConnection_TranslationToLanguages,void 0)!==void 0?this.privSpeechProperties.getProperty(t.PropertyId.SpeechServiceConnection_TranslationToLanguages).split(","):[]}get voiceName(){return this.getProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_TranslationVoice])}set voiceName(c){e.Contracts.throwIfNullOrWhitespace(c,"value"),this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceConnection_TranslationVoice,c)}get region(){return this.privSpeechProperties.getProperty(t.PropertyId.SpeechServiceConnection_Region)}setProxy(c,u,d,p){this.setProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_ProxyHostName],c),this.setProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_ProxyPort],u),this.setProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_ProxyUserName],d),this.setProperty(t.PropertyId[t.PropertyId.SpeechServiceConnection_ProxyPassword],p)}getProperty(c,u){return this.privSpeechProperties.getProperty(c,u)}setProperty(c,u){this.privSpeechProperties.setProperty(c,u)}get properties(){return this.privSpeechProperties}close(){}setServiceProperty(c,u){const d=JSON.parse(this.privSpeechProperties.getProperty(i.ServicePropertiesPropertyName,"{}"));d[c]=u,this.privSpeechProperties.setProperty(i.ServicePropertiesPropertyName,JSON.stringify(d))}setProfanity(c){this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceResponse_ProfanityOption,t.ProfanityOption[c])}enableAudioLogging(){this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceConnection_EnableAudioLogging,"true")}requestWordLevelTimestamps(){this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceResponse_RequestWordLevelTimestamps,"true")}enableDictation(){this.privSpeechProperties.setProperty(i.ForceDictationPropertyName,"true")}get speechSynthesisLanguage(){return this.privSpeechProperties.getProperty(t.PropertyId.SpeechServiceConnection_SynthLanguage)}set speechSynthesisLanguage(c){this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceConnection_SynthLanguage,c)}get speechSynthesisVoiceName(){return this.privSpeechProperties.getProperty(t.PropertyId.SpeechServiceConnection_SynthVoice)}set speechSynthesisVoiceName(c){this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceConnection_SynthVoice,c)}get speechSynthesisOutputFormat(){return t.SpeechSynthesisOutputFormat[this.privSpeechProperties.getProperty(t.PropertyId.SpeechServiceConnection_SynthOutputFormat,void 0)]}set speechSynthesisOutputFormat(c){this.privSpeechProperties.setProperty(t.PropertyId.SpeechServiceConnection_SynthOutputFormat,t.SpeechSynthesisOutputFormat[c])}}return SpeechTranslationConfig.SpeechTranslationConfigImpl=o,SpeechTranslationConfig}var PropertyCollection={},hasRequiredPropertyCollection;function requirePropertyCollection(){if(hasRequiredPropertyCollection)return PropertyCollection;hasRequiredPropertyCollection=1,Object.defineProperty(PropertyCollection,"__esModule",{value:!0}),PropertyCollection.PropertyCollection=void 0;const i=requireExports$3();let e=class Te{constructor(){this.privKeys=[],this.privValues=[]}getProperty(s,o){let a;typeof s=="string"?a=s:a=i.PropertyId[s];for(let c=0;c<this.privKeys.length;c++)if(this.privKeys[c]===a)return this.privValues[c];if(o!==void 0)return String(o)}setProperty(s,o){let a;typeof s=="string"?a=s:a=i.PropertyId[s];for(let c=0;c<this.privKeys.length;c++)if(this.privKeys[c]===a){this.privValues[c]=o;return}this.privKeys.push(a),this.privValues.push(o)}clone(){const s=new Te;for(let o=0;o<this.privKeys.length;o++)s.privKeys.push(this.privKeys[o]),s.privValues.push(this.privValues[o]);return s}mergeTo(s){this.privKeys.forEach(o=>{if(s.getProperty(o,void 0)===void 0){const a=this.getProperty(o);s.setProperty(o,a)}})}get keys(){return this.privKeys}};return PropertyCollection.PropertyCollection=e,PropertyCollection}var PropertyId={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.PropertyId=void 0,function(e){e[e.SpeechServiceConnection_Key=0]="SpeechServiceConnection_Key",e[e.SpeechServiceConnection_Endpoint=1]="SpeechServiceConnection_Endpoint",e[e.SpeechServiceConnection_Region=2]="SpeechServiceConnection_Region",e[e.SpeechServiceAuthorization_Token=3]="SpeechServiceAuthorization_Token",e[e.SpeechServiceAuthorization_Type=4]="SpeechServiceAuthorization_Type",e[e.SpeechServiceConnection_EndpointId=5]="SpeechServiceConnection_EndpointId",e[e.SpeechServiceConnection_TranslationToLanguages=6]="SpeechServiceConnection_TranslationToLanguages",e[e.SpeechServiceConnection_TranslationVoice=7]="SpeechServiceConnection_TranslationVoice",e[e.SpeechServiceConnection_TranslationFeatures=8]="SpeechServiceConnection_TranslationFeatures",e[e.SpeechServiceConnection_IntentRegion=9]="SpeechServiceConnection_IntentRegion",e[e.SpeechServiceConnection_ProxyHostName=10]="SpeechServiceConnection_ProxyHostName",e[e.SpeechServiceConnection_ProxyPort=11]="SpeechServiceConnection_ProxyPort",e[e.SpeechServiceConnection_ProxyUserName=12]="SpeechServiceConnection_ProxyUserName",e[e.SpeechServiceConnection_ProxyPassword=13]="SpeechServiceConnection_ProxyPassword",e[e.SpeechServiceConnection_RecoMode=14]="SpeechServiceConnection_RecoMode",e[e.SpeechServiceConnection_RecoLanguage=15]="SpeechServiceConnection_RecoLanguage",e[e.Speech_SessionId=16]="Speech_SessionId",e[e.SpeechServiceConnection_SynthLanguage=17]="SpeechServiceConnection_SynthLanguage",e[e.SpeechServiceConnection_SynthVoice=18]="SpeechServiceConnection_SynthVoice",e[e.SpeechServiceConnection_SynthOutputFormat=19]="SpeechServiceConnection_SynthOutputFormat",e[e.SpeechServiceConnection_AutoDetectSourceLanguages=20]="SpeechServiceConnection_AutoDetectSourceLanguages",e[e.SpeechServiceResponse_RequestDetailedResultTrueFalse=21]="SpeechServiceResponse_RequestDetailedResultTrueFalse",e[e.SpeechServiceResponse_RequestProfanityFilterTrueFalse=22]="SpeechServiceResponse_RequestProfanityFilterTrueFalse",e[e.SpeechServiceResponse_JsonResult=23]="SpeechServiceResponse_JsonResult",e[e.SpeechServiceResponse_JsonErrorDetails=24]="SpeechServiceResponse_JsonErrorDetails",e[e.CancellationDetails_Reason=25]="CancellationDetails_Reason",e[e.CancellationDetails_ReasonText=26]="CancellationDetails_ReasonText",e[e.CancellationDetails_ReasonDetailedText=27]="CancellationDetails_ReasonDetailedText",e[e.LanguageUnderstandingServiceResponse_JsonResult=28]="LanguageUnderstandingServiceResponse_JsonResult",e[e.SpeechServiceConnection_Url=29]="SpeechServiceConnection_Url",e[e.SpeechServiceConnection_InitialSilenceTimeoutMs=30]="SpeechServiceConnection_InitialSilenceTimeoutMs",e[e.SpeechServiceConnection_EndSilenceTimeoutMs=31]="SpeechServiceConnection_EndSilenceTimeoutMs",e[e.Speech_SegmentationSilenceTimeoutMs=32]="Speech_SegmentationSilenceTimeoutMs",e[e.SpeechServiceConnection_EnableAudioLogging=33]="SpeechServiceConnection_EnableAudioLogging",e[e.SpeechServiceConnection_LanguageIdMode=34]="SpeechServiceConnection_LanguageIdMode",e[e.SpeechServiceConnection_RecognitionEndpointVersion=35]="SpeechServiceConnection_RecognitionEndpointVersion",e[e.SpeechServiceConnection_SpeakerIdMode=36]="SpeechServiceConnection_SpeakerIdMode",e[e.SpeechServiceResponse_ProfanityOption=37]="SpeechServiceResponse_ProfanityOption",e[e.SpeechServiceResponse_PostProcessingOption=38]="SpeechServiceResponse_PostProcessingOption",e[e.SpeechServiceResponse_RequestWordLevelTimestamps=39]="SpeechServiceResponse_RequestWordLevelTimestamps",e[e.SpeechServiceResponse_StablePartialResultThreshold=40]="SpeechServiceResponse_StablePartialResultThreshold",e[e.SpeechServiceResponse_OutputFormatOption=41]="SpeechServiceResponse_OutputFormatOption",e[e.SpeechServiceResponse_TranslationRequestStablePartialResult=42]="SpeechServiceResponse_TranslationRequestStablePartialResult",e[e.SpeechServiceResponse_RequestWordBoundary=43]="SpeechServiceResponse_RequestWordBoundary",e[e.SpeechServiceResponse_RequestPunctuationBoundary=44]="SpeechServiceResponse_RequestPunctuationBoundary",e[e.SpeechServiceResponse_RequestSentenceBoundary=45]="SpeechServiceResponse_RequestSentenceBoundary",e[e.SpeechServiceResponse_DiarizeIntermediateResults=46]="SpeechServiceResponse_DiarizeIntermediateResults",e[e.Conversation_ApplicationId=47]="Conversation_ApplicationId",e[e.Conversation_DialogType=48]="Conversation_DialogType",e[e.Conversation_Initial_Silence_Timeout=49]="Conversation_Initial_Silence_Timeout",e[e.Conversation_From_Id=50]="Conversation_From_Id",e[e.Conversation_Conversation_Id=51]="Conversation_Conversation_Id",e[e.Conversation_Custom_Voice_Deployment_Ids=52]="Conversation_Custom_Voice_Deployment_Ids",e[e.Conversation_Speech_Activity_Template=53]="Conversation_Speech_Activity_Template",e[e.Conversation_Request_Bot_Status_Messages=54]="Conversation_Request_Bot_Status_Messages",e[e.Conversation_Agent_Connection_Id=55]="Conversation_Agent_Connection_Id",e[e.SpeechServiceConnection_Host=56]="SpeechServiceConnection_Host",e[e.ConversationTranslator_Host=57]="ConversationTranslator_Host",e[e.ConversationTranslator_Name=58]="ConversationTranslator_Name",e[e.ConversationTranslator_CorrelationId=59]="ConversationTranslator_CorrelationId",e[e.ConversationTranslator_Token=60]="ConversationTranslator_Token",e[e.PronunciationAssessment_ReferenceText=61]="PronunciationAssessment_ReferenceText",e[e.PronunciationAssessment_GradingSystem=62]="PronunciationAssessment_GradingSystem",e[e.PronunciationAssessment_Granularity=63]="PronunciationAssessment_Granularity",e[e.PronunciationAssessment_EnableMiscue=64]="PronunciationAssessment_EnableMiscue",e[e.PronunciationAssessment_Json=65]="PronunciationAssessment_Json",e[e.PronunciationAssessment_Params=66]="PronunciationAssessment_Params",e[e.SpeakerRecognition_Api_Version=67]="SpeakerRecognition_Api_Version",e[e.WebWorkerLoadType=68]="WebWorkerLoadType",e[e.TalkingAvatarService_WebRTC_SDP=69]="TalkingAvatarService_WebRTC_SDP"}(i.PropertyId||(i.PropertyId={}))})(PropertyId);var Recognizer={},hasRequiredRecognizer;function requireRecognizer(){if(hasRequiredRecognizer)return Recognizer;hasRequiredRecognizer=1,Object.defineProperty(Recognizer,"__esModule",{value:!0}),Recognizer.Recognizer=void 0;const i=requireExports(),e=requireExports$5(),t=Contracts$1,s=requireExports$3();let o=class Ee{constructor(c,u,d){this.audioConfig=c!==void 0?c:s.AudioConfig.fromDefaultMicrophoneInput(),this.privDisposed=!1,this.privProperties=u.clone(),this.privConnectionFactory=d,this.implCommonRecognizerSetup()}close(c,u){t.Contracts.throwIfDisposed(this.privDisposed),e.marshalPromiseToCallbacks(this.dispose(!0),c,u)}get internalData(){return this.privReco}async dispose(c){this.privDisposed||(this.privDisposed=!0,c&&this.privReco&&(await this.privReco.audioSource.turnOff(),await this.privReco.dispose()))}static get telemetryEnabled(){return i.ServiceRecognizerBase.telemetryDataEnabled}static enableTelemetry(c){i.ServiceRecognizerBase.telemetryDataEnabled=c}implCommonRecognizerSetup(){let c=typeof window<"u"?"Browser":"Node",u="unknown",d="unknown";typeof navigator<"u"&&(c=c+"/"+navigator.platform,u=navigator.userAgent,d=navigator.appVersion);const p=this.createRecognizerConfig(new i.SpeechServiceConfig(new i.Context(new i.OS(c,u,d))));this.privReco=this.createServiceRecognizer(Ee.getAuthFromProperties(this.privProperties),this.privConnectionFactory,this.audioConfig,p)}async recognizeOnceAsyncImpl(c){t.Contracts.throwIfDisposed(this.privDisposed);const u=new e.Deferred;await this.implRecognizerStop(),await this.privReco.recognize(c,u.resolve,u.reject);const d=await u.promise;return await this.implRecognizerStop(),d}async startContinuousRecognitionAsyncImpl(c){t.Contracts.throwIfDisposed(this.privDisposed),await this.implRecognizerStop(),await this.privReco.recognize(c,void 0,void 0)}async stopContinuousRecognitionAsyncImpl(){t.Contracts.throwIfDisposed(this.privDisposed),await this.implRecognizerStop()}async implRecognizerStop(){this.privReco&&await this.privReco.stopRecognizing()}static getAuthFromProperties(c){const u=c.getProperty(s.PropertyId.SpeechServiceConnection_Key,void 0);return u&&u!==""?new i.CognitiveSubscriptionKeyAuthentication(u):new i.CognitiveTokenAuthentication(()=>{const p=c.getProperty(s.PropertyId.SpeechServiceAuthorization_Token,void 0);return Promise.resolve(p)},()=>{const p=c.getProperty(s.PropertyId.SpeechServiceAuthorization_Token,void 0);return Promise.resolve(p)})}};return Recognizer.Recognizer=o,Recognizer}var SpeechRecognizer={},hasRequiredSpeechRecognizer;function requireSpeechRecognizer(){if(hasRequiredSpeechRecognizer)return SpeechRecognizer;hasRequiredSpeechRecognizer=1,Object.defineProperty(SpeechRecognizer,"__esModule",{value:!0}),SpeechRecognizer.SpeechRecognizer=void 0;const i=requireExports(),e=requireExports$5(),t=Contracts$1,s=requireExports$3();let o=class be extends s.Recognizer{constructor(c,u){const d=c;t.Contracts.throwIfNull(d,"speechConfig"),t.Contracts.throwIfNullOrWhitespace(d.properties.getProperty(s.PropertyId.SpeechServiceConnection_RecoLanguage),s.PropertyId[s.PropertyId.SpeechServiceConnection_RecoLanguage]),super(u,d.properties,new i.SpeechConnectionFactory),this.privDisposedRecognizer=!1}static FromConfig(c,u,d){const p=c;return u.properties.mergeTo(p.properties),new be(c,d)}get endpointId(){return t.Contracts.throwIfDisposed(this.privDisposedRecognizer),this.properties.getProperty(s.PropertyId.SpeechServiceConnection_EndpointId,"00000000-0000-0000-0000-000000000000")}get authorizationToken(){return this.properties.getProperty(s.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(c){t.Contracts.throwIfNullOrWhitespace(c,"token"),this.properties.setProperty(s.PropertyId.SpeechServiceAuthorization_Token,c)}get speechRecognitionLanguage(){return t.Contracts.throwIfDisposed(this.privDisposedRecognizer),this.properties.getProperty(s.PropertyId.SpeechServiceConnection_RecoLanguage)}get outputFormat(){return t.Contracts.throwIfDisposed(this.privDisposedRecognizer),this.properties.getProperty(i.OutputFormatPropertyName,s.OutputFormat[s.OutputFormat.Simple])===s.OutputFormat[s.OutputFormat.Simple]?s.OutputFormat.Simple:s.OutputFormat.Detailed}get properties(){return this.privProperties}recognizeOnceAsync(c,u){e.marshalPromiseToCallbacks(this.recognizeOnceAsyncImpl(i.RecognitionMode.Interactive),c,u)}startContinuousRecognitionAsync(c,u){e.marshalPromiseToCallbacks(this.startContinuousRecognitionAsyncImpl(i.RecognitionMode.Conversation),c,u)}stopContinuousRecognitionAsync(c,u){e.marshalPromiseToCallbacks(this.stopContinuousRecognitionAsyncImpl(),c,u)}startKeywordRecognitionAsync(c,u,d){t.Contracts.throwIfNull(c,"model"),d&&d("Not yet implemented.")}stopKeywordRecognitionAsync(c){c&&c()}close(c,u){t.Contracts.throwIfDisposed(this.privDisposedRecognizer),e.marshalPromiseToCallbacks(this.dispose(!0),c,u)}async dispose(c){this.privDisposedRecognizer||(c&&(this.privDisposedRecognizer=!0,await this.implRecognizerStop()),await super.dispose(c))}createRecognizerConfig(c){return new i.RecognizerConfig(c,this.privProperties)}createServiceRecognizer(c,u,d,p){const v=d;return new i.SpeechServiceRecognizer(c,u,v,p,this)}};return SpeechRecognizer.SpeechRecognizer=o,SpeechRecognizer}var IntentRecognizer={},hasRequiredIntentRecognizer;function requireIntentRecognizer(){if(hasRequiredIntentRecognizer)return IntentRecognizer;hasRequiredIntentRecognizer=1,Object.defineProperty(IntentRecognizer,"__esModule",{value:!0}),IntentRecognizer.IntentRecognizer=void 0;const i=requireExports(),e=requireExports$5(),t=Contracts$1,s=requireExports$3();let o=class extends s.Recognizer{constructor(c,u){t.Contracts.throwIfNullOrUndefined(c,"speechConfig");const d=c;t.Contracts.throwIfNullOrUndefined(d,"speechConfig"),super(u,d.properties,new i.IntentConnectionFactory),this.privAddedIntents=[],this.privAddedLmIntents={},this.privDisposedIntentRecognizer=!1,this.privProperties=d.properties,t.Contracts.throwIfNullOrWhitespace(this.properties.getProperty(s.PropertyId.SpeechServiceConnection_RecoLanguage),s.PropertyId[s.PropertyId.SpeechServiceConnection_RecoLanguage])}get speechRecognitionLanguage(){return t.Contracts.throwIfDisposed(this.privDisposedIntentRecognizer),this.properties.getProperty(s.PropertyId.SpeechServiceConnection_RecoLanguage)}get authorizationToken(){return this.properties.getProperty(s.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(c){this.properties.setProperty(s.PropertyId.SpeechServiceAuthorization_Token,c)}get properties(){return this.privProperties}recognizeOnceAsync(c,u){if(t.Contracts.throwIfDisposed(this.privDisposedIntentRecognizer),Object.keys(this.privAddedLmIntents).length!==0||this.privUmbrellaIntent!==void 0){const d=this.buildSpeechContext();this.privReco.speechContext.setSection("intent",d.Intent),this.privReco.dynamicGrammar.addReferenceGrammar(d.ReferenceGrammars),this.privReco.setIntents(this.privAddedLmIntents,this.privUmbrellaIntent)}e.marshalPromiseToCallbacks(this.recognizeOnceAsyncImpl(i.RecognitionMode.Interactive),c,u)}startContinuousRecognitionAsync(c,u){if(Object.keys(this.privAddedLmIntents).length!==0||this.privUmbrellaIntent!==void 0){const d=this.buildSpeechContext();this.privReco.speechContext.setSection("intent",d.Intent),this.privReco.dynamicGrammar.addReferenceGrammar(d.ReferenceGrammars),this.privReco.setIntents(this.privAddedLmIntents,this.privUmbrellaIntent)}e.marshalPromiseToCallbacks(this.startContinuousRecognitionAsyncImpl(i.RecognitionMode.Conversation),c,u)}stopContinuousRecognitionAsync(c,u){e.marshalPromiseToCallbacks(this.stopContinuousRecognitionAsyncImpl(),c,u)}startKeywordRecognitionAsync(c,u,d){t.Contracts.throwIfNull(c,"model"),d&&d("Not yet implemented.")}stopKeywordRecognitionAsync(c,u){if(c)try{c()}catch(d){u&&u(d)}}addIntent(c,u){t.Contracts.throwIfDisposed(this.privDisposedIntentRecognizer),t.Contracts.throwIfNullOrWhitespace(u,"intentId"),t.Contracts.throwIfNullOrWhitespace(c,"simplePhrase"),this.privAddedIntents.push([u,c])}addIntentWithLanguageModel(c,u,d){t.Contracts.throwIfDisposed(this.privDisposedIntentRecognizer),t.Contracts.throwIfNullOrWhitespace(c,"intentId"),t.Contracts.throwIfNull(u,"model");const p=u;t.Contracts.throwIfNullOrWhitespace(p.appId,"model.appId"),this.privAddedLmIntents[c]=new i.AddedLmIntent(p,d)}addAllIntents(c,u){t.Contracts.throwIfNull(c,"model");const d=c;t.Contracts.throwIfNullOrWhitespace(d.appId,"model.appId"),this.privUmbrellaIntent=new i.AddedLmIntent(d,u)}close(c,u){t.Contracts.throwIfDisposed(this.privDisposedIntentRecognizer),e.marshalPromiseToCallbacks(this.dispose(!0),c,u)}createRecognizerConfig(c){return new i.RecognizerConfig(c,this.privProperties)}createServiceRecognizer(c,u,d,p){const v=d;return new i.IntentServiceRecognizer(c,u,v,p,this)}async dispose(c){this.privDisposedIntentRecognizer||c&&(this.privDisposedIntentRecognizer=!0,await super.dispose(c))}buildSpeechContext(){let c,u,d;const p=[];this.privUmbrellaIntent!==void 0&&(c=this.privUmbrellaIntent.modelImpl.appId,u=this.privUmbrellaIntent.modelImpl.region,d=this.privUmbrellaIntent.modelImpl.subscriptionKey);for(const v of Object.keys(this.privAddedLmIntents)){const g=this.privAddedLmIntents[v];if(c===void 0)c=g.modelImpl.appId;else if(c!==g.modelImpl.appId)throw new Error("Intents must all be from the same LUIS model");if(u===void 0)u=g.modelImpl.region;else if(u!==g.modelImpl.region)throw new Error("Intents must all be from the same LUIS model in a single region");if(d===void 0)d=g.modelImpl.subscriptionKey;else if(d!==g.modelImpl.subscriptionKey)throw new Error("Intents must all use the same subscription key");const m="luis/"+c+"-PRODUCTION#"+v;p.push(m)}return{Intent:{id:c,key:d===void 0?this.privProperties.getProperty(s.PropertyId[s.PropertyId.SpeechServiceConnection_Key]):d,provider:"LUIS"},ReferenceGrammars:this.privUmbrellaIntent===void 0?p:["luis/"+c+"-PRODUCTION"]}}};return IntentRecognizer.IntentRecognizer=o,IntentRecognizer}var VoiceProfileType={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.VoiceProfileType=void 0,function(e){e[e.TextIndependentIdentification=0]="TextIndependentIdentification",e[e.TextDependentVerification=1]="TextDependentVerification",e[e.TextIndependentVerification=2]="TextIndependentVerification"}(i.VoiceProfileType||(i.VoiceProfileType={}))})(VoiceProfileType);var TranslationRecognizer={},Connection={},ConnectionMessage={},hasRequiredConnectionMessage;function requireConnectionMessage(){if(hasRequiredConnectionMessage)return ConnectionMessage;hasRequiredConnectionMessage=1,Object.defineProperty(ConnectionMessage,"__esModule",{value:!0}),ConnectionMessage.ConnectionMessageImpl=ConnectionMessage.ConnectionMessage=void 0;const i=HeaderNames$1,e=requireExports$5(),t=requirePropertyCollection(),s=PropertyId;let o=class{};ConnectionMessage.ConnectionMessage=o;class a{constructor(u){this.privConnectionMessage=u,this.privProperties=new t.PropertyCollection,this.privConnectionMessage.headers[i.HeaderNames.ConnectionId]&&this.privProperties.setProperty(s.PropertyId.Speech_SessionId,this.privConnectionMessage.headers[i.HeaderNames.ConnectionId]),Object.keys(this.privConnectionMessage.headers).forEach(d=>{this.privProperties.setProperty(d,this.privConnectionMessage.headers[d])})}get path(){return this.privConnectionMessage.headers[Object.keys(this.privConnectionMessage.headers).find(u=>u.toLowerCase()==="path".toLowerCase())]}get isTextMessage(){return this.privConnectionMessage.messageType===e.MessageType.Text}get isBinaryMessage(){return this.privConnectionMessage.messageType===e.MessageType.Binary}get TextMessage(){return this.privConnectionMessage.textBody}get binaryMessage(){return this.privConnectionMessage.binaryBody}get properties(){return this.privProperties}toString(){return""}}return ConnectionMessage.ConnectionMessageImpl=a,ConnectionMessage}var hasRequiredConnection;function requireConnection(){if(hasRequiredConnection)return Connection;hasRequiredConnection=1,Object.defineProperty(Connection,"__esModule",{value:!0}),Connection.Connection=void 0;const i=requireExports(),e=requireExports$5(),t=requireConnectionMessage(),s=Contracts$1,o=requireExports$3();let a=class pe{static fromRecognizer(u){const d=u.internalData,p=new pe;return p.privInternalData=d,p.setupEvents(),p}static fromSynthesizer(u){const d=u.internalData,p=new pe;return p.privInternalData=d,p.setupEvents(),p}openConnection(u,d){e.marshalPromiseToCallbacks(this.privInternalData.connect(),u,d)}closeConnection(u,d){if(this.privInternalData instanceof i.SynthesisAdapterBase)throw new Error("Disconnecting a synthesizer's connection is currently not supported");e.marshalPromiseToCallbacks(this.privInternalData.disconnect(),u,d)}setMessageProperty(u,d,p){if(s.Contracts.throwIfNullOrWhitespace(d,"propertyName"),this.privInternalData instanceof i.ServiceRecognizerBase){if(u.toLowerCase()!=="speech.context")throw new Error("Only speech.context message property sets are currently supported for recognizer");this.privInternalData.speechContext.setSection(d,p)}else if(this.privInternalData instanceof i.SynthesisAdapterBase){if(u.toLowerCase()!=="synthesis.context")throw new Error("Only synthesis.context message property sets are currently supported for synthesizer");this.privInternalData.synthesisContext.setSection(d,p)}}sendMessageAsync(u,d,p,v){e.marshalPromiseToCallbacks(this.privInternalData.sendNetworkMessage(u,d),p,v)}close(){}setupEvents(){this.privEventListener=this.privInternalData.connectionEvents.attach(u=>{u.name==="ConnectionEstablishedEvent"?this.connected&&this.connected(new o.ConnectionEventArgs(u.connectionId)):u.name==="ConnectionClosedEvent"?this.disconnected&&this.disconnected(new o.ConnectionEventArgs(u.connectionId)):u.name==="ConnectionMessageSentEvent"?this.messageSent&&this.messageSent(new o.ConnectionMessageEventArgs(new t.ConnectionMessageImpl(u.message))):u.name==="ConnectionMessageReceivedEvent"&&this.messageReceived&&this.messageReceived(new o.ConnectionMessageEventArgs(new t.ConnectionMessageImpl(u.message)))}),this.privServiceEventListener=this.privInternalData.serviceEvents.attach(u=>{this.receivedServiceMessage&&this.receivedServiceMessage(new o.ServiceEventArgs(u.jsonString,u.name))})}};return Connection.Connection=a,Connection}var hasRequiredTranslationRecognizer;function requireTranslationRecognizer(){if(hasRequiredTranslationRecognizer)return TranslationRecognizer;hasRequiredTranslationRecognizer=1,Object.defineProperty(TranslationRecognizer,"__esModule",{value:!0}),TranslationRecognizer.TranslationRecognizer=void 0;const i=requireExports(),e=requireExports$5(),t=requireConnection(),s=Contracts$1,o=requireExports$3();let a=class Pe extends o.Recognizer{constructor(u,d,p){const v=u;s.Contracts.throwIfNull(v,"speechConfig"),super(d,v.properties,p||new i.TranslationConnectionFactory),this.privDisposedTranslationRecognizer=!1,this.properties.getProperty(o.PropertyId.SpeechServiceConnection_TranslationVoice,void 0)!==void 0&&s.Contracts.throwIfNullOrWhitespace(this.properties.getProperty(o.PropertyId.SpeechServiceConnection_TranslationVoice),o.PropertyId[o.PropertyId.SpeechServiceConnection_TranslationVoice]),s.Contracts.throwIfNullOrWhitespace(this.properties.getProperty(o.PropertyId.SpeechServiceConnection_TranslationToLanguages),o.PropertyId[o.PropertyId.SpeechServiceConnection_TranslationToLanguages]),s.Contracts.throwIfNullOrWhitespace(this.properties.getProperty(o.PropertyId.SpeechServiceConnection_RecoLanguage),o.PropertyId[o.PropertyId.SpeechServiceConnection_RecoLanguage])}static FromConfig(u,d,p){const v=u;return d.properties.mergeTo(v.properties),new Pe(u,p)}get speechRecognitionLanguage(){return s.Contracts.throwIfDisposed(this.privDisposedTranslationRecognizer),this.properties.getProperty(o.PropertyId.SpeechServiceConnection_RecoLanguage)}get targetLanguages(){return s.Contracts.throwIfDisposed(this.privDisposedTranslationRecognizer),this.properties.getProperty(o.PropertyId.SpeechServiceConnection_TranslationToLanguages).split(",")}get voiceName(){return s.Contracts.throwIfDisposed(this.privDisposedTranslationRecognizer),this.properties.getProperty(o.PropertyId.SpeechServiceConnection_TranslationVoice,void 0)}get properties(){return this.privProperties}get authorizationToken(){return this.properties.getProperty(o.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(u){this.properties.setProperty(o.PropertyId.SpeechServiceAuthorization_Token,u)}recognizeOnceAsync(u,d){s.Contracts.throwIfDisposed(this.privDisposedTranslationRecognizer),e.marshalPromiseToCallbacks(this.recognizeOnceAsyncImpl(i.RecognitionMode.Interactive),u,d)}startContinuousRecognitionAsync(u,d){e.marshalPromiseToCallbacks(this.startContinuousRecognitionAsyncImpl(i.RecognitionMode.Conversation),u,d)}stopContinuousRecognitionAsync(u,d){e.marshalPromiseToCallbacks(this.stopContinuousRecognitionAsyncImpl(),u,d)}removeTargetLanguage(u){if(s.Contracts.throwIfNullOrUndefined(u,"language to be removed"),this.properties.getProperty(o.PropertyId.SpeechServiceConnection_TranslationToLanguages,void 0)!==void 0){const d=this.properties.getProperty(o.PropertyId.SpeechServiceConnection_TranslationToLanguages).split(","),p=d.indexOf(u);p>-1&&(d.splice(p,1),this.properties.setProperty(o.PropertyId.SpeechServiceConnection_TranslationToLanguages,d.join(",")),this.updateLanguages(d))}}addTargetLanguage(u){s.Contracts.throwIfNullOrUndefined(u,"language to be added");let d=[];this.properties.getProperty(o.PropertyId.SpeechServiceConnection_TranslationToLanguages,void 0)!==void 0?(d=this.properties.getProperty(o.PropertyId.SpeechServiceConnection_TranslationToLanguages).split(","),d.includes(u)||(d.push(u),this.properties.setProperty(o.PropertyId.SpeechServiceConnection_TranslationToLanguages,d.join(",")))):(this.properties.setProperty(o.PropertyId.SpeechServiceConnection_TranslationToLanguages,u),d=[u]),this.updateLanguages(d)}close(u,d){s.Contracts.throwIfDisposed(this.privDisposedTranslationRecognizer),e.marshalPromiseToCallbacks(this.dispose(!0),u,d)}onConnection(){}async dispose(u){this.privDisposedTranslationRecognizer||(this.privDisposedTranslationRecognizer=!0,u&&(await this.implRecognizerStop(),await super.dispose(u)))}createRecognizerConfig(u){return new i.RecognizerConfig(u,this.privProperties)}createServiceRecognizer(u,d,p,v){const g=p;return new i.TranslationServiceRecognizer(u,d,g,v,this)}updateLanguages(u){const d=t.Connection.fromRecognizer(this);d&&(d.setMessageProperty("speech.context","translationcontext",{to:u}),d.sendMessageAsync("event",JSON.stringify({id:"translation",name:"updateLanguage",to:u})))}};return TranslationRecognizer.TranslationRecognizer=a,TranslationRecognizer}var Translations={},hasRequiredTranslations;function requireTranslations(){if(hasRequiredTranslations)return Translations;hasRequiredTranslations=1,Object.defineProperty(Translations,"__esModule",{value:!0}),Translations.Translations=void 0;const i=requireExports$3();let e=class{constructor(){this.privMap=new i.PropertyCollection}get languages(){return this.privMap.keys}get(s,o){return this.privMap.getProperty(s,o)}set(s,o){this.privMap.setProperty(s,o)}};return Translations.Translations=e,Translations}var NoMatchReason={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.NoMatchReason=void 0,function(e){e[e.NotRecognized=0]="NotRecognized",e[e.InitialSilenceTimeout=1]="InitialSilenceTimeout",e[e.InitialBabbleTimeout=2]="InitialBabbleTimeout"}(i.NoMatchReason||(i.NoMatchReason={}))})(NoMatchReason);var NoMatchDetails={},hasRequiredNoMatchDetails;function requireNoMatchDetails(){if(hasRequiredNoMatchDetails)return NoMatchDetails;hasRequiredNoMatchDetails=1,Object.defineProperty(NoMatchDetails,"__esModule",{value:!0}),NoMatchDetails.NoMatchDetails=void 0;const i=requireExports(),e=requireExports$3();let t=class _e{constructor(o){this.privReason=o}static fromResult(o){const a=i.SimpleSpeechPhrase.fromJSON(o.json);let c=e.NoMatchReason.NotRecognized;switch(a.RecognitionStatus){case i.RecognitionStatus.BabbleTimeout:c=e.NoMatchReason.InitialBabbleTimeout;break;case i.RecognitionStatus.InitialSilenceTimeout:c=e.NoMatchReason.InitialSilenceTimeout;break;default:c=e.NoMatchReason.NotRecognized;break}return new _e(c)}get reason(){return this.privReason}};return NoMatchDetails.NoMatchDetails=t,NoMatchDetails}var TranslationRecognitionCanceledEventArgs$1={};Object.defineProperty(TranslationRecognitionCanceledEventArgs$1,"__esModule",{value:!0});TranslationRecognitionCanceledEventArgs$1.TranslationRecognitionCanceledEventArgs=void 0;class TranslationRecognitionCanceledEventArgs{constructor(e,t,s,o,a){this.privCancelReason=t,this.privErrorDetails=s,this.privResult=a,this.privSessionId=e,this.privErrorCode=o}get result(){return this.privResult}get sessionId(){return this.privSessionId}get reason(){return this.privCancelReason}get errorCode(){return this.privErrorCode}get errorDetails(){return this.privErrorDetails}}TranslationRecognitionCanceledEventArgs$1.TranslationRecognitionCanceledEventArgs=TranslationRecognitionCanceledEventArgs;var IntentRecognitionCanceledEventArgs={},hasRequiredIntentRecognitionCanceledEventArgs;function requireIntentRecognitionCanceledEventArgs(){if(hasRequiredIntentRecognitionCanceledEventArgs)return IntentRecognitionCanceledEventArgs;hasRequiredIntentRecognitionCanceledEventArgs=1,Object.defineProperty(IntentRecognitionCanceledEventArgs,"__esModule",{value:!0}),IntentRecognitionCanceledEventArgs.IntentRecognitionCanceledEventArgs=void 0;const i=requireExports$3();let e=class extends i.IntentRecognitionEventArgs{constructor(s,o,a,c,u,d){super(c,u,d),this.privReason=s,this.privErrorDetails=o,this.privErrorCode=a}get reason(){return this.privReason}get errorCode(){return this.privErrorCode}get errorDetails(){return this.privErrorDetails}};return IntentRecognitionCanceledEventArgs.IntentRecognitionCanceledEventArgs=e,IntentRecognitionCanceledEventArgs}var CancellationDetailsBase$1={};Object.defineProperty(CancellationDetailsBase$1,"__esModule",{value:!0});CancellationDetailsBase$1.CancellationDetailsBase=void 0;class CancellationDetailsBase{constructor(e,t,s){this.privReason=e,this.privErrorDetails=t,this.privErrorCode=s}get reason(){return this.privReason}get errorDetails(){return this.privErrorDetails}get ErrorCode(){return this.privErrorCode}}CancellationDetailsBase$1.CancellationDetailsBase=CancellationDetailsBase;var CancellationDetails={},hasRequiredCancellationDetails;function requireCancellationDetails(){if(hasRequiredCancellationDetails)return CancellationDetails;hasRequiredCancellationDetails=1,Object.defineProperty(CancellationDetails,"__esModule",{value:!0}),CancellationDetails.CancellationDetails=void 0;const i=requireExports(),e=CancellationDetailsBase$1,t=requireExports$3();let s=class ke extends e.CancellationDetailsBase{constructor(a,c,u){super(a,c,u)}static fromResult(a){let c=t.CancellationReason.Error,u=t.CancellationErrorCode.NoError;if(a instanceof t.RecognitionResult&&a.json){const d=i.SimpleSpeechPhrase.fromJSON(a.json);c=i.EnumTranslation.implTranslateCancelResult(d.RecognitionStatus)}return a.properties&&(u=t.CancellationErrorCode[a.properties.getProperty(i.CancellationErrorCodePropertyName,t.CancellationErrorCode[t.CancellationErrorCode.NoError])]),new ke(c,a.errorDetails||i.EnumTranslation.implTranslateErrorDetails(u),u)}};return CancellationDetails.CancellationDetails=s,CancellationDetails}var CancellationErrorCodes={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.CancellationErrorCode=void 0,function(e){e[e.NoError=0]="NoError",e[e.AuthenticationFailure=1]="AuthenticationFailure",e[e.BadRequestParameters=2]="BadRequestParameters",e[e.TooManyRequests=3]="TooManyRequests",e[e.ConnectionFailure=4]="ConnectionFailure",e[e.ServiceTimeout=5]="ServiceTimeout",e[e.ServiceError=6]="ServiceError",e[e.RuntimeError=7]="RuntimeError",e[e.Forbidden=8]="Forbidden"}(i.CancellationErrorCode||(i.CancellationErrorCode={}))})(CancellationErrorCodes);var ConnectionEventArgs={},hasRequiredConnectionEventArgs;function requireConnectionEventArgs(){if(hasRequiredConnectionEventArgs)return ConnectionEventArgs;hasRequiredConnectionEventArgs=1,Object.defineProperty(ConnectionEventArgs,"__esModule",{value:!0}),ConnectionEventArgs.ConnectionEventArgs=void 0;const i=requireExports$3();let e=class extends i.SessionEventArgs{};return ConnectionEventArgs.ConnectionEventArgs=e,ConnectionEventArgs}var ServiceEventArgs={},hasRequiredServiceEventArgs;function requireServiceEventArgs(){if(hasRequiredServiceEventArgs)return ServiceEventArgs;hasRequiredServiceEventArgs=1,Object.defineProperty(ServiceEventArgs,"__esModule",{value:!0}),ServiceEventArgs.ServiceEventArgs=void 0;const i=requireExports$3();let e=class extends i.SessionEventArgs{constructor(s,o,a){super(a),this.privJsonResult=s,this.privEventName=o}get jsonString(){return this.privJsonResult}get eventName(){return this.privEventName}};return ServiceEventArgs.ServiceEventArgs=e,ServiceEventArgs}var PhraseListGrammar$1={};Object.defineProperty(PhraseListGrammar$1,"__esModule",{value:!0});PhraseListGrammar$1.PhraseListGrammar=void 0;class PhraseListGrammar{constructor(e){this.privGrammerBuilder=e.dynamicGrammar}static fromRecognizer(e){const t=e.internalData;return new PhraseListGrammar(t)}addPhrase(e){this.privGrammerBuilder.addPhrase(e)}addPhrases(e){this.privGrammerBuilder.addPhrase(e)}clear(){this.privGrammerBuilder.clearPhrases()}}PhraseListGrammar$1.PhraseListGrammar=PhraseListGrammar;var DialogServiceConfig={},hasRequiredDialogServiceConfig;function requireDialogServiceConfig(){if(hasRequiredDialogServiceConfig)return DialogServiceConfig;hasRequiredDialogServiceConfig=1,Object.defineProperty(DialogServiceConfig,"__esModule",{value:!0}),DialogServiceConfig.DialogServiceConfigImpl=DialogServiceConfig.DialogServiceConfig=void 0;const i=Contracts$1,e=requireExports$3();let t=class{constructor(){}set applicationId(a){}static get DialogTypes(){return{BotFramework:"bot_framework",CustomCommands:"custom_commands"}}};DialogServiceConfig.DialogServiceConfig=t;class s extends t{constructor(){super(),this.privSpeechConfig=new e.SpeechConfigImpl}get properties(){return this.privSpeechConfig.properties}get speechRecognitionLanguage(){return this.privSpeechConfig.speechRecognitionLanguage}set speechRecognitionLanguage(a){i.Contracts.throwIfNullOrWhitespace(a,"value"),this.privSpeechConfig.speechRecognitionLanguage=a}get outputFormat(){return this.privSpeechConfig.outputFormat}set outputFormat(a){this.privSpeechConfig.outputFormat=a}setProperty(a,c){this.privSpeechConfig.setProperty(a,c)}getProperty(a,c){return this.privSpeechConfig.getProperty(a)}setProxy(a,c,u,d){this.setProperty(e.PropertyId.SpeechServiceConnection_ProxyHostName,a),this.setProperty(e.PropertyId.SpeechServiceConnection_ProxyPort,`${c}`),u&&this.setProperty(e.PropertyId.SpeechServiceConnection_ProxyUserName,u),d&&this.setProperty(e.PropertyId.SpeechServiceConnection_ProxyPassword,d)}setServiceProperty(a,c,u){this.privSpeechConfig.setServiceProperty(a,c)}close(){}}return DialogServiceConfig.DialogServiceConfigImpl=s,DialogServiceConfig}var BotFrameworkConfig={},hasRequiredBotFrameworkConfig;function requireBotFrameworkConfig(){if(hasRequiredBotFrameworkConfig)return BotFrameworkConfig;hasRequiredBotFrameworkConfig=1,Object.defineProperty(BotFrameworkConfig,"__esModule",{value:!0}),BotFrameworkConfig.BotFrameworkConfig=void 0;const i=Contracts$1,e=requireDialogServiceConfig(),t=requireExports$3();let s=class extends e.DialogServiceConfigImpl{constructor(){super()}static fromSubscription(a,c,u){i.Contracts.throwIfNullOrWhitespace(a,"subscription"),i.Contracts.throwIfNullOrWhitespace(c,"region");const d=new e.DialogServiceConfigImpl;return d.setProperty(t.PropertyId.Conversation_DialogType,e.DialogServiceConfig.DialogTypes.BotFramework),d.setProperty(t.PropertyId.SpeechServiceConnection_Key,a),d.setProperty(t.PropertyId.SpeechServiceConnection_Region,c),u&&d.setProperty(t.PropertyId.Conversation_ApplicationId,u),d}static fromAuthorizationToken(a,c,u){i.Contracts.throwIfNullOrWhitespace(a,"authorizationToken"),i.Contracts.throwIfNullOrWhitespace(c,"region");const d=new e.DialogServiceConfigImpl;return d.setProperty(t.PropertyId.Conversation_DialogType,e.DialogServiceConfig.DialogTypes.BotFramework),d.setProperty(t.PropertyId.SpeechServiceAuthorization_Token,a),d.setProperty(t.PropertyId.SpeechServiceConnection_Region,c),u&&d.setProperty(t.PropertyId.Conversation_ApplicationId,u),d}static fromHost(a,c,u){i.Contracts.throwIfNullOrUndefined(a,"host");const d=a instanceof URL?a:new URL(`wss://${a}.convai.speech.azure.us`);i.Contracts.throwIfNullOrUndefined(d,"resolvedHost");const p=new e.DialogServiceConfigImpl;return p.setProperty(t.PropertyId.Conversation_DialogType,e.DialogServiceConfig.DialogTypes.BotFramework),p.setProperty(t.PropertyId.SpeechServiceConnection_Host,d.toString()),c!==void 0&&p.setProperty(t.PropertyId.SpeechServiceConnection_Key,c),p}static fromEndpoint(a,c){i.Contracts.throwIfNull(a,"endpoint");const u=new e.DialogServiceConfigImpl;return u.setProperty(t.PropertyId.Conversation_DialogType,e.DialogServiceConfig.DialogTypes.BotFramework),u.setProperty(t.PropertyId.SpeechServiceConnection_Endpoint,a.toString()),c!==void 0&&u.setProperty(t.PropertyId.SpeechServiceConnection_Key,c),u}};return BotFrameworkConfig.BotFrameworkConfig=s,BotFrameworkConfig}var CustomCommandsConfig={},hasRequiredCustomCommandsConfig;function requireCustomCommandsConfig(){if(hasRequiredCustomCommandsConfig)return CustomCommandsConfig;hasRequiredCustomCommandsConfig=1,Object.defineProperty(CustomCommandsConfig,"__esModule",{value:!0}),CustomCommandsConfig.CustomCommandsConfig=void 0;const i=Contracts$1,e=requireDialogServiceConfig(),t=requireExports$3();let s=class extends e.DialogServiceConfigImpl{constructor(){super()}static fromSubscription(a,c,u){i.Contracts.throwIfNullOrWhitespace(a,"applicationId"),i.Contracts.throwIfNullOrWhitespace(c,"subscription"),i.Contracts.throwIfNullOrWhitespace(u,"region");const d=new e.DialogServiceConfigImpl;return d.setProperty(t.PropertyId.Conversation_DialogType,e.DialogServiceConfig.DialogTypes.CustomCommands),d.setProperty(t.PropertyId.Conversation_ApplicationId,a),d.setProperty(t.PropertyId.SpeechServiceConnection_Key,c),d.setProperty(t.PropertyId.SpeechServiceConnection_Region,u),d}static fromAuthorizationToken(a,c,u){i.Contracts.throwIfNullOrWhitespace(a,"applicationId"),i.Contracts.throwIfNullOrWhitespace(c,"authorizationToken"),i.Contracts.throwIfNullOrWhitespace(u,"region");const d=new e.DialogServiceConfigImpl;return d.setProperty(t.PropertyId.Conversation_DialogType,e.DialogServiceConfig.DialogTypes.CustomCommands),d.setProperty(t.PropertyId.Conversation_ApplicationId,a),d.setProperty(t.PropertyId.SpeechServiceAuthorization_Token,c),d.setProperty(t.PropertyId.SpeechServiceConnection_Region,u),d}set applicationId(a){i.Contracts.throwIfNullOrWhitespace(a,"value"),this.setProperty(t.PropertyId.Conversation_ApplicationId,a)}get applicationId(){return this.getProperty(t.PropertyId.Conversation_ApplicationId)}};return CustomCommandsConfig.CustomCommandsConfig=s,CustomCommandsConfig}var DialogServiceConnector={},DialogConnectorFactory={},ConnectionFactoryBase={},QueryParameterNames$1={};Object.defineProperty(QueryParameterNames$1,"__esModule",{value:!0});QueryParameterNames$1.QueryParameterNames=void 0;class QueryParameterNames{}QueryParameterNames$1.QueryParameterNames=QueryParameterNames;QueryParameterNames.BotId="botid";QueryParameterNames.CustomSpeechDeploymentId="cid";QueryParameterNames.CustomVoiceDeploymentId="deploymentId";QueryParameterNames.EnableAudioLogging="storeAudio";QueryParameterNames.EnableLanguageId="lidEnabled";QueryParameterNames.EnableWordLevelTimestamps="wordLevelTimestamps";QueryParameterNames.EndSilenceTimeoutMs="endSilenceTimeoutMs";QueryParameterNames.SegmentationSilenceTimeoutMs="segmentationSilenceTimeoutMs";QueryParameterNames.Format="format";QueryParameterNames.InitialSilenceTimeoutMs="initialSilenceTimeoutMs";QueryParameterNames.Language="language";QueryParameterNames.Profanity="profanity";QueryParameterNames.RequestBotStatusMessages="enableBotMessageStatus";QueryParameterNames.StableIntermediateThreshold="stableIntermediateThreshold";QueryParameterNames.StableTranslation="stableTranslation";QueryParameterNames.TestHooks="testhooks";QueryParameterNames.Postprocessing="postprocessing";QueryParameterNames.CtsMeetingId="meetingId";QueryParameterNames.CtsDeviceId="deviceId";QueryParameterNames.CtsIsParticipant="isParticipant";QueryParameterNames.EnableAvatar="enableTalkingAvatar";var hasRequiredConnectionFactoryBase;function requireConnectionFactoryBase(){if(hasRequiredConnectionFactoryBase)return ConnectionFactoryBase;hasRequiredConnectionFactoryBase=1,Object.defineProperty(ConnectionFactoryBase,"__esModule",{value:!0}),ConnectionFactoryBase.ConnectionFactoryBase=void 0;const i=requireExports(),e=requireExports$3(),t=QueryParameterNames$1;let s=class{static getHostSuffix(a){if(a){if(a.toLowerCase().startsWith("china"))return".azure.cn";if(a.toLowerCase().startsWith("usgov"))return".azure.us"}return".microsoft.com"}setCommonUrlParams(a,c,u){new Map([[e.PropertyId.Speech_SegmentationSilenceTimeoutMs,t.QueryParameterNames.SegmentationSilenceTimeoutMs],[e.PropertyId.SpeechServiceConnection_EnableAudioLogging,t.QueryParameterNames.EnableAudioLogging],[e.PropertyId.SpeechServiceConnection_EndSilenceTimeoutMs,t.QueryParameterNames.EndSilenceTimeoutMs],[e.PropertyId.SpeechServiceConnection_InitialSilenceTimeoutMs,t.QueryParameterNames.InitialSilenceTimeoutMs],[e.PropertyId.SpeechServiceResponse_PostProcessingOption,t.QueryParameterNames.Postprocessing],[e.PropertyId.SpeechServiceResponse_ProfanityOption,t.QueryParameterNames.Profanity],[e.PropertyId.SpeechServiceResponse_RequestWordLevelTimestamps,t.QueryParameterNames.EnableWordLevelTimestamps],[e.PropertyId.SpeechServiceResponse_StablePartialResultThreshold,t.QueryParameterNames.StableIntermediateThreshold]]).forEach((v,g)=>{this.setUrlParameter(g,v,a,c,u)});const p=JSON.parse(a.parameters.getProperty(i.ServicePropertiesPropertyName,"{}"));Object.keys(p).forEach(v=>{c[v]=p[v]})}setUrlParameter(a,c,u,d,p){const v=u.parameters.getProperty(a,void 0);v&&(!p||p.search(c)===-1)&&(d[c]=v.toLocaleLowerCase())}};return ConnectionFactoryBase.ConnectionFactoryBase=s,ConnectionFactoryBase}var hasRequiredDialogConnectorFactory;function requireDialogConnectorFactory(){if(hasRequiredDialogConnectorFactory)return DialogConnectorFactory;hasRequiredDialogConnectorFactory=1,Object.defineProperty(DialogConnectorFactory,"__esModule",{value:!0}),DialogConnectorFactory.DialogConnectionFactory=void 0;const i=requireExports$2(),e=requireExports(),t=requireExports$3(),s=requireConnectionFactoryBase(),o=requireExports(),a=HeaderNames$1,c=QueryParameterNames$1;class u extends s.ConnectionFactoryBase{create(p,v,g){const m=p.parameters.getProperty(t.PropertyId.Conversation_ApplicationId,""),S=p.parameters.getProperty(t.PropertyId.Conversation_DialogType),y=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Region),C=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_RecoLanguage,"en-US"),R=p.parameters.getProperty(t.PropertyId.Conversation_Request_Bot_Status_Messages,"true"),T={};T[a.HeaderNames.ConnectionId]=g,T[c.QueryParameterNames.Format]=p.parameters.getProperty(e.OutputFormatPropertyName,t.OutputFormat[t.OutputFormat.Simple]).toLowerCase(),T[c.QueryParameterNames.Language]=C,T[c.QueryParameterNames.RequestBotStatusMessages]=R,m&&(T[c.QueryParameterNames.BotId]=m,S===t.DialogServiceConfig.DialogTypes.CustomCommands&&(T[a.HeaderNames.CustomCommandsAppId]=m));const E=S===t.DialogServiceConfig.DialogTypes.CustomCommands?"commands/":"",A=S===t.DialogServiceConfig.DialogTypes.CustomCommands?"v1":S===t.DialogServiceConfig.DialogTypes.BotFramework?"v3":"v0",b={};v.token!=null&&v.token!==""&&(b[v.headerName]=v.token);let P=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Endpoint,"");if(!P){const w=s.ConnectionFactoryBase.getHostSuffix(y),I=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Host,`wss://${y}.${u.BaseUrl}${w}`);P=`${I.endsWith("/")?I:I+"/"}${E}${u.ApiKey}/${A}`}this.setCommonUrlParams(p,T,P);const _=p.parameters.getProperty("SPEECH-EnableWebsocketCompression","false")==="true";return new i.WebsocketConnection(P,T,b,new o.WebsocketMessageFormatter,i.ProxyInfo.fromRecognizerConfig(p),_,g)}}return DialogConnectorFactory.DialogConnectionFactory=u,u.ApiKey="api",u.BaseUrl="convai.speech",DialogConnectorFactory}var hasRequiredDialogServiceConnector;function requireDialogServiceConnector(){if(hasRequiredDialogServiceConnector)return DialogServiceConnector;hasRequiredDialogServiceConnector=1,Object.defineProperty(DialogServiceConnector,"__esModule",{value:!0}),DialogServiceConnector.DialogServiceConnector=void 0;const i=requireDialogConnectorFactory(),e=requireExports(),t=requireExports$5(),s=Contracts$1,o=requireExports$3(),a=PropertyId;let c=class extends o.Recognizer{constructor(d,p){const v=d;s.Contracts.throwIfNull(d,"dialogConfig"),super(p,v.properties,new i.DialogConnectionFactory),this.isTurnComplete=!0,this.privIsDisposed=!1,this.privProperties=v.properties.clone();const g=this.buildAgentConfig();this.privReco.agentConfig.set(g)}connect(d,p){t.marshalPromiseToCallbacks(this.privReco.connect(),d,p)}disconnect(d,p){t.marshalPromiseToCallbacks(this.privReco.disconnect(),d,p)}get authorizationToken(){return this.properties.getProperty(a.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(d){s.Contracts.throwIfNullOrWhitespace(d,"token"),this.properties.setProperty(a.PropertyId.SpeechServiceAuthorization_Token,d)}get properties(){return this.privProperties}get speechActivityTemplate(){return this.properties.getProperty(a.PropertyId.Conversation_Speech_Activity_Template)}set speechActivityTemplate(d){this.properties.setProperty(a.PropertyId.Conversation_Speech_Activity_Template,d)}listenOnceAsync(d,p){if(this.isTurnComplete){s.Contracts.throwIfDisposed(this.privIsDisposed);const g=(async()=>{await this.privReco.connect(),await this.implRecognizerStop(),this.isTurnComplete=!1;const m=new t.Deferred;await this.privReco.recognize(e.RecognitionMode.Conversation,m.resolve,m.reject);const S=await m.promise;return await this.implRecognizerStop(),S})();g.catch(()=>{this.dispose(!0).catch(()=>{})}),t.marshalPromiseToCallbacks(g.finally(()=>{this.isTurnComplete=!0}),d,p)}}sendActivityAsync(d,p,v){t.marshalPromiseToCallbacks(this.privReco.sendMessage(d),p,v)}close(d,p){s.Contracts.throwIfDisposed(this.privIsDisposed),t.marshalPromiseToCallbacks(this.dispose(!0),d,p)}async dispose(d){this.privIsDisposed||d&&(this.privIsDisposed=!0,await this.implRecognizerStop(),await super.dispose(d))}createRecognizerConfig(d){return new e.RecognizerConfig(d,this.privProperties)}createServiceRecognizer(d,p,v,g){const m=v;return new e.DialogServiceAdapter(d,p,m,g,this)}buildAgentConfig(){return{botInfo:{commType:this.properties.getProperty("Conversation_Communication_Type","Default"),commandsCulture:void 0,connectionId:this.properties.getProperty(a.PropertyId.Conversation_Agent_Connection_Id),conversationId:this.properties.getProperty(a.PropertyId.Conversation_Conversation_Id,void 0),fromId:this.properties.getProperty(a.PropertyId.Conversation_From_Id,void 0),ttsAudioFormat:this.properties.getProperty(a.PropertyId.SpeechServiceConnection_SynthOutputFormat,void 0)},version:.2}}};return DialogServiceConnector.DialogServiceConnector=c,DialogServiceConnector}var ActivityReceivedEventArgs$1={};Object.defineProperty(ActivityReceivedEventArgs$1,"__esModule",{value:!0});ActivityReceivedEventArgs$1.ActivityReceivedEventArgs=void 0;class ActivityReceivedEventArgs{constructor(e,t){this.privActivity=e,this.privAudioStream=t}get activity(){return this.privActivity}get audioStream(){return this.privAudioStream}}ActivityReceivedEventArgs$1.ActivityReceivedEventArgs=ActivityReceivedEventArgs;var TurnStatusReceivedEventArgs$1={},TurnStatusPayload={};Object.defineProperty(TurnStatusPayload,"__esModule",{value:!0});TurnStatusPayload.TurnStatusResponsePayload=void 0;class TurnStatusResponsePayload{constructor(e){this.privMessageStatusResponse=JSON.parse(e)}static fromJSON(e){return new TurnStatusResponsePayload(e)}get interactionId(){return this.privMessageStatusResponse.interactionId}get conversationId(){return this.privMessageStatusResponse.conversationId}get statusCode(){switch(this.privMessageStatusResponse.statusCode){case"Success":return 200;case"Failed":return 400;case"TimedOut":return 429;default:return this.privMessageStatusResponse.statusCode}}}TurnStatusPayload.TurnStatusResponsePayload=TurnStatusResponsePayload;Object.defineProperty(TurnStatusReceivedEventArgs$1,"__esModule",{value:!0});TurnStatusReceivedEventArgs$1.TurnStatusReceivedEventArgs=void 0;const TurnStatusPayload_js_1=TurnStatusPayload;class TurnStatusReceivedEventArgs{constructor(e){this.privTurnStatus=TurnStatusPayload_js_1.TurnStatusResponsePayload.fromJSON(e)}get interactionId(){return this.privTurnStatus.interactionId}get conversationId(){return this.privTurnStatus.conversationId}get statusCode(){return this.privTurnStatus.statusCode}}TurnStatusReceivedEventArgs$1.TurnStatusReceivedEventArgs=TurnStatusReceivedEventArgs;var ServicePropertyChannel={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.ServicePropertyChannel=void 0,function(e){e[e.UriQueryParameter=0]="UriQueryParameter"}(i.ServicePropertyChannel||(i.ServicePropertyChannel={}))})(ServicePropertyChannel);var ProfanityOption={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.ProfanityOption=void 0,function(e){e[e.Masked=0]="Masked",e[e.Removed=1]="Removed",e[e.Raw=2]="Raw"}(i.ProfanityOption||(i.ProfanityOption={}))})(ProfanityOption);var BaseAudioPlayer={},hasRequiredBaseAudioPlayer;function requireBaseAudioPlayer(){if(hasRequiredBaseAudioPlayer)return BaseAudioPlayer;hasRequiredBaseAudioPlayer=1,Object.defineProperty(BaseAudioPlayer,"__esModule",{value:!0}),BaseAudioPlayer.BaseAudioPlayer=void 0;const i=_Error,e=requireExports$3(),t=AudioStreamFormat;let s=class{constructor(a){this.audioContext=null,this.gainNode=null,this.autoUpdateBufferTimer=0,a===void 0&&(a=e.AudioStreamFormat.getDefaultInputFormat()),this.init(a)}playAudioSample(a,c,u){try{this.ensureInitializedContext();const d=this.formatAudioData(a),p=new Float32Array(this.samples.length+d.length);p.set(this.samples,0),p.set(d,this.samples.length),this.samples=p,c&&c()}catch(d){u&&u(d)}}stopAudio(a,c){this.audioContext!==null&&(this.samples=new Float32Array,clearInterval(this.autoUpdateBufferTimer),this.audioContext.close().then(()=>{a&&a()},u=>{c&&c(u)}),this.audioContext=null)}init(a){this.audioFormat=a,this.samples=new Float32Array}ensureInitializedContext(){if(this.audioContext===null){this.createAudioContext();const a=200;this.autoUpdateBufferTimer=setInterval(()=>{this.updateAudioBuffer()},a)}}createAudioContext(){this.audioContext=t.AudioStreamFormatImpl.getAudioContext(),this.gainNode=this.audioContext.createGain(),this.gainNode.gain.value=1,this.gainNode.connect(this.audioContext.destination),this.startTime=this.audioContext.currentTime}formatAudioData(a){switch(this.audioFormat.bitsPerSample){case 8:return this.formatArrayBuffer(new Int8Array(a),128);case 16:return this.formatArrayBuffer(new Int16Array(a),32768);case 32:return this.formatArrayBuffer(new Int32Array(a),2147483648);default:throw new i.InvalidOperationError("Only WAVE_FORMAT_PCM (8/16/32 bps) format supported at this time")}}formatArrayBuffer(a,c){const u=new Float32Array(a.length);for(let d=0;d<a.length;d++)u[d]=a[d]/c;return u}updateAudioBuffer(){if(this.samples.length===0)return;const a=this.audioFormat.channels,c=this.audioContext.createBufferSource(),u=this.samples.length/a,d=this.audioContext.createBuffer(a,u,this.audioFormat.samplesPerSec);for(let p=0;p<a;p++){let v=p;const g=d.getChannelData(p);for(let m=0;m<this.samples.length;m++,v+=a)g[m]=this.samples[v]}this.startTime<this.audioContext.currentTime&&(this.startTime=this.audioContext.currentTime),c.buffer=d,c.connect(this.gainNode),c.start(this.startTime),this.startTime+=d.duration,this.samples=new Float32Array}async playAudio(a){this.audioContext===null&&this.createAudioContext();const c=this.audioContext.createBufferSource(),u=this.audioContext.destination;await this.audioContext.decodeAudioData(a,d=>{c.buffer=d,c.connect(u),c.start(0)})}};return BaseAudioPlayer.BaseAudioPlayer=s,BaseAudioPlayer}var ConnectionMessageEventArgs$1={};Object.defineProperty(ConnectionMessageEventArgs$1,"__esModule",{value:!0});ConnectionMessageEventArgs$1.ConnectionMessageEventArgs=void 0;class ConnectionMessageEventArgs{constructor(e){this.privConnectionMessage=e}get message(){return this.privConnectionMessage}toString(){return"Message: "+this.privConnectionMessage.toString()}}ConnectionMessageEventArgs$1.ConnectionMessageEventArgs=ConnectionMessageEventArgs;var VoiceProfile$1={};Object.defineProperty(VoiceProfile$1,"__esModule",{value:!0});VoiceProfile$1.VoiceProfile=void 0;class VoiceProfile{constructor(e,t){this.privId=e,this.privProfileType=t}get profileId(){return this.privId}get profileType(){return this.privProfileType}}VoiceProfile$1.VoiceProfile=VoiceProfile;var VoiceProfileEnrollmentResult={},hasRequiredVoiceProfileEnrollmentResult;function requireVoiceProfileEnrollmentResult(){if(hasRequiredVoiceProfileEnrollmentResult)return VoiceProfileEnrollmentResult;hasRequiredVoiceProfileEnrollmentResult=1,Object.defineProperty(VoiceProfileEnrollmentResult,"__esModule",{value:!0}),VoiceProfileEnrollmentResult.VoiceProfileEnrollmentCancellationDetails=VoiceProfileEnrollmentResult.VoiceProfileEnrollmentResult=void 0;const i=requireExports(),e=requireExports$3();let t=class he{constructor(a,c,u){this.privReason=a,this.privProperties=new e.PropertyCollection,this.privReason!==e.ResultReason.Canceled?c&&(this.privDetails=JSON.parse(c),this.privDetails.enrollmentStatus.toLowerCase()==="enrolling"&&(this.privReason=e.ResultReason.EnrollingVoiceProfile)):(this.privErrorDetails=u,this.privProperties.setProperty(i.CancellationErrorCodePropertyName,e.CancellationErrorCode[e.CancellationErrorCode.ServiceError]))}get reason(){return this.privReason}get enrollmentsCount(){return this.privDetails.enrollmentsCount}get enrollmentsLength(){return this.privDetails.enrollmentsLength}get properties(){return this.privProperties}get enrollmentResultDetails(){return this.privDetails}get errorDetails(){return this.privErrorDetails}static FromIdentificationProfileList(a){const c=[];for(const u of a.value){const d=u.enrollmentStatus.toLowerCase()==="enrolling"?e.ResultReason.EnrollingVoiceProfile:u.enrollmentStatus.toLowerCase()==="enrolled"?e.ResultReason.EnrolledVoiceProfile:e.ResultReason.Canceled,p=new he(d,null,null);p.privDetails=this.getIdentificationDetails(u),c.push(p)}return c}static FromVerificationProfileList(a){const c=[];for(const u of a.value){const d=u.enrollmentStatus.toLowerCase()==="enrolling"?e.ResultReason.EnrollingVoiceProfile:u.enrollmentStatus.toLowerCase()==="enrolled"?e.ResultReason.EnrolledVoiceProfile:e.ResultReason.Canceled,p=new he(d,null,null);p.privDetails=this.getVerificationDetails(u),c.push(p)}return c}static getIdentificationDetails(a){return{audioLength:a.audioLength?parseFloat(a.audioLength):0,audioSpeechLength:a.audioSpeechLength?parseFloat(a.audioSpeechLength):0,enrollmentStatus:a.enrollmentStatus,enrollmentsCount:a.enrollmentsCount||0,enrollmentsLength:a.enrollmentsLength?parseFloat(a.enrollmentsLength):0,enrollmentsSpeechLength:a.enrollmentsSpeechLength?parseFloat(a.enrollmentsSpeechLength):0,profileId:a.profileId||a.identificationProfileId,remainingEnrollmentsSpeechLength:a.remainingEnrollmentsSpeechLength?parseFloat(a.remainingEnrollmentsSpeechLength):0}}static getVerificationDetails(a){return{audioLength:a.audioLength?parseFloat(a.audioLength):0,audioSpeechLength:a.audioSpeechLength?parseFloat(a.audioSpeechLength):0,enrollmentStatus:a.enrollmentStatus,enrollmentsCount:a.enrollmentsCount,enrollmentsLength:a.enrollmentsLength?parseFloat(a.enrollmentsLength):0,enrollmentsSpeechLength:a.enrollmentsSpeechLength?parseFloat(a.enrollmentsSpeechLength):0,profileId:a.profileId||a.verificationProfileId,remainingEnrollmentsCount:a.remainingEnrollments||a.remainingEnrollmentsCount,remainingEnrollmentsSpeechLength:a.remainingEnrollmentsSpeechLength?parseFloat(a.remainingEnrollmentsSpeechLength):0}}};VoiceProfileEnrollmentResult.VoiceProfileEnrollmentResult=t;class s extends e.CancellationDetailsBase{constructor(a,c,u){super(a,c,u)}static fromResult(a){const c=e.CancellationReason.Error;let u=e.CancellationErrorCode.NoError;return a.properties&&(u=e.CancellationErrorCode[a.properties.getProperty(i.CancellationErrorCodePropertyName,e.CancellationErrorCode[e.CancellationErrorCode.NoError])]),new s(c,a.errorDetails,u)}}return VoiceProfileEnrollmentResult.VoiceProfileEnrollmentCancellationDetails=s,VoiceProfileEnrollmentResult}var VoiceProfileResult={},hasRequiredVoiceProfileResult;function requireVoiceProfileResult(){if(hasRequiredVoiceProfileResult)return VoiceProfileResult;hasRequiredVoiceProfileResult=1,Object.defineProperty(VoiceProfileResult,"__esModule",{value:!0}),VoiceProfileResult.VoiceProfileCancellationDetails=VoiceProfileResult.VoiceProfileResult=void 0;const i=requireExports(),e=Contracts$1,t=requireExports$3();let s=class{constructor(c,u){this.privReason=c,this.privProperties=new t.PropertyCollection,c===t.ResultReason.Canceled&&(e.Contracts.throwIfNullOrUndefined(u,"statusText"),this.privErrorDetails=u,this.privProperties.setProperty(i.CancellationErrorCodePropertyName,t.CancellationErrorCode[t.CancellationErrorCode.ServiceError]))}get reason(){return this.privReason}get properties(){return this.privProperties}get errorDetails(){return this.privErrorDetails}};VoiceProfileResult.VoiceProfileResult=s;class o extends t.CancellationDetailsBase{constructor(c,u,d){super(c,u,d)}static fromResult(c){const u=t.CancellationReason.Error;let d=t.CancellationErrorCode.NoError;return c.properties&&(d=t.CancellationErrorCode[c.properties.getProperty(i.CancellationErrorCodePropertyName,t.CancellationErrorCode[t.CancellationErrorCode.NoError])]),new o(u,c.errorDetails,d)}}return VoiceProfileResult.VoiceProfileCancellationDetails=o,VoiceProfileResult}var VoiceProfilePhraseResult={},hasRequiredVoiceProfilePhraseResult;function requireVoiceProfilePhraseResult(){if(hasRequiredVoiceProfilePhraseResult)return VoiceProfilePhraseResult;hasRequiredVoiceProfilePhraseResult=1,Object.defineProperty(VoiceProfilePhraseResult,"__esModule",{value:!0}),VoiceProfilePhraseResult.VoiceProfilePhraseResult=void 0;const i=Contracts$1,e=requireExports$3();let t=class extends e.VoiceProfileResult{constructor(o,a,c,u){super(o,a),this.privPhrases=[],i.Contracts.throwIfNullOrUndefined(u,"phrase array"),this.privType=c,u&&u[0]&&(this.privPhrases=u)}get phrases(){return this.privPhrases}get type(){return this.privType}};return VoiceProfilePhraseResult.VoiceProfilePhraseResult=t,VoiceProfilePhraseResult}var VoiceProfileClient={},hasRequiredVoiceProfileClient;function requireVoiceProfileClient(){if(hasRequiredVoiceProfileClient)return VoiceProfileClient;hasRequiredVoiceProfileClient=1,Object.defineProperty(VoiceProfileClient,"__esModule",{value:!0}),VoiceProfileClient.VoiceProfileClient=void 0;const i=requireExports(),e=requireAudioConfig(),t=Contracts$1,s=requireExports$3();let o=class extends s.Recognizer{constructor(c){t.Contracts.throwIfNullOrUndefined(c,"speechConfig");const u=c;t.Contracts.throwIfNull(u,"speechConfig"),super(e.AudioConfig.fromStreamInput(s.AudioInputStream.createPushStream()),u.properties,new i.VoiceProfileConnectionFactory),this.privProperties=u.properties.clone(),this.privVoiceAdapter=this.privReco,this.privDisposedVoiceAdapter=!1}get properties(){return this.privProperties}get authorizationToken(){return this.properties.getProperty(s.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(c){t.Contracts.throwIfNullOrWhitespace(c,"token"),this.properties.setProperty(s.PropertyId.SpeechServiceAuthorization_Token,c)}async createProfileAsync(c,u){const d=await this.privVoiceAdapter.createProfile(c,u);return new s.VoiceProfile(d[0],c)}async retrieveEnrollmentResultAsync(c){return this.privVoiceAdapter.retrieveEnrollmentResult(c)}async getAllProfilesAsync(c){return this.privVoiceAdapter.getAllProfiles(c)}async getActivationPhrasesAsync(c,u){return this.privVoiceAdapter.getActivationPhrases(c,u)}async enrollProfileAsync(c,u){const d=u;return t.Contracts.throwIfNullOrUndefined(d,"audioConfig"),this.audioConfig=u,this.privVoiceAdapter.SpeakerAudioSource=d,this.privVoiceAdapter.enrollProfile(c)}async deleteProfileAsync(c){return this.privVoiceAdapter.deleteProfile(c)}async resetProfileAsync(c){return this.privVoiceAdapter.resetProfile(c)}async close(){await this.dispose(!0)}createServiceRecognizer(c,u,d,p){const v=d;return new i.VoiceServiceRecognizer(c,u,v,p,this)}async dispose(c){this.privDisposedVoiceAdapter||(this.privDisposedVoiceAdapter=!0,c&&await super.dispose(c))}createRecognizerConfig(c){return new i.RecognizerConfig(c,this.properties)}getResult(c,u){return new s.VoiceProfileResult(c.ok?u:s.ResultReason.Canceled,c.statusText)}};return VoiceProfileClient.VoiceProfileClient=o,VoiceProfileClient}var SpeakerRecognizer={},hasRequiredSpeakerRecognizer;function requireSpeakerRecognizer(){if(hasRequiredSpeakerRecognizer)return SpeakerRecognizer;hasRequiredSpeakerRecognizer=1,Object.defineProperty(SpeakerRecognizer,"__esModule",{value:!0}),SpeakerRecognizer.SpeakerRecognizer=void 0;const i=requireExports(),e=Contracts$1,t=requireExports$3();let s=class extends t.Recognizer{constructor(a,c){e.Contracts.throwIfNullOrUndefined(a,"speechConfig");const u=a;e.Contracts.throwIfNullOrUndefined(u,"speechConfig"),super(c,u.properties,new i.SpeakerRecognitionConnectionFactory),this.privAudioConfigImpl=c,e.Contracts.throwIfNull(this.privAudioConfigImpl,"audioConfig"),this.privDisposedSpeakerRecognizer=!1,this.privProperties=u.properties}get authorizationToken(){return this.properties.getProperty(t.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(a){e.Contracts.throwIfNullOrWhitespace(a,"token"),this.properties.setProperty(t.PropertyId.SpeechServiceAuthorization_Token,a)}get properties(){return this.privProperties}async recognizeOnceAsync(a){return e.Contracts.throwIfDisposed(this.privDisposedSpeakerRecognizer),this.recognizeSpeakerOnceAsyncImpl(a)}async close(){e.Contracts.throwIfDisposed(this.privDisposedSpeakerRecognizer),await this.dispose(!0)}async recognizeSpeakerOnceAsyncImpl(a){e.Contracts.throwIfDisposed(this.privDisposedSpeakerRecognizer),await this.implRecognizerStop();const c=await this.privReco.recognizeSpeaker(a);return await this.implRecognizerStop(),c}async implRecognizerStop(){this.privReco&&await this.privReco.stopRecognizing()}createRecognizerConfig(a){return new i.RecognizerConfig(a,this.privProperties)}createServiceRecognizer(a,c,u,d){const p=u;return new i.SpeakerServiceRecognizer(a,c,p,d,this)}async dispose(a){this.privDisposedSpeakerRecognizer||a&&(this.privDisposedSpeakerRecognizer=!0,await super.dispose(a))}};return SpeakerRecognizer.SpeakerRecognizer=s,SpeakerRecognizer}var SpeakerIdentificationModel={},hasRequiredSpeakerIdentificationModel;function requireSpeakerIdentificationModel(){if(hasRequiredSpeakerIdentificationModel)return SpeakerIdentificationModel;hasRequiredSpeakerIdentificationModel=1,Object.defineProperty(SpeakerIdentificationModel,"__esModule",{value:!0}),SpeakerIdentificationModel.SpeakerIdentificationModel=void 0;const i=Contracts$1,e=requireExports$3();let t=class Ae{constructor(o){if(this.privVoiceProfiles=[],this.privProfileIds=[],i.Contracts.throwIfNullOrUndefined(o,"VoiceProfiles"),o.length===0)throw new Error("Empty Voice Profiles array");for(const a of o){if(a.profileType!==e.VoiceProfileType.TextIndependentIdentification)throw new Error("Identification model can only be created from Identification profile: "+a.profileId);this.privVoiceProfiles.push(a),this.privProfileIds.push(a.profileId)}}static fromProfiles(o){return new Ae(o)}get voiceProfileIds(){return this.privProfileIds.join(",")}get profileIds(){return this.privProfileIds}get scenario(){return"TextIndependentIdentification"}};return SpeakerIdentificationModel.SpeakerIdentificationModel=t,SpeakerIdentificationModel}var SpeakerVerificationModel={},hasRequiredSpeakerVerificationModel;function requireSpeakerVerificationModel(){if(hasRequiredSpeakerVerificationModel)return SpeakerVerificationModel;hasRequiredSpeakerVerificationModel=1,Object.defineProperty(SpeakerVerificationModel,"__esModule",{value:!0}),SpeakerVerificationModel.SpeakerVerificationModel=void 0;const i=Contracts$1,e=requireExports$3();let t=class we{constructor(o){if(i.Contracts.throwIfNullOrUndefined(o,"VoiceProfile"),o.profileType===e.VoiceProfileType.TextIndependentIdentification)throw new Error("Verification model cannot be created from Identification profile");this.privVoiceProfile=o}static fromProfile(o){return new we(o)}get voiceProfile(){return this.privVoiceProfile}get profileIds(){return[this.voiceProfile.profileId]}get scenario(){return this.voiceProfile.profileType===e.VoiceProfileType.TextDependentVerification?"TextDependentVerification":"TextIndependentVerification"}};return SpeakerVerificationModel.SpeakerVerificationModel=t,SpeakerVerificationModel}var AutoDetectSourceLanguageConfig={},LanguageIdMode={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.LanguageIdMode=void 0,function(e){e[e.AtStart=0]="AtStart",e[e.Continuous=1]="Continuous"}(i.LanguageIdMode||(i.LanguageIdMode={}))})(LanguageIdMode);var hasRequiredAutoDetectSourceLanguageConfig;function requireAutoDetectSourceLanguageConfig(){if(hasRequiredAutoDetectSourceLanguageConfig)return AutoDetectSourceLanguageConfig;hasRequiredAutoDetectSourceLanguageConfig=1,Object.defineProperty(AutoDetectSourceLanguageConfig,"__esModule",{value:!0}),AutoDetectSourceLanguageConfig.AutoDetectSourceLanguageConfig=void 0;const i=requireExports(),e=Contracts$1,t=requireExports$3(),s=LanguageIdMode;let o=class ie{constructor(){this.privProperties=new t.PropertyCollection,this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_LanguageIdMode,"AtStart"),this.privLanguageIdMode=s.LanguageIdMode.AtStart}static fromOpenRange(){const c=new ie;return c.properties.setProperty(t.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages,i.AutoDetectSourceLanguagesOpenRangeOptionName),c}static fromLanguages(c){e.Contracts.throwIfArrayEmptyOrWhitespace(c,"languages");const u=new ie;return u.properties.setProperty(t.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages,c.join()),u}static fromSourceLanguageConfigs(c){if(c.length<1)throw new Error("Expected non-empty SourceLanguageConfig array.");const u=new ie,d=[];return c.forEach(p=>{if(d.push(p.language),p.endpointId!==void 0&&p.endpointId!==""){const v=p.language+t.PropertyId.SpeechServiceConnection_EndpointId.toString();u.properties.setProperty(v,p.endpointId)}}),u.properties.setProperty(t.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages,d.join()),u}get properties(){return this.privProperties}set mode(c){c===s.LanguageIdMode.Continuous?(this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_RecognitionEndpointVersion,"2"),this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_LanguageIdMode,"Continuous")):(this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_RecognitionEndpointVersion,"1"),this.privProperties.setProperty(t.PropertyId.SpeechServiceConnection_LanguageIdMode,"AtStart")),this.privLanguageIdMode=c}};return AutoDetectSourceLanguageConfig.AutoDetectSourceLanguageConfig=o,AutoDetectSourceLanguageConfig}var AutoDetectSourceLanguageResult$1={};Object.defineProperty(AutoDetectSourceLanguageResult$1,"__esModule",{value:!0});AutoDetectSourceLanguageResult$1.AutoDetectSourceLanguageResult=void 0;const Contracts_js_1$2=Contracts$1;class AutoDetectSourceLanguageResult{constructor(e,t){Contracts_js_1$2.Contracts.throwIfNullOrUndefined(e,"language"),Contracts_js_1$2.Contracts.throwIfNullOrUndefined(t,"languageDetectionConfidence"),this.privLanguage=e,this.privLanguageDetectionConfidence=t}static fromResult(e){return new AutoDetectSourceLanguageResult(e.language,e.languageDetectionConfidence)}static fromConversationTranscriptionResult(e){return new AutoDetectSourceLanguageResult(e.language,e.languageDetectionConfidence)}get language(){return this.privLanguage}get languageDetectionConfidence(){return this.privLanguageDetectionConfidence}}AutoDetectSourceLanguageResult$1.AutoDetectSourceLanguageResult=AutoDetectSourceLanguageResult;var SourceLanguageConfig$1={};Object.defineProperty(SourceLanguageConfig$1,"__esModule",{value:!0});SourceLanguageConfig$1.SourceLanguageConfig=void 0;const Contracts_js_1$1=Contracts$1;class SourceLanguageConfig{constructor(e,t){Contracts_js_1$1.Contracts.throwIfNullOrUndefined(e,"language"),this.privLanguage=e,this.privEndpointId=t}static fromLanguage(e,t){return new SourceLanguageConfig(e,t)}get language(){return this.privLanguage}get endpointId(){return this.privEndpointId}}SourceLanguageConfig$1.SourceLanguageConfig=SourceLanguageConfig;var SpeakerRecognitionResult={},hasRequiredSpeakerRecognitionResult;function requireSpeakerRecognitionResult(){return hasRequiredSpeakerRecognitionResult||(hasRequiredSpeakerRecognitionResult=1,function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.SpeakerRecognitionCancellationDetails=i.SpeakerRecognitionResult=i.SpeakerRecognitionResultType=void 0;const e=requireExports(),t=requireExports$3();var s;(function(c){c[c.Verify=0]="Verify",c[c.Identify=1]="Identify"})(s=i.SpeakerRecognitionResultType||(i.SpeakerRecognitionResultType={}));class o{constructor(u,d=t.ResultReason.RecognizedSpeaker,p=t.CancellationErrorCode.NoError,v=""){this.privProperties=new t.PropertyCollection;const g=u.scenario==="TextIndependentIdentification"?s.Identify:s.Verify;this.privReason=d,this.privReason!==t.ResultReason.Canceled?g===s.Identify?(this.privProfileId=u.identificationResult.identifiedProfile.profileId,this.privScore=u.identificationResult.identifiedProfile.score,this.privReason=t.ResultReason.RecognizedSpeakers):(this.privScore=u.verificationResult.score,u.verificationResult.recognitionResult.toLowerCase()!=="accept"&&(this.privReason=t.ResultReason.NoMatch),u.verificationResult.profileId!==void 0&&u.verificationResult.profileId!==""&&(this.privProfileId=u.verificationResult.profileId)):(this.privErrorDetails=v,this.privProperties.setProperty(e.CancellationErrorCodePropertyName,t.CancellationErrorCode[p])),this.privProperties.setProperty(t.PropertyId.SpeechServiceResponse_JsonResult,JSON.stringify(u))}get properties(){return this.privProperties}get reason(){return this.privReason}get profileId(){return this.privProfileId}get errorDetails(){return this.privErrorDetails}get score(){return this.privScore}}i.SpeakerRecognitionResult=o;class a extends t.CancellationDetailsBase{constructor(u,d,p){super(u,d,p)}static fromResult(u){const d=t.CancellationReason.Error;let p=t.CancellationErrorCode.NoError;return u.properties&&(p=t.CancellationErrorCode[u.properties.getProperty(e.CancellationErrorCodePropertyName,t.CancellationErrorCode[t.CancellationErrorCode.NoError])]),new a(d,u.errorDetails,p)}}i.SpeakerRecognitionCancellationDetails=a}(SpeakerRecognitionResult)),SpeakerRecognitionResult}var Exports$2={},Conversation={},hasRequiredConversation;function requireConversation(){if(hasRequiredConversation)return Conversation;hasRequiredConversation=1,Object.defineProperty(Conversation,"__esModule",{value:!0}),Conversation.ConversationImpl=Conversation.Conversation=void 0;const i=requireExports(),e=requireExports$5(),t=Contracts$1,s=requireExports$3();let o=class{constructor(){}static createConversationAsync(u,d,p,v){t.Contracts.throwIfNullOrUndefined(u,i.ConversationConnectionConfig.restErrors.invalidArgs.replace("{arg}","config")),t.Contracts.throwIfNullOrUndefined(u.region,i.ConversationConnectionConfig.restErrors.invalidArgs.replace("{arg}","SpeechServiceConnection_Region")),!u.subscriptionKey&&!u.getProperty(s.PropertyId[s.PropertyId.SpeechServiceAuthorization_Token])&&t.Contracts.throwIfNullOrUndefined(u.subscriptionKey,i.ConversationConnectionConfig.restErrors.invalidArgs.replace("{arg}","SpeechServiceConnection_Key"));let g,m,S;return typeof d=="string"?(g=new a(u,d),e.marshalPromiseToCallbacks((async()=>{})(),p,v)):(g=new a(u),m=d,S=p,g.createConversationAsync(()=>{m&&m()},y=>{S&&S(y)})),g}};Conversation.Conversation=o;class a extends o{constructor(u,d){if(super(),this.privErrors=i.ConversationConnectionConfig.restErrors,this.onConnected=g=>{var m;this.privIsConnected=!0;try{(m=this.privConversationTranslator)!=null&&m.sessionStarted&&this.privConversationTranslator.sessionStarted(this.privConversationTranslator,g)}catch{}},this.onDisconnected=g=>{var m;try{(m=this.privConversationTranslator)!=null&&m.sessionStopped&&this.privConversationTranslator.sessionStopped(this.privConversationTranslator,g)}catch{}finally{this.close(!1)}},this.onCanceled=(g,m)=>{var S;try{(S=this.privConversationTranslator)!=null&&S.canceled&&this.privConversationTranslator.canceled(this.privConversationTranslator,m)}catch{}},this.onParticipantUpdateCommandReceived=(g,m)=>{try{const S=this.privParticipants.getParticipant(m.id);if(S!==void 0){switch(m.key){case i.ConversationTranslatorCommandTypes.changeNickname:S.displayName=m.value;break;case i.ConversationTranslatorCommandTypes.setUseTTS:S.isUsingTts=m.value;break;case i.ConversationTranslatorCommandTypes.setProfanityFiltering:S.profanity=m.value;break;case i.ConversationTranslatorCommandTypes.setMute:S.isMuted=m.value;break;case i.ConversationTranslatorCommandTypes.setTranslateToLanguages:S.translateToLanguages=m.value;break}this.privParticipants.addOrUpdateParticipant(S),this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.Updated,[this.toParticipant(S)],m.sessionId))}}catch{}},this.onLockRoomCommandReceived=()=>{},this.onMuteAllCommandReceived=(g,m)=>{try{this.privParticipants.participants.forEach(S=>S.isMuted=S.isHost?!1:m.isMuted),this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.Updated,this.toParticipants(!1),m.sessionId))}catch{}},this.onParticipantJoinCommandReceived=(g,m)=>{try{const S=this.privParticipants.addOrUpdateParticipant(m.participant);S!==void 0&&this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.JoinedConversation,[this.toParticipant(S)],m.sessionId))}catch{}},this.onParticipantLeaveCommandReceived=(g,m)=>{try{const S=this.privParticipants.getParticipant(m.participant.id);S!==void 0&&(this.privParticipants.deleteParticipant(m.participant.id),this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.LeftConversation,[this.toParticipant(S)],m.sessionId)))}catch{}},this.onTranslationReceived=(g,m)=>{try{switch(m.command){case i.ConversationTranslatorMessageTypes.final:this.privConversationTranslator&&this.privConversationTranslator.transcribed(this.privConversationTranslator,new s.ConversationTranslationEventArgs(m.payload,void 0,m.sessionId));break;case i.ConversationTranslatorMessageTypes.partial:this.privConversationTranslator&&this.privConversationTranslator.transcribing(this.privConversationTranslator,new s.ConversationTranslationEventArgs(m.payload,void 0,m.sessionId));break;case i.ConversationTranslatorMessageTypes.instantMessage:this.privConversationTranslator&&this.privConversationTranslator.textMessageReceived(this.privConversationTranslator,new s.ConversationTranslationEventArgs(m.payload,void 0,m.sessionId));break}}catch{}},this.onParticipantsListReceived=(g,m)=>{var S;try{if(m.sessionToken!==void 0&&m.sessionToken!==null&&(this.privRoom.token=m.sessionToken),this.privParticipants.participants=[...m.participants],this.privParticipants.me!==void 0&&(this.privIsReady=!0),this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.JoinedConversation,this.toParticipants(!0),m.sessionId)),this.me.isHost){const y=(S=this.privConversationTranslator)==null?void 0:S.properties.getProperty(s.PropertyId.ConversationTranslator_Name);y!==void 0&&y.length>0&&y!==this.me.displayName&&this.changeNicknameAsync(y)}}catch{}},this.onConversationExpiration=(g,m)=>{try{this.privConversationTranslator&&this.privConversationTranslator.conversationExpiration(this.privConversationTranslator,m)}catch{}},this.privIsConnected=!1,this.privIsDisposed=!1,this.privConversationId="",this.privProperties=new s.PropertyCollection,this.privManager=new i.ConversationManager,u.getProperty(s.PropertyId[s.PropertyId.SpeechServiceConnection_RecoLanguage])||u.setProperty(s.PropertyId[s.PropertyId.SpeechServiceConnection_RecoLanguage],i.ConversationConnectionConfig.defaultLanguageCode),this.privLanguage=u.getProperty(s.PropertyId[s.PropertyId.SpeechServiceConnection_RecoLanguage]),d)this.privConversationId=d;else{u.targetLanguages.length===0&&u.addTargetLanguage(this.privLanguage),u.getProperty(s.PropertyId[s.PropertyId.SpeechServiceResponse_ProfanityOption])||u.setProfanity(s.ProfanityOption.Masked);let m=u.getProperty(s.PropertyId[s.PropertyId.ConversationTranslator_Name]);m==null&&(m="Host"),t.Contracts.throwIfNullOrTooLong(m,"nickname",50),t.Contracts.throwIfNullOrTooShort(m,"nickname",2),u.setProperty(s.PropertyId[s.PropertyId.ConversationTranslator_Name],m)}this.privConfig=u;const v=u;t.Contracts.throwIfNull(v,"speechConfig"),this.privProperties=v.properties.clone(),this.privIsConnected=!1,this.privParticipants=new i.InternalParticipants,this.privIsReady=!1,this.privTextMessageMaxLength=1e3}get room(){return this.privRoom}get connection(){return this.privConversationRecognizer}get config(){return this.privConfig}get conversationId(){return this.privRoom?this.privRoom.roomId:this.privConversationId}get properties(){return this.privProperties}get speechRecognitionLanguage(){return this.privLanguage}get isMutedByHost(){var u,d;return(u=this.privParticipants.me)!=null&&u.isHost?!1:(d=this.privParticipants.me)==null?void 0:d.isMuted}get isConnected(){return this.privIsConnected&&this.privIsReady}get participants(){return this.toParticipants(!0)}get me(){return this.toParticipant(this.privParticipants.me)}get host(){return this.toParticipant(this.privParticipants.host)}get transcriberRecognizer(){return this.privTranscriberRecognizer}get conversationInfo(){const u=this.conversationId,d=this.participants.map(g=>({id:g.id,preferredLanguage:g.preferredLanguage,voice:g.voice})),p={};for(const g of i.ConversationConnectionConfig.transcriptionEventKeys){const m=this.properties.getProperty(g,"");m!==""&&(p[g]=m)}return{id:u,participants:d,conversationProperties:p}}get canSend(){var u;return this.privIsConnected&&!((u=this.privParticipants.me)!=null&&u.isMuted)}get canSendAsHost(){var u;return this.privIsConnected&&((u=this.privParticipants.me)==null?void 0:u.isHost)}get authorizationToken(){return this.privToken}set authorizationToken(u){t.Contracts.throwIfNullOrWhitespace(u,"authorizationToken"),this.privToken=u}set conversationTranslator(u){this.privConversationTranslator=u}onToken(u){this.privConversationTranslator.onToken(u)}createConversationAsync(u,d){try{this.privConversationRecognizer&&this.handleError(new Error(this.privErrors.permissionDeniedStart),d),this.privManager.createOrJoin(this.privProperties,void 0,p=>{p||this.handleError(new Error(this.privErrors.permissionDeniedConnect),d),this.privRoom=p,this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}startConversationAsync(u,d){try{this.privConversationRecognizer&&this.handleError(new Error(this.privErrors.permissionDeniedStart),d),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedConnect),this.privParticipants.meId=this.privRoom.participantId,this.privConversationRecognizer=i.ConversationRecognizerFactory.fromConfig(this,this.privConfig),this.privConversationRecognizer.connected=this.onConnected,this.privConversationRecognizer.disconnected=this.onDisconnected,this.privConversationRecognizer.canceled=this.onCanceled,this.privConversationRecognizer.participantUpdateCommandReceived=this.onParticipantUpdateCommandReceived,this.privConversationRecognizer.lockRoomCommandReceived=this.onLockRoomCommandReceived,this.privConversationRecognizer.muteAllCommandReceived=this.onMuteAllCommandReceived,this.privConversationRecognizer.participantJoinCommandReceived=this.onParticipantJoinCommandReceived,this.privConversationRecognizer.participantLeaveCommandReceived=this.onParticipantLeaveCommandReceived,this.privConversationRecognizer.translationReceived=this.onTranslationReceived,this.privConversationRecognizer.participantsListReceived=this.onParticipantsListReceived,this.privConversationRecognizer.conversationExpiration=this.onConversationExpiration,this.privConversationRecognizer.connect(this.privRoom.token,()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}addParticipantAsync(u,d,p){t.Contracts.throwIfNullOrUndefined(u,"Participant"),e.marshalPromiseToCallbacks(this.addParticipantImplAsync(u),d,p)}joinConversationAsync(u,d,p,v,g){try{t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","conversationId")),t.Contracts.throwIfNullOrWhitespace(d,this.privErrors.invalidArgs.replace("{arg}","nickname")),t.Contracts.throwIfNullOrWhitespace(p,this.privErrors.invalidArgs.replace("{arg}","language")),this.privManager.createOrJoin(this.privProperties,u,m=>{t.Contracts.throwIfNullOrUndefined(m,this.privErrors.permissionDeniedConnect),this.privRoom=m,this.privConfig.authorizationToken=m.cognitiveSpeechAuthToken,v&&v(m.cognitiveSpeechAuthToken)},m=>{this.handleError(m,g)})}catch(m){this.handleError(m,g)}}deleteConversationAsync(u,d){e.marshalPromiseToCallbacks(this.deleteConversationImplAsync(),u,d)}async deleteConversationImplAsync(){t.Contracts.throwIfNullOrUndefined(this.privProperties,this.privErrors.permissionDeniedConnect),t.Contracts.throwIfNullOrWhitespace(this.privRoom.token,this.privErrors.permissionDeniedConnect),await this.privManager.leave(this.privProperties,this.privRoom.token),this.dispose()}endConversationAsync(u,d){e.marshalPromiseToCallbacks(this.endConversationImplAsync(),u,d)}endConversationImplAsync(){return this.close(!0)}lockConversationAsync(u,d){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedConversation.replace("{command}","lock")),d),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getLockCommand(!0),()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}muteAllParticipantsAsync(u,d){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privConversationRecognizer,this.privErrors.permissionDeniedSend),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedConversation.replace("{command}","mute")),d),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMuteAllCommand(!0),()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}muteParticipantAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","userId")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),!this.me.isHost&&this.me.id!==u&&this.handleError(new Error(this.privErrors.permissionDeniedParticipant.replace("{command}","mute")),p),this.privParticipants.getParticipantIndex(u)===-1&&this.handleError(new Error(this.privErrors.invalidParticipantRequest),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMuteCommand(u,!0),()=>{this.handleCallback(d,p)},g=>{this.handleError(g,p)})}catch(v){this.handleError(v,p)}}removeParticipantAsync(u,d,p){try{if(t.Contracts.throwIfDisposed(this.privIsDisposed),this.privTranscriberRecognizer&&u.hasOwnProperty("id"))e.marshalPromiseToCallbacks(this.removeParticipantImplAsync(u),d,p);else{t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedParticipant.replace("{command}","remove")),p);let v="";typeof u=="string"?v=u:u.hasOwnProperty("id")?v=u.id:u.hasOwnProperty("userId")&&(v=u.userId),t.Contracts.throwIfNullOrWhitespace(v,this.privErrors.invalidArgs.replace("{arg}","userId")),this.participants.findIndex(m=>m.id===v)===-1&&this.handleError(new Error(this.privErrors.invalidParticipantRequest),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getEjectCommand(v),()=>{this.handleCallback(d,p)},m=>{this.handleError(m,p)})}}catch(v){this.handleError(v,p)}}unlockConversationAsync(u,d){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedConversation.replace("{command}","unlock")),d),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getLockCommand(!1),()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}unmuteAllParticipantsAsync(u,d){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedConversation.replace("{command}","unmute all")),d),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMuteAllCommand(!1),()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}unmuteParticipantAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","userId")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),!this.me.isHost&&this.me.id!==u&&this.handleError(new Error(this.privErrors.permissionDeniedParticipant.replace("{command}","mute")),p),this.privParticipants.getParticipantIndex(u)===-1&&this.handleError(new Error(this.privErrors.invalidParticipantRequest),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMuteCommand(u,!1),()=>{this.handleCallback(d,p)},g=>{this.handleError(g,p)})}catch(v){this.handleError(v,p)}}sendTextMessageAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","message")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),u.length>this.privTextMessageMaxLength&&this.handleError(new Error(this.privErrors.invalidArgs.replace("{arg}","message length")),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMessageCommand(u),()=>{this.handleCallback(d,p)},v=>{this.handleError(v,p)})}catch(v){this.handleError(v,p)}}setTranslatedLanguagesAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfArrayEmptyOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","languages")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getSetTranslateToLanguagesCommand(u),()=>{this.handleCallback(d,p)},v=>{this.handleError(v,p)})}catch(v){this.handleError(v,p)}}changeNicknameAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","nickname")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getChangeNicknameCommand(u),()=>{this.handleCallback(d,p)},v=>{this.handleError(v,p)})}catch(v){this.handleError(v,p)}}isDisposed(){return this.privIsDisposed}dispose(){this.isDisposed||(this.privIsDisposed=!0,this.config&&this.config.close(),this.privConfig=void 0,this.privLanguage=void 0,this.privProperties=void 0,this.privRoom=void 0,this.privToken=void 0,this.privManager=void 0,this.privIsConnected=!1,this.privIsReady=!1,this.privParticipants=void 0)}async connectTranscriberRecognizer(u){this.privTranscriberRecognizer&&await this.privTranscriberRecognizer.close(),await u.enforceAudioGating(),this.privTranscriberRecognizer=u,this.privTranscriberRecognizer.conversation=this}getKeepAlive(){const u=this.me?this.me.displayName:"default_nickname";return JSON.stringify({id:"0",nickname:u,participantId:this.privRoom.participantId,roomId:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.keepAlive})}addParticipantImplAsync(u){if(this.privParticipants.addOrUpdateParticipant(u)!==void 0&&this.privTranscriberRecognizer){const p=this.conversationInfo;return p.participants=[u],this.privTranscriberRecognizer.pushConversationEvent(p,"join")}}removeParticipantImplAsync(u){this.privParticipants.deleteParticipant(u.id);const d=this.conversationInfo;return d.participants=[u],this.privTranscriberRecognizer.pushConversationEvent(d,"leave")}async close(u){var d;try{this.privIsConnected=!1,await((d=this.privConversationRecognizer)==null?void 0:d.close()),this.privConversationRecognizer=void 0,this.privConversationTranslator&&this.privConversationTranslator.dispose()}catch(p){throw p}u&&this.dispose()}handleCallback(u,d){if(u){try{u()}catch(p){d&&d(p)}u=void 0}}handleError(u,d){if(d)if(u instanceof Error){const p=u;d(p.name+": "+p.message)}else d(u)}toParticipants(u){const d=this.privParticipants.participants.map(p=>this.toParticipant(p));return u?d:d.filter(p=>p.isHost===!1)}toParticipant(u){return new s.Participant(u.id,u.avatar,u.displayName,u.isHost,u.isMuted,u.isUsingTts,u.preferredLanguage,u.voice)}getMuteAllCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"conversationId"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.setMuteAll,participantId:this.privRoom.participantId,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:u})}getMuteCommand(u,d){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"conversationId"),t.Contracts.throwIfNullOrWhitespace(u,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.setMute,participantId:u,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:d})}getLockCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"conversationId"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.setLockState,participantId:this.privRoom.participantId,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:u})}getEjectCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"conversationId"),t.Contracts.throwIfNullOrWhitespace(u,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.ejectParticipant,participantId:u,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand})}getSetTranslateToLanguagesCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"conversationId"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.setTranslateToLanguages,participantId:this.privRoom.participantId,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:u})}getChangeNicknameCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"conversationId"),t.Contracts.throwIfNullOrWhitespace(u,"nickname"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.changeNickname,nickname:u,participantId:this.privRoom.participantId,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:u})}getMessageCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"conversationId"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),t.Contracts.throwIfNullOrWhitespace(u,"message"),JSON.stringify({participantId:this.privRoom.participantId,roomId:this.privRoom.roomId,text:u,type:i.ConversationTranslatorMessageTypes.instantMessage})}}return Conversation.ConversationImpl=a,Conversation}var ConversationCommon$1={};Object.defineProperty(ConversationCommon$1,"__esModule",{value:!0});ConversationCommon$1.ConversationCommon=void 0;class ConversationCommon{constructor(e){this.privAudioConfig=e}handleCallback(e,t){if(e){try{e()}catch(s){t&&t(s)}e=void 0}}handleError(e,t){if(t)if(e instanceof Error){const s=e;t(s.name+": "+s.message)}else t(e)}}ConversationCommon$1.ConversationCommon=ConversationCommon;var ConversationExpirationEventArgs={},hasRequiredConversationExpirationEventArgs;function requireConversationExpirationEventArgs(){if(hasRequiredConversationExpirationEventArgs)return ConversationExpirationEventArgs;hasRequiredConversationExpirationEventArgs=1,Object.defineProperty(ConversationExpirationEventArgs,"__esModule",{value:!0}),ConversationExpirationEventArgs.ConversationExpirationEventArgs=void 0;const i=requireExports$3();let e=class extends i.SessionEventArgs{constructor(s,o){super(o),this.privExpirationTime=s}get expirationTime(){return this.privExpirationTime}};return ConversationExpirationEventArgs.ConversationExpirationEventArgs=e,ConversationExpirationEventArgs}var ConversationParticipantsChangedEventArgs={},hasRequiredConversationParticipantsChangedEventArgs;function requireConversationParticipantsChangedEventArgs(){if(hasRequiredConversationParticipantsChangedEventArgs)return ConversationParticipantsChangedEventArgs;hasRequiredConversationParticipantsChangedEventArgs=1,Object.defineProperty(ConversationParticipantsChangedEventArgs,"__esModule",{value:!0}),ConversationParticipantsChangedEventArgs.ConversationParticipantsChangedEventArgs=void 0;const i=requireExports$3();let e=class extends i.SessionEventArgs{constructor(s,o,a){super(a),this.privReason=s,this.privParticipant=o}get reason(){return this.privReason}get participants(){return this.privParticipant}};return ConversationParticipantsChangedEventArgs.ConversationParticipantsChangedEventArgs=e,ConversationParticipantsChangedEventArgs}var ConversationTranslationCanceledEventArgs={},hasRequiredConversationTranslationCanceledEventArgs;function requireConversationTranslationCanceledEventArgs(){if(hasRequiredConversationTranslationCanceledEventArgs)return ConversationTranslationCanceledEventArgs;hasRequiredConversationTranslationCanceledEventArgs=1,Object.defineProperty(ConversationTranslationCanceledEventArgs,"__esModule",{value:!0}),ConversationTranslationCanceledEventArgs.ConversationTranslationCanceledEventArgs=void 0;const i=requireCancellationEventArgsBase();let e=class extends i.CancellationEventArgsBase{};return ConversationTranslationCanceledEventArgs.ConversationTranslationCanceledEventArgs=e,ConversationTranslationCanceledEventArgs}var ConversationTranslationEventArgs={},hasRequiredConversationTranslationEventArgs;function requireConversationTranslationEventArgs(){if(hasRequiredConversationTranslationEventArgs)return ConversationTranslationEventArgs;hasRequiredConversationTranslationEventArgs=1,Object.defineProperty(ConversationTranslationEventArgs,"__esModule",{value:!0}),ConversationTranslationEventArgs.ConversationTranslationEventArgs=void 0;const i=requireExports$3();let e=class extends i.RecognitionEventArgs{constructor(s,o,a){super(o,a),this.privResult=s}get result(){return this.privResult}};return ConversationTranslationEventArgs.ConversationTranslationEventArgs=e,ConversationTranslationEventArgs}var ConversationTranslationResult={},hasRequiredConversationTranslationResult;function requireConversationTranslationResult(){if(hasRequiredConversationTranslationResult)return ConversationTranslationResult;hasRequiredConversationTranslationResult=1,Object.defineProperty(ConversationTranslationResult,"__esModule",{value:!0}),ConversationTranslationResult.ConversationTranslationResult=void 0;const i=requireTranslationRecognitionResult();let e=class extends i.TranslationRecognitionResult{constructor(s,o,a,c,u,d,p,v,g,m,S){super(o,c,u,d,p,v,void 0,void 0,g,m,S),this.privId=s,this.privOrigLang=a}get participantId(){return this.privId}get originalLang(){return this.privOrigLang}};return ConversationTranslationResult.ConversationTranslationResult=e,ConversationTranslationResult}var ConversationTranslator={},ConversationTranslatorConnectionFactory={},StringUtils$1={};Object.defineProperty(StringUtils$1,"__esModule",{value:!0});StringUtils$1.StringUtils=void 0;class StringUtils{static formatString(e,t){if(!e)return"";if(!t)return e;let s="",o="";const a=d=>{s+=d},c=d=>{o+=d};let u=a;for(let d=0;d<e.length;d++){const p=e[d],v=d+1<e.length?e[d+1]:"";switch(p){case"{":v==="{"?(u("{"),d++):u=c;break;case"}":v==="}"?(u("}"),d++):(t.hasOwnProperty(o)&&(s+=t[o]),u=a,o="");break;default:u(p);break}}return s}}StringUtils$1.StringUtils=StringUtils;var hasRequiredConversationTranslatorConnectionFactory;function requireConversationTranslatorConnectionFactory(){if(hasRequiredConversationTranslatorConnectionFactory)return ConversationTranslatorConnectionFactory;hasRequiredConversationTranslatorConnectionFactory=1,Object.defineProperty(ConversationTranslatorConnectionFactory,"__esModule",{value:!0}),ConversationTranslatorConnectionFactory.ConversationTranslatorConnectionFactory=void 0;const i=requireExports$2(),e=StringUtils$1,t=Contracts$1,s=requireExports$3(),o=HeaderNames$1,a=QueryParameterNames$1,c=requireConnectionFactoryBase(),u=requireExports();let d=class Ie extends c.ConnectionFactoryBase{constructor(v){super(),t.Contracts.throwIfNullOrUndefined(v,"convGetter"),this.privConvGetter=v}create(v,g,m){const S=v.parameters.getProperty("ConversationTranslator_MultiChannelAudio","").toUpperCase()==="TRUE",y=this.privConvGetter().room,C=y.cognitiveSpeechRegion||v.parameters.getProperty(s.PropertyId.SpeechServiceConnection_Region,""),R={hostSuffix:c.ConnectionFactoryBase.getHostSuffix(C),path:Ie.CTS_VIRT_MIC_PATH,region:encodeURIComponent(C)};R[a.QueryParameterNames.Language]=encodeURIComponent(v.parameters.getProperty(s.PropertyId.SpeechServiceConnection_RecoLanguage,"")),R[a.QueryParameterNames.CtsMeetingId]=encodeURIComponent(y.roomId),R[a.QueryParameterNames.CtsDeviceId]=encodeURIComponent(y.participantId),R[a.QueryParameterNames.CtsIsParticipant]=y.isHost?"":"&"+a.QueryParameterNames.CtsIsParticipant;let T="";const E={},A={};if(S){T=v.parameters.getProperty(s.PropertyId.SpeechServiceConnection_Endpoint),T||(T="wss://"+v.parameters.getProperty(s.PropertyId.SpeechServiceConnection_Host,"transcribe.{region}.cts.speech{hostSuffix}")+"{path}"),T=e.StringUtils.formatString(T,R);const P=new URL(T);P.searchParams.forEach((w,I)=>{E[I]=w}),new u.TranscriberConnectionFactory().setQueryParams(E,v,T),E[a.QueryParameterNames.CtsMeetingId]=R[a.QueryParameterNames.CtsMeetingId],E[a.QueryParameterNames.CtsDeviceId]=R[a.QueryParameterNames.CtsDeviceId],y.isHost||(E[a.QueryParameterNames.CtsIsParticipant]=""),a.QueryParameterNames.Format in E||(E[a.QueryParameterNames.Format]="simple"),P.searchParams.forEach((w,I)=>{P.searchParams.set(I,E[I]),delete E[I]}),T=P.toString()}else{const P=new u.TranslationConnectionFactory;T=P.getEndpointUrl(v,!0),T=e.StringUtils.formatString(T,R),P.setQueryParams(E,v,T)}A[o.HeaderNames.ConnectionId]=m,A[i.RestConfigBase.configParams.token]=y.token,g.token&&(A[g.headerName]=g.token);const b=v.parameters.getProperty("SPEECH-EnableWebsocketCompression","").toUpperCase()==="TRUE";return new i.WebsocketConnection(T,E,A,new u.WebsocketMessageFormatter,i.ProxyInfo.fromRecognizerConfig(v),b,m)}};return ConversationTranslatorConnectionFactory.ConversationTranslatorConnectionFactory=d,d.CTS_VIRT_MIC_PATH="/speech/recognition/dynamicaudio",ConversationTranslatorConnectionFactory}var hasRequiredConversationTranslator;function requireConversationTranslator(){return hasRequiredConversationTranslator||(hasRequiredConversationTranslator=1,function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.ConversationTranslator=i.SpeechState=void 0;const e=requireExports(),t=requireConversationTranslatorConnectionFactory(),s=requireExports$5(),o=Contracts$1,a=requireExports$3(),c=requireConversation(),u=requireExports$4();var d;(function(g){g[g.Inactive=0]="Inactive",g[g.Connecting=1]="Connecting",g[g.Connected=2]="Connected"})(d=i.SpeechState||(i.SpeechState={}));class p extends a.TranslationRecognizer{constructor(m,S,y,C){super(m,S,new t.ConversationTranslatorConnectionFactory(C)),this.privSpeechState=d.Inactive,y&&(this.privTranslator=y,this.sessionStarted=()=>{this.privSpeechState=d.Connected},this.sessionStopped=()=>{this.privSpeechState=d.Inactive},this.recognizing=(R,T)=>{this.privTranslator.recognizing&&this.privTranslator.recognizing(this.privTranslator,T)},this.recognized=async(R,T)=>{var E;(E=T.result)!=null&&E.errorDetails?(await this.cancelSpeech(),this.fireCancelEvent(T.result.errorDetails)):this.privTranslator.recognized&&this.privTranslator.recognized(this.privTranslator,T)},this.canceled=async()=>{if(this.privSpeechState!==d.Inactive)try{await this.cancelSpeech()}catch{this.privSpeechState=d.Inactive}})}get state(){return this.privSpeechState}set state(m){this.privSpeechState=m}set authentication(m){this.privReco.authentication=m}onConnection(){this.privSpeechState=d.Connected}async onCancelSpeech(){this.privSpeechState=d.Inactive,await this.cancelSpeech()}fireCancelEvent(m){try{if(this.privTranslator.canceled){const S=new u.ConversationTranslationCanceledEventArgs(a.CancellationReason.Error,m,a.CancellationErrorCode.RuntimeError);this.privTranslator.canceled(this.privTranslator,S)}}catch{}}async cancelSpeech(){var m;try{this.stopContinuousRecognitionAsync(),await((m=this.privReco)==null?void 0:m.disconnect()),this.privSpeechState=d.Inactive}catch{}}}class v extends u.ConversationCommon{constructor(m){super(m),this.privErrors=e.ConversationConnectionConfig.restErrors,this.privIsDisposed=!1,this.privIsSpeaking=!1,this.privPlaceholderKey="abcdefghijklmnopqrstuvwxyz012345",this.privPlaceholderRegion="westus",this.privProperties=new a.PropertyCollection}get properties(){return this.privProperties}get speechRecognitionLanguage(){return this.privSpeechRecognitionLanguage}get participants(){var m;return(m=this.privConversation)==null?void 0:m.participants}get canSpeak(){return!(!this.privConversation.isConnected||!this.privCTRecognizer||this.privIsSpeaking||this.privCTRecognizer.state===d.Connected||this.privCTRecognizer.state===d.Connecting||this.privConversation.isMutedByHost)}onToken(m){this.privCTRecognizer.authentication=m}setServiceProperty(m,S){const y=JSON.parse(this.privProperties.getProperty(e.ServicePropertiesPropertyName,"{}"));y[m]=S,this.privProperties.setProperty(e.ServicePropertiesPropertyName,JSON.stringify(y))}joinConversationAsync(m,S,y,C,R){try{if(typeof m=="string"){o.Contracts.throwIfNullOrUndefined(m,this.privErrors.invalidArgs.replace("{arg}","conversation id")),o.Contracts.throwIfNullOrWhitespace(S,this.privErrors.invalidArgs.replace("{arg}","nickname")),this.privConversation&&this.handleError(new Error(this.privErrors.permissionDeniedStart),R);let T=y;(T==null||T==="")&&(T=e.ConversationConnectionConfig.defaultLanguageCode),this.privSpeechTranslationConfig=a.SpeechTranslationConfig.fromSubscription(this.privPlaceholderKey,this.privPlaceholderRegion),this.privSpeechTranslationConfig.setProfanity(a.ProfanityOption.Masked),this.privSpeechTranslationConfig.addTargetLanguage(T),this.privSpeechTranslationConfig.setProperty(a.PropertyId[a.PropertyId.SpeechServiceConnection_RecoLanguage],T),this.privSpeechTranslationConfig.setProperty(a.PropertyId[a.PropertyId.ConversationTranslator_Name],S);const E=[a.PropertyId.SpeechServiceConnection_Host,a.PropertyId.ConversationTranslator_Host,a.PropertyId.SpeechServiceConnection_Endpoint,a.PropertyId.SpeechServiceConnection_ProxyHostName,a.PropertyId.SpeechServiceConnection_ProxyPassword,a.PropertyId.SpeechServiceConnection_ProxyPort,a.PropertyId.SpeechServiceConnection_ProxyUserName,"ConversationTranslator_MultiChannelAudio","ConversationTranslator_Region"];for(const b of E){const P=this.privProperties.getProperty(b);if(P){const _=typeof b=="string"?b:a.PropertyId[b];this.privSpeechTranslationConfig.setProperty(_,P)}}const A=JSON.parse(this.privProperties.getProperty(e.ServicePropertiesPropertyName,"{}"));for(const b of Object.keys(A))this.privSpeechTranslationConfig.setServiceProperty(b,A[b],a.ServicePropertyChannel.UriQueryParameter);this.privConversation=new c.ConversationImpl(this.privSpeechTranslationConfig),this.privConversation.conversationTranslator=this,this.privConversation.joinConversationAsync(m,S,T,b=>{b||this.handleError(new Error(this.privErrors.permissionDeniedConnect),R),this.privSpeechTranslationConfig.authorizationToken=b,this.privConversation.room.isHost=!1,this.privConversation.startConversationAsync(()=>{this.handleCallback(C,R)},P=>{this.handleError(P,R)})},b=>{this.handleError(b,R)})}else typeof m=="object"?(o.Contracts.throwIfNullOrUndefined(m,this.privErrors.invalidArgs.replace("{arg}","conversation id")),o.Contracts.throwIfNullOrWhitespace(S,this.privErrors.invalidArgs.replace("{arg}","nickname")),this.privProperties.setProperty(a.PropertyId.ConversationTranslator_Name,S),this.privConversation=m,this.privConversation.conversationTranslator=this,this.privConversation.room.isHost=!0,o.Contracts.throwIfNullOrUndefined(this.privConversation,this.privErrors.permissionDeniedConnect),o.Contracts.throwIfNullOrUndefined(this.privConversation.room.token,this.privErrors.permissionDeniedConnect),this.privSpeechTranslationConfig=m.config,this.handleCallback(y,C)):this.handleError(new Error(this.privErrors.invalidArgs.replace("{arg}","invalid conversation type")),C)}catch(T){this.handleError(T,typeof y=="string"?R:C)}}leaveConversationAsync(m,S){s.marshalPromiseToCallbacks((async()=>{await this.cancelSpeech(),await this.privConversation.endConversationImplAsync(),await this.privConversation.deleteConversationImplAsync(),this.dispose()})(),m,S)}sendTextMessageAsync(m,S,y){try{o.Contracts.throwIfNullOrUndefined(this.privConversation,this.privErrors.permissionDeniedSend),o.Contracts.throwIfNullOrWhitespace(m,this.privErrors.invalidArgs.replace("{arg}",m)),this.privConversation.sendTextMessageAsync(m,S,y)}catch(C){this.handleError(C,y)}}startTranscribingAsync(m,S){s.marshalPromiseToCallbacks((async()=>{try{o.Contracts.throwIfNullOrUndefined(this.privConversation,this.privErrors.permissionDeniedSend),o.Contracts.throwIfNullOrUndefined(this.privConversation.room.token,this.privErrors.permissionDeniedConnect),this.privCTRecognizer===void 0&&await this.connectTranslatorRecognizer(),o.Contracts.throwIfNullOrUndefined(this.privCTRecognizer,this.privErrors.permissionDeniedSend),this.canSpeak||this.handleError(new Error(this.privErrors.permissionDeniedSend),S),await this.startContinuousRecognition(),this.privIsSpeaking=!0}catch(y){throw this.privIsSpeaking=!1,await this.cancelSpeech(),y}})(),m,S)}stopTranscribingAsync(m,S){s.marshalPromiseToCallbacks((async()=>{try{if(!this.privIsSpeaking){await this.cancelSpeech();return}this.privIsSpeaking=!1,await new Promise((y,C)=>{this.privCTRecognizer.stopContinuousRecognitionAsync(y,C)})}catch{await this.cancelSpeech()}})(),m,S)}isDisposed(){return this.privIsDisposed}dispose(m,S,y){s.marshalPromiseToCallbacks((async()=>{this.isDisposed&&!this.privIsSpeaking||(await this.cancelSpeech(),this.privIsDisposed=!0,this.privSpeechTranslationConfig.close(),this.privSpeechRecognitionLanguage=void 0,this.privProperties=void 0,this.privAudioConfig=void 0,this.privSpeechTranslationConfig=void 0,this.privConversation.dispose(),this.privConversation=void 0)})(),S,y)}async cancelSpeech(){var m;try{this.privIsSpeaking=!1,await((m=this.privCTRecognizer)==null?void 0:m.onCancelSpeech()),this.privCTRecognizer=void 0}catch{}}async connectTranslatorRecognizer(){try{this.privAudioConfig===void 0&&(this.privAudioConfig=a.AudioConfig.fromDefaultMicrophoneInput()),this.privSpeechTranslationConfig.getProperty(a.PropertyId[a.PropertyId.SpeechServiceConnection_Key])===this.privPlaceholderKey&&this.privSpeechTranslationConfig.setProperty(a.PropertyId[a.PropertyId.SpeechServiceConnection_Key],"");const m=()=>this.privConversation;this.privCTRecognizer=new p(this.privSpeechTranslationConfig,this.privAudioConfig,this,m)}catch(m){throw await this.cancelSpeech(),m}}startContinuousRecognition(){return new Promise((m,S)=>{this.privCTRecognizer.startContinuousRecognitionAsync(m,S)})}}i.ConversationTranslator=v}(ConversationTranslator)),ConversationTranslator}var ConversationTranscriber={},hasRequiredConversationTranscriber;function requireConversationTranscriber(){if(hasRequiredConversationTranscriber)return ConversationTranscriber;hasRequiredConversationTranscriber=1,Object.defineProperty(ConversationTranscriber,"__esModule",{value:!0}),ConversationTranscriber.ConversationTranscriber=void 0;const i=requireExports(),e=requireExports$5(),t=Contracts$1,s=requireExports$3();let o=class Oe extends s.Recognizer{constructor(c,u){const d=c;t.Contracts.throwIfNull(d,"speechConfig"),t.Contracts.throwIfNullOrWhitespace(d.properties.getProperty(s.PropertyId.SpeechServiceConnection_RecoLanguage),s.PropertyId[s.PropertyId.SpeechServiceConnection_RecoLanguage]),super(u,d.properties,new i.ConversationTranscriberConnectionFactory),this.privProperties.setProperty(s.PropertyId.SpeechServiceConnection_RecognitionEndpointVersion,"2"),this.privDisposedRecognizer=!1}static FromConfig(c,u,d){const p=c;return u.properties.mergeTo(p.properties),new Oe(c,d)}get endpointId(){return t.Contracts.throwIfDisposed(this.privDisposedRecognizer),this.properties.getProperty(s.PropertyId.SpeechServiceConnection_EndpointId,"00000000-0000-0000-0000-000000000000")}get authorizationToken(){return this.properties.getProperty(s.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(c){t.Contracts.throwIfNullOrWhitespace(c,"token"),this.properties.setProperty(s.PropertyId.SpeechServiceAuthorization_Token,c)}get speechRecognitionLanguage(){return t.Contracts.throwIfDisposed(this.privDisposedRecognizer),this.properties.getProperty(s.PropertyId.SpeechServiceConnection_RecoLanguage)}get outputFormat(){return t.Contracts.throwIfDisposed(this.privDisposedRecognizer),this.properties.getProperty(i.OutputFormatPropertyName,s.OutputFormat[s.OutputFormat.Simple])===s.OutputFormat[s.OutputFormat.Simple]?s.OutputFormat.Simple:s.OutputFormat.Detailed}get properties(){return this.privProperties}startTranscribingAsync(c,u){e.marshalPromiseToCallbacks(this.startContinuousRecognitionAsyncImpl(i.RecognitionMode.Conversation),c,u)}stopTranscribingAsync(c,u){e.marshalPromiseToCallbacks(this.stopContinuousRecognitionAsyncImpl(),c,u)}close(c,u){t.Contracts.throwIfDisposed(this.privDisposedRecognizer),e.marshalPromiseToCallbacks(this.dispose(!0),c,u)}async dispose(c){this.privDisposedRecognizer||(c&&(this.privDisposedRecognizer=!0,await this.implRecognizerStop()),await super.dispose(c))}createRecognizerConfig(c){return new i.RecognizerConfig(c,this.privProperties)}createServiceRecognizer(c,u,d,p){const v=d;return p.isSpeakerDiarizationEnabled=!0,new i.ConversationTranscriptionServiceRecognizer(c,u,v,p,this)}};return ConversationTranscriber.ConversationTranscriber=o,ConversationTranscriber}var IParticipant={},hasRequiredIParticipant;function requireIParticipant(){if(hasRequiredIParticipant)return IParticipant;hasRequiredIParticipant=1,Object.defineProperty(IParticipant,"__esModule",{value:!0}),IParticipant.Participant=IParticipant.User=void 0;const i=requireExports$3();class e{constructor(o){this.privUserId=o}get userId(){return this.privUserId}}IParticipant.User=e;class t{constructor(o,a,c,u,d,p,v,g){this.privId=o,this.privAvatar=a,this.privDisplayName=c,this.privIsHost=u,this.privIsMuted=d,this.privIsUsingTts=p,this.privPreferredLanguage=v,this.privVoice=g,this.privProperties=new i.PropertyCollection}get avatar(){return this.privAvatar}get displayName(){return this.privDisplayName}get id(){return this.privId}get preferredLanguage(){return this.privPreferredLanguage}get isHost(){return this.privIsHost}get isMuted(){return this.privIsMuted}get isUsingTts(){return this.privIsUsingTts}get voice(){return this.privVoice}get properties(){return this.privProperties}static From(o,a,c){return new t(o,"",o,!1,!1,!1,a,c)}}return IParticipant.Participant=t,IParticipant}var ParticipantChangedReason={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.ParticipantChangedReason=void 0,function(e){e[e.JoinedConversation=0]="JoinedConversation",e[e.LeftConversation=1]="LeftConversation",e[e.Updated=2]="Updated"}(i.ParticipantChangedReason||(i.ParticipantChangedReason={}))})(ParticipantChangedReason);var Meeting={},hasRequiredMeeting;function requireMeeting(){if(hasRequiredMeeting)return Meeting;hasRequiredMeeting=1,Object.defineProperty(Meeting,"__esModule",{value:!0}),Meeting.MeetingImpl=Meeting.Meeting=void 0;const i=requireExports(),e=requireExports$5(),t=Contracts$1,s=requireExports$3();let o=class{constructor(){}static createMeetingAsync(u,d,p,v){if(t.Contracts.throwIfNullOrUndefined(u,i.ConversationConnectionConfig.restErrors.invalidArgs.replace("{arg}","config")),t.Contracts.throwIfNullOrUndefined(u.region,i.ConversationConnectionConfig.restErrors.invalidArgs.replace("{arg}","SpeechServiceConnection_Region")),t.Contracts.throwIfNull(d,"meetingId"),d.length===0)throw new Error("meetingId cannot be empty");!u.subscriptionKey&&!u.getProperty(s.PropertyId[s.PropertyId.SpeechServiceAuthorization_Token])&&t.Contracts.throwIfNullOrUndefined(u.subscriptionKey,i.ConversationConnectionConfig.restErrors.invalidArgs.replace("{arg}","SpeechServiceConnection_Key"));const g=new a(u,d);return e.marshalPromiseToCallbacks((async()=>{})(),p,v),g}};Meeting.Meeting=o;class a extends o{constructor(u,d){super(),this.privErrors=i.ConversationConnectionConfig.restErrors,this.onConnected=g=>{var m;this.privIsConnected=!0;try{(m=this.privConversationTranslator)!=null&&m.sessionStarted&&this.privConversationTranslator.sessionStarted(this.privConversationTranslator,g)}catch{}},this.onDisconnected=g=>{var m;try{(m=this.privConversationTranslator)!=null&&m.sessionStopped&&this.privConversationTranslator.sessionStopped(this.privConversationTranslator,g)}catch{}finally{this.close(!1)}},this.onCanceled=(g,m)=>{var S;try{(S=this.privConversationTranslator)!=null&&S.canceled&&this.privConversationTranslator.canceled(this.privConversationTranslator,m)}catch{}},this.onParticipantUpdateCommandReceived=(g,m)=>{try{const S=this.privParticipants.getParticipant(m.id);if(S!==void 0){switch(m.key){case i.ConversationTranslatorCommandTypes.changeNickname:S.displayName=m.value;break;case i.ConversationTranslatorCommandTypes.setUseTTS:S.isUsingTts=m.value;break;case i.ConversationTranslatorCommandTypes.setProfanityFiltering:S.profanity=m.value;break;case i.ConversationTranslatorCommandTypes.setMute:S.isMuted=m.value;break;case i.ConversationTranslatorCommandTypes.setTranslateToLanguages:S.translateToLanguages=m.value;break}this.privParticipants.addOrUpdateParticipant(S),this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.Updated,[this.toParticipant(S)],m.sessionId))}}catch{}},this.onLockRoomCommandReceived=()=>{},this.onMuteAllCommandReceived=(g,m)=>{try{this.privParticipants.participants.forEach(S=>S.isMuted=S.isHost?!1:m.isMuted),this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.Updated,this.toParticipants(!1),m.sessionId))}catch{}},this.onParticipantJoinCommandReceived=(g,m)=>{try{const S=this.privParticipants.addOrUpdateParticipant(m.participant);S!==void 0&&this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.JoinedConversation,[this.toParticipant(S)],m.sessionId))}catch{}},this.onParticipantLeaveCommandReceived=(g,m)=>{try{const S=this.privParticipants.getParticipant(m.participant.id);S!==void 0&&(this.privParticipants.deleteParticipant(m.participant.id),this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.LeftConversation,[this.toParticipant(S)],m.sessionId)))}catch{}},this.onTranslationReceived=(g,m)=>{try{switch(m.command){case i.ConversationTranslatorMessageTypes.final:this.privConversationTranslator&&this.privConversationTranslator.transcribed(this.privConversationTranslator,new s.ConversationTranslationEventArgs(m.payload,void 0,m.sessionId));break;case i.ConversationTranslatorMessageTypes.partial:this.privConversationTranslator&&this.privConversationTranslator.transcribing(this.privConversationTranslator,new s.ConversationTranslationEventArgs(m.payload,void 0,m.sessionId));break;case i.ConversationTranslatorMessageTypes.instantMessage:this.privConversationTranslator&&this.privConversationTranslator.textMessageReceived(this.privConversationTranslator,new s.ConversationTranslationEventArgs(m.payload,void 0,m.sessionId));break}}catch{}},this.onParticipantsListReceived=(g,m)=>{var S;try{if(m.sessionToken!==void 0&&m.sessionToken!==null&&(this.privRoom.token=m.sessionToken),this.privParticipants.participants=[...m.participants],this.privParticipants.me!==void 0&&(this.privIsReady=!0),this.privConversationTranslator&&this.privConversationTranslator.participantsChanged(this.privConversationTranslator,new s.ConversationParticipantsChangedEventArgs(s.ParticipantChangedReason.JoinedConversation,this.toParticipants(!0),m.sessionId)),this.me.isHost){const y=(S=this.privConversationTranslator)==null?void 0:S.properties.getProperty(s.PropertyId.ConversationTranslator_Name);y!==void 0&&y.length>0&&y!==this.me.displayName&&this.changeNicknameAsync(y)}}catch{}},this.onConversationExpiration=(g,m)=>{try{this.privConversationTranslator&&this.privConversationTranslator.conversationExpiration(this.privConversationTranslator,m)}catch{}},this.privIsConnected=!1,this.privIsDisposed=!1,this.privConversationId="",this.privProperties=new s.PropertyCollection,this.privManager=new i.ConversationManager,u.getProperty(s.PropertyId[s.PropertyId.SpeechServiceConnection_RecoLanguage])||u.setProperty(s.PropertyId[s.PropertyId.SpeechServiceConnection_RecoLanguage],i.ConversationConnectionConfig.defaultLanguageCode),this.privLanguage=u.getProperty(s.PropertyId[s.PropertyId.SpeechServiceConnection_RecoLanguage]),this.privConversationId=d,this.privConfig=u;const v=u;t.Contracts.throwIfNull(v,"speechConfig"),this.privProperties=v.properties.clone(),this.privIsConnected=!1,this.privParticipants=new i.InternalParticipants,this.privIsReady=!1,this.privTextMessageMaxLength=1e3}get room(){return this.privRoom}get connection(){return this.privConversationRecognizer}get config(){return this.privConfig}get meetingId(){return this.privRoom?this.privRoom.roomId:this.privConversationId}get properties(){return this.privProperties}get speechRecognitionLanguage(){return this.privLanguage}get isMutedByHost(){var u,d;return(u=this.privParticipants.me)!=null&&u.isHost?!1:(d=this.privParticipants.me)==null?void 0:d.isMuted}get isConnected(){return this.privIsConnected&&this.privIsReady}get participants(){return this.toParticipants(!0)}get me(){return this.toParticipant(this.privParticipants.me)}get host(){return this.toParticipant(this.privParticipants.host)}get transcriberRecognizer(){return this.privTranscriberRecognizer}get meetingInfo(){const u=this.meetingId,d=this.participants.map(g=>({id:g.id,preferredLanguage:g.preferredLanguage,voice:g.voice})),p={};for(const g of i.ConversationConnectionConfig.transcriptionEventKeys){const m=this.properties.getProperty(g,"");m!==""&&(p[g]=m)}return{id:u,participants:d,meetingProperties:p}}get canSend(){var u;return this.privIsConnected&&!((u=this.privParticipants.me)!=null&&u.isMuted)}get canSendAsHost(){var u;return this.privIsConnected&&((u=this.privParticipants.me)==null?void 0:u.isHost)}get authorizationToken(){return this.privToken}set authorizationToken(u){t.Contracts.throwIfNullOrWhitespace(u,"authorizationToken"),this.privToken=u}createMeetingAsync(u,d){try{this.privConversationRecognizer&&this.handleError(new Error(this.privErrors.permissionDeniedStart),d),this.privManager.createOrJoin(this.privProperties,void 0,p=>{p||this.handleError(new Error(this.privErrors.permissionDeniedConnect),d),this.privRoom=p,this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}startMeetingAsync(u,d){try{this.privConversationRecognizer&&this.handleError(new Error(this.privErrors.permissionDeniedStart),d),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedConnect),this.privParticipants.meId=this.privRoom.participantId,this.privConversationRecognizer.connected=this.onConnected,this.privConversationRecognizer.disconnected=this.onDisconnected,this.privConversationRecognizer.canceled=this.onCanceled,this.privConversationRecognizer.participantUpdateCommandReceived=this.onParticipantUpdateCommandReceived,this.privConversationRecognizer.lockRoomCommandReceived=this.onLockRoomCommandReceived,this.privConversationRecognizer.muteAllCommandReceived=this.onMuteAllCommandReceived,this.privConversationRecognizer.participantJoinCommandReceived=this.onParticipantJoinCommandReceived,this.privConversationRecognizer.participantLeaveCommandReceived=this.onParticipantLeaveCommandReceived,this.privConversationRecognizer.translationReceived=this.onTranslationReceived,this.privConversationRecognizer.participantsListReceived=this.onParticipantsListReceived,this.privConversationRecognizer.conversationExpiration=this.onConversationExpiration,this.privConversationRecognizer.connect(this.privRoom.token,()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}addParticipantAsync(u,d,p){t.Contracts.throwIfNullOrUndefined(u,"Participant"),e.marshalPromiseToCallbacks(this.addParticipantImplAsync(u),d,p)}joinMeetingAsync(u,d,p,v,g){try{t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","conversationId")),t.Contracts.throwIfNullOrWhitespace(d,this.privErrors.invalidArgs.replace("{arg}","nickname")),t.Contracts.throwIfNullOrWhitespace(p,this.privErrors.invalidArgs.replace("{arg}","language")),this.privManager.createOrJoin(this.privProperties,u,m=>{t.Contracts.throwIfNullOrUndefined(m,this.privErrors.permissionDeniedConnect),this.privRoom=m,this.privConfig.authorizationToken=m.cognitiveSpeechAuthToken,v&&v(m.cognitiveSpeechAuthToken)},m=>{this.handleError(m,g)})}catch(m){this.handleError(m,g)}}deleteMeetingAsync(u,d){e.marshalPromiseToCallbacks(this.deleteMeetingImplAsync(),u,d)}async deleteMeetingImplAsync(){t.Contracts.throwIfNullOrUndefined(this.privProperties,this.privErrors.permissionDeniedConnect),t.Contracts.throwIfNullOrWhitespace(this.privRoom.token,this.privErrors.permissionDeniedConnect),await this.privManager.leave(this.privProperties,this.privRoom.token),this.dispose()}endMeetingAsync(u,d){e.marshalPromiseToCallbacks(this.endMeetingImplAsync(),u,d)}endMeetingImplAsync(){return this.close(!0)}lockMeetingAsync(u,d){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedConversation.replace("{command}","lock")),d),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getLockCommand(!0),()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}muteAllParticipantsAsync(u,d){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privConversationRecognizer,this.privErrors.permissionDeniedSend),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedConversation.replace("{command}","mute")),d),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMuteAllCommand(!0),()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}muteParticipantAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","userId")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),!this.me.isHost&&this.me.id!==u&&this.handleError(new Error(this.privErrors.permissionDeniedParticipant.replace("{command}","mute")),p),this.privParticipants.getParticipantIndex(u)===-1&&this.handleError(new Error(this.privErrors.invalidParticipantRequest),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMuteCommand(u,!0),()=>{this.handleCallback(d,p)},g=>{this.handleError(g,p)})}catch(v){this.handleError(v,p)}}removeParticipantAsync(u,d,p){try{if(t.Contracts.throwIfDisposed(this.privIsDisposed),this.privTranscriberRecognizer&&u.hasOwnProperty("id"))e.marshalPromiseToCallbacks(this.removeParticipantImplAsync(u),d,p);else{t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedParticipant.replace("{command}","remove")),p);let v="";typeof u=="string"?v=u:u.hasOwnProperty("id")?v=u.id:u.hasOwnProperty("userId")&&(v=u.userId),t.Contracts.throwIfNullOrWhitespace(v,this.privErrors.invalidArgs.replace("{arg}","userId")),this.participants.findIndex(m=>m.id===v)===-1&&this.handleError(new Error(this.privErrors.invalidParticipantRequest),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getEjectCommand(v),()=>{this.handleCallback(d,p)},m=>{this.handleError(m,p)})}}catch(v){this.handleError(v,p)}}unlockMeetingAsync(u,d){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedConversation.replace("{command}","unlock")),d),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getLockCommand(!1),()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}unmuteAllParticipantsAsync(u,d){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSendAsHost||this.handleError(new Error(this.privErrors.permissionDeniedConversation.replace("{command}","unmute all")),d),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMuteAllCommand(!1),()=>{this.handleCallback(u,d)},p=>{this.handleError(p,d)})}catch(p){this.handleError(p,d)}}unmuteParticipantAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","userId")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),!this.me.isHost&&this.me.id!==u&&this.handleError(new Error(this.privErrors.permissionDeniedParticipant.replace("{command}","mute")),p),this.privParticipants.getParticipantIndex(u)===-1&&this.handleError(new Error(this.privErrors.invalidParticipantRequest),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMuteCommand(u,!1),()=>{this.handleCallback(d,p)},g=>{this.handleError(g,p)})}catch(v){this.handleError(v,p)}}sendTextMessageAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","message")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),u.length>this.privTextMessageMaxLength&&this.handleError(new Error(this.privErrors.invalidArgs.replace("{arg}","message length")),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getMessageCommand(u),()=>{this.handleCallback(d,p)},v=>{this.handleError(v,p)})}catch(v){this.handleError(v,p)}}setTranslatedLanguagesAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfArrayEmptyOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","languages")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getSetTranslateToLanguagesCommand(u),()=>{this.handleCallback(d,p)},v=>{this.handleError(v,p)})}catch(v){this.handleError(v,p)}}changeNicknameAsync(u,d,p){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfDisposed(this.privConversationRecognizer.isDisposed()),t.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","nickname")),t.Contracts.throwIfNullOrUndefined(this.privRoom,this.privErrors.permissionDeniedSend),this.canSend||this.handleError(new Error(this.privErrors.permissionDeniedSend),p),this.privConversationRecognizer&&this.privConversationRecognizer.sendRequest(this.getChangeNicknameCommand(u),()=>{this.handleCallback(d,p)},v=>{this.handleError(v,p)})}catch(v){this.handleError(v,p)}}isDisposed(){return this.privIsDisposed}dispose(){this.isDisposed||(this.privIsDisposed=!0,this.config&&this.config.close(),this.privConfig=void 0,this.privLanguage=void 0,this.privProperties=void 0,this.privRoom=void 0,this.privToken=void 0,this.privManager=void 0,this.privIsConnected=!1,this.privIsReady=!1,this.privParticipants=void 0)}async connectTranscriberRecognizer(u){this.privTranscriberRecognizer&&await this.privTranscriberRecognizer.close(),await u.enforceAudioGating(),this.privTranscriberRecognizer=u,this.privTranscriberRecognizer.meeting=this}getKeepAlive(){const u=this.me?this.me.displayName:"default_nickname";return JSON.stringify({id:"0",nickname:u,participantId:this.privRoom.participantId,roomId:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.keepAlive})}addParticipantImplAsync(u){if(this.privParticipants.addOrUpdateParticipant(u)!==void 0&&this.privTranscriberRecognizer){const p=this.meetingInfo;return p.participants=[u],this.privTranscriberRecognizer.pushMeetingEvent(p,"join")}}removeParticipantImplAsync(u){this.privParticipants.deleteParticipant(u.id);const d=this.meetingInfo;return d.participants=[u],this.privTranscriberRecognizer.pushMeetingEvent(d,"leave")}async close(u){var d;try{this.privIsConnected=!1,await((d=this.privConversationRecognizer)==null?void 0:d.close()),this.privConversationRecognizer=void 0,this.privConversationTranslator&&this.privConversationTranslator.dispose()}catch(p){throw p}u&&this.dispose()}handleCallback(u,d){if(u){try{u()}catch(p){d&&d(p)}u=void 0}}handleError(u,d){if(d)if(u instanceof Error){const p=u;d(p.name+": "+p.message)}else d(u)}toParticipants(u){const d=this.privParticipants.participants.map(p=>this.toParticipant(p));return u?d:d.filter(p=>p.isHost===!1)}toParticipant(u){return new s.Participant(u.id,u.avatar,u.displayName,u.isHost,u.isMuted,u.isUsingTts,u.preferredLanguage,u.voice)}getMuteAllCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"meetingd"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.setMuteAll,participantId:this.privRoom.participantId,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:u})}getMuteCommand(u,d){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"conversationId"),t.Contracts.throwIfNullOrWhitespace(u,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.setMute,participantId:u,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:d})}getLockCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"meetingId"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.setLockState,participantId:this.privRoom.participantId,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:u})}getEjectCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"meetingId"),t.Contracts.throwIfNullOrWhitespace(u,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.ejectParticipant,participantId:u,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand})}getSetTranslateToLanguagesCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"meetingId"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.setTranslateToLanguages,participantId:this.privRoom.participantId,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:u})}getChangeNicknameCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"meetingId"),t.Contracts.throwIfNullOrWhitespace(u,"nickname"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),JSON.stringify({command:i.ConversationTranslatorCommandTypes.changeNickname,nickname:u,participantId:this.privRoom.participantId,roomid:this.privRoom.roomId,type:i.ConversationTranslatorMessageTypes.participantCommand,value:u})}getMessageCommand(u){return t.Contracts.throwIfNullOrWhitespace(this.privRoom.roomId,"meetingId"),t.Contracts.throwIfNullOrWhitespace(this.privRoom.participantId,"participantId"),t.Contracts.throwIfNullOrWhitespace(u,"message"),JSON.stringify({participantId:this.privRoom.participantId,roomId:this.privRoom.roomId,text:u,type:i.ConversationTranslatorMessageTypes.instantMessage})}}return Meeting.MeetingImpl=a,Meeting}var MeetingTranscriptionCanceledEventArgs$1={},hasRequiredMeetingTranscriptionCanceledEventArgs$1;function requireMeetingTranscriptionCanceledEventArgs$1(){if(hasRequiredMeetingTranscriptionCanceledEventArgs$1)return MeetingTranscriptionCanceledEventArgs$1;hasRequiredMeetingTranscriptionCanceledEventArgs$1=1,Object.defineProperty(MeetingTranscriptionCanceledEventArgs$1,"__esModule",{value:!0}),MeetingTranscriptionCanceledEventArgs$1.MeetingTranscriptionCanceledEventArgs=void 0;const i=requireCancellationEventArgsBase();class e extends i.CancellationEventArgsBase{}return MeetingTranscriptionCanceledEventArgs$1.MeetingTranscriptionCanceledEventArgs=e,MeetingTranscriptionCanceledEventArgs$1}var MeetingTranscriber={},hasRequiredMeetingTranscriber;function requireMeetingTranscriber(){if(hasRequiredMeetingTranscriber)return MeetingTranscriber;hasRequiredMeetingTranscriber=1,Object.defineProperty(MeetingTranscriber,"__esModule",{value:!0}),MeetingTranscriber.MeetingTranscriber=void 0;const i=requireExports(),e=requireExports$5(),t=Contracts$1,s=requireExports$3(),o=requireExports$4();let a=class{constructor(u){this.privAudioConfig=u,this.privProperties=new s.PropertyCollection,this.privRecognizer=void 0,this.privDisposedRecognizer=!1}get speechRecognitionLanguage(){return t.Contracts.throwIfDisposed(this.privDisposedRecognizer),this.properties.getProperty(s.PropertyId.SpeechServiceConnection_RecoLanguage)}get properties(){return this.privProperties}get internalData(){return this.privRecognizer.internalData}get connection(){return s.Connection.fromRecognizer(this.privRecognizer)}get authorizationToken(){return this.properties.getProperty(s.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(u){t.Contracts.throwIfNullOrWhitespace(u,"token"),this.properties.setProperty(s.PropertyId.SpeechServiceAuthorization_Token,u)}joinMeetingAsync(u,d,p){const v=u;t.Contracts.throwIfNullOrUndefined(o.MeetingImpl,"Meeting"),this.privRecognizer=new i.TranscriberRecognizer(u.config,this.privAudioConfig),t.Contracts.throwIfNullOrUndefined(this.privRecognizer,"Recognizer"),this.privRecognizer.connectMeetingCallbacks(this),e.marshalPromiseToCallbacks(v.connectTranscriberRecognizer(this.privRecognizer),d,p)}startTranscribingAsync(u,d){this.privRecognizer.startContinuousRecognitionAsync(u,d)}stopTranscribingAsync(u,d){this.privRecognizer.stopContinuousRecognitionAsync(u,d)}leaveMeetingAsync(u,d){this.privRecognizer.disconnectCallbacks(),e.marshalPromiseToCallbacks((async()=>{})(),u,d)}close(u,d){t.Contracts.throwIfDisposed(this.privDisposedRecognizer),e.marshalPromiseToCallbacks(this.dispose(!0),u,d)}async dispose(u){this.privDisposedRecognizer||(this.privRecognizer&&(await this.privRecognizer.close(),this.privRecognizer=void 0),u&&(this.privDisposedRecognizer=!0))}};return MeetingTranscriber.MeetingTranscriber=a,MeetingTranscriber}var ConversationTranscriptionResult={},hasRequiredConversationTranscriptionResult;function requireConversationTranscriptionResult(){if(hasRequiredConversationTranscriptionResult)return ConversationTranscriptionResult;hasRequiredConversationTranscriptionResult=1,Object.defineProperty(ConversationTranscriptionResult,"__esModule",{value:!0}),ConversationTranscriptionResult.ConversationTranscriptionResult=void 0;const i=requireExports$3();let e=class extends i.RecognitionResult{constructor(s,o,a,c,u,d,p,v,g,m,S){super(s,o,a,c,u,d,p,g,m,S),this.privSpeakerId=v}get speakerId(){return this.privSpeakerId}};return ConversationTranscriptionResult.ConversationTranscriptionResult=e,ConversationTranscriptionResult}var hasRequiredExports$4;function requireExports$4(){return hasRequiredExports$4||(hasRequiredExports$4=1,function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=requireConversation();Object.defineProperty(i,"Conversation",{enumerable:!0,get:function(){return e.Conversation}}),Object.defineProperty(i,"ConversationImpl",{enumerable:!0,get:function(){return e.ConversationImpl}});var t=ConversationCommon$1;Object.defineProperty(i,"ConversationCommon",{enumerable:!0,get:function(){return t.ConversationCommon}});var s=requireConversationExpirationEventArgs();Object.defineProperty(i,"ConversationExpirationEventArgs",{enumerable:!0,get:function(){return s.ConversationExpirationEventArgs}});var o=requireConversationParticipantsChangedEventArgs();Object.defineProperty(i,"ConversationParticipantsChangedEventArgs",{enumerable:!0,get:function(){return o.ConversationParticipantsChangedEventArgs}});var a=requireConversationTranslationCanceledEventArgs();Object.defineProperty(i,"ConversationTranslationCanceledEventArgs",{enumerable:!0,get:function(){return a.ConversationTranslationCanceledEventArgs}});var c=requireConversationTranslationEventArgs();Object.defineProperty(i,"ConversationTranslationEventArgs",{enumerable:!0,get:function(){return c.ConversationTranslationEventArgs}});var u=requireConversationTranslationResult();Object.defineProperty(i,"ConversationTranslationResult",{enumerable:!0,get:function(){return u.ConversationTranslationResult}});var d=requireConversationTranslator();Object.defineProperty(i,"ConversationTranslator",{enumerable:!0,get:function(){return d.ConversationTranslator}});var p=requireConversationTranscriber();Object.defineProperty(i,"ConversationTranscriber",{enumerable:!0,get:function(){return p.ConversationTranscriber}});var v=requireIParticipant();Object.defineProperty(i,"Participant",{enumerable:!0,get:function(){return v.Participant}}),Object.defineProperty(i,"User",{enumerable:!0,get:function(){return v.User}});var g=ParticipantChangedReason;Object.defineProperty(i,"ParticipantChangedReason",{enumerable:!0,get:function(){return g.ParticipantChangedReason}});var m=requireMeeting();Object.defineProperty(i,"Meeting",{enumerable:!0,get:function(){return m.Meeting}}),Object.defineProperty(i,"MeetingImpl",{enumerable:!0,get:function(){return m.MeetingImpl}});var S=requireMeetingTranscriptionCanceledEventArgs$1();Object.defineProperty(i,"MeetingTranscriptionCanceledEventArgs",{enumerable:!0,get:function(){return S.MeetingTranscriptionCanceledEventArgs}});var y=requireMeetingTranscriber();Object.defineProperty(i,"MeetingTranscriber",{enumerable:!0,get:function(){return y.MeetingTranscriber}});var C=requireConversationTranscriptionResult();Object.defineProperty(i,"ConversationTranscriptionResult",{enumerable:!0,get:function(){return C.ConversationTranscriptionResult}})}(Exports$2)),Exports$2}var Synthesizer={},hasRequiredSynthesizer;function requireSynthesizer(){if(hasRequiredSynthesizer)return Synthesizer;hasRequiredSynthesizer=1,Object.defineProperty(Synthesizer,"__esModule",{value:!0}),Synthesizer.SynthesisRequest=Synthesizer.Synthesizer=void 0;const i=requireExports(),e=requireExports$5(),t=Contracts$1,s=requireExports$3();let o=class Me{constructor(u){const d=u;t.Contracts.throwIfNull(d,"speechConfig"),this.privProperties=d.properties.clone(),this.privDisposed=!1,this.privSynthesizing=!1,this.synthesisRequestQueue=new e.Queue}get authorizationToken(){return this.properties.getProperty(s.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(u){t.Contracts.throwIfNullOrWhitespace(u,"token"),this.properties.setProperty(s.PropertyId.SpeechServiceAuthorization_Token,u)}get properties(){return this.privProperties}get autoDetectSourceLanguage(){return this.properties.getProperty(s.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages)===i.AutoDetectSourceLanguagesOpenRangeOptionName}buildSsml(u){const d={"af-ZA":"af-ZA-AdriNeural","am-ET":"am-ET-AmehaNeural","ar-AE":"ar-AE-FatimaNeural","ar-BH":"ar-BH-AliNeural","ar-DZ":"ar-DZ-AminaNeural","ar-EG":"ar-EG-SalmaNeural","ar-IQ":"ar-IQ-BasselNeural","ar-JO":"ar-JO-SanaNeural","ar-KW":"ar-KW-FahedNeural","ar-LY":"ar-LY-ImanNeural","ar-MA":"ar-MA-JamalNeural","ar-QA":"ar-QA-AmalNeural","ar-SA":"ar-SA-HamedNeural","ar-SY":"ar-SY-AmanyNeural","ar-TN":"ar-TN-HediNeural","ar-YE":"ar-YE-MaryamNeural","bg-BG":"bg-BG-BorislavNeural","bn-BD":"bn-BD-NabanitaNeural","bn-IN":"bn-IN-BashkarNeural","ca-ES":"ca-ES-JoanaNeural","cs-CZ":"cs-CZ-AntoninNeural","cy-GB":"cy-GB-AledNeural","da-DK":"da-DK-ChristelNeural","de-AT":"de-AT-IngridNeural","de-CH":"de-CH-JanNeural","de-DE":"de-DE-KatjaNeural","el-GR":"el-GR-AthinaNeural","en-AU":"en-AU-NatashaNeural","en-CA":"en-CA-ClaraNeural","en-GB":"en-GB-LibbyNeural","en-HK":"en-HK-SamNeural","en-IE":"en-IE-ConnorNeural","en-IN":"en-IN-NeerjaNeural","en-KE":"en-KE-AsiliaNeural","en-NG":"en-NG-AbeoNeural","en-NZ":"en-NZ-MitchellNeural","en-PH":"en-PH-JamesNeural","en-SG":"en-SG-LunaNeural","en-TZ":"en-TZ-ElimuNeural","en-US":"en-US-AvaMultilingualNeural","en-ZA":"en-ZA-LeahNeural","es-AR":"es-AR-ElenaNeural","es-BO":"es-BO-MarceloNeural","es-CL":"es-CL-CatalinaNeural","es-CO":"es-CO-GonzaloNeural","es-CR":"es-CR-JuanNeural","es-CU":"es-CU-BelkysNeural","es-DO":"es-DO-EmilioNeural","es-EC":"es-EC-AndreaNeural","es-ES":"es-ES-AlvaroNeural","es-GQ":"es-GQ-JavierNeural","es-GT":"es-GT-AndresNeural","es-HN":"es-HN-CarlosNeural","es-MX":"es-MX-DaliaNeural","es-NI":"es-NI-FedericoNeural","es-PA":"es-PA-MargaritaNeural","es-PE":"es-PE-AlexNeural","es-PR":"es-PR-KarinaNeural","es-PY":"es-PY-MarioNeural","es-SV":"es-SV-LorenaNeural","es-US":"es-US-AlonsoNeural","es-UY":"es-UY-MateoNeural","es-VE":"es-VE-PaolaNeural","et-EE":"et-EE-AnuNeural","fa-IR":"fa-IR-DilaraNeural","fi-FI":"fi-FI-SelmaNeural","fil-PH":"fil-PH-AngeloNeural","fr-BE":"fr-BE-CharlineNeural","fr-CA":"fr-CA-SylvieNeural","fr-CH":"fr-CH-ArianeNeural","fr-FR":"fr-FR-DeniseNeural","ga-IE":"ga-IE-ColmNeural","gl-ES":"gl-ES-RoiNeural","gu-IN":"gu-IN-DhwaniNeural","he-IL":"he-IL-AvriNeural","hi-IN":"hi-IN-MadhurNeural","hr-HR":"hr-HR-GabrijelaNeural","hu-HU":"hu-HU-NoemiNeural","id-ID":"id-ID-ArdiNeural","is-IS":"is-IS-GudrunNeural","it-IT":"it-IT-IsabellaNeural","ja-JP":"ja-JP-NanamiNeural","jv-ID":"jv-ID-DimasNeural","kk-KZ":"kk-KZ-AigulNeural","km-KH":"km-KH-PisethNeural","kn-IN":"kn-IN-GaganNeural","ko-KR":"ko-KR-SunHiNeural","lo-LA":"lo-LA-ChanthavongNeural","lt-LT":"lt-LT-LeonasNeural","lv-LV":"lv-LV-EveritaNeural","mk-MK":"mk-MK-AleksandarNeural","ml-IN":"ml-IN-MidhunNeural","mr-IN":"mr-IN-AarohiNeural","ms-MY":"ms-MY-OsmanNeural","mt-MT":"mt-MT-GraceNeural","my-MM":"my-MM-NilarNeural","nb-NO":"nb-NO-PernilleNeural","nl-BE":"nl-BE-ArnaudNeural","nl-NL":"nl-NL-ColetteNeural","pl-PL":"pl-PL-AgnieszkaNeural","ps-AF":"ps-AF-GulNawazNeural","pt-BR":"pt-BR-FranciscaNeural","pt-PT":"pt-PT-DuarteNeural","ro-RO":"ro-RO-AlinaNeural","ru-RU":"ru-RU-SvetlanaNeural","si-LK":"si-LK-SameeraNeural","sk-SK":"sk-SK-LukasNeural","sl-SI":"sl-SI-PetraNeural","so-SO":"so-SO-MuuseNeural","sr-RS":"sr-RS-NicholasNeural","su-ID":"su-ID-JajangNeural","sv-SE":"sv-SE-SofieNeural","sw-KE":"sw-KE-RafikiNeural","sw-TZ":"sw-TZ-DaudiNeural","ta-IN":"ta-IN-PallaviNeural","ta-LK":"ta-LK-KumarNeural","ta-SG":"ta-SG-AnbuNeural","te-IN":"te-IN-MohanNeural","th-TH":"th-TH-PremwadeeNeural","tr-TR":"tr-TR-AhmetNeural","uk-UA":"uk-UA-OstapNeural","ur-IN":"ur-IN-GulNeural","ur-PK":"ur-PK-AsadNeural","uz-UZ":"uz-UZ-MadinaNeural","vi-VN":"vi-VN-HoaiMyNeural","zh-CN":"zh-CN-XiaoxiaoNeural","zh-HK":"zh-HK-HiuMaanNeural","zh-TW":"zh-TW-HsiaoChenNeural","zu-ZA":"zu-ZA-ThandoNeural"};let p=this.properties.getProperty(s.PropertyId.SpeechServiceConnection_SynthLanguage,"en-US"),v=this.properties.getProperty(s.PropertyId.SpeechServiceConnection_SynthVoice,""),g=Me.XMLEncode(u);return this.autoDetectSourceLanguage?p="en-US":v=v||d[p],v&&(g=`<voice name='${v}'>${g}</voice>`),g=`<speak version='1.0' xmlns='http://www.w3.org/2001/10/synthesis' xmlns:mstts='http://www.w3.org/2001/mstts' xmlns:emo='http://www.w3.org/2009/10/emotionml' xml:lang='${p}'>${g}</speak>`,g}async dispose(u){this.privDisposed||(u&&this.privAdapter&&await this.privAdapter.dispose(),this.privDisposed=!0)}async adapterSpeak(){if(!this.privDisposed&&!this.privSynthesizing){this.privSynthesizing=!0;const u=await this.synthesisRequestQueue.dequeue();return this.privAdapter.Speak(u.text,u.isSSML,u.requestId,u.cb,u.err,u.dataStream)}}createSynthesizerConfig(u){return new i.SynthesizerConfig(u,this.privProperties)}implCommonSynthesizeSetup(){let u=typeof window<"u"?"Browser":"Node",d="unknown",p="unknown";typeof navigator<"u"&&(u=u+"/"+navigator.platform,d=navigator.userAgent,p=navigator.appVersion);const v=this.createSynthesizerConfig(new i.SpeechServiceConfig(new i.Context(new i.OS(u,d,p)))),g=this.privProperties.getProperty(s.PropertyId.SpeechServiceConnection_Key,void 0),m=g&&g!==""?new i.CognitiveSubscriptionKeyAuthentication(g):new i.CognitiveTokenAuthentication(()=>{const S=this.privProperties.getProperty(s.PropertyId.SpeechServiceAuthorization_Token,void 0);return Promise.resolve(S)},()=>{const S=this.privProperties.getProperty(s.PropertyId.SpeechServiceAuthorization_Token,void 0);return Promise.resolve(S)});this.privAdapter=this.createSynthesisAdapter(m,this.privConnectionFactory,v),this.privRestAdapter=this.createRestSynthesisAdapter(m,v)}static XMLEncode(u){return u.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}};Synthesizer.Synthesizer=o;class a{constructor(u,d,p,v,g,m){this.requestId=u,this.text=d,this.isSSML=p,this.cb=v,this.err=g,this.dataStream=m}}return Synthesizer.SynthesisRequest=a,Synthesizer}var SpeechSynthesizer={},hasRequiredSpeechSynthesizer;function requireSpeechSynthesizer(){if(hasRequiredSpeechSynthesizer)return SpeechSynthesizer;hasRequiredSpeechSynthesizer=1,Object.defineProperty(SpeechSynthesizer,"__esModule",{value:!0}),SpeechSynthesizer.SpeechSynthesizer=void 0;const i=requireExports(),e=requireExports$5(),t=AudioFileWriter$1,s=AudioOutputFormat,o=AudioOutputStream$1,a=Contracts$1,c=requireExports$3(),u=requireSynthesizer();let d=class De extends c.Synthesizer{constructor(v,g){super(v),g!==null&&(g===void 0?this.audioConfig=typeof window>"u"?void 0:c.AudioConfig.fromDefaultSpeakerOutput():this.audioConfig=g),this.privConnectionFactory=new i.SpeechSynthesisConnectionFactory,this.implCommonSynthesizeSetup()}static FromConfig(v,g,m){const S=v;return g.properties.mergeTo(S.properties),new De(v,m)}speakTextAsync(v,g,m,S){this.speakImpl(v,!1,g,m,S)}speakSsmlAsync(v,g,m,S){this.speakImpl(v,!0,g,m,S)}async getVoicesAsync(v=""){return this.getVoices(v)}close(v,g){a.Contracts.throwIfDisposed(this.privDisposed),e.marshalPromiseToCallbacks(this.dispose(!0),v,g)}get internalData(){return this.privAdapter}createSynthesisAdapter(v,g,m){return new i.SpeechSynthesisAdapter(v,g,m,this,this.audioConfig)}createRestSynthesisAdapter(v,g){return new i.SynthesisRestAdapter(g,v)}implCommonSynthesizeSetup(){super.implCommonSynthesizeSetup(),this.privAdapter.audioOutputFormat=s.AudioOutputFormatImpl.fromSpeechSynthesisOutputFormat(c.SpeechSynthesisOutputFormat[this.properties.getProperty(c.PropertyId.SpeechServiceConnection_SynthOutputFormat,void 0)])}speakImpl(v,g,m,S,y){try{a.Contracts.throwIfDisposed(this.privDisposed);const C=e.createNoDashGuid();let R;y instanceof c.PushAudioOutputStreamCallback?R=new o.PushAudioOutputStreamImpl(y):y instanceof c.PullAudioOutputStream?R=y:y!==void 0?R=new t.AudioFileWriter(y):R=void 0,this.synthesisRequestQueue.enqueue(new u.SynthesisRequest(C,v,g,T=>{if(this.privSynthesizing=!1,m)try{m(T)}catch(E){S&&S(E)}m=void 0,this.adapterSpeak().catch(()=>{})},T=>{S&&S(T)},R)),this.adapterSpeak().catch(()=>{})}catch(C){if(S)if(C instanceof Error){const R=C;S(R.name+": "+R.message)}else S(C);this.dispose(!0).catch(()=>{})}}async getVoices(v){const g=e.createNoDashGuid(),m=await this.privRestAdapter.getVoicesList(g);if(m.ok&&Array.isArray(m.json)){let S=m.json;return v&&v.length>0&&(S=S.filter(y=>!!y.Locale&&y.Locale.toLowerCase()===v.toLowerCase())),new c.SynthesisVoicesResult(g,S,void 0)}else return new c.SynthesisVoicesResult(g,void 0,`Error: ${m.status}: ${m.statusText}`)}};return SpeechSynthesizer.SpeechSynthesizer=d,SpeechSynthesizer}var SynthesisResult$1={};Object.defineProperty(SynthesisResult$1,"__esModule",{value:!0});SynthesisResult$1.SynthesisResult=void 0;class SynthesisResult{constructor(e,t,s,o){this.privResultId=e,this.privReason=t,this.privErrorDetails=s,this.privProperties=o}get resultId(){return this.privResultId}get reason(){return this.privReason}get errorDetails(){return this.privErrorDetails}get properties(){return this.privProperties}}SynthesisResult$1.SynthesisResult=SynthesisResult;var SpeechSynthesisResult={},hasRequiredSpeechSynthesisResult;function requireSpeechSynthesisResult(){if(hasRequiredSpeechSynthesisResult)return SpeechSynthesisResult;hasRequiredSpeechSynthesisResult=1,Object.defineProperty(SpeechSynthesisResult,"__esModule",{value:!0}),SpeechSynthesisResult.SpeechSynthesisResult=void 0;const i=requireExports$3();let e=class extends i.SynthesisResult{constructor(s,o,a,c,u,d){super(s,o,c,u),this.privAudioData=a,this.privAudioDuration=d}get audioData(){return this.privAudioData}get audioDuration(){return this.privAudioDuration}};return SpeechSynthesisResult.SpeechSynthesisResult=e,SpeechSynthesisResult}var SpeechSynthesisEventArgs$1={};Object.defineProperty(SpeechSynthesisEventArgs$1,"__esModule",{value:!0});SpeechSynthesisEventArgs$1.SpeechSynthesisEventArgs=void 0;class SpeechSynthesisEventArgs{constructor(e){this.privResult=e}get result(){return this.privResult}}SpeechSynthesisEventArgs$1.SpeechSynthesisEventArgs=SpeechSynthesisEventArgs;var SpeechSynthesisWordBoundaryEventArgs$1={};Object.defineProperty(SpeechSynthesisWordBoundaryEventArgs$1,"__esModule",{value:!0});SpeechSynthesisWordBoundaryEventArgs$1.SpeechSynthesisWordBoundaryEventArgs=void 0;class SpeechSynthesisWordBoundaryEventArgs{constructor(e,t,s,o,a,c){this.privAudioOffset=e,this.privDuration=t,this.privText=s,this.privWordLength=o,this.privTextOffset=a,this.privBoundaryType=c}get audioOffset(){return this.privAudioOffset}get duration(){return this.privDuration}get text(){return this.privText}get wordLength(){return this.privWordLength}get textOffset(){return this.privTextOffset}get boundaryType(){return this.privBoundaryType}}SpeechSynthesisWordBoundaryEventArgs$1.SpeechSynthesisWordBoundaryEventArgs=SpeechSynthesisWordBoundaryEventArgs;var SpeechSynthesisBookmarkEventArgs$1={};Object.defineProperty(SpeechSynthesisBookmarkEventArgs$1,"__esModule",{value:!0});SpeechSynthesisBookmarkEventArgs$1.SpeechSynthesisBookmarkEventArgs=void 0;class SpeechSynthesisBookmarkEventArgs{constructor(e,t){this.privAudioOffset=e,this.privText=t}get audioOffset(){return this.privAudioOffset}get text(){return this.privText}}SpeechSynthesisBookmarkEventArgs$1.SpeechSynthesisBookmarkEventArgs=SpeechSynthesisBookmarkEventArgs;var SpeechSynthesisVisemeEventArgs$1={};Object.defineProperty(SpeechSynthesisVisemeEventArgs$1,"__esModule",{value:!0});SpeechSynthesisVisemeEventArgs$1.SpeechSynthesisVisemeEventArgs=void 0;class SpeechSynthesisVisemeEventArgs{constructor(e,t,s){this.privAudioOffset=e,this.privVisemeId=t,this.privAnimation=s}get audioOffset(){return this.privAudioOffset}get visemeId(){return this.privVisemeId}get animation(){return this.privAnimation}}SpeechSynthesisVisemeEventArgs$1.SpeechSynthesisVisemeEventArgs=SpeechSynthesisVisemeEventArgs;var SpeechSynthesisBoundaryType={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.SpeechSynthesisBoundaryType=void 0,function(e){e.Word="WordBoundary",e.Punctuation="PunctuationBoundary",e.Sentence="SentenceBoundary"}(i.SpeechSynthesisBoundaryType||(i.SpeechSynthesisBoundaryType={}))})(SpeechSynthesisBoundaryType);var SynthesisVoicesResult={},hasRequiredSynthesisVoicesResult;function requireSynthesisVoicesResult(){if(hasRequiredSynthesisVoicesResult)return SynthesisVoicesResult;hasRequiredSynthesisVoicesResult=1,Object.defineProperty(SynthesisVoicesResult,"__esModule",{value:!0}),SynthesisVoicesResult.SynthesisVoicesResult=void 0;const i=requireExports$3();let e=class extends i.SynthesisResult{constructor(s,o,a){if(Array.isArray(o)){super(s,i.ResultReason.VoicesListRetrieved,void 0,new i.PropertyCollection),this.privVoices=[];for(const c of o)this.privVoices.push(new i.VoiceInfo(c))}else super(s,i.ResultReason.Canceled,a||"Error information unavailable",new i.PropertyCollection)}get voices(){return this.privVoices}};return SynthesisVoicesResult.SynthesisVoicesResult=e,SynthesisVoicesResult}var VoiceInfo={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.VoiceInfo=i.SynthesisVoiceType=i.SynthesisVoiceGender=void 0;var e;(function(a){a[a.Unknown=0]="Unknown",a[a.Female=1]="Female",a[a.Male=2]="Male",a[a.Neutral=3]="Neutral"})(e=i.SynthesisVoiceGender||(i.SynthesisVoiceGender={}));var t;(function(a){a[a.OnlineNeural=1]="OnlineNeural",a[a.OnlineStandard=2]="OnlineStandard",a[a.OfflineNeural=3]="OfflineNeural",a[a.OfflineStandard=4]="OfflineStandard"})(t=i.SynthesisVoiceType||(i.SynthesisVoiceType={}));const s={[e[e.Neutral]]:e.Neutral,[e[e.Male]]:e.Male,[e[e.Female]]:e.Female};class o{constructor(c){if(this.privStyleList=[],c){if(this.privName=c.Name,this.privLocale=c.Locale,this.privShortName=c.ShortName,this.privLocaleName=c.LocaleName,this.privDisplayName=c.DisplayName,this.privLocalName=c.LocalName,this.privVoiceType=c.VoiceType.endsWith("Standard")?t.OnlineStandard:t.OnlineNeural,this.privGender=s[c.Gender]||e.Unknown,c.StyleList&&Array.isArray(c.StyleList))for(const u of c.StyleList)this.privStyleList.push(u);this.privSampleRateHertz=c.SampleRateHertz,this.privStatus=c.Status,c.ExtendedPropertyMap&&(this.privExtendedPropertyMap=c.ExtendedPropertyMap),this.privWordsPerMinute=c.WordsPerMinute,Array.isArray(c.SecondaryLocaleList)&&(this.privSecondaryLocaleList=[...c.SecondaryLocaleList]),Array.isArray(c.RolePlayList)&&(this.privRolePlayList=[...c.RolePlayList])}}get name(){return this.privName}get locale(){return this.privLocale}get shortName(){return this.privShortName}get displayName(){return this.privDisplayName}get localName(){return this.privLocalName}get localeName(){return this.privLocaleName}get gender(){return this.privGender}get voiceType(){return this.privVoiceType}get styleList(){return this.privStyleList}get sampleRateHertz(){return this.privSampleRateHertz}get status(){return this.privStatus}get extendedPropertyMap(){return this.privExtendedPropertyMap}get wordsPerMinute(){return this.privWordsPerMinute}get secondaryLocaleList(){return this.privSecondaryLocaleList}get rolePlayList(){return this.privRolePlayList}}i.VoiceInfo=o})(VoiceInfo);var SpeakerAudioDestination$1={};Object.defineProperty(SpeakerAudioDestination$1,"__esModule",{value:!0});SpeakerAudioDestination$1.SpeakerAudioDestination=void 0;const Exports_js_1$8=requireExports$5(),AudioOutputStream_js_1$1=AudioOutputStream$1,AudioStreamFormat_js_1=AudioStreamFormat,MediaDurationPlaceholderSeconds=60*30,AudioFormatToMimeType={[AudioStreamFormat_js_1.AudioFormatTag.PCM]:"audio/wav",[AudioStreamFormat_js_1.AudioFormatTag.MuLaw]:"audio/x-wav",[AudioStreamFormat_js_1.AudioFormatTag.MP3]:"audio/mpeg",[AudioStreamFormat_js_1.AudioFormatTag.OGG_OPUS]:"audio/ogg",[AudioStreamFormat_js_1.AudioFormatTag.WEBM_OPUS]:"audio/webm; codecs=opus",[AudioStreamFormat_js_1.AudioFormatTag.ALaw]:"audio/x-wav",[AudioStreamFormat_js_1.AudioFormatTag.FLAC]:"audio/flac",[AudioStreamFormat_js_1.AudioFormatTag.AMR_WB]:"audio/amr-wb",[AudioStreamFormat_js_1.AudioFormatTag.G722]:"audio/G722"};class SpeakerAudioDestination{constructor(e){this.privPlaybackStarted=!1,this.privAppendingToBuffer=!1,this.privMediaSourceOpened=!1,this.privBytesReceived=0,this.privId=e||Exports_js_1$8.createNoDashGuid(),this.privIsPaused=!1,this.privIsClosed=!1}id(){return this.privId}write(e,t,s){this.privAudioBuffer!==void 0?(this.privAudioBuffer.push(e),this.updateSourceBuffer().then(()=>{t&&t()},o=>{s&&s(o)})):this.privAudioOutputStream!==void 0&&(this.privAudioOutputStream.write(e),this.privBytesReceived+=e.byteLength)}close(e,t){if(this.privIsClosed=!0,this.privSourceBuffer!==void 0)this.handleSourceBufferUpdateEnd().then(()=>{e&&e()},s=>{t&&t(s)});else if(this.privAudioOutputStream!==void 0&&typeof window<"u")if((this.privFormat.formatTag===AudioStreamFormat_js_1.AudioFormatTag.PCM||this.privFormat.formatTag===AudioStreamFormat_js_1.AudioFormatTag.MuLaw||this.privFormat.formatTag===AudioStreamFormat_js_1.AudioFormatTag.ALaw)&&this.privFormat.hasHeader===!1)console.warn("Play back is not supported for raw PCM, mulaw or alaw format without header."),this.onAudioEnd&&this.onAudioEnd(this);else{let s=new ArrayBuffer(this.privBytesReceived);this.privAudioOutputStream.read(s).then(()=>{s=this.privFormat.addHeader(s);const o=new Blob([s],{type:AudioFormatToMimeType[this.privFormat.formatTag]});this.privAudio.src=window.URL.createObjectURL(o),this.notifyPlayback().then(()=>{e&&e()},a=>{t&&t(a)})},o=>{t&&t(o)})}else this.onAudioEnd&&this.onAudioEnd(this)}set format(e){if(typeof AudioContext<"u"||typeof window<"u"&&typeof window.webkitAudioContext<"u"){this.privFormat=e;const t=AudioFormatToMimeType[this.privFormat.formatTag];t===void 0?console.warn(`Unknown mimeType for format ${AudioStreamFormat_js_1.AudioFormatTag[this.privFormat.formatTag]}; playback is not supported.`):typeof MediaSource<"u"&&MediaSource.isTypeSupported(t)?(this.privAudio=new Audio,this.privAudioBuffer=[],this.privMediaSource=new MediaSource,this.privAudio.src=URL.createObjectURL(this.privMediaSource),this.privAudio.load(),this.privMediaSource.onsourceopen=()=>{this.privMediaSourceOpened=!0,this.privMediaSource.duration=MediaDurationPlaceholderSeconds,this.privSourceBuffer=this.privMediaSource.addSourceBuffer(t),this.privSourceBuffer.onupdate=()=>{this.updateSourceBuffer().catch(s=>{Exports_js_1$8.Events.instance.onEvent(new Exports_js_1$8.BackgroundEvent(s))})},this.privSourceBuffer.onupdateend=()=>{this.handleSourceBufferUpdateEnd().catch(s=>{Exports_js_1$8.Events.instance.onEvent(new Exports_js_1$8.BackgroundEvent(s))})},this.privSourceBuffer.onupdatestart=()=>{this.privAppendingToBuffer=!1}},this.updateSourceBuffer().catch(s=>{Exports_js_1$8.Events.instance.onEvent(new Exports_js_1$8.BackgroundEvent(s))})):(console.warn(`Format ${AudioStreamFormat_js_1.AudioFormatTag[this.privFormat.formatTag]} could not be played by MSE, streaming playback is not enabled.`),this.privAudioOutputStream=new AudioOutputStream_js_1$1.PullAudioOutputStreamImpl,this.privAudioOutputStream.format=this.privFormat,this.privAudio=new Audio)}}get volume(){var e;return((e=this.privAudio)==null?void 0:e.volume)??-1}set volume(e){this.privAudio&&(this.privAudio.volume=e)}mute(){this.privAudio&&(this.privAudio.muted=!0)}unmute(){this.privAudio&&(this.privAudio.muted=!1)}get isClosed(){return this.privIsClosed}get currentTime(){return this.privAudio!==void 0?this.privAudio.currentTime:-1}pause(){!this.privIsPaused&&this.privAudio!==void 0&&(this.privAudio.pause(),this.privIsPaused=!0)}resume(e,t){this.privIsPaused&&this.privAudio!==void 0&&(this.privAudio.play().then(()=>{e&&e()},s=>{t&&t(s)}),this.privIsPaused=!1)}get internalAudio(){return this.privAudio}async updateSourceBuffer(){if(this.privAudioBuffer!==void 0&&this.privAudioBuffer.length>0&&this.sourceBufferAvailable()){this.privAppendingToBuffer=!0;const e=this.privAudioBuffer.shift();try{this.privSourceBuffer.appendBuffer(e)}catch{this.privAudioBuffer.unshift(e),console.log("buffer filled, pausing addition of binaries until space is made");return}await this.notifyPlayback()}else this.canEndStream()&&await this.handleSourceBufferUpdateEnd()}async handleSourceBufferUpdateEnd(){this.canEndStream()&&this.sourceBufferAvailable()&&(this.privMediaSource.endOfStream(),await this.notifyPlayback())}async notifyPlayback(){!this.privPlaybackStarted&&this.privAudio!==void 0&&(this.privPlaybackStarted=!0,this.onAudioStart&&this.onAudioStart(this),this.privAudio.onended=()=>{this.onAudioEnd&&this.onAudioEnd(this)},this.privIsPaused||await this.privAudio.play())}canEndStream(){return this.isClosed&&this.privSourceBuffer!==void 0&&this.privAudioBuffer.length===0&&this.privMediaSourceOpened&&!this.privAppendingToBuffer&&this.privMediaSource.readyState==="open"}sourceBufferAvailable(){return this.privSourceBuffer!==void 0&&!this.privSourceBuffer.updating}}SpeakerAudioDestination$1.SpeakerAudioDestination=SpeakerAudioDestination;var ConversationTranscriptionCanceledEventArgs={},hasRequiredConversationTranscriptionCanceledEventArgs;function requireConversationTranscriptionCanceledEventArgs(){if(hasRequiredConversationTranscriptionCanceledEventArgs)return ConversationTranscriptionCanceledEventArgs;hasRequiredConversationTranscriptionCanceledEventArgs=1,Object.defineProperty(ConversationTranscriptionCanceledEventArgs,"__esModule",{value:!0}),ConversationTranscriptionCanceledEventArgs.ConversationTranscriptionCanceledEventArgs=void 0;const i=requireCancellationEventArgsBase();let e=class extends i.CancellationEventArgsBase{};return ConversationTranscriptionCanceledEventArgs.ConversationTranscriptionCanceledEventArgs=e,ConversationTranscriptionCanceledEventArgs}var MeetingTranscriptionCanceledEventArgs={},hasRequiredMeetingTranscriptionCanceledEventArgs;function requireMeetingTranscriptionCanceledEventArgs(){if(hasRequiredMeetingTranscriptionCanceledEventArgs)return MeetingTranscriptionCanceledEventArgs;hasRequiredMeetingTranscriptionCanceledEventArgs=1,Object.defineProperty(MeetingTranscriptionCanceledEventArgs,"__esModule",{value:!0}),MeetingTranscriptionCanceledEventArgs.MeetingTranscriptionCanceledEventArgs=void 0;const i=requireCancellationEventArgsBase();let e=class extends i.CancellationEventArgsBase{};return MeetingTranscriptionCanceledEventArgs.MeetingTranscriptionCanceledEventArgs=e,MeetingTranscriptionCanceledEventArgs}var PronunciationAssessmentGradingSystem={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.PronunciationAssessmentGradingSystem=void 0,function(e){e[e.FivePoint=1]="FivePoint",e[e.HundredMark=2]="HundredMark"}(i.PronunciationAssessmentGradingSystem||(i.PronunciationAssessmentGradingSystem={}))})(PronunciationAssessmentGradingSystem);var PronunciationAssessmentGranularity={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.PronunciationAssessmentGranularity=void 0,function(e){e[e.Phoneme=1]="Phoneme",e[e.Word=2]="Word",e[e.FullText=3]="FullText"}(i.PronunciationAssessmentGranularity||(i.PronunciationAssessmentGranularity={}))})(PronunciationAssessmentGranularity);var PronunciationAssessmentConfig={},hasRequiredPronunciationAssessmentConfig;function requirePronunciationAssessmentConfig(){if(hasRequiredPronunciationAssessmentConfig)return PronunciationAssessmentConfig;hasRequiredPronunciationAssessmentConfig=1,Object.defineProperty(PronunciationAssessmentConfig,"__esModule",{value:!0}),PronunciationAssessmentConfig.PronunciationAssessmentConfig=void 0;const i=Contracts$1,e=requireExports$3();let t=class xe{constructor(o,a=e.PronunciationAssessmentGradingSystem.FivePoint,c=e.PronunciationAssessmentGranularity.Phoneme,u=!1){i.Contracts.throwIfNullOrUndefined(o,"referenceText"),this.privProperties=new e.PropertyCollection,this.privProperties.setProperty(e.PropertyId.PronunciationAssessment_ReferenceText,o),this.privProperties.setProperty(e.PropertyId.PronunciationAssessment_GradingSystem,e.PronunciationAssessmentGradingSystem[a]),this.privProperties.setProperty(e.PropertyId.PronunciationAssessment_Granularity,e.PronunciationAssessmentGranularity[c]),this.privProperties.setProperty(e.PropertyId.PronunciationAssessment_EnableMiscue,String(u))}static fromJSON(o){i.Contracts.throwIfNullOrUndefined(o,"json");const a=new xe("");return a.privProperties=new e.PropertyCollection,a.properties.setProperty(e.PropertyId.PronunciationAssessment_Json,o),a}toJSON(){return this.updateJson(),this.privProperties.getProperty(e.PropertyId.PronunciationAssessment_Params)}applyTo(o){this.updateJson();const a=o.internalData;a.expectContentAssessmentResponse=!!this.privContentAssessmentTopic,a.speechContext.setPronunciationAssessmentParams(this.properties.getProperty(e.PropertyId.PronunciationAssessment_Params),this.privContentAssessmentTopic,a.isSpeakerDiarizationEnabled)}get referenceText(){return this.properties.getProperty(e.PropertyId.PronunciationAssessment_ReferenceText)}set referenceText(o){i.Contracts.throwIfNullOrWhitespace(o,"referenceText"),this.properties.setProperty(e.PropertyId.PronunciationAssessment_ReferenceText,o)}set phonemeAlphabet(o){i.Contracts.throwIfNullOrWhitespace(o,"phonemeAlphabet"),this.privPhonemeAlphabet=o}set enableMiscue(o){const a=o?"true":"false";this.properties.setProperty(e.PropertyId.PronunciationAssessment_EnableMiscue,a)}get enableMiscue(){return this.properties.getProperty(e.PropertyId.PronunciationAssessment_EnableMiscue,"false").toLowerCase()==="true"}set nbestPhonemeCount(o){this.privNBestPhonemeCount=o}set enableProsodyAssessment(o){this.privEnableProsodyAssessment=o}enableContentAssessmentWithTopic(o){this.privContentAssessmentTopic=o}get properties(){return this.privProperties}updateJson(){const o=this.privProperties.getProperty(e.PropertyId.PronunciationAssessment_Json,"{}"),a=JSON.parse(o),c=this.privProperties.getProperty(e.PropertyId.PronunciationAssessment_ReferenceText);c&&(a.referenceText=c);const u=this.privProperties.getProperty(e.PropertyId.PronunciationAssessment_GradingSystem);u&&(a.gradingSystem=u);const d=this.privProperties.getProperty(e.PropertyId.PronunciationAssessment_Granularity);d&&(a.granularity=d),this.privPhonemeAlphabet&&(a.phonemeAlphabet=this.privPhonemeAlphabet),this.privNBestPhonemeCount&&(a.nbestPhonemeCount=this.privNBestPhonemeCount),a.enableProsodyAssessment=this.privEnableProsodyAssessment,a.dimension="Comprehensive",this.privProperties.getProperty(e.PropertyId.PronunciationAssessment_EnableMiscue)&&(a.enableMiscue=this.enableMiscue),this.privProperties.setProperty(e.PropertyId.PronunciationAssessment_Params,JSON.stringify(a))}};return PronunciationAssessmentConfig.PronunciationAssessmentConfig=t,PronunciationAssessmentConfig}var PronunciationAssessmentResult={},hasRequiredPronunciationAssessmentResult;function requirePronunciationAssessmentResult(){if(hasRequiredPronunciationAssessmentResult)return PronunciationAssessmentResult;hasRequiredPronunciationAssessmentResult=1,Object.defineProperty(PronunciationAssessmentResult,"__esModule",{value:!0}),PronunciationAssessmentResult.PronunciationAssessmentResult=PronunciationAssessmentResult.ContentAssessmentResult=void 0;const i=Contracts$1,e=requireExports$3();class t{constructor(a){this.privPronJson=a}get grammarScore(){return this.privPronJson.ContentAssessment.GrammarScore}get vocabularyScore(){return this.privPronJson.ContentAssessment.VocabularyScore}get topicScore(){return this.privPronJson.ContentAssessment.TopicScore}}PronunciationAssessmentResult.ContentAssessmentResult=t;let s=class Ne{constructor(a){const c=JSON.parse(a);i.Contracts.throwIfNullOrUndefined(c.NBest[0],"NBest"),this.privPronJson=c.NBest[0]}static fromResult(a){i.Contracts.throwIfNullOrUndefined(a,"result");const c=a.properties.getProperty(e.PropertyId.SpeechServiceResponse_JsonResult);return i.Contracts.throwIfNullOrUndefined(c,"json"),new Ne(c)}get detailResult(){return this.privPronJson}get accuracyScore(){var a;return(a=this.detailResult.PronunciationAssessment)==null?void 0:a.AccuracyScore}get pronunciationScore(){var a;return(a=this.detailResult.PronunciationAssessment)==null?void 0:a.PronScore}get completenessScore(){var a;return(a=this.detailResult.PronunciationAssessment)==null?void 0:a.CompletenessScore}get fluencyScore(){var a;return(a=this.detailResult.PronunciationAssessment)==null?void 0:a.FluencyScore}get prosodyScore(){var a;return(a=this.detailResult.PronunciationAssessment)==null?void 0:a.ProsodyScore}get contentAssessmentResult(){if(this.detailResult.ContentAssessment!==void 0)return new t(this.detailResult)}};return PronunciationAssessmentResult.PronunciationAssessmentResult=s,PronunciationAssessmentResult}var AvatarConfig={},hasRequiredAvatarConfig;function requireAvatarConfig(){if(hasRequiredAvatarConfig)return AvatarConfig;hasRequiredAvatarConfig=1,Object.defineProperty(AvatarConfig,"__esModule",{value:!0}),AvatarConfig.AvatarConfig=void 0;const i=Contracts$1,e=requireExports$3();let t=class{constructor(o,a,c){this.privCustomized=!1,i.Contracts.throwIfNullOrWhitespace(o,"character"),this.character=o,this.style=a,c===void 0&&(c=new e.AvatarVideoFormat),this.videoFormat=c}get customized(){return this.privCustomized}set customized(o){this.privCustomized=o}get backgroundColor(){return this.privBackgroundColor}set backgroundColor(o){this.privBackgroundColor=o}get backgroundImage(){return this.privBackgroundImage}set backgroundImage(o){this.privBackgroundImage=o}get remoteIceServers(){return this.privRemoteIceServers}set remoteIceServers(o){this.privRemoteIceServers=o}};return AvatarConfig.AvatarConfig=t,AvatarConfig}var AvatarEventArgs={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.AvatarEventArgs=i.AvatarEventTypes=void 0,function(t){t.SwitchedToSpeaking="SwitchedToSpeaking",t.SwitchedToIdle="SwitchedToIdle",t.SessionClosed="SessionClosed"}(i.AvatarEventTypes||(i.AvatarEventTypes={}));class e{constructor(s,o){this.privOffset=s,this.privDescription=o}get type(){return this.privType}get offset(){return this.privOffset}get description(){return this.privDescription}}i.AvatarEventArgs=e})(AvatarEventArgs);var AvatarSynthesizer={},SpeechSynthesisConnectionFactory={},hasRequiredSpeechSynthesisConnectionFactory;function requireSpeechSynthesisConnectionFactory(){if(hasRequiredSpeechSynthesisConnectionFactory)return SpeechSynthesisConnectionFactory;hasRequiredSpeechSynthesisConnectionFactory=1,Object.defineProperty(SpeechSynthesisConnectionFactory,"__esModule",{value:!0}),SpeechSynthesisConnectionFactory.SpeechSynthesisConnectionFactory=void 0;const i=requireExports$2(),e=requireExports$3(),t=requireConnectionFactoryBase(),s=requireExports(),o=HeaderNames$1,a=QueryParameterNames$1;let c=class{constructor(){this.synthesisUri="/cognitiveservices/websocket/v1"}create(d,p,v){let g=d.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Endpoint,void 0);const m=d.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Region,void 0),S=t.ConnectionFactoryBase.getHostSuffix(m),y=d.parameters.getProperty(e.PropertyId.SpeechServiceConnection_EndpointId,void 0),C=y===void 0?"tts":"voice",R=d.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Host,"wss://"+m+"."+C+".speech"+S),T={},E={};p.token!==void 0&&p.token!==""&&(E[p.headerName]=p.token),E[o.HeaderNames.ConnectionId]=v,y!==void 0&&y!==""&&(!g||g.search(a.QueryParameterNames.CustomVoiceDeploymentId)===-1)&&(T[a.QueryParameterNames.CustomVoiceDeploymentId]=y),d.avatarEnabled&&(!g||g.search(a.QueryParameterNames.EnableAvatar)===-1)&&(T[a.QueryParameterNames.EnableAvatar]="true"),g||(g=R+this.synthesisUri),d.parameters.setProperty(e.PropertyId.SpeechServiceConnection_Url,g);const A=d.parameters.getProperty("SPEECH-EnableWebsocketCompression","false")==="true";return new i.WebsocketConnection(g,T,E,new s.WebsocketMessageFormatter,i.ProxyInfo.fromParameters(d.parameters),A,v)}};return SpeechSynthesisConnectionFactory.SpeechSynthesisConnectionFactory=c,SpeechSynthesisConnectionFactory}var hasRequiredAvatarSynthesizer;function requireAvatarSynthesizer(){if(hasRequiredAvatarSynthesizer)return AvatarSynthesizer;hasRequiredAvatarSynthesizer=1,Object.defineProperty(AvatarSynthesizer,"__esModule",{value:!0}),AvatarSynthesizer.AvatarSynthesizer=void 0;const i=requireSpeechSynthesisConnectionFactory(),e=requireExports(),t=requireExports$5(),s=AudioOutputFormat,o=requireExports$3(),a=Contracts$1,c=requireSynthesizer();let u=class extends o.Synthesizer{constructor(p,v){super(p),a.Contracts.throwIfNullOrUndefined(v,"avatarConfig"),this.privConnectionFactory=new i.SpeechSynthesisConnectionFactory,this.privAvatarConfig=v,this.implCommonSynthesizeSetup()}implCommonSynthesizeSetup(){super.implCommonSynthesizeSetup(),this.privAdapter.audioOutputFormat=s.AudioOutputFormatImpl.fromSpeechSynthesisOutputFormat(o.SpeechSynthesisOutputFormat.Riff24Khz16BitMonoPcm)}async startAvatarAsync(p){a.Contracts.throwIfNullOrUndefined(p,"peerConnection"),this.privIceServers=p.getConfiguration().iceServers,a.Contracts.throwIfNullOrUndefined(this.privIceServers,"Ice servers must be set.");const v=new t.Deferred;p.onicegatheringstatechange=()=>{t.Events.instance.onEvent(new t.PlatformEvent("peer connection: ice gathering state: "+p.iceGatheringState,t.EventType.Debug)),p.iceGatheringState==="complete"&&(t.Events.instance.onEvent(new t.PlatformEvent("peer connection: ice gathering complete.",t.EventType.Info)),v.resolve())},p.onicecandidate=C=>{C.candidate?t.Events.instance.onEvent(new t.PlatformEvent("peer connection: ice candidate: "+C.candidate.candidate,t.EventType.Debug)):(t.Events.instance.onEvent(new t.PlatformEvent("peer connection: ice candidate: complete",t.EventType.Debug)),v.resolve())},setTimeout(()=>{p.iceGatheringState!=="complete"&&(t.Events.instance.onEvent(new t.PlatformEvent("peer connection: ice gathering timeout.",t.EventType.Warning)),v.resolve())},2e3);const g=await p.createOffer();await p.setLocalDescription(g),await v.promise,t.Events.instance.onEvent(new t.PlatformEvent("peer connection: got local SDP.",t.EventType.Info)),this.privProperties.setProperty(o.PropertyId.TalkingAvatarService_WebRTC_SDP,JSON.stringify(p.localDescription));const m=await this.speak("",!1);if(m.reason!==o.ResultReason.SynthesizingAudioCompleted)return new o.SynthesisResult(m.resultId,m.reason,m.errorDetails,m.properties);const S=atob(m.properties.getProperty(o.PropertyId.TalkingAvatarService_WebRTC_SDP)),y=new RTCSessionDescription(JSON.parse(S));return await p.setRemoteDescription(y),new o.SynthesisResult(m.resultId,m.reason,void 0,m.properties)}async speakTextAsync(p){const v=await this.speak(p,!1);return new o.SynthesisResult(v.resultId,v.reason,v.errorDetails,v.properties)}async speakSsmlAsync(p){const v=await this.speak(p,!0);return new o.SynthesisResult(v.resultId,v.reason,v.errorDetails,v.properties)}async stopSpeakingAsync(){for(;this.synthesisRequestQueue.length()>0;)(await this.synthesisRequestQueue.dequeue()).err("Synthesis is canceled by user.");return this.privAdapter.stopSpeaking()}async stopAvatarAsync(){return a.Contracts.throwIfDisposed(this.privDisposed),this.dispose(!0)}async close(){if(!this.privDisposed)return this.dispose(!0)}get iceServers(){return this.privIceServers}createSynthesisAdapter(p,v,g){return new e.AvatarSynthesisAdapter(p,v,g,this,this.privAvatarConfig)}createRestSynthesisAdapter(p,v){}createSynthesizerConfig(p){const v=super.createSynthesizerConfig(p);return v.avatarEnabled=!0,v}async speak(p,v){const g=t.createNoDashGuid(),m=new t.Deferred;return this.synthesisRequestQueue.enqueue(new c.SynthesisRequest(g,p,v,S=>{m.resolve(S),this.privSynthesizing=!1,this.adapterSpeak()},S=>{m.reject(S),this.privSynthesizing=!1})),this.adapterSpeak(),m.promise}};return AvatarSynthesizer.AvatarSynthesizer=u,AvatarSynthesizer}var AvatarVideoFormat$1={};Object.defineProperty(AvatarVideoFormat$1,"__esModule",{value:!0});AvatarVideoFormat$1.AvatarVideoFormat=AvatarVideoFormat$1.Coordinate=void 0;class Coordinate{constructor(e,t){this.x=e,this.y=t}}AvatarVideoFormat$1.Coordinate=Coordinate;class AvatarVideoFormat{constructor(e="H264",t=2e6,s=1920,o=1080){this.codec=e,this.bitrate=t,this.width=s,this.height=o}setCropRange(e,t){this.cropRange={bottomRight:t,topLeft:e}}}AvatarVideoFormat$1.AvatarVideoFormat=AvatarVideoFormat;var AvatarWebRTCConnectionResult={},hasRequiredAvatarWebRTCConnectionResult;function requireAvatarWebRTCConnectionResult(){if(hasRequiredAvatarWebRTCConnectionResult)return AvatarWebRTCConnectionResult;hasRequiredAvatarWebRTCConnectionResult=1,Object.defineProperty(AvatarWebRTCConnectionResult,"__esModule",{value:!0}),AvatarWebRTCConnectionResult.AvatarWebRTCConnectionResult=void 0;const i=requireExports$3();let e=class extends i.SynthesisResult{constructor(s,o,a,c,u){super(o,a,c,u),this.privSDPAnswer=s}get SDPAnswer(){return this.privSDPAnswer}};return AvatarWebRTCConnectionResult.AvatarWebRTCConnectionResult=e,AvatarWebRTCConnectionResult}var Diagnostics={},hasRequiredDiagnostics;function requireDiagnostics(){if(hasRequiredDiagnostics)return Diagnostics;hasRequiredDiagnostics=1,Object.defineProperty(Diagnostics,"__esModule",{value:!0}),Diagnostics.Diagnostics=void 0;const i=requireExports$2(),e=requireExports$5();let t=class{static SetLoggingLevel(o){this.privListener=new i.ConsoleLoggingListener(o),e.Events.instance.attachConsoleListener(this.privListener)}static StartConsoleOutput(){this.privListener&&(this.privListener.enableConsoleOutput=!0)}static StopConsoleOutput(){this.privListener&&(this.privListener.enableConsoleOutput=!1)}static SetLogOutputPath(o){if(typeof window>"u")this.privListener&&(this.privListener.logPath=o);else throw new Error("File system logging not available in browser.")}static set onLogOutput(o){this.privListener&&(this.privListener.logCallback=o)}};return Diagnostics.Diagnostics=t,t.privListener=void 0,Diagnostics}var hasRequiredExports$3;function requireExports$3(){return hasRequiredExports$3||(hasRequiredExports$3=1,function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=requireAudioConfig();Object.defineProperty(i,"AudioConfig",{enumerable:!0,get:function(){return e.AudioConfig}});var t=AudioStreamFormat;Object.defineProperty(i,"AudioStreamFormat",{enumerable:!0,get:function(){return t.AudioStreamFormat}}),Object.defineProperty(i,"AudioFormatTag",{enumerable:!0,get:function(){return t.AudioFormatTag}});var s=requireAudioInputStream();Object.defineProperty(i,"AudioInputStream",{enumerable:!0,get:function(){return s.AudioInputStream}}),Object.defineProperty(i,"PullAudioInputStream",{enumerable:!0,get:function(){return s.PullAudioInputStream}}),Object.defineProperty(i,"PushAudioInputStream",{enumerable:!0,get:function(){return s.PushAudioInputStream}});var o=AudioOutputStream$1;Object.defineProperty(i,"AudioOutputStream",{enumerable:!0,get:function(){return o.AudioOutputStream}}),Object.defineProperty(i,"PullAudioOutputStream",{enumerable:!0,get:function(){return o.PullAudioOutputStream}}),Object.defineProperty(i,"PushAudioOutputStream",{enumerable:!0,get:function(){return o.PushAudioOutputStream}});var a=CancellationReason;Object.defineProperty(i,"CancellationReason",{enumerable:!0,get:function(){return a.CancellationReason}});var c=PullAudioInputStreamCallback$1;Object.defineProperty(i,"PullAudioInputStreamCallback",{enumerable:!0,get:function(){return c.PullAudioInputStreamCallback}});var u=PushAudioOutputStreamCallback$1;Object.defineProperty(i,"PushAudioOutputStreamCallback",{enumerable:!0,get:function(){return u.PushAudioOutputStreamCallback}});var d=KeywordRecognitionModel$1;Object.defineProperty(i,"KeywordRecognitionModel",{enumerable:!0,get:function(){return d.KeywordRecognitionModel}});var p=SessionEventArgs$1;Object.defineProperty(i,"SessionEventArgs",{enumerable:!0,get:function(){return p.SessionEventArgs}});var v=requireRecognitionEventArgs();Object.defineProperty(i,"RecognitionEventArgs",{enumerable:!0,get:function(){return v.RecognitionEventArgs}});var g=OutputFormat;Object.defineProperty(i,"OutputFormat",{enumerable:!0,get:function(){return g.OutputFormat}});var m=requireIntentRecognitionEventArgs();Object.defineProperty(i,"IntentRecognitionEventArgs",{enumerable:!0,get:function(){return m.IntentRecognitionEventArgs}});var S=RecognitionResult$1;Object.defineProperty(i,"RecognitionResult",{enumerable:!0,get:function(){return S.RecognitionResult}});var y=requireSpeechRecognitionResult();Object.defineProperty(i,"SpeechRecognitionResult",{enumerable:!0,get:function(){return y.SpeechRecognitionResult}});var C=requireIntentRecognitionResult();Object.defineProperty(i,"IntentRecognitionResult",{enumerable:!0,get:function(){return C.IntentRecognitionResult}});var R=LanguageUnderstandingModel$1;Object.defineProperty(i,"LanguageUnderstandingModel",{enumerable:!0,get:function(){return R.LanguageUnderstandingModel}});var T=requireSpeechRecognitionEventArgs();Object.defineProperty(i,"SpeechRecognitionEventArgs",{enumerable:!0,get:function(){return T.SpeechRecognitionEventArgs}}),Object.defineProperty(i,"ConversationTranscriptionEventArgs",{enumerable:!0,get:function(){return T.ConversationTranscriptionEventArgs}}),Object.defineProperty(i,"MeetingTranscriptionEventArgs",{enumerable:!0,get:function(){return T.MeetingTranscriptionEventArgs}});var E=requireSpeechRecognitionCanceledEventArgs();Object.defineProperty(i,"SpeechRecognitionCanceledEventArgs",{enumerable:!0,get:function(){return E.SpeechRecognitionCanceledEventArgs}});var A=requireTranslationRecognitionEventArgs();Object.defineProperty(i,"TranslationRecognitionEventArgs",{enumerable:!0,get:function(){return A.TranslationRecognitionEventArgs}});var b=requireTranslationSynthesisEventArgs();Object.defineProperty(i,"TranslationSynthesisEventArgs",{enumerable:!0,get:function(){return b.TranslationSynthesisEventArgs}});var P=requireTranslationRecognitionResult();Object.defineProperty(i,"TranslationRecognitionResult",{enumerable:!0,get:function(){return P.TranslationRecognitionResult}});var _=TranslationSynthesisResult$1;Object.defineProperty(i,"TranslationSynthesisResult",{enumerable:!0,get:function(){return _.TranslationSynthesisResult}});var w=ResultReason;Object.defineProperty(i,"ResultReason",{enumerable:!0,get:function(){return w.ResultReason}});var I=requireSpeechConfig();Object.defineProperty(i,"SpeechConfig",{enumerable:!0,get:function(){return I.SpeechConfig}}),Object.defineProperty(i,"SpeechConfigImpl",{enumerable:!0,get:function(){return I.SpeechConfigImpl}});var D=requireSpeechTranslationConfig();Object.defineProperty(i,"SpeechTranslationConfig",{enumerable:!0,get:function(){return D.SpeechTranslationConfig}}),Object.defineProperty(i,"SpeechTranslationConfigImpl",{enumerable:!0,get:function(){return D.SpeechTranslationConfigImpl}});var N=requirePropertyCollection();Object.defineProperty(i,"PropertyCollection",{enumerable:!0,get:function(){return N.PropertyCollection}});var L=PropertyId;Object.defineProperty(i,"PropertyId",{enumerable:!0,get:function(){return L.PropertyId}});var j=requireRecognizer();Object.defineProperty(i,"Recognizer",{enumerable:!0,get:function(){return j.Recognizer}});var z=requireSpeechRecognizer();Object.defineProperty(i,"SpeechRecognizer",{enumerable:!0,get:function(){return z.SpeechRecognizer}});var U=requireIntentRecognizer();Object.defineProperty(i,"IntentRecognizer",{enumerable:!0,get:function(){return U.IntentRecognizer}});var Y=VoiceProfileType;Object.defineProperty(i,"VoiceProfileType",{enumerable:!0,get:function(){return Y.VoiceProfileType}});var ne=requireTranslationRecognizer();Object.defineProperty(i,"TranslationRecognizer",{enumerable:!0,get:function(){return ne.TranslationRecognizer}});var se=requireTranslations();Object.defineProperty(i,"Translations",{enumerable:!0,get:function(){return se.Translations}});var te=NoMatchReason;Object.defineProperty(i,"NoMatchReason",{enumerable:!0,get:function(){return te.NoMatchReason}});var oe=requireNoMatchDetails();Object.defineProperty(i,"NoMatchDetails",{enumerable:!0,get:function(){return oe.NoMatchDetails}});var K=TranslationRecognitionCanceledEventArgs$1;Object.defineProperty(i,"TranslationRecognitionCanceledEventArgs",{enumerable:!0,get:function(){return K.TranslationRecognitionCanceledEventArgs}});var re=requireIntentRecognitionCanceledEventArgs();Object.defineProperty(i,"IntentRecognitionCanceledEventArgs",{enumerable:!0,get:function(){return re.IntentRecognitionCanceledEventArgs}});var X=CancellationDetailsBase$1;Object.defineProperty(i,"CancellationDetailsBase",{enumerable:!0,get:function(){return X.CancellationDetailsBase}});var ae=requireCancellationDetails();Object.defineProperty(i,"CancellationDetails",{enumerable:!0,get:function(){return ae.CancellationDetails}});var J=CancellationErrorCodes;Object.defineProperty(i,"CancellationErrorCode",{enumerable:!0,get:function(){return J.CancellationErrorCode}});var ce=requireConnectionEventArgs();Object.defineProperty(i,"ConnectionEventArgs",{enumerable:!0,get:function(){return ce.ConnectionEventArgs}});var ue=requireServiceEventArgs();Object.defineProperty(i,"ServiceEventArgs",{enumerable:!0,get:function(){return ue.ServiceEventArgs}});var de=requireConnection();Object.defineProperty(i,"Connection",{enumerable:!0,get:function(){return de.Connection}});var V=PhraseListGrammar$1;Object.defineProperty(i,"PhraseListGrammar",{enumerable:!0,get:function(){return V.PhraseListGrammar}});var M=requireDialogServiceConfig();Object.defineProperty(i,"DialogServiceConfig",{enumerable:!0,get:function(){return M.DialogServiceConfig}});var O=requireBotFrameworkConfig();Object.defineProperty(i,"BotFrameworkConfig",{enumerable:!0,get:function(){return O.BotFrameworkConfig}});var x=requireCustomCommandsConfig();Object.defineProperty(i,"CustomCommandsConfig",{enumerable:!0,get:function(){return x.CustomCommandsConfig}});var q=requireDialogServiceConnector();Object.defineProperty(i,"DialogServiceConnector",{enumerable:!0,get:function(){return q.DialogServiceConnector}});var $=ActivityReceivedEventArgs$1;Object.defineProperty(i,"ActivityReceivedEventArgs",{enumerable:!0,get:function(){return $.ActivityReceivedEventArgs}});var F=TurnStatusReceivedEventArgs$1;Object.defineProperty(i,"TurnStatusReceivedEventArgs",{enumerable:!0,get:function(){return F.TurnStatusReceivedEventArgs}});var B=ServicePropertyChannel;Object.defineProperty(i,"ServicePropertyChannel",{enumerable:!0,get:function(){return B.ServicePropertyChannel}});var G=ProfanityOption;Object.defineProperty(i,"ProfanityOption",{enumerable:!0,get:function(){return G.ProfanityOption}});var W=requireBaseAudioPlayer();Object.defineProperty(i,"BaseAudioPlayer",{enumerable:!0,get:function(){return W.BaseAudioPlayer}});var Q=ConnectionMessageEventArgs$1;Object.defineProperty(i,"ConnectionMessageEventArgs",{enumerable:!0,get:function(){return Q.ConnectionMessageEventArgs}});var ge=requireConnectionMessage();Object.defineProperty(i,"ConnectionMessage",{enumerable:!0,get:function(){return ge.ConnectionMessage}});var Z=VoiceProfile$1;Object.defineProperty(i,"VoiceProfile",{enumerable:!0,get:function(){return Z.VoiceProfile}});var me=requireVoiceProfileEnrollmentResult();Object.defineProperty(i,"VoiceProfileEnrollmentResult",{enumerable:!0,get:function(){return me.VoiceProfileEnrollmentResult}}),Object.defineProperty(i,"VoiceProfileEnrollmentCancellationDetails",{enumerable:!0,get:function(){return me.VoiceProfileEnrollmentCancellationDetails}});var Se=requireVoiceProfileResult();Object.defineProperty(i,"VoiceProfileResult",{enumerable:!0,get:function(){return Se.VoiceProfileResult}}),Object.defineProperty(i,"VoiceProfileCancellationDetails",{enumerable:!0,get:function(){return Se.VoiceProfileCancellationDetails}});var Fe=requireVoiceProfilePhraseResult();Object.defineProperty(i,"VoiceProfilePhraseResult",{enumerable:!0,get:function(){return Fe.VoiceProfilePhraseResult}});var ze=requireVoiceProfileClient();Object.defineProperty(i,"VoiceProfileClient",{enumerable:!0,get:function(){return ze.VoiceProfileClient}});var Be=requireSpeakerRecognizer();Object.defineProperty(i,"SpeakerRecognizer",{enumerable:!0,get:function(){return Be.SpeakerRecognizer}});var Ue=requireSpeakerIdentificationModel();Object.defineProperty(i,"SpeakerIdentificationModel",{enumerable:!0,get:function(){return Ue.SpeakerIdentificationModel}});var Ve=requireSpeakerVerificationModel();Object.defineProperty(i,"SpeakerVerificationModel",{enumerable:!0,get:function(){return Ve.SpeakerVerificationModel}});var We=requireAutoDetectSourceLanguageConfig();Object.defineProperty(i,"AutoDetectSourceLanguageConfig",{enumerable:!0,get:function(){return We.AutoDetectSourceLanguageConfig}});var He=AutoDetectSourceLanguageResult$1;Object.defineProperty(i,"AutoDetectSourceLanguageResult",{enumerable:!0,get:function(){return He.AutoDetectSourceLanguageResult}});var Ke=SourceLanguageConfig$1;Object.defineProperty(i,"SourceLanguageConfig",{enumerable:!0,get:function(){return Ke.SourceLanguageConfig}});var le=requireSpeakerRecognitionResult();Object.defineProperty(i,"SpeakerRecognitionResult",{enumerable:!0,get:function(){return le.SpeakerRecognitionResult}}),Object.defineProperty(i,"SpeakerRecognitionResultType",{enumerable:!0,get:function(){return le.SpeakerRecognitionResultType}}),Object.defineProperty(i,"SpeakerRecognitionCancellationDetails",{enumerable:!0,get:function(){return le.SpeakerRecognitionCancellationDetails}});var H=requireExports$4();Object.defineProperty(i,"Conversation",{enumerable:!0,get:function(){return H.Conversation}}),Object.defineProperty(i,"ConversationExpirationEventArgs",{enumerable:!0,get:function(){return H.ConversationExpirationEventArgs}}),Object.defineProperty(i,"ConversationParticipantsChangedEventArgs",{enumerable:!0,get:function(){return H.ConversationParticipantsChangedEventArgs}}),Object.defineProperty(i,"ConversationTranslationCanceledEventArgs",{enumerable:!0,get:function(){return H.ConversationTranslationCanceledEventArgs}}),Object.defineProperty(i,"ConversationTranslationEventArgs",{enumerable:!0,get:function(){return H.ConversationTranslationEventArgs}}),Object.defineProperty(i,"ConversationTranslationResult",{enumerable:!0,get:function(){return H.ConversationTranslationResult}}),Object.defineProperty(i,"ConversationTranslator",{enumerable:!0,get:function(){return H.ConversationTranslator}}),Object.defineProperty(i,"ConversationTranscriber",{enumerable:!0,get:function(){return H.ConversationTranscriber}}),Object.defineProperty(i,"ConversationTranscriptionResult",{enumerable:!0,get:function(){return H.ConversationTranscriptionResult}}),Object.defineProperty(i,"Meeting",{enumerable:!0,get:function(){return H.Meeting}}),Object.defineProperty(i,"MeetingTranscriber",{enumerable:!0,get:function(){return H.MeetingTranscriber}}),Object.defineProperty(i,"Participant",{enumerable:!0,get:function(){return H.Participant}}),Object.defineProperty(i,"ParticipantChangedReason",{enumerable:!0,get:function(){return H.ParticipantChangedReason}}),Object.defineProperty(i,"User",{enumerable:!0,get:function(){return H.User}});var Ge=requireSynthesizer();Object.defineProperty(i,"Synthesizer",{enumerable:!0,get:function(){return Ge.Synthesizer}});var Je=SpeechSynthesisOutputFormat;Object.defineProperty(i,"SpeechSynthesisOutputFormat",{enumerable:!0,get:function(){return Je.SpeechSynthesisOutputFormat}});var Qe=requireSpeechSynthesizer();Object.defineProperty(i,"SpeechSynthesizer",{enumerable:!0,get:function(){return Qe.SpeechSynthesizer}});var Ye=SynthesisResult$1;Object.defineProperty(i,"SynthesisResult",{enumerable:!0,get:function(){return Ye.SynthesisResult}});var Xe=requireSpeechSynthesisResult();Object.defineProperty(i,"SpeechSynthesisResult",{enumerable:!0,get:function(){return Xe.SpeechSynthesisResult}});var Ze=SpeechSynthesisEventArgs$1;Object.defineProperty(i,"SpeechSynthesisEventArgs",{enumerable:!0,get:function(){return Ze.SpeechSynthesisEventArgs}});var et=SpeechSynthesisWordBoundaryEventArgs$1;Object.defineProperty(i,"SpeechSynthesisWordBoundaryEventArgs",{enumerable:!0,get:function(){return et.SpeechSynthesisWordBoundaryEventArgs}});var tt=SpeechSynthesisBookmarkEventArgs$1;Object.defineProperty(i,"SpeechSynthesisBookmarkEventArgs",{enumerable:!0,get:function(){return tt.SpeechSynthesisBookmarkEventArgs}});var rt=SpeechSynthesisVisemeEventArgs$1;Object.defineProperty(i,"SpeechSynthesisVisemeEventArgs",{enumerable:!0,get:function(){return rt.SpeechSynthesisVisemeEventArgs}});var it=SpeechSynthesisBoundaryType;Object.defineProperty(i,"SpeechSynthesisBoundaryType",{enumerable:!0,get:function(){return it.SpeechSynthesisBoundaryType}});var nt=requireSynthesisVoicesResult();Object.defineProperty(i,"SynthesisVoicesResult",{enumerable:!0,get:function(){return nt.SynthesisVoicesResult}});var st=VoiceInfo;Object.defineProperty(i,"VoiceInfo",{enumerable:!0,get:function(){return st.VoiceInfo}});var ot=SpeakerAudioDestination$1;Object.defineProperty(i,"SpeakerAudioDestination",{enumerable:!0,get:function(){return ot.SpeakerAudioDestination}});var at=requireConversationTranscriptionCanceledEventArgs();Object.defineProperty(i,"ConversationTranscriptionCanceledEventArgs",{enumerable:!0,get:function(){return at.ConversationTranscriptionCanceledEventArgs}});var ct=requireMeetingTranscriptionCanceledEventArgs();Object.defineProperty(i,"MeetingTranscriptionCanceledEventArgs",{enumerable:!0,get:function(){return ct.MeetingTranscriptionCanceledEventArgs}});var ut=PronunciationAssessmentGradingSystem;Object.defineProperty(i,"PronunciationAssessmentGradingSystem",{enumerable:!0,get:function(){return ut.PronunciationAssessmentGradingSystem}});var dt=PronunciationAssessmentGranularity;Object.defineProperty(i,"PronunciationAssessmentGranularity",{enumerable:!0,get:function(){return dt.PronunciationAssessmentGranularity}});var lt=requirePronunciationAssessmentConfig();Object.defineProperty(i,"PronunciationAssessmentConfig",{enumerable:!0,get:function(){return lt.PronunciationAssessmentConfig}});var pt=requirePronunciationAssessmentResult();Object.defineProperty(i,"PronunciationAssessmentResult",{enumerable:!0,get:function(){return pt.PronunciationAssessmentResult}});var ht=LanguageIdMode;Object.defineProperty(i,"LanguageIdMode",{enumerable:!0,get:function(){return ht.LanguageIdMode}});var ft=requireAvatarConfig();Object.defineProperty(i,"AvatarConfig",{enumerable:!0,get:function(){return ft.AvatarConfig}});var vt=AvatarEventArgs;Object.defineProperty(i,"AvatarEventArgs",{enumerable:!0,get:function(){return vt.AvatarEventArgs}});var gt=requireAvatarSynthesizer();Object.defineProperty(i,"AvatarSynthesizer",{enumerable:!0,get:function(){return gt.AvatarSynthesizer}});var ye=AvatarVideoFormat$1;Object.defineProperty(i,"AvatarVideoFormat",{enumerable:!0,get:function(){return ye.AvatarVideoFormat}}),Object.defineProperty(i,"Coordinate",{enumerable:!0,get:function(){return ye.Coordinate}});var mt=requireAvatarWebRTCConnectionResult();Object.defineProperty(i,"AvatarWebRTCConnectionResult",{enumerable:!0,get:function(){return mt.AvatarWebRTCConnectionResult}});var St=requireDiagnostics();Object.defineProperty(i,"Diagnostics",{enumerable:!0,get:function(){return St.Diagnostics}});var yt=LogLevel;Object.defineProperty(i,"LogLevel",{enumerable:!0,get:function(){return yt.LogLevel}})}(Exports$3)),Exports$3}var hasRequiredProxyInfo;function requireProxyInfo(){if(hasRequiredProxyInfo)return ProxyInfo;hasRequiredProxyInfo=1,Object.defineProperty(ProxyInfo,"__esModule",{value:!0}),ProxyInfo.ProxyInfo=void 0;const i=requireExports$3();let e=class Le{constructor(s,o,a,c){this.privProxyHostName=s,this.privProxyPort=o,this.privProxyUserName=a,this.privProxyPassword=c}static fromParameters(s){return new Le(s.getProperty(i.PropertyId.SpeechServiceConnection_ProxyHostName),parseInt(s.getProperty(i.PropertyId.SpeechServiceConnection_ProxyPort),10),s.getProperty(i.PropertyId.SpeechServiceConnection_ProxyUserName),s.getProperty(i.PropertyId.SpeechServiceConnection_ProxyPassword))}static fromRecognizerConfig(s){return this.fromParameters(s.parameters)}get HostName(){return this.privProxyHostName}get Port(){return this.privProxyPort}get UserName(){return this.privProxyUserName}get Password(){return this.privProxyPassword}};return ProxyInfo.ProxyInfo=e,ProxyInfo}var RestMessageAdapter={};const encodings=new Set(["json","buffer","string"]);var core$1=i=>(...e)=>{const t=new Set;let s,o,a,c="";return e.forEach(u=>{if(typeof u=="string")if(u.toUpperCase()===u)if(s){const d=`Can't set method to ${u}, already set to ${s}.`;throw new Error(d)}else s=u;else if(u.startsWith("http:")||u.startsWith("https:"))c=u;else if(encodings.has(u))o=u;else throw new Error(`Unknown encoding, ${u}`);else if(typeof u=="number")t.add(u);else if(typeof u=="object")if(Array.isArray(u)||u instanceof Set)u.forEach(d=>t.add(d));else{if(a)throw new Error("Cannot set headers twice.");a=u}else throw new Error(`Unknown type: ${typeof u}`)}),s||(s="GET"),t.size===0&&t.add(200),i(t,s,o,a,c)};const core=core$1;class StatusError extends Error{constructor(e,...t){super(...t),Error.captureStackTrace&&Error.captureStackTrace(this,StatusError),this.name="StatusError",this.message=e.statusMessage,this.statusCode=e.status,this.res=e,this.json=e.json.bind(e),this.text=e.text.bind(e),this.arrayBuffer=e.arrayBuffer.bind(e);let s;Object.defineProperty(this,"responseBody",{get:()=>(s||(s=this.arrayBuffer()),s)}),this.headers={};for(const[a,c]of e.headers.entries())this.headers[a.toLowerCase()]=c}}const mkrequest=(i,e,t,s,o)=>async(a,c,u={})=>{a=o+(a||"");let d=new URL(a);if(s||(s={}),d.username&&(s.Authorization="Basic "+btoa(d.username+":"+d.password),d=new URL(d.protocol+"//"+d.host+d.pathname+d.search)),d.protocol!=="https:"&&d.protocol!=="http:")throw new Error(`Unknown protocol, ${d.protocol}`);if(c&&!(c instanceof ArrayBuffer||ArrayBuffer.isView(c)||typeof c=="string"))if(typeof c=="object")c=JSON.stringify(c),s["Content-Type"]="application/json";else throw new Error("Unknown body type.");u=new Headers({...s||{},...u});const p=await fetch(d,{method:e,headers:u,body:c});if(p.statusCode=p.status,!i.has(p.status))throw new StatusError(p);return t==="json"?p.json():t==="buffer"?p.arrayBuffer():t==="string"?p.text():p};var browser=core(mkrequest);(function(i){var e=commonjsGlobal&&commonjsGlobal.__importDefault||function(c){return c&&c.__esModule?c:{default:c}};Object.defineProperty(i,"__esModule",{value:!0}),i.RestMessageAdapter=i.RestRequestType=void 0;const t=e(browser),s=requireExports$5();var o;(function(c){c.Get="GET",c.Post="POST",c.Delete="DELETE",c.File="file"})(o=i.RestRequestType||(i.RestRequestType={}));class a{constructor(u){if(!u)throw new s.ArgumentNullError("configParams");this.privHeaders=u.headers,this.privIgnoreCache=u.ignoreCache}static extractHeaderValue(u,d){let p="";try{const v=d.trim().split(/[\r\n]+/),g={};v.forEach(m=>{const S=m.split(": "),y=S.shift().toLowerCase(),C=S.join(": ");g[y]=C}),p=g[u.toLowerCase()]}catch{}return p}set options(u){this.privHeaders=u.headers,this.privIgnoreCache=u.ignoreCache}setHeaders(u,d){this.privHeaders[u]=d}request(u,d,p={},v=null){const g=new s.Deferred,m=u===o.File?"POST":u,S=(C,R={})=>{const T=C;return{data:JSON.stringify(R),headers:JSON.stringify(C.headers),json:R,ok:C.statusCode>=200&&C.statusCode<300,status:C.statusCode,statusText:R.error?R.error.message:T.statusText?T.statusText:T.statusMessage}},y=C=>{const R=t.default(d,m,this.privHeaders,200,201,202,204,400,401,402,403,404),T=this.queryParams(p)===""?"":`?${this.queryParams(p)}`;R(T,C).then(async E=>{if(u===o.Delete||E.statusCode===204)g.resolve(S(E));else try{const A=await E.json();g.resolve(S(E,A))}catch{g.resolve(S(E))}}).catch(E=>{g.reject(E)})};return this.privIgnoreCache&&(this.privHeaders["Cache-Control"]="no-cache"),u===o.Post&&v&&(this.privHeaders["content-type"]="application/json",this.privHeaders["Content-Type"]="application/json"),y(v),g.promise}queryParams(u={}){return Object.keys(u).map(d=>encodeURIComponent(d)+"="+encodeURIComponent(u[d])).join("&")}}i.RestMessageAdapter=a})(RestMessageAdapter);var RestConfigBase$1={};Object.defineProperty(RestConfigBase$1,"__esModule",{value:!0});RestConfigBase$1.RestConfigBase=void 0;class RestConfigBase{static get requestOptions(){return RestConfigBase.privDefaultRequestOptions}static get configParams(){return RestConfigBase.privDefaultParams}static get restErrors(){return RestConfigBase.privRestErrors}}RestConfigBase$1.RestConfigBase=RestConfigBase;RestConfigBase.privDefaultRequestOptions={headers:{Accept:"application/json"},ignoreCache:!1,timeout:1e4};RestConfigBase.privRestErrors={authInvalidSubscriptionKey:"You must specify either an authentication token to use, or a Cognitive Speech subscription key.",authInvalidSubscriptionRegion:"You must specify the Cognitive Speech region to use.",invalidArgs:"Required input not found: {arg}.",invalidCreateJoinConversationResponse:"Creating/Joining conversation failed with HTTP {status}.",invalidParticipantRequest:"The requested participant was not found.",permissionDeniedConnect:"Required credentials not found.",permissionDeniedConversation:"Invalid operation: only the host can {command} the conversation.",permissionDeniedParticipant:"Invalid operation: only the host can {command} a participant.",permissionDeniedSend:"Invalid operation: the conversation is not in a connected state.",permissionDeniedStart:"Invalid operation: there is already an active conversation."};RestConfigBase.privDefaultParams={apiVersion:"api-version",authorization:"Authorization",clientAppId:"X-ClientAppId",contentTypeKey:"Content-Type",correlationId:"X-CorrelationId",languageCode:"language",nickname:"nickname",profanity:"profanity",requestId:"X-RequestId",roomId:"roomid",sessionToken:"token",subscriptionKey:"Ocp-Apim-Subscription-Key",subscriptionRegion:"Ocp-Apim-Subscription-Region",token:"X-CapitoToken"};var hasRequiredExports$2;function requireExports$2(){return hasRequiredExports$2||(hasRequiredExports$2=1,function(i){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(s,o,a,c){c===void 0&&(c=a),Object.defineProperty(s,c,{enumerable:!0,get:function(){return o[a]}})}:function(s,o,a,c){c===void 0&&(c=a),s[c]=o[a]}),t=commonjsGlobal&&commonjsGlobal.__exportStar||function(s,o){for(var a in s)a!=="default"&&!o.hasOwnProperty(a)&&e(o,s,a)};Object.defineProperty(i,"__esModule",{value:!0}),t(ConsoleLoggingListener$1,i),t(IRecorder,i),t(requireMicAudioSource(),i),t(requireFileAudioSource(),i),t(PCMRecorder,i),t(WebsocketConnection$1,i),t(WebsocketMessageAdapter$1,i),t(ReplayableAudioNode$1,i),t(requireProxyInfo(),i),t(RestMessageAdapter,i),t(RestConfigBase$1,i)}(Exports$4)),Exports$4}var hasRequiredIntentConnectionFactory;function requireIntentConnectionFactory(){if(hasRequiredIntentConnectionFactory)return IntentConnectionFactory;hasRequiredIntentConnectionFactory=1,Object.defineProperty(IntentConnectionFactory,"__esModule",{value:!0}),IntentConnectionFactory.IntentConnectionFactory=void 0;const i=requireExports$2(),e=requireExports$3(),t=requireConnectionFactoryBase(),s=requireExports(),o=HeaderNames$1;let a=class extends t.ConnectionFactoryBase{create(u,d,p){let v=u.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Endpoint);if(!v){const y=u.parameters.getProperty(e.PropertyId.SpeechServiceConnection_IntentRegion),C=t.ConnectionFactoryBase.getHostSuffix(y);v=u.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Host,"wss://"+y+".sr.speech"+C)+"/speech/recognition/interactive/cognitiveservices/v1"}const g={format:"simple",language:u.parameters.getProperty(e.PropertyId.SpeechServiceConnection_RecoLanguage)};this.setCommonUrlParams(u,g,v);const m={};d.token!==void 0&&d.token!==""&&(m[d.headerName]=d.token),m[o.HeaderNames.ConnectionId]=p,u.parameters.setProperty(e.PropertyId.SpeechServiceConnection_Url,v);const S=u.parameters.getProperty("SPEECH-EnableWebsocketCompression","false")==="true";return new i.WebsocketConnection(v,g,m,new s.WebsocketMessageFormatter,i.ProxyInfo.fromRecognizerConfig(u),S,p)}getSpeechRegionFromIntentRegion(u){switch(u){case"West US":case"US West":case"westus":return"uswest";case"West US 2":case"US West 2":case"westus2":return"uswest2";case"South Central US":case"US South Central":case"southcentralus":return"ussouthcentral";case"West Central US":case"US West Central":case"westcentralus":return"uswestcentral";case"East US":case"US East":case"eastus":return"useast";case"East US 2":case"US East 2":case"eastus2":return"useast2";case"West Europe":case"Europe West":case"westeurope":return"europewest";case"North Europe":case"Europe North":case"northeurope":return"europenorth";case"Brazil South":case"South Brazil":case"southbrazil":return"brazilsouth";case"Australia East":case"East Australia":case"eastaustralia":return"australiaeast";case"Southeast Asia":case"Asia Southeast":case"southeastasia":return"asiasoutheast";case"East Asia":case"Asia East":case"eastasia":return"asiaeast";default:return u}}};return IntentConnectionFactory.IntentConnectionFactory=a,IntentConnectionFactory}var SpeakerRecognitionConnectionFactory={},hasRequiredSpeakerRecognitionConnectionFactory;function requireSpeakerRecognitionConnectionFactory(){if(hasRequiredSpeakerRecognitionConnectionFactory)return SpeakerRecognitionConnectionFactory;hasRequiredSpeakerRecognitionConnectionFactory=1,Object.defineProperty(SpeakerRecognitionConnectionFactory,"__esModule",{value:!0}),SpeakerRecognitionConnectionFactory.VoiceProfileConnectionFactory=SpeakerRecognitionConnectionFactory.SpeakerRecognitionConnectionFactory=void 0;const i=requireExports$2(),e=requireExports$3(),t=requireConnectionFactoryBase(),s=requireExports(),o=HeaderNames$1;class a extends t.ConnectionFactoryBase{create(p,v,g,m){let S=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Endpoint);if(!S){const T=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Region),E=t.ConnectionFactoryBase.getHostSuffix(T),A=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Host,`wss://${T}.spr-frontend.speech${E}`),b=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_SpeakerIdMode,"TextIndependentIdentification");S=`${A}/speaker/ws/${this.scenarioToPath(b)}/${g}`}const y={format:"simple",language:p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_RecoLanguage)};this.setCommonUrlParams(p,y,S);const C={};v.token!==void 0&&v.token!==""&&(C[v.headerName]=v.token),C[o.HeaderNames.ConnectionId]=m,C[o.HeaderNames.SpIDAuthKey]=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Key),p.parameters.setProperty(e.PropertyId.SpeechServiceConnection_Url,S);const R=p.parameters.getProperty("SPEECH-EnableWebsocketCompression","false")==="true";return new i.WebsocketConnection(S,y,C,new s.WebsocketMessageFormatter,i.ProxyInfo.fromRecognizerConfig(p),R,m)}scenarioToPath(p){switch(p){case"TextIndependentVerification":case"2":return"verification/text-independent";case"TextDependentVerification":case"1":return"verification/text-dependent";default:return"identification/text-independent"}}}let c=class extends a{create(p,v,g){return super.create(p,v,"recognition",g)}};SpeakerRecognitionConnectionFactory.SpeakerRecognitionConnectionFactory=c;class u extends a{create(p,v,g){return super.create(p,v,"profile",g)}}return SpeakerRecognitionConnectionFactory.VoiceProfileConnectionFactory=u,SpeakerRecognitionConnectionFactory}var RecognitionEvents={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.RecognitionEndedEvent=i.RecognitionCompletionStatus=i.RecognitionStartedEvent=i.ConnectingToServiceEvent=i.ListeningStartedEvent=i.RecognitionTriggeredEvent=i.SpeechRecognitionEvent=void 0;const e=requireExports$5();class t extends e.PlatformEvent{constructor(v,g,m,S=e.EventType.Info){super(v,S),this.privRequestId=g,this.privSessionId=m}get requestId(){return this.privRequestId}get sessionId(){return this.privSessionId}}i.SpeechRecognitionEvent=t;class s extends t{constructor(v,g,m,S){super("RecognitionTriggeredEvent",v,g),this.privAudioSourceId=m,this.privAudioNodeId=S}get audioSourceId(){return this.privAudioSourceId}get audioNodeId(){return this.privAudioNodeId}}i.RecognitionTriggeredEvent=s;class o extends t{constructor(v,g,m,S){super("ListeningStartedEvent",v,g),this.privAudioSourceId=m,this.privAudioNodeId=S}get audioSourceId(){return this.privAudioSourceId}get audioNodeId(){return this.privAudioNodeId}}i.ListeningStartedEvent=o;class a extends t{constructor(v,g,m){super("ConnectingToServiceEvent",v,m),this.privAuthFetchEventid=g}get authFetchEventid(){return this.privAuthFetchEventid}}i.ConnectingToServiceEvent=a;class c extends t{constructor(v,g,m,S,y){super("RecognitionStartedEvent",v,y),this.privAudioSourceId=g,this.privAudioNodeId=m,this.privAuthFetchEventId=S}get audioSourceId(){return this.privAudioSourceId}get audioNodeId(){return this.privAudioNodeId}get authFetchEventId(){return this.privAuthFetchEventId}}i.RecognitionStartedEvent=c;var u;(function(p){p[p.Success=0]="Success",p[p.AudioSourceError=1]="AudioSourceError",p[p.AudioSourceTimeout=2]="AudioSourceTimeout",p[p.AuthTokenFetchError=3]="AuthTokenFetchError",p[p.AuthTokenFetchTimeout=4]="AuthTokenFetchTimeout",p[p.UnAuthorized=5]="UnAuthorized",p[p.ConnectTimeout=6]="ConnectTimeout",p[p.ConnectError=7]="ConnectError",p[p.ClientRecognitionActivityTimeout=8]="ClientRecognitionActivityTimeout",p[p.UnknownError=9]="UnknownError"})(u=i.RecognitionCompletionStatus||(i.RecognitionCompletionStatus={}));class d extends t{constructor(v,g,m,S,y,C,R,T){super("RecognitionEndedEvent",v,y,R===u.Success?e.EventType.Info:e.EventType.Error),this.privAudioSourceId=g,this.privAudioNodeId=m,this.privAuthFetchEventId=S,this.privStatus=R,this.privError=T,this.privServiceTag=C}get audioSourceId(){return this.privAudioSourceId}get audioNodeId(){return this.privAudioNodeId}get authFetchEventId(){return this.privAuthFetchEventId}get serviceTag(){return this.privServiceTag}get status(){return this.privStatus}get error(){return this.privError}}i.RecognitionEndedEvent=d})(RecognitionEvents);var ServiceRecognizerBase={},SpeechConnectionMessage_Internal={};Object.defineProperty(SpeechConnectionMessage_Internal,"__esModule",{value:!0});SpeechConnectionMessage_Internal.SpeechConnectionMessage=void 0;const Exports_js_1$7=requireExports$5(),HeaderNames_js_1=HeaderNames$1;class SpeechConnectionMessage extends Exports_js_1$7.ConnectionMessage{constructor(e,t,s,o,a,c,u,d){if(!t)throw new Exports_js_1$7.ArgumentNullError("path");if(!s)throw new Exports_js_1$7.ArgumentNullError("requestId");const p={};if(p[HeaderNames_js_1.HeaderNames.Path]=t,p[HeaderNames_js_1.HeaderNames.RequestId]=s,p[HeaderNames_js_1.HeaderNames.RequestTimestamp]=new Date().toISOString(),o&&(p[HeaderNames_js_1.HeaderNames.ContentType]=o),c&&(p[HeaderNames_js_1.HeaderNames.RequestStreamId]=c),u)for(const v in u)v&&(p[v]=u[v]);d?super(e,a,p,d):super(e,a,p),this.privPath=t,this.privRequestId=s,this.privContentType=o,this.privStreamId=c,this.privAdditionalHeaders=u}get path(){return this.privPath}get requestId(){return this.privRequestId}get contentType(){return this.privContentType}get streamId(){return this.privStreamId}get additionalHeaders(){return this.privAdditionalHeaders}static fromConnectionMessage(e){let t=null,s=null,o=null,a=null;const c={};if(e.headers)for(const u in e.headers)u&&(u.toLowerCase()===HeaderNames_js_1.HeaderNames.Path.toLowerCase()?t=e.headers[u]:u.toLowerCase()===HeaderNames_js_1.HeaderNames.RequestId.toLowerCase()?s=e.headers[u]:u.toLowerCase()===HeaderNames_js_1.HeaderNames.ContentType.toLowerCase()?o=e.headers[u]:u.toLowerCase()===HeaderNames_js_1.HeaderNames.RequestStreamId.toLowerCase()?a=e.headers[u]:c[u]=e.headers[u]);return new SpeechConnectionMessage(e.messageType,t,s,o,e.body,a,c,e.id)}}SpeechConnectionMessage_Internal.SpeechConnectionMessage=SpeechConnectionMessage;var hasRequiredServiceRecognizerBase;function requireServiceRecognizerBase(){if(hasRequiredServiceRecognizerBase)return ServiceRecognizerBase;hasRequiredServiceRecognizerBase=1,Object.defineProperty(ServiceRecognizerBase,"__esModule",{value:!0}),ServiceRecognizerBase.ServiceRecognizerBase=void 0;const i=requireExports$2(),e=requireExports$5(),t=requireExports$3(),s=requireExports(),o=SpeechConnectionMessage_Internal;let a=class ee{constructor(u,d,p,v,g){if(this.privConnectionConfigurationPromise=void 0,this.privConnectionPromise=void 0,this.privSetTimeout=setTimeout,this.privIsLiveAudio=!1,this.privAverageBytesPerMs=0,this.privEnableSpeakerId=!1,this.privExpectContentAssessmentResponse=!1,this.recognizeOverride=void 0,this.recognizeSpeaker=void 0,this.disconnectOverride=void 0,this.receiveMessageOverride=void 0,this.sendPrePayloadJSONOverride=void 0,this.postConnectImplOverride=void 0,this.configConnectionOverride=void 0,this.handleSpeechPhraseMessage=void 0,this.handleSpeechHypothesisMessage=void 0,!u)throw new e.ArgumentNullError("authentication");if(!d)throw new e.ArgumentNullError("connectionFactory");if(!p)throw new e.ArgumentNullError("audioSource");if(!v)throw new e.ArgumentNullError("recognizerConfig");this.privEnableSpeakerId=v.isSpeakerDiarizationEnabled,this.privMustReportEndOfStream=!1,this.privAuthentication=u,this.privConnectionFactory=d,this.privAudioSource=p,this.privRecognizerConfig=v,this.privIsDisposed=!1,this.privRecognizer=g,this.privRequestSession=new s.RequestSession(this.privAudioSource.id()),this.privConnectionEvents=new e.EventSource,this.privServiceEvents=new e.EventSource,this.privDynamicGrammar=new s.DynamicGrammarBuilder,this.privSpeechContext=new s.SpeechContext(this.privDynamicGrammar),this.privAgentConfig=new s.AgentConfig,this.privRecognizerConfig.parameters.getProperty(t.PropertyId.WebWorkerLoadType,"on").toLowerCase()==="on"&&typeof Blob<"u"&&typeof Worker<"u"?this.privSetTimeout=e.Timeout.setTimeout:(typeof window<"u"&&(this.privSetTimeout=window.setTimeout.bind(window)),typeof globalThis<"u"&&(this.privSetTimeout=globalThis.setTimeout.bind(globalThis))),this.connectionEvents.attach(S=>{if(S.name==="ConnectionClosedEvent"){const y=S;(y.statusCode===1003||y.statusCode===1007||y.statusCode===1002||y.statusCode===4e3||this.privRequestSession.numConnectionAttempts>this.privRecognizerConfig.maxRetryCount)&&this.cancelRecognitionLocal(t.CancellationReason.Error,y.statusCode===1007?t.CancellationErrorCode.BadRequestParameters:t.CancellationErrorCode.ConnectionFailure,`${y.reason} websocket error code: ${y.statusCode}`)}}),this.privEnableSpeakerId&&(this.privDiarizationSessionId=e.createNoDashGuid()),this.setLanguageIdJson(),this.setOutputDetailLevelJson()}setTranslationJson(){const u=this.privRecognizerConfig.parameters.getProperty(t.PropertyId.SpeechServiceConnection_TranslationToLanguages,void 0);if(u!==void 0){const d=u.split(","),p=this.privRecognizerConfig.parameters.getProperty(t.PropertyId.SpeechServiceConnection_TranslationVoice,void 0),v=p!==void 0?"Synthesize":"None";if(this.privSpeechContext.setSection("translation",{onSuccess:{action:v},output:{interimResults:{mode:"Always"}},targetLanguages:d}),p!==void 0){const g={};for(const m of d)g[m]=p;this.privSpeechContext.setSection("synthesis",{defaultVoices:g})}}}setSpeechSegmentationTimeoutJson(){const u=this.privRecognizerConfig.parameters.getProperty(t.PropertyId.Speech_SegmentationSilenceTimeoutMs,void 0);if(u!==void 0){const d=this.recognitionMode===s.RecognitionMode.Conversation?"CONVERSATION":this.recognitionMode===s.RecognitionMode.Dictation?"DICTATION":"INTERACTIVE",p=parseInt(u,10),v=this.privSpeechContext.getSection("phraseDetection");v.mode=d,v[d]={segmentation:{mode:"Custom",segmentationSilenceTimeoutMs:p}},this.privSpeechContext.setSection("phraseDetection",v)}}setLanguageIdJson(){const u=this.privSpeechContext.getSection("phraseDetection");if(this.privRecognizerConfig.autoDetectSourceLanguages!==void 0){const p=this.privRecognizerConfig.autoDetectSourceLanguages.split(",");let v;this.privRecognizerConfig.languageIdMode==="Continuous"?v="DetectContinuous":v="DetectAtAudioStart",this.privSpeechContext.setSection("languageId",{Priority:"PrioritizeLatency",languages:p,mode:v,onSuccess:{action:"Recognize"},onUnknown:{action:"None"}}),this.privSpeechContext.setSection("phraseOutput",{interimResults:{resultType:"Auto"},phraseResults:{resultType:"Always"}});const g=this.privRecognizerConfig.sourceLanguageModels;g!==void 0&&(u.customModels=g,u.onInterim={action:"None"},u.onSuccess={action:"None"})}this.privRecognizerConfig.parameters.getProperty(t.PropertyId.SpeechServiceConnection_TranslationToLanguages,void 0)!==void 0&&(u.onInterim={action:"Translate"},u.onSuccess={action:"Translate"},this.privSpeechContext.setSection("phraseOutput",{interimResults:{resultType:"None"},phraseResults:{resultType:"None"}})),this.privSpeechContext.setSection("phraseDetection",u)}setOutputDetailLevelJson(){this.privEnableSpeakerId&&(this.privRecognizerConfig.parameters.getProperty(t.PropertyId.SpeechServiceResponse_RequestWordLevelTimestamps,"false").toLowerCase()==="true"?this.privSpeechContext.setWordLevelTimings():this.privRecognizerConfig.parameters.getProperty(s.OutputFormatPropertyName,t.OutputFormat[t.OutputFormat.Simple]).toLowerCase()===t.OutputFormat[t.OutputFormat.Detailed].toLocaleLowerCase()&&this.privSpeechContext.setDetailedOutputFormat())}get isSpeakerDiarizationEnabled(){return this.privEnableSpeakerId}get audioSource(){return this.privAudioSource}get speechContext(){return this.privSpeechContext}get dynamicGrammar(){return this.privDynamicGrammar}get agentConfig(){return this.privAgentConfig}set conversationTranslatorToken(u){this.privRecognizerConfig.parameters.setProperty(t.PropertyId.ConversationTranslator_Token,u)}set voiceProfileType(u){this.privRecognizerConfig.parameters.setProperty(t.PropertyId.SpeechServiceConnection_SpeakerIdMode,u)}set authentication(u){this.privAuthentication=u}isDisposed(){return this.privIsDisposed}async dispose(u){if(this.privIsDisposed=!0,this.privConnectionConfigurationPromise!==void 0)try{await(await this.privConnectionConfigurationPromise).dispose(u)}catch{return}}get connectionEvents(){return this.privConnectionEvents}get serviceEvents(){return this.privServiceEvents}get recognitionMode(){return this.privRecognizerConfig.recognitionMode}async recognize(u,d,p){if(this.recognizeOverride!==void 0){await this.recognizeOverride(u,d,p);return}this.privConnectionConfigurationPromise=void 0,this.privRecognizerConfig.recognitionMode=u,this.setSpeechSegmentationTimeoutJson(),this.setTranslationJson(),this.privSuccessCallback=d,this.privErrorCallback=p,this.privRequestSession.startNewRecognition(),this.privRequestSession.listenForServiceTelemetry(this.privAudioSource.events);const v=this.connectImpl();let g;try{const y=await this.audioSource.attach(this.privRequestSession.audioNodeId),C=await this.audioSource.format,R=await this.audioSource.deviceInfo;this.privIsLiveAudio=R.type&&R.type===s.type.Microphones,g=new i.ReplayableAudioNode(y,C.avgBytesPerSec),await this.privRequestSession.onAudioSourceAttachCompleted(g,!1),this.privRecognizerConfig.SpeechServiceConfig.Context.audio={source:R}}catch(y){throw await this.privRequestSession.onStopRecognizing(),y}try{await v}catch(y){await this.cancelRecognitionLocal(t.CancellationReason.Error,t.CancellationErrorCode.ConnectionFailure,y);return}const m=new t.SessionEventArgs(this.privRequestSession.sessionId);this.privRecognizer.sessionStarted&&this.privRecognizer.sessionStarted(this.privRecognizer,m),this.receiveMessage(),this.sendAudio(g).catch(async y=>{await this.cancelRecognitionLocal(t.CancellationReason.Error,t.CancellationErrorCode.RuntimeError,y)})}async stopRecognizing(){if(this.privRequestSession.isRecognizing)try{await this.audioSource.turnOff(),await this.sendFinalAudio(),await this.privRequestSession.onStopRecognizing(),await this.privRequestSession.turnCompletionPromise}finally{await this.privRequestSession.dispose()}}async connect(){return await this.connectImpl(),Promise.resolve()}connectAsync(u,d){this.connectImpl().then(()=>{try{u&&u()}catch(p){d&&d(p)}},p=>{try{d&&d(p)}catch{}})}async disconnect(){if(await this.cancelRecognitionLocal(t.CancellationReason.Error,t.CancellationErrorCode.NoError,"Disconnecting"),this.disconnectOverride!==void 0&&await this.disconnectOverride(),this.privConnectionPromise!==void 0)try{await(await this.privConnectionPromise).dispose()}catch{}this.privConnectionPromise=void 0}sendMessage(u){}async sendNetworkMessage(u,d){const p=typeof d=="string"?e.MessageType.Text:e.MessageType.Binary,v=typeof d=="string"?"application/json":"";return(await this.fetchConnection()).send(new o.SpeechConnectionMessage(p,u,this.privRequestSession.requestId,v,d))}set activityTemplate(u){this.privActivityTemplate=u}get activityTemplate(){return this.privActivityTemplate}set expectContentAssessmentResponse(u){this.privExpectContentAssessmentResponse=u}async sendTelemetryData(){const u=this.privRequestSession.getTelemetry();if(ee.telemetryDataEnabled!==!0||this.privIsDisposed||u===null)return;if(ee.telemetryData)try{ee.telemetryData(u)}catch{}await(await this.fetchConnection()).send(new o.SpeechConnectionMessage(e.MessageType.Text,"telemetry",this.privRequestSession.requestId,"application/json",u))}async cancelRecognitionLocal(u,d,p){this.privRequestSession.isRecognizing&&(await this.privRequestSession.onStopRecognizing(),this.cancelRecognition(this.privRequestSession.sessionId,this.privRequestSession.requestId,u,d,p))}async receiveMessage(){try{if(this.privIsDisposed)return;let u=await this.fetchConnection();const d=await u.read();if(this.receiveMessageOverride!==void 0)return this.receiveMessageOverride();if(!d)return this.receiveMessage();this.privServiceHasSentMessage=!0;const p=o.SpeechConnectionMessage.fromConnectionMessage(d);if(p.requestId.toLowerCase()===this.privRequestSession.requestId.toLowerCase())switch(p.path.toLowerCase()){case"turn.start":this.privMustReportEndOfStream=!0,this.privRequestSession.onServiceTurnStartResponse();break;case"speech.startdetected":const v=s.SpeechDetected.fromJSON(p.textBody),g=new t.RecognitionEventArgs(v.Offset,this.privRequestSession.sessionId);this.privRecognizer.speechStartDetected&&this.privRecognizer.speechStartDetected(this.privRecognizer,g);break;case"speech.enddetected":let m;p.textBody.length>0?m=p.textBody:m="{ Offset: 0 }";const S=s.SpeechDetected.fromJSON(m),y=new t.RecognitionEventArgs(S.Offset+this.privRequestSession.currentTurnAudioOffset,this.privRequestSession.sessionId);this.privRecognizer.speechEndDetected&&this.privRecognizer.speechEndDetected(this.privRecognizer,y);break;case"turn.end":await this.sendTelemetryData(),this.privRequestSession.isSpeechEnded&&this.privMustReportEndOfStream&&(this.privMustReportEndOfStream=!1,await this.cancelRecognitionLocal(t.CancellationReason.EndOfStream,t.CancellationErrorCode.NoError,void 0));const C=new t.SessionEventArgs(this.privRequestSession.sessionId);if(await this.privRequestSession.onServiceTurnEndResponse(this.privRecognizerConfig.isContinuousRecognition),!this.privRecognizerConfig.isContinuousRecognition||this.privRequestSession.isSpeechEnded||!this.privRequestSession.isRecognizing){this.privRecognizer.sessionStopped&&this.privRecognizer.sessionStopped(this.privRecognizer,C);return}else u=await this.fetchConnection(),await this.sendPrePayloadJSON(u);break;default:await this.processTypeSpecificMessages(p)||this.privServiceEvents&&this.serviceEvents.onEvent(new e.ServiceEvent(p.path.toLowerCase(),p.textBody))}return this.receiveMessage()}catch{return null}}updateSpeakerDiarizationAudioOffset(){const u=this.privRequestSession.recognitionBytesSent,d=this.privAverageBytesPerMs!==0?u/this.privAverageBytesPerMs:0;this.privSpeechContext.setSpeakerDiarizationAudioOffsetMs(d)}sendSpeechContext(u,d){this.privEnableSpeakerId&&this.updateSpeakerDiarizationAudioOffset();const p=this.speechContext.toJSON();if(d&&this.privRequestSession.onSpeechContext(),p)return u.send(new o.SpeechConnectionMessage(e.MessageType.Text,"speech.context",this.privRequestSession.requestId,"application/json",p))}noOp(){}async sendPrePayloadJSON(u,d=!0){if(this.sendPrePayloadJSONOverride!==void 0)return this.sendPrePayloadJSONOverride(u);await this.sendSpeechContext(u,d),await this.sendWaveHeader(u)}async sendWaveHeader(u){const d=await this.audioSource.format;return u.send(new o.SpeechConnectionMessage(e.MessageType.Binary,"audio",this.privRequestSession.requestId,"audio/x-wav",d.header))}connectImpl(){return this.privConnectionPromise!==void 0?this.privConnectionPromise.then(u=>u.state()===e.ConnectionState.Disconnected?(this.privConnectionId=null,this.privConnectionPromise=void 0,this.privServiceHasSentMessage=!1,this.connectImpl()):this.privConnectionPromise,()=>(this.privConnectionId=null,this.privConnectionPromise=void 0,this.privServiceHasSentMessage=!1,this.connectImpl())):(this.privConnectionPromise=this.retryableConnect(),this.privConnectionPromise.catch(()=>{}),this.postConnectImplOverride!==void 0?this.postConnectImplOverride(this.privConnectionPromise):this.privConnectionPromise)}sendSpeechServiceConfig(u,d,p){if(d.onSpeechContext(),ee.telemetryDataEnabled!==!0){const g={context:{system:JSON.parse(p).context.system}};p=JSON.stringify(g)}if(this.privRecognizerConfig.parameters.getProperty("f0f5debc-f8c9-4892-ac4b-90a7ab359fd2","false").toLowerCase()==="true"){const v=JSON.parse(p);v.context.DisableReferenceChannel="True",v.context.MicSpec="1_0_0",p=JSON.stringify(v)}if(p)return u.send(new o.SpeechConnectionMessage(e.MessageType.Text,"speech.config",d.requestId,"application/json",p))}async fetchConnection(){return this.privConnectionConfigurationPromise!==void 0?this.privConnectionConfigurationPromise.then(u=>u.state()===e.ConnectionState.Disconnected?(this.privConnectionId=null,this.privConnectionConfigurationPromise=void 0,this.privServiceHasSentMessage=!1,this.fetchConnection()):this.privConnectionConfigurationPromise,()=>(this.privConnectionId=null,this.privConnectionConfigurationPromise=void 0,this.privServiceHasSentMessage=!1,this.fetchConnection())):(this.privConnectionConfigurationPromise=this.configureConnection(),await this.privConnectionConfigurationPromise)}async sendAudio(u){const d=await this.audioSource.format;this.privAverageBytesPerMs=d.avgBytesPerSec/1e3;let p=Date.now();const v=this.privRecognizerConfig.parameters.getProperty("SPEECH-TransmitLengthBeforThrottleMs","5000"),g=d.avgBytesPerSec/1e3*parseInt(v,10),m=this.privRequestSession.recogNumber,S=async()=>{if(!this.privIsDisposed&&!this.privRequestSession.isSpeechEnded&&this.privRequestSession.isRecognizing&&this.privRequestSession.recogNumber===m){const y=await this.fetchConnection(),C=await u.read();if(this.privRequestSession.isSpeechEnded)return;let R,T;if(!C||C.isEnd?(R=null,T=0):(R=C.buffer,this.privRequestSession.onAudioSent(R.byteLength),g>=this.privRequestSession.bytesSent?T=0:T=Math.max(0,p-Date.now())),T!==0&&await this.delay(T),R!==null&&(p=Date.now()+R.byteLength*1e3/(d.avgBytesPerSec*2)),!this.privIsDisposed&&!this.privRequestSession.isSpeechEnded&&this.privRequestSession.isRecognizing&&this.privRequestSession.recogNumber===m)if(y.send(new o.SpeechConnectionMessage(e.MessageType.Binary,"audio",this.privRequestSession.requestId,null,R)).catch(()=>{this.privRequestSession.onServiceTurnEndResponse(this.privRecognizerConfig.isContinuousRecognition).catch(()=>{})}),C!=null&&C.isEnd)this.privIsLiveAudio||this.privRequestSession.onSpeechEnded();else return S()}};return S()}async retryableConnect(){let u=!1;this.privAuthFetchEventId=e.createNoDashGuid();const d=this.privRequestSession.sessionId;this.privConnectionId=d!==void 0?d:e.createNoDashGuid(),this.privRequestSession.onPreConnectionStart(this.privAuthFetchEventId,this.privConnectionId);let p=0,v="";for(;this.privRequestSession.numConnectionAttempts<=this.privRecognizerConfig.maxRetryCount;){const m=await(u?this.privAuthentication.fetchOnExpiry(this.privAuthFetchEventId):this.privAuthentication.fetch(this.privAuthFetchEventId));await this.privRequestSession.onAuthCompleted(!1);const S=this.privConnectionFactory.create(this.privRecognizerConfig,m,this.privConnectionId);this.privRequestSession.listenForServiceTelemetry(S.events),S.events.attach(C=>{this.connectionEvents.onEvent(C)});const y=await S.open();if(y.statusCode===200)return await this.privRequestSession.onConnectionEstablishCompleted(y.statusCode),Promise.resolve(S);y.statusCode===1006&&(u=!0),p=y.statusCode,v=y.reason,this.privRequestSession.onRetryConnection()}return await this.privRequestSession.onConnectionEstablishCompleted(p,v),Promise.reject(`Unable to contact server. StatusCode: ${p}, ${this.privRecognizerConfig.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Endpoint)} Reason: ${v}`)}delay(u){return new Promise(d=>this.privSetTimeout(d,u))}writeBufferToConsole(u){let d="Buffer Size: ";if(u===null)d+="null";else{const p=new Uint8Array(u);d+=`${u.byteLength}\r
`;for(let v=0;v<u.byteLength;v++)d+=p[v].toString(16).padStart(2,"0")+" ",(v+1)%16===0&&(console.info(d),d="")}console.info(d)}async sendFinalAudio(){await(await this.fetchConnection()).send(new o.SpeechConnectionMessage(e.MessageType.Binary,"audio",this.privRequestSession.requestId,null,null))}async configureConnection(){const u=await this.connectImpl();return this.configConnectionOverride!==void 0?this.configConnectionOverride(u):(await this.sendSpeechServiceConfig(u,this.privRequestSession,this.privRecognizerConfig.SpeechServiceConfig.serialize()),await this.sendPrePayloadJSON(u,!1),u)}};return ServiceRecognizerBase.ServiceRecognizerBase=a,a.telemetryDataEnabled=!0,ServiceRecognizerBase}var ConversationServiceRecognizer={},hasRequiredConversationServiceRecognizer;function requireConversationServiceRecognizer(){if(hasRequiredConversationServiceRecognizer)return ConversationServiceRecognizer;hasRequiredConversationServiceRecognizer=1,Object.defineProperty(ConversationServiceRecognizer,"__esModule",{value:!0}),ConversationServiceRecognizer.ConversationServiceRecognizer=void 0;const i=requireExports$3(),e=requireExports();let t=class extends e.ServiceRecognizerBase{constructor(o,a,c,u,d){super(o,a,c,u,d),this.handleSpeechPhraseMessage=async p=>this.handleSpeechPhrase(p),this.handleSpeechHypothesisMessage=p=>this.handleSpeechHypothesis(p)}processTypeSpecificMessages(o){}handleRecognizedCallback(o,a,c){}handleRecognizingCallback(o,a,c){}async processSpeechMessages(o){let a=!1;switch(o.path.toLowerCase()){case"speech.hypothesis":case"speech.fragment":this.handleSpeechHypothesisMessage&&this.handleSpeechHypothesisMessage(o.textBody),a=!0;break;case"speech.phrase":this.handleSpeechPhraseMessage&&await this.handleSpeechPhraseMessage(o.textBody),a=!0;break}return a}cancelRecognition(o,a,c,u,d){}async handleSpeechPhrase(o){const a=e.SimpleSpeechPhrase.fromJSON(o),c=e.EnumTranslation.implTranslateRecognitionResult(a.RecognitionStatus);let u;const d=new i.PropertyCollection;d.setProperty(i.PropertyId.SpeechServiceResponse_JsonResult,o);const p=a.Offset+this.privRequestSession.currentTurnAudioOffset;let v=p;if(this.privRequestSession.onPhraseRecognized(this.privRequestSession.currentTurnAudioOffset+a.Offset+a.Duration),i.ResultReason.Canceled===c){const g=e.EnumTranslation.implTranslateCancelResult(a.RecognitionStatus),m=e.EnumTranslation.implTranslateCancelErrorCode(a.RecognitionStatus);await this.cancelRecognitionLocal(g,m,e.EnumTranslation.implTranslateErrorDetails(m))}else if(!(this.privRequestSession.isSpeechEnded&&c===i.ResultReason.NoMatch&&a.RecognitionStatus!==e.RecognitionStatus.InitialSilenceTimeout)){if(this.privRecognizerConfig.parameters.getProperty(e.OutputFormatPropertyName)===i.OutputFormat[i.OutputFormat.Simple])u=new i.SpeechRecognitionResult(this.privRequestSession.requestId,c,a.DisplayText,a.Duration,p,a.Language,a.LanguageDetectionConfidence,a.SpeakerId,void 0,o,d);else{const g=e.DetailedSpeechPhrase.fromJSON(o),m=g.Offset+this.privRequestSession.currentTurnAudioOffset,S=g.getJsonWithCorrectedOffsets(m);u=new i.SpeechRecognitionResult(this.privRequestSession.requestId,c,g.Text,g.Duration,m,g.Language,g.LanguageDetectionConfidence,g.SpeakerId,void 0,S,d),v=u.offset}this.handleRecognizedCallback(u,v,this.privRequestSession.sessionId)}}handleSpeechHypothesis(o){const a=e.SpeechHypothesis.fromJSON(o),c=a.Offset+this.privRequestSession.currentTurnAudioOffset,u=new i.PropertyCollection;u.setProperty(i.PropertyId.SpeechServiceResponse_JsonResult,o);const d=new i.SpeechRecognitionResult(this.privRequestSession.requestId,i.ResultReason.RecognizingSpeech,a.Text,a.Duration,c,a.Language,a.LanguageDetectionConfidence,a.SpeakerId,void 0,o,u);this.privRequestSession.onHypothesis(c),this.handleRecognizingCallback(d,a.Duration,this.privRequestSession.sessionId)}};return ConversationServiceRecognizer.ConversationServiceRecognizer=t,ConversationServiceRecognizer}var RecognizerConfig={},hasRequiredRecognizerConfig;function requireRecognizerConfig(){return hasRequiredRecognizerConfig||(hasRequiredRecognizerConfig=1,function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.RecognizerConfig=i.SpeechResultFormat=i.RecognitionMode=void 0;const e=requireExports$3(),t=requireExports();var s;(function(a){a[a.Interactive=0]="Interactive",a[a.Conversation=1]="Conversation",a[a.Dictation=2]="Dictation"})(s=i.RecognitionMode||(i.RecognitionMode={})),function(a){a[a.Simple=0]="Simple",a[a.Detailed=1]="Detailed"}(i.SpeechResultFormat||(i.SpeechResultFormat={}));class o{constructor(c,u){this.privSpeechServiceConfig=c||new t.SpeechServiceConfig(new t.Context(null)),this.privParameters=u,this.privMaxRetryCount=parseInt(u.getProperty("SPEECH-Error-MaxRetryCount","4"),10),this.privLanguageIdMode=u.getProperty(e.PropertyId.SpeechServiceConnection_LanguageIdMode,void 0),this.privEnableSpeakerId=!1}get parameters(){return this.privParameters}get recognitionMode(){return this.privRecognitionMode}set recognitionMode(c){this.privRecognitionMode=c,this.privRecognitionActivityTimeout=c===s.Interactive?8e3:25e3,this.privSpeechServiceConfig.Recognition=s[c]}get SpeechServiceConfig(){return this.privSpeechServiceConfig}get recognitionActivityTimeout(){return this.privRecognitionActivityTimeout}get isContinuousRecognition(){return this.privRecognitionMode!==s.Interactive}get languageIdMode(){return this.privLanguageIdMode}get autoDetectSourceLanguages(){return this.parameters.getProperty(e.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages,void 0)}get recognitionEndpointVersion(){return this.parameters.getProperty(e.PropertyId.SpeechServiceConnection_RecognitionEndpointVersion,void 0)}get sourceLanguageModels(){const c=[];let u=!1;if(this.autoDetectSourceLanguages!==void 0)for(const d of this.autoDetectSourceLanguages.split(",")){const p=d+e.PropertyId.SpeechServiceConnection_EndpointId.toString(),v=this.parameters.getProperty(p,void 0);v!==void 0?(c.push({language:d,endpoint:v}),u=!0):c.push({language:d,endpoint:""})}return u?c:void 0}get maxRetryCount(){return this.privMaxRetryCount}get isSpeakerDiarizationEnabled(){return this.privEnableSpeakerId}set isSpeakerDiarizationEnabled(c){this.privEnableSpeakerId=c}}i.RecognizerConfig=o}(RecognizerConfig)),RecognizerConfig}var SpeechServiceInterfaces={};Object.defineProperty(SpeechServiceInterfaces,"__esModule",{value:!0});var WebsocketMessageFormatter$1={};Object.defineProperty(WebsocketMessageFormatter$1,"__esModule",{value:!0});WebsocketMessageFormatter$1.WebsocketMessageFormatter=void 0;const Exports_js_1$6=requireExports$5(),CRLF=`\r
`;class WebsocketMessageFormatter{toConnectionMessage(e){const t=new Exports_js_1$6.Deferred;try{if(e.messageType===Exports_js_1$6.MessageType.Text){const s=e.textContent;let o={},a=null;if(s){const c=s.split(`\r
\r
`);c&&c.length>0&&(o=this.parseHeaders(c[0]),c.length>1&&(a=c[1]))}t.resolve(new Exports_js_1$6.ConnectionMessage(e.messageType,a,o,e.id))}else if(e.messageType===Exports_js_1$6.MessageType.Binary){const s=e.binaryContent;let o={},a=null;if(!s||s.byteLength<2)throw new Error("Invalid binary message format. Header length missing.");const c=new DataView(s),u=c.getInt16(0);if(s.byteLength<u+2)throw new Error("Invalid binary message format. Header content missing.");let d="";for(let p=0;p<u;p++)d+=String.fromCharCode(c.getInt8(p+2));o=this.parseHeaders(d),s.byteLength>u+2&&(a=s.slice(2+u)),t.resolve(new Exports_js_1$6.ConnectionMessage(e.messageType,a,o,e.id))}}catch(s){t.reject(`Error formatting the message. Error: ${s}`)}return t.promise}fromConnectionMessage(e){const t=new Exports_js_1$6.Deferred;try{if(e.messageType===Exports_js_1$6.MessageType.Text){const s=`${this.makeHeaders(e)}${CRLF}${e.textBody?e.textBody:""}`;t.resolve(new Exports_js_1$6.RawWebsocketMessage(Exports_js_1$6.MessageType.Text,s,e.id))}else if(e.messageType===Exports_js_1$6.MessageType.Binary){const s=this.makeHeaders(e),o=e.binaryBody,a=this.stringToArrayBuffer(s),c=new Int8Array(a),u=c.byteLength,d=new Int8Array(2+u+(o?o.byteLength:0));if(d[0]=u>>8&255,d[1]=u&255,d.set(c,2),o){const v=new Int8Array(o);d.set(v,2+u)}const p=d.buffer;t.resolve(new Exports_js_1$6.RawWebsocketMessage(Exports_js_1$6.MessageType.Binary,p,e.id))}}catch(s){t.reject(`Error formatting the message. ${s}`)}return t.promise}makeHeaders(e){let t="";if(e.headers)for(const s in e.headers)s&&(t+=`${s}: ${e.headers[s]}${CRLF}`);return t}parseHeaders(e){const t={};if(e){const s=e.match(/[^\r\n]+/g);if(t){for(const o of s)if(o){const a=o.indexOf(":"),c=a>0?o.substr(0,a).trim().toLowerCase():o,u=a>0&&o.length>a+1?o.substr(a+1).trim():"";t[c]=u}}}return t}stringToArrayBuffer(e){const t=new ArrayBuffer(e.length),s=new DataView(t);for(let o=0;o<e.length;o++)s.setUint8(o,e.charCodeAt(o));return t}}WebsocketMessageFormatter$1.WebsocketMessageFormatter=WebsocketMessageFormatter;var SpeechConnectionFactory={},hasRequiredSpeechConnectionFactory;function requireSpeechConnectionFactory(){if(hasRequiredSpeechConnectionFactory)return SpeechConnectionFactory;hasRequiredSpeechConnectionFactory=1,Object.defineProperty(SpeechConnectionFactory,"__esModule",{value:!0}),SpeechConnectionFactory.SpeechConnectionFactory=void 0;const i=requireExports$2(),e=requireExports(),t=requireExports$3(),s=requireConnectionFactoryBase(),o=requireExports(),a=HeaderNames$1,c=QueryParameterNames$1;let u=class extends s.ConnectionFactoryBase{constructor(){super(...arguments),this.interactiveRelativeUri="/speech/recognition/interactive/cognitiveservices/v1",this.conversationRelativeUri="/speech/recognition/conversation/cognitiveservices/v1",this.dictationRelativeUri="/speech/recognition/dictation/cognitiveservices/v1",this.universalUri="/speech/universal/v"}create(p,v,g){let m=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Endpoint,void 0);const S=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Region,void 0),y=s.ConnectionFactoryBase.getHostSuffix(S),C=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Host,"wss://"+S+".stt.speech"+y),R={},T=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_EndpointId,void 0),E=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_RecoLanguage,void 0);if(T?(!m||m.search(c.QueryParameterNames.CustomSpeechDeploymentId)===-1)&&(R[c.QueryParameterNames.CustomSpeechDeploymentId]=T):E&&(!m||m.search(c.QueryParameterNames.Language)===-1)&&(R[c.QueryParameterNames.Language]=E),(!m||m.search(c.QueryParameterNames.Format)===-1)&&(R[c.QueryParameterNames.Format]=p.parameters.getProperty(e.OutputFormatPropertyName,t.OutputFormat[t.OutputFormat.Simple]).toLowerCase()),p.autoDetectSourceLanguages!==void 0&&(R[c.QueryParameterNames.EnableLanguageId]="true"),this.setCommonUrlParams(p,R,m),!m)switch(p.recognitionMode){case o.RecognitionMode.Conversation:p.parameters.getProperty(e.ForceDictationPropertyName,"false")==="true"?m=C+this.dictationRelativeUri:p.recognitionEndpointVersion!==void 0&&parseInt(p.recognitionEndpointVersion,10)>1?m=`${C}${this.universalUri}${p.recognitionEndpointVersion}`:m=C+this.conversationRelativeUri;break;case o.RecognitionMode.Dictation:m=C+this.dictationRelativeUri;break;default:p.recognitionEndpointVersion!==void 0&&parseInt(p.recognitionEndpointVersion,10)>1?m=`${C}${this.universalUri}${p.recognitionEndpointVersion}`:m=C+this.interactiveRelativeUri;break}const A={};v.token!==void 0&&v.token!==""&&(A[v.headerName]=v.token),A[a.HeaderNames.ConnectionId]=g;const b=p.parameters.getProperty("SPEECH-EnableWebsocketCompression","false")==="true",P=new i.WebsocketConnection(m,R,A,new o.WebsocketMessageFormatter,i.ProxyInfo.fromRecognizerConfig(p),b,g),_=P.uri;return p.parameters.setProperty(t.PropertyId.SpeechServiceConnection_Url,_),P}};return SpeechConnectionFactory.SpeechConnectionFactory=u,SpeechConnectionFactory}var ConversationTranscriberConnectionFactory={},hasRequiredConversationTranscriberConnectionFactory;function requireConversationTranscriberConnectionFactory(){if(hasRequiredConversationTranscriberConnectionFactory)return ConversationTranscriberConnectionFactory;hasRequiredConversationTranscriberConnectionFactory=1,Object.defineProperty(ConversationTranscriberConnectionFactory,"__esModule",{value:!0}),ConversationTranscriberConnectionFactory.ConversationTranscriberConnectionFactory=void 0;const i=requireExports$2(),e=requireExports$3(),t=requireExports(),s=requireConnectionFactoryBase(),o=requireExports(),a=HeaderNames$1,c=QueryParameterNames$1;let u=class extends s.ConnectionFactoryBase{constructor(){super(...arguments),this.universalUri="/speech/universal/v2"}create(p,v,g){let m=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Endpoint,void 0);const S=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Region,void 0),y=s.ConnectionFactoryBase.getHostSuffix(S),C=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Host,"wss://"+S+".stt.speech"+y),R={},T=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_EndpointId,void 0),E=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_RecoLanguage,void 0);T?(!m||m.search(c.QueryParameterNames.CustomSpeechDeploymentId)===-1)&&(R[c.QueryParameterNames.CustomSpeechDeploymentId]=T):E&&(!m||m.search(c.QueryParameterNames.Language)===-1)&&(R[c.QueryParameterNames.Language]=E),p.autoDetectSourceLanguages!==void 0&&(R[c.QueryParameterNames.EnableLanguageId]="true"),this.setV2UrlParams(p,R,m),m||(m=`${C}${this.universalUri}`);const A={};v.token!==void 0&&v.token!==""&&(A[v.headerName]=v.token),A[a.HeaderNames.ConnectionId]=g;const b=p.parameters.getProperty("SPEECH-EnableWebsocketCompression","false")==="true",P=new i.WebsocketConnection(m,R,A,new o.WebsocketMessageFormatter,i.ProxyInfo.fromRecognizerConfig(p),b,g),_=P.uri;return p.parameters.setProperty(e.PropertyId.SpeechServiceConnection_Url,_),P}setV2UrlParams(p,v,g){new Map([[e.PropertyId.Speech_SegmentationSilenceTimeoutMs,c.QueryParameterNames.SegmentationSilenceTimeoutMs],[e.PropertyId.SpeechServiceConnection_EnableAudioLogging,c.QueryParameterNames.EnableAudioLogging],[e.PropertyId.SpeechServiceConnection_EndSilenceTimeoutMs,c.QueryParameterNames.EndSilenceTimeoutMs],[e.PropertyId.SpeechServiceConnection_InitialSilenceTimeoutMs,c.QueryParameterNames.InitialSilenceTimeoutMs],[e.PropertyId.SpeechServiceResponse_PostProcessingOption,c.QueryParameterNames.Postprocessing],[e.PropertyId.SpeechServiceResponse_ProfanityOption,c.QueryParameterNames.Profanity],[e.PropertyId.SpeechServiceResponse_StablePartialResultThreshold,c.QueryParameterNames.StableIntermediateThreshold]]).forEach((y,C)=>{this.setUrlParameter(C,y,p,v,g)});const S=JSON.parse(p.parameters.getProperty(t.ServicePropertiesPropertyName,"{}"));Object.keys(S).forEach(y=>{v[y]=S[y]})}};return ConversationTranscriberConnectionFactory.ConversationTranscriberConnectionFactory=u,ConversationTranscriberConnectionFactory}var TranscriberConnectionFactory={},hasRequiredTranscriberConnectionFactory;function requireTranscriberConnectionFactory(){if(hasRequiredTranscriberConnectionFactory)return TranscriberConnectionFactory;hasRequiredTranscriberConnectionFactory=1,Object.defineProperty(TranscriberConnectionFactory,"__esModule",{value:!0}),TranscriberConnectionFactory.TranscriberConnectionFactory=void 0;const i=requireExports$2(),e=requireExports$3(),t=requireConnectionFactoryBase(),s=requireExports(),o=HeaderNames$1,a=QueryParameterNames$1;let c=class extends t.ConnectionFactoryBase{constructor(){super(...arguments),this.multiaudioRelativeUri="/speech/recognition/multiaudio"}create(d,p,v){let g=d.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Endpoint,void 0);const m=d.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Region,"centralus"),S=t.ConnectionFactoryBase.getHostSuffix(m),y="wss://transcribe."+m+".cts.speech"+S+this.multiaudioRelativeUri,C=d.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Host,y),R={};this.setQueryParams(R,d,g),g||(g=C);const T={};p.token!==void 0&&p.token!==""&&(T[p.headerName]=p.token),T[o.HeaderNames.ConnectionId]=v,d.parameters.setProperty(e.PropertyId.SpeechServiceConnection_Url,g);const E=d.parameters.getProperty("SPEECH-EnableWebsocketCompression","false")==="true";return new i.WebsocketConnection(g,R,T,new s.WebsocketMessageFormatter,i.ProxyInfo.fromRecognizerConfig(d),E,v)}setQueryParams(d,p,v){const g=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_EndpointId,void 0),m=p.parameters.getProperty(e.PropertyId.SpeechServiceConnection_RecoLanguage,void 0);g&&!(a.QueryParameterNames.CustomSpeechDeploymentId in d)&&(d[a.QueryParameterNames.CustomSpeechDeploymentId]=g),m&&!(a.QueryParameterNames.Language in d)&&(d[a.QueryParameterNames.Language]=m);const S=p.parameters.getProperty(e.PropertyId.SpeechServiceResponse_RequestWordLevelTimestamps,"false").toLowerCase()==="true",y=p.parameters.getProperty(s.OutputFormatPropertyName,e.OutputFormat[e.OutputFormat.Simple])!==e.OutputFormat[e.OutputFormat.Simple];(S||y)&&(d[a.QueryParameterNames.Format]=e.OutputFormat[e.OutputFormat.Detailed].toLowerCase()),this.setCommonUrlParams(p,d,v)}};return TranscriberConnectionFactory.TranscriberConnectionFactory=c,TranscriberConnectionFactory}var TranslationConnectionFactory={},hasRequiredTranslationConnectionFactory;function requireTranslationConnectionFactory(){if(hasRequiredTranslationConnectionFactory)return TranslationConnectionFactory;hasRequiredTranslationConnectionFactory=1,Object.defineProperty(TranslationConnectionFactory,"__esModule",{value:!0}),TranslationConnectionFactory.TranslationConnectionFactory=void 0;const i=requireExports$2(),e=StringUtils$1,t=requireExports$3(),s=requireConnectionFactoryBase(),o=requireExports(),a=HeaderNames$1,c=QueryParameterNames$1;let u=class extends s.ConnectionFactoryBase{create(p,v,g){const m=this.getEndpointUrl(p),S={};p.autoDetectSourceLanguages!==void 0&&(S[c.QueryParameterNames.EnableLanguageId]="true"),this.setQueryParams(S,p,m);const y={};v.token!==void 0&&v.token!==""&&(y[v.headerName]=v.token),y[a.HeaderNames.ConnectionId]=g,p.parameters.setProperty(t.PropertyId.SpeechServiceConnection_Url,m);const C=p.parameters.getProperty("SPEECH-EnableWebsocketCompression","false")==="true";return new i.WebsocketConnection(m,S,y,new o.WebsocketMessageFormatter,i.ProxyInfo.fromRecognizerConfig(p),C,g)}getEndpointUrl(p,v){const g=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Region),m=s.ConnectionFactoryBase.getHostSuffix(g);let S=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Endpoint,void 0);return S||(p.autoDetectSourceLanguages!==void 0?S=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Host,"wss://{region}.stt.speech"+m)+"/speech/universal/v2":S=p.parameters.getProperty(t.PropertyId.SpeechServiceConnection_Host,"wss://{region}.s2s.speech"+m)+"/speech/translation/cognitiveservices/v1"),v===!0?S:e.StringUtils.formatString(S,{region:g})}setQueryParams(p,v,g){p.from=v.parameters.getProperty(t.PropertyId.SpeechServiceConnection_RecoLanguage),p.to=v.parameters.getProperty(t.PropertyId.SpeechServiceConnection_TranslationToLanguages),p.scenario=v.recognitionMode===o.RecognitionMode.Interactive?"interactive":v.recognitionMode===o.RecognitionMode.Conversation?"conversation":"",this.setCommonUrlParams(v,p,g),this.setUrlParameter(t.PropertyId.SpeechServiceResponse_TranslationRequestStablePartialResult,c.QueryParameterNames.StableTranslation,v,p,g);const m=v.parameters.getProperty(t.PropertyId.SpeechServiceConnection_TranslationVoice,void 0);m!==void 0&&(p.voice=m,p.features="texttospeech")}};return TranslationConnectionFactory.TranslationConnectionFactory=u,TranslationConnectionFactory}var EnumTranslation={},hasRequiredEnumTranslation;function requireEnumTranslation(){if(hasRequiredEnumTranslation)return EnumTranslation;hasRequiredEnumTranslation=1,Object.defineProperty(EnumTranslation,"__esModule",{value:!0}),EnumTranslation.EnumTranslation=void 0;const i=requireExports$3(),e=requireExports();let t=class{static implTranslateRecognitionResult(o,a=!1){let c=i.ResultReason.Canceled;switch(o){case e.RecognitionStatus.Success:c=i.ResultReason.RecognizedSpeech;break;case e.RecognitionStatus.EndOfDictation:c=a?i.ResultReason.RecognizedSpeech:i.ResultReason.NoMatch;break;case e.RecognitionStatus.NoMatch:case e.RecognitionStatus.InitialSilenceTimeout:case e.RecognitionStatus.BabbleTimeout:c=i.ResultReason.NoMatch;break;case e.RecognitionStatus.Error:case e.RecognitionStatus.BadRequest:case e.RecognitionStatus.Forbidden:default:c=i.ResultReason.Canceled;break}return c}static implTranslateCancelResult(o){let a=i.CancellationReason.EndOfStream;switch(o){case e.RecognitionStatus.Success:case e.RecognitionStatus.EndOfDictation:case e.RecognitionStatus.NoMatch:a=i.CancellationReason.EndOfStream;break;case e.RecognitionStatus.InitialSilenceTimeout:case e.RecognitionStatus.BabbleTimeout:case e.RecognitionStatus.Error:case e.RecognitionStatus.BadRequest:case e.RecognitionStatus.Forbidden:default:a=i.CancellationReason.Error;break}return a}static implTranslateCancelErrorCode(o){let a=i.CancellationErrorCode.NoError;switch(o){case e.RecognitionStatus.Error:a=i.CancellationErrorCode.ServiceError;break;case e.RecognitionStatus.TooManyRequests:a=i.CancellationErrorCode.TooManyRequests;break;case e.RecognitionStatus.BadRequest:a=i.CancellationErrorCode.BadRequestParameters;break;case e.RecognitionStatus.Forbidden:a=i.CancellationErrorCode.Forbidden;break;default:a=i.CancellationErrorCode.NoError;break}return a}static implTranslateErrorDetails(o){let a="The speech service encountered an internal error and could not continue.";switch(o){case i.CancellationErrorCode.Forbidden:a="The recognizer is using a free subscription that ran out of quota.";break;case i.CancellationErrorCode.BadRequestParameters:a="Invalid parameter or unsupported audio format in the request.";break;case i.CancellationErrorCode.TooManyRequests:a="The number of parallel requests exceeded the number of allowed concurrent transcriptions.";break}return a}};return EnumTranslation.EnumTranslation=t,EnumTranslation}var Enums={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.RecognitionStatus=i.SynthesisStatus=void 0,function(e){e[e.Success=0]="Success",e[e.SynthesisEnd=1]="SynthesisEnd",e[e.Error=2]="Error"}(i.SynthesisStatus||(i.SynthesisStatus={})),function(e){e[e.Success=0]="Success",e[e.NoMatch=1]="NoMatch",e[e.InitialSilenceTimeout=2]="InitialSilenceTimeout",e[e.BabbleTimeout=3]="BabbleTimeout",e[e.Error=4]="Error",e[e.EndOfDictation=5]="EndOfDictation",e[e.TooManyRequests=6]="TooManyRequests",e[e.BadRequest=7]="BadRequest",e[e.Forbidden=8]="Forbidden"}(i.RecognitionStatus||(i.RecognitionStatus={}))})(Enums);var TranslationSynthesisEnd={},hasRequiredTranslationSynthesisEnd;function requireTranslationSynthesisEnd(){if(hasRequiredTranslationSynthesisEnd)return TranslationSynthesisEnd;hasRequiredTranslationSynthesisEnd=1,Object.defineProperty(TranslationSynthesisEnd,"__esModule",{value:!0}),TranslationSynthesisEnd.TranslationSynthesisEnd=void 0;const i=requireExports();let e=class $e{constructor(s){this.privSynthesisEnd=JSON.parse(s),this.privSynthesisEnd.SynthesisStatus&&(this.privSynthesisEnd.SynthesisStatus=i.SynthesisStatus[this.privSynthesisEnd.SynthesisStatus]),this.privSynthesisEnd.Status&&(this.privSynthesisEnd.SynthesisStatus=i.SynthesisStatus[this.privSynthesisEnd.Status])}static fromJSON(s){return new $e(s)}get SynthesisStatus(){return this.privSynthesisEnd.SynthesisStatus}get FailureReason(){return this.privSynthesisEnd.FailureReason}};return TranslationSynthesisEnd.TranslationSynthesisEnd=e,TranslationSynthesisEnd}var TranslationHypothesis$1={};Object.defineProperty(TranslationHypothesis$1,"__esModule",{value:!0});TranslationHypothesis$1.TranslationHypothesis=void 0;const Contracts_js_1=Contracts$1,TranslationStatus_js_1=TranslationStatus;class TranslationHypothesis{constructor(e){this.privTranslationHypothesis=e,this.privTranslationHypothesis.Translation.TranslationStatus=TranslationStatus_js_1.TranslationStatus[this.privTranslationHypothesis.Translation.TranslationStatus]}static fromJSON(e){return new TranslationHypothesis(JSON.parse(e))}static fromTranslationResponse(e){Contracts_js_1.Contracts.throwIfNullOrUndefined(e,"translationHypothesis");const t=e.SpeechHypothesis;return e.SpeechHypothesis=void 0,t.Translation=e,new TranslationHypothesis(t)}get Duration(){return this.privTranslationHypothesis.Duration}get Offset(){return this.privTranslationHypothesis.Offset}get Text(){return this.privTranslationHypothesis.Text}get Translation(){return this.privTranslationHypothesis.Translation}get Language(){var e;return(e=this.privTranslationHypothesis.PrimaryLanguage)==null?void 0:e.Language}}TranslationHypothesis$1.TranslationHypothesis=TranslationHypothesis;var TranslationPhrase={},hasRequiredTranslationPhrase;function requireTranslationPhrase(){if(hasRequiredTranslationPhrase)return TranslationPhrase;hasRequiredTranslationPhrase=1,Object.defineProperty(TranslationPhrase,"__esModule",{value:!0}),TranslationPhrase.TranslationPhrase=void 0;const i=Contracts$1,e=requireExports(),t=TranslationStatus;let s=class fe{constructor(a){this.privTranslationPhrase=a,this.privTranslationPhrase.RecognitionStatus=e.RecognitionStatus[this.privTranslationPhrase.RecognitionStatus],this.privTranslationPhrase.Translation!==void 0&&(this.privTranslationPhrase.Translation.TranslationStatus=t.TranslationStatus[this.privTranslationPhrase.Translation.TranslationStatus])}static fromJSON(a){return new fe(JSON.parse(a))}static fromTranslationResponse(a){i.Contracts.throwIfNullOrUndefined(a,"translationResponse");const c=a.SpeechPhrase;return a.SpeechPhrase=void 0,c.Translation=a,c.Text=c.DisplayText,new fe(c)}get RecognitionStatus(){return this.privTranslationPhrase.RecognitionStatus}get Offset(){return this.privTranslationPhrase.Offset}get Duration(){return this.privTranslationPhrase.Duration}get Text(){return this.privTranslationPhrase.Text}get Language(){var a;return(a=this.privTranslationPhrase.PrimaryLanguage)==null?void 0:a.Language}get Confidence(){var a;return(a=this.privTranslationPhrase.PrimaryLanguage)==null?void 0:a.Confidence}get Translation(){return this.privTranslationPhrase.Translation}};return TranslationPhrase.TranslationPhrase=s,TranslationPhrase}var TranslationServiceRecognizer={},hasRequiredTranslationServiceRecognizer;function requireTranslationServiceRecognizer(){if(hasRequiredTranslationServiceRecognizer)return TranslationServiceRecognizer;hasRequiredTranslationServiceRecognizer=1,Object.defineProperty(TranslationServiceRecognizer,"__esModule",{value:!0}),TranslationServiceRecognizer.TranslationServiceRecognizer=void 0;const i=requireExports$5(),e=requireExports$3(),t=requireExports();let s=class extends t.ConversationServiceRecognizer{constructor(a,c,u,d,p){super(a,c,u,d,p),this.privTranslationRecognizer=p,this.connectionEvents.attach(v=>{v.name==="ConnectionEstablishedEvent"&&this.privTranslationRecognizer.onConnection()})}async processTypeSpecificMessages(a){const c=new e.PropertyCollection;let u=await this.processSpeechMessages(a);if(u)return!0;const d=async v=>{if(this.privRequestSession.onPhraseRecognized(this.privRequestSession.currentTurnAudioOffset+v.Offset+v.Duration),v.RecognitionStatus===t.RecognitionStatus.Success){const g=this.fireEventForResult(v,c);if(this.privTranslationRecognizer.recognized)try{this.privTranslationRecognizer.recognized(this.privTranslationRecognizer,g)}catch{}if(this.privSuccessCallback){try{this.privSuccessCallback(g.result)}catch(m){this.privErrorCallback&&this.privErrorCallback(m)}this.privSuccessCallback=void 0,this.privErrorCallback=void 0}}else{const g=t.EnumTranslation.implTranslateRecognitionResult(v.RecognitionStatus),m=new e.TranslationRecognitionResult(void 0,this.privRequestSession.requestId,g,v.Text,v.Duration,this.privRequestSession.currentTurnAudioOffset+v.Offset,v.Language,v.Confidence,void 0,a.textBody,c);if(g===e.ResultReason.Canceled){const S=t.EnumTranslation.implTranslateCancelResult(v.RecognitionStatus),y=t.EnumTranslation.implTranslateCancelErrorCode(v.RecognitionStatus);await this.cancelRecognitionLocal(S,y,t.EnumTranslation.implTranslateErrorDetails(y))}else{if(!(this.privRequestSession.isSpeechEnded&&g===e.ResultReason.NoMatch&&v.RecognitionStatus!==t.RecognitionStatus.InitialSilenceTimeout)){const S=new e.TranslationRecognitionEventArgs(m,m.offset,this.privRequestSession.sessionId);if(this.privTranslationRecognizer.recognized)try{this.privTranslationRecognizer.recognized(this.privTranslationRecognizer,S)}catch{}}if(this.privSuccessCallback){try{this.privSuccessCallback(m)}catch(S){this.privErrorCallback&&this.privErrorCallback(S)}this.privSuccessCallback=void 0,this.privErrorCallback=void 0}}u=!0}},p=(v,g)=>{const m=this.fireEventForResult(v,g);if(this.privRequestSession.onHypothesis(this.privRequestSession.currentTurnAudioOffset+m.offset),this.privTranslationRecognizer.recognizing)try{this.privTranslationRecognizer.recognizing(this.privTranslationRecognizer,m)}catch{}u=!0};switch(a.messageType===i.MessageType.Text&&c.setProperty(e.PropertyId.SpeechServiceResponse_JsonResult,a.textBody),a.path.toLowerCase()){case"translation.hypothesis":p(t.TranslationHypothesis.fromJSON(a.textBody),c);break;case"translation.response":const v=JSON.parse(a.textBody);if(v.SpeechPhrase)await d(t.TranslationPhrase.fromTranslationResponse(v));else{const m=JSON.parse(a.textBody);m.SpeechHypothesis&&p(t.TranslationHypothesis.fromTranslationResponse(m),c)}break;case"translation.phrase":await d(t.TranslationPhrase.fromJSON(a.textBody));break;case"translation.synthesis":this.sendSynthesisAudio(a.binaryBody,this.privRequestSession.sessionId),u=!0;break;case"audio.end":case"translation.synthesis.end":const g=t.TranslationSynthesisEnd.fromJSON(a.textBody);switch(g.SynthesisStatus){case t.SynthesisStatus.Error:if(this.privTranslationRecognizer.synthesizing){const m=new e.TranslationSynthesisResult(e.ResultReason.Canceled,void 0),S=new e.TranslationSynthesisEventArgs(m,this.privRequestSession.sessionId);try{this.privTranslationRecognizer.synthesizing(this.privTranslationRecognizer,S)}catch{}}if(this.privTranslationRecognizer.canceled){const m=new e.TranslationRecognitionCanceledEventArgs(this.privRequestSession.sessionId,e.CancellationReason.Error,g.FailureReason,e.CancellationErrorCode.ServiceError,null);try{this.privTranslationRecognizer.canceled(this.privTranslationRecognizer,m)}catch{}}break;case t.SynthesisStatus.Success:this.sendSynthesisAudio(void 0,this.privRequestSession.sessionId);break}u=!0;break}return u}cancelRecognition(a,c,u,d,p){const v=new e.PropertyCollection;if(v.setProperty(t.CancellationErrorCodePropertyName,e.CancellationErrorCode[d]),this.privTranslationRecognizer.canceled){const g=new e.TranslationRecognitionCanceledEventArgs(a,u,p,d,void 0);try{this.privTranslationRecognizer.canceled(this.privTranslationRecognizer,g)}catch{}}if(this.privSuccessCallback){const g=new e.TranslationRecognitionResult(void 0,c,e.ResultReason.Canceled,void 0,void 0,void 0,void 0,void 0,p,void 0,v);try{this.privSuccessCallback(g),this.privSuccessCallback=void 0}catch{}}}handleRecognizingCallback(a,c,u){try{const d=new e.TranslationRecognitionEventArgs(e.TranslationRecognitionResult.fromSpeechRecognitionResult(a),c,u);this.privTranslationRecognizer.recognizing(this.privTranslationRecognizer,d)}catch{}}handleRecognizedCallback(a,c,u){try{const d=new e.TranslationRecognitionEventArgs(e.TranslationRecognitionResult.fromSpeechRecognitionResult(a),c,u);this.privTranslationRecognizer.recognized(this.privTranslationRecognizer,d)}catch{}}fireEventForResult(a,c){let u;if(a.Translation.Translations!==void 0){u=new e.Translations;for(const y of a.Translation.Translations)u.set(y.Language,y.Text||y.DisplayText)}let d,p;a instanceof t.TranslationPhrase?(a.Translation&&a.Translation.TranslationStatus===i.TranslationStatus.Success?d=e.ResultReason.TranslatedSpeech:d=e.ResultReason.RecognizedSpeech,p=a.Confidence):d=e.ResultReason.TranslatingSpeech;const v=a.Language,g=a.Offset+this.privRequestSession.currentTurnAudioOffset,m=new e.TranslationRecognitionResult(u,this.privRequestSession.requestId,d,a.Text,a.Duration,g,v,p,a.Translation.FailureReason,JSON.stringify(a),c);return new e.TranslationRecognitionEventArgs(m,g,this.privRequestSession.sessionId)}sendSynthesisAudio(a,c){const u=a===void 0?e.ResultReason.SynthesizingAudioCompleted:e.ResultReason.SynthesizingAudio,d=new e.TranslationSynthesisResult(u,a),p=new e.TranslationSynthesisEventArgs(d,c);if(this.privTranslationRecognizer.synthesizing)try{this.privTranslationRecognizer.synthesizing(this.privTranslationRecognizer,p)}catch{}}};return TranslationServiceRecognizer.TranslationServiceRecognizer=s,TranslationServiceRecognizer}var SpeechDetected$1={};Object.defineProperty(SpeechDetected$1,"__esModule",{value:!0});SpeechDetected$1.SpeechDetected=void 0;class SpeechDetected{constructor(e){this.privSpeechStartDetected=JSON.parse(e)}static fromJSON(e){return new SpeechDetected(e)}get Offset(){return this.privSpeechStartDetected.Offset}}SpeechDetected$1.SpeechDetected=SpeechDetected;var SpeechHypothesis$1={};Object.defineProperty(SpeechHypothesis$1,"__esModule",{value:!0});SpeechHypothesis$1.SpeechHypothesis=void 0;class SpeechHypothesis{constructor(e){this.privSpeechHypothesis=JSON.parse(e)}static fromJSON(e){return new SpeechHypothesis(e)}get Text(){return this.privSpeechHypothesis.Text}get Offset(){return this.privSpeechHypothesis.Offset}get Duration(){return this.privSpeechHypothesis.Duration}get Language(){return this.privSpeechHypothesis.PrimaryLanguage===void 0?void 0:this.privSpeechHypothesis.PrimaryLanguage.Language}get LanguageDetectionConfidence(){return this.privSpeechHypothesis.PrimaryLanguage===void 0?void 0:this.privSpeechHypothesis.PrimaryLanguage.Confidence}get SpeakerId(){return this.privSpeechHypothesis.SpeakerId}}SpeechHypothesis$1.SpeechHypothesis=SpeechHypothesis;var SpeechKeyword$1={};Object.defineProperty(SpeechKeyword$1,"__esModule",{value:!0});SpeechKeyword$1.SpeechKeyword=void 0;class SpeechKeyword{constructor(e){this.privSpeechKeyword=JSON.parse(e)}static fromJSON(e){return new SpeechKeyword(e)}get Status(){return this.privSpeechKeyword.Status}get Text(){return this.privSpeechKeyword.Text}get Offset(){return this.privSpeechKeyword.Offset}get Duration(){return this.privSpeechKeyword.Duration}}SpeechKeyword$1.SpeechKeyword=SpeechKeyword;var SpeechServiceRecognizer={},hasRequiredSpeechServiceRecognizer;function requireSpeechServiceRecognizer(){if(hasRequiredSpeechServiceRecognizer)return SpeechServiceRecognizer;hasRequiredSpeechServiceRecognizer=1,Object.defineProperty(SpeechServiceRecognizer,"__esModule",{value:!0}),SpeechServiceRecognizer.SpeechServiceRecognizer=void 0;const i=requireExports$3(),e=requireExports();let t=class extends e.ServiceRecognizerBase{constructor(o,a,c,u,d){super(o,a,c,u,d),this.privSpeechRecognizer=d}async processTypeSpecificMessages(o){let a;const c=new i.PropertyCollection;c.setProperty(i.PropertyId.SpeechServiceResponse_JsonResult,o.textBody);let u=!1;switch(o.path.toLowerCase()){case"speech.hypothesis":case"speech.fragment":const d=e.SpeechHypothesis.fromJSON(o.textBody),p=d.Offset+this.privRequestSession.currentTurnAudioOffset;a=new i.SpeechRecognitionResult(this.privRequestSession.requestId,i.ResultReason.RecognizingSpeech,d.Text,d.Duration,p,d.Language,d.LanguageDetectionConfidence,void 0,void 0,o.textBody,c),this.privRequestSession.onHypothesis(p);const v=new i.SpeechRecognitionEventArgs(a,d.Duration,this.privRequestSession.sessionId);if(this.privSpeechRecognizer.recognizing)try{this.privSpeechRecognizer.recognizing(this.privSpeechRecognizer,v)}catch{}u=!0;break;case"speech.phrase":const g=e.SimpleSpeechPhrase.fromJSON(o.textBody),m=e.EnumTranslation.implTranslateRecognitionResult(g.RecognitionStatus,this.privExpectContentAssessmentResponse);if(this.privRequestSession.onPhraseRecognized(this.privRequestSession.currentTurnAudioOffset+g.Offset+g.Duration),i.ResultReason.Canceled===m){const S=e.EnumTranslation.implTranslateCancelResult(g.RecognitionStatus),y=e.EnumTranslation.implTranslateCancelErrorCode(g.RecognitionStatus);await this.cancelRecognitionLocal(S,y,e.EnumTranslation.implTranslateErrorDetails(y))}else{if(!(this.privRequestSession.isSpeechEnded&&m===i.ResultReason.NoMatch&&g.RecognitionStatus!==e.RecognitionStatus.InitialSilenceTimeout)){if(this.privRecognizerConfig.parameters.getProperty(e.OutputFormatPropertyName)===i.OutputFormat[i.OutputFormat.Simple])a=new i.SpeechRecognitionResult(this.privRequestSession.requestId,m,g.DisplayText,g.Duration,g.Offset+this.privRequestSession.currentTurnAudioOffset,g.Language,g.LanguageDetectionConfidence,void 0,void 0,o.textBody,c);else{const y=e.DetailedSpeechPhrase.fromJSON(o.textBody),C=y.Offset+this.privRequestSession.currentTurnAudioOffset,R=y.getJsonWithCorrectedOffsets(C);a=new i.SpeechRecognitionResult(this.privRequestSession.requestId,m,y.RecognitionStatus===e.RecognitionStatus.Success?y.NBest[0].Display:void 0,y.Duration,C,y.Language,y.LanguageDetectionConfidence,void 0,void 0,R,c)}const S=new i.SpeechRecognitionEventArgs(a,a.offset,this.privRequestSession.sessionId);if(this.privSpeechRecognizer.recognized)try{this.privSpeechRecognizer.recognized(this.privSpeechRecognizer,S)}catch{}}if(this.privSuccessCallback){try{this.privSuccessCallback(a)}catch(S){this.privErrorCallback&&this.privErrorCallback(S)}this.privSuccessCallback=void 0,this.privErrorCallback=void 0}}u=!0;break}return u}cancelRecognition(o,a,c,u,d){const p=new i.PropertyCollection;if(p.setProperty(e.CancellationErrorCodePropertyName,i.CancellationErrorCode[u]),this.privSpeechRecognizer.canceled){const v=new i.SpeechRecognitionCanceledEventArgs(c,d,u,void 0,o);try{this.privSpeechRecognizer.canceled(this.privSpeechRecognizer,v)}catch{}}if(this.privSuccessCallback){const v=new i.SpeechRecognitionResult(a,i.ResultReason.Canceled,void 0,void 0,void 0,void 0,void 0,void 0,d,void 0,p);try{this.privSuccessCallback(v),this.privSuccessCallback=void 0}catch{}}}};return SpeechServiceRecognizer.SpeechServiceRecognizer=t,SpeechServiceRecognizer}var ConversationTranscriptionServiceRecognizer={},hasRequiredConversationTranscriptionServiceRecognizer;function requireConversationTranscriptionServiceRecognizer(){if(hasRequiredConversationTranscriptionServiceRecognizer)return ConversationTranscriptionServiceRecognizer;hasRequiredConversationTranscriptionServiceRecognizer=1,Object.defineProperty(ConversationTranscriptionServiceRecognizer,"__esModule",{value:!0}),ConversationTranscriptionServiceRecognizer.ConversationTranscriptionServiceRecognizer=void 0;const i=requireExports$3(),e=requireExports();let t=class extends e.ServiceRecognizerBase{constructor(o,a,c,u,d){super(o,a,c,u,d),this.privConversationTranscriber=d,this.setSpeakerDiarizationJson()}setSpeakerDiarizationJson(){if(this.privEnableSpeakerId){const o=this.privSpeechContext.getSection("phraseDetection");o.mode="Conversation";const a={};a.mode="Anonymous",a.audioSessionId=this.privDiarizationSessionId,a.audioOffsetMs=0,a.diarizeIntermediates=this.privRecognizerConfig.parameters.getProperty(i.PropertyId.SpeechServiceResponse_DiarizeIntermediateResults,"false")==="true",o.speakerDiarization=a,this.privSpeechContext.setSection("phraseDetection",o)}}async processTypeSpecificMessages(o){let a;const c=new i.PropertyCollection;c.setProperty(i.PropertyId.SpeechServiceResponse_JsonResult,o.textBody);let u=!1;switch(o.path.toLowerCase()){case"speech.hypothesis":case"speech.fragment":const d=e.SpeechHypothesis.fromJSON(o.textBody),p=d.Offset+this.privRequestSession.currentTurnAudioOffset;a=new i.ConversationTranscriptionResult(this.privRequestSession.requestId,i.ResultReason.RecognizingSpeech,d.Text,d.Duration,p,d.Language,d.LanguageDetectionConfidence,d.SpeakerId,void 0,o.textBody,c),this.privRequestSession.onHypothesis(p);const v=new i.ConversationTranscriptionEventArgs(a,d.Duration,this.privRequestSession.sessionId);if(this.privConversationTranscriber.transcribing)try{this.privConversationTranscriber.transcribing(this.privConversationTranscriber,v)}catch{}u=!0;break;case"speech.phrase":const g=e.SimpleSpeechPhrase.fromJSON(o.textBody),m=e.EnumTranslation.implTranslateRecognitionResult(g.RecognitionStatus);if(this.privRequestSession.onPhraseRecognized(this.privRequestSession.currentTurnAudioOffset+g.Offset+g.Duration),i.ResultReason.Canceled===m){const S=e.EnumTranslation.implTranslateCancelResult(g.RecognitionStatus),y=e.EnumTranslation.implTranslateCancelErrorCode(g.RecognitionStatus);await this.cancelRecognitionLocal(S,y,e.EnumTranslation.implTranslateErrorDetails(y))}else if(!(this.privRequestSession.isSpeechEnded&&m===i.ResultReason.NoMatch&&g.RecognitionStatus!==e.RecognitionStatus.InitialSilenceTimeout)){if(this.privRecognizerConfig.parameters.getProperty(e.OutputFormatPropertyName)===i.OutputFormat[i.OutputFormat.Simple])a=new i.ConversationTranscriptionResult(this.privRequestSession.requestId,m,g.DisplayText,g.Duration,g.Offset+this.privRequestSession.currentTurnAudioOffset,g.Language,g.LanguageDetectionConfidence,g.SpeakerId,void 0,o.textBody,c);else{const y=e.DetailedSpeechPhrase.fromJSON(o.textBody),C=y.Offset+this.privRequestSession.currentTurnAudioOffset,R=y.getJsonWithCorrectedOffsets(C);a=new i.ConversationTranscriptionResult(this.privRequestSession.requestId,m,y.RecognitionStatus===e.RecognitionStatus.Success?y.NBest[0].Display:void 0,y.Duration,C,y.Language,y.LanguageDetectionConfidence,g.SpeakerId,void 0,R,c)}const S=new i.ConversationTranscriptionEventArgs(a,a.offset,this.privRequestSession.sessionId);if(this.privConversationTranscriber.transcribed)try{this.privConversationTranscriber.transcribed(this.privConversationTranscriber,S)}catch{}}u=!0;break}return u}cancelRecognition(o,a,c,u,d){if(new i.PropertyCollection().setProperty(e.CancellationErrorCodePropertyName,i.CancellationErrorCode[u]),this.privConversationTranscriber.canceled){const v=new i.ConversationTranscriptionCanceledEventArgs(c,d,u,void 0,o);try{this.privConversationTranscriber.canceled(this.privConversationTranscriber,v)}catch{}}}};return ConversationTranscriptionServiceRecognizer.ConversationTranscriptionServiceRecognizer=t,ConversationTranscriptionServiceRecognizer}var TranscriptionServiceRecognizer={},hasRequiredTranscriptionServiceRecognizer;function requireTranscriptionServiceRecognizer(){if(hasRequiredTranscriptionServiceRecognizer)return TranscriptionServiceRecognizer;hasRequiredTranscriptionServiceRecognizer=1,Object.defineProperty(TranscriptionServiceRecognizer,"__esModule",{value:!0}),TranscriptionServiceRecognizer.TranscriptionServiceRecognizer=void 0;const i=requireExports$5(),e=requireExports$3(),t=requireExports(),s=SpeechConnectionMessage_Internal;let o=class extends t.ConversationServiceRecognizer{constructor(c,u,d,p,v){super(c,u,d,p,v),this.privTranscriberRecognizer=v,this.sendPrePayloadJSONOverride=g=>this.sendTranscriptionStartJSON(g),this.privRecognizerConfig.parameters.getProperty(e.PropertyId.SpeechServiceResponse_RequestWordLevelTimestamps)==="true"&&this.privSpeechContext.setWordLevelTimings()}async sendSpeechEventAsync(c,u){if(this.privRequestSession.isRecognizing){const d=await this.fetchConnection();await this.sendSpeechEvent(d,this.createSpeechEventPayload(c,u))}}async sendMeetingSpeechEventAsync(c,u){if(this.privRequestSession.isRecognizing){const d=await this.fetchConnection();await this.sendSpeechEvent(d,this.createMeetingSpeechEventPayload(c,u))}}processTypeSpecificMessages(c){return this.processSpeechMessages(c)}handleRecognizedCallback(c,u,d){try{const p=new e.SpeechRecognitionEventArgs(c,u,d);if(this.privTranscriberRecognizer.recognized(this.privTranscriberRecognizer,p),this.privSuccessCallback){try{this.privSuccessCallback(c)}catch(v){this.privErrorCallback&&this.privErrorCallback(v)}this.privSuccessCallback=void 0,this.privErrorCallback=void 0}}catch{}}handleRecognizingCallback(c,u,d){try{const p=new e.SpeechRecognitionEventArgs(c,u,d);this.privTranscriberRecognizer.recognizing(this.privTranscriberRecognizer,p)}catch{}}cancelRecognition(c,u,d,p,v){const g=new e.PropertyCollection;if(g.setProperty(t.CancellationErrorCodePropertyName,e.CancellationErrorCode[p]),this.privTranscriberRecognizer.IsMeetingRecognizer()){if(this.privTranscriberRecognizer.canceled){const m=new e.MeetingTranscriptionCanceledEventArgs(d,v,p,void 0,c);try{this.privTranscriberRecognizer.canceled(this.privTranscriberRecognizer,m)}catch{}}}else if(this.privTranscriberRecognizer.canceled){const m=new e.ConversationTranscriptionCanceledEventArgs(d,v,p,void 0,c);try{this.privTranscriberRecognizer.canceled(this.privTranscriberRecognizer,m)}catch{}}if(this.privSuccessCallback){const m=new e.SpeechRecognitionResult(u,e.ResultReason.Canceled,void 0,void 0,void 0,void 0,void 0,void 0,v,void 0,g);try{this.privSuccessCallback(m),this.privSuccessCallback=void 0}catch{}}}async sendTranscriptionStartJSON(c){if(await this.sendSpeechContext(c,!0),this.privTranscriberRecognizer.IsMeetingRecognizer()){const u=this.privTranscriberRecognizer.getMeetingInfo(),d=this.createMeetingSpeechEventPayload(u,"start");await this.sendSpeechEvent(c,d)}else{const u=this.privTranscriberRecognizer.getConversationInfo(),d=this.createSpeechEventPayload(u,"start");await this.sendSpeechEvent(c,d)}await this.sendWaveHeader(c)}sendSpeechEvent(c,u){const d=JSON.stringify(u);if(d)return c.send(new s.SpeechConnectionMessage(i.MessageType.Text,"speech.event",this.privRequestSession.requestId,"application/json",d))}createSpeechEventPayload(c,u){const d={id:"meeting",name:u,meeting:c.conversationProperties};return d.meeting.id=c.id,d.meeting.attendees=c.participants,d}createMeetingSpeechEventPayload(c,u){const d={id:"meeting",name:u,meeting:c.meetingProperties};return d.meeting.id=c.id,d.meeting.attendees=c.participants,d}};return TranscriptionServiceRecognizer.TranscriptionServiceRecognizer=o,TranscriptionServiceRecognizer}var DetailedSpeechPhrase={},hasRequiredDetailedSpeechPhrase;function requireDetailedSpeechPhrase(){if(hasRequiredDetailedSpeechPhrase)return DetailedSpeechPhrase;hasRequiredDetailedSpeechPhrase=1,Object.defineProperty(DetailedSpeechPhrase,"__esModule",{value:!0}),DetailedSpeechPhrase.DetailedSpeechPhrase=void 0;const i=requireExports();let e=class je{constructor(s){this.privDetailedSpeechPhrase=JSON.parse(s),this.privDetailedSpeechPhrase.RecognitionStatus=i.RecognitionStatus[this.privDetailedSpeechPhrase.RecognitionStatus]}static fromJSON(s){return new je(s)}getJsonWithCorrectedOffsets(s){if(this.privDetailedSpeechPhrase.NBest){let o;for(const a of this.privDetailedSpeechPhrase.NBest)if(a.Words&&a.Words[0]){o=a.Words[0].Offset;break}if(o&&o<s){const a=s-o;for(const c of this.privDetailedSpeechPhrase.NBest){if(c.Words)for(const u of c.Words)u.Offset+=a;if(c.DisplayWords)for(const u of c.DisplayWords)u.Offset+=a}}}return JSON.stringify(this.privDetailedSpeechPhrase)}get RecognitionStatus(){return this.privDetailedSpeechPhrase.RecognitionStatus}get NBest(){return this.privDetailedSpeechPhrase.NBest}get Duration(){return this.privDetailedSpeechPhrase.Duration}get Offset(){return this.privDetailedSpeechPhrase.Offset}get Language(){return this.privDetailedSpeechPhrase.PrimaryLanguage===void 0?void 0:this.privDetailedSpeechPhrase.PrimaryLanguage.Language}get LanguageDetectionConfidence(){return this.privDetailedSpeechPhrase.PrimaryLanguage===void 0?void 0:this.privDetailedSpeechPhrase.PrimaryLanguage.Confidence}get Text(){return this.privDetailedSpeechPhrase.NBest&&this.privDetailedSpeechPhrase.NBest[0]?this.privDetailedSpeechPhrase.NBest[0].Display||this.privDetailedSpeechPhrase.NBest[0].DisplayText:this.privDetailedSpeechPhrase.DisplayText}get SpeakerId(){return this.privDetailedSpeechPhrase.SpeakerId}};return DetailedSpeechPhrase.DetailedSpeechPhrase=e,DetailedSpeechPhrase}var SimpleSpeechPhrase={},hasRequiredSimpleSpeechPhrase;function requireSimpleSpeechPhrase(){if(hasRequiredSimpleSpeechPhrase)return SimpleSpeechPhrase;hasRequiredSimpleSpeechPhrase=1,Object.defineProperty(SimpleSpeechPhrase,"__esModule",{value:!0}),SimpleSpeechPhrase.SimpleSpeechPhrase=void 0;const i=requireExports();let e=class qe{constructor(s){this.privSimpleSpeechPhrase=JSON.parse(s),this.privSimpleSpeechPhrase.RecognitionStatus=i.RecognitionStatus[this.privSimpleSpeechPhrase.RecognitionStatus]}static fromJSON(s){return new qe(s)}get RecognitionStatus(){return this.privSimpleSpeechPhrase.RecognitionStatus}get DisplayText(){return this.privSimpleSpeechPhrase.DisplayText}get Offset(){return this.privSimpleSpeechPhrase.Offset}get Duration(){return this.privSimpleSpeechPhrase.Duration}get Language(){return this.privSimpleSpeechPhrase.PrimaryLanguage===void 0?void 0:this.privSimpleSpeechPhrase.PrimaryLanguage.Language}get LanguageDetectionConfidence(){return this.privSimpleSpeechPhrase.PrimaryLanguage===void 0?void 0:this.privSimpleSpeechPhrase.PrimaryLanguage.Confidence}get SpeakerId(){return this.privSimpleSpeechPhrase.SpeakerId}};return SimpleSpeechPhrase.SimpleSpeechPhrase=e,SimpleSpeechPhrase}var AddedLmIntent$1={};Object.defineProperty(AddedLmIntent$1,"__esModule",{value:!0});AddedLmIntent$1.AddedLmIntent=void 0;class AddedLmIntent{constructor(e,t){this.modelImpl=e,this.intentName=t}}AddedLmIntent$1.AddedLmIntent=AddedLmIntent;var IntentServiceRecognizer={},hasRequiredIntentServiceRecognizer;function requireIntentServiceRecognizer(){if(hasRequiredIntentServiceRecognizer)return IntentServiceRecognizer;hasRequiredIntentServiceRecognizer=1,Object.defineProperty(IntentServiceRecognizer,"__esModule",{value:!0}),IntentServiceRecognizer.IntentServiceRecognizer=void 0;const i=requireExports$5(),e=requireExports$3(),t=requireExports();let s=class extends t.ServiceRecognizerBase{constructor(a,c,u,d,p){super(a,c,u,d,p),this.privIntentRecognizer=p,this.privIntentDataSent=!1}setIntents(a,c){this.privAddedLmIntents=a,this.privUmbrellaIntent=c,this.privIntentDataSent=!0}processTypeSpecificMessages(a){let c,u,d=!1;const p=new e.PropertyCollection;switch(a.messageType===i.MessageType.Text&&p.setProperty(e.PropertyId.SpeechServiceResponse_JsonResult,a.textBody),a.path.toLowerCase()){case"speech.hypothesis":const g=t.SpeechHypothesis.fromJSON(a.textBody);if(c=new e.IntentRecognitionResult(void 0,this.privRequestSession.requestId,e.ResultReason.RecognizingIntent,g.Text,g.Duration,g.Offset+this.privRequestSession.currentTurnAudioOffset,g.Language,g.LanguageDetectionConfidence,void 0,a.textBody,p),this.privRequestSession.onHypothesis(c.offset),u=new e.IntentRecognitionEventArgs(c,g.Offset+this.privRequestSession.currentTurnAudioOffset,this.privRequestSession.sessionId),this.privIntentRecognizer.recognizing)try{this.privIntentRecognizer.recognizing(this.privIntentRecognizer,u)}catch{}d=!0;break;case"speech.phrase":const m=t.SimpleSpeechPhrase.fromJSON(a.textBody);c=new e.IntentRecognitionResult(void 0,this.privRequestSession.requestId,t.EnumTranslation.implTranslateRecognitionResult(m.RecognitionStatus),m.DisplayText,m.Duration,m.Offset+this.privRequestSession.currentTurnAudioOffset,m.Language,m.LanguageDetectionConfidence,void 0,a.textBody,p),u=new e.IntentRecognitionEventArgs(c,c.offset,this.privRequestSession.sessionId);const S=()=>{if(this.privIntentRecognizer.recognized)try{this.privIntentRecognizer.recognized(this.privIntentRecognizer,u)}catch{}if(this.privSuccessCallback){try{this.privSuccessCallback(c)}catch(C){this.privErrorCallback&&this.privErrorCallback(C)}this.privSuccessCallback=void 0,this.privErrorCallback=void 0}};this.privIntentDataSent===!1||e.ResultReason.NoMatch===u.result.reason?(this.privRequestSession.onPhraseRecognized(u.offset+u.result.duration),S()):this.privPendingIntentArgs=u,d=!0;break;case"response":if(u=this.privPendingIntentArgs,this.privPendingIntentArgs=void 0,u===void 0){if(a.textBody==="")return;u=new e.IntentRecognitionEventArgs(new e.IntentRecognitionResult,0,this.privRequestSession.sessionId)}const y=t.IntentResponse.fromJSON(a.textBody);if(y!==null&&y.topScoringIntent&&y.topScoringIntent.intent){let C=this.privAddedLmIntents[y.topScoringIntent.intent];if(this.privUmbrellaIntent!==void 0&&(C=this.privUmbrellaIntent),C){const R=C===void 0||C.intentName===void 0?y.topScoringIntent.intent:C.intentName;let T=u.result.reason;R!==void 0&&(T=e.ResultReason.RecognizedIntent);const E=u.result.properties!==void 0?u.result.properties:new e.PropertyCollection;E.setProperty(e.PropertyId.LanguageUnderstandingServiceResponse_JsonResult,a.textBody),u=new e.IntentRecognitionEventArgs(new e.IntentRecognitionResult(R,u.result.resultId,T,u.result.text,u.result.duration,u.result.offset,void 0,void 0,u.result.errorDetails,u.result.json,E),u.offset,u.sessionId)}}if(this.privRequestSession.onPhraseRecognized(u.offset+u.result.duration),this.privIntentRecognizer.recognized)try{this.privIntentRecognizer.recognized(this.privIntentRecognizer,u)}catch{}if(this.privSuccessCallback){try{this.privSuccessCallback(u.result)}catch(C){this.privErrorCallback&&this.privErrorCallback(C)}this.privSuccessCallback=void 0,this.privErrorCallback=void 0}d=!0;break}const v=new i.Deferred;return v.resolve(d),v.promise}cancelRecognition(a,c,u,d,p){const v=new e.PropertyCollection;if(v.setProperty(t.CancellationErrorCodePropertyName,e.CancellationErrorCode[d]),this.privIntentRecognizer.canceled){const g=new e.IntentRecognitionCanceledEventArgs(u,p,d,void 0,void 0,a);try{this.privIntentRecognizer.canceled(this.privIntentRecognizer,g)}catch{}}if(this.privSuccessCallback){const g=new e.IntentRecognitionResult(void 0,c,e.ResultReason.Canceled,void 0,void 0,void 0,void 0,void 0,p,void 0,v);try{this.privSuccessCallback(g),this.privSuccessCallback=void 0}catch{}}}};return IntentServiceRecognizer.IntentServiceRecognizer=s,IntentServiceRecognizer}var IntentResponse$1={};Object.defineProperty(IntentResponse$1,"__esModule",{value:!0});IntentResponse$1.IntentResponse=void 0;class IntentResponse{constructor(e){e===""?this.privIntentResponse={}:this.privIntentResponse=JSON.parse(e)}static fromJSON(e){return new IntentResponse(e)}get query(){return this.privIntentResponse.query}get topScoringIntent(){return this.privIntentResponse.topScoringIntent}get entities(){return this.privIntentResponse.entities}}IntentResponse$1.IntentResponse=IntentResponse;var SpeakerResponse={};Object.defineProperty(SpeakerResponse,"__esModule",{value:!0});var RequestSession$1={},ServiceTelemetryListener_Internal={};Object.defineProperty(ServiceTelemetryListener_Internal,"__esModule",{value:!0});ServiceTelemetryListener_Internal.ServiceTelemetryListener=void 0;const Exports_js_1$5=requireExports$5(),RecognitionEvents_js_1$1=RecognitionEvents;class ServiceTelemetryListener{constructor(e,t,s){this.privIsDisposed=!1,this.privListeningTriggerMetric=null,this.privMicMetric=null,this.privConnectionEstablishMetric=null,this.privRequestId=e,this.privAudioSourceId=t,this.privAudioNodeId=s,this.privReceivedMessages={},this.privPhraseLatencies=[],this.privHypothesisLatencies=[]}phraseReceived(e){e>0&&this.privPhraseLatencies.push(Date.now()-e)}hypothesisReceived(e){e>0&&this.privHypothesisLatencies.push(Date.now()-e)}onEvent(e){this.privIsDisposed||(e instanceof RecognitionEvents_js_1$1.RecognitionTriggeredEvent&&e.requestId===this.privRequestId&&(this.privListeningTriggerMetric={End:e.eventTime,Name:"ListeningTrigger",Start:e.eventTime}),e instanceof Exports_js_1$5.AudioStreamNodeAttachingEvent&&e.audioSourceId===this.privAudioSourceId&&e.audioNodeId===this.privAudioNodeId&&(this.privMicStartTime=e.eventTime),e instanceof Exports_js_1$5.AudioStreamNodeAttachedEvent&&e.audioSourceId===this.privAudioSourceId&&e.audioNodeId===this.privAudioNodeId&&(this.privMicStartTime=e.eventTime),e instanceof Exports_js_1$5.AudioSourceErrorEvent&&e.audioSourceId===this.privAudioSourceId&&(this.privMicMetric||(this.privMicMetric={End:e.eventTime,Error:e.error,Name:"Microphone",Start:this.privMicStartTime})),e instanceof Exports_js_1$5.AudioStreamNodeErrorEvent&&e.audioSourceId===this.privAudioSourceId&&e.audioNodeId===this.privAudioNodeId&&(this.privMicMetric||(this.privMicMetric={End:e.eventTime,Error:e.error,Name:"Microphone",Start:this.privMicStartTime})),e instanceof Exports_js_1$5.AudioStreamNodeDetachedEvent&&e.audioSourceId===this.privAudioSourceId&&e.audioNodeId===this.privAudioNodeId&&(this.privMicMetric||(this.privMicMetric={End:e.eventTime,Name:"Microphone",Start:this.privMicStartTime})),e instanceof RecognitionEvents_js_1$1.ConnectingToServiceEvent&&e.requestId===this.privRequestId&&(this.privConnectionId=e.sessionId),e instanceof Exports_js_1$5.ConnectionStartEvent&&e.connectionId===this.privConnectionId&&(this.privConnectionStartTime=e.eventTime),e instanceof Exports_js_1$5.ConnectionEstablishedEvent&&e.connectionId===this.privConnectionId&&(this.privConnectionEstablishMetric||(this.privConnectionEstablishMetric={End:e.eventTime,Id:this.privConnectionId,Name:"Connection",Start:this.privConnectionStartTime})),e instanceof Exports_js_1$5.ConnectionEstablishErrorEvent&&e.connectionId===this.privConnectionId&&(this.privConnectionEstablishMetric||(this.privConnectionEstablishMetric={End:e.eventTime,Error:this.getConnectionError(e.statusCode),Id:this.privConnectionId,Name:"Connection",Start:this.privConnectionStartTime})),e instanceof Exports_js_1$5.ConnectionMessageReceivedEvent&&e.connectionId===this.privConnectionId&&e.message&&e.message.headers&&e.message.headers.path&&(this.privReceivedMessages[e.message.headers.path]||(this.privReceivedMessages[e.message.headers.path]=new Array),this.privReceivedMessages[e.message.headers.path].length<50&&this.privReceivedMessages[e.message.headers.path].push(e.networkReceivedTime)))}getTelemetry(){const e=new Array;this.privListeningTriggerMetric&&e.push(this.privListeningTriggerMetric),this.privMicMetric&&e.push(this.privMicMetric),this.privConnectionEstablishMetric&&e.push(this.privConnectionEstablishMetric),this.privPhraseLatencies.length>0&&e.push({PhraseLatencyMs:this.privPhraseLatencies}),this.privHypothesisLatencies.length>0&&e.push({FirstHypothesisLatencyMs:this.privHypothesisLatencies});const t={Metrics:e,ReceivedMessages:this.privReceivedMessages},s=JSON.stringify(t);return this.privReceivedMessages={},this.privListeningTriggerMetric=null,this.privMicMetric=null,this.privConnectionEstablishMetric=null,this.privPhraseLatencies=[],this.privHypothesisLatencies=[],s}get hasTelemetry(){return Object.keys(this.privReceivedMessages).length!==0||this.privListeningTriggerMetric!==null||this.privMicMetric!==null||this.privConnectionEstablishMetric!==null||this.privPhraseLatencies.length!==0||this.privHypothesisLatencies.length!==0}dispose(){this.privIsDisposed=!0}getConnectionError(e){switch(e){case 400:case 1002:case 1003:case 1005:case 1007:case 1008:case 1009:return"BadRequest";case 401:return"Unauthorized";case 403:return"Forbidden";case 503:case 1001:return"ServerUnavailable";case 500:case 1011:return"ServerError";case 408:case 504:return"Timeout";default:return"statuscode:"+e.toString()}}}ServiceTelemetryListener_Internal.ServiceTelemetryListener=ServiceTelemetryListener;Object.defineProperty(RequestSession$1,"__esModule",{value:!0});RequestSession$1.RequestSession=void 0;const Exports_js_1$4=requireExports$5(),RecognitionEvents_js_1=RecognitionEvents,ServiceTelemetryListener_Internal_js_1=ServiceTelemetryListener_Internal;class RequestSession{constructor(e){this.privIsDisposed=!1,this.privDetachables=new Array,this.privIsAudioNodeDetached=!1,this.privIsRecognizing=!1,this.privIsSpeechEnded=!1,this.privTurnStartAudioOffset=0,this.privLastRecoOffset=0,this.privHypothesisReceived=!1,this.privBytesSent=0,this.privRecognitionBytesSent=0,this.privRecogNumber=0,this.privInTurn=!1,this.privConnectionAttempts=0,this.privAudioSourceId=e,this.privRequestId=Exports_js_1$4.createNoDashGuid(),this.privAudioNodeId=Exports_js_1$4.createNoDashGuid(),this.privTurnDeferral=new Exports_js_1$4.Deferred,this.privTurnDeferral.resolve()}get sessionId(){return this.privSessionId}get requestId(){return this.privRequestId}get audioNodeId(){return this.privAudioNodeId}get turnCompletionPromise(){return this.privTurnDeferral.promise}get isSpeechEnded(){return this.privIsSpeechEnded}get isRecognizing(){return this.privIsRecognizing}get currentTurnAudioOffset(){return this.privTurnStartAudioOffset}get recogNumber(){return this.privRecogNumber}get numConnectionAttempts(){return this.privConnectionAttempts}get bytesSent(){return this.privBytesSent}get recognitionBytesSent(){return this.privRecognitionBytesSent}listenForServiceTelemetry(e){this.privServiceTelemetryListener&&this.privDetachables.push(e.attachListener(this.privServiceTelemetryListener))}startNewRecognition(){this.privRecognitionBytesSent=0,this.privIsSpeechEnded=!1,this.privIsRecognizing=!0,this.privTurnStartAudioOffset=0,this.privLastRecoOffset=0,this.privRecogNumber++,this.privServiceTelemetryListener=new ServiceTelemetryListener_Internal_js_1.ServiceTelemetryListener(this.privRequestId,this.privAudioSourceId,this.privAudioNodeId),this.onEvent(new RecognitionEvents_js_1.RecognitionTriggeredEvent(this.requestId,this.privSessionId,this.privAudioSourceId,this.privAudioNodeId))}async onAudioSourceAttachCompleted(e,t){this.privAudioNode=e,this.privIsAudioNodeDetached=!1,t?await this.onComplete():this.onEvent(new RecognitionEvents_js_1.ListeningStartedEvent(this.privRequestId,this.privSessionId,this.privAudioSourceId,this.privAudioNodeId))}onPreConnectionStart(e,t){this.privAuthFetchEventId=e,this.privSessionId=t,this.onEvent(new RecognitionEvents_js_1.ConnectingToServiceEvent(this.privRequestId,this.privAuthFetchEventId,this.privSessionId))}async onAuthCompleted(e){e&&await this.onComplete()}async onConnectionEstablishCompleted(e,t){if(e===200){this.onEvent(new RecognitionEvents_js_1.RecognitionStartedEvent(this.requestId,this.privAudioSourceId,this.privAudioNodeId,this.privAuthFetchEventId,this.privSessionId)),this.privAudioNode&&this.privAudioNode.replay(),this.privTurnStartAudioOffset=this.privLastRecoOffset,this.privBytesSent=0;return}else e===403&&await this.onComplete()}async onServiceTurnEndResponse(e){this.privTurnDeferral.resolve(),!e||this.isSpeechEnded?(await this.onComplete(),this.privInTurn=!1):(this.privTurnStartAudioOffset=this.privLastRecoOffset,this.privAudioNode.replay())}onSpeechContext(){this.privRequestId=Exports_js_1$4.createNoDashGuid()}onServiceTurnStartResponse(){this.privTurnDeferral&&this.privInTurn&&(this.privTurnDeferral.reject("Another turn started before current completed."),this.privTurnDeferral.promise.then().catch(()=>{})),this.privInTurn=!0,this.privTurnDeferral=new Exports_js_1$4.Deferred}onHypothesis(e){this.privHypothesisReceived||(this.privHypothesisReceived=!0,this.privServiceTelemetryListener.hypothesisReceived(this.privAudioNode.findTimeAtOffset(e)))}onPhraseRecognized(e){this.privServiceTelemetryListener.phraseReceived(this.privAudioNode.findTimeAtOffset(e)),this.onServiceRecognized(e)}onServiceRecognized(e){this.privLastRecoOffset=e,this.privHypothesisReceived=!1,this.privAudioNode.shrinkBuffers(e),this.privConnectionAttempts=0}onAudioSent(e){this.privBytesSent+=e,this.privRecognitionBytesSent+=e}onRetryConnection(){this.privConnectionAttempts++}async dispose(){if(!this.privIsDisposed){this.privIsDisposed=!0;for(const e of this.privDetachables)await e.detach();this.privServiceTelemetryListener&&this.privServiceTelemetryListener.dispose(),this.privIsRecognizing=!1}}getTelemetry(){return this.privServiceTelemetryListener.hasTelemetry?this.privServiceTelemetryListener.getTelemetry():null}async onStopRecognizing(){await this.onComplete()}onSpeechEnded(){this.privIsSpeechEnded=!0}onEvent(e){this.privServiceTelemetryListener&&this.privServiceTelemetryListener.onEvent(e),Exports_js_1$4.Events.instance.onEvent(e)}async onComplete(){this.privIsRecognizing&&(this.privIsRecognizing=!1,await this.detachAudioNode())}async detachAudioNode(){this.privIsAudioNodeDetached||(this.privIsAudioNodeDetached=!0,this.privAudioNode&&await this.privAudioNode.detach())}}RequestSession$1.RequestSession=RequestSession;var SpeechContext$1={};Object.defineProperty(SpeechContext$1,"__esModule",{value:!0});SpeechContext$1.SpeechContext=void 0;class SpeechContext{constructor(e){this.privContext={},this.privDynamicGrammar=e}getSection(e){return this.privContext[e]||{}}setSection(e,t){this.privContext[e]=t}setPronunciationAssessmentParams(e,t,s=!1){this.privContext.phraseDetection===void 0&&(this.privContext.phraseDetection={enrichment:{pronunciationAssessment:{}}}),this.privContext.phraseDetection.enrichment===void 0&&(this.privContext.phraseDetection.enrichment={pronunciationAssessment:{}}),this.privContext.phraseDetection.enrichment.pronunciationAssessment=JSON.parse(e),s&&(this.privContext.phraseDetection.mode="Conversation"),this.setWordLevelTimings(),this.privContext.phraseOutput.detailed.options.push("PronunciationAssessment"),this.privContext.phraseOutput.detailed.options.indexOf("SNR")===-1&&this.privContext.phraseOutput.detailed.options.push("SNR"),t&&(this.privContext.phraseDetection.enrichment.contentAssessment={topic:t},this.privContext.phraseOutput.detailed.options.push("ContentAssessment"))}setDetailedOutputFormat(){this.privContext.phraseOutput===void 0&&(this.privContext.phraseOutput={detailed:{options:[]},format:{}}),this.privContext.phraseOutput.detailed===void 0&&(this.privContext.phraseOutput.detailed={options:[]}),this.privContext.phraseOutput.format="Detailed"}setWordLevelTimings(){this.privContext.phraseOutput===void 0&&(this.privContext.phraseOutput={detailed:{options:[]},format:{}}),this.privContext.phraseOutput.detailed===void 0&&(this.privContext.phraseOutput.detailed={options:[]}),this.privContext.phraseOutput.format="Detailed",this.privContext.phraseOutput.detailed.options.indexOf("WordTimings")===-1&&this.privContext.phraseOutput.detailed.options.push("WordTimings")}setSpeakerDiarizationAudioOffsetMs(e){this.privContext.phraseDetection.speakerDiarization.audioOffsetMs=e}toJSON(){const e=this.privDynamicGrammar.generateGrammarObject();return this.setSection("dgi",e),JSON.stringify(this.privContext)}}SpeechContext$1.SpeechContext=SpeechContext;var DynamicGrammarBuilder$1={};Object.defineProperty(DynamicGrammarBuilder$1,"__esModule",{value:!0});DynamicGrammarBuilder$1.DynamicGrammarBuilder=void 0;class DynamicGrammarBuilder{addPhrase(e){this.privPhrases||(this.privPhrases=[]),e instanceof Array?this.privPhrases=this.privPhrases.concat(e):this.privPhrases.push(e)}clearPhrases(){this.privPhrases=void 0}addReferenceGrammar(e){this.privGrammars||(this.privGrammars=[]),e instanceof Array?this.privGrammars=this.privGrammars.concat(e):this.privGrammars.push(e)}clearGrammars(){this.privGrammars=void 0}generateGrammarObject(){if(this.privGrammars===void 0&&this.privPhrases===void 0)return;const e={};if(e.ReferenceGrammars=this.privGrammars,this.privPhrases!==void 0&&this.privPhrases.length!==0){const t=[];this.privPhrases.forEach(s=>{t.push({Text:s})}),e.Groups=[{Type:"Generic",Items:t}]}return e}}DynamicGrammarBuilder$1.DynamicGrammarBuilder=DynamicGrammarBuilder;var DynamicGrammarInterfaces={};Object.defineProperty(DynamicGrammarInterfaces,"__esModule",{value:!0});var DialogServiceAdapter={},DialogServiceTurnStateManager$1={},DialogServiceTurnState$1={},ActivityResponsePayload={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.MessageDataStreamType=i.ActivityPayloadResponse=void 0;class e{constructor(s){this.privActivityResponse=JSON.parse(s)}static fromJSON(s){return new e(s)}get conversationId(){return this.privActivityResponse.conversationId}get messageDataStreamType(){return this.privActivityResponse.messageDataStreamType}get messagePayload(){return this.privActivityResponse.messagePayload}get version(){return this.privActivityResponse.version}}i.ActivityPayloadResponse=e,function(t){t[t.None=0]="None",t[t.TextToSpeechAudio=1]="TextToSpeechAudio"}(i.MessageDataStreamType||(i.MessageDataStreamType={}))})(ActivityResponsePayload);Object.defineProperty(DialogServiceTurnState$1,"__esModule",{value:!0});DialogServiceTurnState$1.DialogServiceTurnState=void 0;const AudioOutputFormat_js_1=AudioOutputFormat,AudioOutputStream_js_1=AudioOutputStream$1,ActivityResponsePayload_js_1=ActivityResponsePayload;class DialogServiceTurnState{constructor(e,t){this.privRequestId=t,this.privIsCompleted=!1,this.privAudioStream=null,this.privTurnManager=e,this.resetTurnEndTimeout()}get audioStream(){return this.resetTurnEndTimeout(),this.privAudioStream}processActivityPayload(e,t){return e.messageDataStreamType===ActivityResponsePayload_js_1.MessageDataStreamType.TextToSpeechAudio&&(this.privAudioStream=AudioOutputStream_js_1.AudioOutputStream.createPullStream(),this.privAudioStream.format=t!==void 0?t:AudioOutputFormat_js_1.AudioOutputFormatImpl.getDefaultOutputFormat()),this.privAudioStream}endAudioStream(){this.privAudioStream!==null&&!this.privAudioStream.isClosed&&this.privAudioStream.close()}complete(){this.privTimeoutToken!==void 0&&clearTimeout(this.privTimeoutToken),this.endAudioStream()}resetTurnEndTimeout(){this.privTimeoutToken!==void 0&&clearTimeout(this.privTimeoutToken),this.privTimeoutToken=setTimeout(()=>{this.privTurnManager.CompleteTurn(this.privRequestId)},2e3)}}DialogServiceTurnState$1.DialogServiceTurnState=DialogServiceTurnState;Object.defineProperty(DialogServiceTurnStateManager$1,"__esModule",{value:!0});DialogServiceTurnStateManager$1.DialogServiceTurnStateManager=void 0;const Error_js_1=_Error,DialogServiceTurnState_js_1=DialogServiceTurnState$1;class DialogServiceTurnStateManager{constructor(){this.privTurnMap=new Map}StartTurn(e){if(this.privTurnMap.has(e))throw new Error_js_1.InvalidOperationError("Service error: There is already a turn with id:"+e);const t=new DialogServiceTurnState_js_1.DialogServiceTurnState(this,e);return this.privTurnMap.set(e,t),this.privTurnMap.get(e)}GetTurn(e){return this.privTurnMap.get(e)}CompleteTurn(e){if(!this.privTurnMap.has(e))throw new Error_js_1.InvalidOperationError("Service error: Received turn end for an unknown turn id:"+e);const t=this.privTurnMap.get(e);return t.complete(),this.privTurnMap.delete(e),t}}DialogServiceTurnStateManager$1.DialogServiceTurnStateManager=DialogServiceTurnStateManager;var hasRequiredDialogServiceAdapter;function requireDialogServiceAdapter(){if(hasRequiredDialogServiceAdapter)return DialogServiceAdapter;hasRequiredDialogServiceAdapter=1,Object.defineProperty(DialogServiceAdapter,"__esModule",{value:!0}),DialogServiceAdapter.DialogServiceAdapter=void 0;const i=requireExports$2(),e=DialogEvents,t=requireExports$5(),s=AudioOutputFormat,o=requireExports$3(),a=DialogServiceTurnStateManager$1,c=requireExports(),u=ActivityResponsePayload,d=SpeechConnectionMessage_Internal;let p=class extends c.ServiceRecognizerBase{constructor(g,m,S,y,C){super(g,m,S,y,C),this.privEvents=new t.EventSource,this.privDialogServiceConnector=C,this.receiveMessageOverride=()=>this.receiveDialogMessageOverride(),this.privTurnStateManager=new a.DialogServiceTurnStateManager,this.recognizeOverride=(R,T,E)=>this.listenOnce(R,T,E),this.postConnectImplOverride=R=>this.dialogConnectImpl(R),this.configConnectionOverride=R=>this.configConnection(R),this.disconnectOverride=()=>this.privDisconnect(),this.privDialogAudioSource=S,this.agentConfigSent=!1,this.privLastResult=null,this.connectionEvents.attach(R=>{R.name==="ConnectionClosedEvent"&&(this.terminateMessageLoop=!0)})}async sendMessage(g){const m=t.createGuid(),S=t.createNoDashGuid(),y={context:{interactionId:m},messagePayload:JSON.parse(g),version:.5},C=JSON.stringify(y);await(await this.fetchConnection()).send(new d.SpeechConnectionMessage(t.MessageType.Text,"agent",S,"application/json",C))}async privDisconnect(){await this.cancelRecognition(this.privRequestSession.sessionId,this.privRequestSession.requestId,o.CancellationReason.Error,o.CancellationErrorCode.NoError,"Disconnecting"),this.terminateMessageLoop=!0,this.agentConfigSent=!1}processTypeSpecificMessages(g){const m=new o.PropertyCollection;g.messageType===t.MessageType.Text&&m.setProperty(o.PropertyId.SpeechServiceResponse_JsonResult,g.textBody);let S,y;switch(g.path.toLowerCase()){case"speech.phrase":const R=c.SimpleSpeechPhrase.fromJSON(g.textBody);if(this.privRequestSession.onPhraseRecognized(this.privRequestSession.currentTurnAudioOffset+R.Offset+R.Duration),R.RecognitionStatus!==c.RecognitionStatus.TooManyRequests&&R.RecognitionStatus!==c.RecognitionStatus.Error){const _=this.fireEventForResult(R,m);if(this.privLastResult=_.result,this.privDialogServiceConnector.recognized)try{this.privDialogServiceConnector.recognized(this.privDialogServiceConnector,_)}catch{}}y=!0;break;case"speech.hypothesis":const T=c.SpeechHypothesis.fromJSON(g.textBody),E=T.Offset+this.privRequestSession.currentTurnAudioOffset;S=new o.SpeechRecognitionResult(this.privRequestSession.requestId,o.ResultReason.RecognizingSpeech,T.Text,T.Duration,E,T.Language,T.LanguageDetectionConfidence,void 0,void 0,g.textBody,m),this.privRequestSession.onHypothesis(E);const A=new o.SpeechRecognitionEventArgs(S,T.Duration,this.privRequestSession.sessionId);if(this.privDialogServiceConnector.recognizing)try{this.privDialogServiceConnector.recognizing(this.privDialogServiceConnector,A)}catch{}y=!0;break;case"speech.keyword":const b=c.SpeechKeyword.fromJSON(g.textBody);S=new o.SpeechRecognitionResult(this.privRequestSession.requestId,b.Status==="Accepted"?o.ResultReason.RecognizedKeyword:o.ResultReason.NoMatch,b.Text,b.Duration,b.Offset,void 0,void 0,void 0,void 0,g.textBody,m),b.Status!=="Accepted"&&(this.privLastResult=S);const P=new o.SpeechRecognitionEventArgs(S,S.duration,S.resultId);if(this.privDialogServiceConnector.recognized)try{this.privDialogServiceConnector.recognized(this.privDialogServiceConnector,P)}catch{}y=!0;break;case"audio":{const _=g.requestId.toUpperCase(),w=this.privTurnStateManager.GetTurn(_);try{g.binaryBody?w.audioStream.write(g.binaryBody):w.endAudioStream()}catch{}}y=!0;break;case"response":this.handleResponseMessage(g),y=!0;break}const C=new t.Deferred;return C.resolve(y),C.promise}async cancelRecognition(g,m,S,y,C){if(this.terminateMessageLoop=!0,this.privRequestSession.isRecognizing&&await this.privRequestSession.onStopRecognizing(),this.privDialogServiceConnector.canceled){const R=new o.PropertyCollection;R.setProperty(c.CancellationErrorCodePropertyName,o.CancellationErrorCode[y]);const T=new o.SpeechRecognitionCanceledEventArgs(S,C,y,void 0,g);try{this.privDialogServiceConnector.canceled(this.privDialogServiceConnector,T)}catch{}if(this.privSuccessCallback){const E=new o.SpeechRecognitionResult(void 0,o.ResultReason.Canceled,void 0,void 0,void 0,void 0,void 0,void 0,C,void 0,R);try{this.privSuccessCallback(E),this.privSuccessCallback=void 0}catch{}}}}async listenOnce(g,m,S){this.privRecognizerConfig.recognitionMode=g,this.privSuccessCallback=m,this.privErrorCallback=S,this.privRequestSession.startNewRecognition(),this.privRequestSession.listenForServiceTelemetry(this.privDialogAudioSource.events),this.privRecognizerConfig.parameters.setProperty(o.PropertyId.Speech_SessionId,this.privRequestSession.sessionId);const y=this.connectImpl(),C=this.sendPreAudioMessages(),R=await this.privDialogAudioSource.attach(this.privRequestSession.audioNodeId),T=await this.privDialogAudioSource.format,E=await this.privDialogAudioSource.deviceInfo,A=new i.ReplayableAudioNode(R,T.avgBytesPerSec);await this.privRequestSession.onAudioSourceAttachCompleted(A,!1),this.privRecognizerConfig.SpeechServiceConfig.Context.audio={source:E};try{await y,await C}catch(_){return await this.cancelRecognition(this.privRequestSession.sessionId,this.privRequestSession.requestId,o.CancellationReason.Error,o.CancellationErrorCode.ConnectionFailure,_),Promise.resolve()}const b=new o.SessionEventArgs(this.privRequestSession.sessionId);this.privRecognizer.sessionStarted&&this.privRecognizer.sessionStarted(this.privRecognizer,b),this.sendAudio(A).then(()=>{},async _=>{await this.cancelRecognition(this.privRequestSession.sessionId,this.privRequestSession.requestId,o.CancellationReason.Error,o.CancellationErrorCode.RuntimeError,_)})}dialogConnectImpl(g){return this.privConnectionLoop=this.startMessageLoop(),g}receiveDialogMessageOverride(){const g=new t.Deferred,m=async()=>{try{const S=this.isDisposed(),y=!this.isDisposed()&&this.terminateMessageLoop;if(S||y){g.resolve(void 0);return}const R=await(await this.fetchConnection()).read();if(!R)return m();const T=d.SpeechConnectionMessage.fromConnectionMessage(R);switch(T.path.toLowerCase()){case"turn.start":{const I=T.requestId.toUpperCase(),D=this.privRequestSession.requestId.toUpperCase();I!==D?this.privTurnStateManager.StartTurn(I):this.privRequestSession.onServiceTurnStartResponse()}break;case"speech.startdetected":const A=c.SpeechDetected.fromJSON(T.textBody),b=new o.RecognitionEventArgs(A.Offset,this.privRequestSession.sessionId);this.privRecognizer.speechStartDetected&&this.privRecognizer.speechStartDetected(this.privRecognizer,b);break;case"speech.enddetected":let P;T.textBody.length>0?P=T.textBody:P="{ Offset: 0 }";const _=c.SpeechDetected.fromJSON(P);this.privRequestSession.onServiceRecognized(_.Offset+this.privRequestSession.currentTurnAudioOffset);const w=new o.RecognitionEventArgs(_.Offset+this.privRequestSession.currentTurnAudioOffset,this.privRequestSession.sessionId);this.privRecognizer.speechEndDetected&&this.privRecognizer.speechEndDetected(this.privRecognizer,w);break;case"turn.end":{const I=T.requestId.toUpperCase(),D=this.privRequestSession.requestId.toUpperCase();if(I!==D)this.privTurnStateManager.CompleteTurn(I);else{const N=new o.SessionEventArgs(this.privRequestSession.sessionId);if(await this.privRequestSession.onServiceTurnEndResponse(!1),(!this.privRecognizerConfig.isContinuousRecognition||this.privRequestSession.isSpeechEnded||!this.privRequestSession.isRecognizing)&&this.privRecognizer.sessionStopped&&this.privRecognizer.sessionStopped(this.privRecognizer,N),this.privSuccessCallback&&this.privLastResult){try{this.privSuccessCallback(this.privLastResult),this.privLastResult=null}catch(L){this.privErrorCallback&&this.privErrorCallback(L)}this.privSuccessCallback=void 0,this.privErrorCallback=void 0}}}break;default:try{await this.processTypeSpecificMessages(T)||this.serviceEvents&&this.serviceEvents.onEvent(new t.ServiceEvent(T.path.toLowerCase(),T.textBody))}catch{}}return m()}catch{this.terminateMessageLoop=!0,g.resolve()}};return m().catch(S=>{t.Events.instance.onEvent(new t.BackgroundEvent(S))}),g.promise}async startMessageLoop(){this.terminateMessageLoop=!1;try{await this.receiveDialogMessageOverride()}catch(g){await this.cancelRecognition(this.privRequestSession.sessionId,this.privRequestSession.requestId,o.CancellationReason.Error,o.CancellationErrorCode.RuntimeError,g)}return Promise.resolve()}async configConnection(g){return this.terminateMessageLoop?(this.terminateMessageLoop=!1,Promise.reject("Connection to service terminated.")):(await this.sendSpeechServiceConfig(g,this.privRequestSession,this.privRecognizerConfig.SpeechServiceConfig.serialize()),await this.sendAgentConfig(g),g)}async sendPreAudioMessages(){const g=await this.fetchConnection();this.addKeywordContextData(),await this.sendSpeechContext(g,!0),await this.sendAgentContext(g),await this.sendWaveHeader(g)}sendAgentConfig(g){if(this.agentConfig&&!this.agentConfigSent){if(this.privRecognizerConfig.parameters.getProperty(o.PropertyId.Conversation_DialogType)===o.DialogServiceConfig.DialogTypes.CustomCommands){const S=this.agentConfig.get();S.botInfo.commandsCulture=this.privRecognizerConfig.parameters.getProperty(o.PropertyId.SpeechServiceConnection_RecoLanguage,"en-us"),this.agentConfig.set(S)}this.onEvent(new e.SendingAgentContextMessageEvent(this.agentConfig));const m=this.agentConfig.toJsonString();return this.agentConfigSent=!0,g.send(new d.SpeechConnectionMessage(t.MessageType.Text,"agent.config",this.privRequestSession.requestId,"application/json",m))}}sendAgentContext(g){const m=t.createGuid(),S=this.privDialogServiceConnector.properties.getProperty(o.PropertyId.Conversation_Speech_Activity_Template),C=JSON.stringify({channelData:"",context:{interactionId:m},messagePayload:typeof S===void 0?void 0:S,version:.5});return g.send(new d.SpeechConnectionMessage(t.MessageType.Text,"speech.agent.context",this.privRequestSession.requestId,"application/json",C))}fireEventForResult(g,m){const S=c.EnumTranslation.implTranslateRecognitionResult(g.RecognitionStatus),y=g.Offset+this.privRequestSession.currentTurnAudioOffset,C=new o.SpeechRecognitionResult(this.privRequestSession.requestId,S,g.DisplayText,g.Duration,y,g.Language,g.LanguageDetectionConfidence,void 0,void 0,JSON.stringify(g),m);return new o.SpeechRecognitionEventArgs(C,y,this.privRequestSession.sessionId)}handleResponseMessage(g){const m=JSON.parse(g.textBody);switch(m.messageType.toLowerCase()){case"message":const S=g.requestId.toUpperCase(),y=u.ActivityPayloadResponse.fromJSON(g.textBody),C=this.privTurnStateManager.GetTurn(S);if(y.conversationId){const E=this.agentConfig.get();E.botInfo.conversationId=y.conversationId,this.agentConfig.set(E)}const R=C.processActivityPayload(y,s.AudioOutputFormatImpl.fromSpeechSynthesisOutputFormatString(this.privDialogServiceConnector.properties.getProperty(o.PropertyId.SpeechServiceConnection_SynthOutputFormat,void 0))),T=new o.ActivityReceivedEventArgs(y.messagePayload,R);if(this.privDialogServiceConnector.activityReceived)try{this.privDialogServiceConnector.activityReceived(this.privDialogServiceConnector,T)}catch{}break;case"messagestatus":if(this.privDialogServiceConnector.turnStatusReceived)try{this.privDialogServiceConnector.turnStatusReceived(this.privDialogServiceConnector,new o.TurnStatusReceivedEventArgs(g.textBody))}catch{}break;default:t.Events.instance.onEvent(new t.BackgroundEvent(`Unexpected response of type ${m.messageType}. Ignoring.`));break}}onEvent(g){this.privEvents.onEvent(g),t.Events.instance.onEvent(g)}addKeywordContextData(){const g=this.privRecognizerConfig.parameters.getProperty("SPEECH-KeywordsToDetect");if(g===void 0)return;const m=this.privRecognizerConfig.parameters.getProperty("SPEECH-KeywordsToDetect-Offsets"),S=this.privRecognizerConfig.parameters.getProperty("SPEECH-KeywordsToDetect-Durations"),y=g.split(";"),C=m===void 0?[]:m.split(";"),R=S===void 0?[]:S.split(";"),T=[];for(let E=0;E<y.length;E++){const A={};A.text=y[E],E<C.length&&(A.offset=Number(C[E])),E<R.length&&(A.duration=Number(R[E])),T.push(A)}this.speechContext.setSection("invocationSource","VoiceActivationWithKeyword"),this.speechContext.setSection("keywordDetection",[{clientDetectedKeywords:T,onReject:{action:"EndOfTurn"},type:"startTrigger"}])}};return DialogServiceAdapter.DialogServiceAdapter=p,DialogServiceAdapter}var AgentConfig$1={};Object.defineProperty(AgentConfig$1,"__esModule",{value:!0});AgentConfig$1.AgentConfig=void 0;class AgentConfig{toJsonString(){return JSON.stringify(this.iPrivConfig)}get(){return this.iPrivConfig}set(e){this.iPrivConfig=e}}AgentConfig$1.AgentConfig=AgentConfig;var Exports$1={},ConversationManager={},ConversationConnectionConfig$1={};Object.defineProperty(ConversationConnectionConfig$1,"__esModule",{value:!0});ConversationConnectionConfig$1.ConversationConnectionConfig=void 0;const RestConfigBase_js_1=RestConfigBase$1;class ConversationConnectionConfig extends RestConfigBase_js_1.RestConfigBase{static get host(){return ConversationConnectionConfig.privHost}static get apiVersion(){return ConversationConnectionConfig.privApiVersion}static get clientAppId(){return ConversationConnectionConfig.privClientAppId}static get defaultLanguageCode(){return ConversationConnectionConfig.privDefaultLanguageCode}static get restPath(){return ConversationConnectionConfig.privRestPath}static get webSocketPath(){return ConversationConnectionConfig.privWebSocketPath}static get transcriptionEventKeys(){return ConversationConnectionConfig.privTranscriptionEventKeys}}ConversationConnectionConfig$1.ConversationConnectionConfig=ConversationConnectionConfig;ConversationConnectionConfig.privHost="dev.microsofttranslator.com";ConversationConnectionConfig.privRestPath="/capito/room";ConversationConnectionConfig.privApiVersion="2.0";ConversationConnectionConfig.privDefaultLanguageCode="en-US";ConversationConnectionConfig.privClientAppId="FC539C22-1767-4F1F-84BC-B4D811114F15";ConversationConnectionConfig.privWebSocketPath="/capito/translate";ConversationConnectionConfig.privTranscriptionEventKeys=["iCalUid","callId","organizer","FLAC","MTUri","DifferentiateGuestSpeakers","audiorecording","Threadid","OrganizerMri","OrganizerTenantId","UserToken"];var hasRequiredConversationManager;function requireConversationManager(){if(hasRequiredConversationManager)return ConversationManager;hasRequiredConversationManager=1,Object.defineProperty(ConversationManager,"__esModule",{value:!0}),ConversationManager.ConversationManager=void 0;const i=requireExports$2(),e=Contracts$1,t=requireExports$3(),s=ConversationConnectionConfig$1;let o=class{constructor(){this.privRequestParams=s.ConversationConnectionConfig.configParams,this.privErrors=s.ConversationConnectionConfig.restErrors,this.privHost=s.ConversationConnectionConfig.host,this.privApiVersion=s.ConversationConnectionConfig.apiVersion,this.privRestPath=s.ConversationConnectionConfig.restPath,this.privRestAdapter=new i.RestMessageAdapter({})}createOrJoin(c,u,d,p){try{e.Contracts.throwIfNullOrUndefined(c,"args");const v=c.getProperty(t.PropertyId.SpeechServiceConnection_RecoLanguage,s.ConversationConnectionConfig.defaultLanguageCode),g=c.getProperty(t.PropertyId.ConversationTranslator_Name,"conversation_host"),m=c.getProperty(t.PropertyId.ConversationTranslator_Host,this.privHost),S=c.getProperty(t.PropertyId.ConversationTranslator_CorrelationId),y=c.getProperty(t.PropertyId.SpeechServiceConnection_Key),C=c.getProperty(t.PropertyId.SpeechServiceConnection_Region),R=c.getProperty(t.PropertyId.SpeechServiceAuthorization_Token);e.Contracts.throwIfNullOrWhitespace(v,"languageCode"),e.Contracts.throwIfNullOrWhitespace(g,"nickname"),e.Contracts.throwIfNullOrWhitespace(m,"endpointHost");const T={};T[this.privRequestParams.apiVersion]=this.privApiVersion,T[this.privRequestParams.languageCode]=v,T[this.privRequestParams.nickname]=g;const E={};S&&(E[this.privRequestParams.correlationId]=S),E[this.privRequestParams.clientAppId]=s.ConversationConnectionConfig.clientAppId,u!==void 0?T[this.privRequestParams.roomId]=u:(e.Contracts.throwIfNullOrUndefined(C,this.privErrors.authInvalidSubscriptionRegion),E[this.privRequestParams.subscriptionRegion]=C,y?E[this.privRequestParams.subscriptionKey]=y:R?E[this.privRequestParams.authorization]=`Bearer ${R}`:e.Contracts.throwIfNullOrUndefined(y,this.privErrors.authInvalidSubscriptionKey));const A={};A.headers=E,this.privRestAdapter.options=A;const b=`https://${m}${this.privRestPath}`;this.privRestAdapter.request(i.RestRequestType.Post,b,T,null).then(P=>{const _=i.RestMessageAdapter.extractHeaderValue(this.privRequestParams.requestId,P.headers);if(!P.ok){if(p){let I=this.privErrors.invalidCreateJoinConversationResponse.replace("{status}",P.status.toString()),D;try{D=JSON.parse(P.data),I+=` [${D.error.code}: ${D.error.message}]`}catch{I+=` [${P.data}]`}_&&(I+=` ${_}`),p(I)}return}const w=JSON.parse(P.data);if(w&&(w.requestId=_),d){try{d(w)}catch(I){p&&p(I)}d=void 0}}).catch(()=>{})}catch(v){if(p)if(v instanceof Error){const g=v;p(g.name+": "+g.message)}else p(v)}}leave(c,u){return new Promise((d,p)=>{try{e.Contracts.throwIfNullOrUndefined(c,this.privErrors.invalidArgs.replace("{arg}","config")),e.Contracts.throwIfNullOrWhitespace(u,this.privErrors.invalidArgs.replace("{arg}","token"));const v=c.getProperty(t.PropertyId.ConversationTranslator_Host,this.privHost),g=c.getProperty(t.PropertyId.ConversationTranslator_CorrelationId),m={};m[this.privRequestParams.apiVersion]=this.privApiVersion,m[this.privRequestParams.sessionToken]=u;const S={};g&&(S[this.privRequestParams.correlationId]=g);const y={};y.headers=S,this.privRestAdapter.options=y;const C=`https://${v}${this.privRestPath}`;this.privRestAdapter.request(i.RestRequestType.Delete,C,m,null).then(R=>{R.ok,d()}).catch(()=>{})}catch(v){if(v instanceof Error){const g=v;p(g.name+": "+g.message)}else p(v)}})}};return ConversationManager.ConversationManager=o,ConversationManager}var ConversationTranslatorRecognizer={},ConversationConnectionFactory={},ConversationWebsocketMessageFormatter$1={},ConversationConnectionMessage$1={};Object.defineProperty(ConversationConnectionMessage$1,"__esModule",{value:!0});ConversationConnectionMessage$1.ConversationConnectionMessage=void 0;const Exports_js_1$3=requireExports$5();class ConversationConnectionMessage extends Exports_js_1$3.ConnectionMessage{constructor(e,t,s,o){super(e,t,s,o);const a=JSON.parse(this.textBody);a.type!==void 0&&(this.privConversationMessageType=a.type)}get conversationMessageType(){return this.privConversationMessageType}}ConversationConnectionMessage$1.ConversationConnectionMessage=ConversationConnectionMessage;Object.defineProperty(ConversationWebsocketMessageFormatter$1,"__esModule",{value:!0});ConversationWebsocketMessageFormatter$1.ConversationWebsocketMessageFormatter=void 0;const Exports_js_1$2=requireExports$5(),ConversationConnectionMessage_js_1=ConversationConnectionMessage$1;class ConversationWebsocketMessageFormatter{toConnectionMessage(e){const t=new Exports_js_1$2.Deferred;try{if(e.messageType===Exports_js_1$2.MessageType.Text){const s=new ConversationConnectionMessage_js_1.ConversationConnectionMessage(e.messageType,e.textContent,{},e.id);t.resolve(s)}else e.messageType===Exports_js_1$2.MessageType.Binary&&t.resolve(new ConversationConnectionMessage_js_1.ConversationConnectionMessage(e.messageType,e.binaryContent,void 0,e.id))}catch(s){t.reject(`Error formatting the message. Error: ${s}`)}return t.promise}fromConnectionMessage(e){const t=new Exports_js_1$2.Deferred;try{if(e.messageType===Exports_js_1$2.MessageType.Text){const s=`${e.textBody?e.textBody:""}`;t.resolve(new Exports_js_1$2.RawWebsocketMessage(Exports_js_1$2.MessageType.Text,s,e.id))}}catch(s){t.reject(`Error formatting the message. ${s}`)}return t.promise}}ConversationWebsocketMessageFormatter$1.ConversationWebsocketMessageFormatter=ConversationWebsocketMessageFormatter;var hasRequiredConversationConnectionFactory;function requireConversationConnectionFactory(){if(hasRequiredConversationConnectionFactory)return ConversationConnectionFactory;hasRequiredConversationConnectionFactory=1,Object.defineProperty(ConversationConnectionFactory,"__esModule",{value:!0}),ConversationConnectionFactory.ConversationConnectionFactory=void 0;const i=requireExports$2(),e=requireExports$5(),t=Contracts$1,s=requireExports$3(),o=requireConnectionFactoryBase(),a=ConversationConnectionConfig$1,c=ConversationWebsocketMessageFormatter$1;let u=class extends o.ConnectionFactoryBase{create(p,v,g){const m=p.parameters.getProperty(s.PropertyId.ConversationTranslator_Host,a.ConversationConnectionConfig.host),S=p.parameters.getProperty(s.PropertyId.ConversationTranslator_CorrelationId,e.createGuid()),y=`wss://${m}${a.ConversationConnectionConfig.webSocketPath}`,C=p.parameters.getProperty(s.PropertyId.ConversationTranslator_Token,void 0);t.Contracts.throwIfNullOrUndefined(C,"token");const R={};R[a.ConversationConnectionConfig.configParams.apiVersion]=a.ConversationConnectionConfig.apiVersion,R[a.ConversationConnectionConfig.configParams.token]=C,R[a.ConversationConnectionConfig.configParams.correlationId]=S;const T=p.parameters.getProperty("SPEECH-EnableWebsocketCompression","false")==="true";return new i.WebsocketConnection(y,R,{},new c.ConversationWebsocketMessageFormatter,i.ProxyInfo.fromRecognizerConfig(p),T,g)}};return ConversationConnectionFactory.ConversationConnectionFactory=u,ConversationConnectionFactory}var ConversationServiceAdapter={},ConversationRequestSession$1={};Object.defineProperty(ConversationRequestSession$1,"__esModule",{value:!0});ConversationRequestSession$1.ConversationRequestSession=void 0;const Exports_js_1$1=requireExports$5();class ConversationRequestSession{constructor(e){this.privIsDisposed=!1,this.privDetachables=new Array,this.privSessionId=e,this.privRequestId=Exports_js_1$1.createNoDashGuid(),this.privRequestCompletionDeferral=new Exports_js_1$1.Deferred}get sessionId(){return this.privSessionId}get requestId(){return this.privRequestId}get completionPromise(){return this.privRequestCompletionDeferral.promise}onPreConnectionStart(e,t){this.privSessionId=t}onAuthCompleted(e){e&&this.onComplete()}onConnectionEstablishCompleted(e){e!==200&&e===403&&this.onComplete()}onServiceTurnEndResponse(e){e?this.privRequestId=Exports_js_1$1.createNoDashGuid():this.onComplete()}async dispose(){if(!this.privIsDisposed){this.privIsDisposed=!0;for(const e of this.privDetachables)await e.detach()}}onComplete(){}}ConversationRequestSession$1.ConversationRequestSession=ConversationRequestSession;var ConversationTranslatorEventArgs={},hasRequiredConversationTranslatorEventArgs;function requireConversationTranslatorEventArgs(){if(hasRequiredConversationTranslatorEventArgs)return ConversationTranslatorEventArgs;hasRequiredConversationTranslatorEventArgs=1,Object.defineProperty(ConversationTranslatorEventArgs,"__esModule",{value:!0}),ConversationTranslatorEventArgs.ConversationReceivedTranslationEventArgs=ConversationTranslatorEventArgs.ParticipantsListEventArgs=ConversationTranslatorEventArgs.ParticipantAttributeEventArgs=ConversationTranslatorEventArgs.ParticipantEventArgs=ConversationTranslatorEventArgs.LockRoomEventArgs=ConversationTranslatorEventArgs.MuteAllEventArgs=void 0;const i=requireExports$3();class e extends i.SessionEventArgs{constructor(d,p){super(p),this.privIsMuted=d}get isMuted(){return this.privIsMuted}}ConversationTranslatorEventArgs.MuteAllEventArgs=e;class t extends i.SessionEventArgs{constructor(d,p){super(p),this.privIsLocked=d}get isMuted(){return this.privIsLocked}}ConversationTranslatorEventArgs.LockRoomEventArgs=t;class s extends i.SessionEventArgs{constructor(d,p){super(p),this.privParticipant=d}get participant(){return this.privParticipant}}ConversationTranslatorEventArgs.ParticipantEventArgs=s;class o extends i.SessionEventArgs{constructor(d,p,v,g){super(g),this.privKey=p,this.privValue=v,this.privParticipantId=d}get value(){return this.privValue}get key(){return this.privKey}get id(){return this.privParticipantId}}ConversationTranslatorEventArgs.ParticipantAttributeEventArgs=o;class a extends i.SessionEventArgs{constructor(d,p,v,g,m,S,y,C,R){super(R),this.privRoomId=d,this.privSessionToken=p,this.privTranslateTo=v,this.privProfanityFilter=g,this.privRoomProfanityFilter=m,this.privIsRoomLocked=S,this.privIsRoomLocked=y,this.privParticipants=C}get sessionToken(){return this.privSessionToken}get conversationId(){return this.privRoomId}get translateTo(){return this.privTranslateTo}get profanityFilter(){return this.privProfanityFilter}get roomProfanityFilter(){return this.privRoomProfanityFilter}get isRoomLocked(){return this.privIsRoomLocked}get isMuteAll(){return this.privIsMuteAll}get participants(){return this.privParticipants}}ConversationTranslatorEventArgs.ParticipantsListEventArgs=a;class c{constructor(d,p,v){this.privPayload=p,this.privCommand=d,this.privSessionId=v}get payload(){return this.privPayload}get command(){return this.privCommand}get sessionId(){return this.privSessionId}}return ConversationTranslatorEventArgs.ConversationReceivedTranslationEventArgs=c,ConversationTranslatorEventArgs}var ConversationTranslatorInterfaces={};Object.defineProperty(ConversationTranslatorInterfaces,"__esModule",{value:!0});ConversationTranslatorInterfaces.ConversationTranslatorCommandTypes=ConversationTranslatorInterfaces.ConversationTranslatorMessageTypes=ConversationTranslatorInterfaces.InternalParticipants=void 0;class InternalParticipants{constructor(e=[],t){this.participants=e,this.meId=t}addOrUpdateParticipant(e){if(e===void 0)return;const t=this.getParticipantIndex(e.id);return t>-1?this.participants.splice(t,1,e):this.participants.push(e),this.getParticipant(e.id)}getParticipantIndex(e){return this.participants.findIndex(t=>t.id===e)}getParticipant(e){return this.participants.find(t=>t.id===e)}deleteParticipant(e){this.participants=this.participants.filter(t=>t.id!==e)}get host(){return this.participants.find(e=>e.isHost===!0)}get me(){return this.getParticipant(this.meId)}}ConversationTranslatorInterfaces.InternalParticipants=InternalParticipants;ConversationTranslatorInterfaces.ConversationTranslatorMessageTypes={command:"command",final:"final",info:"info",instantMessage:"instant_message",keepAlive:"keep_alive",partial:"partial",participantCommand:"participant_command",translatedMessage:"translated_message"};ConversationTranslatorInterfaces.ConversationTranslatorCommandTypes={changeNickname:"ChangeNickname",disconnectSession:"DisconnectSession",ejectParticipant:"EjectParticipant",instant_message:"instant_message",joinSession:"JoinSession",leaveSession:"LeaveSession",participantList:"ParticipantList",roomExpirationWarning:"RoomExpirationWarning",setLockState:"SetLockState",setMute:"SetMute",setMuteAll:"SetMuteAll",setProfanityFiltering:"SetProfanityFiltering",setTranslateToLanguages:"SetTranslateToLanguages",setUseTTS:"SetUseTTS"};var Exports={},CommandResponsePayload$1={};Object.defineProperty(CommandResponsePayload$1,"__esModule",{value:!0});CommandResponsePayload$1.CommandResponsePayload=void 0;const parseCommandResponse=i=>JSON.parse(i);class CommandResponsePayload{constructor(e){this.privCommandResponse=parseCommandResponse(e)}get type(){return this.privCommandResponse.type}get command(){return this.privCommandResponse.command}get id(){return this.privCommandResponse.id}get nickname(){return this.privCommandResponse.nickname}get participantId(){return this.privCommandResponse.participantId}get roomid(){return this.privCommandResponse.roomid}get value(){return this.privCommandResponse.value}get token(){return this.privCommandResponse.token}static fromJSON(e){return new CommandResponsePayload(e)}}CommandResponsePayload$1.CommandResponsePayload=CommandResponsePayload;var ParticipantResponsePayload={};Object.defineProperty(ParticipantResponsePayload,"__esModule",{value:!0});ParticipantResponsePayload.ParticipantPayloadResponse=ParticipantResponsePayload.ParticipantsListPayloadResponse=void 0;const parseListResponse=i=>JSON.parse(i),parseParticipantResponse=i=>JSON.parse(i);class ParticipantsListPayloadResponse{constructor(e){this.privParticipantsPayloadResponse=parseListResponse(e)}get roomid(){return this.privParticipantsPayloadResponse.roomid}get id(){return this.privParticipantsPayloadResponse.id}get command(){return this.privParticipantsPayloadResponse.command}get participants(){return this.privParticipantsPayloadResponse.participants}get token(){return this.privParticipantsPayloadResponse.token}get translateTo(){return this.privParticipantsPayloadResponse.translateTo}get profanityFilter(){return this.privParticipantsPayloadResponse.profanityFilter}get roomProfanityFilter(){return this.privParticipantsPayloadResponse.roomProfanityFilter}get roomLocked(){return this.privParticipantsPayloadResponse.roomLocked}get muteAll(){return this.privParticipantsPayloadResponse.muteAll}get type(){return this.privParticipantsPayloadResponse.type}static fromJSON(e){return new ParticipantsListPayloadResponse(e)}}ParticipantResponsePayload.ParticipantsListPayloadResponse=ParticipantsListPayloadResponse;class ParticipantPayloadResponse{constructor(e){this.privParticipantPayloadResponse=parseParticipantResponse(e)}get nickname(){return this.privParticipantPayloadResponse.nickname}get locale(){return this.privParticipantPayloadResponse.locale}get usetts(){return this.privParticipantPayloadResponse.usetts}get ismuted(){return this.privParticipantPayloadResponse.ismuted}get ishost(){return this.privParticipantPayloadResponse.ishost}get participantId(){return this.privParticipantPayloadResponse.participantId}get avatar(){return this.privParticipantPayloadResponse.avatar}static fromJSON(e){return new ParticipantPayloadResponse(e)}}ParticipantResponsePayload.ParticipantPayloadResponse=ParticipantPayloadResponse;var TranslationResponsePayload={};Object.defineProperty(TranslationResponsePayload,"__esModule",{value:!0});TranslationResponsePayload.TextResponsePayload=TranslationResponsePayload.SpeechResponsePayload=void 0;const parseSpeechResponse=i=>JSON.parse(i),parseTextResponse=i=>JSON.parse(i);class SpeechResponsePayload{constructor(e){this.privSpeechResponse=parseSpeechResponse(e)}get recognition(){return this.privSpeechResponse.recognition}get translations(){return this.privSpeechResponse.translations}get id(){return this.privSpeechResponse.id}get language(){return this.privSpeechResponse.language}get nickname(){return this.privSpeechResponse.nickname}get participantId(){return this.privSpeechResponse.participantId}get roomid(){return this.privSpeechResponse.roomid}get timestamp(){return this.privSpeechResponse.timestamp}get type(){return this.privSpeechResponse.type}get isFinal(){return this.privSpeechResponse.type==="final"}static fromJSON(e){return new SpeechResponsePayload(e)}}TranslationResponsePayload.SpeechResponsePayload=SpeechResponsePayload;class TextResponsePayload{constructor(e){this.privTextResponse=parseTextResponse(e)}get originalText(){return this.privTextResponse.originalText}get translations(){return this.privTextResponse.translations}get id(){return this.privTextResponse.id}get language(){return this.privTextResponse.language}get nickname(){return this.privTextResponse.nickname}get participantId(){return this.privTextResponse.participantId}get roomid(){return this.privTextResponse.roomid}get timestamp(){return this.privTextResponse.timestamp}get type(){return this.privTextResponse.type}static fromJSON(e){return new TextResponsePayload(e)}}TranslationResponsePayload.TextResponsePayload=TextResponsePayload;(function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=CommandResponsePayload$1;Object.defineProperty(i,"CommandResponsePayload",{enumerable:!0,get:function(){return e.CommandResponsePayload}});var t=ParticipantResponsePayload;Object.defineProperty(i,"ParticipantsListPayloadResponse",{enumerable:!0,get:function(){return t.ParticipantsListPayloadResponse}}),Object.defineProperty(i,"ParticipantPayloadResponse",{enumerable:!0,get:function(){return t.ParticipantPayloadResponse}});var s=TranslationResponsePayload;Object.defineProperty(i,"SpeechResponsePayload",{enumerable:!0,get:function(){return s.SpeechResponsePayload}}),Object.defineProperty(i,"TextResponsePayload",{enumerable:!0,get:function(){return s.TextResponsePayload}})})(Exports);var hasRequiredConversationServiceAdapter;function requireConversationServiceAdapter(){if(hasRequiredConversationServiceAdapter)return ConversationServiceAdapter;hasRequiredConversationServiceAdapter=1,Object.defineProperty(ConversationServiceAdapter,"__esModule",{value:!0}),ConversationServiceAdapter.ConversationServiceAdapter=void 0;const i=requireExports$5(),e=requireExports$3(),t=requireExports(),s=ConversationConnectionMessage$1,o=ConversationRequestSession$1,a=requireConversationTranslatorEventArgs(),c=ConversationTranslatorInterfaces,u=Exports;let d=class extends t.ServiceRecognizerBase{constructor(v,g,m,S,y){super(v,g,m,S,y),this.privConnectionConfigPromise=void 0,this.privLastPartialUtteranceId="",this.privConversationServiceConnector=y,this.privConversationAuthentication=v,this.receiveMessageOverride=()=>this.receiveConversationMessageOverride(),this.recognizeOverride=()=>this.noOp(),this.postConnectImplOverride=C=>this.conversationConnectImpl(C),this.configConnectionOverride=()=>this.configConnection(),this.disconnectOverride=()=>this.privDisconnect(),this.privConversationRequestSession=new o.ConversationRequestSession(i.createNoDashGuid()),this.privConversationConnectionFactory=g,this.privConversationIsDisposed=!1}isDisposed(){return super.isDisposed()||this.privConversationIsDisposed}async dispose(v){this.privConversationIsDisposed=!0,this.privConnectionConfigPromise!==void 0&&await(await this.privConnectionConfigPromise).dispose(v),await super.dispose(v)}async sendMessage(v){return(await this.fetchConnection()).send(new s.ConversationConnectionMessage(i.MessageType.Text,v))}async sendMessageAsync(v){await(await this.fetchConnection()).send(new s.ConversationConnectionMessage(i.MessageType.Text,v))}privDisconnect(){if(!this.terminateMessageLoop)return this.cancelRecognition(this.privConversationRequestSession.sessionId,this.privConversationRequestSession.requestId,e.CancellationReason.Error,e.CancellationErrorCode.NoError,"Disconnecting"),this.terminateMessageLoop=!0,Promise.resolve()}async processTypeSpecificMessages(){return!0}cancelRecognition(v,g,m,S,y){this.terminateMessageLoop=!0;const C=new e.ConversationTranslationCanceledEventArgs(m,y,S,void 0,v);try{this.privConversationServiceConnector.canceled&&this.privConversationServiceConnector.canceled(this.privConversationServiceConnector,C)}catch{}}async conversationConnectImpl(v){return this.privConnectionLoop=this.startMessageLoop(),v}async receiveConversationMessageOverride(){if(this.isDisposed()||this.terminateMessageLoop)return Promise.resolve();const v=new i.Deferred;try{const m=await(await this.fetchConnection()).read();if(this.isDisposed()||this.terminateMessageLoop)return v.resolve(),Promise.resolve();if(!m)return this.receiveConversationMessageOverride();const S=this.privConversationRequestSession.sessionId,y=m.conversationMessageType.toLowerCase();let C=!1;try{switch(y){case"info":case"participant_command":case"command":const R=u.CommandResponsePayload.fromJSON(m.textBody);switch(R.command.toLowerCase()){case"participantlist":const _=u.ParticipantsListPayloadResponse.fromJSON(m.textBody),w=_.participants.map(z=>({avatar:z.avatar,displayName:z.nickname,id:z.participantId,isHost:z.ishost,isMuted:z.ismuted,isUsingTts:z.usetts,preferredLanguage:z.locale}));this.privConversationServiceConnector.participantsListReceived&&this.privConversationServiceConnector.participantsListReceived(this.privConversationServiceConnector,new a.ParticipantsListEventArgs(_.roomid,_.token,_.translateTo,_.profanityFilter,_.roomProfanityFilter,_.roomLocked,_.muteAll,w,S));break;case"settranslatetolanguages":this.privConversationServiceConnector.participantUpdateCommandReceived&&this.privConversationServiceConnector.participantUpdateCommandReceived(this.privConversationServiceConnector,new a.ParticipantAttributeEventArgs(R.participantId,c.ConversationTranslatorCommandTypes.setTranslateToLanguages,R.value,S));break;case"setprofanityfiltering":this.privConversationServiceConnector.participantUpdateCommandReceived&&this.privConversationServiceConnector.participantUpdateCommandReceived(this.privConversationServiceConnector,new a.ParticipantAttributeEventArgs(R.participantId,c.ConversationTranslatorCommandTypes.setProfanityFiltering,R.value,S));break;case"setmute":this.privConversationServiceConnector.participantUpdateCommandReceived&&this.privConversationServiceConnector.participantUpdateCommandReceived(this.privConversationServiceConnector,new a.ParticipantAttributeEventArgs(R.participantId,c.ConversationTranslatorCommandTypes.setMute,R.value,S));break;case"setmuteall":this.privConversationServiceConnector.muteAllCommandReceived&&this.privConversationServiceConnector.muteAllCommandReceived(this.privConversationServiceConnector,new a.MuteAllEventArgs(R.value,S));break;case"roomexpirationwarning":this.privConversationServiceConnector.conversationExpiration&&this.privConversationServiceConnector.conversationExpiration(this.privConversationServiceConnector,new e.ConversationExpirationEventArgs(R.value,this.privConversationRequestSession.sessionId));break;case"setusetts":this.privConversationServiceConnector.participantUpdateCommandReceived&&this.privConversationServiceConnector.participantUpdateCommandReceived(this.privConversationServiceConnector,new a.ParticipantAttributeEventArgs(R.participantId,c.ConversationTranslatorCommandTypes.setUseTTS,R.value,S));break;case"setlockstate":this.privConversationServiceConnector.lockRoomCommandReceived&&this.privConversationServiceConnector.lockRoomCommandReceived(this.privConversationServiceConnector,new a.LockRoomEventArgs(R.value,S));break;case"changenickname":this.privConversationServiceConnector.participantUpdateCommandReceived&&this.privConversationServiceConnector.participantUpdateCommandReceived(this.privConversationServiceConnector,new a.ParticipantAttributeEventArgs(R.participantId,c.ConversationTranslatorCommandTypes.changeNickname,R.value,S));break;case"joinsession":const I=u.ParticipantPayloadResponse.fromJSON(m.textBody),D={avatar:I.avatar,displayName:I.nickname,id:I.participantId,isHost:I.ishost,isMuted:I.ismuted,isUsingTts:I.usetts,preferredLanguage:I.locale};this.privConversationServiceConnector.participantJoinCommandReceived&&this.privConversationServiceConnector.participantJoinCommandReceived(this.privConversationServiceConnector,new a.ParticipantEventArgs(D,S));break;case"leavesession":const N={id:R.participantId};this.privConversationServiceConnector.participantLeaveCommandReceived&&this.privConversationServiceConnector.participantLeaveCommandReceived(this.privConversationServiceConnector,new a.ParticipantEventArgs(N,S));break;case"disconnectsession":const L={id:R.participantId};break;case"token":const j=new t.CognitiveTokenAuthentication(()=>{const z=R.token;return Promise.resolve(z)},()=>{const z=R.token;return Promise.resolve(z)});this.authentication=j,this.privConversationServiceConnector.onToken(j);break;default:break}break;case"partial":case"final":const T=u.SpeechResponsePayload.fromJSON(m.textBody),E=y==="final"?e.ResultReason.TranslatedParticipantSpeech:e.ResultReason.TranslatingParticipantSpeech,A=new e.ConversationTranslationResult(T.participantId,this.getTranslations(T.translations),T.language,T.id,E,T.recognition,void 0,void 0,m.textBody,void 0);T.isFinal?((A.text!==void 0&&A.text.length>0||T.id===this.privLastPartialUtteranceId)&&(C=!0),C&&this.privConversationServiceConnector.translationReceived&&this.privConversationServiceConnector.translationReceived(this.privConversationServiceConnector,new a.ConversationReceivedTranslationEventArgs(c.ConversationTranslatorMessageTypes.final,A,S))):A.text!==void 0&&(this.privLastPartialUtteranceId=T.id,this.privConversationServiceConnector.translationReceived&&this.privConversationServiceConnector.translationReceived(this.privConversationServiceConnector,new a.ConversationReceivedTranslationEventArgs(c.ConversationTranslatorMessageTypes.partial,A,S)));break;case"translated_message":const b=u.TextResponsePayload.fromJSON(m.textBody),P=new e.ConversationTranslationResult(b.participantId,this.getTranslations(b.translations),b.language,void 0,void 0,b.originalText,void 0,void 0,void 0,m.textBody,void 0);this.privConversationServiceConnector.translationReceived&&this.privConversationServiceConnector.translationReceived(this.privConversationServiceConnector,new a.ConversationReceivedTranslationEventArgs(c.ConversationTranslatorMessageTypes.instantMessage,P,S));break;default:break}}catch{}return this.receiveConversationMessageOverride()}catch{this.terminateMessageLoop=!0}return v.promise}async startMessageLoop(){if(this.isDisposed())return Promise.resolve();this.terminateMessageLoop=!1;const v=this.receiveConversationMessageOverride();try{return await v}catch(g){return this.cancelRecognition(this.privRequestSession?this.privRequestSession.sessionId:"",this.privRequestSession?this.privRequestSession.requestId:"",e.CancellationReason.Error,e.CancellationErrorCode.RuntimeError,g),null}}configConnection(){return this.isDisposed()?Promise.resolve(void 0):this.privConnectionConfigPromise!==void 0?this.privConnectionConfigPromise.then(v=>v.state()===i.ConnectionState.Disconnected?(this.privConnectionId=null,this.privConnectionConfigPromise=void 0,this.configConnection()):this.privConnectionConfigPromise,()=>(this.privConnectionId=null,this.privConnectionConfigPromise=void 0,this.configConnection())):this.terminateMessageLoop?Promise.resolve(void 0):(this.privConnectionConfigPromise=this.connectImpl().then(v=>v),this.privConnectionConfigPromise)}getTranslations(v){let g;if(v!==void 0){g=new e.Translations;for(const m of v)g.set(m.lang,m.translation)}return g}};return ConversationServiceAdapter.ConversationServiceAdapter=d,ConversationServiceAdapter}var hasRequiredConversationTranslatorRecognizer;function requireConversationTranslatorRecognizer(){if(hasRequiredConversationTranslatorRecognizer)return ConversationTranslatorRecognizer;hasRequiredConversationTranslatorRecognizer=1,Object.defineProperty(ConversationTranslatorRecognizer,"__esModule",{value:!0}),ConversationTranslatorRecognizer.ConversationTranslatorRecognizer=ConversationTranslatorRecognizer.ConversationRecognizerFactory=void 0;const i=requireExports(),e=requireExports$5(),t=Contracts$1,s=requireExports$3(),o=requireConversationConnectionFactory(),a=requireConversationServiceAdapter();class c{static fromConfig(p,v,g){return new u(p,v,g)}}ConversationTranslatorRecognizer.ConversationRecognizerFactory=c;let u=class extends s.Recognizer{constructor(p,v,g){const m=v;t.Contracts.throwIfNull(m,"speechConfig");const S=p;t.Contracts.throwIfNull(S,"conversationImpl"),super(g,m.properties,new o.ConversationConnectionFactory),this.privConversation=S,this.privIsDisposed=!1,this.privProperties=m.properties.clone(),this.privConnection=s.Connection.fromRecognizer(this),this.privProperties.getProperty(s.PropertyId.WebWorkerLoadType,"on").toLowerCase()==="on"&&typeof Blob<"u"&&typeof Worker<"u"?(this.privSetTimeout=e.Timeout.setTimeout,this.privClearTimeout=e.Timeout.clearTimeout):typeof window<"u"?(this.privSetTimeout=window.setTimeout.bind(window),this.privClearTimeout=window.clearTimeout.bind(window)):(this.privSetTimeout=setTimeout,this.privClearTimeout=clearTimeout)}set connected(p){this.privConnection.connected=p}set disconnected(p){this.privConnection.disconnected=p}get speechRecognitionLanguage(){return this.privSpeechRecognitionLanguage}get properties(){return this.privProperties}isDisposed(){return this.privIsDisposed}connect(p,v,g){try{t.Contracts.throwIfDisposed(this.privIsDisposed),t.Contracts.throwIfNullOrWhitespace(p,"token"),this.privReco.conversationTranslatorToken=p,this.resetConversationTimeout(),this.privReco.connectAsync(v,g)}catch(m){if(g)if(m instanceof Error){const S=m;g(S.name+": "+S.message)}else g(m)}}disconnect(p,v){try{t.Contracts.throwIfDisposed(this.privIsDisposed),this.privTimeoutToken!==void 0&&this.privClearTimeout(this.privTimeoutToken),this.privReco.disconnect().then(()=>{p&&p()},g=>{v&&v(g)})}catch(g){if(v)if(g instanceof Error){const m=g;v(m.name+": "+m.message)}else v(g);this.dispose(!0).catch(m=>{e.Events.instance.onEvent(new e.BackgroundEvent(m))})}}sendRequest(p,v,g){try{t.Contracts.throwIfDisposed(this.privIsDisposed),this.sendMessage(p,v,g)}catch(m){if(g)if(m instanceof Error){const S=m;g(S.name+": "+S.message)}else g(m);this.dispose(!0).catch(S=>{e.Events.instance.onEvent(new e.BackgroundEvent(S))})}}onToken(p){this.privConversation.onToken(p)}async close(){this.privIsDisposed||(this.privConnection&&(this.privConnection.closeConnection(),this.privConnection.close()),this.privConnection=void 0,await this.dispose(!0))}async dispose(p){this.privIsDisposed||p&&(this.privTimeoutToken!==void 0&&this.privClearTimeout(this.privTimeoutToken),this.privIsDisposed=!0,this.privConnection&&(this.privConnection.closeConnection(),this.privConnection.close(),this.privConnection=void 0),await super.dispose(p))}createRecognizerConfig(p){return new i.RecognizerConfig(p,this.privProperties)}createServiceRecognizer(p,v,g,m){const S=g;return new a.ConversationServiceAdapter(p,v,S,m,this)}sendMessage(p,v,g){const m=this.privReco;((y,C,R)=>{y!==void 0?y.then(()=>{try{C&&C()}catch(T){R&&R(`'Unhandled error on promise callback: ${T}'`)}},T=>{try{R&&R(T)}catch{}}):R&&R("Null promise")})(m.sendMessageAsync(p),v,g),this.resetConversationTimeout()}resetConversationTimeout(){this.privTimeoutToken!==void 0&&this.privClearTimeout(this.privTimeoutToken),this.privTimeoutToken=this.privSetTimeout(()=>{this.sendRequest(this.privConversation.getKeepAlive())},6e4)}};return ConversationTranslatorRecognizer.ConversationTranslatorRecognizer=u,ConversationTranslatorRecognizer}var TranscriberRecognizer={},hasRequiredTranscriberRecognizer;function requireTranscriberRecognizer(){if(hasRequiredTranscriberRecognizer)return TranscriberRecognizer;hasRequiredTranscriberRecognizer=1,Object.defineProperty(TranscriberRecognizer,"__esModule",{value:!0}),TranscriberRecognizer.TranscriberRecognizer=void 0;const i=requireExports$5(),e=Contracts$1,t=requireExports$3(),s=requireExports();let o=class extends t.Recognizer{constructor(c,u){const d=c;e.Contracts.throwIfNull(d,"speechTranslationConfig");const p=u;e.Contracts.throwIfNull(p,"audioConfigImpl"),e.Contracts.throwIfNullOrWhitespace(d.speechRecognitionLanguage,t.PropertyId[t.PropertyId.SpeechServiceConnection_RecoLanguage]),super(u,d.properties,new s.TranscriberConnectionFactory),this.privDisposedRecognizer=!1,this.isMeetingRecognizer=!1}get speechRecognitionLanguage(){return e.Contracts.throwIfDisposed(this.privDisposedRecognizer),this.properties.getProperty(t.PropertyId.SpeechServiceConnection_RecoLanguage)}get properties(){return this.privProperties}get authorizationToken(){return this.properties.getProperty(t.PropertyId.SpeechServiceAuthorization_Token)}set authorizationToken(c){e.Contracts.throwIfNullOrWhitespace(c,"token"),this.properties.setProperty(t.PropertyId.SpeechServiceAuthorization_Token,c)}set conversation(c){e.Contracts.throwIfNullOrUndefined(c,"Conversation"),this.isMeetingRecognizer=!1,this.privConversation=c}getConversationInfo(){return e.Contracts.throwIfNullOrUndefined(this.privConversation,"Conversation"),this.privConversation.conversationInfo}set meeting(c){e.Contracts.throwIfNullOrUndefined(c,"Meeting"),this.isMeetingRecognizer=!0,this.privMeeting=c}getMeetingInfo(){return e.Contracts.throwIfNullOrUndefined(this.privMeeting,"Meeting"),this.privMeeting.meetingInfo}IsMeetingRecognizer(){return this.isMeetingRecognizer}startContinuousRecognitionAsync(c,u){i.marshalPromiseToCallbacks(this.startContinuousRecognitionAsyncImpl(s.RecognitionMode.Conversation),c,u)}stopContinuousRecognitionAsync(c,u){i.marshalPromiseToCallbacks(this.stopContinuousRecognitionAsyncImpl(),c,u)}async close(){this.privDisposedRecognizer||await this.dispose(!0)}async pushConversationEvent(c,u){const d=this.privReco;e.Contracts.throwIfNullOrUndefined(d,"serviceRecognizer"),await d.sendSpeechEventAsync(c,u)}async pushMeetingEvent(c,u){const d=this.privReco;e.Contracts.throwIfNullOrUndefined(d,"serviceRecognizer"),await d.sendMeetingSpeechEventAsync(c,u)}async enforceAudioGating(){const d=(await this.audioConfig.format).channels;if(d===1){if(this.properties.getProperty("f0f5debc-f8c9-4892-ac4b-90a7ab359fd2","false").toLowerCase()!=="true")throw new Error("Single channel audio configuration for MeetingTranscriber is currently under private preview, please contact diarizationrequest@microsoft.com for more details")}else if(d!==8)throw new Error(`Unsupported audio configuration: Detected ${d}-channel audio`)}connectMeetingCallbacks(c){this.isMeetingRecognizer=!0,this.canceled=(u,d)=>{c.canceled&&c.canceled(c,d)},this.recognizing=(u,d)=>{c.transcribing&&c.transcribing(c,d)},this.recognized=(u,d)=>{c.transcribed&&c.transcribed(c,d)},this.sessionStarted=(u,d)=>{c.sessionStarted&&c.sessionStarted(c,d)},this.sessionStopped=(u,d)=>{c.sessionStopped&&c.sessionStopped(c,d)}}disconnectCallbacks(){this.canceled=void 0,this.recognizing=void 0,this.recognized=void 0,this.sessionStarted=void 0,this.sessionStopped=void 0}async dispose(c){this.privDisposedRecognizer||(c&&(this.privDisposedRecognizer=!0,await this.implRecognizerStop()),await super.dispose(c))}createRecognizerConfig(c){return new s.RecognizerConfig(c,this.properties)}createServiceRecognizer(c,u,d,p){const v=d;return new s.TranscriptionServiceRecognizer(c,u,v,p,this)}};return TranscriberRecognizer.TranscriberRecognizer=o,TranscriberRecognizer}var hasRequiredExports$1;function requireExports$1(){return hasRequiredExports$1||(hasRequiredExports$1=1,function(i){Object.defineProperty(i,"__esModule",{value:!0});var e=requireConversationManager();Object.defineProperty(i,"ConversationManager",{enumerable:!0,get:function(){return e.ConversationManager}});var t=ConversationConnectionConfig$1;Object.defineProperty(i,"ConversationConnectionConfig",{enumerable:!0,get:function(){return t.ConversationConnectionConfig}});var s=requireConversationTranslatorRecognizer();Object.defineProperty(i,"ConversationRecognizerFactory",{enumerable:!0,get:function(){return s.ConversationRecognizerFactory}});var o=requireTranscriberRecognizer();Object.defineProperty(i,"TranscriberRecognizer",{enumerable:!0,get:function(){return o.TranscriberRecognizer}});var a=requireConversationTranslatorEventArgs();Object.defineProperty(i,"ConversationReceivedTranslationEventArgs",{enumerable:!0,get:function(){return a.ConversationReceivedTranslationEventArgs}}),Object.defineProperty(i,"LockRoomEventArgs",{enumerable:!0,get:function(){return a.LockRoomEventArgs}}),Object.defineProperty(i,"MuteAllEventArgs",{enumerable:!0,get:function(){return a.MuteAllEventArgs}}),Object.defineProperty(i,"ParticipantAttributeEventArgs",{enumerable:!0,get:function(){return a.ParticipantAttributeEventArgs}}),Object.defineProperty(i,"ParticipantEventArgs",{enumerable:!0,get:function(){return a.ParticipantEventArgs}}),Object.defineProperty(i,"ParticipantsListEventArgs",{enumerable:!0,get:function(){return a.ParticipantsListEventArgs}});var c=ConversationTranslatorInterfaces;Object.defineProperty(i,"ConversationTranslatorCommandTypes",{enumerable:!0,get:function(){return c.ConversationTranslatorCommandTypes}}),Object.defineProperty(i,"ConversationTranslatorMessageTypes",{enumerable:!0,get:function(){return c.ConversationTranslatorMessageTypes}}),Object.defineProperty(i,"InternalParticipants",{enumerable:!0,get:function(){return c.InternalParticipants}})}(Exports$1)),Exports$1}var SynthesisAudioMetadata={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.SynthesisAudioMetadata=i.MetadataType=void 0,function(t){t.WordBoundary="WordBoundary",t.Bookmark="Bookmark",t.Viseme="Viseme",t.SentenceBoundary="SentenceBoundary",t.SessionEnd="SessionEnd",t.AvatarSignal="TalkingAvatarSignal"}(i.MetadataType||(i.MetadataType={}));class e{constructor(s){this.privSynthesisAudioMetadata=JSON.parse(s)}static fromJSON(s){return new e(s)}get Metadata(){return this.privSynthesisAudioMetadata.Metadata}}i.SynthesisAudioMetadata=e})(SynthesisAudioMetadata);var SynthesisTurn={},SynthesisEvents={};Object.defineProperty(SynthesisEvents,"__esModule",{value:!0});SynthesisEvents.SynthesisStartedEvent=SynthesisEvents.ConnectingToSynthesisServiceEvent=SynthesisEvents.SynthesisTriggeredEvent=SynthesisEvents.SpeechSynthesisEvent=void 0;const Exports_js_1=requireExports$5();class SpeechSynthesisEvent extends Exports_js_1.PlatformEvent{constructor(e,t,s=Exports_js_1.EventType.Info){super(e,s),this.privRequestId=t}get requestId(){return this.privRequestId}}SynthesisEvents.SpeechSynthesisEvent=SpeechSynthesisEvent;class SynthesisTriggeredEvent extends SpeechSynthesisEvent{constructor(e,t,s){super("SynthesisTriggeredEvent",e),this.privSessionAudioDestinationId=t,this.privTurnAudioDestinationId=s}get audioSessionDestinationId(){return this.privSessionAudioDestinationId}get audioTurnDestinationId(){return this.privTurnAudioDestinationId}}SynthesisEvents.SynthesisTriggeredEvent=SynthesisTriggeredEvent;class ConnectingToSynthesisServiceEvent extends SpeechSynthesisEvent{constructor(e,t){super("ConnectingToSynthesisServiceEvent",e),this.privAuthFetchEventId=t}get authFetchEventId(){return this.privAuthFetchEventId}}SynthesisEvents.ConnectingToSynthesisServiceEvent=ConnectingToSynthesisServiceEvent;class SynthesisStartedEvent extends SpeechSynthesisEvent{constructor(e,t){super("SynthesisStartedEvent",e),this.privAuthFetchEventId=t}get authFetchEventId(){return this.privAuthFetchEventId}}SynthesisEvents.SynthesisStartedEvent=SynthesisStartedEvent;var hasRequiredSynthesisTurn;function requireSynthesisTurn(){if(hasRequiredSynthesisTurn)return SynthesisTurn;hasRequiredSynthesisTurn=1,Object.defineProperty(SynthesisTurn,"__esModule",{value:!0}),SynthesisTurn.SynthesisTurn=void 0;const i=requireExports$5(),e=AudioOutputStream$1,t=requireExports$3(),s=SynthesisAudioMetadata,o=SynthesisEvents;let a=class ve{constructor(){this.privIsDisposed=!1,this.privIsSynthesizing=!1,this.privIsSynthesisEnded=!1,this.privBytesReceived=0,this.privInTurn=!1,this.privTextOffset=0,this.privNextSearchTextIndex=0,this.privSentenceOffset=0,this.privNextSearchSentenceIndex=0,this.privRequestId=i.createNoDashGuid(),this.privTurnDeferral=new i.Deferred,this.privTurnDeferral.resolve()}get requestId(){return this.privRequestId}get streamId(){return this.privStreamId}set streamId(u){this.privStreamId=u}get audioOutputFormat(){return this.privAudioOutputFormat}set audioOutputFormat(u){this.privAudioOutputFormat=u}get turnCompletionPromise(){return this.privTurnDeferral.promise}get isSynthesisEnded(){return this.privIsSynthesisEnded}get isSynthesizing(){return this.privIsSynthesizing}get currentTextOffset(){return this.privTextOffset}get currentSentenceOffset(){return this.privSentenceOffset}get bytesReceived(){return this.privBytesReceived}get audioDuration(){return this.privAudioDuration}get extraProperties(){if(this.privWebRTCSDP){const u=new t.PropertyCollection;return u.setProperty(t.PropertyId.TalkingAvatarService_WebRTC_SDP,this.privWebRTCSDP),u}}async getAllReceivedAudio(){return this.privReceivedAudio?Promise.resolve(this.privReceivedAudio):this.privIsSynthesisEnded?(await this.readAllAudioFromStream(),Promise.resolve(this.privReceivedAudio)):null}async getAllReceivedAudioWithHeader(){if(this.privReceivedAudioWithHeader)return this.privReceivedAudioWithHeader;if(!this.privIsSynthesisEnded)return null;if(this.audioOutputFormat.hasHeader){const u=await this.getAllReceivedAudio();return this.privReceivedAudioWithHeader=this.audioOutputFormat.addHeader(u),this.privReceivedAudioWithHeader}else return this.getAllReceivedAudio()}startNewSynthesis(u,d,p,v){this.privIsSynthesisEnded=!1,this.privIsSynthesizing=!0,this.privRequestId=u,this.privRawText=d,this.privIsSSML=p,this.privAudioOutputStream=new e.PullAudioOutputStreamImpl,this.privAudioOutputStream.format=this.privAudioOutputFormat,this.privReceivedAudio=null,this.privReceivedAudioWithHeader=null,this.privBytesReceived=0,this.privTextOffset=0,this.privNextSearchTextIndex=0,this.privSentenceOffset=0,this.privNextSearchSentenceIndex=0,this.privPartialVisemeAnimation="",this.privWebRTCSDP="",v!==void 0&&(this.privTurnAudioDestination=v,this.privTurnAudioDestination.format=this.privAudioOutputFormat),this.onEvent(new o.SynthesisTriggeredEvent(this.requestId,void 0,v===void 0?void 0:v.id()))}onPreConnectionStart(u){this.privAuthFetchEventId=u,this.onEvent(new o.ConnectingToSynthesisServiceEvent(this.privRequestId,this.privAuthFetchEventId))}onAuthCompleted(u){u&&this.onComplete()}onConnectionEstablishCompleted(u){if(u===200){this.onEvent(new o.SynthesisStartedEvent(this.requestId,this.privAuthFetchEventId)),this.privBytesReceived=0;return}else u===403&&this.onComplete()}onServiceResponseMessage(u){const d=JSON.parse(u);this.streamId=d.audio.streamId}onServiceTurnEndResponse(){this.privInTurn=!1,this.privTurnDeferral.resolve(),this.onComplete()}onServiceTurnStartResponse(u){this.privTurnDeferral&&this.privInTurn&&(this.privTurnDeferral.reject("Another turn started before current completed."),this.privTurnDeferral.promise.then().catch(()=>{})),this.privInTurn=!0,this.privTurnDeferral=new i.Deferred;const d=JSON.parse(u);d.webrtc&&(this.privWebRTCSDP=d.webrtc.connectionString)}onAudioChunkReceived(u){this.isSynthesizing&&(this.privAudioOutputStream.write(u),this.privBytesReceived+=u.byteLength,this.privTurnAudioDestination!==void 0&&this.privTurnAudioDestination.write(u))}onTextBoundaryEvent(u){this.updateTextOffset(u.Data.text.Text,u.Type)}onVisemeMetadataReceived(u){u.Data.AnimationChunk!==void 0&&(this.privPartialVisemeAnimation+=u.Data.AnimationChunk)}onSessionEnd(u){this.privAudioDuration=u.Data.Offset}async constructSynthesisResult(){const u=await this.getAllReceivedAudioWithHeader();return new t.SpeechSynthesisResult(this.requestId,t.ResultReason.SynthesizingAudioCompleted,u,void 0,this.extraProperties,this.audioDuration)}dispose(){this.privIsDisposed||(this.privIsDisposed=!0)}onStopSynthesizing(){this.onComplete()}getAndClearVisemeAnimation(){const u=this.privPartialVisemeAnimation;return this.privPartialVisemeAnimation="",u}onEvent(u){i.Events.instance.onEvent(u)}static isXmlTag(u){return u.length>=2&&u[0]==="<"&&u[u.length-1]===">"}updateTextOffset(u,d){d===s.MetadataType.WordBoundary?(this.privTextOffset=this.privRawText.indexOf(u,this.privNextSearchTextIndex),this.privTextOffset>=0&&(this.privNextSearchTextIndex=this.privTextOffset+u.length,this.privIsSSML&&this.withinXmlTag(this.privTextOffset)&&!ve.isXmlTag(u)&&this.updateTextOffset(u,d))):(this.privSentenceOffset=this.privRawText.indexOf(u,this.privNextSearchSentenceIndex),this.privSentenceOffset>=0&&(this.privNextSearchSentenceIndex=this.privSentenceOffset+u.length,this.privIsSSML&&this.withinXmlTag(this.privSentenceOffset)&&!ve.isXmlTag(u)&&this.updateTextOffset(u,d)))}onComplete(){this.privIsSynthesizing&&(this.privIsSynthesizing=!1,this.privIsSynthesisEnded=!0,this.privAudioOutputStream.close(),this.privInTurn=!1,this.privTurnAudioDestination!==void 0&&(this.privTurnAudioDestination.close(),this.privTurnAudioDestination=void 0))}async readAllAudioFromStream(){if(this.privIsSynthesisEnded){this.privReceivedAudio=new ArrayBuffer(this.bytesReceived);try{await this.privAudioOutputStream.read(this.privReceivedAudio)}catch{this.privReceivedAudio=new ArrayBuffer(0)}}}withinXmlTag(u){return this.privRawText.indexOf("<",u+1)>this.privRawText.indexOf(">",u+1)}};return SynthesisTurn.SynthesisTurn=a,SynthesisTurn}var SynthesisAdapterBase={},hasRequiredSynthesisAdapterBase;function requireSynthesisAdapterBase(){if(hasRequiredSynthesisAdapterBase)return SynthesisAdapterBase;hasRequiredSynthesisAdapterBase=1,Object.defineProperty(SynthesisAdapterBase,"__esModule",{value:!0}),SynthesisAdapterBase.SynthesisAdapterBase=void 0;const i=requireExports$5(),e=requireExports$3(),t=requireExports(),s=SpeechConnectionMessage_Internal;let o=class{constructor(c,u,d,p){if(this.speakOverride=void 0,this.receiveMessageOverride=void 0,this.connectImplOverride=void 0,this.configConnectionOverride=void 0,this.privConnectionConfigurationPromise=void 0,!c)throw new i.ArgumentNullError("authentication");if(!u)throw new i.ArgumentNullError("connectionFactory");if(!d)throw new i.ArgumentNullError("synthesizerConfig");this.privAuthentication=c,this.privConnectionFactory=u,this.privSynthesizerConfig=d,this.privIsDisposed=!1,this.privSessionAudioDestination=p,this.privSynthesisTurn=new t.SynthesisTurn,this.privConnectionEvents=new i.EventSource,this.privServiceEvents=new i.EventSource,this.privSynthesisContext=new t.SynthesisContext,this.privAgentConfig=new t.AgentConfig,this.connectionEvents.attach(v=>{if(v.name==="ConnectionClosedEvent"){const g=v;g.statusCode!==1e3&&this.cancelSynthesisLocal(e.CancellationReason.Error,g.statusCode===1007?e.CancellationErrorCode.BadRequestParameters:e.CancellationErrorCode.ConnectionFailure,`${g.reason} websocket error code: ${g.statusCode}`)}})}get synthesisContext(){return this.privSynthesisContext}get agentConfig(){return this.privAgentConfig}get connectionEvents(){return this.privConnectionEvents}get serviceEvents(){return this.privServiceEvents}set activityTemplate(c){this.privActivityTemplate=c}get activityTemplate(){return this.privActivityTemplate}set audioOutputFormat(c){this.privAudioOutputFormat=c,this.privSynthesisTurn.audioOutputFormat=c,this.privSessionAudioDestination!==void 0&&(this.privSessionAudioDestination.format=c),this.synthesisContext!==void 0&&(this.synthesisContext.audioOutputFormat=c)}isDisposed(){return this.privIsDisposed}async dispose(c){this.privIsDisposed=!0,this.privSessionAudioDestination!==void 0&&this.privSessionAudioDestination.close(),this.privConnectionConfigurationPromise!==void 0&&await(await this.privConnectionConfigurationPromise).dispose(c)}async connect(){await this.connectImpl()}async sendNetworkMessage(c,u){const d=typeof u=="string"?i.MessageType.Text:i.MessageType.Binary,p=typeof u=="string"?"application/json":"";return(await this.fetchConnection()).send(new s.SpeechConnectionMessage(d,c,this.privSynthesisTurn.requestId,p,u))}async Speak(c,u,d,p,v,g){let m;if(u?m=c:m=this.privSynthesizer.buildSsml(c),this.speakOverride!==void 0)return this.speakOverride(m,d,p,v);this.privSuccessCallback=p,this.privErrorCallback=v,this.privSynthesisTurn.startNewSynthesis(d,c,u,g);try{await this.connectImpl();const S=await this.fetchConnection();await this.sendSynthesisContext(S),await this.sendSsmlMessage(S,m,d),this.onSynthesisStarted(d),this.receiveMessage()}catch(S){return this.cancelSynthesisLocal(e.CancellationReason.Error,e.CancellationErrorCode.ConnectionFailure,S),Promise.reject(S)}}async stopSpeaking(){return await this.connectImpl(),(await this.fetchConnection()).send(new s.SpeechConnectionMessage(i.MessageType.Text,"synthesis.control",this.privSynthesisTurn.requestId,"application/json",JSON.stringify({action:"stop"})))}cancelSynthesis(c,u,d,p){const v=new e.PropertyCollection;v.setProperty(t.CancellationErrorCodePropertyName,e.CancellationErrorCode[d]);const g=new e.SpeechSynthesisResult(c,e.ResultReason.Canceled,void 0,p,v);if(this.onSynthesisCancelled(g),this.privSuccessCallback)try{this.privSuccessCallback(g)}catch{}}cancelSynthesisLocal(c,u,d){this.privSynthesisTurn.isSynthesizing&&(this.privSynthesisTurn.onStopSynthesizing(),this.cancelSynthesis(this.privSynthesisTurn.requestId,c,u,d))}processTypeSpecificMessages(c){return!0}async receiveMessage(){try{const u=await(await this.fetchConnection()).read();if(this.receiveMessageOverride!==void 0)return this.receiveMessageOverride();if(this.privIsDisposed)return;if(!u)return this.privSynthesisTurn.isSynthesizing?this.receiveMessage():void 0;const d=s.SpeechConnectionMessage.fromConnectionMessage(u);if(d.requestId.toLowerCase()===this.privSynthesisTurn.requestId.toLowerCase())switch(d.path.toLowerCase()){case"turn.start":this.privSynthesisTurn.onServiceTurnStartResponse(d.textBody);break;case"response":this.privSynthesisTurn.onServiceResponseMessage(d.textBody);break;case"audio":this.privSynthesisTurn.streamId.toLowerCase()===d.streamId.toLowerCase()&&d.binaryBody&&(this.privSynthesisTurn.onAudioChunkReceived(d.binaryBody),this.onSynthesizing(d.binaryBody),this.privSessionAudioDestination!==void 0&&this.privSessionAudioDestination.write(d.binaryBody));break;case"audio.metadata":const p=t.SynthesisAudioMetadata.fromJSON(d.textBody).Metadata;for(const g of p)switch(g.Type){case t.MetadataType.WordBoundary:case t.MetadataType.SentenceBoundary:this.privSynthesisTurn.onTextBoundaryEvent(g);const m=new e.SpeechSynthesisWordBoundaryEventArgs(g.Data.Offset,g.Data.Duration,g.Data.text.Text,g.Data.text.Length,g.Type===t.MetadataType.WordBoundary?this.privSynthesisTurn.currentTextOffset:this.privSynthesisTurn.currentSentenceOffset,g.Data.text.BoundaryType);this.onWordBoundary(m);break;case t.MetadataType.Bookmark:const S=new e.SpeechSynthesisBookmarkEventArgs(g.Data.Offset,g.Data.Bookmark);this.onBookmarkReached(S);break;case t.MetadataType.Viseme:if(this.privSynthesisTurn.onVisemeMetadataReceived(g),g.Data.IsLastAnimation){const y=new e.SpeechSynthesisVisemeEventArgs(g.Data.Offset,g.Data.VisemeId,this.privSynthesisTurn.getAndClearVisemeAnimation());this.onVisemeReceived(y)}break;case t.MetadataType.AvatarSignal:this.onAvatarEvent(g);break;case t.MetadataType.SessionEnd:this.privSynthesisTurn.onSessionEnd(g);break}break;case"turn.end":this.privSynthesisTurn.onServiceTurnEndResponse();let v;try{v=await this.privSynthesisTurn.constructSynthesisResult(),this.privSuccessCallback&&this.privSuccessCallback(v)}catch(g){this.privErrorCallback&&this.privErrorCallback(g)}this.onSynthesisCompleted(v);break;default:this.processTypeSpecificMessages(d)||this.privServiceEvents&&this.serviceEvents.onEvent(new i.ServiceEvent(d.path.toLowerCase(),d.textBody))}return this.receiveMessage()}catch{}}sendSynthesisContext(c){this.setSynthesisContextSynthesisSection();const u=this.synthesisContext.toJSON();if(u)return c.send(new s.SpeechConnectionMessage(i.MessageType.Text,"synthesis.context",this.privSynthesisTurn.requestId,"application/json",u))}setSpeechConfigSynthesisSection(){}connectImpl(c=!1){if(this.privConnectionPromise!=null)return this.privConnectionPromise.then(d=>d.state()===i.ConnectionState.Disconnected?(this.privConnectionId=null,this.privConnectionPromise=null,this.connectImpl()):this.privConnectionPromise,()=>(this.privConnectionId=null,this.privConnectionPromise=null,this.connectImpl()));this.privAuthFetchEventId=i.createNoDashGuid(),this.privConnectionId=i.createNoDashGuid(),this.privSynthesisTurn.onPreConnectionStart(this.privAuthFetchEventId);const u=c?this.privAuthentication.fetchOnExpiry(this.privAuthFetchEventId):this.privAuthentication.fetch(this.privAuthFetchEventId);return this.privConnectionPromise=u.then(async d=>{this.privSynthesisTurn.onAuthCompleted(!1);const p=this.privConnectionFactory.create(this.privSynthesizerConfig,d,this.privConnectionId);p.events.attach(g=>{this.connectionEvents.onEvent(g)});const v=await p.open();return v.statusCode===200?(this.privSynthesisTurn.onConnectionEstablishCompleted(v.statusCode),Promise.resolve(p)):v.statusCode===403&&!c?this.connectImpl(!0):(this.privSynthesisTurn.onConnectionEstablishCompleted(v.statusCode),Promise.reject(`Unable to contact server. StatusCode: ${v.statusCode},
                    ${this.privSynthesizerConfig.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Url)} Reason: ${v.reason}`))},d=>{throw this.privSynthesisTurn.onAuthCompleted(!0),new Error(d)}),this.privConnectionPromise.catch(()=>{}),this.privConnectionPromise}sendSpeechServiceConfig(c,u){if(u)return c.send(new s.SpeechConnectionMessage(i.MessageType.Text,"speech.config",this.privSynthesisTurn.requestId,"application/json",u))}sendSsmlMessage(c,u,d){return c.send(new s.SpeechConnectionMessage(i.MessageType.Text,"ssml",d,"application/ssml+xml",u))}async fetchConnection(){return this.privConnectionConfigurationPromise!==void 0?this.privConnectionConfigurationPromise.then(c=>c.state()===i.ConnectionState.Disconnected?(this.privConnectionId=null,this.privConnectionConfigurationPromise=void 0,this.fetchConnection()):this.privConnectionConfigurationPromise,()=>(this.privConnectionId=null,this.privConnectionConfigurationPromise=void 0,this.fetchConnection())):(this.privConnectionConfigurationPromise=this.configureConnection(),await this.privConnectionConfigurationPromise)}async configureConnection(){const c=await this.connectImpl();return this.configConnectionOverride!==void 0?this.configConnectionOverride(c):(this.setSpeechConfigSynthesisSection(),await this.sendSpeechServiceConfig(c,this.privSynthesizerConfig.SpeechServiceConfig.serialize()),c)}onAvatarEvent(c){}onSynthesisStarted(c){}onSynthesizing(c){}onSynthesisCancelled(c){}onSynthesisCompleted(c){}onWordBoundary(c){}onVisemeReceived(c){}onBookmarkReached(c){}};return SynthesisAdapterBase.SynthesisAdapterBase=o,o.telemetryDataEnabled=!0,SynthesisAdapterBase}var AvatarSynthesisAdapter={},hasRequiredAvatarSynthesisAdapter;function requireAvatarSynthesisAdapter(){if(hasRequiredAvatarSynthesisAdapter)return AvatarSynthesisAdapter;hasRequiredAvatarSynthesisAdapter=1,Object.defineProperty(AvatarSynthesisAdapter,"__esModule",{value:!0}),AvatarSynthesisAdapter.AvatarSynthesisAdapter=void 0;const i=requireExports$3(),e=requireExports();let t=class extends e.SynthesisAdapterBase{constructor(o,a,c,u,d){super(o,a,c,void 0),this.privAvatarSynthesizer=u,this.privSynthesizer=u,this.privAvatarConfig=d}setSynthesisContextSynthesisSection(){this.privSynthesisContext.setSynthesisSection(void 0)}setSpeechConfigSynthesisSection(){var o,a,c,u,d,p,v,g,m,S,y,C,R,T,E,A,b;this.privSynthesizerConfig.synthesisVideoSection={format:{bitrate:(o=this.privAvatarConfig.videoFormat)==null?void 0:o.bitrate,codec:(a=this.privAvatarConfig.videoFormat)==null?void 0:a.codec,crop:{bottomRight:{x:(d=(u=(c=this.privAvatarConfig.videoFormat)==null?void 0:c.cropRange)==null?void 0:u.bottomRight)==null?void 0:d.x,y:(g=(v=(p=this.privAvatarConfig.videoFormat)==null?void 0:p.cropRange)==null?void 0:v.bottomRight)==null?void 0:g.y},topLeft:{x:(y=(S=(m=this.privAvatarConfig.videoFormat)==null?void 0:m.cropRange)==null?void 0:S.topLeft)==null?void 0:y.x,y:(T=(R=(C=this.privAvatarConfig.videoFormat)==null?void 0:C.cropRange)==null?void 0:R.topLeft)==null?void 0:T.y}},resolution:{height:(E=this.privAvatarConfig.videoFormat)==null?void 0:E.height,width:(A=this.privAvatarConfig.videoFormat)==null?void 0:A.width}},protocol:{name:"WebRTC",webrtcConfig:{clientDescription:btoa(this.privSynthesizerConfig.parameters.getProperty(i.PropertyId.TalkingAvatarService_WebRTC_SDP)),iceServers:this.privAvatarConfig.remoteIceServers??this.privAvatarSynthesizer.iceServers}},talkingAvatar:{background:{color:this.privAvatarConfig.backgroundColor,image:{url:(b=this.privAvatarConfig.backgroundImage)==null?void 0:b.toString()}},character:this.privAvatarConfig.character,customized:this.privAvatarConfig.customized,style:this.privAvatarConfig.style}}}onAvatarEvent(o){if(this.privAvatarSynthesizer.avatarEventReceived){const a=new i.AvatarEventArgs(o.Data.Offset,o.Data.Name);try{this.privAvatarSynthesizer.avatarEventReceived(this.privAvatarSynthesizer,a)}catch{}}}};return AvatarSynthesisAdapter.AvatarSynthesisAdapter=t,AvatarSynthesisAdapter}var SpeechSynthesisAdapter={},hasRequiredSpeechSynthesisAdapter;function requireSpeechSynthesisAdapter(){if(hasRequiredSpeechSynthesisAdapter)return SpeechSynthesisAdapter;hasRequiredSpeechSynthesisAdapter=1,Object.defineProperty(SpeechSynthesisAdapter,"__esModule",{value:!0}),SpeechSynthesisAdapter.SpeechSynthesisAdapter=void 0;const i=requireExports$3(),e=requireExports();let t=class extends e.SynthesisAdapterBase{constructor(o,a,c,u,d){super(o,a,c,d),this.privSpeechSynthesizer=u,this.privSynthesizer=u}setSynthesisContextSynthesisSection(){this.privSynthesisContext.setSynthesisSection(this.privSpeechSynthesizer)}onSynthesisStarted(o){const a=new i.SpeechSynthesisEventArgs(new i.SpeechSynthesisResult(o,i.ResultReason.SynthesizingAudioStarted));this.privSpeechSynthesizer.synthesisStarted&&this.privSpeechSynthesizer.synthesisStarted(this.privSpeechSynthesizer,a)}onSynthesizing(o){if(this.privSpeechSynthesizer.synthesizing)try{const a=this.privSynthesisTurn.audioOutputFormat.addHeader(o),c=new i.SpeechSynthesisEventArgs(new i.SpeechSynthesisResult(this.privSynthesisTurn.requestId,i.ResultReason.SynthesizingAudio,a));this.privSpeechSynthesizer.synthesizing(this.privSpeechSynthesizer,c)}catch{}}onSynthesisCancelled(o){if(this.privSpeechSynthesizer.SynthesisCanceled){const a=new i.SpeechSynthesisEventArgs(o);try{this.privSpeechSynthesizer.SynthesisCanceled(this.privSpeechSynthesizer,a)}catch{}}}onSynthesisCompleted(o){if(this.privSpeechSynthesizer.synthesisCompleted)try{this.privSpeechSynthesizer.synthesisCompleted(this.privSpeechSynthesizer,new i.SpeechSynthesisEventArgs(o))}catch{}}onWordBoundary(o){if(this.privSpeechSynthesizer.wordBoundary)try{this.privSpeechSynthesizer.wordBoundary(this.privSpeechSynthesizer,o)}catch{}}onVisemeReceived(o){if(this.privSpeechSynthesizer.visemeReceived)try{this.privSpeechSynthesizer.visemeReceived(this.privSpeechSynthesizer,o)}catch{}}onBookmarkReached(o){if(this.privSpeechSynthesizer.bookmarkReached)try{this.privSpeechSynthesizer.bookmarkReached(this.privSpeechSynthesizer,o)}catch{}}};return SpeechSynthesisAdapter.SpeechSynthesisAdapter=t,SpeechSynthesisAdapter}var SynthesisRestAdapter={},hasRequiredSynthesisRestAdapter;function requireSynthesisRestAdapter(){if(hasRequiredSynthesisRestAdapter)return SynthesisRestAdapter;hasRequiredSynthesisRestAdapter=1,Object.defineProperty(SynthesisRestAdapter,"__esModule",{value:!0}),SynthesisRestAdapter.SynthesisRestAdapter=void 0;const i=requireExports$2(),e=requireExports$3(),t=requireConnectionFactoryBase(),s=HeaderNames$1;let o=class{constructor(c,u){let d=c.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Endpoint,void 0);if(!d){const v=c.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Region,"westus"),g=t.ConnectionFactoryBase.getHostSuffix(v);d=c.parameters.getProperty(e.PropertyId.SpeechServiceConnection_Host,`https://${v}.tts.speech${g}`)}this.privUri=`${d}/cognitiveservices/voices/list`;const p=i.RestConfigBase.requestOptions;this.privRestAdapter=new i.RestMessageAdapter(p),this.privAuthentication=u}getVoicesList(c){return this.privRestAdapter.setHeaders(s.HeaderNames.ConnectionId,c),this.privAuthentication.fetch(c).then(u=>(this.privRestAdapter.setHeaders(u.headerName,u.token),this.privRestAdapter.request(i.RestRequestType.Get,this.privUri)))}};return SynthesisRestAdapter.SynthesisRestAdapter=o,SynthesisRestAdapter}var SynthesizerConfig={},hasRequiredSynthesizerConfig;function requireSynthesizerConfig(){return hasRequiredSynthesizerConfig||(hasRequiredSynthesizerConfig=1,function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.SynthesizerConfig=i.SynthesisServiceType=void 0;const e=requireExports();var t;(function(o){o[o.Standard=0]="Standard",o[o.Custom=1]="Custom"})(t=i.SynthesisServiceType||(i.SynthesisServiceType={}));class s{constructor(a,c){this.privSynthesisServiceType=t.Standard,this.avatarEnabled=!1,this.privSpeechServiceConfig=a||new e.SpeechServiceConfig(new e.Context(null)),this.privParameters=c}get parameters(){return this.privParameters}get synthesisServiceType(){return this.privSynthesisServiceType}set synthesisServiceType(a){this.privSynthesisServiceType=a}set synthesisVideoSection(a){this.privSpeechServiceConfig.Context.synthesis={video:a}}get SpeechServiceConfig(){return this.privSpeechServiceConfig}}i.SynthesizerConfig=s}(SynthesizerConfig)),SynthesizerConfig}var SynthesisContext={},hasRequiredSynthesisContext;function requireSynthesisContext(){if(hasRequiredSynthesisContext)return SynthesisContext;hasRequiredSynthesisContext=1,Object.defineProperty(SynthesisContext,"__esModule",{value:!0}),SynthesisContext.SynthesisContext=void 0;const i=requireExports$3();let e=class{constructor(){this.privContext={}}setSection(s,o){this.privContext[s]=o}set audioOutputFormat(s){this.privAudioOutputFormat=s}toJSON(){return JSON.stringify(this.privContext)}setSynthesisSection(s){const o=this.buildSynthesisContext(s);this.setSection("synthesis",o)}buildSynthesisContext(s){return{audio:{metadataOptions:{bookmarkEnabled:!!(s!=null&&s.bookmarkReached),punctuationBoundaryEnabled:s==null?void 0:s.properties.getProperty(i.PropertyId.SpeechServiceResponse_RequestPunctuationBoundary,!!(s!=null&&s.wordBoundary)),sentenceBoundaryEnabled:s==null?void 0:s.properties.getProperty(i.PropertyId.SpeechServiceResponse_RequestSentenceBoundary,!1),sessionEndEnabled:!0,visemeEnabled:!!(s!=null&&s.visemeReceived),wordBoundaryEnabled:s==null?void 0:s.properties.getProperty(i.PropertyId.SpeechServiceResponse_RequestWordBoundary,!!(s!=null&&s.wordBoundary))},outputFormat:this.privAudioOutputFormat.requestAudioFormatString},language:{autoDetection:s==null?void 0:s.autoDetectSourceLanguage}}}};return SynthesisContext.SynthesisContext=e,SynthesisContext}var SpeakerRecognitionConfig={},hasRequiredSpeakerRecognitionConfig;function requireSpeakerRecognitionConfig(){if(hasRequiredSpeakerRecognitionConfig)return SpeakerRecognitionConfig;hasRequiredSpeakerRecognitionConfig=1,Object.defineProperty(SpeakerRecognitionConfig,"__esModule",{value:!0}),SpeakerRecognitionConfig.SpeakerRecognitionConfig=void 0;const i=requireExports();let e=class{constructor(s,o){this.privContext=s||new i.Context(null),this.privParameters=o}get parameters(){return this.privParameters}get Context(){return this.privContext}};return SpeakerRecognitionConfig.SpeakerRecognitionConfig=e,SpeakerRecognitionConfig}var SpeakerServiceRecognizer={},hasRequiredSpeakerServiceRecognizer;function requireSpeakerServiceRecognizer(){if(hasRequiredSpeakerServiceRecognizer)return SpeakerServiceRecognizer;hasRequiredSpeakerServiceRecognizer=1,Object.defineProperty(SpeakerServiceRecognizer,"__esModule",{value:!0}),SpeakerServiceRecognizer.SpeakerServiceRecognizer=void 0;const i=requireExports$2(),e=requireExports$5(),t=requireExports$3(),s=requireExports(),o=SpeechConnectionMessage_Internal;let a=class extends s.ServiceRecognizerBase{constructor(u,d,p,v,g){super(u,d,p,v,g),this.privSpeakerRecognizer=g,this.privSpeakerAudioSource=p,this.recognizeSpeaker=m=>this.recognizeSpeakerOnce(m),this.sendPrePayloadJSONOverride=()=>this.noOp()}processTypeSpecificMessages(u){let d=!1;const p=new t.PropertyCollection;switch(u.messageType===e.MessageType.Text&&p.setProperty(t.PropertyId.SpeechServiceResponse_JsonResult,u.textBody),u.path.toLowerCase()){case"speaker.response":const g=JSON.parse(u.textBody);let m;g.status.statusCode.toLowerCase()!=="success"?m=new t.SpeakerRecognitionResult(g,t.ResultReason.Canceled,t.CancellationErrorCode.ServiceError,g.status.reason):m=new t.SpeakerRecognitionResult(g,t.ResultReason.RecognizedSpeaker),this.privResultDeferral&&this.privResultDeferral.resolve(m),d=!0;break}const v=new e.Deferred;return v.resolve(d),v.promise}cancelRecognition(u,d,p,v,g){if(new t.PropertyCollection().setProperty(s.CancellationErrorCodePropertyName,t.CancellationErrorCode[v]),this.privResultDeferral){const S=new t.SpeakerRecognitionResult({scenario:this.privSpeakerModel.scenario,status:{statusCode:g,reason:g}},t.ResultReason.Canceled,v,g);try{this.privResultDeferral.resolve(S)}catch(y){this.privResultDeferral.reject(y)}}}async recognizeSpeakerOnce(u){this.privSpeakerModel=u,this.voiceProfileType=u.scenario,this.privResultDeferral||(this.privResultDeferral=new e.Deferred),this.privRequestSession.startNewRecognition(),this.privRequestSession.listenForServiceTelemetry(this.privSpeakerAudioSource.events),this.privRecognizerConfig.parameters.setProperty(t.PropertyId.Speech_SessionId,this.privRequestSession.sessionId);const d=this.connectImpl(),p=this.sendPreAudioMessages(this.extractSpeakerContext(u)),v=await this.privSpeakerAudioSource.attach(this.privRequestSession.audioNodeId),g=await this.privSpeakerAudioSource.format,m=await this.privSpeakerAudioSource.deviceInfo,S=new i.ReplayableAudioNode(v,g.avgBytesPerSec);await this.privRequestSession.onAudioSourceAttachCompleted(S,!1),this.privRecognizerConfig.SpeechServiceConfig.Context.audio={source:m};try{await d,await p}catch(R){this.cancelRecognition(this.privRequestSession.sessionId,this.privRequestSession.requestId,t.CancellationReason.Error,t.CancellationErrorCode.ConnectionFailure,R)}const y=new t.SessionEventArgs(this.privRequestSession.sessionId);return this.privRecognizer.sessionStarted&&this.privRecognizer.sessionStarted(this.privRecognizer,y),this.receiveMessage(),this.sendAudio(S).then(()=>{},R=>{this.cancelRecognition(this.privRequestSession.sessionId,this.privRequestSession.requestId,t.CancellationReason.Error,t.CancellationErrorCode.RuntimeError,R)}),this.privResultDeferral.promise}async sendPreAudioMessages(u){const d=await this.fetchConnection();await this.sendSpeakerRecognition(d,u)}async sendSpeakerRecognition(u,d){const p=JSON.stringify(d);return u.send(new o.SpeechConnectionMessage(e.MessageType.Text,"speaker.context",this.privRequestSession.requestId,"application/json; charset=utf-8",p))}extractSpeakerContext(u){return{features:{interimResult:"enabled",progressiveDetection:"disabled"},profileIds:u.profileIds,scenario:u.scenario}}};return SpeakerServiceRecognizer.SpeakerServiceRecognizer=a,SpeakerServiceRecognizer}var VoiceServiceRecognizer={},hasRequiredVoiceServiceRecognizer;function requireVoiceServiceRecognizer(){if(hasRequiredVoiceServiceRecognizer)return VoiceServiceRecognizer;hasRequiredVoiceServiceRecognizer=1,Object.defineProperty(VoiceServiceRecognizer,"__esModule",{value:!0}),VoiceServiceRecognizer.VoiceServiceRecognizer=void 0;const i=requireExports$2(),e=requireExports$5(),t=requireExports$3(),s=requireExports(),o=SpeechConnectionMessage_Internal;let a=class extends s.ServiceRecognizerBase{constructor(u,d,p,v,g){super(u,d,p,v,g),this.privDeferralMap=new e.DeferralMap,this.privSpeakerAudioSource=p,this.sendPrePayloadJSONOverride=()=>this.noOp()}set SpeakerAudioSource(u){this.privSpeakerAudioSource=u}processTypeSpecificMessages(u){let d=!1;const p=new t.PropertyCollection;switch(u.messageType===e.MessageType.Text&&p.setProperty(t.PropertyId.SpeechServiceResponse_JsonResult,u.textBody),u.path.toLowerCase()){case"speaker.profiles":const g=JSON.parse(u.textBody);switch(g.operation.toLowerCase()){case"create":this.handleCreateResponse(g,u.requestId);break;case"delete":case"reset":this.handleResultResponse(g,u.requestId);break;case"fetch":const C=JSON.parse(u.textBody);this.handleFetchResponse(C,u.requestId);break}d=!0;break;case"speaker.phrases":const m=JSON.parse(u.textBody);this.handlePhrasesResponse(m,u.requestId),d=!0;break;case"speaker.profile.enrollment":const S=JSON.parse(u.textBody),y=new t.VoiceProfileEnrollmentResult(this.enrollmentReasonFrom(S.enrollment?S.enrollment.enrollmentStatus:S.status.statusCode),S.enrollment?JSON.stringify(S.enrollment):void 0,S.status.reason);this.privDeferralMap.getId(u.requestId)&&this.privDeferralMap.complete(u.requestId,y),this.privRequestSession.onSpeechEnded(),d=!0;break}const v=new e.Deferred;return v.resolve(d),v.promise}cancelRecognition(u,d,p,v,g){new t.PropertyCollection().setProperty(s.CancellationErrorCodePropertyName,t.CancellationErrorCode[v]);const S=new t.VoiceProfileEnrollmentResult(t.ResultReason.Canceled,g,g);this.privDeferralMap.getId(d)&&this.privDeferralMap.complete(d,S)}async createProfile(u,d){this.voiceProfileType=u.toString();const p=this.connectImpl();try{const v=new e.Deferred;return await p,await this.sendCreateProfile(v,u,d),this.receiveMessage(),v.promise}catch(v){throw v}}async resetProfile(u){return this.voiceProfileType=u.profileType.toString(),this.sendCommonRequest("reset",u.profileType,u)}async deleteProfile(u){return this.voiceProfileType=u.profileType.toString(),this.sendCommonRequest("delete",u.profileType,u)}async retrieveEnrollmentResult(u){return this.voiceProfileType=u.profileType.toString(),this.privExpectedProfileId=u.profileId,this.sendCommonRequest("fetch",u.profileType,u)}async getAllProfiles(u){return this.voiceProfileType=u.toString(),this.sendCommonRequest("fetch",u)}async getActivationPhrases(u,d){this.voiceProfileType=u.toString();const p=this.connectImpl();try{const v=new e.Deferred;return await p,await this.sendPhrasesRequest(v,u,d),this.receiveMessage(),v.promise}catch(v){throw v}}async enrollProfile(u){this.voiceProfileType=u.profileType.toString();const d=new e.Deferred;this.privRequestSession.startNewRecognition(),this.privRequestSession.listenForServiceTelemetry(this.privSpeakerAudioSource.events),this.privRecognizerConfig.parameters.setProperty(t.PropertyId.Speech_SessionId,this.privRequestSession.sessionId);const p=this.connectImpl(),v=this.sendPreAudioMessages(u,d),g=await this.privSpeakerAudioSource.attach(this.privRequestSession.audioNodeId),m=await this.privSpeakerAudioSource.format,S=await this.privSpeakerAudioSource.deviceInfo,y=new i.ReplayableAudioNode(g,m.avgBytesPerSec);await this.privRequestSession.onAudioSourceAttachCompleted(y,!1),this.privRecognizerConfig.SpeechServiceConfig.Context.audio={source:S};try{await p,await v}catch(T){this.cancelRecognition(this.privRequestSession.sessionId,this.privRequestSession.requestId,t.CancellationReason.Error,t.CancellationErrorCode.ConnectionFailure,T)}const C=new t.SessionEventArgs(this.privRequestSession.sessionId);return this.privRecognizer.sessionStarted&&this.privRecognizer.sessionStarted(this.privRecognizer,C),this.receiveMessage(),this.sendAudio(y).then(()=>{},T=>{this.cancelRecognition(this.privRequestSession.sessionId,this.privRequestSession.requestId,t.CancellationReason.Error,t.CancellationErrorCode.RuntimeError,T)}),d.promise}async sendPreAudioMessages(u,d){const p=await this.fetchConnection();this.privRequestSession.onSpeechContext(),this.privDeferralMap.add(this.privRequestSession.requestId,d),await this.sendBaseRequest(p,"enroll",this.scenarioFrom(u.profileType),u)}async sendPhrasesRequest(u,d,p){const v=await this.fetchConnection();this.privRequestSession.onSpeechContext(),this.privDeferralMap.add(this.privRequestSession.requestId,u);const g=this.scenarioFrom(d),m={locale:p,scenario:g};return v.send(new o.SpeechConnectionMessage(e.MessageType.Text,"speaker.profile.phrases",this.privRequestSession.requestId,"application/json; charset=utf-8",JSON.stringify(m)))}async sendCreateProfile(u,d,p){const v=await this.fetchConnection();this.privRequestSession.onSpeechContext(),this.privDeferralMap.add(this.privRequestSession.requestId,u);const g=d===t.VoiceProfileType.TextIndependentIdentification?"TextIndependentIdentification":d===t.VoiceProfileType.TextIndependentVerification?"TextIndependentVerification":"TextDependentVerification",m={locale:p,number:"1",scenario:g};return v.send(new o.SpeechConnectionMessage(e.MessageType.Text,"speaker.profile.create",this.privRequestSession.requestId,"application/json; charset=utf-8",JSON.stringify(m)))}async sendCommonRequest(u,d,p=void 0){const v=this.connectImpl();try{const g=new e.Deferred;this.privRequestSession.onSpeechContext(),await v;const m=await this.fetchConnection();return this.privDeferralMap.add(this.privRequestSession.requestId,g),await this.sendBaseRequest(m,u,this.scenarioFrom(d),p),this.receiveMessage(),g.promise}catch(g){throw g}}async sendBaseRequest(u,d,p,v){const g={scenario:p};return v?g.profileIds=[v.profileId]:g.maxPageSize=-1,u.send(new o.SpeechConnectionMessage(e.MessageType.Text,`speaker.profile.${d}`,this.privRequestSession.requestId,"application/json; charset=utf-8",JSON.stringify(g)))}extractSpeakerContext(u){return{features:{interimResult:"enabled",progressiveDetection:"disabled"},profileIds:u.profileIds,scenario:u.scenario}}handlePhrasesResponse(u,d){if(this.privDeferralMap.getId(d))if(u.status.statusCode.toLowerCase()!=="success"){const p=t.ResultReason.Canceled,v=new t.VoiceProfilePhraseResult(p,u.status.statusCode,u.passPhraseType,[]);this.privDeferralMap.complete(d,v)}else if(u.phrases&&u.phrases.length>0){const p=t.ResultReason.EnrollingVoiceProfile,v=new t.VoiceProfilePhraseResult(p,u.status.statusCode,u.passPhraseType,u.phrases);this.privDeferralMap.complete(d,v)}else throw new Error("Voice Profile get activation phrases failed, no phrases received");else throw new Error(`Voice Profile get activation phrases request for requestID ${d} not found`)}handleCreateResponse(u,d){if(u.profiles&&u.profiles.length>0)if(this.privDeferralMap.getId(d)){const p=u.profiles.map(v=>v.profileId);this.privDeferralMap.complete(d,p)}else throw new Error(`Voice Profile create request for requestID ${d} not found`);else throw new Error("Voice Profile create failed, no profile id received")}handleResultResponse(u,d){if(this.privDeferralMap.getId(d)){const p=u.operation.toLowerCase()==="delete"?t.ResultReason.DeletedVoiceProfile:t.ResultReason.ResetVoiceProfile,v=u.status.statusCode.toLowerCase()==="success"?p:t.ResultReason.Canceled,g=new t.VoiceProfileResult(v,`statusCode: ${u.status.statusCode}, errorDetails: ${u.status.reason}`);this.privDeferralMap.complete(d,g)}else throw new Error(`Voice Profile create request for requestID ${d} not found`)}handleFetchResponse(u,d){if(this.privDeferralMap.getId(d)&&u.profiles[0]){if(this.privExpectedProfileId&&u.profiles.length===1&&u.profiles[0].profileId===this.privExpectedProfileId){this.privExpectedProfileId=void 0;const p=u.profiles[0],v=new t.VoiceProfileEnrollmentResult(this.enrollmentReasonFrom(p.enrollmentStatus),JSON.stringify(p),u.status.reason);this.privDeferralMap.complete(d,v)}else if(u.profiles.length>0){const p=u.profiles,v=[];for(const g of p)v.push(new t.VoiceProfileEnrollmentResult(this.enrollmentReasonFrom(g.enrollmentStatus),JSON.stringify(g),u.status.reason));this.privDeferralMap.complete(d,v)}}else throw new Error(`Voice Profile fetch request for requestID ${d} not found`)}enrollmentReasonFrom(u){switch(u.toLowerCase()){case"enrolled":return t.ResultReason.EnrolledVoiceProfile;case"invalidlocale":case"invalidphrase":case"invalidaudioformat":case"invalidscenario":case"invalidprofilecount":case"invalidoperation":case"audiotooshort":case"audiotoolong":case"toomanyenrollments":case"storageconflict":case"profilenotfound":case"incompatibleprofiles":case"incompleteenrollment":return t.ResultReason.Canceled;default:return t.ResultReason.EnrollingVoiceProfile}}scenarioFrom(u){return u===t.VoiceProfileType.TextIndependentIdentification?"TextIndependentIdentification":u===t.VoiceProfileType.TextIndependentVerification?"TextIndependentVerification":"TextDependentVerification"}};return VoiceServiceRecognizer.VoiceServiceRecognizer=a,VoiceServiceRecognizer}var SpeechServiceConfig={};(function(i){Object.defineProperty(i,"__esModule",{value:!0}),i.type=i.connectivity=i.Device=i.OS=i.System=i.Context=i.SpeechServiceConfig=void 0;class e{constructor(u){this.context=u}serialize(){return JSON.stringify(this,(u,d)=>{if(d&&typeof d=="object"&&!Array.isArray(d)){const p={};for(const v in d)Object.hasOwnProperty.call(d,v)&&(p[v&&v.charAt(0).toLowerCase()+v.substring(1)]=d[v]);return p}return d})}get Context(){return this.context}get Recognition(){return this.recognition}set Recognition(u){this.recognition=u.toLowerCase()}}i.SpeechServiceConfig=e;class t{constructor(u){this.system=new s,this.os=u}}i.Context=t;class s{constructor(){const u="1.41.0";this.name="SpeechSDK",this.version=u,this.build="JavaScript",this.lang="JavaScript"}}i.System=s;class o{constructor(u,d,p){this.platform=u,this.name=d,this.version=p}}i.OS=o;class a{constructor(u,d,p){this.manufacturer=u,this.model=d,this.version=p}}i.Device=a,function(c){c.Bluetooth="Bluetooth",c.Wired="Wired",c.WiFi="WiFi",c.Cellular="Cellular",c.InBuilt="InBuilt",c.Unknown="Unknown"}(i.connectivity||(i.connectivity={})),function(c){c.Phone="Phone",c.Speaker="Speaker",c.Car="Car",c.Headset="Headset",c.Thermostat="Thermostat",c.Microphones="Microphones",c.Deskphone="Deskphone",c.RemoteControl="RemoteControl",c.Unknown="Unknown",c.File="File",c.Stream="Stream"}(i.type||(i.type={}))})(SpeechServiceConfig);var hasRequiredExports;function requireExports(){return hasRequiredExports||(hasRequiredExports=1,function(i){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(a,c,u,d){d===void 0&&(d=u),Object.defineProperty(a,d,{enumerable:!0,get:function(){return c[u]}})}:function(a,c,u,d){d===void 0&&(d=u),a[d]=c[u]}),t=commonjsGlobal&&commonjsGlobal.__exportStar||function(a,c){for(var u in a)u!=="default"&&!c.hasOwnProperty(u)&&e(c,a,u)};Object.defineProperty(i,"__esModule",{value:!0}),i.AutoDetectSourceLanguagesOpenRangeOptionName=i.ForceDictationPropertyName=i.ServicePropertiesPropertyName=i.CancellationErrorCodePropertyName=i.OutputFormatPropertyName=void 0,t(CognitiveSubscriptionKeyAuthentication$1,i),t(CognitiveTokenAuthentication$1,i),t(IAuthentication,i),t(IConnectionFactory,i),t(ISynthesisConnectionFactory,i),t(requireIntentConnectionFactory(),i),t(requireSpeakerRecognitionConnectionFactory(),i),t(RecognitionEvents,i),t(requireServiceRecognizerBase(),i),t(requireConversationServiceRecognizer(),i),t(requireRecognizerConfig(),i),t(SpeechServiceInterfaces,i),t(WebsocketMessageFormatter$1,i),t(requireSpeechConnectionFactory(),i),t(requireConversationTranscriberConnectionFactory(),i),t(requireTranscriberConnectionFactory(),i),t(requireTranslationConnectionFactory(),i),t(requireSpeechSynthesisConnectionFactory(),i),t(requireEnumTranslation(),i),t(Enums,i),t(requireTranslationSynthesisEnd(),i),t(TranslationHypothesis$1,i),t(requireTranslationPhrase(),i),t(requireTranslationServiceRecognizer(),i),t(SpeechDetected$1,i),t(SpeechHypothesis$1,i),t(SpeechKeyword$1,i),t(requireSpeechServiceRecognizer(),i),t(requireConversationTranscriptionServiceRecognizer(),i),t(requireTranscriptionServiceRecognizer(),i),t(requireDetailedSpeechPhrase(),i),t(requireSimpleSpeechPhrase(),i),t(AddedLmIntent$1,i),t(requireIntentServiceRecognizer(),i),t(IntentResponse$1,i),t(SpeakerResponse,i),t(RequestSession$1,i),t(SpeechContext$1,i),t(DynamicGrammarBuilder$1,i),t(DynamicGrammarInterfaces,i),t(requireDialogServiceAdapter(),i),t(AgentConfig$1,i),t(requireExports$1(),i),t(SynthesisAudioMetadata,i),t(requireSynthesisTurn(),i),t(requireSynthesisAdapterBase(),i);var s=requireAvatarSynthesisAdapter();Object.defineProperty(i,"AvatarSynthesisAdapter",{enumerable:!0,get:function(){return s.AvatarSynthesisAdapter}});var o=requireSpeechSynthesisAdapter();Object.defineProperty(i,"SpeechSynthesisAdapter",{enumerable:!0,get:function(){return o.SpeechSynthesisAdapter}}),t(requireSynthesisRestAdapter(),i),t(requireSynthesizerConfig(),i),t(requireSynthesisContext(),i),t(requireSpeakerRecognitionConfig(),i),t(requireSpeakerServiceRecognizer(),i),t(requireVoiceServiceRecognizer(),i),t(SpeechServiceConfig,i),i.OutputFormatPropertyName="OutputFormat",i.CancellationErrorCodePropertyName="CancellationErrorCode",i.ServicePropertiesPropertyName="ServiceProperties",i.ForceDictationPropertyName="ForceDictation",i.AutoDetectSourceLanguagesOpenRangeOptionName="OpenRange"}(Exports$6)),Exports$6}(function(i){var e=commonjsGlobal&&commonjsGlobal.__createBinding||(Object.create?function(o,a,c,u){u===void 0&&(u=c),Object.defineProperty(o,u,{enumerable:!0,get:function(){return a[c]}})}:function(o,a,c,u){u===void 0&&(u=c),o[u]=a[c]}),t=commonjsGlobal&&commonjsGlobal.__exportStar||function(o,a){for(var c in o)c!=="default"&&!a.hasOwnProperty(c)&&e(a,o,c)};Object.defineProperty(i,"__esModule",{value:!0});const s=requireExports();new s.AgentConfig,t(requireExports$3(),i)})(microsoft_cognitiveservices_speech_sdk);var silenceTimeout="3000";const cogSvcRegion="westus2",cogSvcSubKey="ae8ef7b57eb24d60a05ec81e4ad83dc4";let tempSpeech="",recognizer,chatHistory=[];const test="ZjY0OWZlOGRkOTIzNDFhYzg4Y2FjMWYzMDYzNjE3OWItMTcwODQyMTQzMQ==";console.log(test);const videoElement=document.getElementById("avatarVideo"),startButton=document.getElementById("startSession"),endButton=document.getElementById("endSession"),startVoice=document.getElementById("start-voice"),stopVoice=document.getElementById("stop-voice"),interrupt=document.getElementById("interrupt"),loaderElement=document.querySelector("#loader");async function getTokenOrRefresh(){const i={headers:{"Ocp-Apim-Subscription-Key":cogSvcSubKey,"Content-Type":"application/x-www-form-urlencoded"}};try{return{authToken:(await axios.post(`https://${cogSvcRegion}.api.cognitive.microsoft.com/sts/v1.0/issueToken`,null,i)).data,region:cogSvcRegion}}catch{throw new Error("There was an error authorizing your speech key.")}}async function talktoOpenAI(i){const e=chatHistory.map(s=>({role:s.role,content:s.content}));e.push({role:"user",content:i});const t={url:"https://openai-futurestore.openai.azure.com/openai/deployments/gpt-4/chat/completions?api-version=2024-02-15-preview",method:"POST",headers:{"api-key":"b0c5483f03a84470b710e20b98b56094","Content-Type":"application/json"},data:JSON.stringify({messages:[{role:"system",content:[{type:"text",text:"You are an Omantel virtual customer service executive. Begin by warmly greeting the customer and establishing a friendly rapport. Engage in a professional conversation to understand the customer's requirements thoroughly. Assist the customer in finding the best product from the Omantel store, ensuring a helpful and friendly interaction throughout. Your response must be in JSON format with only the 'speech' key, which contains the text you would say to the user."}]},...e],temperature:.7,top_p:.95,max_tokens:800})};try{const s=await axios(t);try{const a=JSON.parse(s.data.choices[0].message.content).speech;console.log("Nora: "+a),chatHistory.push({role:"assistant",content:a}),sessionData&&handleSpeak(a),showCaptions("Avatar",a)}catch(o){console.error("Failed to parse JSON response for chat history:",o)}}catch(s){console.error("Error communicating with OpenAI:",s)}}async function sttFromMic(){const i=await getTokenOrRefresh(),e=microsoft_cognitiveservices_speech_sdk.SpeechConfig.fromAuthorizationToken(i.authToken,i.region);e.setProperty(microsoft_cognitiveservices_speech_sdk.PropertyId.SpeechServiceConnection_EndSilenceTimeoutMs,silenceTimeout),e.setProperty(microsoft_cognitiveservices_speech_sdk.PropertyId.SpeechServiceConnection_AutoDetectSourceLanguages,"ar-MA,ar-AE"),console.log(e);const t=microsoft_cognitiveservices_speech_sdk.AudioConfig.fromDefaultMicrophoneInput();recognizer=new microsoft_cognitiveservices_speech_sdk.SpeechRecognizer(e,t),console.log("speak into your microphone..."),startVoice.classList.remove("d-none"),stopVoice.classList.add("d-none"),recognizer.startContinuousRecognitionAsync(()=>{console.log("Recognition started successfully.")},s=>{console.log(`ERROR: ${s}`)}),recognizer.recognizing=(s,o)=>{showCaptions("Customer",o.result.text)},recognizer.recognized=(s,o)=>{o.result.reason===microsoft_cognitiveservices_speech_sdk.ResultReason.RecognizedSpeech?(console.log(`RECOGNIZED: Text=${o.result.text}`),tempSpeech+=o.result.text,talktoOpenAI(tempSpeech),tempSpeech=""):o.result.reason===microsoft_cognitiveservices_speech_sdk.ResultReason.NoMatch&&console.log("NOMATCH: Speech could not be recognized.")},recognizer.canceled=(s,o)=>{console.log(`CANCELED: Reason=${o.reason}`),o.reason===microsoft_cognitiveservices_speech_sdk.CancellationReason.Error&&(console.log(`"CANCELED: ErrorCode=${o.errorCode}`),console.log(`"CANCELED: ErrorDetails=${o.errorDetails}`),console.log("CANCELED: Did you set the speech resource key and region values?")),recognizer.stopContinuousRecognitionAsync(),startVoice.classList.add("d-none"),stopVoice.classList.remove("d-none")},recognizer.sessionStopped=s=>{console.log(`
    Session stopped event.`),console.log(tempSpeech),showCaptions("Customer",tempSpeech),tempSpeech&&talktoOpenAI(tempSpeech),tempSpeech="",recognizer.stopContinuousRecognitionAsync(),startVoice.classList.add("d-none"),stopVoice.classList.remove("d-none")}}function stopMicrophone(){recognizer?(startVoice.classList.add("d-none"),stopVoice.classList.remove("d-none"),recognizer.stopContinuousRecognitionAsync()):console.log("Recognizer is not initialized.")}let avatar=null,sessionData=null;async function fetchAccessToken(){const e=await fetch("https://api.heygen.com/v1/streaming.create_token",{method:"POST",headers:{"x-api-key":"ZjY0OWZlOGRkOTIzNDFhYzg4Y2FjMWYzMDYzNjE3OWItMTcwODQyMTQzMQ=="}}),{data:t}=await e.json();return t.token}async function initializeAvatarSession(){loaderElement&&loaderElement.classList.remove("d-none");debugger;const i=await fetchAccessToken();console.log(i),avatar=new StreamingAvatar({token:i}),sessionData=await avatar.createStartAvatar({quality:AvatarQuality.High,avatarName:"ef08039a41354ed5a20565db899373f3",voice:{emotion:VoiceEmotion.FRIENDLY},language:"Arabic"}),console.log("Session data:",sessionData),endButton.disabled=!1,startButton.disabled=!0,loaderElement&&loaderElement.classList.add("d-none"),avatar.on(StreamingEvents.STREAM_READY,handleStreamReady),avatar.on(StreamingEvents.STREAM_DISCONNECTED,handleStreamDisconnected)}function handleStreamReady(i){i.detail&&videoElement?(videoElement.srcObject=i.detail,videoElement.onloadedmetadata=()=>{videoElement.play().catch(console.error)}):console.error("Stream is not available")}function handleStreamDisconnected(){console.log("Stream disconnected"),videoElement&&(videoElement.srcObject=null),startButton.disabled=!1,endButton.disabled=!0}async function terminateAvatarSession(){!avatar||!sessionData||(await avatar.stopAvatar(),videoElement.srcObject=null,avatar=null)}async function handleSpeak(i){avatar&&i&&await avatar.speak({text:i,task_type:TaskType.REPEAT})}async function showCaptions(i,e){const t=document.getElementById("captionText");if(t&&e)switch(i){case"Customer":t.textContent=`You: ${e}`;break;case"Avatar":t.textContent=`Nora: ${e}`;break}}startButton.addEventListener("click",initializeAvatarSession);endButton.addEventListener("click",terminateAvatarSession);startVoice.addEventListener("click",stopMicrophone);stopVoice.addEventListener("click",sttFromMic);interrupt.addEventListener("click",()=>handleSpeak("مرحبا بكم في خدمة المشتركين من عمانتل! أنا بخير ، شكرا على سؤالك. كيف يمكنني مساعدتك اليوم؟"));document.addEventListener("DOMContentLoaded",async function(){});
